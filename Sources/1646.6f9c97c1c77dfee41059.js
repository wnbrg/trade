(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[1646],{963894:(e,t)=>{"use strict";t.CircularBuffer=void 0;var i=function(){function e(e){this._start=0,this._size=0,this._buffer=new Array(e)}return e.prototype.size=function(){return this._size},e.prototype.capacity=function(){return this._buffer.length},e.prototype.enqueue=function(e){this._size<this._buffer.length?this._size++:this._start=(this._start+1)%this._buffer.length;var t=(this._start+this._size-1)%this._buffer.length;this._buffer[t]=e},e.prototype.dequeue=function(){if(0===this._size)throw new Error("Buffer is empty");var e=this._buffer[this._start];return this._buffer[this._start]=void 0,this._start=(this._start+1)%this._buffer.length,this._size--,e},e.prototype.get=function(e){if(e>=this._size)throw new Error("Index is out of range");var t=(this._start+e)%this._buffer.length;return this._buffer[t]},e.prototype.forEach=function(e,t){for(var i=0;i<this._size;i++){var s=(this._start+i)%this._buffer.length;e.call(t,this._buffer[s],s,this)}},e.prototype.clear=function(){for(var e=this._buffer.length,t=0;t<e;t++)this._buffer[t]=void 0;this._start=0,this._size=0},e}();t.CircularBuffer=i},254355:e=>{e.exports={screen:"screen-otjoFNF2",fade:"fade-otjoFNF2",screenfade:"screenfade-otjoFNF2"}},784516:e=>{e.exports={}},460682:e=>{e.exports={css_value_currency_label_radius:"4",css_wrapper_margin:"4",css_row_left_right_padding:"3",css_first_row_top_padding:"9",css_fade_height:"10","price-axis-currency-label-wrapper":"price-axis-currency-label-wrapper-y5H41VPj",hidden:"hidden-y5H41VPj","price-axis-currency-label":"price-axis-currency-label-y5H41VPj",row:"row-y5H41VPj",expanded:"expanded-y5H41VPj","price-axis-currency-label-arrow-down":"price-axis-currency-label-arrow-down-y5H41VPj","price-axis-currency-label-text":"price-axis-currency-label-text-y5H41VPj"}},949668:e=>{e.exports={labelwidth:"19px",labelheight:"19px",bordersize:"2px",bottommargin:"5px",gearheight:"13px",gearwidth:"15px","price-axis-stub":"price-axis-stub-t9vjEPyG",wrapper:"wrapper-t9vjEPyG",label:"label-t9vjEPyG",symbol:"symbol-t9vjEPyG",gear:"gear-t9vjEPyG","fixed-gear":"fixed-gear-t9vjEPyG","fixed-symbol":"fixed-symbol-t9vjEPyG"}},647184:e=>{e.exports={}},100658:e=>{e.exports={}},877825:e=>{e.exports={"css-value-chart-controls-bar-height-with-border":"39px","css-value-chart-controls-bar-border":"1px"}},237218:e=>{e.exports={}},143517:(e,t,i)=>{"use strict";var s;i.d(t,{MarketGroup:()=>s}),function(e){e.EntireWorld="Entire World",e.NorthAmerica="North America",e.Europe="Europe",e.MiddleEastAfrica="Middle East / Africa",e.MexicoSouthAmerica="Mexico and South America",e.AsiaPacific="Asia / Pacific",e.Worldwide="Worldwide",e.G20="G20"}(s||(s={}))},339957:(e,t,i)=>{"use strict";i.d(t,{mindsMovedToDetailsEnabled:()=>o});var s=i(125226),r=i(244842);function o(){return!r.enabled("widget")&&(0,s.isFeatureEnabled)("minds_moved_to_details")}},581996:(e,t,i)=>{"use strict";i.d(t,{ResizerDetacherState:()=>o});var s=i(650151),r=i(401580);class o{constructor(e){this._alive=new r.WatchedValue,
this._container=new r.WatchedValue,this._width=new r.WatchedValue,this._height=new r.WatchedValue,this._fullscreen=new r.WatchedValue,this._detachable=new r.WatchedValue,this._fullscreenable=new r.WatchedValue,this._visible=new r.WatchedValue,this._availWidth=new r.WatchedValue,this._availHeight=new r.WatchedValue,this._owner=new r.WatchedValue,this._ownersStack=[],this.owner=this._owner.readonly(),this._bridge={alive:this._alive.readonly(),container:this._container.readonly(),width:this._width.readonly(),height:this._height.readonly(),fullscreen:this._fullscreen.readonly(),detachable:this._detachable.readonly(),fullscreenable:this._fullscreenable.readonly(),visible:this._visible.readonly(),availWidth:this._availWidth.readonly(),availHeight:this._availHeight.readonly(),remove:()=>{const e=this._owner.value();e&&e.remove&&e.remove()},negotiateWidth:e=>{const t=this._owner.value();t&&t.negotiateWidth&&t.negotiateWidth(e)},negotiateHeight:e=>{const t=this._owner.value();t&&t.negotiateHeight&&t.negotiateHeight(e)},requestFullscreen:()=>{const e=this._owner.value();e&&e.requestFullscreen&&e.requestFullscreen()},exitFullscreen:()=>{const e=this._owner.value();e&&e.exitFullscreen&&e.exitFullscreen()},detach:e=>{const t=this._owner.value();t&&t.detach&&t.detach(e)},attach:()=>{const e=this._owner.value();e&&e.attach&&e.attach()}},e&&this.pushOwner(e)}bridge(){return this._bridge}pushOwner(e){if(!e.alive.value())return;for(const e of this._ownersStack)this._unsubscribeOwner(e);const t={owner:e};this._ownersStack.push(t),this._subscribeOwner(t)}_subscribeOwner(e){const t=e.owner;if(e.deathWatcher||(this._alive.setValue(!0),e.deathWatcher=t.alive.spawn(),e.deathWatcher.subscribe((t=>{t||this._deadHandler(e)}))),this._owner.setValue(t),!e.subscriptions){const i=e.subscriptions=[];this._visible.setValue(!1);const s=(e,t)=>{if(e){const s=e.spawn();i.push(s),s.subscribe((e=>{t.setValue(e)}),{callWithLast:!0})}else t.deleteValue()};s(t.container,this._container),s(t.width,this._width),s(t.height,this._height),s(t.fullscreen,this._fullscreen),s(t.detachable,this._detachable),s(t.fullscreenable,this._fullscreenable),s(t.availWidth,this._availWidth),s(t.availHeight,this._availHeight),s(t.visible,this._visible)}}_unsubscribeOwner(e,t){if(e.subscriptions){for(const t of e.subscriptions)t.unsubscribe();e.subscriptions=null}t&&e.deathWatcher&&(e.deathWatcher.unsubscribe(),e.deathWatcher=null)}_deadHandler(e){const t=this._ownersStack.indexOf(e);(0,s.assert)(-1!==t,"sanitized owner should be in stack");for(let e=this._ownersStack.length-1;e>=t;e--)this._unsubscribeOwner(this._ownersStack[e],!0);this._ownersStack.length=t,t>0?this._subscribeOwner(this._ownersStack[t-1]):(this._alive.setValue(!1),this._owner.deleteValue())}}},100366:(e,t,i)=>{"use strict";async function s(){return(await Promise.all([i.e(85866),i.e(50690),i.e(20139)]).then(i.bind(i,254543))).ErrorCardRenderer}i.d(t,{getErrorCardRenderer:()=>s})},388482:(e,t,i)=>{"use strict";i.d(t,{getChartStorage:()=>o});var s=i(594520);let r=null;function o(){
return null===r&&(r=new s.ChartStorageHttp),r}},594520:(e,t,i)=>{"use strict";i.d(t,{ChartStorageHttp:()=>_,parseLineToolsAndGroupsDTO:()=>h});var s=i(120780),r=i(895370),o=i(175203),n=i(45696),a=i(198303),l=i(266325);function c(){const e=document.querySelector('link[rel~="chart-storage"]'),t=new URL((null==e?void 0:e.href)||"/charts-storage/",location.href);return t.pathname.endsWith("/")||(t.pathname+="/"),t}function h(e,t){const i={sources:null,groups:new Map};if(null!==e.sources){i.sources=new Map;for(const t in e.sources||{}){const s=e.sources[t];i.sources.set(t,s)}}for(const t in e.drawing_groups||{}){const s=e.drawing_groups[t];i.groups.set(t,s)}return null!==t&&(i.serverRequestId=t),i.clientId=e.clientId,i.symbol=e.symbol,i}function d(e){const{charts:t={},countSourcesTotal:i=0,limitBytesTotal:s=0,sizeBytesTotal:r=0}=e,o=new Map;for(const e in t){const i=t[e].symbols,s=new Map;for(const e in i||{}){const t=i[e];s.set(e,{countSources:t.countSources,sizeBytes:t.sizeBytes,ids:t.ids})}o.set(e,s)}return{charts:o,countSourcesTotal:i,limitBytesTotal:s,sizeBytesTotal:r}}const u={sources:new Map,groups:new Map};class _{constructor(){this._lastSaveRequest=Promise.resolve(),this._requestsCounter=0,this._lastSharedToolsLoadingRequest=Promise.resolve(u)}async saveLineToolsAndGroups(e,t,i,h,d){if(""===e||void 0===e)return Promise.reject("Unnamed chart cannot be saved");const u=`${e}.${t}.${this._requestsCounter++}`,_=`ChartStorage.Save.TotallyProcessing.${u}`,p=(0,r.perfMeasureOperation)(_,(()=>this._lastSaveRequest.then((async()=>{if(null==d?void 0:d.aborted)throw(0,l.createAbortError)();const _=`ChartStorage.Save.GettingToken.${u}`,p=await(0,r.perfMeasureOperation)(_,(()=>(0,n.getStorageTarget)(e,t,h,d))),m=new URL(p.path,c());p.chartId&&m.searchParams.append("chart_id",p.chartId),m.searchParams.append("jwt",p.token);const g=function(e){const t={};return e.sources&&(t.sources={},e.sources.forEach(((e,i)=>{t.sources[i]=e}))),t.drawing_groups={},e.groups.forEach(((e,i)=>{t.drawing_groups[i]=e})),t.clientId=e.clientId,JSON.stringify(t)}(i),S=`ChartStorage.Save.GettingResponse.${u}`;return(0,r.perfMeasureOperation)(S,(()=>(0,s.fetch)(m.toString(),{signal:d,method:"PUT",headers:{"Content-Type":"application/json","X-BUILD-TIME":window.BUILD_TIME},credentials:"include",body:g}).then((e=>{if(!e.ok){const t=429===e.status;throw new a.SavingLineToolsError(t,`Response status is not success: ${e.status}`)}const t=e.json();return o.telemetry.sendLineToolsStorageReport("line_tools_save_success"),t})).then((s=>({content:s,savedDto:i,layoutId:e,chartId:t,sharingMode:h})))))}))));return this._lastSaveRequest=p.catch((e=>{o.telemetry.sendLineToolsStorageReport("line_tools_save_error")})),p}async loadLineToolsAndGroups(e,t,i){if(""===e||void 0===e)return u;const a=`${e}.${t}.${i.requestType}.${this._requestsCounter++}`,l=`ChartStorage.Load.GettingToken.${a}`,d=await(0,r.perfMeasureOperation)(l,(()=>(0,n.getStorageTarget)(e,t,i.sharingMode))),_=`get/${d.path}`,p=new URL(_,c());switch(d.chartId&&p.searchParams.append("chart_id",d.chartId),
p.searchParams.append("jwt",d.token),i.requestType){case"mainSeriesLineTools":p.searchParams.append("symbol",i.symbol),0===i.sharingMode&&p.searchParams.append("includeOwnerSource",i.seriesSourceId),p.searchParams.append("brokerName",i.brokerName);break;case"studiesLineTools":p.searchParams.append("excludeOwnerSource",i.seriesSourceId);break;case"lineToolsWithoutSymbol":p.searchParams.append("symbol",""),0===i.sharingMode&&p.searchParams.append("includeOwnerSource",i.seriesSourceId)}const m=`ChartStorage.Load.GettingResponse.${a}`,g=()=>(0,s.fetch)(p.toString(),{method:"GET",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("Response status is not success");const t=e.headers.get("X-Request-Id");return e.json().then((e=>{if(null===e)throw new Error("Body is null");if(!e.success)throw new Error("Response is not success");const i=h(e.payload||{},t);return o.telemetry.sendLineToolsStorageReport("line_tools_load_success"),i}))})),S=0===i.sharingMode?g:()=>this._lastSharedToolsLoadingRequest.then(g),v=(0,r.perfMeasureOperation)(m,S).catch((e=>{throw o.telemetry.sendLineToolsStorageReport("line_tools_load_error"),e}));return 0!==i.sharingMode&&(this._lastSharedToolsLoadingRequest=v.catch((()=>u))),v}async removeLineTools(e,t,i,a){if(""===e||void 0===e)return!1;const l=`${e}.${t}.${this._requestsCounter++}`,h=`ChartStorage.Remove.GettingToken.${l}`,d=await(0,r.perfMeasureOperation)(h,(()=>(0,n.getStorageTarget)(e,t,i))),u=new URL(d.path,c());d.chartId&&u.searchParams.append("chart_id",d.chartId),u.searchParams.append("jwt",d.token),u.searchParams.append("symbol",a);const _=`ChartStorage.Remove.GettingResponse.${l}`;return(0,r.perfMeasureOperation)(_,(()=>(0,s.fetch)(u.toString(),{method:"DELETE",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("Response status is not success");return e.json().then((e=>{if(null===e)throw new Error("Body is null");if(!e.success)throw new Error("Response is not success");return o.telemetry.sendLineToolsStorageReport("line_tools_remove_by_symbol_success"),!0}))})))).catch((e=>{throw o.telemetry.sendLineToolsStorageReport("line_tools_remove_by_symbol_error"),e}))}async getLayoutDrawingsSizeInfo(e,t){if(""===e||void 0===e)return{charts:new Map,countSourcesTotal:0,limitBytesTotal:0,sizeBytesTotal:0};const i=`${e}.${t}.${this._requestsCounter++}`,s=`ChartStorage.GetSizes.GettingToken.${i}`,a=await(0,r.perfMeasureOperation)(s,(()=>(0,n.getStorageTarget)(e,t,0))),l=new URL(`layout/${e}/sizes`,c());return l.searchParams.append("jwt",a.token),this._fetchData(`ChartStorage.GetSizes.GettingResponse.${i}`,l,{method:"GET",credentials:"include"}).then((e=>(o.telemetry.sendLineToolsStorageReport("line_tools_size_info_success"),d(e||{})))).catch((e=>{throw o.telemetry.sendLineToolsStorageReport("line_tools_size_info_error"),e}))}async getUserGlobalDrawingsSizeInfo(e){if(""===e||void 0===e)return{charts:new Map,countSourcesTotal:0,limitBytesTotal:0,sizeBytesTotal:0};const t=this._requestsCounter++,i=await(0,r.perfMeasureOperation)(`ChartStorage.GetGlobalSizes.GettingToken.${t}`,(()=>(0,
n.getStorageTarget)(e,"",2))),s=new URL("user/sizes",c());return s.searchParams.append("jwt",i.token),this._fetchData(`ChartStorage.GetGlobalSizes.GettingResponse.${t}`,s,{credentials:"include"}).then((e=>(o.telemetry.sendLineToolsStorageReport("global_line_tools_size_info_success"),d(e||{})))).catch((e=>{throw o.telemetry.sendLineToolsStorageReport("global_line_tools_size_info_error"),e}))}async _fetchData(e,t,i){const o=await(0,r.perfMeasureOperation)(e,(()=>(0,s.fetch)(t.toString(),i)));if(!o.ok)throw new Error("Response status is not success");const n=await o.json();if(null===n)throw new Error("Body is null");if(!n.success)throw new Error("Response is not success");return n.payload}}},347402:(e,t,i)=>{"use strict";i.d(t,{desktopVersionIsLess:()=>n,lessThan:()=>o});var s=i(638456);function r(e){const t=e.match(/^(\d+).(\d+).(\d+)/);if(!t)return null;const[,i,s,r]=t;return[parseInt(i),parseInt(s),parseInt(r)]}function o(e,t){const i=r(e),s=r(t);if(!i||!s)return!1;const[o,n,a]=i,[l,c,h]=s;return o!==l?o<l:n!==c?n<c:a!==h&&a<h}function n(e){const t=(0,s.desktopAppVersion)();return!!t&&o(t,e)}},752604:(e,t,i)=>{"use strict";i.d(t,{isCountryCode:()=>r,toCountryCode:()=>o});const s=/^[A-Z]{2}$/;function r(e){return s.test(e)}function o(e){if(r(e))return e;throw new Error("Invalid country code")}},196726:(e,t,i)=>{"use strict";i.d(t,{preventDefault:()=>r,preventScrollByWheelClick:()=>n,wrapHandlerWithPreventEvent:()=>o});var s=i(638456);function r(e){e.cancelable&&e.preventDefault()}function o(e){return t=>{r(t),e()}}function n(e){s.isChrome&&e.addEventListener("mousedown",(e=>{if(1===e.button)return e.preventDefault(),!1}))}},709404:(e,t,i)=>{"use strict";i.d(t,{getExchanges:()=>r});var s=i(279274);function r(){return s}},515312:(e,t,i)=>{"use strict";i.d(t,{isNativeUIInteraction:()=>s.isNativeUIInteraction,isTextEditingField:()=>s.isTextEditingField});var s=i(607423)},963568:(e,t,i)=>{"use strict";i.d(t,{retries:()=>o,retriesWithDelays:()=>n});var s=i(266325);async function r(e,t,i){let s;for(let r=0;r<t;++r)try{return await e(s)}catch(e){s=e,await i(r)}throw s}async function o(e,t){return r(e,t,(()=>Promise.resolve()))}async function n(e,t){return r(e,t.length+1,(e=>e<t.length?(0,s.delay)(null,t[e]):Promise.resolve()))}},67302:(e,t,i)=>{"use strict";i.d(t,{showThemeAction:()=>n,showThemeSwitcher:()=>o});var s=i(638456),r=i(347402);function o(){return!(0,s.isDesktopApp)()||(0,r.desktopVersionIsLess)("1.0.10")}function n(){return(0,s.isDesktopApp)()&&!(0,r.desktopVersionIsLess)("1.0.11")}},247001:(e,t,i)=>{"use strict";i.d(t,{trackStudies:()=>o});var s=i(776734),r=i(526075);function o(e,t){const i=e.metaInfo(),o=!e.isPine()||e.isStandardPine()?i.description:i.scriptIdPart,n=i.productId,a=r.StudyMetaInfo.isScriptStrategy(i),l=window.user&&window.user.pro_plan||"";(0,s.getTracker)().then((e=>{e&&e.trackStudiesAnalytics(o,n,t,a,l)}))}},875049:(e,t,i)=>{"use strict";i.d(t,{default:()=>o});var s=i(345848);const r={filterNamesMap:{script_type:"Indicators and Strategies","script_type-indicators":"Indicators",
"script_type-strategies":"Strategies",stream:"All Markets","stream-stocks":"Stocks","stream-indices":"Indices","stream-commodities":"Commodities","stream-currencies":"Currencies","stream-bitcoin":"Bitcoin","interval-all":"All Intervals","interval-m":"Short Term","interval-h":"Medium Term","interval-dwm":"Long Term","sort-unmoderated":"Unmoderated","sort-trending":"Trending","sort-discussed":"Most Discussed","sort-viewed":"Most Viewed","sort-agreed":"Most Agreed","sort-suggested":"Suggested","sort-recent":"All Ideas","time-day":"Today","time-week":"This Week","time-month":"This Month","time-all":"All Time","by-everyone":"Everyone","by-following":"Following","by-me":"My Ideas"},goProFeaturesMap:{customIntervals:"Add Custom Interval",intradaySpread:"Inraday Spread",kagiRenko:"Japanese Intraday Chart",alerts:{prefix:"New Alerts Limit",widget:"Widget",chart:"Chart Header"},multipleCharts:"Multiple Charts Layout",savedChartsLimit:"Save Chart Limit",studyLimit:"Studies Limit",multipleWatchLists:{prefix:"Watchlists",new:"Create New List",rename:"Rename List",saveAs:"Save List As"},importWatchlist:"Watchlists Import Watchlist",exportWatchlist:"Watchlists Export Watchlist",BATSExchangePopup:"BATS Exchange Popup",DataQualityPopup:"Data Quality Popup",FreeDelayPopup:"Free Delay Popup",proRTProduct:"Volume Profile",studyOnStudy:"Unlimited Study on Study"},trackFeature:{savedChartsLimit:!0,BATSExchangePopup:!0,FreeDelayPopup:!0,DataQualityPopup:!0,intradaySpread:!0,studyOnStudy:!0},trackGoPro:function(e,t,i){i&&!t&&(t=i,i=null);var o=r.goProFeaturesMap[t];if(o){if(i){if("string"==typeof o)return;o="{0} {1}".format(o.prefix,o[i])}(0,s.trackEvent)(e,o)}}},o=r},405117:(e,t,i)=>{"use strict";i.r(t),i.d(t,{trackGoProFeature:()=>r});var s=i(875049);function r(e,t){s.default.trackGoPro("Gopro Features",e,t)}},560420:(e,t,i)=>{"use strict";i.d(t,{activateKeyPressHandler:()=>u,showDialog:()=>_});var s=i(449628),r=i(826531),o=i(244842),n=i(230296),a=i(868683),l=i(34831),c=i(345848);let h=null;function d(e){if(!(0,r.globalKeypressMatches)(e))return!1;e.preventDefault();const t=String.fromCharCode(e.charCode);return o.enabled("show_interval_dialog_on_key_press")&&function(e){return/[1-9]/.test(e)}(t)?(0,n.showChangeIntervalDialogAsync)({initVal:t}):o.enabled("symbol_search_hot_key")&&(_({defaultValue:t,selectSearchOnInit:!1,source:"keyboard",trackResultsOptions:{trackResults:!o.enabled("widget"),emptySearchType:"empty_result__supercharts"}}),(0,c.trackEvent)("GUI","SS","hotkey")),!0}function u(){(0,a.loadChangeIntervalDialog)(),s.pushBackListener("symbolEdit",d)}function _(e){const t=h=(0,l.loadNewSymbolSearch)().then((i=>{t===h&&i.showDefaultSearchDialog(e)}));return t}},711496:(e,t,i)=>{"use strict";i.d(t,{hasFinancialsByAvailabilityFlags:()=>h,hasFinancialsByTypespecs:()=>c});var s=i(519073);const r=new Set(["stock","dr","right","warrant","structured","bond"]),o=new Set(["mutual","unit","trust","reit","closedend","etn"]),n=new Set(["etn"]),a=new Set(["convertible","corporate"]),l=new Set(["cfd"]);function c(e,t){return!(e&&t&&(0,
s.isEtf)(e,t))&&("structured"===e&&(null==t?void 0:t.length)?t.filter((e=>n.has(e))).length>0:"fund"===e&&(null==t?void 0:t.length)?t.filter((e=>o.has(e))).length>0:"bond"===e&&(null==t?void 0:t.length)?t.filter((e=>a.has(e))).length>0:"stock"===e&&(null==t?void 0:t.length)?0===t.filter((e=>l.has(e))).length:Boolean(e&&r.has(e)))}function h(e,t,i){if(t&&i&&(0,s.isEtf)(t,i))return!1;const{dividendsAvailability:r,earningsAvailability:o,financialsAvailability:n}=e;return 1===n||1===r||1===o}},2606:(e,t,i)=>{"use strict";i.d(t,{isDetailsReady:()=>s});const s=new(i(401580).WatchedValue)(!1)},137674:(e,t,i)=>{"use strict";i.d(t,{createSymbolNote:()=>m,showSymbolIdeas:()=>_,showSymbolMinds:()=>p,showSymbolNews:()=>u,showSymbolNotes:()=>d});var s=i(2606),r=i(421219),o=i(777453);async function n(e){Promise.all([i.e(38507),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(34465),i.e(69121),i.e(38669),i.e(35649),i.e(5145),i.e(89842),i.e(25190),i.e(87845),i.e(58056),i.e(21625),i.e(61631),i.e(73954),i.e(34186),i.e(90592),i.e(98535),i.e(28345),i.e(70235),i.e(86102),i.e(50690),i.e(26300),i.e(57413),i.e(98955),i.e(92780),i.e(50996)]).then(i.bind(i,768175)).then((t=>{t.renderNotesDialog(e)}))}var a=i(881607);var l=i(515828);let c=null;function h(e,t){if(c&&s.isDetailsReady.unsubscribe(c),c=()=>{var i,s,r;(null===(r=null===(s=null===(i=null===window||void 0===window?void 0:window.widgetbar)||void 0===i?void 0:i.layout)||void 0===s?void 0:s.getWidgetByType("detail"))||void 0===r?void 0:r.widgetObject).navigate(e,t)},s.isDetailsReady.value())return c(),void(c=null);s.isDetailsReady.subscribe(c,{once:!0})}function d(e=null,t){const i=(0,r.pathToGroup)(null!=e?e:"");t?n(i):h(i)}function u(e,t){const s=(0,o.newsPathToGroup)(null!=e?e:"");t?async function(e){(await Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(4015),i.e(38669),i.e(5145),i.e(89842),i.e(25190),i.e(88548),i.e(13423),i.e(36747),i.e(21625),i.e(61631),i.e(52567),i.e(58666),i.e(92991),i.e(76972),i.e(98535),i.e(39164),i.e(50938),i.e(45932),i.e(84998),i.e(86944),i.e(50690),i.e(11843),i.e(55325),i.e(40619),i.e(21392),i.e(21635),i.e(84482)]).then(i.bind(i,23154))).renderNewsDialog(e)}(s):h(s)}function _(e,t){const s=(0,a.ideasPathToGroup)(null!=e?e:"");t?async function(e){(await Promise.all([i.e(39138),i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(4015),i.e(92191),i.e(38669),i.e(5145),i.e(89842),i.e(25190),i.e(88548),i.e(36747),i.e(21625),i.e(61631),i.e(45896),i.e(52567),i.e(42244),i.e(76972),i.e(98535),i.e(50938),i.e(71793),i.e(35306),i.e(47768),i.e(50690),i.e(24951),i.e(55325),i.e(40619),i.e(5953),i.e(94673)]).then(i.bind(i,790348))).renderIdeasDialog(e)}(s):h(s)}function p(e){h((0,l.mindsPathToGroup)(null!=e?e:""))}function m(e=null,t){const i=(0,r.pathToGroup)(null!=e?e:"")+"?new="+performance.now();t&&n(i),h(i)}},881607:(e,t,i)=>{"use strict";i.d(t,{IDEAS_GROUP_PATH_PATTERN:()=>s,ideasPathToGroup:()=>r});const s="/ideas/groups/:symbol/";function r(e){return s.replace(":symbol",encodeURIComponent(e))}},777453:(e,t,i)=>{"use strict"
;i.d(t,{NEWS_GROUP_PATH_PATTERN:()=>s,newsPathToGroup:()=>r});const s="/news/groups/:symbol/";function r(e){return s.replace(":symbol",encodeURIComponent(e))}},421219:(e,t,i)=>{"use strict";i.d(t,{GROUP_PATH_PATTERN:()=>r,NOTES_PATH_PATTERN:()=>s,UNATTENDED_PATH_PATTERN:()=>o,pathToGroup:()=>n});const s="/notes/",r="/notes/groups/:symbol/",o="/notes/unattended/";function n(e){return e?r.replace(":symbol",encodeURIComponent(e)):o}},834698:(e,t,i)=>{"use strict";i.d(t,{CompareDialogRenderer:()=>o});var s=i(111393);var r=i(251954);class o extends s.DialogRenderer{constructor(e){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)},this._chartWidgetCollection=e}show(e){this._load().then((t=>{var i,s;null===(i=this._dialog)||void 0===i||i.hide(),null===(s=this._dialog)||void 0===s||s.visible().unsubscribe(this._subscribe),this._dialog=t,t.visible().subscribe(this._subscribe),t.show(e),r.emit("compare_add")}))}hide(){var e;null===(e=this._dialog)||void 0===e||e.hide()}_load(){return Promise.all([Promise.all([i.e(70166),i.e(57271)]).then(i.bind(i,910261)),Promise.all([i.e(70166),i.e(44636),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(26855),i.e(58056),i.e(21625),i.e(91033),i.e(61631),i.e(90684),i.e(40866),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(77807),i.e(58289),i.e(43445),i.e(21895),i.e(56949),i.e(73353),i.e(91070),i.e(50690),i.e(30979),i.e(26300),i.e(95961),i.e(37457),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(30731)]).then(i.bind(i,160654))]).then((([e,t])=>{const i=new e.CompareModel(this._chartWidgetCollection);return t.getCompareDialogRenderer(i)}))}}},105580:(e,t,i)=>{"use strict";i.d(t,{showDetailsDialog:()=>n});var s=i(111393);let r;class o extends s.DialogRenderer{constructor(){super(...arguments),this._dialog=null,this._promise=null,this._subscribe=e=>{this._setVisibility(e)}}show(e){const t=this._promise=Promise.all([i.e(70166),i.e(68716),i.e(11544),i.e(35613),i.e(93483),i.e(46855),i.e(75424),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(38669),i.e(35649),i.e(5145),i.e(89842),i.e(30006),i.e(25190),i.e(88548),i.e(68992),i.e(36747),i.e(58056),i.e(21625),i.e(61631),i.e(67080),i.e(52567),i.e(57215),i.e(94345),i.e(58666),i.e(92991),i.e(76972),i.e(25626),i.e(54690),i.e(66886),i.e(50254),i.e(39760),i.e(39164),i.e(10690),i.e(28345),i.e(45932),i.e(18070),i.e(17194),i.e(86341),i.e(96234),i.e(50690),i.e(26300),i.e(57413),i.e(94065),i.e(21242),i.e(61259),i.e(83433),i.e(85841),i.e(44246),i.e(51022),i.e(13),i.e(61597),i.e(36974),i.e(29170),i.e(9753),i.e(21635),i.e(44442),i.e(26720)]).then(i.bind(i,863308)).then((i=>{this._promise===t&&(this._dialog&&(this._dialog.hide(),this._dialog.visible().unsubscribe(this._subscribe)),this._dialog=new i.DetailsDialogRenderer,this._dialog.visible().subscribe(this._subscribe),this._dialog.show(e))}))}hide(){var e,t
;null===(e=this._dialog)||void 0===e||e.hide(),null===(t=this._dialog)||void 0===t||t.visible().unsubscribe(this._subscribe)}static getInstance(){return r||(r=new o),r}}function n(e){o.getInstance().show(e)}},597101:(e,t,i)=>{"use strict";i.d(t,{hideStateChange:()=>s});const s=new(i(707957).Delegate)},161590:(e,t,i)=>{"use strict";i.d(t,{GeneralChartPropertiesRenderer:()=>r});var s=i(111393);class r extends s.DialogRenderer{constructor(e){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)},this._chartWidgetCollection=e}show(e){const t=this._chartWidgetCollection,s=t.activeChartWidget.value();return s.generalPropertiesDefinitions().then((r=>Promise.all([i.e(70166),i.e(44636),i.e(88601),i.e(90674),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(36884),i.e(46036),i.e(68992),i.e(87845),i.e(26855),i.e(58056),i.e(13152),i.e(21625),i.e(84281),i.e(91033),i.e(61631),i.e(90684),i.e(40866),i.e(99916),i.e(43610),i.e(73954),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(98149),i.e(77807),i.e(89434),i.e(8740),i.e(58289),i.e(24215),i.e(43445),i.e(18511),i.e(26053),i.e(21895),i.e(22333),i.e(54474),i.e(15886),i.e(36740),i.e(75058),i.e(85256),i.e(18182),i.e(73606),i.e(24534),i.e(14127),i.e(88506),i.e(63616),i.e(69523),i.e(50690),i.e(30979),i.e(26300),i.e(67209),i.e(31142),i.e(37457),i.e(68985),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(44111),i.e(85871),i.e(93656),i.e(81245),i.e(37078)]).then(i.bind(i,824306)).then((i=>{var o,n;const a=new i.GeneralChartPropertiesDialogRenderer({chartWidgetCollection:t,propertyPages:r,activePageId:this._activePageId,model:s.model()});return null===(o=this._dialog)||void 0===o||o.hide(),null===(n=this._dialog)||void 0===n||n.visible().unsubscribe(this._subscribe),this._dialog=a,a.visible().subscribe(this._subscribe),a.show(e),this._activePageId=void 0,a}))))}hide(){var e;null===(e=this._dialog)||void 0===e||e.hide()}isVisible(){return this.visible().value()}focusOnText(){}setActivePage(e){this._activePageId=e}}},83871:(e,t,i)=>{"use strict";i.d(t,{SYMBOL_LIST_SERVICE:()=>s});const s={id:"SymbolListService"}},306388:(e,t,i)=>{"use strict";i.d(t,{initSymbolListService:()=>o});var s=i(564894),r=i(83871);function o(){
return Promise.all([Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(88194),i.e(30006),i.e(26855),i.e(43610),i.e(96899),i.e(50690),i.e(26300),i.e(29594),i.e(10758),i.e(21065),i.e(745),i.e(37457),i.e(55404),i.e(87092),i.e(29772),i.e(4157),i.e(1867),i.e(1026)]).then(i.bind(i,818062)),Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(88194),i.e(30006),i.e(26855),i.e(43610),i.e(96899),i.e(50690),i.e(26300),i.e(29594),i.e(10758),i.e(21065),i.e(745),i.e(37457),i.e(55404),i.e(87092),i.e(29772),i.e(4157),i.e(1867),i.e(1026)]).then(i.bind(i,38506)),Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(88194),i.e(30006),i.e(26855),i.e(43610),i.e(96899),i.e(50690),i.e(26300),i.e(29594),i.e(10758),i.e(21065),i.e(745),i.e(37457),i.e(55404),i.e(87092),i.e(29772),i.e(4157),i.e(1867),i.e(1026)]).then(i.bind(i,850935)),Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(88194),i.e(30006),i.e(26855),i.e(43610),i.e(96899),i.e(50690),i.e(26300),i.e(29594),i.e(10758),i.e(21065),i.e(745),i.e(37457),i.e(55404),i.e(87092),i.e(29772),i.e(4157),i.e(1867),i.e(1026)]).then(i.bind(i,244692))]).then((([e,t,i,o])=>{if((0,s.hasService)(r.SYMBOL_LIST_SERVICE))return(0,s.service)(r.SYMBOL_LIST_SERVICE);const{store:n,runner:a}=e.configureStore(),l=a.run(t.symbolListRepositorySaga);return(0,s.registerService)(r.SYMBOL_LIST_SERVICE,{store:n,runner:a,actions:{addSymbols:o.addSymbolsThunk,initWidget:i.initWidget,saveListAs:o.saveListAsThunk,createNewWatchList:o.userCreateWatchlistThunk},task:l}),(0,s.service)(r.SYMBOL_LIST_SERVICE)}))}},826939:(e,t,i)=>{"use strict";i.d(t,{WATCHLIST_WIDGET_ID:()=>s});const s="watchlist-widget"},104436:(e,t,i)=>{"use strict";var s;i.d(t,{ToolboxType:()=>s}),function(e){e[e.Delete=0]="Delete"}(s||(s={}))},581501:e=>{e.exports={chartsSplitter:"chartsSplitter-L0xapso5",hovered:"hovered-L0xapso5","i-active":"i-active-L0xapso5"}},871332:e=>{e.exports={"css-value-pane-controls-padding-left":"1px","css-value-pane-controls-padding-right":"4px"}},630383:e=>{e.exports={paneSeparator:"paneSeparator-uqBaC1Ki",handle:"handle-uqBaC1Ki",hovered:"hovered-uqBaC1Ki",active:"active-uqBaC1Ki"}},758035:e=>{e.exports={priceScaleModeButtons:"priceScaleModeButtons-PEm49B2T",priceScaleModeButtons__button:"priceScaleModeButtons__button-PEm49B2T",priceScaleModeButtons__button_activated:"priceScaleModeButtons__button_activated-PEm49B2T"}},364123:e=>{e.exports={"css-value-small-size":"18px","css-value-medium-size":"22px","css-value-large-size":"28px","css-value-border-radius-small-size":"9px","css-value-border-radius-medium-size":"11px","css-value-border-radius-large-size":"8px",statuses:"statuses-Lgtz1OtS",statusItem:"statusItem-Lgtz1OtS",statuses_hidden:"statuses_hidden-Lgtz1OtS",small:"small-Lgtz1OtS",medium:"medium-Lgtz1OtS",large:"large-Lgtz1OtS",blinking:"blinking-Lgtz1OtS","blinking-animation":"blinking-animation-Lgtz1OtS",
marketStatusOpen:"marketStatusOpen-Lgtz1OtS",marketStatusClose:"marketStatusClose-Lgtz1OtS",marketStatusPre:"marketStatusPre-Lgtz1OtS",marketStatusPost:"marketStatusPost-Lgtz1OtS",marketStatusHoliday:"marketStatusHoliday-Lgtz1OtS",marketStatusExpired:"marketStatusExpired-Lgtz1OtS",marketStatusCustom:"marketStatusCustom-Lgtz1OtS",invalidSymbol:"invalidSymbol-Lgtz1OtS",replayModeAutoPlay:"replayModeAutoPlay-Lgtz1OtS",replayModePause:"replayModePause-Lgtz1OtS",replayModePointSelect:"replayModePointSelect-Lgtz1OtS","blinking-animation-custom":"blinking-animation-custom-Lgtz1OtS",notAccurate:"notAccurate-Lgtz1OtS",delay:"delay-Lgtz1OtS",eod:"eod-Lgtz1OtS",dataProblemHigh:"dataProblemHigh-Lgtz1OtS",dataProblemLow:"dataProblemLow-Lgtz1OtS"}},531005:(e,t,i)=>{"use strict";i.d(t,{reconnectChartApi:()=>s,setBroker:()=>r});i(730128);function s(e){const t=window.ChartApiInstance;window.is_authenticated&&(t.disconnect(),e&&t.authTokenManager().reset(),setTimeout((()=>t.connect()),500))}function r(e){window.ChartApiInstance.setBroker(e)}},315347:(e,t,i)=>{"use strict";var s,r;function o(e,t){return"period-back"===e.type&&"period-back"===t.type?e.value===t.value:"time-range"===e.type&&"time-range"===t.type&&(e.from===t.from&&e.to===t.to)}i.d(t,{TIMEFRAMETYPE:()=>r,areEqualTimeFrames:()=>o}),function(e){e.extractErrorReason=function(e){return e.params[1]}}(s||(s={})),function(e){e.PeriodBack="period-back",e.TimeRange="time-range"}(r||(r={}))},15458:(e,t,i)=>{"use strict";i.r(t),i.d(t,{availableTimezones:()=>l,timezoneIsAvailable:()=>u,timezoneIsSupported:()=>_,timezoneTitle:()=>p,updateAvailableTimezones:()=>d});var s=i(444372),r=i(245302);const o=[{id:"Etc/UTC",title:s.t(null,void 0,i(850406))},{id:"exchange",title:s.t(null,void 0,i(777295))}],n=[{id:"Africa/Cairo",title:s.t(null,void 0,i(994099)),offset:0},{id:"Africa/Casablanca",title:s.t(null,void 0,i(753705)),offset:0},{id:"Africa/Johannesburg",title:s.t(null,void 0,i(387469)),offset:0},{id:"Africa/Lagos",title:s.t(null,void 0,i(89155)),offset:0},{id:"Africa/Nairobi",title:s.t(null,void 0,i(679023)),offset:0},{id:"Africa/Tunis",title:s.t(null,void 0,i(193855)),offset:0},{id:"America/Anchorage",title:s.t(null,void 0,i(399873)),offset:0},{id:"America/Argentina/Buenos_Aires",title:s.t(null,void 0,i(882446)),offset:0},{id:"America/Bogota",title:s.t(null,void 0,i(54173)),offset:0},{id:"America/Caracas",title:s.t(null,void 0,i(846837)),offset:0},{id:"America/Chicago",title:s.t(null,void 0,i(228244)),offset:0},{id:"America/El_Salvador",title:s.t(null,void 0,i(768553)),offset:0},{id:"America/Juneau",title:s.t(null,void 0,i(124435)),offset:0},{id:"America/Lima",title:s.t(null,void 0,i(725846)),offset:0},{id:"America/Los_Angeles",title:s.t(null,void 0,i(687604)),offset:0},{id:"America/Mexico_City",title:s.t(null,void 0,i(185095)),offset:0},{id:"America/New_York",title:s.t(null,void 0,i(291203)),offset:0},{id:"America/Phoenix",title:s.t(null,void 0,i(219093)),offset:0},{id:"America/Santiago",title:s.t(null,void 0,i(965412)),offset:0},{id:"America/Sao_Paulo",
title:s.t(null,void 0,i(913538)),offset:0},{id:"America/Toronto",title:s.t(null,void 0,i(83836)),offset:0},{id:"America/Vancouver",title:s.t(null,void 0,i(115771)),offset:0},{id:"US/Mountain",title:s.t(null,void 0,i(257701)),offset:0},{id:"Asia/Almaty",title:s.t(null,void 0,i(14452)),offset:0},{id:"Asia/Ashkhabad",title:s.t(null,void 0,i(559340)),offset:0},{id:"Asia/Bahrain",title:s.t(null,void 0,i(53260)),offset:0},{id:"Asia/Bangkok",title:s.t(null,void 0,i(732376)),offset:0},{id:"Asia/Chongqing",title:s.t(null,void 0,i(649648)),offset:0},{id:"Asia/Colombo",title:s.t(null,void 0,i(115168)),offset:0},{id:"Asia/Dhaka",title:s.t(null,void 0,i(724477)),offset:0},{id:"Asia/Dubai",title:s.t(null,void 0,i(822429)),offset:0},{id:"Asia/Ho_Chi_Minh",title:s.t(null,void 0,i(587338)),offset:0},{id:"Asia/Hong_Kong",title:s.t(null,void 0,i(532918)),offset:0},{id:"Asia/Jakarta",title:s.t(null,void 0,i(652707)),offset:0},{id:"Asia/Jerusalem",title:s.t(null,void 0,i(642890)),offset:0},{id:"Asia/Karachi",title:s.t(null,void 0,i(202693)),offset:0},{id:"Asia/Kathmandu",title:s.t(null,void 0,i(303155)),offset:0},{id:"Asia/Kolkata",title:s.t(null,void 0,i(916245)),offset:0},{id:"Asia/Kuwait",title:s.t(null,void 0,i(872374)),offset:0},{id:"Asia/Manila",title:s.t(null,void 0,i(290271)),offset:0},{id:"Asia/Muscat",title:s.t(null,void 0,i(442769)),offset:0},{id:"Asia/Nicosia",title:s.t(null,void 0,i(733566)),offset:0},{id:"Asia/Qatar",title:s.t(null,void 0,i(619056)),offset:0},{id:"Asia/Riyadh",title:s.t(null,void 0,i(152588)),offset:0},{id:"Asia/Seoul",title:s.t(null,void 0,i(605961)),offset:0},{id:"Asia/Shanghai",title:s.t(null,void 0,i(969240)),offset:0},{id:"Asia/Singapore",title:s.t(null,void 0,i(156683)),offset:0},{id:"Asia/Taipei",title:s.t(null,void 0,i(438788)),offset:0},{id:"Asia/Tehran",title:s.t(null,void 0,i(16267)),offset:0},{id:"Asia/Tokyo",title:s.t(null,void 0,i(294284)),offset:0},{id:"Asia/Yangon",title:s.t(null,void 0,i(769293)),offset:0},{id:"Atlantic/Reykjavik",title:s.t(null,void 0,i(626833)),offset:0},{id:"Australia/Adelaide",title:s.t(null,void 0,i(717365)),offset:0},{id:"Australia/Brisbane",title:s.t(null,void 0,i(511741)),offset:0},{id:"Australia/Perth",title:s.t(null,void 0,i(635590)),offset:0},{id:"Australia/Sydney",title:s.t(null,void 0,i(111020)),offset:0},{id:"Europe/Amsterdam",title:s.t(null,void 0,i(688010)),offset:0},{id:"Europe/Athens",title:s.t(null,void 0,i(921983)),offset:0},{id:"Europe/Belgrade",title:s.t(null,void 0,i(254861)),offset:0},{id:"Europe/Berlin",title:s.t(null,void 0,i(326825)),offset:0},{id:"Europe/Bratislava",title:s.t(null,void 0,i(605262)),offset:0},{id:"Europe/Brussels",title:s.t(null,void 0,i(690204)),offset:0},{id:"Europe/Bucharest",title:s.t(null,void 0,i(537728)),offset:0},{id:"Europe/Budapest",title:s.t(null,void 0,i(787143)),offset:0},{id:"Europe/Copenhagen",title:s.t(null,void 0,i(743432)),offset:0},{id:"Europe/Dublin",title:s.t(null,void 0,i(609497)),offset:0},{id:"Europe/Helsinki",title:s.t(null,void 0,i(899820)),offset:0},{id:"Europe/Istanbul",title:s.t(null,void 0,i(537885)),
offset:0},{id:"Europe/Lisbon",title:s.t(null,void 0,i(450091)),offset:0},{id:"Europe/London",title:s.t(null,void 0,i(50286)),offset:0},{id:"Europe/Luxembourg",title:s.t(null,void 0,i(164352)),offset:0},{id:"Europe/Madrid",title:s.t(null,void 0,i(758038)),offset:0},{id:"Europe/Malta",title:s.t(null,void 0,i(334190)),offset:0},{id:"Europe/Moscow",title:s.t(null,void 0,i(118665)),offset:0},{id:"Europe/Oslo",title:s.t(null,void 0,i(782906)),offset:0},{id:"Europe/Paris",title:s.t(null,void 0,i(595995)),offset:0},{id:"Europe/Prague",title:s.t(null,void 0,i(546298)),offset:0},{id:"Europe/Riga",title:s.t(null,void 0,i(605871)),offset:0},{id:"Europe/Rome",title:s.t(null,void 0,i(974214)),offset:0},{id:"Europe/Stockholm",title:s.t(null,void 0,i(248767)),offset:0},{id:"Europe/Tallinn",title:s.t(null,void 0,i(939108)),offset:0},{id:"Europe/Vienna",title:s.t(null,void 0,i(732166)),offset:0},{id:"Europe/Vilnius",title:s.t(null,void 0,i(475354)),offset:0},{id:"Europe/Warsaw",title:s.t(null,void 0,i(48474)),offset:0},{id:"Europe/Zurich",title:s.t(null,void 0,i(984301)),offset:0},{id:"Pacific/Auckland",title:s.t(null,void 0,i(824143)),offset:0},{id:"Pacific/Chatham",title:s.t(null,void 0,i(59884)),offset:0},{id:"Pacific/Fakaofo",title:s.t(null,void 0,i(520466)),offset:0},{id:"Pacific/Honolulu",title:s.t(null,void 0,i(961351)),offset:0},{id:"Pacific/Norfolk",title:s.t(null,void 0,i(99203)),offset:0}];function a(e,t,i){const s=function(e){return e.map((({id:e,title:t})=>{const{string:i,offset:s}=(0,r.parseTzOffset)(e);return{id:e,offset:s,title:`(${i}) ${t}`}}))}(e),o=i.filter((({alias:e})=>Boolean(e))).map((({title:e,alias:t,id:i})=>{const{string:s,offset:o}=(0,r.parseTzOffset)(t);return{id:i,offset:o,title:`(${s}) ${e}`,alias:t}})),n=function(e){return e.sort(((e,t)=>{const i=e.offset-t.offset;return 0!==i?i:e.title.localeCompare(t.title)}))}(s.concat(o));return t.concat(n)}const l=a(n,o,[]),c=new Map;l.forEach((e=>{c.set(e.id,!0)}));const h=new Map;o.concat(n).forEach((e=>{h.set(e.id,!0)}));const d=e=>{l.splice(0,l.length,...a(n,o,e)),l.forEach((e=>{c.set(e.id,!0)}))};function u(e){return c.has(e)}function _(e){return h.get(e)||!1}function p(e){for(const{id:t,title:i}of n)if(t===e){return`${i} (${(0,r.parseTzOffset)(e).string})`}for(const{id:t,title:i}of l)if(t===e)return`${i}`;return e}},356893:(e,t,i)=>{"use strict";i.d(t,{clipboardDataForSources:()=>l,isLineToolClipboardData:()=>a});var s=i(650151),r=i(982217),o=i(161488),n=i(713473);function a(e){return"drawing"===e.type}function l(e,t){if(1===t.length&&(0,o.isStudy)(t[0])){const e=t[0];return{title:e.title(r.TitleDisplayTarget.StatusLine),sources:[{source:(0,s.ensureNotNull)(e.state()),type:"study"}]}}const i={sources:[],title:""};return i.sources=t.filter((e=>e.copiable()&&(0,n.isLineTool)(e))).map((t=>{const i={type:"drawing",geometry:t.geometry(),source:{...t.state(!1),points:t.normalizedPoints()},modelId:e};return delete i.source.alertId,i})),i.sources.length>0?(1===i.sources.length?i.title=t[0].title(r.TitleDisplayTarget.StatusLine):i.title="Drawings",i):null}},
237872:(e,t,i)=>{"use strict";i.d(t,{ChartHotkeysListener:()=>v,globalEnvironmentState:()=>S,modifierPressed:()=>g,shiftPressed:()=>m});var s,r,o,n=i(799786),a=i(470316),l=i(515312),c=i(401580),h=i(950740);const d=new c.WatchedValue(Boolean((null!==(s=n.pressedKeys.value())&&void 0!==s?s:0)&a.Modifiers.Shift)),u=new c.WatchedValue(Boolean((null!==(r=n.pressedKeys.value())&&void 0!==r?r:0)&a.Modifiers.Mod)),_=new c.WatchedValue(Boolean((null!==(o=n.pressedKeys.value())&&void 0!==o?o:0)&a.Modifiers.Alt)),p=[a.Modifiers.None,a.Modifiers.Alt,a.Modifiers.Mod,a.Modifiers.Alt+a.Modifiers.Shift];function m(){return d}function g(){return u}function S(){return new h.EnvironmentState({altKey:_.value(),ctrlKey:g().value(),metaKey:g().value(),shiftKey:m().value()})}n.pressedKeys.subscribe(((e=0)=>{d.setValue(Boolean(e&a.Modifiers.Shift)),u.setValue(Boolean(e&a.Modifiers.Mod)),_.setValue(Boolean(e&a.Modifiers.Alt))}));class v{constructor(e,t){this._pressedKeyCode=null,this._boundKeydownHandler=null,this._boundKeyupHandler=null,this._chartWidget=e,this._parent=t,this._boundKeydownHandler=this._keydownHandler.bind(this),this._boundKeyupHandler=this._keyupHandler.bind(this),this._parent.ownerDocument.addEventListener("keydown",this._boundKeydownHandler),this._parent.ownerDocument.addEventListener("keyup",this._boundKeyupHandler)}destroy(){null!==this._boundKeydownHandler&&(this._parent.ownerDocument.removeEventListener("keydown",this._boundKeydownHandler),this._boundKeydownHandler=null),null!==this._boundKeyupHandler&&(this._parent.ownerDocument.removeEventListener("keyup",this._boundKeyupHandler),this._boundKeyupHandler=null)}_keydownHandler(e){this._chartWidget.hasModel()&&window.document.activeElement===window.document.body&&this._chartWidget.isActive()&&(this._handleMoveDrawingsKeyDown(e)||this._handleScrollKeyDown(e)||this._handleZoomKeyDown(e))&&e.preventDefault()}_keyupHandler(e){this._chartWidget.hasModel()&&this._handleScrollKeyUp(e)}_handleMoveDrawingsKeyDown(e){const t=255&(0,a.hashFromEvent)(e),i=this._chartWidget.model();switch(t){case 37:return i.moveSelectedToolsLeft();case 39:return i.moveSelectedToolsRight();case 38:return i.moveSelectedToolsUp();case 40:return i.moveSelectedToolsDown()}return!1}_handleScrollKeyDown(e){if(null!==this._pressedKeyCode)return!1;const t=(0,a.hashFromEvent)(e),i=255&t,s=(0,a.modifiersFromEvent)(e);let r;if(37===i)r=1;else{if(39!==i)return!1;r=-1}return!(a.isMacKeyboard&&s===a.Modifiers.Mod||!p.includes(s))&&(!(0,l.isNativeUIInteraction)(t,e.target)&&(this._pressedKeyCode=i,s===a.Modifiers.None?this._chartWidget.scrollHelper().moveByBar(r):s===a.Modifiers.Alt||s===a.Modifiers.Mod?this._chartWidget.scrollHelper().move(r):-1===r?this._chartWidget.model().timeScale().scrollToRealtime(!0):this._chartWidget.model().timeScale().scrollToFirstBar(),!0))}_handleScrollKeyUp(e){if(null===this._pressedKeyCode)return!1;const t=(0,a.hashFromEvent)(e);if((0,l.isNativeUIInteraction)(t,e.target))return!1;return(255&t)===this._pressedKeyCode&&(this._pressedKeyCode=null,
this._chartWidget.scrollHelper().stopMove(),!0)}_handleZoomKeyDown(e){const t=(0,a.hashFromEvent)(e),i=255&t;if((0,a.modifiersFromEvent)(e)!==a.Modifiers.Mod||(0,l.isNativeUIInteraction)(t,e.target))return!1;const s=this._chartWidget.model();if(38===i)s.zoomIn();else{if(40!==i)return!1;s.zoomOut()}return!0}}},655068:(e,t,i)=>{"use strict";i.d(t,{ChartWidgetBase:()=>Ds});var s=i(327714),r=i(650151),o=i(591800),n=i(444372),a=i(201089);function l(e,t){const i=Object.create(Object.getPrototypeOf(e));for(const s of t)Object.prototype.hasOwnProperty.call(e,s)&&(i[s]=e[s]);return i}var c=i(62802),h=i(638456),d=i(268222),u=i(251954),_=i(111393);let p;class m extends _.DialogRenderer{constructor(){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)}}show(){this._load().then((e=>e.show()))}hide(){var e;null===(e=this._dialog)||void 0===e||e.hide()}static getInstance(){return p||(p=new m),p}_load(){return Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(53842),i.e(34465),i.e(69121),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(30006),i.e(25190),i.e(13423),i.e(36747),i.e(58056),i.e(67080),i.e(98149),i.e(15518),i.e(36752),i.e(35542),i.e(96962),i.e(51494),i.e(34781),i.e(34386),i.e(29030),i.e(50690),i.e(30979),i.e(29594),i.e(57413),i.e(58510),i.e(22189),i.e(42767),i.e(21396),i.e(34862)]).then(i.bind(i,272935)).then((e=>{var t,i;return null===(t=this._dialog)||void 0===t||t.hide(),null===(i=this._dialog)||void 0===i||i.visible().unsubscribe(this._subscribe),this._dialog=new e.ObjectTreeDialogRenderer,this._dialog.visible().subscribe(this._subscribe),this._dialog}))}}var g=i(941285),S=i(389137),v=i(66732),f=i(553582),b=i(466743);var y=i(373571),C=i(526075),w=i(819021),P=i(854798),T=i(516684),M=i(691639);const x=(0,a.getLogger)("Chart.Studies.StudyMetaInfoRepository",{color:"#606"});class I{constructor(e){this._nextRequestNumber=1,this._rawStudiesMetaInfo=[],this._isReady=!1,this._metaInfoQueryQueue=[],this._javaMetaInfoQueryQueue=[],this._javaStudiesMetaInfo=[],this._pineMetaInfoCache=[],this._studiesMigrations=[],this._gateway=e}requestMetaInfo(){this._requestStarted();const e=this._makeNextRequestId();return x.logNormal(`Requesting metainfo #${e}`),new Promise((t=>{x.logNormal(`Requesting studies metadata #${e}`),this._gateway.requestMetadata(e,(i=>{x.logNormal(`Requesting studies metadata #${e} finished`);const s=i.params[1].metainfo.slice();{const e=i.params[1].migrations.slice();this._processSiteMetaInfo(s,e)}this._requestFinished(),t()}))}))}findById(e){if(!this._isReady)return this._enqueueMetaInfoQuery(e);const t=this._findStudyMetaInfo(e);return null!==t?Promise.resolve(t):"pine"===e.type?this._compilePine(e):Promise.reject(`unexpected study id=${e.studyId} with type=${e.type}`)}findByIdSync(e){return this._findStudyMetaInfo(e)}isReady(){return this._isReady}findAllJavaStudies(){return this._isReady?Promise.resolve(this._javaStudiesMetaInfo):this._enqueueJavaMetaInfoQuery()}getInternalMetaInfoArray(){return this._javaStudiesMetaInfo}getMigrations(){
return this._studiesMigrations}addPineMetaInfo(e){return k(this._pineMetaInfoCache,e)}async getLatestMetaInfoForPineStudy(e,t){const i=await(0,T.requestUserScripts)();let s;if(i){const r=i.find((t=>t.scriptIdPart===e));if(r){const e=P.Version.parse(t),i=P.Version.parse(r.version);e.isLess(i)&&(s=r.version)}}if(void 0!==s){const t={type:"pine",pineId:e,pineVersion:s};return this.findById(t)}return null}_processMigrations(e){this._studiesMigrations=[];for(let t=0;e&&t<e.length;t++)this._studiesMigrations.push(e[t])}_processSiteMetaInfo(e,t){for(const t of e)M.StudyVersioning._verifyInputsMaxValue(t),L(t);this._rawStudiesMetaInfo=e,this._processMigrations(t);for(const e of this._rawStudiesMetaInfo)k(this._javaStudiesMetaInfo,e);C.StudyMetaInfo.overrideDefaults(this._javaStudiesMetaInfo)}_processLibraryMetaInfo(e){}_requestStarted(){this._isReady=!1,this._javaStudiesMetaInfo=[],this._pineMetaInfoCache=[],this._studiesMigrations=[],this._rawStudiesMetaInfo=[]}_requestFinished(){this._isReady=!0,this._processPendingMetaInfoQueries(),this._processPendingFullMetaInfoQueries()}_enqueueMetaInfoQuery(e){return new Promise((t=>{this._metaInfoQueryQueue.push({studyDescriptor:e,resolver:t})}))}_enqueueJavaMetaInfoQuery(){return new Promise((e=>{this._javaMetaInfoQueryQueue.push({resolver:e})}))}_processPendingMetaInfoQueries(){for(;this._metaInfoQueryQueue.length;){const e=this._metaInfoQueryQueue.shift();this.findById(e.studyDescriptor).then(e.resolver)}}_processPendingFullMetaInfoQueries(){for(;this._javaMetaInfoQueryQueue.length;){this._javaMetaInfoQueryQueue.shift().resolver(this._javaStudiesMetaInfo)}}_findStudyMetaInfo(e){return"java"===e.type?this._javaStudiesMetaInfo.find((t=>t.id===e.studyId))||null:this._pineMetaInfoCache.find((t=>t.scriptIdPart===e.pineId&&(void 0===e.pineVersion||(0,r.ensureDefined)(t.pine).version===e.pineVersion)))||null}_makeNextRequestId(){return"metadata_"+this._nextRequestNumber++}_compilePine(e){x.logNormal(`Compiling ${e.pineId} script`);const t=Promise.resolve((0,T.translateScriptAsync2)(e.pineId,e.pineVersion||"last")).then((t=>(x.logNormal(`Compiling ${e.pineId} is successful`),this.addPineMetaInfo((0,r.ensureDefined)(t)))));return t.catch((()=>{x.logNormal(`Compiling ${e.pineId} is failed`)})),t}}function L(e){e.description_localized=n.t(e.description,{context:"study"},i(168716))}function k(e,t){const i=new C.StudyMetaInfo(t);(0,w.migrateMetaInfoAndPropState)(i);let s=!0;const r=e.findIndex((e=>e.id===i.id));if(-1===r)e.push(i);else{const t=e[r],o=void 0!==t.pine?P.Version.parse(t.pine.version):null,n=void 0!==i.pine?P.Version.parse(i.pine.version):null;null===n||null===o||n.isGreaterOrEqual(o)?(t.removeDefaults(),e[r]=i):s=!1}return s&&i.createDefaults(),i}var A=i(713473),E=i(616117),D=i(161488),B=i(853965),R=i(877009),N=i(316230),V=i(410864),O=i(86441),F=i(987088),W=i(951713),z=i(809796),H=i(86121),U=i(329806),G=i(315801),q=i(507795),j=i(950740),Y=i(913984),K=i(885482),X=i(345297),$=i(431912),Z=i(199471),Q=i(787123),J=i(511131),ee=i(429874),te=i(507983),ie=i(949668),se=i(422333)
;const re=parseInt(ie.labelheight),oe=parseInt(ie.bottommargin);function ne(e){return e/11}class ae{constructor(){this._wrapper=document.createElement("div"),this._element=document.createElement("div"),this._labelElement=document.createElement("div"),this._gearElement=document.createElement("div"),this._currentScale=1,this._info=null,this._mode="auto",this._wrapper.appendChild(this._element),this._wrapper.classList.add(ie.wrapper),this._element.classList.add(ie.label),this._labelElement.className=ie.symbol,this._element.appendChild(this._labelElement),this._gearElement.className=ie.gear,this._gearElement.innerHTML=te,this._element.appendChild(this._gearElement)}getElement(){return this._wrapper}setMode(e){this._mode!==e&&(this._mode=e)}align(e,t){const i=ne(t);Math.abs(i-this._currentScale)>.1&&(this._currentScale=i,Math.abs(this._currentScale-1)>.1?this._element.style.transform=`scale(${this._currentScale})`:(this._currentScale=1,this._element.style.transform=""))}drawLabelForScreenshot(e,t){if(null===this._info||"gear"===this._mode)return;const i=(0,J.makeFont)(t.fontSize,se.CHART_FONT_FAMILY);e.fillStyle=ee.themes[t.theme].getThemedColor("color-price-axis-label-back"),e.globalAlpha=.5,e.beginPath();const s=ne(t.fontSize)*re/2,r=(0,O.point)(t.offset+t.width/2,t.height/2);e.arc(r.x,r.y,s,0,2*Math.PI,!0),e.fill(),e.globalAlpha=1,e.fillStyle=ee.themes[t.theme].getThemedColor("color-price-axis-label-text"),e.textAlign="center",e.font=i,e.textBaseline="middle",e.fillText(this._info.label,r.x,r.y)}setAxisNameInfo(e){this._info=e,null!==e&&(this._labelElement.textContent=e.label)}static height(e){return(re+oe)*e}}var le=i(707957),ce=i(783375),he=i(499994);const de={enableTooltip:!0,showLabels:!0,enableMenu:!0,enableHighlight:!0};class ue{constructor(e,t,i,r,o,n=null){this._invalidated=!0,this._size=(0,s.size)({width:0,height:0}),this._offset=0,this._axisInfo=null,this._onLabelHovered=new le.Delegate,this._highlighted=!1,this._labelMode="auto",this._fixedLabelMode=null,this._canvasConfiguredHandler=()=>this.update(),this._timeAxisWidget=n,this._isLeft="left"===e,this._rendererOptionsProvider=r.rendererOptionsProvider,this._sourcesTitlesProvider=r.sourcesTitlesProvider,this._contextMenuItemsProvider=r.contextMenuItemsProvider,this._backgroundBasedTheme=r.backgroundBasedTheme,this._getBackgroundTopColor=r.getBackgroundTopColor,this._getBackgroundBottomColor=r.getBackgroundBottomColor,this._showHorizontalBorder=Boolean(r.showHorizontalBorder),this._properties=t,this._axisInfo=i,this._labelOptions={...de,...o},this._properties.lineColor.subscribe(this,this._onPropertyChanged),this._cell=document.createElement("div"),this._cell.classList.add(ie["price-axis-stub"]),this._labelOptions.enableTooltip&&this._cell.classList.add("apply-common-tooltip"),this._cell.style.width="25px",this._cell.style.height="100%",this._cell.style.position="absolute",this._cell.style.left="0",this._cell.style.overflow="hidden",this._labelOptions.showLabels?(this._label=new ae,this._label.setAxisNameInfo(this._axisInfo),
this._cell.appendChild(this._label.getElement()),this._labelOptions.enableTooltip&&(0,he.setTooltipData)(this._cell,"text",(e=>this._tooltipContent()))):this._label=null,this._mouseEventHandler=new $.MouseEventHandler(this._cell,this,{treatHorzTouchDragAsPageScroll:!0,treatVertTouchDragAsPageScroll:!0}),this._canvasBinding=(0,Z.createBoundCanvas)(this._cell,(0,s.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const a=this._canvasBinding.canvasElement;a.style.position="absolute",a.style.left="0",a.style.top="0"}destroy(){this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._properties.lineColor.unsubscribe(this,this._onPropertyChanged),this._mouseEventHandler.destroy()}mouseEnterEvent(e){this._mouseOrTouchEnterEvent(e)}touchStartEvent(e){this._mouseOrTouchEnterEvent(e)}mouseLeaveEvent(e){this._mouseOrTouchLeaveEvent(e)}touchEndEvent(e){this._mouseOrTouchLeaveEvent(e)}mouseClickEvent(e){this._mouseClickOrTapEvent(e)}tapEvent(e){this._mouseClickOrTapEvent(e)}update(){}getElement(){return this._cell}onLabelHovered(){return this._onLabelHovered}setSizeAndOffset(e,t){(0,s.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._cell.style.width=`${e.width}px`,this._cell.style.minWidth=`${e.width}px`,this._cell.style.height=`${e.height}px`,this._invalidated=!0),this._offset!==t&&(this._offset=t,this._cell.style.left=`${t}px`)}paint(e){if(e<R.InvalidationLevel.Light&&!this._invalidated)return;if(0===this._size.width||0===this._size.height)return;this._invalidated=!1,(0,Z.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding);const t=(0,Z.getBindingPixelRatio)(this._canvasBinding),i=(0,Z.getContext2D)(this._canvasBinding.canvasElement);this._drawBackground(i,t),this._drawVerticalBorder(i,t),this._showHorizontalBorder&&this._drawHorizontalBorder(i,t)}getWidth(){return this._size.width}getImage(){const e=(0,Z.createDisconnectedCanvas)(document,this._size),t=(0,Z.getPrescaledContext2D)(e),i=this._getBackgroundTopColor(),s=this._getBackgroundBottomColor();return i===s?(0,Z.clearRect)(t,0,0,this._size.width,this._size.height,i):(0,Q.clearRectWithGradient)(t,0,0,this._size.width,this._size.height,i,s),t.drawImage(this._canvasBinding.canvasElement,0,0,this._size.width,this._size.height),null!==this._label&&this._label.drawLabelForScreenshot(t,{offset:0,width:this._size.width,height:this._size.height,fontSize:this._properties.fontSize.value(),theme:this._backgroundBasedTheme.value()}),e}setLabelMode(e){e!==this._labelMode&&(this._labelMode=e,null!==this._label&&this._label.setMode(e),this._cell.classList.toggle(ie["fixed-gear"],"gear"===e),this._cell.classList.toggle(ie["fixed-symbol"],"symbol"===e),this._cell.classList.toggle("apply-common-tooltip","symbol"!==e&&this._labelOptions.enableTooltip))}_setHighlighted(e){this._labelOptions.enableHighlight&&(this._onLabelHovered.fire("stubButton",e),this._highlighted!==e&&(this._highlighted=e,this._invalidated=!0))}
_onPropertyChanged(){this._invalidated=!0}_drawVerticalBorder(e,t){const i=this._size.width;e.save(),e.fillStyle=this._properties.lineColor.value();const s=Math.max(1,Math.floor(this._rendererOptionsProvider.options().borderSize*t)),r=this._isLeft?Math.floor(i*t)-s:0,o=Math.ceil(this._size.height*t);e.fillRect(r,0,s,o+1),e.restore()}_drawHorizontalBorder(e,t){var i,s;e.save(),e.fillStyle=null!==(s=null===(i=this._timeAxisWidget)||void 0===i?void 0:i.lineColor())&&void 0!==s?s:this._properties.lineColor.value();const r=Math.max(1,Math.floor(this._rendererOptionsProvider.options().borderSize*t)),o=Math.ceil(this._size.width*t),n=this._isLeft?0:r;e.fillRect(n,0,o-r,r),e.restore()}_drawBackground(e,t){const i=Math.ceil(t*this._size.width),s=Math.ceil(t*this._size.height),r=this._getBackgroundTopColor(),o=this._getBackgroundBottomColor();if(r===o?(0,Z.clearRect)(e,0,0,i+1,s+1,r):(0,Q.clearRectWithGradient)(e,0,0,i+1,s+1,r,o),this._highlighted){const t=ee.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight");(0,Z.fillRect)(e,0,0,i+1,s+1,t),e.globalAlpha=1}}_tooltipContent(){return this._sourcesTitlesProvider().join("\n")}_mouseOrTouchEnterEvent(e){null!==this._label&&"symbol"!==this._labelMode&&this._labelOptions.enableHighlight&&this._setHighlighted(!0)}_mouseOrTouchLeaveEvent(e){"symbol"!==this._labelMode&&this._setHighlighted(!1)}_mouseClickOrTapEvent(e){if(e.preventDefault(),null!==this._fixedLabelMode||"symbol"===this._labelMode||!this._labelOptions.enableMenu||!this._labelOptions.showLabels)return void ce.ContextMenuManager.hideAll();this._fixedLabelMode=this._labelMode,this.setLabelMode("gear");const t=this._cell.getBoundingClientRect();ce.ContextMenuManager.showMenu(this._contextMenuItemsProvider(),{clientX:this._isLeft?t.left:t.right,clientY:t.top,attachToXBy:this._isLeft?"left":"right",attachToYBy:"bottom"},{statName:"PriceScaleLabelContextMenu",doNotCloseOn:this.getElement()},{menuName:"PriceScaleLabelContextMenu"},(()=>{this.setLabelMode((0,r.ensureNotNull)(this._fixedLabelMode)),this._fixedLabelMode=null}))}}var _e=i(175070);class pe{constructor(e,t,i,r,o,n=null){this._axises=[],this._stubs=[],this._size=(0,s.size)({width:0,height:0}),this._onLabelHovered=new le.Delegate,this._scalesProperties=e,this._priceAxisWidgetFactory=i,this._timeAxisWidget=n,this._rendererOptionsProvider=r.rendererOptionsProvider,this._titlesProvider=r.titlesProvider,this._stubContextMenuProvider=r.stubContextMenuProvider,this._backgroundBasedTheme=r.backgroundBasedTheme,this._getBackgroundTopColor=r.getBackgroundTopColor,this._getBackgroundBottomColor=r.getBackgroundBottomColor,this._showHorisontalBorder=Boolean(r.showHorizontalBorder),this._labelsOptions={...de,...o};const a=this._scalesProperties.childs();this._stubProperties={lineColor:a.lineColor,fontSize:a.fontSize},this._side=t,this._cell=document.createElement("td"),this._cell.classList.add("chart-markup-table","price-axis-container"),this._cell.style.width="25px",this._cell.style.position="relative"}destroy(){this.setScales([],0,0,0)}
onLabelHovered(){return this._onLabelHovered}setScales(e,t,i,s){for(;e.length>this._axises.length&&this._axises.length<t;){const e=(0,_e.getPriceAxisNameInfo)(this._side,this._axises.length),t=this._priceAxisWidgetFactory(this._side,this._rendererOptionsProvider,this._scalesProperties,e,this._backgroundBasedTheme);this._axises.push(t),this._cell.appendChild(t.getElement())}for(;e.length<this._axises.length;){const e=(0,r.ensureDefined)(this._axises.pop());this._cell.removeChild(e.getElement()),e.destroy()}for(let t=0;t<this._axises.length;++t)this._axises[t].setPriceScale(e[t]);const o=t-e.length,n=Math.max(0,o);for(;this._stubs.length>n;){const e=(0,r.ensureDefined)(this._stubs.pop());e.onLabelHovered().unsubscribeAll(this),this._cell.removeChild(e.getElement()),e.destroy()}for(;this._stubs.length<o;){const e=this._labelsOptions.showLabels?(0,_e.getPriceAxisNameInfo)(this._side,this._stubs.length):null,t=new ue(this._side,this._stubProperties,e,this._stubParams(this._stubs.length),this._labelsOptions,this._timeAxisWidget);t.onLabelHovered().subscribe(this,((t,i)=>{this._labelsOptions.showLabels&&this._labelsOptions.enableHighlight&&this._onLabelHovered.fire({owner:t,axis:(0,r.ensureNotNull)(e)},i)})),this._stubs.push(t),this._cell.appendChild(t.getElement())}const a=this._labelsOptions.enableMenu;1===s?this._stubs.forEach(((e,t)=>e.setLabelMode(a?"gear":"symbol"))):this._stubs.forEach(((e,t)=>e.setLabelMode(t<i&&a?"auto":"symbol")))}getElement(){return this._cell}updateCurrencyLabels(){return this._axises.forEach((e=>e.updateCurrencyLabel()))}optimalWidths(){return this._axises.map((e=>e.optimalWidth()))}setSizes(e,t){this._size=(0,s.size)({width:t.reduce(((e,t)=>e+t),0),height:e}),this._cell.style.width=this._size.width+"px",this._cell.style.minWidth=this._size.width+"px",this._cell.style.height=this._size.height+"px",t.length!==this._axises.length+this._stubs.length&&(0,r.assert)(t.length===this._axises.length+this._stubs.length,"Widgets count should be the same as widths one");let i=0;this._forEachWidgetFromLeft(((r,o)=>{const n=t[o];r.setSizeAndOffset((0,s.size)({width:n,height:e}),i),i+=n}))}update(){this._axises.forEach((e=>e.update())),this._stubs.forEach((e=>e.update()))}paint(e){this._axises.forEach(((t,i)=>t.paint(e(i)))),this._stubs.forEach(((t,i)=>t.paint(e(i))))}paintStubs(e){this._stubs.forEach((t=>t.paint(e)))}restoreDefaultCursor(){this._axises.forEach((e=>e.restoreDefaultCursor()))}getWidth(){return this._size.width}findAxisWidgetForScale(e){const t=this._axises.find((t=>t.priceScale()===e));return void 0===t?null:t}getScreenshotData(){const e=this._getImage();return{canvas:e,content:e.toDataURL(),contentHeight:this._size.height,contentWidth:this._size.width}}getImage(){return this._getImage()}slotsCount(){return this._axises.length+this._stubs.length}highlightPriceAxisByLabel(e){this._axises.forEach((t=>{const i=t.axisInfo();t.setHighlighted(null!==i&&i.equals(e))}))}axes(){return this._axises}_stubParams(e){return{rendererOptionsProvider:this._rendererOptionsProvider,
backgroundBasedTheme:this._backgroundBasedTheme,sourcesTitlesProvider:()=>this._titlesProvider(this._side,e),contextMenuItemsProvider:()=>this._stubContextMenuProvider(this._side,e),getBackgroundTopColor:this._getBackgroundTopColor,getBackgroundBottomColor:this._getBackgroundBottomColor,showHorizontalBorder:this._showHorisontalBorder}}_getImage(){const e=(0,Z.createDisconnectedCanvas)(document,this._size),t=(0,Z.getPrescaledContext2D)(e);let i=0;return this._forEachWidgetFromLeft(((e,s)=>{const r=e.getWidth();0!==r&&0!==this._size.height&&(t.drawImage(e.getImage(),i,0,r,this._size.height),i+=r)})),e}_forEachWidgetFromLeft(e){const t=[...this._axises,...this._stubs],i="left"===this._side,s=i?-1:t.length,r=i?-1:1;for(let o=i?t.length-1:0;o!==s;o+=r)e(t[o],o,t)}}var me=i(724377),ge=i(109154),Se=i(401580),ve=i(91849),fe=i(294162),be=i(246733),ye=i(345848),Ce=i(678515),we=i(855824),Pe=i(460682);class Te{constructor(){this._width=null,this._currencyInfo=null,this._unitInfo=null,this._measureUnitIdInfo=null,this._fontSize=0,this._currencyAndUnitLabelsWrapper=document.createElement("div"),this._currencyAndUnitLabelsWrapper.className=Pe["price-axis-currency-label-wrapper"],this._currencyAndUnitLabelsWrapper.setAttribute("data-name","currency-unit-label-wrapper"),this._controlsContainer=document.createElement("div"),this._controlsContainer.className=Pe["price-axis-currency-label"],this._currencyAndUnitLabelsWrapper.appendChild(this._controlsContainer),this._currencyLabelDiv=document.createElement("div"),this._currencyLabelDiv.className=Pe.row,this._currencyLabelDiv.classList.add("apply-common-tooltip"),(0,he.setTooltipData)(this._currencyLabelDiv,"text",(e=>this._currencyTooltipContent())),this._currencyText=document.createElement("div"),this._currencyText.className=Pe["price-axis-currency-label-text"],this._currencyLabelDiv.appendChild(this._currencyText),this._currencyArrowDown=document.createElement("div"),this._currencyArrowDown.className=Pe["price-axis-currency-label-arrow-down"],this._currencyArrowDown.innerHTML=we,this._currencyLabelDiv.appendChild(this._currencyArrowDown),this._measureUnitIdLabelDiv=document.createElement("div"),this._measureUnitIdLabelDiv.className=Pe.row,this._measureUnitIdLabelDiv.classList.add("apply-common-tooltip"),this._measureUnitIdLabelDiv.classList.add("readonly"),(0,he.setTooltipData)(this._measureUnitIdLabelDiv,"text",(e=>this._measureUnitIdTooltipContent())),this._measureUnitIdText=document.createElement("div"),this._measureUnitIdText.className=Pe["price-axis-currency-label-text"],this._measureUnitIdLabelDiv.appendChild(this._measureUnitIdText),this._unitLabelDiv=document.createElement("div"),this._unitLabelDiv.className=Pe.row,this._unitLabelDiv.classList.add("apply-common-tooltip"),(0,he.setTooltipData)(this._unitLabelDiv,"text",(e=>this._unitTooltipContent())),this._unitText=document.createElement("div"),this._unitText.className=Pe["price-axis-currency-label-text"],this._unitLabelDiv.appendChild(this._unitText),this._unitArrowDown=document.createElement("div"),
this._unitArrowDown.className=Pe["price-axis-currency-label-arrow-down"],this._unitArrowDown.innerHTML=we,this._unitLabelDiv.appendChild(this._unitArrowDown),this._controlsContainer.appendChild(this._currencyLabelDiv),this._controlsContainer.appendChild(this._measureUnitIdLabelDiv),this._controlsContainer.appendChild(this._unitLabelDiv),this.disableCurrency(),this.disableUnit()}element(){return this._currencyAndUnitLabelsWrapper}currencyLabelElement(){return this._currencyLabelDiv}unitLabelElement(){return this._unitLabelDiv}isEnabled(){return this.currencyLabelEnabled()||this.unitLabelEnabled()||this.measureUnitIdLableEnabled()}setCurrencyExpanded(e){this._currencyLabelDiv.classList.toggle(Pe.expanded,e)}setUnitExpanded(e){this._unitLabelDiv.classList.toggle(Pe.expanded,e)}width(){if(null!==this._width)return this._width;let e=0;if(this.currencyLabelEnabled()){const t=this._currencyText.getBoundingClientRect(),i=this._currencyArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}if(this.measureUnitIdLableEnabled()){const t=this._measureUnitIdText.getBoundingClientRect();e=Math.max(e,t.width+2*this._textMarginAndPadding())}if(this.unitLabelEnabled()){const t=this._unitText.getBoundingClientRect(),i=this._unitArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}return this._width=e}drawLabel(e,t,i){var s,r,o;if(!this.isEnabled())return;const n=Math.round(Number(Pe.css_wrapper_margin)*i),a=(0,Ce.ceiledEven)(t*i)-2*n,l=Math.round(this.labelBottom()*i),c=Math.round(Number(Pe.css_value_currency_label_radius)*i);e.fillStyle=getComputedStyle(this._currencyAndUnitLabelsWrapper).backgroundColor,e.fillRect(0,0,Math.ceil(t*i),l+Math.round(2*Number(Pe.css_wrapper_margin)*i));const h=[];h.push(this.currencyLabelEnabled()&&null!==(s=this._currencyText.textContent)&&void 0!==s?s:""),h.push(this.measureUnitIdLableEnabled()&&null!==(r=this._measureUnitIdText.textContent)&&void 0!==r?r:""),h.push(this.unitLabelEnabled()&&null!==(o=this._unitText.textContent)&&void 0!==o?o:""),e.font=(0,J.makeFont)(this._fontSize,se.CHART_FONT_FAMILY);const d=new fe.TextWidthCache,u=h.map((t=>""===t?0:d.yMidCorrection(e,t)));e.beginPath();const _=getComputedStyle(this._controlsContainer);e.fillStyle=_.backgroundColor,e.strokeStyle=_.borderColor,(0,Q.drawRoundRect)(e,n,n,a,l,c),e.fill(),e.stroke(),e.fillStyle=getComputedStyle(this._currencyLabelDiv).color,e.textBaseline="middle",e.textAlign="left";const p=Math.round(Number(Pe.css_first_row_top_padding)*i),m=Math.round(this._textMarginAndPadding()*i)+n,g=this._oneLineHeight()/2*i;let S=p+g;h.forEach(((t,s)=>{""!==t&&((0,Z.drawScaled)(e,i,i,(()=>{e.fillText(t,m/i,(S+u[s])/i)})),S=Math.ceil(S+2*g))}))}setHidden(e){this._currencyAndUnitLabelsWrapper.classList.toggle(Pe.hidden,e)}enableCurrency(){this._currencyLabelDiv.classList.remove("js-hidden"),this._width=null,this._updateVisibility()}disableCurrency(){this._currencyLabelDiv.classList.add("js-hidden"),this._width=null,this._updateVisibility()}enableUnit(){
this._unitLabelDiv.classList.remove("js-hidden"),this._width=null,this._updateVisibility()}disableUnit(){this._unitLabelDiv.classList.add("js-hidden"),this._width=null,this._updateVisibility()}enableMeasureUnitId(){this._measureUnitIdLabelDiv.classList.remove("js-hidden"),this._width=null,this._updateVisibility()}disableMeasureUnitId(){this._measureUnitIdLabelDiv.classList.add("js-hidden"),this._width=null,this._updateVisibility()}currencyLabelEnabled(){return!this._currencyLabelDiv.classList.contains("js-hidden")}unitLabelEnabled(){return!this._unitLabelDiv.classList.contains("js-hidden")}measureUnitIdLableEnabled(){return!this._measureUnitIdLabelDiv.classList.contains("js-hidden")}currencyConversionAvailable(){return!this._currencyLabelDiv.classList.contains("readonly")}unitConversionAvailable(){return!this._unitLabelDiv.classList.contains("readonly")}setCurrencyInfo(e){if(this._currencyInfo===e)return!1;this._currencyInfo=e;const t=null===e.selectedCurrency?n.t(null,void 0,i(795093)):(0,r.ensureDefined)(e.displayedValues.get(e.selectedCurrency));return this._currencyText.textContent!==t&&(this._currencyText.textContent=t,this._width=null),this._currencyArrowDown.classList.contains("js-hidden")!==e.readOnly&&(this._currencyArrowDown.classList.toggle("js-hidden",e.readOnly),this._currencyLabelDiv.classList.toggle("readonly",e.readOnly),this._width=null),!0}setUnitInfo(e){if(null!==this._unitInfo&&this._unitInfo.selectedUnit===e.selectedUnit&&0===this._unitInfo.availableGroups.size==(0===e.availableGroups.size)&&this._unitInfo.originalUnits.size===e.originalUnits.size)return this._unitInfo=e,!1;this._unitInfo=e;const t=null===e.selectedUnit?n.t(null,void 0,i(795093)):(0,r.ensureDefined)(e.names.get(e.selectedUnit));return this._unitText.textContent!==t&&(this._unitText.textContent=t,this._width=null),this._unitArrowDown.classList.contains("js-hidden")!==(0===e.availableGroups.size)&&(this._unitArrowDown.classList.toggle("js-hidden",0===e.availableGroups.size),this._unitLabelDiv.classList.toggle("readonly",0===e.availableGroups.size),this._width=null),!0}setMeasureUnitIdInfo(e){if(this._measureUnitIdInfo===e)return!1;this._measureUnitIdInfo=e;const t=null===e.selectedMeasureUnitId?n.t(null,void 0,i(795093)):(0,r.ensureDefined)(e.names.get(e.selectedMeasureUnitId));return this._measureUnitIdText.textContent!==t&&(this._measureUnitIdText.textContent=t,this._width=null),this._measureUnitIdLabelDiv.classList.contains("js-hidden")!==(0===e.names.size)&&(this._measureUnitIdLabelDiv.classList.toggle("js-hidden",0===e.names.size),this._width=null),!0}updateColors(e,t){this._currencyAndUnitLabelsWrapper.style.backgroundColor=e}currencyInfo(){return this._currencyInfo}unitInfo(){return this._unitInfo}measureUnitIdInfo(){return this._measureUnitIdInfo}setFontSize(e){this._fontSize!==e&&(this._fontSize=e,this._currencyLabelDiv.style.fontSize=e+"px",this._measureUnitIdLabelDiv.style.fontSize=e+"px",this._unitLabelDiv.style.fontSize=e+"px",this._width=null)}labelBottom(){const e=this._oneLineHeight()
;let t=(this.currencyLabelEnabled()?e:0)+(this.measureUnitIdLableEnabled()?e:0)+(this.unitLabelEnabled()?e:0);return t>0&&(t+=Number(Pe.css_first_row_top_padding)),t}_textMarginAndPadding(){return Number(Pe.css_wrapper_margin)+Number(Pe.css_row_left_right_padding)+2}_currencyTooltipContent(){const e=this._currencyInfo;return null===e?"":null===e.selectedCurrency?Array.from(e.currencies).map((t=>(0,r.ensureDefined)(e.displayedValues.get(t)))).join(", "):e.displayedValues.get(e.selectedCurrency)||""}_unitTooltipContent(){const e=this._unitInfo;return null===e?"":null===e.selectedUnit?Array.from(e.units).map((t=>(0,r.ensureDefined)(e.names.get(t)))).join(", "):e.descriptions.get(e.selectedUnit)||""}_measureUnitIdTooltipContent(){const e=this._measureUnitIdInfo;return null===e?"":null===e.selectedMeasureUnitId?Array.from(e.measureUnitIds).map((t=>(0,r.ensureDefined)(e.names.get(t)))).join(", "):e.descriptions.get(e.selectedMeasureUnitId)||""}_updateVisibility(){const e=this.isEnabled();this._currencyAndUnitLabelsWrapper.classList.toggle("js-hidden",!e)}_oneLineHeight(){return 3+this._fontSize}}async function Me(e,t,s,r){const{UnitConversionRenderer:o}=await Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(4015),i.e(53842),i.e(38669),i.e(5145),i.e(30006),i.e(25190),i.e(46036),i.e(90684),i.e(40866),i.e(36752),i.e(96025),i.e(17111),i.e(50690),i.e(745),i.e(32704)]).then(i.bind(i,300203));return new o(e,s,t,r)}function xe(e,t){let{deltaX:i,deltaY:s}=e;switch(i/=100,s/=100,t.deltaMode){case t.DOM_DELTA_PAGE:i*=120,s*=120;break;case t.DOM_DELTA_LINE:i*=32,s*=32}return{deltaX:i,deltaY:s}}class Ie{constructor(){this._totalDeltaX=0,this._totalDeltaY=0,this._prevWheelTime=0}processWheel(e){e.timeStamp-this._prevWheelTime>100&&this._reset(),this._totalDeltaX+=e.deltaX,this._totalDeltaY+=e.deltaY,this._prevWheelTime=e.timeStamp;const t={deltaX:e.deltaX,deltaY:e.deltaY};return 0===this._totalDeltaX||0===this._totalDeltaY||(Math.abs(this._totalDeltaX)>=Math.abs(3*this._totalDeltaY)&&(t.deltaY=0),Math.abs(this._totalDeltaY)>=Math.abs(3*this._totalDeltaX)&&(t.deltaX=0)),xe(t,e)}_reset(){this._totalDeltaX=0,this._totalDeltaY=0}}var Le=i(470316),ke=i(608415),Ae=i(327453),Ee=i(244842),De=i(621618),Be=i(261066),Re=i(480059),Ne=i(497754),Ve=i.n(Ne),Oe=i(758035);class Fe{constructor({setMode:e,className:t=""}){const s=this._wrapper=document.createElement("div");s.classList.add(t),s.addEventListener("dblclick",this._stopPropagation,{capture:!0}),s.addEventListener("touchstart",this._stopPropagation,{capture:!0});const r=s.appendChild(document.createElement("div"));r.className=Oe.priceScaleModeButtons,this._autoScaleButton=r.appendChild(this._createButton({title:n.t(null,{context:'The first letter of the "auto" word'},i(9846)),tooltip:n.t(null,void 0,i(550834)),onClick:()=>e("auto")})),this._logarithmButton=r.appendChild(this._createButton({title:n.t(null,{context:'The first letter of the "logarithmic" word'},i(655765)),tooltip:n.t(null,void 0,i(512285)),onClick:()=>e("log")}))}destroy(){
this._wrapper.removeEventListener("dblclick",this._stopPropagation),this._wrapper.removeEventListener("touchstart",this._stopPropagation),this._autoScaleButton.remove(),this._logarithmButton.remove(),this._wrapper.remove()}element(){return this._wrapper}width(){return 52}updateMode(e){const{log:t,autoScale:i}=e;this._logarithmButton.classList.toggle(Oe.priceScaleModeButtons__button_activated,!!t),this._autoScaleButton.classList.toggle(Oe.priceScaleModeButtons__button_activated,!!i)}_createButton(e){const{title:t,tooltip:i,onClick:s}=e,r=document.createElement("button");return r.className=Ve()(Oe.priceScaleModeButtons__button,"apply-common-tooltip"),r.textContent=t,r.dataset.tooltip=i,r.addEventListener("click",s),r}_stopPropagation(e){e.stopPropagation()}}var We=i(139267);i(647184);const ze=new z.TranslatedString("change no overlapping labels",n.t(null,void 0,i(783935))),He=new z.TranslatedString("toggle auto scale",n.t(null,void 0,i(863060))),Ue=new z.TranslatedString("toggle log scale",n.t(null,void 0,i(160166))),Ge=n.t(null,void 0,i(375633)),qe=n.t(null,void 0,i(194420)),je=n.t(null,void 0,i(881520)),Ye=n.t(null,void 0,i(125933)),Ke=n.t(null,void 0,i(417258)),Xe=n.t(null,void 0,i(550834)),$e=n.t(null,{context:"scale_menu"},i(670361)),Ze=n.t(null,{context:"scale_menu"},i(547807)),Qe=n.t(null,{context:"scale_menu"},i(934727)),Je=n.t(null,{context:"scale_menu"},i(172116)),et=n.t(null,{context:"scale_menu"},i(19238)),tt=n.t(null,{context:"scale_menu"},i(454138));const it=function(e){const t=new Ae.LimitedPrecisionNumericFormatter(e);return(e,i)=>(0,S.isNumber)(i)&&!e.isLog()?t.format(i):""}(4),st={contextMenuEnabled:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,countdownEnabled:!0,contextMenu:{general:!0,source:!0},pressedMouseMoveScale:!0,mouseWheelScale:!0,pinchScale:!0,croppedTickMarks:!0};class rt{constructor(e,t,i,r,o,n,a,l,c){this._actions=null,this._priceScale=null,this._scaleModeButtons=null,this._widthCache=new fe.TextWidthCache(1e3),this._color=null,this._fontSize=null,this._currencyFontSize=0,this._currencyLabelWidth=null,this._isVisible=!0,this._currencyMenu=null,this._unitMenu=null,this._size=(0,s.size)({width:0,height:0}),this._currentCursorClassName="",this._destroyed=!1,this._highlighted=!1,this._highlightColorCache=null,this._mouseWheelHelper=null,this._dragScaleActive=!1,this._offset=NaN,this._pinching=!1,this._lastHittestResult=null,this._isHovered=new Se.WatchedValue(!1),this._recalcCurrencyAndUnitVisibility=()=>{if(null===this._currencyLabel)return;let e=!0;switch((0,Be.currencyUnitVisibilityProperty)().value()){case"alwaysOff":e=!1;break;case"visibleOnMouseOver":const t=this._chart.anyPriceAxisHovered().value(),i=null!==this._currencyMenu&&this._currencyMenu.isOpened(),s=null!==this._unitMenu&&this._unitMenu.isOpened();e=t||i||s}this._currencyLabel.setHidden(!e)},this._handleAutoLogButtonsVisibilityProperty=e=>{const t=e.value();"alwaysOff"===t?this._scaleModeButtons&&this._destroyScaleModeButtons():(this._scaleModeButtons||this._createScaleModeButtons(),
"alwaysOn"===t?(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._updatePriceScaleModeButtonsVisibility(!0)):this._isHovered.subscribe(this._updatePriceScaleModeButtonsVisibility,{callWithLast:!0}))},this._updatePriceScaleModeButtonsVisibility=e=>{var t;null===(t=this._scaleModeButtons)||void 0===t||t.element().classList.toggle("price-axis__modeButtons_hidden",!e)},this._updateScaleModeButtons=()=>{var e;this._priceScale&&(null===(e=this._scaleModeButtons)||void 0===e||e.updateMode(this._priceScale.mode()))},this._chart=e,this._pane=t,this._undoModel=i,this._properties=r,this._isLeft="left"===n,this._options=(0,S.merge)((0,S.clone)(st),a),this._rendererOptionsProvider=o,this._backgroundBasedTheme=c,this._cell=document.createElement("div"),this._cell.className="price-axis",this._cell.style.width="25px",this._cell.style.left="0",this._canvasConfiguredHandler=()=>{this._undoModel.model().lightUpdate()},this._canvasBinding=(0,Z.createBoundCanvas)(this._cell,(0,s.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const h=this._canvasBinding.canvasElement;h.style.position="absolute",h.style.zIndex="1",h.style.left="0",h.style.top="0",this._topCanvasBinding=(0,Z.createBoundCanvas)(this._cell,(0,s.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const d=this._topCanvasBinding.canvasElement;d.style.position="absolute",d.style.zIndex="2",d.style.left="0",d.style.top="0",this._mouseEventHandler=new $.MouseEventHandler(this._cell,this,{treatVertTouchDragAsPageScroll:!1,treatHorzTouchDragAsPageScroll:!0}),this._options.currencyConversionEnabled||this._options.unitConversionEnabled?(this._currencyLabel=new Te,this._cell.appendChild(this._currencyLabel.element())):this._currencyLabel=null,this._properties.childs().fontSize.subscribe(this,this._onFontSizeChanged),this._options.mouseWheelScale&&(this._mouseWheelHelper=new Ie,this._cell.addEventListener("wheel",this._onMousewheel.bind(this),{passive:!1})),this._axisInfo=l,this._offset=0,this.restoreDefaultCursor(),(0,Be.currencyUnitVisibilityProperty)().subscribe(this,this._recalcCurrencyAndUnitVisibility),(0,Re.autoLogButtonsVisibilityProperty)().subscribe(this,this._handleAutoLogButtonsVisibilityProperty),this._handleAutoLogButtonsVisibilityProperty((0,Re.autoLogButtonsVisibilityProperty)()),this._chart.anyPriceAxisHovered().subscribe(this._recalcCurrencyAndUnitVisibility,{callWithLast:!0}),this.update()}getContextMenuActions(){var e;this._initActions();const t=(0,r.ensureNotNull)(this._actions),i=this._chart.actions(),s=[];return(null===(e=this._priceScale)||void 0===e?void 0:e.resetScaleAvailable().value())&&s.push(t.reset,new y.Separator),s.push(this._autoScaleAction()),this._isMainSeriesAxis()&&s.push(this._lockScaleAction()),s.push(i.scaleSeriesOnly,this._invertAction(),new y.Separator,this._regularScaleAction(),this._percentageAction(),this._indexedTo100Action(),this._logAction(),new y.Separator),
h.CheckMobile.any()||(s.push(this._createMergeScalesAction()),s.push(new y.Separator)),Ee.enabled("fundamental_widget")||s.push(new y.Action({actionId:"Chart.PriceScale.Labels",label:qe,subItems:[i.showSymbolLabelsAction,i.showSeriesLastValue,i.showSeriesPrevCloseValue,i.showPrePostMarketPriceLabel,i.showHighLowPriceLabels,Ee.enabled("show_average_close_price_line_and_label")?i.showAverageClosePriceLabel:null,this._undoModel.model().hasCustomSource("bidask")&&i.showBidAskLabels,i.showStudyPlotNamesAction,i.showStudyLastValue,t.alignLabels].filter(Boolean)})),s.push((0,De.createLinesAction)(this._chart)),this._options.countdownEnabled&&s.push(i.showCountdown),this._undoModel.crossHairSource().isMenuEnabled()&&s.push(i.addPlusButton),!(0,h.onWidget)()&&Ee.enabled("show_chart_property_page")&&Ee.enabled("chart_property_page_scales")&&i.scalesProperties&&s.push(new y.Separator,i.scalesProperties),s}getElement(){return this._cell}onOptimalWidthNeedToBeRecalculated(e){(this._size.width<this.optimalWidth()||e)&&this._undoModel.model().fullUpdate()}optimalWidth(){var e,t,i;if(!this.isVisible())return 0;let s=0;const o=this.rendererOptions();if(this._pane.hasState()){const t=(0,Z.getContext2D)(this._canvasBinding.canvasElement);t.font=this.baseFont();const i=this.backLabels(!0);for(let e=i.length;e--;){if(!i[e].isAxisLabelVisible())continue;const r=this._widthCache.measureText(t,i[e].text());s=Math.max(s,r);const o=i[e].secondLineText();o&&(s=Math.max(s,this._widthCache.measureText(t,o)));const n=i[e].thirdLineText();n&&(s=Math.max(s,this._widthCache.measureText(t,n)))}const r=this.priceScale(),o=r.marks();o.length>0&&(s=Math.max(s,this._widthCache.measureText(t,o[0].label),this._widthCache.measureText(t,o[o.length-1].label)));const n=(null===(e=r.mainSource())||void 0===e?void 0:e.firstValue())||null;if(null!==n){const e=r.coordinateToPrice(1,n),i=r.coordinateToPrice(this._size.height-2,n);if(Math.abs(e-i)>1e-14){const o=r.formatPrice(Math.floor(Math.min(e,i))+.11111111111111,n),a=r.formatPrice(Math.ceil(Math.max(e,i))-.11111111111111,n);s=Math.max(s,this._widthCache.measureText(t,o),this._widthCache.measureText(t,a))}}}let n=0;this._isCurrencyLabelEnabled()&&(null===this._currencyLabelWidth&&(this._currencyLabelWidth=(0,r.ensureNotNull)(this._currencyLabel).width()),n=Math.round(this._currencyLabelWidth));const a=s||34;let l=Math.max(n,null!==(i=null===(t=this._scaleModeButtons)||void 0===t?void 0:t.width())&&void 0!==i?i:0,Math.ceil(o.borderSize+o.additionalPaddingInner+o.paddingInner+o.paddingOuter+a+4));return l+=l%2,l}backLabels(e){const t=[],i=this._grouppedSources(),s=s=>{for(const r of s){if(!e&&i.topLevelSources.has(r))continue;const s=r.priceAxisViews(this._pane.state(),this.priceScale());if(s)for(const e of s)t.push(e)}};return s(i.sources),s(this._pane.state().customSources()),t}setSizeAndOffset(e,t){(0,s.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._cell.style.width=e.width+"px",this._cell.style.height=e.height+"px",
this._cell.style.minWidth=e.width+"px"),this._offset!==t&&(this._offset=t,this._cell.style.left=t+"px")}getWidth(){return this._size.width}getImage(){const e=this._size,t=(0,Z.createDisconnectedCanvas)(document,e);return(0,Z.getPrescaledContext2D)(t).drawImage(this._canvasBinding.canvasElement,0,0,e.width,e.height),null!==this._currencyLabel&&this._currencyLabel.isEnabled()&&this._currencyLabel.drawLabel((0,Z.getContext2D)(t),e.width,(0,ge.getCanvasDevicePixelRatio)(t)),t}update(){null!==this._priceScale&&(this._priceScale.marks(),this._updateCurrencyLabelFont(),this.rendererOptions())}paint(e){if(!this._isVisible||0===this._size.width||0===this._size.height)return;if(e===R.InvalidationLevel.None)return;const t=this._pane.state(),i=!t.maximized().value()&&t.collapsed().value();if((0,Z.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,Z.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding),e>R.InvalidationLevel.Cursor){const e=(0,Z.getContext2D)(this._canvasBinding.canvasElement),t=(0,Z.getBindingPixelRatio)(this._canvasBinding);i||this._alignLabels(),this._drawBackground(e,t),this._drawBorder(e,t),this._pane.hasState()&&(this.updateCurrencyLabel(),this._scaleModeButtons&&(this._scaleModeButtons.element().style.background=this._highlighted?this._highlightColor():this.backgroundColor()),i||(this._drawTickMarks(e,t),this._drawBackLabels(e,t)))}if(this._pane.hasState()&&!i){const e=(0,Z.getContext2D)(this._topCanvasBinding.canvasElement),t=(0,Z.getBindingPixelRatio)(this._topCanvasBinding);e.clearRect(0,0,Math.ceil(this._size.width*t)+1,Math.ceil(this._size.height*t)+1),this._drawCrossHairLabel(e,t)}}restoreDefaultCursor(){this._setCursor("")}priceScale(){return(0,r.ensureNotNull)(this._priceScale)}setPriceScale(e){this._priceScale!==e&&(null!==this._priceScale&&(this._priceScale.onMarksChanged().unsubscribe(this,this.onOptimalWidthNeedToBeRecalculated),this._priceScale.modeChanged().unsubscribeAll(this)),this._priceScale=e,null!==e&&(e.onMarksChanged().subscribe(this,this.onOptimalWidthNeedToBeRecalculated),e.modeChanged().subscribe(this,(()=>this.onOptimalWidthNeedToBeRecalculated(!0))),this.onOptimalWidthNeedToBeRecalculated(),this._scaleModeButtons&&(e.modeChanged().subscribe(this,this._updateScaleModeButtons),this._updateScaleModeButtons())))}isVisible(){return this._isVisible}setVisible(e){(e=!!e)!==this._isVisible&&(this._cell.style.display=e?"table-cell":"none",this._isVisible=e)}destroy(){null!==this._currencyMenu&&(this._currencyMenu.close(),this._currencyMenu=null),null!==this._unitMenu&&(this._unitMenu.close(),this._unitMenu=null),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),null!==this._priceScale&&(this._priceScale.onMarksChanged().unsubscribe(this,this.onOptimalWidthNeedToBeRecalculated),this._priceScale.modeChanged().unsubscribeAll(this)),this._priceScale=null,this._mouseEventHandler.destroy(),
this._properties.childs().fontSize.unsubscribe(this,this._onFontSizeChanged),null!==this._actions&&this._actions.reset&&this._actions.reset.destroy(),(0,Be.currencyUnitVisibilityProperty)().unsubscribeAll(this),this._chart.anyPriceAxisHovered().unsubscribe(this._recalcCurrencyAndUnitVisibility),(0,Re.autoLogButtonsVisibilityProperty)().unsubscribeAll(this),this._chart.setPriceAxisHovered(this,!1),this._destroyScaleModeButtons(),this._destroyed=!0}axisInfo(){return this._axisInfo}setHighlighted(e){this._highlighted=e}backgroundColor(){return this._pane.state().model().backgroundColor().value()}backgroundTopColor(){return this._pane.state().model().backgroundTopColor().value()}lineColor(){return this._properties.childs().lineColor.value()}textColor(){return this._properties.childs().textColor.value()}fontSize(){return this._properties.childs().fontSize.value()}baseFont(){return(0,J.makeFont)(this.fontSize(),se.CHART_FONT_FAMILY,"")}rendererOptions(){let e=this._rendererOptionsProvider.options();return this._color===e.color&&this._fontSize===e.fontSize||(this._color=e.color),this._fontSize!==e.fontSize&&(this._widthCache.reset(),this._fontSize=e.fontSize,this._currencyLabelWidth=null,this._currencyFontSize=0,this._updateCurrencyLabelFont(),this.onOptimalWidthNeedToBeRecalculated()),this._hasAlertLabel()&&(e=Object.assign({},e,{paddingInner:Math.max(e.paddingInner,ve.ALERT_LABEL_WIDTH)})),e}mouseEnterEvent(e){this._chart.setPriceAxisHovered(this,!0),this._isHovered.setValue(!0),this._mouseEnterOrTouchStartEvent(e)}mouseMoveEvent(e){this._mouseOrTouchMoveEvent(e)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseOrTouchMoveEvent(e),this._mouseEnterOrTouchStartEvent(e),this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}pinchStartEvent(e,t,i,s){return s.bothPointsOnTargetElement}pinchEvent(e,t,i){if(this._zoomAvailable()&&this._options.pinchScale){if(this._dragScaleActive&&this._finishScale(),!this._pinching)return this._pinching=!0,void this._undoModel.startTwoPointsScalePrice(this._pane.state(),this.priceScale(),t.y,i.y);this._undoModel.twoPointsScalePriceTo(this._pane.state(),this.priceScale(),t.y,i.y)}}pinchEndEvent(){this._pinching=!1,this._undoModel.endTwoPointsScalePrice(this._pane.state(),this.priceScale())}mouseDownOutsideEvent(){this._finishScale()}touchStartOutsideEvent(){this._finishScale()}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseLeaveOrTouchEndEvent(e),this._mouseUpOrTouchEndEvent(e)}mouseClickEvent(e){this._mouseClickOrTapEvent(e)}tapEvent(e){this._mouseClickOrTapEvent(e)}mouseLeaveEvent(e){this._chart.setPriceAxisHovered(this,!1),this._isHovered.setValue(!1),this._mouseLeaveOrTouchEndEvent(e)}mouseDoubleClickEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}doubleTapEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}contextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}touchContextMenuEvent(e){
this._contextMenuOrTouchContextMenuEvent(e)}dataSourceAtPoint(e,t){const i=this._pane.state();if(!i.maximized().value()&&i.collapsed().value())return null;const s=this._grouppedSources(),r=[...s.sources,...s.topLevelSources,...i.customSources()];let o=null,n=null;if(!this._priceScale)return null;const a=(e,t)=>{var i;const s=null!==(i=null==n?void 0:n.target())&&void 0!==i?i:0;e.target()>s&&(n=e,o=t)},l=new O.Point(e,t);for(let e=r.length-1;e>=0;--e){const t=r[e],s=t.priceAxisViews(i,this._priceScale);if(s&&0!==s.length)for(let e=s.length-1;e>=0;--e){const i=s[e].renderer();if(void 0!==i.hitTest){const e=i.hitTest(l,this._size.width,this._isLeft?"left":"right");null!==e&&a(e,t)}}}return this._lastHittestResult=n,o}reset(){const e=this._pane.state(),t=this.priceScale();this._undoModel.resetPriceScale(e,t),this.onOptimalWidthNeedToBeRecalculated(!0)}updateCurrencyLabel(){if(null===this._currencyLabel)return;let e=!1;if(this._options.currencyConversionEnabled){const t=this.priceScale().currency(this._undoModel.model().availableCurrencies());null===t||"alwaysOff"===(0,Be.currencyUnitVisibilityProperty)().value()?(e=this._currencyLabel.currencyLabelEnabled(),this._currencyLabel.disableCurrency()):(e=!this._currencyLabel.currencyLabelEnabled(),this._currencyLabel.enableCurrency(),this._currencyLabel.updateColors(this.backgroundTopColor(),this.textColor()),e=this._currencyLabel.setCurrencyInfo(t)||e)}else this._currencyLabel.disableCurrency();if(this._options.unitConversionEnabled){const t="alwaysOff"===(0,Be.currencyUnitVisibilityProperty)().value(),i=this._undoModel.model().availableUnits(),s=this.priceScale().unit(i);null===s||t?(e=e||this._currencyLabel.unitLabelEnabled(),this._currencyLabel.disableUnit()):(e=e||!this._currencyLabel.unitLabelEnabled(),this._currencyLabel.enableUnit(),this._currencyLabel.updateColors(this.backgroundTopColor(),this.textColor()),e=this._currencyLabel.setUnitInfo(s)||e);const r=this.priceScale().measureUnitId(i);null===r||t?(e=e||this._currencyLabel.measureUnitIdLableEnabled(),this._currencyLabel.disableMeasureUnitId()):(e=e||!this._currencyLabel.measureUnitIdLableEnabled(),this._currencyLabel.enableMeasureUnitId(),this._currencyLabel.updateColors(this.backgroundTopColor(),this.textColor()),e=this._currencyLabel.setMeasureUnitIdInfo(r)||e)}else this._currencyLabel.disableUnit(),this._currencyLabel.disableMeasureUnitId();this._updateCurrencyLabelFont(),e&&(this._currencyLabelWidth=null)}_grouppedSources(){var e;const t=this._pane,i=t.state().model(),s=this._sameSideSources().slice(),r=t.state(),o=this.priceScale(),n=new Set,a=null!==(e=i.lineBeingEdited())&&void 0!==e?e:i.lineBeingCreated();a&&n.add(a);const l=i.customSourceBeingMoved();null!==l&&n.add(l),i.sourcesBeingMoved().forEach((e=>n.add(e))),i.selection().allSources().forEach((e=>n.add(e)));const c=i.hoveredSource();null!==c&&n.add(c);if(o===r.defaultPriceScale()){const e=this._pane.state().dataSources();for(const t of e)r.isOverlay(t)&&s.push(t)}return{sources:s,topLevelSources:n}}_isCurrencyLabelEnabled(){
return null!==this._currencyLabel&&this._currencyLabel.isEnabled()}_updateCurrencyLabelFont(){if(null===this._currencyLabel)return;const e=this.fontSize();e!==this._currencyFontSize&&(this._currencyLabel.setFontSize(e),this._currencyFontSize=e,this._currencyLabelWidth=null,this.onOptimalWidthNeedToBeRecalculated())}_alignLabels(){var e,t;const i=this._size.height;let s=i/2;const r=[],o=this.priceScale(),n=o.orderedSources().slice(),a=this._pane.state(),l=this.rendererOptions();if(o===a.defaultPriceScale()){const e=a.priceDataSources();for(let t=0;t<e.length;t++)a.isOverlay(e[t])&&n.push(e[t])}const c=o.mainSource();for(const e of[n,a.customSources()])for(let t=0;t<e.length;++t){const n=e[t],h=n.priceAxisViews(a,o);if(h){const e=h.filter((e=>{if(e.ignoreAlignment()||!e.isVisible())return!1;const{total:t}=e.topBottomTotalHeight(l),s=e.floatCoordinate();return s>-t&&s<i+t}));if(!e.length)continue;r.push(...e),c===n&&(s=e[0].floatCoordinate())}}const h=r.filter((e=>e.floatCoordinate()<=s)),d=r.filter((e=>e.floatCoordinate()>s));h.sort(((e,t)=>t.floatCoordinate()-e.floatCoordinate())),h.length>0&&d.length>0&&d.push(h[0]),d.sort(((e,t)=>e.floatCoordinate()-t.floatCoordinate()));for(const e of r)e.setFixedCoordinate(e.coordinate());if(o.properties().childs().alignLabels.value()){if(d.length>0||h.length>0){{const t=null!==(e=h[0])&&void 0!==e?e:d[0],s=t.getFixedCoordinate(),{top:r,bottom:o,total:n}=t.topBottomTotalHeight(l);n<i&&s-r<0&&s+o>0&&t.setFixedCoordinate(r)}{const e=null!==(t=d[0])&&void 0!==t?t:h[0],s=e.getFixedCoordinate(),{top:r,bottom:o,total:n}=e.topBottomTotalHeight(l);n<i&&s-r<i&&s+o>i&&e.setFixedCoordinate(i-o)}}for(let e=1;e<h.length;e++){const t=h[e],i=h[e-1],{top:s,bottom:r,total:o}=t.topBottomTotalHeight(l),n=t.getFixedCoordinate(),a=i.getFixedCoordinate();if(n>a-o)t.setFixedCoordinate(a-o);else if(a>0&&n-s<0&&n+r>0){const{top:e}=i.topBottomTotalHeight(l);t.setFixedCoordinate(Math.min(a-e-r,s))}}for(let e=1;e<d.length;e++){const t=d[e],s=d[e-1],{bottom:r,total:o}=s.topBottomTotalHeight(l),n=t.getFixedCoordinate(),a=s.getFixedCoordinate();if(n<a+o)t.setFixedCoordinate(a+o);else if(a<i){const{top:e,bottom:s}=t.topBottomTotalHeight(l);n-e<i&&n+s>i&&t.setFixedCoordinate(Math.max(a+r+e,i-s))}}}}_drawTickMarks(e,t){const i=this.priceScale().marks();e.save(),e.font=this.baseFont();const s=this.rendererOptions(),o=this._isLeft?Math.floor((this._size.width-s.additionalPaddingInner)*t):0,n=this._isLeft?Math.round(o-s.paddingInner*t):Math.round(o+(s.additionalPaddingInner+s.paddingInner)*t),a=this.fontSize(),l=this._isCurrencyLabelEnabled()?(0,r.ensureNotNull)(this._currencyLabel).labelBottom():0,c=i.map((t=>{if(this._options.croppedTickMarks)return{visible:!0,yCorrection:this._widthCache.yMidCorrection(e,t.label)};const i=t.coord-a/2,s=t.coord+a/2,r=!(s>this._size.height||i<l);return{visible:!(s>this._size.height||i<l),yCorrection:r?this._widthCache.yMidCorrection(e,t.label):0}}));e.fillStyle=this.textColor(),e.textAlign=this._isLeft?"right":"left",e.textBaseline="middle",(0,Z.drawScaled)(e,t,t,(()=>{
for(let s=i.length;s--;){if(!c[s].visible)continue;const r=i[s];e.fillText(r.label,n/t,r.coord+c[s].yCorrection)}})),e.restore()}_hasAlertLabel(){return this.priceScale().dataSources().some((e=>(0,ve.isAlertLabel)(e)))}async _showCurrenciesContextMenu(){var e;if(null!==this._currencyMenu&&this._currencyMenu.isOpened())return void this._currencyMenu.close();(0,ye.trackEvent)("GUI","Currency conversion");const{currencyActions:t}=await Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(4015),i.e(53842),i.e(38669),i.e(5145),i.e(30006),i.e(25190),i.e(46036),i.e(90684),i.e(40866),i.e(36752),i.e(96025),i.e(17111),i.e(50690),i.e(745),i.e(32704)]).then(i.bind(i,87423)),s=await Me(je,(()=>t(this._undoModel,(0,r.ensureNotNull)(this._currencyLabel).currencyInfo(),this.priceScale())),(0,r.ensureNotNull)(this._currencyLabel).currencyLabelElement(),(()=>{var e;this._recalcCurrencyAndUnitVisibility(),null===(e=this._currencyLabel)||void 0===e||e.setCurrencyExpanded(!1)}));null===(e=this._currencyLabel)||void 0===e||e.setCurrencyExpanded(!0),this._destroyed?s.close():this._currencyMenu=s}async _showUnitsContextMenu(){var e;if(null!==this._unitMenu&&this._unitMenu.isOpened())return void this._unitMenu.close();(0,ye.trackEvent)("GUI","Unit conversion");const{unitActions:t}=await Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(4015),i.e(53842),i.e(38669),i.e(5145),i.e(30006),i.e(25190),i.e(46036),i.e(90684),i.e(40866),i.e(36752),i.e(96025),i.e(17111),i.e(50690),i.e(745),i.e(32704)]).then(i.bind(i,63189)),s=await Me(Ye,(()=>t(this._undoModel,(0,r.ensureNotNull)(this._currencyLabel).unitInfo(),this.priceScale())),(0,r.ensureNotNull)(this._currencyLabel).unitLabelElement(),(()=>{var e;this._recalcCurrencyAndUnitVisibility(),null===(e=this._currencyLabel)||void 0===e||e.setUnitExpanded(!1)}));null===(e=this._currencyLabel)||void 0===e||e.setUnitExpanded(!0),this._destroyed?s.close():this._unitMenu=s}_onFontSizeChanged(){this._currencyLabelWidth=null,this._currencyFontSize=0,this._updateCurrencyLabelFont(),this.onOptimalWidthNeedToBeRecalculated()}_mouseOrTouchMoveEvent(e){var t,i,s,r;if(!this._priceScale)return;if(e.localX<0||e.localY<0||e.localX>=this._size.width||e.localY>=this._size.height)return;let o=!0;const n=this.dataSourceAtPoint(e.localX,e.localY);n?(this._setCursorClassName("pointer"),(null===(i=null===(t=this._lastHittestResult)||void 0===t?void 0:t.data())||void 0===i?void 0:i.hoverModelFromAxis)&&(this._undoModel.model().setHoveredSource(n,null!==(r=null===(s=this._lastHittestResult)||void 0===s?void 0:s.data())&&void 0!==r?r:null),o=!1)):this._setResizeCursor(),o&&this._undoModel.model().setHoveredSource(null,null)}_mouseDownOrTouchStartEvent(e){this._zoomAvailable()&&this._options.pressedMouseMoveScale&&!this._pinching&&(this._dragScaleActive=!0,this._undoModel.startScalePrice(this._pane.state(),this.priceScale(),e.localY))}_mouseEnterOrTouchStartEvent(e){this._setResizeCursor()}_pressedMouseOrTouchMoveEvent(e){if(this._dragScaleActive){const t=this.priceScale()
;this._undoModel.scalePriceTo(this._pane.state(),t,e.localY)}}_mouseUpOrTouchEndEvent(e){this._finishScale()}_finishScale(){this._dragScaleActive&&(this._undoModel.endScalePrice(this._pane.state(),this.priceScale()),this.restoreDefaultCursor(),this._dragScaleActive=!1)}_mouseClickOrTapEvent(e){if(this._currencyLabel){if(this._currencyLabel.currencyConversionAvailable()&&this._currencyLabel.currencyLabelElement().contains(e.target))return this._showCurrenciesContextMenu(),void e.preventDefault();if(this._currencyLabel.unitConversionAvailable()&&this._currencyLabel.unitLabelElement().contains(e.target))return this._showUnitsContextMenu(),void e.preventDefault()}const t=this.dataSourceAtPoint(e.localX,e.localY);t&&this._undoModel.selectionMacro((e=>{var i,s,r;e.selection().isSelected(t)&&this._undoModel.model().lastSelectedHittestData()===(null===(i=this._lastHittestResult)||void 0===i?void 0:i.data())||(e.clearSelection(),e.addSourceToSelection(t,null!==(r=null===(s=this._lastHittestResult)||void 0===s?void 0:s.data())&&void 0!==r?r:null))}))}_mouseLeaveOrTouchEndEvent(e){this._setCursorClassName("")}_mouseDoubleClickOrDoubleTapEvent(e){var t;const i=this.dataSourceAtPoint(e.localX,e.localY);i?this._pane.processDoubleClickOnSource(i,null!==(t=this._lastHittestResult)&&void 0!==t?t:void 0,{origin:"price_scale"}):(this.reset(),(0,ye.trackEvent)("GUI","Double click price scale"))}_contextMenuOrTouchContextMenuEvent(e){if(this._options.contextMenuEnabled){const t=this.dataSourceAtPoint(e.localX,e.localY);if(null!==t&&this._options.contextMenu.source){return void this._undoModel.model().selectionMacro((i=>{i.selection().isSelected(t)||(i.clearSelection(),i.addSourceToSelection(t)),this._pane.showContextMenuForSelection(e,{origin:"price_scale"})}))}this._options.contextMenu.general&&ce.ContextMenuManager.showMenu(this.getContextMenuActions(),e,{statName:"PriceScaleContextMenu"},{menuName:"PriceScaleContextMenu"})}}_setResizeCursor(){const e=this.priceScale();e.isPercentage()||e.isIndexedTo100()?this._setCursorClassName(""):this._zoomAvailable()&&(this._options.pressedMouseMoveScale||this._options.mouseWheelScale)&&this._setCursorClassName("ns-resize")}_setCursorClassName(e){let t="";e&&(t="price-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t)}_zoomAvailable(){return!this.priceScale().isEmpty()&&this._undoModel.model().zoomEnabled()}_onMousewheel(e){if(!this._zoomAvailable()||!this._options.mouseWheelScale)return;const t=(0,r.ensureNotNull)(this._mouseWheelHelper).processWheel(e).deltaY;if(0===t)return;e.cancelable&&e.preventDefault();const i=this._undoModel,s=this._pane.state(),o=this.priceScale(),n=this._cell.getBoundingClientRect(),a=e.clientY-n.top,l=a+15*t;i.startScalePrice(s,this.priceScale(),a,!0),i.scalePriceTo(s,o,l),i.endScalePrice(s,o),e.stopPropagation()}_drawCrossHairLabel(e,t){var i,s;e.save()
;const r=this._pane.state(),o=r.model(),n=this.priceScale(),a=[],l=this.priceScale()===r.defaultPriceScale(),c=null!==(i=o.lineBeingEdited())&&void 0!==i?i:o.lineBeingCreated();if(c&&(c.priceScale()===n||l&&r.isOverlay(c))){const e=c.priceAxisViews(r,n);e&&e.length&&a.push(e)}const h=o.customSourceBeingMoved();this._addViewsOrMaxMin(null===h?[]:[h],a),this._addViewsOrMaxMin(o.sourcesBeingMoved(),a),this._addViewsOrMaxMin(o.selection().allSources(),a);const d=o.hoveredSource();if(d){const e=r.customSources().includes(d)?n:d.priceScale();if(!o.selection().isSelected(d)&&(this._isFromSameSide(e)||l&&r.isOverlay(d))){const e=null===(s=o.hoveredSource())||void 0===s?void 0:s.priceAxisViews(r,n);e&&e.length&&a.push(e)}}const u=o.crossHairSource().priceAxisViews(r,n);u&&u.length&&a.push(u);const _=this.rendererOptions(),p=this._isLeft?"right":"left";a.forEach((i=>{i.forEach((i=>{e.save(),i.renderer().draw(e,_,this._widthCache,this._size.width,this._size.height,p,t),e.restore()}))})),e.restore()}_drawBackground(e,t){const i=Math.ceil(this._size.width*t),s=Math.ceil(this._size.height*t),r=this.backgroundTopColor(),o=this.backgroundColor();if(r===o?(0,Z.clearRect)(e,0,0,i+1,s+1,this.backgroundColor()):(0,Q.clearRectWithGradient)(e,0,0,i+1,s+1,r,o),this._highlighted){e.globalAlpha=.5;const t=ee.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight");(0,Z.fillRect)(e,0,0,i+1,s+1,t),e.globalAlpha=1}const n=this._pane.state().model(),a=this.priceScale(),l=n.selection().lineDataSources().filter((e=>e.priceScale()===a)).reduce(((e,t)=>{const i=t.priceAxisPoints();return 0===i.length?e:e.concat(i)}),[]);l.length>0&&this._hightlightBackground(e,l,this.priceScale().mainSource(),t);const c=n.crossHairSource();c.startMeasurePoint()&&this._hightlightBackground(e,c.measurePoints(),this.priceScale().mainSource(),t)}_drawBorder(e,t){e.save(),e.fillStyle=this.lineColor();const i=Math.max(1,Math.floor(this.rendererOptions().borderSize*t)),s=this._isLeft?Math.floor(this._size.width*t)-i:0;e.fillRect(s,0,i,Math.ceil(this._size.height*t)+1),e.restore()}_drawBackLabels(e,t){e.save();const i=this.backLabels(),s=this.rendererOptions(),r=this._isLeft?"right":"left";for(const o of i)o.isAxisLabelVisible()&&(e.save(),o.renderer().draw(e,s,this._widthCache,this._size.width,this._size.height,r,t),e.restore());e.restore()}_hightlightBackground(e,t,i,s){if(!i)return;const r=i.firstValue();if(null===r)return;let o=t[0].price,n=t[0].price;for(let e=1;e<t.length;e++)o=Math.min(o,t[e].price),n=Math.max(n,t[e].price);const a=this.priceScale(),l=Math.floor(a.priceToCoordinate(o,r)*s),c=Math.ceil(a.priceToCoordinate(n,r)*s);(0,Z.fillRect)(e,Math.floor(s),l,Math.ceil((this._size.width-1)*s)+1,c-l,this._properties.childs().axisHighlightColor.value())}_addViewsOrMaxMin(e,t){const i=this._pane.state(),s=this.priceScale();if(s!==i.defaultPriceScale()&&(e=e.filter((e=>i.isOverlay(e)||this._isFromSameSide(e.priceScale())))),0!==e.length)if(1===e.length){const r=e[0].priceAxisViews(i,s);r&&r.length&&t.push(r)
}else t.push(this._minMaxViews(e))}_minMaxViews(e){const t=this._pane.state(),i=this.priceScale(),s=[];let r=1/0,o=-1/0,n=null,a=null;for(const s of e){const e=s.priceAxisViews(t,i);if(e&&e.length)for(let t=0;t<e.length;t++){const i=e[t],s=i.coordinate();s>=o&&(o=s,a=i),s<=r&&(r=s,n=i)}}return a&&s.push(a),n&&s.push(n),s}_isFromSameSide(e){return null!==e&&(this._isLeft?this._pane.state().leftPriceScales():this._pane.state().rightPriceScales()).includes(e)}_sameSideSources(){const e=this._pane.state().sourcesByGroup();return this._isLeft?e.leftPriceScalesSources():e.rightPriceScalesSources()}_initActions(){if(!this._pane.hasState()||null!==this._actions)return;const e=this._undoModel,t=new y.Action({actionId:"Chart.PriceScale.Reset",label:Ke,icon:We,shortcutHint:(0,Le.humanReadableHash)(Le.Modifiers.Alt+82),statName:"ResetScale",onExecute:()=>this.reset()}),i=new y.Action({actionId:"Chart.PriceScale.ToggleAutoScale",label:Xe,checkable:!0,checked:!0,statName:"ToggleAutoScale",onExecute:()=>{e.togglePriceScaleAutoScaleMode(this.priceScale()),this._updateScalesActions()}}),s=new y.Action({actionId:"Chart.PriceScale.TogglePercentage",label:$e,checkable:!0,checked:this.priceScale().isPercentage(),statName:"TogglePercantage",onExecute:()=>{e.togglePriceScalePercentageScaleMode(this.priceScale()),this._updateScalesActions()}}),r=new y.Action({actionId:"Chart.PriceScale.ToggleIndexedTo100",label:Ze,checkable:!0,checked:this.priceScale().isIndexedTo100(),statName:"ToggleIndexedTo100",onExecute:()=>{e.togglePriceScaleIndexedTo100ScaleMode(this.priceScale()),this._updateScalesActions()}}),o=new y.Action({actionId:"Chart.PriceScale.ToggleLogarithmic",label:Qe,checkable:!0,checked:this.priceScale().isLog(),statName:"ToggleLogScale",onExecute:()=>{e.togglePriceScaleLogScaleMode(this.priceScale()),this._updateScalesActions()}}),n=new y.Action({actionId:"Chart.PriceScale.ToggleRegular",label:Je,checkable:!0,checked:this.priceScale().isRegular(),statName:"ToggleRegularScale",onExecute:()=>{e.setPriceScaleRegularScaleMode(this.priceScale()),this._updateScalesActions()}}),a=new y.Action({actionId:"Chart.PriceScale.Labels.ToggleNoOverlappingLabelsVisibility",label:et,checkable:!0,checked:this.priceScale().properties().childs().alignLabels.value(),statName:"TogglePreciseLabels"});a.setBinding(new ke.ActionBinder(a,this.priceScale().properties().childs().alignLabels,e,ze));const l=new y.Action({actionId:"Chart.PriceScale.ToggleInvertScale",label:tt,checkable:!0,checked:this.priceScale().isInverted(),statName:"Invert Scale",onExecute:()=>{e.invertPriceScale(this.priceScale()),this._updateScalesActions()}});this._actions={reset:t,setAutoScale:i,setPercentage:s,setIndexedTo100:r,setLog:o,setRegular:n,alignLabels:a,invertScale:l},this._updateScalesActions()}_logAction(){return this._isMainSeriesAxis()?this._chart.actions().logSeriesScale:(0,r.ensureNotNull)(this._actions).setLog}_percentageAction(){return this._isMainSeriesAxis()?this._chart.actions().percentSeriesScale:(0,r.ensureNotNull)(this._actions).setPercentage}_indexedTo100Action(){
return this._isMainSeriesAxis()?this._chart.actions().indexedTo100SeriesScale:(0,r.ensureNotNull)(this._actions).setIndexedTo100}_autoScaleAction(){return this._isMainSeriesAxis()?this._chart.actions().autoSeriesScale:(0,r.ensureNotNull)(this._actions).setAutoScale}_regularScaleAction(){return this._isMainSeriesAxis()?this._chart.actions().regularSeriesScale:(0,r.ensureNotNull)(this._actions).setRegular}_lockScaleAction(){const e=this._chart.actions().lockSeriesScale,t=it(this.priceScale(),this._undoModel.model().mainSeriesScaleRatio());return e.update({hint:t}),e}_invertAction(){return this._isMainSeriesAxis()?this._chart.actions().invertSeriesScale:(0,r.ensureNotNull)(this._actions).invertScale}_isMainSeriesAxis(){return this.priceScale().hasMainSeries()}_updateScalesActions(){const e=this.priceScale(),t=this._isMainSeriesAxis(),i=(0,r.ensureNotNull)(e.mainSource()).properties(),s=t&&e.isLockScale(),o=t&&6===i.style.value(),n=(0,r.ensureNotNull)(this._actions);n.setRegular.update({checked:e.isRegular(),disabled:s||o}),n.setPercentage.update({checked:e.isPercentage(),disabled:s||o}),n.setIndexedTo100.update({checked:e.isIndexedTo100(),disabled:s||o}),n.setLog.update({checked:e.isLog(),disabled:s||o}),n.setAutoScale.update({checked:e.isAutoScale(),disabled:e.properties().childs().autoScaleDisabled.value()})}_createMergeScalesAction(){const e=this._chart.actions(),t=this._undoModel.model().priceScaleSlotsCount();if(t.left+t.right===1)return 0===t.left?e.moveScaleToLeft:e.moveScaleToRight;const i=[];return i.push(e.mergeLeftScalesAction),i.push(e.mergeRightScalesAction),new y.Action({actionId:"Chart.PriceScale.MergeAllScales",label:Ge,subItems:i})}_setCursor(e){let t="";"grabbing"!==e&&"ns-resize"!==e||(t="price-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t,this._cell.style.cursor)}_createScaleModeButtons(){var e;const t=this._scaleModeButtons=new Fe({className:"price-axis__modeButtons",setMode:e=>{this._priceScale&&("log"===e?this._chart.model().setPriceScaleMode({log:!this._priceScale.isLog()},this._priceScale,Ue):this._chart.model().setPriceScaleMode({autoScale:!this._priceScale.isAutoScale()},this._priceScale,He))}});return t.element().style.background=this.backgroundColor(),this._cell.appendChild(t.element()),null===(e=this._priceScale)||void 0===e||e.modeChanged().subscribe(this,this._updateScaleModeButtons),this._updateScaleModeButtons(),t}_destroyScaleModeButtons(){var e;this._scaleModeButtons&&(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),null===(e=this._priceScale)||void 0===e||e.modeChanged().unsubscribe(this,this._updateScaleModeButtons),this._scaleModeButtons.destroy(),this._scaleModeButtons=null)}_highlightColor(){const e=this.backgroundColor(),t=this._backgroundBasedTheme.value();if(null===this._highlightColorCache||this._highlightColorCache.backgroundColor!==e||this._highlightColorCache.theme!==t){const i=(0,
be.applyTransparency)(ee.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight"),50),s=(0,me.rgbaToString)((0,me.blendRgba)((0,me.parseRgba)(this.backgroundColor()),(0,me.parseRgba)(i)));this._highlightColorCache={theme:t,backgroundColor:e,resultColor:s}}return this._highlightColorCache.resultColor}}var ot=i(104415),nt=i(89820),at=i(371764),lt=i(974655),ct=i(924788),ht=i(558793),dt=i(606097),ut=i(846778),_t=i(458527),pt=i(794349),mt=i(147354),gt=i(673747),St=i(100366),vt=i(451798),ft=i(237872);function bt(e){return"startMoving"in e&&"move"in e&&"endMoving"in e&&"convertYCoordinateToPriceForMoving"in e}var yt=i(440617),Ct=i(964824),wt=i(871332);i(784516);const Pt=parseInt(wt["css-value-pane-controls-padding-left"]),Tt=parseInt(wt["css-value-pane-controls-padding-right"]),Mt=(0,F.getHexColorByName)("color-cold-gray-700"),xt=(0,F.getHexColorByName)("color-cold-gray-400"),It=new z.TranslatedString("scroll",n.t(null,void 0,i(468193))),Lt=n.t(null,void 0,i(482232)),kt=n.t(null,void 0,i(398478));function At(e,t,i){e.drawBackground&&e.drawBackground(t,i)}function Et(e,t,i){e.draw(t,i)}function Dt(e,t){return e.paneViews(t)}function Bt(e,t){return e.topPaneViews()}function Rt(e,t){return e.labelPaneViews(t)}function Nt(e,t){const i=e.strategyOrdersPaneView();return null===i?null:[i]}function Vt(e,t){return null===e||e.source!==t?null:e.hittest.data()}function Ot(e,t,i,s,r){var o,n;const a=null!==(n=null===(o=e.result)||void 0===o?void 0:o.hittest.target())&&void 0!==n?n:0;t.target()>a&&(e.result={hittest:t,source:i,renderer:s,isCustom:r})}const Ft={contextMenuEnabled:!0,contextMenu:De.defaultContextMenuOptions,priceScaleContextMenuEnabled:!0,legendWidgetEnabled:!0,controlsEnabled:!0,propertyPagesEnabled:!0,sourceSelectionEnabled:!0,countdownEnabled:!0},Wt=new Map([[G.AreaName.Text,"Text"],[G.AreaName.Style,"Style"]]),zt=!Ee.enabled("display_legend_on_all_charts");let Ht=null;function Ut(e,t){return!(0,G.shouldDefaultActionBeExecuted)(e,t,"pressedMouseMoveHandler","touchMoveHandler")}class Gt{constructor(e,t,i,o){this._legendWidget=null,this._paneControls=null,this._isDestroyed=!1,this._trackCrosshairOnlyAfterLongTap=(0,H.lastMouseOrTouchEventInfo)().isTouch,this._startTrackPoint=null,this._exitTrackingModeOnNextTry=!1,this._startMoveSourceParams=null,this._startChangeLineToolParams=null,this._preventSourceChange=!1,this._clonningAtMoveLineTools=null,this._startCloningPoint=null,this._size=(0,s.size)({width:0,height:0}),this._themedTopColor=null,this._initCrossHairPosition=null,this._firstZoomPoint=null,this._editDialog=null,this._processing=!1,this._pressedMoveStage=0,this._touchMove=!1,this._startTouchPoint=null,this._isSelecting=!1,this._prevHoveredHittest=null,this._contextMenuX=0,this._contextMenuY=0,this._startScrollingPos=null,this._isScrolling=!1,this._scrollPriceScale=null,this._scrollXAnimation=null,this._prevPinchScale=1,this._pinching=!1,this._wasPinched=!1,this._longTap=!1,this._contextMenuOpenedOnLastTap=!1,this._paneControlsResizeObserver=null,this._lastClickedSource=null,
this._customLegendWidgetsFactoryMap=new Map,this._prevMoveEventPosition=null,this._onMagnetStateChangedListener=this._onMagnetStateChanged.bind(this),this._onShiftKeyStateChangedListener=this._onShiftKeyStateChanged.bind(this),this._currentCursorClassName="",this._lastFinishedToolId=null,this._needResetMeasureLater=!1,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null,this._prevTooltipData=null,this._errorRenderer=null,this._highlightedPriceAxis=new Se.WatchedValue({owner:"",axis:null}),this._visuallyCollapsed=new Se.WatchedValue(!1),this._endOfSeriesDataBanner=null,this._canvasConfiguredHandler=()=>this._state&&this._chartModel().lightUpdate(),this._updateVisuallyCollapsed=()=>{this._visuallyCollapsed.setValue(!this.state().maximized().value()&&this.state().collapsed().value())},this._chart=e,this._state=t,this._options=(0,S.merge)((0,S.clone)(Ft),i),this._paneWidgetsSharedState=o,this._state&&this._subscribeToState();const n={contextMenuEnabled:this._options.priceScaleContextMenuEnabled,pressedMouseMoveScale:this._options.handleScale.axisPressedMouseMove.price,mouseWheelScale:this._options.handleScale.mouseWheel,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,countdownEnabled:this._options.countdownEnabled,croppedTickMarks:this._options.croppedTickMarks};void 0!==this._options.priceScaleContextMenu&&(n.contextMenu=this._options.priceScaleContextMenu);const a=(e,t,i,s,r)=>new rt(this._chart,this,this._chartUndoModel(),i,t,e,n,s,r),l=e.properties().childs().scalesProperties,c=this._chartModel().rendererOptionsProvider(),h={backgroundBasedTheme:e.backgroundBasedTheme(),rendererOptionsProvider:c,getBackgroundTopColor:()=>this._chartModel().backgroundTopColor().value(),getBackgroundBottomColor:()=>this._chartModel().backgroundColor().value()},d={showLabels:!1};this._lhsPriceAxisesContainer=new pe(l,"left",a,h,d),this._rhsPriceAxisesContainer=new pe(l,"right",a,h,d),this._paneCell=document.createElement("td"),this._paneCell.classList.add("chart-markup-table","pane"),this._div=document.createElement("div"),this._div.classList.add("chart-gui-wrapper"),this._div.setAttribute("data-name","pane-widget-chart-gui-wrapper"),this._paneCell.appendChild(this._div),this._canvasBinding=(0,Z.createBoundCanvas)(this._div,(0,s.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const u=this._canvasBinding.canvasElement;u.style.position="absolute",u.style.left="0",u.style.top="0",this._topCanvasBinding=(0,Z.createBoundCanvas)(this._div,(0,s.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const _=this._topCanvasBinding.canvasElement;_.style.position="absolute",_.style.left="0",_.style.top="0",this._rowElement=document.createElement("tr"),this._rowElement.appendChild(this._lhsPriceAxisesContainer.getElement()),this._rowElement.appendChild(this._paneCell),
this._rowElement.appendChild(this._rhsPriceAxisesContainer.getElement()),this._options.legendWidgetEnabled&&(this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._loadAndCreateLegendWidget()),this._state&&!this._chart.readOnly()&&this._options.controlsEnabled&&this._loadAndCreatePaneControlsWidget(),(0,vt.magnetEnabled)().subscribe(this._onMagnetStateChangedListener),(0,ft.shiftPressed)().subscribe(this._onShiftKeyStateChangedListener),this._paneCell.addEventListener("dragover",(e=>{e.dataTransfer&&Array.from(e.dataTransfer.files).some(dt.blobImageFilter)&&e.preventDefault()})),this._paneCell.addEventListener("drop",(e=>{if(window.user.id&&e.dataTransfer&&this._state){const t=Array.from(e.dataTransfer.files).find(dt.blobImageFilter);if(t){e.preventDefault();const i=(0,dt.uploadImage)(t),s=URL.createObjectURL(t);this._chartUndoModel().pasteImageAsLineTool(i,s,this._state),i.catch((e=>{this._chart.chartWidgetCollection().getToasts().then((t=>{(0,r.ensureNotNull)(t).showSimpleToast({title:kt,text:e.message,role:"alert",intent:V.ToastIntent.Warning})}))}))}}})),this.setCursorForTool(),this._mouseEventHandler=new $.MouseEventHandler(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:!this._options.handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:!this._options.handleScroll.horzTouchDrag}),this._prevHoveredHittest=null,this._highlightedPriceAxis.subscribe((e=>this._highlightPriceAxisByLabel(e.axis))),this._prevPinchScale=0,this._isDestroyed=!1}destroy(){var e;this._chart.onPaneWidgetDestroyed(this),this._customLegendWidgetsFactoryMap.clear(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._legendWidget&&(this._legendWidget.destroy(),this._legendWidget=null),null!==this._paneControlsResizeObserver&&this._paneControlsResizeObserver.disconnect(),null!==this._paneControls&&(this._paneControls.destroy(),this._paneControls=null),this._lhsPriceAxisesContainer.destroy(),this._rhsPriceAxisesContainer.destroy(),this.hasState()&&this._unsubscribeFromState(),(0,vt.magnetEnabled)().unsubscribe(this._onMagnetStateChangedListener),(0,ft.shiftPressed)().unsubscribe(this._onShiftKeyStateChangedListener),this._paneWidgetsSharedState.onPaneDestroyed(this),this._errorRenderer&&this._errorRenderer.then((e=>{e.destroy(),this._errorRenderer=null})),this._prevHoveredHittest=null,this._mouseEventHandler.destroy(),null===(e=this._rowElement.parentElement)||void 0===e||e.removeChild(this._rowElement),this._isDestroyed=!0}size(){return this._size}setSize(e){(0,s.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._paneCell.style.width=e.width+"px",this._paneCell.style.height=e.height+"px",this._div.style.width=e.width+"px",this._div.style.height=e.height+"px",
this._rowElement.classList.toggle("js-hidden",0===e.height),null!==this._legendWidget&&this._legendWidget.updateWidgetModeBySize(e),null!==this._paneControls&&this._paneControls.updateWidgetModeByWidth(e.width))}width(){return this._size.width}height(){return this._size.height}backgroundColor(){return this._chartModel().backgroundColor().value()}highlightedPriceAxis(){return this._highlightedPriceAxis}processDoubleClickOnSource(e,t,i){(0,ve.isAlertLabel)(e)?(0,ht.getChartAlertsFacade)().then((t=>{var s;(0,ye.trackEvent)("chart_alert","edit",`double_click_on_${null!==(s=null==i?void 0:i.origin)&&void 0!==s?s:"line"}`),t.openEditDialog(e.alert(),{actionSource:"alert_label_double_click"})})):(0,Y.isDataSource)(e)&&e.id()!==this._lastFinishedToolId&&this._showEditDialogForSource(e,t)}stretchFactor(){return this._state?this._state.stretchFactor():0}setStretchFactor(e){this.hasState()&&this.state().setStretchFactor(e)}setCursorForTool(e,t,i){if(t&&t.mod()&&e&&e!==this._chartModel().crossHairSource())return void this._setCursorClassName("pointer");if(void 0!==i){switch(i){case mt.PaneCursorType.VerticalResize:this._setCursorClassName("ns-resize");break;case mt.PaneCursorType.HorizontalResize:this._setCursorClassName("ew-resize");break;case mt.PaneCursorType.DiagonalNeSwResize:this._setCursorClassName("nesw-resize");break;case mt.PaneCursorType.DiagonalNwSeResize:this._setCursorClassName("nwse-resize");break;case mt.PaneCursorType.Default:this._setCursorClassName("default");break;case mt.PaneCursorType.Pointer:this._setCursorClassName("pointer");break;case mt.PaneCursorType.Grabbing:this._setCursorClassName("grabbing")}return}const s=K.tool.value();if((0,K.toolIsCursor)(s)){if(null!==this._paneWidgetsSharedState.draggingSource()||this._isScrolling||this._chartUndoModel()&&this._chartUndoModel().model().sourcesBeingMoved().length)return void this._setCursorClassName("grabbing");if(e&&this._options.sourceSelectionEnabled)return void this._setCursorClassName("pointer")}if("eraser"===s)return void this._setCursorClassName("eraser");if("zoom"===s)return void this._setCursorClassName("zoom-in");const r=K.cursorTool.value();"dot"!==r?"arrow"!==r?this._setCursorClassName(""):this._setCursorClassName("default"):this._setCursorClassName("dot")}showContextMenuForSelection(e,t){const i=this._chartUndoModel().selection();if(i.isEmpty())return;const s=i.dataSources().filter((e=>e.hasContextMenu()));this.showContextMenuForSources(s,e,void 0,t)}async showContextMenuForSources(e,t,i,s){var r;if(!e.length)return Promise.resolve(null);const o=e[0],n=(0,S.merge)((0,S.clone)(this._options.contextMenu),i||{}),a=new De.ActionsProvider(this._chart,n);if(o===this._chartUndoModel().crossHairSource())return o.handleContextMenuEvent(t),Promise.resolve(null);{const i=await a.contextMenuActionsForSources(e,t,null==s?void 0:s.origin);if(0===i.length)return Promise.resolve(null);{let e;return e=o instanceof yt.Series?{menuName:"ObjectTreeContextMenu",detail:{type:"series",id:o.instanceId()}}:(0,A.isLineTool)(o)?{menuName:"ObjectTreeContextMenu",detail:{
type:"shape",id:null!==(r=null==o?void 0:o.id())&&void 0!==r?r:null}}:{menuName:"ObjectTreeContextMenu",detail:{type:"study",id:(null==o?void 0:o.id())||null}},ce.ContextMenuManager.createMenu(i,void 0,e).then((e=>(e.show(t),e)))}}}leftPriceAxisesContainer(){return this._lhsPriceAxisesContainer}rightPriceAxisesContainer(){return this._rhsPriceAxisesContainer}setPriceAxisSizes(e,t,i){this._priceAxisesContainer(e).setSizes(t,i)}state(){return(0,r.ensureNotNull)(this._state)}hasState(){return null!==this._state}setState(e){this._state!==e&&(this.hasState()&&this._unsubscribeFromState(),this._state=e,this.hasState()&&(this._subscribeToState(),this.updatePriceAxisWidgetsStates()))}getScreenshotData(e){var t,i,s,r;const o=[],n=[];let a,l=[];const c=this.state().sourcesByGroup().priceSources().slice().reverse(),h=this._chart.properties().childs().paneProperties.childs().legendProperties.childs();for(const d of c){const c=d.statusView();if((0,D.isStudy)(d)&&(h.showLegend.value()||(null==e?void 0:e.showCollapsedStudies))){const s=h.showStudyTitles.value(),r=!0;if(d.properties().childs().visible.value()&&c&&r){o.push(s?d.statusProvider(null==e?void 0:e.status).text():"");const r=Ee.enabled("use_last_visible_bar_value_in_legend")&&null!==(i=null===(t=this._chartModel().timeScale().visibleBarsStrictRange())||void 0===t?void 0:t.lastBar())&&void 0!==i?i:null,a=d.valuesProvider().getValues(r);n.push(a)}}else if(d===this._chartModel().mainSeries()&&c&&h.showSeriesTitle.value()){a=d.statusProvider((null==e?void 0:e.status)||{}).text();const t=Ee.enabled("use_last_visible_bar_value_in_legend")&&null!==(r=null===(s=this._chartModel().timeScale().visibleBarsStrictRange())||void 0===s?void 0:s.lastBar())&&void 0!==r?r:null;l=d.valuesProvider().getValues(t)}}return{type:"pane",leftAxis:this._lhsPriceAxisesContainer.getScreenshotData(),rightAxis:this._rhsPriceAxisesContainer.getScreenshotData(),content:this._canvasBinding.canvasElement.toDataURL(),canvas:this._canvasBinding.canvasElement,contentWidth:this._size.width,contentHeight:this._size.height,studies:o,studiesValues:n,containsMainSeries:this.containsMainSeries(),mainSeriesText:a,mainSeriesValues:l}}updatePriceAxisWidgetsStates(){if(!this.hasState())return;const e=this._chartModel(),t=e.paneForSource(e.mainSeries());if(!t)return;const i=e.priceScaleSlotsCount(),s=this.state(),r=s.visibleLeftPriceScales(),o=s.visibleRightPriceScales();this._lhsPriceAxisesContainer.setScales(r,i.left,t.leftPriceScales().length,i.left+i.right),this._rhsPriceAxisesContainer.setScales(o,i.right,t.rightPriceScales().length,i.left+i.right)}updatePriceAxisWidgets(){this._lhsPriceAxisesContainer.update(),this._rhsPriceAxisesContainer.update()}update(){this.hasState()&&(this.updatePriceAxisWidgets(),null!==this._legendWidget&&this._legendWidget.update(),this.updateControls())}updateStatusWidget(e){this.hasState()&&null!==this._legendWidget&&(e.legendWidgetLayoutInvalidated()?this._legendWidget.updateLayout():this._legendWidget.update())}updateControls(){
this.hasState()&&null!==this._paneControls&&this._paneControls.update()}updateThemedColors(e){this._themedTopColor=e.topColor,this._updateByThemedColors()}statusWidget(){return this._legendWidget}getElement(){return this._rowElement}canvasElement(){return this._canvasBinding.canvasElement}hasCanvas(e){return this._canvasBinding.canvasElement===e||this._topCanvasBinding.canvasElement===e}pinchStartEvent(){return null===this._paneWidgetsSharedState.scrollingPane()&&null===this._paneWidgetsSharedState.pinchingPane()&&(this._onTouchEvent(),!!this._options.handleScale.pinch&&(this._chartModel().stopTimeScaleAnimation(),this._prevPinchScale=1,this._pinching=!0,this._wasPinched=!0,this._paneWidgetsSharedState.setPinchingPane(this),!0))}pinchEvent(e,t,i,s){if(null!==this._paneWidgetsSharedState.scrollingPane()||this._paneWidgetsSharedState.pinchingPane()!==this)return;if(this._onTouchEvent(),!this._options.handleScale.pinch)return;const r=10*(s-this._prevPinchScale);this._prevPinchScale=s,this._chartModel().zoomTime(e.x,r,!0),this._prevPinchScale=s}pinchEndEvent(){null===this._paneWidgetsSharedState.scrollingPane()&&this._paneWidgetsSharedState.pinchingPane()===this&&(this._onTouchEvent(),this._pinching=!1,this._paneWidgetsSharedState.setPinchingPane(null))}mouseClickEvent(e){this._onMouseEvent(),this._mouseClickOrTapEvent(e)}tapEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseClickOrTapEvent(e))}mouseDownEvent(e){this._onMouseEvent(),this.hasState()&&this._mouseDownOrTouchStartEvent(e,this._dataSourceAtPoint(e.localX,e.localY))}touchStartEvent(e){if(this._paneWidgetsSharedState.startTouch(this),this._preventTouchEventsExceptPinch())return;const t=!this._trackCrosshairOnlyAfterLongTap&&null!==Ht&&Ht.stateId===this.state().id()&&Math.abs(Ht.x-e.localX)+Math.abs(Ht.y-e.localY)<5;this._onTouchEvent(),this._chart.setActivePaneWidget(this);const i=this._dataSourceAtPoint(e.localX,e.localY);if(t){const t=this._chartModel().crossHairSource();null!==i&&i.source===t||t.selectPointMode().value()!==K.SelectPointMode.None?this.startTrackingMode(new O.Point(e.localX,e.localY),new O.Point(e.localX,e.localY)):!this._chart.readOnly()&&null!==i&&((0,A.isLineTool)(i.source)&&i.source.userEditEnabled()||(0,ve.isAlertLabel)(i.source))&&this._chartUndoModel().selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(i.source,i.hittest.data())}))}this._mouseDownOrTouchStartEvent(e,i),this._mouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._onMouseEvent(),this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._paneWidgetsSharedState.endTouch(this),this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseOrTouchLeaveEvent(e),this._mouseUpOrTouchEndEvent(e))}mouseMoveEvent(e){this._onMouseEvent(),this._mouseOrTouchMoveEvent(e)}pressedMouseMoveEvent(e){this._onMouseEvent(),this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._pressedMouseOrTouchMoveEvent(e))}mouseLeaveEvent(e){this._onMouseEvent(),
this._updateHoveredSource(null,new j.EnvironmentState(e)),this._mouseOrTouchLeaveEvent(e)}mouseDoubleClickEvent(e){this._onMouseEvent(),this._mouseDoubleClickOrDoubleTapEvent(e)}wheelClickEvent(e){if(this._chart.readOnly())return;const t=this._dataSourceAtPoint(e.localX,e.localY);if(null===t||t.isCustom)return;if((t.hittest.target()||0)<=G.HitTarget.MovePointBackground)return;const i=new j.EnvironmentState(e),s=t.hittest.eraseMarker();if(i.mod()&&void 0!==s&&t.source.processErase)return void t.source.processErase(this._chartUndoModel(),s);const o=this._chartUndoModel();o.selection().isSelected(t.source)||o.selectionMacro((e=>{e.clearSelection();const i=(0,r.ensureNotNull)(t.source);e.addSourceToSelection(i,Vt(t,i))})),this._chart.removeSelectedSources()}doubleTapEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseDoubleClickOrDoubleTapEvent(e))}longTapEvent(e){if(null===this._state||this._preventTouchEventsExceptPinch())return;if(this._onTouchEvent(),this._longTap=!0,null!==this._startTrackPoint||!this._trackingModeShouldBeActive())return;const t=this._chartModel().selection();if(!t.isEmpty()){const i=this._dataSourceAtPoint(e.localX,e.localY);if(null!==i&&t.isSelected(i.source))return}this.startTrackingMode(new O.Point(e.localX,e.localY),new O.Point(e.localX,e.localY),new j.EnvironmentState(e))}mouseEnterEvent(e){if(this._onMouseEvent(),!this.hasState())return;this._chart.setActivePaneWidget(this);const t=this._dataSourceAtPoint(e.localX,e.localY);this._updateHoveredSource(t,new j.EnvironmentState(e)),this._setCursorPosition(e.localX,e.localY,new j.EnvironmentState(e))}contextMenuEvent(e){this._onMouseEvent(),this._contextMenuEvent(e)}touchContextMenuEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._contextMenuEvent(e))}mouseDownOutsideEvent(e){this._processOutsideClick(null,e)}touchStartOutsideEvent(e){this._processOutsideClick(null,e)}cancelZoom(){this._chartModel().crossHairSource().clearSelection(),this._firstZoomPoint=null,this._preventCrossHairMove()&&this._clearCursorPosition()}startTrackingMode(e,t,i){this._startChangeLineToolParams=null,this._startMoveSourceParams=null,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null,this._chartUndoModel().selectionMacro((e=>e.clearSelection())),this._startTrackPoint=e,this._exitTrackingModeOnNextTry=!1,this._setCursorPosition(t.x,t.y,i),this._initCrossHairPosition=this._chartModel().crossHairSource().currentPoint()}setDragToAnotherPaneCursor(){this._setCursorClassName("grabbing")}cloneLineTools(e,t){return this._chartUndoModel().cloneLineTools(e,t)}exitTrackingMode(){null!==this._state&&null!==this._startTrackPoint&&(this._exitTrackingModeOnNextTry=!0,this._tryExitTrackingMode())}trackingModeEnabled(){return null!==this._state&&null!==this._startTrackPoint}addCustomWidgetToLegend(e,t){this._options.legendWidgetEnabled&&(this._customLegendWidgetsFactoryMap.set(e,t),null!==this._legendWidget&&this._legendWidget.addCustomWidgetToLegend(e,t))}containsMainSeries(){
return!!this.hasState()&&this.state().containsMainSeries()}paint(e){if(!this._chartUndoModel()||!this.hasState()||0===this._size.width||0===this._size.height)return;(0,Z.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,Z.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding),this._state&&(e.priceScaleSideMaxLevel("left")>R.InvalidationLevel.Cursor||e.priceScaleSideMaxLevel("right")>R.InvalidationLevel.Cursor)&&(this._recalculatePriceScales((0,Ct.viewportChangeEvent)()),null!==Ht&&Ht.stateId===this.state().id()&&this._setCursorPosition(Ht.x,Ht.y,Ht.envState));const t=e.fullInvalidation();if(t>R.InvalidationLevel.Cursor&&null!==Ht&&Ht.stateId===this.state().id()){const e=this._dataSourceAtPoint(Ht.x,Ht.y);this._updateHoveredSource(e,(0,ft.globalEnvironmentState)())}if(this._lhsPriceAxisesContainer.paint(e.getterForPriceScaleInvalidationLevelBySide("left")),this._rhsPriceAxisesContainer.paint(e.getterForPriceScaleInvalidationLevelBySide("right")),t===R.InvalidationLevel.None)return;const i=this._state&&(this._state.maximized().value()||!this._state.collapsed().value());if(t>R.InvalidationLevel.Cursor){const e=(0,r.ensureNotNull)(this._canvasBinding.canvasElement.getContext("2d"));e.setTransform(1,0,0,1,0,0),this._makeSureIsUpdated();const t=this._canvasRenderParams();this._drawBackground(e,t),i&&this._drawSources(e,t)}if(null!==this._state){const e=(0,r.ensureNotNull)(this._topCanvasBinding.canvasElement.getContext("2d"));e.setTransform(1,0,0,1,0,0);const t=this._topCanvasRenderParams();e.clearRect(0,0,Math.ceil(this._size.width*t.pixelRatio),Math.ceil(this._size.height*t.pixelRatio)),i&&this._drawSeriesTopViews(e,t),this._drawCrossHair(e,t),i&&this._drawActiveLineTools(e,t)}this._updateEndOfSeriesBanner()}cancelCreatingLineTool(){const e=this._chartUndoModel(),t=this._chartUndoModel().lineBeingCreated();if(t)if(t.pointsCount()<=0&&!(0,E.isLineDrawnWithPressedButton)(t.toolname)){const i=t.points();if(i.length>2){const s=i[i.length-2];e.continueCreatingLine(s),this._finishTool(t)}else e.cancelCreatingLine()}else e.cancelCreatingLine();null!==this._firstZoomPoint&&this.cancelZoom(),this.setCursorForTool()}drawRightThere(e){if((0,E.isLineToolName)(e)&&this.hasState()){const t=this._chartUndoModel(),i=t.crossHairSource(),s=t.model().magnet().align(i.price,i.index,this.state());t.createLineTool({pane:this.state(),point:{index:i.index,price:s},linetool:e})}}cancelMeasuring(){this._chartUndoModel().crossHairSource().clearMeasure(),(0,K.resetToCursor)(),this.setCursorForTool()}async setErrorMessage(e){var t,i,s;e&&!this._errorRenderer&&(this._errorRenderer=this._createErrorBlock()),null===(t=await this._errorRenderer)||void 0===t||t.update({message:null==e?void 0:e.message,icon:(null===(i=this._state)||void 0===i?void 0:i.containsMainSeries())||(null===(s=this._state)||void 0===s?void 0:s.maximized().value())?null==e?void 0:e.icon:void 0,backgroundColor:`linear-gradient(${this._chartModel().backgroundTopColor().value()}, ${this._chartModel().backgroundColor().value()})`,
textColor:this._chartModel().dark().value()?xt:Mt,solutionId:null==e?void 0:e.solutionId})}collapsedHeight(){var e,t;return Math.max(Math.ceil(null!==(t=null===(e=this._paneControls)||void 0===e?void 0:e.bottomWithMargin())&&void 0!==t?t:0),33)}_topCanvasRenderParams(){return{pixelRatio:(0,Z.getBindingPixelRatio)(this._topCanvasBinding),physicalWidth:this._topCanvasBinding.canvasElement.width,physicalHeight:this._topCanvasBinding.canvasElement.height,cssWidth:this._chartModel().timeScale().width(),cssHeight:this.height()}}_canvasRenderParams(){return{pixelRatio:(0,Z.getBindingPixelRatio)(this._canvasBinding),physicalWidth:this._canvasBinding.canvasElement.width,physicalHeight:this._canvasBinding.canvasElement.height,cssWidth:this._chartModel().timeScale().width(),cssHeight:this.height()}}_tryExitTrackingMode(e){this._exitTrackingModeOnNextTry&&(this._startTrackPoint=null,e||this._clearCursorPosition())}_tryStartMeasure(e,t,i,s,r){return!(!(0,K.toolIsMeasure)(K.tool.value())||t.startMeasurePoint())&&(e.isTouch||this._preventCrossHairMove()||this._setCursorPosition(e.localX,e.localY,i),s=this._chartModel().magnet().align(s,r,this.state()),t.startMeasuring({price:s,index:r},this.state()),!0)}_tryFinishMeasure(e,t){if(t.startMeasurePoint()&&!t.endMeasurePoint()){let i=t.price;const s=t.index;return i=this._chartModel().magnet().align(i,s,this.state()),t.finishMeasure({price:i,index:s}),e.isTouch?(0,K.resetToCursor)():this._needResetMeasureLater=!0,this._preventCrossHairMove()&&this._clearCursorPosition(),!0}return!1}_tryStartZoom(e,t,i,s){const r=this._chart.model().model().zoomEnabled();if("zoom"===K.tool.value()&&r){const r=this._chartUndoModel(),o=r.timeScale().indexToCoordinate(i)-.5*r.timeScale().barSpacing();return this._firstZoomPoint={price:t,index:i,x:o,y:e.localY},this._preventCrossHairMove()||this._setCursorPosition(e.localX,e.localY,s),this._chartModel().crossHairSource().startSelection(this.state()),!0}return!1}_finishZoom(e){const t=this.state(),i=t.defaultPriceScale(),s=(0,r.ensureNotNull)(t.mainDataSource()).firstValue(),o=i.coordinateToPrice(e.localY,(0,r.ensureNotNull)(s)),n=this._chartUndoModel(),a=Math.round(n.timeScale().coordinateToIndex(e.localX)),l=(0,r.ensureNotNull)(this._firstZoomPoint);a!==l.index&&n.zoomToViewport(l.index,a,l.price,o,t),this._chartModel().crossHairSource().clearSelection(),this._firstZoomPoint=null,(0,K.resetToCursor)(),this._preventCrossHairMove()&&this._clearCursorPosition()}_tryFinishZoom(e){return null!==this._firstZoomPoint&&(this._finishZoom(e),!0)}_tryHandleEraserMouseDown(e,t){if(!("eraser"!==K.tool.value()||e.isCustom||(i=e.source,i&&i.customization&&i.customization.disableErasing))){const i=this._chartUndoModel();if((0,A.isLineTool)(e.source)||(0,D.isStudy)(e.source)){const s=e.hittest.eraseMarker();return t.mod()&&void 0!==s&&e.source.processErase?e.source.processErase(i,s):i.removeSource(e.source,!1),!0}}var i;return!1}_tryStartChangingLineTool(e,t,i,s){var o,n,a;if(e.isTouch&&null!==this._startTrackPoint)return!1;const l=t.hittest
;if((!e.isTouch||!this._preventSourceChange)&&l&&(0,A.isLineTool)(t.source)&&l.target()===G.HitTarget.ChangePoint){const c=this._chartUndoModel(),h=(0,r.ensure)(null===(o=this.state().mainDataSource())||void 0===o?void 0:o.firstValue()),d=(0,r.ensureNotNull)(t.source.priceScale()).coordinateToPrice(e.localY,h);c.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(t.source,l.data())}));let u=d;t.source.priceScale()===c.mainSeries().priceScale()&&(u=c.model().magnet().align(d,s,this.state()));const _=null===(n=l.data())||void 0===n?void 0:n.nonDiscreteIndex;_&&(s=c.timeScale().coordinateToFloatIndex(e.localX));const p=null===(a=l.data())||void 0===a?void 0:a.pointIndex;return this._startChangeLineToolParams={source:t.source,startPoint:{index:s,price:u,nonDiscreteIndex:_},screenPoint:{x:e.localX,y:e.localY},pointIndex:p,envState:i},!0}return this._startChangeLineToolParams=null,!1}_tryStartCloning(e,t,i,s){if(i.mod()){const t=this._chartUndoModel().selection().dataSources().filter((e=>e.cloneable()));if(s&&s.cloneable()&&t.push(s),t.length>0)return this._clonningAtMoveLineTools=t.map((e=>e.id())),this._startCloningPoint=new O.Point(e.localX,e.localY),!0}return!1}_tryFinishClonning(e,t,i){const s=this._chartUndoModel(),o=this._chartModel();if(t.mod()&&this._clonningAtMoveLineTools){const n=new O.Point(e.localX,e.localY),a=(0,r.ensureNotNull)(this._startCloningPoint).subtract(n).length(),l=[];for(const e of this._clonningAtMoveLineTools){const t=o.dataSourceForId(e);null!==t&&l.push(t)}if(0===l.length)return!1;if(a>8){const o=this.cloneLineTools(l,!0).map((e=>(0,r.ensureNotNull)(s.model().dataSourceForId(e))));s.selectionMacro((e=>{e.clearSelection();let t=null;o.forEach((s=>{null===t&&(t=Vt(i,s)),e.addSourceToSelection(s,t)}))}));const n=new O.Point(e.localX,e.localY),a=(0,r.ensureNotNull)(o[0].priceScale()),c=(0,r.ensureNotNull)(this.state().mainDataSource()).firstValue(),h={index:s.timeScale().coordinateToIndex(e.localX),price:a.coordinateToPrice(e.localY,(0,r.ensureNotNull)(c))};s.startMovingSources(o,{logical:h,screen:n},null,t),this._clonningAtMoveLineTools=null,this._startCloningPoint=null}return!0}return!1}_mouseDownEventForLineTool(e,t,i,s){var o,n;const a=K.tool.value();if(!this.hasState()||(0,E.isLineToolDrawWithoutPoints)(a))return;const l=this._chartUndoModel();let c=!1,h=null;(0,K.hideAllDrawings)().value()&&(0,W.toggleHideMode)(),(0,K.lockDrawings)().setValue(!1),e.isTouch&&!e.stylus&&((0,E.isLineToolName)(a)&&!(0,E.isLineDrawnWithPressedButton)(a)||l.lineBeingCreated())&&this._initToolCreationModeParams(e);const d=l.lineBeingCreated();if(d&&!(0,E.isLineDrawnWithPressedButton)(d.toolname)){const a=(0,r.ensure)(null===(o=d.ownerSource())||void 0===o?void 0:o.firstValue());if(e.isTouch&&!e.stylus){if(!this._startTouchPoint){this._startTouchPoint=new O.Point(e.pageX,e.pageY);const t=d.points(),i=t[t.length-1],s=l.timeScale().indexToCoordinate(i.index),o=(0,r.ensureNotNull)(d.priceScale()).priceToCoordinate(i.price,a);return void(this._initCrossHairPosition=new O.Point(s,o))}}else if(!e.isTouch){h=d
;const o=l.model().paneForSource(d);if(o!==this._state&&null!==o){const i=this._externalPaneXCoord(o,e.localX),s=this._externalPaneYCoord(o,e.localY);c=l.continueCreatingLine({index:Math.round(l.timeScale().coordinateToIndex(i)),price:(0,r.ensure)(null===(n=d.priceScale())||void 0===n?void 0:n.coordinateToPrice(s,a))},t)}else{const e=l.model().magnet().align(s,i,this.state());c=l.continueCreatingLine({index:i,price:e},t)}}}else if(!e.isTouch||e.stylus||(0,E.isLineDrawnWithPressedButton)(a)){const e={index:i,price:l.model().magnet().align(s,i,this.state())};h=l.createLineTool({pane:this.state(),point:e,linetool:a}),l.lineBeingCreated()||(c=!0)}const u=this._dataSourceAtPoint(e.localX,e.localY);h&&l.selectionMacro((e=>{e.addSourceToSelection((0,r.ensureNotNull)(h),null==u?void 0:u.hittest.data())})),c&&h&&(this._finishTool(h,u),e.preventDefault())}_handleSelectionMouseDownAndGetJustDeselectedSource(e,t,i){const s=this._chartUndoModel();let r=null;return(null===t||t.source.isSelectionEnabled())&&s.selectionMacro((s=>{!this._preventSourceChange&&null!==t&&(e.isTouch?t.hittest.target()>=G.HitTarget.MovePointBackground:t.hittest.target()>G.HitTarget.MovePointBackground)?(i.mod()||s.selection().isSelected(t.source)||s.clearSelection(),i.mod()&&s.selection().isSelected(t.source)?(r=t.source,s.removeSourceFromSelection(t.source)):s.addSourceToSelection(t.source,t.hittest.data()),s.selection().allSources().length>1&&(0,ye.trackEvent)("GUI","Multiselect","Click Select")):i.mod()||s.clearSelection()})),r}_processMouseMoveWhileZoom(e,t){this._preventCrossHairMove()||this._setCursorPosition(e.localX,e.localY,t)}_updateCommonTooltip(e,t){let i=null;if(null!==e&&null!==e.hittest){const t=e.hittest.data();t&&(i=t.tooltip||null)}if(null===this._prevTooltipData&&null===i)return;if(null===i||""===i.text)return this._prevTooltipData=null,void(0,gt.hide)(t);if(this._prevTooltipData&&(0,N.default)(i,this._prevTooltipData))return;this._prevTooltipData=i;const s=(0,S.clone)(i);if(void 0!==s.rect){const e=this._paneCell.getBoundingClientRect();s.rect.x+=e.left,s.rect.y+=e.top}(0,gt.show)(s)}_setCursorPositionOnExternalPane(e,t,i,s){t=this._externalPaneXCoord(e,t),i=this._externalPaneYCoord(e,i);this._chart.paneByState(e)._setCursorPosition(t,i,s)}_setCursorPosition(e,t,i){this._updateLastCrosshairPosition(e,t,i),this._chartModel().setAndSaveCurrentPosition(this._correctXCoord(e),this._correctYCoord(t),this.state(),i)}_updateLastCrosshairPosition(e,t,i){const s=this.state().id();Ht={x:e,y:t,envState:i,stateId:s}}_setCursorClassName(e){let t="";e&&(t="pane--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._paneCell.classList.remove(this._currentCursorClassName),t&&this._paneCell.classList.add(t),this._currentCursorClassName=t,this._paneCell.style.cursor)}_processMouseUpOrTouchEndHandler(e){const t=this._dataSourceAtPoint(e.localX,e.localY);null!==t&&t.hittest.tryCallMouseUpOrTouchEndHandler(e)}_crossHairShouldBeVisible(){const e=this._chartModel().crossHairSource();return(0,E.isLineToolName)(K.tool.value())||(0,
K.toolIsMeasure)(K.tool.value())||e.startMeasurePoint()&&!e.endMeasurePoint()||null!==this._firstZoomPoint||null!==this._chartModel().lineBeingEdited()||null!==this._chartModel().lineBeingCreated()}_clearCursorPosition(){Ht=null,this._chartModel().clearCurrentPosition()}_dataSourceAtPoint(e,t){if(!this.hasState())return null;const i={result:null},s=this._chartUndoModel();if((0,E.isLineToolName)(K.tool.value())||null!==s.lineBeingCreated())return i.result;if(this._currentChangingLineToolHitTest)return this._currentChangingLineToolHitTest;if(this._currentMovingHitTest)return this._currentMovingHitTest;const r=this.state(),o=r.height(),n=r.width();this._makeSureIsUpdated();const a=Ot.bind(null,i),l=this._canvasRenderParams(),c=new O.Point(e,t);if(!this.state().maximized().value()&&this.state().collapsed().value()||(0,H.lastMouseOrTouchEventInfo)().isTouch&&(K.activePointSelectionMode.value()!==K.SelectPointMode.None||null!==this._startTrackPoint))return this._hitTestSources(l,[s.crossHairSource()],c,a,!1),i.result;const h=r.sourcesByGroup(),d=s.selection();this._hitTestSources(l,d.dataSources(),c,a,!1),this._hitTestSources(l,d.customSources(),c,a,!0);const u=new Set(d.allSources().map((e=>e.id())));this._hitTestSources(l,[s.crossHairSource()],c,a,!1,u),this._hitTestSources(l,r.customSources(q.CustomSourceLayer.Topmost),c,a,!0,u),this._hitTestSources(l,h.tradingSources(),c,a,!1,u),this._hitTestSources(l,r.customSources(q.CustomSourceLayer.Foreground),c,a,!0,u);const _=[...this._chartModel().multiPaneSources(r),...h.hitTestSources()];if(this._hitTestSources(l,_,c,a,!1,u),this.containsMainSeries()){const e=s.activeStrategySource().value();if(null!==e){const t=e.strategyOrdersPaneView();if(null!==t){const s=t.renderer(o,n);if(null!==s){const t=s.hitTest(c,l);t&&Ot(i,t,e,s,!1)}}}}return null===i.result&&this._hitTestSources(l,r.customSources(q.CustomSourceLayer.Background),c,a,!0,u),i.result}_hitTestSources(e,t,i,s,o,n){const a=(0,r.ensureNotNull)(this._state),l=a.height(),c=a.width();for(let r=t.length-1;r>=0;--r){const h=t[r];if(void 0!==n&&n.has(h.id()))continue;const d=h.paneViews(a);if(null!==d&&0!==d.length)for(let t=d.length-1;t>=0;--t){const r=d[t].renderer(l,c);if(r&&r.hitTest){const t=r.hitTest(i,e);null!==t&&s(t,h,r,o)}}}}_tryStartMovingLineTool(e,t,i,s){var o;if(null===t.source||!t.source.movable()||null!==this._startTrackPoint)return!1;if(!this._preventSourceChange){const n=this._chartUndoModel(),a=(0,r.ensureNotNull)((0,r.ensureNotNull)(this._state).mainDataSource()).firstValue(),l=(0,r.ensureNotNull)(t.source.priceScale()).coordinateToPrice(e.localY,(0,r.ensureNotNull)(a));let c=(t.source.isSelectionEnabled()?n.selection().allSources():[t.source]).filter(bt);const h=c.filter(A.isLineTool);c=h.length>0?h:c.includes(t.source)?[t.source]:[c[0]];const d=new O.Point(e.localX,e.localY),u={index:s,price:l},_=null===(o=t.hittest.data())||void 0===o?void 0:o.activeItem;return this._startMoveSourceParams={source:c,startPoint:{logical:u,screen:d},activeItem:void 0===_?null:_,envState:i},!0}
return this._startMoveSourceParams=null,!1}_chartModel(){return this._chart.model().model()}_chartUndoModel(){return this._chart.model()}_externalPaneXCoord(e,t){t+=this._div.getBoundingClientRect().left+document.body.scrollLeft;const i=(0,r.ensureNotNull)(this._chart.paneByState(e)),s=i._div.getBoundingClientRect().left+document.body.scrollLeft;return i._correctXCoord(t-s)}_externalPaneYCoord(e,t){t+=this._div.getBoundingClientRect().top+document.body.scrollTop;const i=(0,r.ensureNotNull)(this._chart.paneByState(e)),s=i._div.getBoundingClientRect().top+document.body.scrollTop;return i._correctYCoord(t-s)}_correctXCoord(e){return Math.max(0,Math.min(e,this._size.width-1))}_correctYCoord(e){return Math.max(0,Math.min(e,this._size.height-1))}_processScroll(e){if(!this._chart.model().model().scrollEnabled())return;const t=performance.now();this._startScrollingPos||this._preventScroll()||(this._startScrollingPos={x:e.clientX,y:e.clientY,timestamp:t,localX:e.localX,localY:e.localY});const i=this._chartUndoModel(),s=this._chartModel().timeScale();let r=this.state().defaultPriceScale();if(this._startScrollingPos&&!this._isScrolling&&(this._startScrollingPos.x!==e.clientX||this._startScrollingPos.y!==e.clientY)){if(i.beginUndoMacro(It,!0),null===this._scrollXAnimation&&this._options.useKineticScroll){const e=s.barSpacing();this._scrollXAnimation=new ot.KineticAnimation(.2/e,7/e,.997,15/e),this._scrollXAnimation.addPosition(s.rightOffset(),this._startScrollingPos.timestamp)}return i.selection().isEmpty()||(r=i.selection().allSources()[0].priceScale()),null===r||r.isEmpty()||(this._scrollPriceScale=r,i.startScrollPrice(this.state(),r,e.localY)),i.startScrollTime(e.localX),this._isScrolling=!0,this.setCursorForTool(),void this._paneWidgetsSharedState.setScrollingPane(this)}this._isScrolling&&(null!==this._scrollPriceScale&&i.scrollPriceTo(this.state(),this._scrollPriceScale,e.localY),i.scrollTimeTo(e.localX),null!==this._scrollXAnimation&&this._scrollXAnimation.addPosition(s.rightOffset(),t))}_finishScroll(){const e=this._chartUndoModel();e.endScrollTime(),null!==this._scrollPriceScale&&e.endScrollPrice(this.state(),this._scrollPriceScale),e.endUndoMacro(),this._isScrolling=!1,this._startScrollingPos=null,this._scrollPriceScale=null,this.setCursorForTool(),this._paneWidgetsSharedState.setScrollingPane(null)}_endScroll(e){if(!this._isScrolling)return!1;this._finishScroll();const t=this._scrollUndoCommandInStack(),i=performance.now(),s=this._chartUndoModel().timeScale();return null!==this._scrollXAnimation&&(this._scrollXAnimation.start(s.rightOffset(),i),this._scrollXAnimation.finished(i)||(this._chartModel().setTimeScaleAnimation(this._scrollXAnimation),this._scrollXAnimation=null)),t}_preventScroll(){return this._trackCrosshairOnlyAfterLongTap&&this._longTap||this._contextMenuOpenedOnLastTap||(0,E.isLineToolName)(K.tool.value())||Boolean(this._chartUndoModel().lineBeingCreated())||null!==this._startTrackPoint}_isSelectPointModeEnabled(){
return this._chartUndoModel().crossHairSource().selectPointMode().value()!==K.SelectPointMode.None}_preventCrossHairMove(){return!!this._trackCrosshairOnlyAfterLongTap&&(null===this._chart.trackingModePaneWidget()&&(!!this._contextMenuOpenedOnLastTap||!this._crossHairShouldBeVisible()&&null===this._startTrackPoint))}_finishTool(e,t=null){const i=this._chartUndoModel(),s=e.toolname;if(s===K.tool.value()&&(0,K.resetToCursor)(),this._preventCrossHairMove()&&this._clearCursorPosition(),i.selectionMacro((i=>{i.addSourceToSelection(e,Vt(t,e))})),(0,E.isTextToolName)(s)){const t=i.createUndoCheckpoint();this._chart.showChartPropertiesForSource(e,pt.TabNames.text,void 0,t).then((e=>{if("LineToolText"===s){const t=!Boolean(c.getBool("hint.pasteText"));null!==e&&t&&e.visible().subscribe((()=>{(0,ut.showPasteLineToolHint)(this._chart.chartWidgetCollection().getContainer(),"hint.pasteText")}),{once:!0})}}))}this._lastFinishedToolId=e.id(),(0,u.emit)("drawing_event",e.id(),"create"),(0,_t.trackDrawingCreated)(e)}_alignSourcesThatBeingMoved(e,t,i,s){const r=this._chartUndoModel(),o=r.timeScale().coordinateToIndex(t);r.model().sourcesBeingMoved().forEach((e=>{var n;let a=o,l=e.convertYCoordinateToPriceForMoving(i,this.state().mainDataSource());if(null!==l){if((0,D.isStudy)(e)){const e=r.mainSeries(),t=e.bars().firstIndex(),i=e.bars().lastIndex();null!==t&&null!==i&&(a=Math.min(Math.max(o,t),i)),l=this._chartModel().magnet().align(l,o,this.state())}null!==this._currentMovingHitTest&&void 0!==(null===(n=this._currentMovingHitTest.hittest.data())||void 0===n?void 0:n.cursorType)||this.setCursorForTool(),r.moveSources({screen:new O.Point(t,i),logical:{index:a,price:l}},s)}}))}_resetMeasureIfRequired(){this._needResetMeasureLater&&((0,K.resetToCursor)(),this._needResetMeasureLater=!1)}_makeSureIsUpdated(){var e;const t=this.state(),i=[...t.dataSources(),...t.customSources()],s=t.height(),r=t.width();for(const o of i){const i=o.paneViews(t);if(null!==i)for(const t of i)null===(e=t.makeSureIsUpdated)||void 0===e||e.call(t,s,r)}}_drawBackground(e,t){const i=Math.ceil(t.pixelRatio*this._size.width),s=Math.ceil(t.pixelRatio*this._size.height),r=this._chartModel(),o=r.backgroundTopColor().value(),n=r.backgroundColor().value();o===n?(0,Z.clearRect)(e,0,0,i+1,s+1,n):(0,Q.clearRectWithGradient)(e,0,0,i+1,s+1,o,n)}_drawWatermark(e,t){const i=this._chartModel().watermarkSource();if(null===i)return;const s=this.state();if(!s.containsMainSeries())return;const r=i.paneViews(),o=s.height(),n=s.width();for(const i of r){e.save();const s=i.renderer(o,n);s&&s.draw(e,t),e.restore()}}_drawCrossHair(e,t){const i=this._chartUndoModel().crossHairSource();i.invalidateLockPosition(),i.visible||null===K.crosshairLock.value()||i.updateAllViews((0,Ct.sourceChangeEvent)(i.id())),this._drawSourceImpl(e,t,Dt,Et,i)}_drawActiveLineTools(e,t){const i=this._chartModel(),s=[i.lineBeingCreated(),i.lineBeingEdited(),...i.sourcesBeingMoved(),i.customSourceBeingMoved()].filter((e=>!!e));for(const r of s){(i.paneForSource(r)===this.state()||(0,
Y.isDataSource)(r)&&r.isMultiPaneEnabled())&&this._drawSourceImpl(e,t,Dt,Et,r)}}_drawSeriesTopViews(e,t){this.state().containsMainSeries()&&this._drawSourceImpl(e,t,Bt,Et,this._chartUndoModel().mainSeries())}_drawSources(e,t){const i=this.state(),s=i.model(),r=i.sourcesByGroup(),o=r.tradingSources(),n=[...s.multiPaneSources(i),...r.generalSources()],a=r.phantomSources(),l=i.customSources(q.CustomSourceLayer.Background).slice(),c=i.customSources(q.CustomSourceLayer.Foreground).slice(),h=i.customSources(q.CustomSourceLayer.Topmost).slice();this._drawSourceImpl(e,t,Dt,Et,s.gridSource()),this._drawWatermark(e,t);for(const i of l)this._drawSourceImpl(e,t,Dt,At,i);for(const i of n)this._drawSourceImpl(e,t,Dt,At,i);for(const i of c)this._drawSourceImpl(e,t,Dt,At,i);for(const i of a)this._drawSourceImpl(e,t,Dt,At,i);const d=new Set;[s.lineBeingCreated(),s.lineBeingEdited(),...s.sourcesBeingMoved(),s.customSourceBeingMoved()].filter(S.notNull).forEach((e=>d.add(e.id())));let u=s.hoveredSource();null!==u&&((0,Y.isDataSource)(u)&&!u.showOnTopOnHovering()||d.has(u.id())||(0,Y.isDataSource)(u)&&!n.includes(u)?u=null:d.add(u.id()));const _=s.selection().allSources().filter((e=>!((0,Y.isDataSource)(e)&&!n.includes(e))&&!d.has(e.id())));_.forEach((e=>d.add(e.id())));{for(const i of l)this._drawSourceImpl(e,t,Dt,Et,i,d);for(const i of n)this._drawSourceImpl(e,t,Dt,Et,i,d);for(const i of c)this._drawSourceImpl(e,t,Dt,Et,i,d);const i=s.activeStrategySource().value();i&&this.containsMainSeries()&&this._drawSourceImpl(e,t,Nt,Et,i)}for(const i of o)this._drawSourceImpl(e,t,Dt,At,i);for(const i of h)this._drawSourceImpl(e,t,Dt,At,i);for(const i of n)this._drawSourceImpl(e,t,Rt,Et,i,d);for(const i of c)this._drawSourceImpl(e,t,Rt,Et,i,d);for(const i of o)this._drawSourceImpl(e,t,Dt,Et,i,d);for(const i of h)this._drawSourceImpl(e,t,Dt,Et,i,d);for(const i of _)this._drawSourceImpl(e,t,Dt,Et,i);for(const i of _)this._drawSourceImpl(e,t,Rt,Et,i);u&&(this._drawSourceImpl(e,t,Dt,Et,u),this._drawSourceImpl(e,t,Rt,Et,u));for(const i of a)this._drawSourceImpl(e,t,Dt,Et,i,d)}_drawSourceImpl(e,t,i,s,r,o){if(o&&o.has(r.id()))return;const n=this.state(),a=n.height(),l=n.width(),c=i(r,this.state());if(c)for(const i of c){const r=i.renderer(a,l);r&&(e.save(),s(r,e,t),e.restore())}}_updateByThemedColors(){null!==this._legendWidget&&this._legendWidget.updateThemedColors(this._themedTopColor),null!==this._paneControls&&this._paneControls.updateThemedColors(this._themedTopColor)}_scrollUndoCommandInStack(){const e=this._chartUndoModel().undoHistory().undoStack();if(e.isEmpty())return!1;const t=e.head();if(!(t instanceof X.UndoMacroCommand))return!1;if(t.isEmpty())return!1;const i=t.commands()[0];return i instanceof at.PriceScaleChangeUndoCommand||i instanceof nt.TimeScaleChangeUndoCommand}_onStateDestroyed(){this.setState(null)}_onDataSourcesCollectionChanged(){this._startMoveSourceParams=null}_processMouseEnterLeaveMoveHandlers(e,t){var i,s,r,o
;null===this._prevHoveredHittest||this._prevHoveredHittest.renderer===(null==e?void 0:e.renderer)&&(null===(i=this._prevHoveredHittest.hittest.data())||void 0===i?void 0:i.activeItem)===(null===(s=e.hittest.data())||void 0===s?void 0:s.activeItem)||((0,G.tryCallHandler)(t,null===(r=this._prevHoveredHittest.hittest.data())||void 0===r?void 0:r.mouseLeaveHandler),this._prevHoveredHittest=null),t.isTouch||null!==e&&((null===(o=this._prevHoveredHittest)||void 0===o?void 0:o.renderer)!==e.renderer&&(e.hittest.tryCallMouseEnterHandler(t),this._prevHoveredHittest=e),e.hittest.tryCallMouseMoveHandler(t))}_startChangeOrMoveLineToolIfNeeded(){if(null!==this._startChangeLineToolParams){const e=this._startChangeLineToolParams;this._chartUndoModel().startChangingLinetool(e.source,e.startPoint,e.pointIndex,e.envState)}if(null!==this._startMoveSourceParams){const e=this._startMoveSourceParams;this._chartUndoModel().startMovingSources(e.source,e.startPoint,e.activeItem,e.envState)}this._startMoveSourceParams=null,this._startChangeLineToolParams=null}_trackingModeShouldBeActive(){return!(!this._trackCrosshairOnlyAfterLongTap||this._contextMenuOpenedOnLastTap||this._crossHairShouldBeVisible())&&this._longTap}_processOutsideClick(e,t){var i;let s=null;const r=this._chartModel();if(null!==e&&(s=e.isCustom?r.customSourceName(e.source):e.source.id()),null!==this._lastClickedSource&&this._lastClickedSource.id!==s){const e=this._lastClickedSource.id;let i=this._lastClickedSource.isCustom?r.customSourceForName(e):r.dataSourceForId(e);null!==i||this._lastClickedSource.isCustom||(i=r.dataSourceForId(e)),null!==i&&i.onClickOutside&&(i.onClickOutside(t),this._chartModel().updateSource(i))}this._lastClickedSource=null!==s?{id:s,isCustom:null!==(i=null==e?void 0:e.isCustom)&&void 0!==i&&i}:null}_mouseClickOrTapEvent(e){var t;if(!this.hasState())return;const i=this._dataSourceAtPoint(e.localX,e.localY),s=i&&i.source,o=this._chartUndoModel(),n=Boolean(null===(t=null==i?void 0:i.hittest.data())||void 0===t?void 0:t.hideCrosshairLinesOnHover);this._processOutsideClick(i,e),!this._isSelectPointModeEnabled()||n||e.isTouch&&this.trackingModeEnabled()&&!this._exitTrackingModeOnNextTry||o.crossHairSource().trySelectCurrentPoint(),null!==i&&i.hittest.tryCallClickOrTapHandler(e)&&o.model().updateSource((0,r.ensureNotNull)(s)),!e.isTouch||this._isSelectPointModeEnabled()||i&&i.source===o.crossHairSource()||this._tryExitTrackingMode(),s&&(0,A.isLineTool)(s)&&this._lastFinishedToolId!==s.id()&&(0,u.emit)("drawing_event",s.id(),"click"),this._resetMeasureIfRequired()}_mouseDownOrTouchStartEvent(e,t){var i,s,o,n,a;if(this._pressedMoveStage=1,e.isTouch&&(this._longTap=!1,this._exitTrackingModeOnNextTry=null!==this._startTrackPoint,this._paneWidgetsSharedState.clearDraggingSource()),this._contextMenuOpenedOnLastTap=!1,this._lastFinishedToolId=null,this._chartModel().stopTimeScaleAnimation(),e.isTouch&&this._switchTrackingModeFromAnotherPaneIfNeeded(e),
document.activeElement!==document.body&&document.activeElement!==document.documentElement)document.activeElement&&document.activeElement.blur?document.activeElement.blur():document.body.focus();else{const e=document.getSelection();null!==e&&e.removeAllRanges()}(0,u.emit)("mouse_down",{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY}),this._updateCommonTooltip(null);const l=this._chartUndoModel(),c=new j.EnvironmentState(e);l.mainSeries().clearGotoDateResult();const h=this.state().defaultPriceScale();if(h.isEmpty()||l.timeScale().isEmpty())return;const d=l.crossHairSource();if(!e.isTouch&&!(0,E.isLineDrawnWithPressedButton)(K.tool.value())){const t=l.lineBeingCreated(),i=null!==t?l.model().paneForSource(t):null;null!==i&&i!==this._state?this._setCursorPositionOnExternalPane(i,e.localX,e.localY,c):this._setCursorPosition(e.localX,e.localY,c)}e.isTouch&&(0,E.isLineToolName)(K.tool.value())&&((0,E.isLineDrawnWithPressedButton)(K.tool.value())||null!==d.pane?(0,E.isLineDrawnWithPressedButton)(K.tool.value())&&this._clearCursorPosition():this._chart.updateCrossHairPositionIfNeeded());const _=(0,r.ensureNotNull)(this.state().mainDataSource()).firstValue();if(null===_)return void(this._chart.readOnly()||(this._handleSelectionMouseDownAndGetJustDeselectedSource(e,t,c),null!==t&&(0,lt.isPriceDataSource)(t.source)&&t.source.isDraggable()&&this._paneWidgetsSharedState.trySetDraggingSource(t.source,this)));let p=h.coordinateToPrice(e.localY,_),m=this._chartModel().timeScale().coordinateToIndex(e.localX);if(d.startMeasurePoint()&&d.endMeasurePoint()&&d.clearMeasure(),c.shift()&&(null===t||!(null===(s=null===(i=t.hittest.data())||void 0===i?void 0:i.hasOwnShortcutsBehaviourFor)||void 0===s?void 0:s.shiftKey))&&(0,K.toolIsCursor)(K.tool.value())&&l.selection().isEmpty()&&K.tool.setValue("measure"),(e.isTouch&&!e.stylus||!this._tryStartMeasure(e,d,c,p,m))&&(e.isTouch&&!e.stylus||!this._tryFinishMeasure(e,d))&&!this._tryFinishZoom(e)&&!this._tryStartZoom(e,p,m,c)){if(e.isTouch&&(null!==this._startTrackPoint?(this._initCrossHairPosition=d.currentPoint(),this._startTrackPoint=new O.Point(e.localX,e.localY)):this._isSelectPointModeEnabled()&&null===this._chart.trackingModePaneWidget()&&this.startTrackingMode(new O.Point(e.localX,e.localY),new O.Point(e.localX,e.localY),new j.EnvironmentState(e))),e.isTouch&&(this._preventSourceChange=null===t||!l.selection().isSelected(t.source)),!this._isSelectPointModeEnabled()&&!this._isScrolling){if(e.isTouch&&!e.stylus&&((0,K.toolIsMeasure)(K.tool.value())||null!==d.measurePane().value()))return void this._initToolCreationModeParams(e);if((0,E.isLineToolName)(K.tool.value())||l.lineBeingCreated())return c.shift()||l.selectionMacro((e=>e.clearSelection())),void this._mouseDownEventForLineTool(e,c,m,p)}if(null!==t&&t.hittest.tryCallMouseDownOrTouchStartHandler(e),!this._chart.readOnly()){const i=this._handleSelectionMouseDownAndGetJustDeselectedSource(e,t,c);if(null!==t&&!this._preventSourceChange){const i=t.hittest.data();if(t.isCustom){
if(t.hittest.hasPressedMoveHandler(e))return l.model().setMovingCustomSource(t.source,i),this._currentMovingHitTest=t,void l.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection((0,r.ensureNotNull)(t.source),(0,r.ensureNotNull)(i))}))}else if((null==i?void 0:i.areaName)===G.AreaName.SourceItemMove){const s=null==i?void 0:i.activeItem;if(void 0!==s)return l.startCustomMoving(t.source,s,e),this._currentMovingHitTest=t,void l.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection((0,r.ensureNotNull)(t.source),(0,r.ensureNotNull)(i))}))}}if(null!==t&&this._tryHandleEraserMouseDown(t,c))return;const s=null!==t&&(0,A.isLineTool)(t.source)&&t.source.isLocked&&t.source.isLocked();if(!((0,K.lockDrawings)().value()||s)&&null!==t&&!t.isCustom){if(!t.source.userEditEnabled())return;const s=null===(o=t.hittest.data())||void 0===o?void 0:o.snappingPrice,l=null===(n=t.hittest.data())||void 0===n?void 0:n.snappingIndex;let h=e.localY,d=e.localX;if(void 0!==s&&(h=(0,r.ensure)(null===(a=t.source)||void 0===a?void 0:a.priceScale()).priceToCoordinate(s,_),p=s),void 0!==l&&(d=this._chartModel().timeScale().indexToCoordinate(l),m=l),h===e.localY&&d===e.localX||(e={...e,localY:h,localX:d},this._setCursorPosition(e.localX,e.localY,c)),this._tryStartChangingLineTool(e,t,c,m))return void(this._currentChangingLineToolHitTest=t);if(this._currentChangingLineToolHitTest=null,(g=t.hittest.target())===G.HitTarget.MovePoint||g===G.HitTarget.MovePointBackground&&(0,H.lastMouseOrTouchEventInfo)().isTouch){if(this._tryStartCloning(e,t,c,i))return;if(this._tryStartMovingLineTool(e,t,c,m))return void(this._currentMovingHitTest=t);this._currentMovingHitTest=null}}if(null!==t&&(0,lt.isPriceDataSource)(t.source)&&t.source.isDraggable()&&this._paneWidgetsSharedState.trySetDraggingSource(t.source,this))return}var g;null!==t&&t.hittest.target()===G.HitTarget.Regular||(this._processing=!0)}}_mouseUpOrTouchEndEvent(e){var t,i;if(!this.hasState())return;this._pressedMoveStage=0;const s=e.isTouch&&null!==this._startTrackPoint,o=e.isTouch&&this._wasPinched;e.isTouch&&(this._wasPinched=!1,this._longTap=!1),this._startMoveSourceParams=null,this._startChangeLineToolParams=null,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null;const n=this._chartUndoModel(),a=n.model().customSourceMovingHitTestData();null!==a||n.customMoveBeingProcessed()||this._processMouseUpOrTouchEndHandler(e),this._isSelecting=!1;const l=n.model(),c=l.crossHairSource(),h=this._dataSourceAtPoint(e.localX,e.localY);if(c.selection()&&null===this._firstZoomPoint){const e=this.state().lineToolsForArea(c.selection());n.selectionMacro((t=>{let i=null;e.forEach((e=>{null===i&&(i=Vt(h,e)),t.addSourceToSelection(e,i)}))})),c.clearSelection(),(0,ye.trackEvent)("GUI","Multiselect","Area Select")}(0,u.emit)("mouse_up",{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY});const d=e.isTouch&&this._touchMove;e.isTouch&&(this._touchMove=!1);const _=new j.EnvironmentState(e),p=K.tool.value();if(e.isTouch&&((0,
K.toolIsMeasure)(p)||null!==c.measurePane().value())){if(!d&&!e.stylus&&null===c.measurePane().value()&&c.pane!==this._state)return void this._setCursorPosition(e.localX,e.localY);if(!d&&!e.stylus&&this._tryStartMeasure(e,c,_,c.price,c.index))return;if((!d||e.stylus)&&this._tryFinishMeasure(e,c))return}if(e.isTouch&&!d&&!(0,E.isLineDrawnWithPressedButton)(p)&&(0,E.isLineToolName)(p)&&!n.lineBeingCreated()){if(this._chart.justActivated())return;if(c.pane!==this._state)return void this._setCursorPosition(e.localX,e.localY,_);const i=c.currentPoint(),s=this.state().defaultPriceScale(),o=(0,r.ensure)(null===(t=this.state().mainDataSource())||void 0===t?void 0:t.firstValue()),a={index:Math.round(n.timeScale().coordinateToIndex(i.x)),price:s.coordinateToPrice(i.y,o)},l=(0,r.ensureNotNull)(n.createLineTool({pane:this.state(),point:a,linetool:p}));return n.selectionMacro((e=>{e.addSourceToSelection(l)})),n.lineBeingCreated()||(this._finishTool(l,h),e.preventDefault()),void(this._startTouchPoint=null)}const m=n.lineBeingCreated();if(m&&!(0,E.isLineDrawnWithPressedButton)(m.toolname)&&e.isTouch&&(this._startTouchPoint||e.stylus)){if(this._startTouchPoint=null,!d||e.stylus){const t=m.points()[m.points().length-1],i=n.continueCreatingLine({index:t.index,price:t.price},new j.EnvironmentState(e));this._initCrossHairPosition=null,i&&(this._finishTool(m,h),e.preventDefault())}return}if(null!==this._firstZoomPoint&&this._firstZoomPoint.draggingMode)return void this._finishZoom(e);if(this._processing=!1,n.customMoveBeingProcessed())return void n.endCustomMoving();if(null!==a&&(a.beingMoved&&((0,G.tryCallHandler)(e,a.mouseUpHandler,a.touchEndHandler),this.setCursorForTool()),l.setMovingCustomSource(null,null),Ut(e,a)))return;if(l.lineBeingEdited())return n.endChangingLinetool(!1),void(this._preventCrossHairMove()&&this._clearCursorPosition());if((0,E.isLineDrawnWithPressedButton)(p)&&!this._isSelectPointModeEnabled()){const t=n.lineBeingCreated();null!==t&&((0,_t.trackDrawingCreated)(t),t.finish());const s=this.state().defaultPriceScale();if(s.isEmpty())return;if(!t)return;const o=(0,r.ensure)(null===(i=t.ownerSource())||void 0===i?void 0:i.firstValue()),a=s.coordinateToPrice(e.localY,o),l={index:Math.round(n.timeScale().coordinateToIndex(e.localX)),price:a};return void n.continueCreatingLine(l)}if(l.sourcesBeingMoved().length)return n.endMovingSource(!1,!1),l.sourcesBeingMoved().filter(A.isLineTool).forEach((e=>{this.setCursorForTool(e)})),void l.invalidate(R.InvalidationMask.cursor());if(!this._chart.readOnly()){const t=e.localX>=0&&e.localX<this._size.width;if((!h||h.source!==c)&&t){const t=n.timeScale().coordinateToIndex(e.localX);l.onSyncScrollNeeded(t)}}const g=this._isScrolling,S=this._endScroll(e),v=this._paneWidgetsSharedState.draggingSource();if(null!==v){const t=e.target,i=this._chart.paneByCanvas(t);i&&i!==this&&(S&&n.undoHistory().undo(),n.mergeToPane(v,i.state()));if(this._chart.timeAxisByCanvas(t))if(l.isUnmergeAvailableForSource(v))S&&n.undoHistory().undo(),n.unmergeToNewBottomPane(v);else{const e=l.panes(),t=(0,
r.ensureNotNull)(l.paneForSource(v)),i=e.indexOf(t);i!==e.length-1&&(S&&n.undoHistory().undo(),t.maximized().value()&&this._chart.toggleMaximizePane(null),n.movePane(i,e.length-1))}this._paneWidgetsSharedState.clearDraggingSource();const s=this._chart.getTimeScale();s&&s.restoreDefaultCursor();const o=this._chart.paneWidgets();for(let e=0;e<o.length;e++){const t=o[e];t===this&&h&&!h.isCustom?t.setCursorForTool(h.source||void 0):t.setCursorForTool(),t.leftPriceAxisesContainer().restoreDefaultCursor(),t.rightPriceAxisesContainer().restoreDefaultCursor()}}this._chart.readOnly()||s||_.mod()||g||o||null!==this._lastFinishedToolId||null!==h&&(h.hittest.target()>G.HitTarget.MovePointBackground||(0,H.lastMouseOrTouchEventInfo)().isTouch)&&n.selectionMacro((e=>{e.clearSelection();const t=(0,r.ensureNotNull)(h.source);e.addSourceToSelection(t,Vt(h,t))})),e.isTouch&&(this._touchMove=!1)}_mouseOrTouchMoveEvent(e){if(!this.hasState())return;this._resetMeasureIfRequired();const t=this._dataSourceAtPoint(e.localX,e.localY);this._processMouseEnterLeaveMoveHandlers(t,e);const i=this._chartUndoModel();if(!i)return;const s=e.localX,r=e.localY;this._prevMoveEventPosition=new O.Point(s,r);const o=new j.EnvironmentState(e);if(null===this._firstZoomPoint){if(this._updateHoveredSource(t,o,e),!e.isTouch&&i.lineBeingCreated()){const e=i.lineBeingCreated(),t=null===e?null:i.model().paneForSource(e);if(null!==t&&t!==this._state)return void this._setCursorPositionOnExternalPane(t,s,r,o)}e.isTouch||this._setCursorPosition(s,r,o)}else this._processMouseMoveWhileZoom(e,o)}_pressedMouseOrTouchMoveEvent(e){var t;if(!this.hasState()||this._pinching||e.isTouch&&this._contextMenuOpenedOnLastTap)return;this._pressedMoveStage=2,this._resetMeasureIfRequired(),this._startChangeOrMoveLineToolIfNeeded(),e.isTouch&&(this._touchMove=!0,this._preventSourceChange=!1);const i=new j.EnvironmentState(e),s=this._chartUndoModel(),o=s.crossHairSource(),n=e.localX,a=e.localY;if(this._prevMoveEventPosition=new O.Point(n,a),null!==this._firstZoomPoint)return this._processMouseMoveWhileZoom(e),void(this._firstZoomPoint.draggingMode=!0);const l=K.tool.value();if(e.isTouch&&this._startTouchPoint&&(0,E.isLineToolName)(l)&&!(0,E.isLineDrawnWithPressedButton)(l)&&!s.lineBeingCreated()&&!this._isSelectPointModeEnabled())return void this._updateCrosshairPositionInToolCreationMode(e,this.state());const c=o.measurePane().value();if(e.isTouch&&(this._startTouchPoint||e.stylus)&&((0,K.toolIsMeasure)(l)||null!==c))return void(e.stylus?this._setCursorPosition(e.localX,e.localY,new j.EnvironmentState(e)):this._updateCrosshairPositionInToolCreationMode(e,c||this.state()));const h=s.lineBeingCreated();if(e.isTouch&&!e.stylus&&h&&!(0,E.isLineDrawnWithPressedButton)(h.toolname)){if(this._startTouchPoint){const t=(0,r.ensureNotNull)(s.lineBeingCreated()),i=(0,r.ensureNotNull)(s.model().paneForSource(t));this._updateCrosshairPositionInToolCreationMode(e,i)}return}if(e.isTouch&&null!==this._startTrackPoint){this._exitTrackingModeOnNextTry=!1;const e=(0,
r.ensureNotNull)(this._initCrossHairPosition),t=new O.Point(n,a).subtract(this._startTrackPoint),s=e.add(t);this._setCursorPosition(s.x,s.y,i)}else e.isTouch&&this._preventCrossHairMove()||this._setCursorPosition(n,a,i);const d=this._isSelectPointModeEnabled();if((0,E.isLineToolName)(l)&&!(0,E.isLineDrawnWithPressedButton)(l)&&!d&&!i.mod())return;if((0,E.isLineDrawnWithPressedButton)(l)&&!d){const i=this.state().defaultPriceScale();if(i.isEmpty())return;const o=s.lineBeingCreated();if(!o)return;const n=new O.Point(e.localX,e.localY),a=(0,r.ensure)(null===(t=o.ownerSource())||void 0===t?void 0:t.firstValue());return n.price=i.coordinateToPrice(e.localY,a),n.index=Math.round(s.timeScale().coordinateToIndex(e.localX)),void s.continueCreatingLine(n)}if(null!==this._paneWidgetsSharedState.draggingSource()){const t=e.target,i=this._chart.paneByCanvas(t);i&&(i!==this?i.setDragToAnotherPaneCursor():i.setCursorForTool());const s=this._chart.timeAxisByCanvas(t);s&&s.setCursor("grabbing")}if(s.timeScale().isEmpty())return;const u=this._options.handleScroll;if((!u.pressedMouseMove||e.isTouch)&&(!u.horzTouchDrag&&!u.vertTouchDrag||!e.isTouch))return;if(s.customMoveBeingProcessed())return void s.processCustomMove(e);const _=s.model().customSourceMovingHitTestData();if(null!==_&&(this._updateCommonTooltip(null,!0),s.model().processingCustomSourceMove(),(0,G.tryCallHandler)(e,_.pressedMouseMoveHandler,_.touchMoveHandler),Ut(e,_)))return;if(s.model().lineBeingEdited())return void this._setCursorPosition(n,a,i);if(s.model().sourcesBeingMoved().length)return void this._alignSourcesThatBeingMoved(s.model().sourcesBeingMoved(),e.localX,e.localY,i);const p=this._dataSourceAtPoint(e.localX,e.localY);if(this._tryFinishClonning(e,new j.EnvironmentState(e),p))return;const m=(0,K.toolIsMeasure)(l)||o.startMeasurePoint()&&o.endMeasurePoint();this._chart.readOnly()||!i.mod()||(0,E.isLineToolName)(l)||m||d?(this._processScroll(e),this._preventScroll()&&!this._preventCrossHairMove()&&null===this._startTrackPoint&&this._setCursorPosition(e.localX,e.localY,new j.EnvironmentState(e))):this._isSelecting||(o.startSelection(this.state()),this._isSelecting=!0)}_mouseOrTouchLeaveEvent(e){var t;if(!this.hasState())return;const i=this._chartUndoModel();if(!i)return;const s=i.crossHairSource();e.isTouch||null!==s.measurePane().value()&&null===s.endMeasurePoint()||this._clearCursorPosition(),i.model().setHoveredSource(null,null),null!==this._prevHoveredHittest&&((0,G.tryCallHandler)(e,null===(t=this._prevHoveredHittest.hittest.data())||void 0===t?void 0:t.mouseLeaveHandler),this._prevHoveredHittest=null),this._updateCommonTooltip(null),this._chart.unsetActivePaneWidget()}_mouseDoubleClickOrDoubleTapEvent(e){if(!this.hasState())return;const t=!this._chart.readOnly()&&!(0,E.isLineToolName)(K.tool.value())&&this._dataSourceAtPoint(e.localX,e.localY)||null
;if(null!==t&&t.isCustom)t.hittest.tryCallDblClickOrDblTapHandler(e);else if(null!==t&&(e.isTouch||t.hittest.target()>G.HitTarget.MovePointBackground))this.processDoubleClickOnSource(t.source,t.hittest?t.hittest:void 0);else if(!this._chart.readOnly()&&!(0,E.isLineToolName)(K.tool.value())&&!this._chartUndoModel().lineBeingCreated()&&this._chartUndoModel().selection().isEmpty()){const t=this.state();new j.EnvironmentState(e).mod()&&!t.maximized().value()?(t.collapsed().value()||this._chartModel().paneCollapsingAvailable().value())&&this._chartUndoModel().toggleCollapsedPane(this.state()):this._chart.toggleMaximizePane(this)}}_contextMenuEvent(e){const t=this._chartUndoModel();if(t.crossHairSource().startMeasurePoint()&&!this._trackCrosshairOnlyAfterLongTap)return t.crossHairSource().clearMeasure(),void(0,K.resetToCursor)(!0);if(this._pinching)return;if(null===this._firstZoomPoint||this._trackCrosshairOnlyAfterLongTap||this.cancelZoom(),!(0,K.toolIsCursor)(K.tool.value())||this._isSelectPointModeEnabled()){if(e.isTouch)return;return(0,K.resetToCursor)(!0),this.setCursorForTool(),void(t.lineBeingCreated()&&t.cancelCreatingLine())}if(!this._options.contextMenuEnabled)return;const i=this._dataSourceAtPoint(e.localX,e.localY),s=i?i.source:null;if(e.isTouch&&null!==this._startTrackPoint){if(this._preventSourceChange)return;this._clearCursorPosition()}e.isTouch&&(this._contextMenuOpenedOnLastTap=!0,this._startTrackPoint=null),this._contextMenuX=e.localX,this._contextMenuY=e.localY;const r=i&&i.hittest?i.hittest.target():0,o=r>=G.HitTarget.Regular||r>=G.HitTarget.MovePointBackground&&e.isTouch;this._chart.updateActions(),t.selectionMacro((t=>{null!==s&&o?t.selection().isSelected(s)||(t.clearSelection(),t.addSourceToSelection(s,Vt(i,s))):(this._options.contextMenu.general&&this._showContextMenu(e),t.clearSelection())})),null!==i&&o&&null!==s&&((0,Y.isDataSource)(s)&&s.hasContextMenu()?s.isSelectionEnabled()?this.showContextMenuForSelection(e):this.showContextMenuForSources([s],e):i.hittest.tryCallContextMenuHandler(e))}_onMouseEvent(){this._preventSourceChange=!1,this._startTrackPoint=null,this._trackCrosshairOnlyAfterLongTap=!1}_onTouchEvent(){this._trackCrosshairOnlyAfterLongTap=!0}_switchTrackingModeFromAnotherPaneIfNeeded(e){const t=this._chart.trackingModePaneWidget();if(null!==t&&t!==this){const i=this._chartModel().crossHairSource().currentPoint();t._exitTrackingModeOnNextTry=!0,t._tryExitTrackingMode(!0),this.startTrackingMode(new O.Point(e.localX,e.localY),new O.Point(i.x,e.localY),new j.EnvironmentState(e))}}_showContextMenu(e){const t=e=>e instanceof y.Separator,i=this._customActions(),s=this._initActions(e).filter((e=>null!==e));i.remove.forEach((e=>{for(let t=0;t<s.length;t++){const i=s[t];if(i instanceof y.Action&&i.getLabel()===e){s.splice(t,1);break}}}));const r=i.top.concat(s).concat(i.bottom);for(let e=r.length-1;e>0;e--)t(r[e])&&t(r[e-1])&&r.splice(e,1);r.length&&t(r[0])&&r.splice(0,1),r.length&&t(r[r.length-1])&&r.splice(r.length-1,1),ce.ContextMenuManager.showMenu(r,e,{statName:"ChartContextMenu"},{
menuName:"ChartContextMenu"})}_initActions(e){var t,i;const s=this._chart.actions(),o=[];if(this._chart.model().model().resetScalesAvailable().value()&&(o.push(s.chartReset),o.push(new y.Separator)),!this.state().isEmpty()&&Ee.enabled("datasource_copypaste")){const t=(0,De.createActionCopyPrice)(this.state(),e.localY),i=(0,De.createPasteAction)(this._chart,this.state());(t||i)&&(t&&o.push(t),i&&o.push(i),o.push(new y.Separator))}if(Ee.enabled("alerts")&&(o.length&&o.push(new y.Separator),(0,r.ensureNotNull)(this.state().mainDataSource()).alertCreationAvailable().value())){const t=(0,De.createActionAddAlert)(this._chart,{localY:e.localY,pane:this.state()});null!==t&&o.push(t)}this._options.contextMenu.mainSeriesTrade&&this.containsMainSeries()&&o.push((0,De.createActionTrade)(this._chart,this.state(),e)),o[o.length-1]instanceof y.Separator||o.push(new y.Separator);return Boolean(null===(t=window.widgetbar)||void 0===t?void 0:t.widget("watchlist"))&&s.addToWatchlist&&o.push(s.addToWatchlist),Ee.enabled("text_notes")&&o.push(s.addToTextNotes),o[o.length-1]instanceof y.Separator||o.push(new y.Separator),s.moveChartAction&&!s.moveChartAction.isDisabled()&&o.push(s.moveChartAction,new y.Separator),o.push(this._createLockTimeAxisAction(e)),o.push(new y.Separator),s.paneObjectTree&&o.push(s.paneObjectTree),!Ee.enabled("charting_library_base")&&s.applyColorTheme&&o.push(s.applyColorTheme),o[o.length-1]instanceof y.Separator||o.push(new y.Separator),this._chart.applyIndicatorsToAllChartsAvailable()&&(o.push(s.applyStudiesToAllCharts),o.push(new y.Separator)),o.push(s.paneRemoveAllDrawingTools),o.push(s.paneRemoveAllStudies),o.push(new y.Separator),(null===(i=window.pro)||void 0===i?void 0:i.hasPackage("mtp-mtpredictor"))&&this.state().containsMainSeries()&&o.push((0,De.createMTPredictorActions)(this._chart,this.state(),this._contextMenuX,this._contextMenuY),new y.Separator),Ee.enabled("show_chart_property_page")&&o.push(s.chartProperties),o[o.length-1]instanceof y.Separator&&o.pop(),o}_loadAndCreateLegendWidget(){Promise.all([i.e(29284),i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(26855),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(48450),i.e(22652),i.e(50690),i.e(26300),i.e(59255),i.e(10758),i.e(10395),i.e(745),i.e(37457),i.e(5093)]).then(i.bind(i,99503)).then((e=>{if(this._isDestroyed)return;const t=e.LegendWidget,i=(0,U.deepExtend)({},this._options.legendWidget);i.canShowSourceCode=!this._chart.onWidget()&&!h.CheckMobile.any(),i.readOnlyMode=i.readOnlyMode||this._chart.readOnly(),i.statusesWidgets={sourceStatusesEnabled:this._options.sourceStatusesWidgetEnabled,sourceStatuses:this._options.sourceStatusesWidget||{},marketStatusEnabled:this._options.marketStatusWidgetEnabled,dataUpdateModeEnabled:this._options.chartWarningWidgetEnabled,dataUpdateMode:this._options.chartWarningWidget||{},dataProblemEnabled:this._options.dataProblemWidgetEnabled};const s=(0,
v.combine)(((e,t)=>zt&&this._chart!==e&&!t),this._chart.chartWidgetCollection().activeChartWidget.weakReference(),this._chart.chartWidgetCollection().lock.crosshair.weakReference()),o=(0,v.combine)(((e,t)=>null!==e?e===this._state:(0,K.toolIsMeasure)(t)),this._chartModel().crossHairSource().measurePane().weakReference(),K.tool.weakReference());this._legendWidget=new t(this._chartUndoModel(),this,this._chart.backgroundTopTheme().spawnOwnership(),s.ownership(),this._visuallyCollapsed.spawnOwnership(),o.ownership(),i,{showContextMenuForSelection:this.showContextMenuForSelection.bind(this),showContextMenuForSources:this.showContextMenuForSources.bind(this),updateActions:this._chart.updateActions.bind(this._chart),showChartPropertiesForSource:this._chart.showChartPropertiesForSource.bind(this._chart),showGeneralChartProperties:this._chart.showGeneralChartProperties.bind(this._chart),showObjectsTreeDialog:this._chart.showObjectsTreeDialog.bind(this._chart)}),this._div.appendChild(this._legendWidget.getElement()),this._legendWidget.updateLayout(),this._legendWidget.updateWidgetModeBySize(this._size),this._legendWidget.updateThemedColors(this._themedTopColor);for(const e of Array.from(this._customLegendWidgetsFactoryMap.keys()))this._legendWidget.addCustomWidgetToLegend(e,(0,r.ensureDefined)(this._customLegendWidgetsFactoryMap.get(e)))}))}_loadAndCreatePaneControlsWidget(){Promise.all([Promise.all([i.e(29284),i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(26855),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(48450),i.e(22652),i.e(50690),i.e(26300),i.e(59255),i.e(10758),i.e(10395),i.e(745),i.e(37457),i.e(5093)]).then(i.bind(i,580723)),Promise.all([i.e(29284),i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(26855),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(48450),i.e(22652),i.e(50690),i.e(26300),i.e(59255),i.e(10758),i.e(10395),i.e(745),i.e(37457),i.e(5093)]).then(i.bind(i,159255))]).then((([e,t])=>{var i;if(this._isDestroyed)return;const s=e.PaneControlsWidget;this._paneControls=new s(this._chartUndoModel(),this,{backgroundThemeName:this._chart.backgroundTopTheme()},{toggleMaximizePane:this._chart.toggleMaximizePane.bind(this._chart)},this._div),this._paneControls.updateWidgetModeByWidth(this._size.width),this._paneControls.updateThemedColors(this._themedTopColor),this._paneControlsResizeObserver=new t.default(this._handleRestrictLegendWidth.bind(this)),this._paneControlsResizeObserver.observe(this._paneControls.getElement()),(null===(i=this._state)||void 0===i?void 0:i.collapsed().value())&&this._chartModel().fullUpdate()}))}_handleRestrictLegendWidth(e){if(null===this._legendWidget||null===this._paneControls)return;const t=e[e.length-1].contentRect.width,i=0===t?0:t+Pt+Tt;this._legendWidget.addMargin(i)}_onMagnetStateChanged(){
this._chart.isActive()&&(this._isSelectPointModeEnabled()||this._isToolActionActiveOnPane(!0))&&this._chartModel().crossHairSource().visible&&this._updateLineToolUsingMagnetOrShift()}_onShiftKeyStateChanged(){this._chart.isActive()&&this._isToolActionActiveOnPane(!1)&&this._chartModel().crossHairSource().visible&&this._updateLineToolUsingMagnetOrShift(j.EnvironmentState.create((0,ft.shiftPressed)().value()))}_isToolActionActiveOnPane(e){const t=this._chartModel(),i=t.lineBeingCreated()||t.lineBeingEdited()||t.sourcesBeingMoved().length>0&&t.sourcesBeingMoved()[0];return i?t.paneForSource(i)===this._state:e&&(0,E.isLineToolName)(K.tool.value())&&t.crossHairSource().pane===this._state}_updateLineToolUsingMagnetOrShift(e){if(null===this._prevMoveEventPosition)return;const{x:t,y:i}=this._prevMoveEventPosition,s=this._chartModel().sourcesBeingMoved();s.length>0?(K.isStudyEditingNow.value()&&this._setCursorPosition(t,i,e),this._alignSourcesThatBeingMoved(s,t,i,e)):this._setCursorPosition(t,i,e)}_showEditDialogForSource(e,t){if(this._options.propertyPagesEnabled&&e.userEditEnabled())if(e===this._chartUndoModel().mainSeries())this._chart.showGeneralChartProperties(pt.TabNames.symbol);else if((0,A.isLineTool)(e)||(0,D.isStudy)(e)||(0,ct.isLollipopDataSource)(e)){let i;const s=null==t?void 0:t.data();if(null!=s){const e=s.areaName;void 0!==e&&(i=Wt.get(e))}this._chart.showChartPropertiesForSource(e,i).then((e=>{this._editDialog=e}))}}_initToolCreationModeParams(e){this._startTouchPoint=new O.Point(e.pageX,e.pageY),this._initCrossHairPosition=this._chartModel().crossHairSource().currentPoint()}_updateCrosshairPositionInToolCreationMode(e,t){if(t!==this._state){const i=this._chart.paneByState(t);return i._startTouchPoint=this._startTouchPoint,i._initCrossHairPosition=this._initCrossHairPosition,void i._updateCrosshairPositionInToolCreationMode(e,t)}const i=this._chartModel().crossHairSource();this._chart.justActivated()&&(this._initCrossHairPosition=i.currentPoint());const s=e.pageX,o=e.pageY,n=(0,r.ensureNotNull)(this._initCrossHairPosition),a=new O.Point(s,o).subtract((0,r.ensureNotNull)(this._startTouchPoint)),l=n.add(a);this._setCursorPosition(l.x,l.y,new j.EnvironmentState(e))}_priceAxisesContainer(e){return"left"===e?this._lhsPriceAxisesContainer:this._rhsPriceAxisesContainer}_recalculatePriceScales(e){const t=this.state();for(const i of t.leftPriceScales())t.recalculatePriceScale(i,e);for(const i of t.rightPriceScales())t.recalculatePriceScale(i,e);for(const i of t.sourcesByGroup().overlayPriceScaleSources())(0,A.isLineTool)(i)||t.recalculatePriceScale(i.priceScale(),e)}_createLockTimeAxisAction(e){var t;const i=0===(null===(t=K.crosshairLock.value())||void 0===t?void 0:t.type);return new y.Action({actionId:"Chart.Crosshair.LockVerticalCursor",label:Lt,statName:"LockCursorInTime",checkable:!0,checked:i,onExecute:()=>this._toggleLockTimeAxis(e.localX,!i)})}_toggleLockTimeAxis(e,t){if(t){const t=this._chartUndoModel().timeScale(),i=t.coordinateToIndex(e),s=t.points().roughTime(i)
;if(null!==s)return void K.crosshairLock.setValue({type:0,time:s})}K.crosshairLock.setValue(null)}_preventTouchEventsExceptPinch(){return this._paneWidgetsSharedState.hasTouchesOnOtherPanes(this)||null!==this._paneWidgetsSharedState.pinchingPane()}_updateHoveredSource(e,t,i){var s,r;const o=this._chartUndoModel(),n=o.model();let a=!1;const l=e&&e.source,c=this._chart.readOnly();if(n.crossHairSource().isReplaySelection())this._setCursorClassName("none");else if(!(!c||e&&(0,A.isLineTool)(e.source))||this._editDialog&&this._editDialog.visible().value())c&&(n.setHoveredSource(null,null),this.setCursorForTool());else{const h=K.tool.value();let d=null;if(!this._processing&&((0,K.toolIsCursor)(h)||"eraser"===h&&!c||t.mod()||!o.lineBeingCreated())){const t=null==e?void 0:e.hittest;a=Boolean(null===(s=null==t?void 0:t.data())||void 0===s?void 0:s.hideCrosshairLinesOnHover),t&&t.target()>G.HitTarget.MovePointBackground?(d=l,!(null==l?void 0:l.isHoveredEnabled())||"eraser"===h&&l===o.mainSeries()?n.setHoveredSource(null,null):n.setHoveredSource(l,t.data())):n.setHoveredSource(null,null)}c?this.setCursorForTool(d,t,mt.PaneCursorType.Default):this._options.sourceSelectionEnabled&&(this._isSelectPointModeEnabled()?this._setCursorClassName("pointer"):this.setCursorForTool(d,t,null===(r=null==e?void 0:e.hittest.data())||void 0===r?void 0:r.cursorType));const u=n.customSourceBeingMoved(),_=null!==u?[u]:n.sourcesBeingMoved();if((!_.length||null!==e&&-1===_.indexOf(e.source))&&this._updateCommonTooltip(e),!c&&null!==e&&i&&e.hittest.hasPressedMoveHandler(i)){switch((e.hittest.data()||{}).cursorType){case mt.PaneCursorType.VerticalResize:this._setCursorClassName("ns-resize");break;case mt.PaneCursorType.HorizontalResize:this._setCursorClassName("we-resize");break;case mt.PaneCursorType.DiagonalNeSwResize:this._setCursorClassName("nesw-resize");break;case mt.PaneCursorType.DiagonalNwSeResize:this._setCursorClassName("nwse-resize")}}}this._preventCrossHairMove()&&this._clearCursorPosition(),1!==this._pressedMoveStage&&n.crossHairSource().setLinesShouldBeHidden(a)}async _createErrorBlock(){const e=new(await(0,St.getErrorCardRenderer)());return this._div.insertBefore(e.container,this._topCanvasBinding.canvasElement.nextSibling),e}_customActions(){const e={top:[],bottom:[],remove:[]},t=this._chartUndoModel().timeScale(),i=this._state&&this._state.defaultPriceScale();if(!Ee.enabled("custom_items_in_context_menu"))return e;const s=t.isEmpty()?void 0:t.indexToUserTime(t.coordinateToIndex(this._contextMenuX));let o;if(i&&!i.isEmpty()){const e=(0,r.ensureNotNull)(this.state().mainDataSource()).firstValue();o=i.coordinateToPrice(this._contextMenuY,(0,r.ensureNotNull)(e))}return(0,u.emit)("onContextMenu",{unixtime:null!=s?s.getTime()/1e3:void 0,price:o,callback:t=>{[...t].forEach((t=>{if(t.text)if(t.text.length>1&&"-"===t.text[0])e.remove.push(t.text.slice(1));else{let i;i="-"===t.text?new y.Separator:new y.Action({actionId:"Chart.ExternalActionId",label:t.text,onExecute:t.click}),t.position&&"top"===t.position?e.top.push(i):e.bottom.push(i)}}))}}),
e}_highlightPriceAxisByLabel(e){this._lhsPriceAxisesContainer.highlightPriceAxisByLabel(e),this._rhsPriceAxisesContainer.highlightPriceAxisByLabel(e)}_subscribeToState(){const e=this.state();e.onDestroyed().subscribe(this,this._onStateDestroyed,!0),e.dataSourcesCollectionChanged().subscribe(this,this._onDataSourcesCollectionChanged),e.maximized().subscribe(this._updateVisuallyCollapsed),e.collapsed().subscribe(this._updateVisuallyCollapsed)}_unsubscribeFromState(){const e=this.state();e.onDestroyed().unsubscribeAll(this),e.dataSourcesCollectionChanged().unsubscribeAll(this),e.maximized().unsubscribe(this._updateVisuallyCollapsed),e.collapsed().unsubscribe(this._updateVisuallyCollapsed)}async _updateEndOfSeriesBanner(){var e,t,s,o;{const n=()=>{var e,t;if(window.user.is_pro)return null;const i=this._state;if(!i)return null===(e=this._endOfSeriesDataBanner)||void 0===e||e.setVisible(!1),null;if(!this._chart.isActive())return null;const s=i.model().mainSeries();if(!s)return null;if(!i.isMainPane())return null;if(2===s.status()||s.requestMoreDataAvailable())return null===(t=this._endOfSeriesDataBanner)||void 0===t||t.setVisible(!1),null;const r=s.bars().firstIndex();return null===r?null:{state:i,series:s,firstIndex:r}},a=()=>{if(this._legendWidget){const e=this._legendWidget.getElement().getBoundingClientRect();return e.bottom-e.top}return 0};let l=n();if(!l||"end"===l.series.endOfDataType())return void(null===(e=this._endOfSeriesDataBanner)||void 0===e||e.setVisible(!1));l.series.doNotShowLastAvailableBar(!1);const c=l.series.endOfDataType(),h=(0,r.ensureNotNull)(this._state).model().timeScale().indexToCoordinate(l.firstIndex)-l.state.model().timeScale().barSpacing();if(!this._endOfSeriesDataBanner&&!Ee.enabled("widget")){const e=await Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(66639),i.e(26855),i.e(92706),i.e(50690),i.e(745),i.e(66849)]).then(i.bind(i,939651));if(l=n(),!l)return;this._endOfSeriesDataBanner||(this._endOfSeriesDataBanner=new e.EndOfSeriesBanner,this._div.appendChild(this._endOfSeriesDataBanner.element()))}const d=a();null===(t=this._endOfSeriesDataBanner)||void 0===t||t.setVisible(!0),null===(s=this._endOfSeriesDataBanner)||void 0===s||s.update(l.state,d,h,c);const u=null===(o=this._endOfSeriesDataBanner)||void 0===o?void 0:o.currentSize();l.series.doNotShowLastAvailableBar(null!==u&&0!==u)}}}var qt=i(630383);class jt{constructor(e,t,i){this._handleEl=null,this._resizeInfo=null,this._colorCache={lineColor:"",backgroundColor:"",color:""},this._chart=e,this._topPaneIndex=t,this._bottomPaneIndex=i,this._row=document.createElement("tr"),this._cell=document.createElement("td"),this._row.appendChild(this._cell),this._cell.classList.add(qt.paneSeparator),this._cell.setAttribute("colspan","3"),this._cell.style.background=this._color(),this.adjustSize(),this._cell.addEventListener("click",(()=>{}));const s=document.createElement("div");s.classList.add(qt.handle),this._cell.appendChild(s),this._mouseEventHandler=new $.MouseEventHandler(s,this,{treatVertTouchDragAsPageScroll:!1,
treatHorzTouchDragAsPageScroll:!0}),this._handleEl=s}destroy(){this._mouseEventHandler.destroy(),this._row.parentElement&&this._row.parentElement.removeChild(this._row)}getElement(){return this._row}hide(){this._row.classList.add("js-hidden")}show(){this._row.classList.remove("js-hidden")}adjustSize(){this._row.style.height=jt.height()+"px"}mouseEnterEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0);null!==t&&null!==i&&(0,r.ensureNotNull)(this._handleEl).classList.add(qt.hovered)}mouseLeaveEvent(e){(0,r.ensureNotNull)(this._handleEl).classList.remove(qt.hovered)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e)}update(){this._cell.style.background=this._color().toString()}paint(){}image(){const{topPane:e}=this._topBottomPane(!1),t=e.leftPriceAxisesContainer().getWidth(),i=e.width(),r=e.rightPriceAxisesContainer().getWidth(),o=this._color(),n=(0,Z.createDisconnectedCanvas)(document,(0,s.size)({width:t,height:1})),a=(0,Z.getPrescaledContext2D)(n);a.fillStyle=o,a.fillRect(0,0,t,1);const l=(0,Z.createDisconnectedCanvas)(document,(0,s.size)({width:i,height:1})),c=(0,Z.getPrescaledContext2D)(l);c.fillStyle=o,c.fillRect(0,0,i,1);const h=(0,Z.createDisconnectedCanvas)(document,(0,s.size)({width:r,height:1})),d=(0,Z.getPrescaledContext2D)(h);return d.fillStyle=o,d.fillRect(0,0,r,1),{type:"separator",leftAxis:{content:n.toDataURL(),canvas:n,contentWidth:t,contentHeight:1},rightAxis:{content:h.toDataURL(),canvas:h,contentWidth:r,contentHeight:1},content:l.toDataURL(),canvas:l,contentWidth:i,contentHeight:1}}static height(){const e=window.devicePixelRatio||1;return e>=1?1:1/e}_mouseDownOrTouchStartEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0);if(null===t||null===i)return;const s=t.state().stretchFactor()+i.state().stretchFactor(),o=s/(t.height()+i.height()),n=30*o;s<=2*n||(this._resizeInfo={startY:e.pageY,prevStretchTopPane:t.state().stretchFactor(),maxPaneStretch:s-n,totalStretch:s,pixelStretchFactor:o,minPaneStretch:n},(0,r.ensureNotNull)(this._handleEl).classList.add(qt.active))}_pressedMouseOrTouchMoveEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0),s=this._resizeInfo;if(null===s||null===t||null===i)return;const r=(e.pageY-s.startY)*s.pixelStretchFactor,o=(0,Ce.clamp)(s.prevStretchTopPane+r,s.minPaneStretch,s.maxPaneStretch);t.state().setStretchFactor(o),i.state().setStretchFactor(s.totalStretch-o),this._chart.model().model().fullUpdate()}_mouseUpOrTouchEndEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0),s=this._resizeInfo;null!==s&&null!==t&&null!==i&&(this._chart.model().addPaneStretchFactorUndoCommand(t.state(),i.state(),s.prevStretchTopPane,t.state().stretchFactor()),this._resizeInfo=null,(0,r.ensureNotNull)(this._handleEl).classList.remove(qt.active))}_color(){
const e=this._chart.properties().childs().paneProperties.childs().separatorColor.value(),t=this._chart.model().model().backgroundColor().value();if(this._colorCache.lineColor!==e||this._colorCache.backgroundColor!==t){const i=(0,me.parseRgba)(t),s=(0,me.parseRgba)(e),r=0===i[3]&&0===s[3]?"rgba(0,0,0,0)":(0,me.rgbaToString)((0,me.blendRgba)(i,s));this._colorCache={lineColor:e,backgroundColor:t,color:r}}return this._colorCache.color}_topBottomPane(e){const t=this._chart.paneWidgets();let i=null,s=null;for(let s=this._topPaneIndex;s>=0;--s){const r=t[s];if(!e||!r.state().collapsed().value()){i=r;break}}for(let i=this._bottomPaneIndex;i<t.length;++i){const r=t[i];if(!e||!r.state().collapsed().value()){s=r;break}}return{topPane:i,bottomPane:s}}}var Yt=i(970109),Kt=i(158566),Xt=i(30574);i(100658);const $t={contextMenuEnabled:!0,timezoneMenuEnabled:!0,pressedMouseMoveScale:!0},Zt=new z.TranslatedString("change session",n.t(null,void 0,i(765303))),Qt=n.t(null,void 0,i(25866));class Jt{constructor(e,t,i,r,o){this._rendererOptions=null,this._onLabelHovered=new le.Delegate,this._mousedown=!1,this._currentCursorClassName="invalid",this._options=(0,S.merge)((0,S.clone)($t),t||{}),this.chart=e,this._properties=e.properties().childs().scalesProperties,this._element=document.createElement("tr"),this._backgroundBasedTheme=o;const n=()=>this.backgroundColor(),a=()=>{throw new Error("Time axis does not support real price scales")},l={titlesProvider:i,stubContextMenuProvider:(e,t)=>{const i=r(e,t),s=this.getContextMenuActions(!0);return 0===s.length?i:i.concat(new y.Separator,s)},backgroundBasedTheme:o,rendererOptionsProvider:e.model().model().rendererOptionsProvider(),getBackgroundTopColor:n,getBackgroundBottomColor:n,showHorizontalBorder:!0};this._lhsStubContainer=new pe(this._properties,"left",a,l,this._options.priceAxisLabelsOptions,this),this._lhsStubContainer.onLabelHovered().subscribe(this,((e,t)=>{this._onLabelHovered.fire(e,t)})),this._rhsStubContainer=new pe(this._properties,"right",a,l,this._options.priceAxisLabelsOptions,this),this._rhsStubContainer.onLabelHovered().subscribe(this,((e,t)=>{this._onLabelHovered.fire(e,t)})),this._element.appendChild(this._lhsStubContainer.getElement()),this._cell=document.createElement("td"),this._element.appendChild(this._cell),this._cell.classList.add("chart-markup-table","time-axis"),this._cell.style.height="25px",this._dv=document.createElement("div"),this._dv.style.width="100%",this._dv.style.height="100%",this._dv.style.position="relative",this._dv.style.overflow="hidden",this._cell.appendChild(this._dv),this._canvasConfiguredHandler=()=>this.chart.model().model().lightUpdate(),this._canvasBinding=(0,Z.createBoundCanvas)(this._dv,(0,s.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const c=this._canvasBinding.canvasElement;c.style.position="absolute",c.style.zIndex="1",c.style.left="0",c.style.top="0",this._topCanvasBinding=(0,Z.createBoundCanvas)(this._dv,(0,s.size)({width:16,height:16})),
this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const h=this._topCanvasBinding.canvasElement;h.style.position="absolute",h.style.zIndex="2",h.style.left="0",h.style.top="0",this._element.appendChild(this._rhsStubContainer.getElement()),this.restoreDefaultCursor(),this.update(),this._minVisibleSpan=Yt.MINUTE_SPAN,this._mouseEventHandler=new $.MouseEventHandler(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:!0,treatHorzTouchDragAsPageScroll:!1}),this.size=(0,s.size)({width:0,height:0})}destroy(){this._mouseEventHandler.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._rhsStubContainer.onLabelHovered().unsubscribeAll(this),this._lhsStubContainer.onLabelHovered().unsubscribeAll(this),this._lhsStubContainer.destroy(),this._rhsStubContainer.destroy(),this.chart.properties().childs().paneProperties.childs().background.unsubscribeAll(this)}setCursor(e){let t="";"grabbing"!==e&&"ew-resize"!==e||(t="time-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t,this._cell.style.cursor)}restoreDefaultCursor(){this.setCursor("")}getElement(){return this._element}optimalHeight(){const e=this.rendererOptions();return Math.ceil(e.borderSize+e.offsetSize+e.fontSize+e.paddingTop+e.paddingBottom+e.labelBottomOffset)}setSizes(e,t,i){this.size&&(0,s.equalSizes)(this.size,e)||(this.size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._cell.style.width=e.width+"px",this._cell.style.height=e.height+"px"),this._lhsStubContainer.setSizes(e.height,t),this._rhsStubContainer.setSizes(e.height,i)}rendererOptions(){if(!this._rendererOptions||this._rendererOptions.fontSize!==this.fontSize()){const e=this.fontSize();this._rendererOptions={borderSize:1,offsetSize:5,fontSize:e,font:(0,J.makeFont)(e,se.CHART_FONT_FAMILY,""),widthCache:new fe.TextWidthCache,paddingTop:3*e/12,paddingBottom:3*e/12,paddingHorizontal:9*e/12,labelBottomOffset:4*e/12}}return this._rendererOptions}backgroundColor(){return this.chart.model().model().backgroundColor().value()}lineColor(){const e=this._properties.childs().lineColor.value();if(0===(0,me.parseRgba)(e)[3]){const e=this.chart.model().model().lastPane();if(e&&(e.collapsed().value()||e.isMainPane()&&this._areEventsEnabled()))return this.chart.properties().childs().paneProperties.childs().separatorColor.value()}return e}textColor(){return this._properties.childs().textColor.value()}fontSize(){return this._properties.childs().fontSize.value()}baseFont(){return(0,J.makeFont)(this.fontSize(),se.CHART_FONT_FAMILY)}baseBoldFont(){return(0,J.makeFont)(this.fontSize(),se.CHART_FONT_FAMILY,"","bold")}hasCanvas(e){
return this._canvasBinding.canvasElement===e||this._topCanvasBinding.canvasElement===e}onLabelHovered(){return this._onLabelHovered}getScreenshotData(){return{content:this._canvasBinding.canvasElement.toDataURL(),canvas:this._canvasBinding.canvasElement,contentWidth:this.size.width,contentHeight:this.size.height,lhsStub:this._lhsStubContainer.getScreenshotData(),rhsStub:this._rhsStubContainer.getScreenshotData()}}getContextMenuActions(e){var t;const i=this.chart;i.updateActions();const s=i.actions(),r=[];if(e||(i.model().timeScale().resetAvailable().value()&&(r.push(s.timeScaleReset),r.push(new y.Separator)),this._options.timezoneMenuEnabled&&r.push(s.applyTimeZone),r.push(s.sessionBreaks)),!i.model().mainSeries().isDWM()){const e=null===(t=i.model())||void 0===t?void 0:t.mainSeries().symbolInfo();if(e){const t=i.model().mainSeries().properties().childs().sessionId,s=(e.subsessions||[]).filter((e=>!e.private));if(s.length>1){const e=s.map((e=>{const s={label:(0,Xt.translateSessionDescription)(e.description),checkable:!0,checked:t.value()===e.id,statName:"SetSession",onExecute:()=>{i.model().setProperty(t,e.id,Zt)}};return new Kt.TVAction(s)})),o={label:Qt,statName:"SetSession",subItems:e},n=new Kt.TVAction(o);r.push(n)}}}return r}update(){if(!this.chart.hasModel())return;const e=this.chart.model().timeScale().marks();if(e){this._minVisibleSpan=Yt.YEAR_SPAN;for(const t of e)this._minVisibleSpan=Math.min(t.span,this._minVisibleSpan)}}updatePriceAxisStubs(){const e=this.chart.model().model(),t=this.chart.isMaximizedPane()?(0,r.ensureNotNull)(this.chart.maximizedPaneWidget()).state():e.paneForSource(e.mainSeries());if(!t)return;const i=e.priceScaleSlotsCount();this._lhsStubContainer.setScales([],i.left,t.leftPriceScales().length,i.left+i.right),this._rhsStubContainer.setScales([],i.right,t.rightPriceScales().length,i.left+i.right)}paint(e){if(e===R.InvalidationLevel.None||0===this.size.width||0===this.size.height)return;(0,Z.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,Z.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding);const t=(0,Z.getContext2D)(this._topCanvasBinding.canvasElement);if(e>R.InvalidationLevel.Cursor){const i=(0,Z.getContext2D)(this._canvasBinding.canvasElement),s=(0,Z.getBindingPixelRatio)(this._canvasBinding);this.drawBackground(i,s),this.chart.hasModel()&&(this.drawBorder(i,s),this.drawTickMarks(i,s),this.drawBackLabels(i,s),this.drawCrossHairLabel(t,s)),this._lhsStubContainer.paintStubs(e),this._rhsStubContainer.paintStubs(e)}this.drawCrossHairLabel(t,(0,Z.getBindingPixelRatio)(this._topCanvasBinding))}drawBackground(e,t){if((0,Z.clearRect)(e,0,0,Math.ceil(this.size.width*t)+1,Math.ceil(this.size.height*t)+1,this.backgroundColor()),!this.chart.hasModel())return;const i=this.chart.model();if(!i.timeScale().isEmpty()){const s=i.model().selection().lineDataSources().reduce(((e,t)=>{const i=t.timeAxisPoints();return 0===i.length?e:e.concat(i)}),[]);s.length>0&&this._hightlightBackground(e,s,t)}const s=i.model().crossHairSource()
;s.startMeasurePoint()&&this._hightlightBackground(e,s.measurePoints(),t)}drawBorder(e,t){e.save(),e.fillStyle=this.lineColor();const i=Math.max(1,Math.floor(this.rendererOptions().borderSize*t)),s=Math.ceil(this.size.width*t);e.fillRect(0,0,s+1,i),e.restore()}drawTickMarks(e,t){const i=this.chart.model().timeScale().marks();if(!i||0===i.length)return;let s=i.reduce(((e,t)=>e.span>t.span?e:t),i[0]).span;s>30&&s<40&&(s=30),e.save(),e.strokeStyle=this.lineColor();const r=this.rendererOptions(),o=r.borderSize+r.offsetSize+r.paddingTop+r.fontSize/2;e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.textColor(),(0,Z.drawScaled)(e,t,t,(()=>{e.font=this.baseFont();for(let t=0;t<i.length;t++){const r=i[t];r.span<s&&e.fillText(r.label,r.coord,o)}e.font=this.baseBoldFont();for(let t=0;t<i.length;t++){const r=i[t];r.span>=s&&e.fillText(r.label,r.coord,o)}})),e.restore()}drawBackLabels(e,t){var i;e.save();const s=new Set,r=this.chart.model().model();let o=r.dataSources();const n=r.selection().allSources();for(const e of n)s.add(e);r.hoveredSource()&&s.add(r.hoveredSource());for(const e of r.sourcesBeingMoved())s.add(e);const a=r.customSourceBeingMoved();null!==a&&s.add(a);const l=null!==(i=r.lineBeingEdited())&&void 0!==i?i:r.lineBeingCreated();l&&s.add(l),s.add(this.chart.model().crossHairSource()),o=o.concat(r.customSources());const c=this.rendererOptions();for(let i=0;i<o.length;i++){const r=o[i];if(!s.has(r)&&r.timeAxisViews){const i=r.timeAxisViews();if(i)for(let s=0;s<i.length;s++)i[s].renderer().draw(e,c,t)}}e.restore()}drawCrossHairLabel(e,t){var i;e.save(),e.clearRect(0,0,Math.ceil(this.size.width*t)+1,Math.ceil(this.size.height*t)+1);const s=this.chart.model().model(),r=[],o=null!==(i=s.lineBeingEdited())&&void 0!==i?i:s.lineBeingCreated();if(o&&o.timeAxisViews){const e=o.timeAxisViews();e&&e.length&&r.push(e)}const n=s.customSourceBeingMoved();this._addViewsOrMaxMin(null===n?[]:[n],r),this._addViewsOrMaxMin(s.sourcesBeingMoved(),r),this._addViewsOrMaxMin(s.selection().allSources(),r);const a=s.hoveredSource();if(a&&(0,Y.isDataSource)(a)&&!s.selection().isSelected(a)&&a.timeAxisViews){const e=a.timeAxisViews();e&&e.length&&r.push(e)}const l=s.crossHairSource(),c=l.timeAxisViews&&l.timeAxisViews();c&&c.length&&r.push(c);const h=this.rendererOptions();for(const i of r)for(const s of i)e.save(),s.renderer().draw(e,h,t),e.restore();e.restore()}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseOrTouchEnterEvent(e),this._mouseDownOrTouchStartEvent(e)}mouseDownOutsideEvent(){this._outsideMouseDownOrTouchStartEvent()}touchStartOutsideEvent(){this._outsideMouseDownOrTouchStartEvent()}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e),this._mouseOrTouchLeaveEvent(e)}contextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}touchContextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}mouseEnterEvent(e){
this._mouseOrTouchEnterEvent(e)}mouseLeaveEvent(e){this._mouseOrTouchLeaveEvent(e)}mouseDoubleClickEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}doubleTapEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}_outsideMouseDownOrTouchStartEvent(){this._zoomAvailable()&&this._mousedown&&(this._mousedown=!1,this.chart.model().endScaleTime(),this.restoreDefaultCursor())}_hightlightBackground(e,t,i){const s=this.chart.model().timeScale();let r=t[0].index,o=t[0].index;for(let e=1;e<t.length;e++)r=Math.min(r,t[e].index),o=Math.max(o,t[e].index);const n=Math.floor(s.indexToCoordinate(r)*i),a=Math.ceil(s.indexToCoordinate(o)*i);(0,Z.fillRect)(e,n,0,a-n,Math.ceil(this.size.height*i)+1,this._properties.childs().axisHighlightColor.value())}_addViewsOrMaxMin(e,t){if(e.length<=1){for(const i of e)if(i.timeAxisViews){const e=i.timeAxisViews();e&&e.length&&t.push(e)}}else t.push(this._minMaxViews(e))}_minMaxViews(e){const t=[];let i=1/0,s=-1/0,r=null,o=null;for(const t of e)if(t.timeAxisViews){const e=t.timeAxisViews();if(e&&e.length)for(let t=0;t<e.length;++t){const n=e[t],a=n.coordinate();a>=s&&(s=a,o=n),a<=i&&(i=a,r=n)}}return o&&t.push(o),r&&t.push(r),t}_zoomAvailable(){return!this.chart.model().timeScale().isEmpty()&&this.chart.model().model().zoomEnabled()&&this._options.pressedMouseMoveScale}_mouseDownOrTouchStartEvent(e){if(this._mousedown||!this._zoomAvailable())return;this._mousedown=!0;const t=this.chart.model();t.timeScale().isEmpty()||t.startScaleTime(e.localX)}_pressedMouseOrTouchMoveEvent(e){this._zoomAvailable()&&this.chart.model().scaleTimeTo(e.localX)}_mouseUpOrTouchEndEvent(e){this._zoomAvailable()&&(this._mousedown=!1,this.chart.model().endScaleTime(),this.restoreDefaultCursor())}_contextMenuOrTouchContextMenuEvent(e){this._options.contextMenuEnabled&&ce.ContextMenuManager.showMenu(this.getContextMenuActions(),e,{statName:"TimeScaleContextMenu"},{menuName:"TimeScaleContextMenu"})}_mouseOrTouchEnterEvent(e){this._zoomAvailable()&&this.setCursor("ew-resize")}_mouseOrTouchLeaveEvent(e){this.restoreDefaultCursor()}_mouseDoubleClickOrDoubleTapEvent(e){(0,ye.trackEvent)("GUI","Double click time scale"),this.chart.model().resetTimeScale()}_areEventsEnabled(){var e;{const t=this.chart.model().mainSeries();switch(null===(e=t.symbolInfo())||void 0===e?void 0:e.type){case"forex":case"cfd":return!Ee.enabled("widget")&&this.chart.model().model().properties().childs().chartEventsSourceProperties.childs().visible.value();case"stock":case"fund":if(!Ee.enabled("widget")||Ee.enabled("esdonwidget")){const{esdShowDividends:e,esdShowSplits:i,esdShowEarnings:s}=t.properties().childs();return e.value()||i.value()||s.value()}return!1;default:return!1}}}}function ei(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ti(e){return e.reduce(((e,t)=>{for(const i in t)if(ei(t,i)){const s=t[i],r=e[i];r?r.push(s):e[i]=[s]}return e}),{})}const ii=new z.TranslatedString("move left",n.t(null,void 0,i(415086))),si=new z.TranslatedString("move right",n.t(null,void 0,i(461711)));class ri{constructor(e){this._chartModel=null,
this._animation=null,this._chart=e,this._chart.withModel(this,(()=>{this._chartModel=this._chart.model()}))}destroy(){var e;null===(e=this._animation)||void 0===e||e.stop()}move(e){if(null!==this._chartModel){const t=this._chartModel.timeScale();if(t.isEmpty())return;const i=t.barSpacing(),s=.003/i,r=1.1/i,o=Math.round(r/s);this._moveImpl(e,((t,i,n)=>{const a=Math.min(i,o),l=e*s*Math.pow(a,2)/2;if(i<=o)return t-l;const c=Number.isFinite(n)?Math.max(0,o-n):0;return t-l-e*(i-a-c)*r-e*(r*c-s*Math.pow(c,2)/2)}),(e=>Math.max(0,o-e)+o))}}moveByBar(e){if(null!==this._chartModel){if(this._chartModel.timeScale().isEmpty())return;const t=300;this._moveImpl(e,((i,s)=>i-e*(Math.floor(Math.max(0,s-t)/100)+1)),(()=>0),!0)}}stopMove(){var e;null===(e=this._animation)||void 0===e||e.stop(),this._animation=null}scrollToRealtime(e){null!==this._chartModel&&this._chartModel.timeScale().scrollToRealtime(e)}_moveImpl(e,t,i,s){if(null===this._chartModel)return;const r=this._chartModel.timeScale();if(r.isEmpty())return;if(this._chartModel.changeTimeScale(1===e?ii:si),s&&null!==r.visibleBarsStrictRange()){const e=r.indexToCoordinate(r.visibleBarsStrictRange().lastBar())+r.barSpacing()/2;Math.abs(r.width()-e)>r.barSpacing()/6&&r.setRightOffset(Math.round(r.rightOffset()))}const o=performance.now();let n=1/0;const a=r.rightOffset();this._animation={getPosition:e=>(e=Math.min(n,e),t(a,e-o,n-e)),finished:e=>e>=n,stop:()=>{const e=performance.now()-o;n=performance.now()+i(e)}},this._chartModel.model().setTimeScaleAnimation(this._animation)}}var oi=i(12481),ni=i(833713),ai=i(895370),li=i(198303),ci=i(388482);const hi=(0,a.getLogger)("Chart.LinkKeyResolver");class di{constructor(e,t,i){this._pendingRequests=new Map,this._startRequestingDebounced=(0,oi.default)((()=>this._startNextRequest()),500),this._layoutId=e,this._chartId=t,this._ownerSourceId=i}resolveLinkKey(e,t,i){var s;const r=function(e,t){return JSON.stringify([e,t])}(e,i),o=null!==(s=this._pendingRequests.get(r))&&void 0!==s?s:new Map;if(o.has(t))return o.get(t).promise;const n=(0,d.createDeferredPromise)();return o.set(t,n),this._pendingRequests.set(r,o),this._startRequestingDebounced(),n.promise}async _startNextRequest(){if(0===this._pendingRequests.size)return;const e=(0,ci.getChartStorage)(),t=this._pendingRequests.entries().next().value,{symbol:i,brokerName:s}=function(e){const t=JSON.parse(e);return{symbol:t[0],brokerName:t[1]}}(t[0]),r=t[1],o={requestType:"mainSeriesLineTools",seriesSourceId:this._ownerSourceId,symbol:i,brokerName:s,sharingMode:0};try{const t=await e.loadLineToolsAndGroups(this._layoutId,this._chartId,o);null!==t&&null!==t.sources&&(t.sources.forEach(((e,t)=>{if(null===e)return;const i=e.state.linkKey;if(!i)return;const s=r.get(i);null==s||s.resolve(e.id),r.delete(i)})),t.serverRequestId&&console.log(`PROCESSED:${t.serverRequestId}`))}catch(e){hi.logError(`Error requesting line tools: ${e}`)}r.forEach((e=>{e.resolve(null)})),this._pendingRequests.delete(t[0]),await this._startNextRequest()}}var ui=i(558105),_i=i(731327),pi=i(978137),mi=i(359663),gi=i(963568)
;const Si=[500,1e4,6e4],vi=new mi.FeatureToggleWatchedValue("disable_retry_load_linetools_from_storage",!1);var fi=i(459711),bi=i(266325);const yi=(0,a.getLogger)("LineToolsSynchronizer");function Ci(e,t){return{id:e.id,name:e.name().value(),symbol:e.symbol(),currencyId:e.currencyId(),unitId:e.unitId()}}function wi(e){return void 0===e?0:e}function Pi(e,t,i){const s=new Map,r=new Set(null==i?void 0:i.keys());return e.forEach(((e,o)=>{const n=!i||i.has(o);(e.timestamp>t||!n)&&(s.set(o,e),r.delete(o))})),{stillInvalidated:s,validated:Array.from(r)}}function Ti(e){return(0,A.isLineTool)(e)||(0,fi.isStudyLineToolStub)(e)}const Mi=/(\w+)\/(\w+)\/(\w+)/;class xi{constructor(e,t,i,s,r){this._invalidatedLineToolsAndStudyStubs=new Map,this._allLineToolsAndStudyStubs=new Map,this._originalLineToolSharingMode=new Map,this._invalidatedLineToolGroups=new Map,this._originalLineToolGroupsSharingMode=new Map,this._ignoreInvalidatingEventsDepth=0,this._saveChartService=null,this._debouncedSave=(0,oi.default)((()=>this._saveInvalidatedIfRequired(!1)),500),this._currentlyLoadedSymbol=new Map,this._linkKeyResolver=null,this._brokerName="",this._hasChanges=new Se.WatchedValue(!1),this._lastBanTime=null,this._invalidateViaSync=0,this._savingAbortControllersBySharingMode=new Map,this._savingExternalChartsAbortControllers=new Map,this._onChangeAutosave=e=>{e&&this._debouncedSave()},this._origin=e,this._chartModel=t,this._options=i,this._duplicateOperationsForSerializedCharts=s,this._deserializedChartsIds=r,this._assignAllLineTools(this._chartModel.panes()),this._chartModel.panesCollectionChanged().subscribe(this,this._processPanesCollectionChanged.bind(this)),this._chartModel.dataSourceCollectionChanged().subscribe(this,this._processDataSourceCollectionChanged.bind(this)),this._chartModel.lineToolsGroupModel().onChanged().subscribe(this,this._processLineToolsGroupModelChanged.bind(this)),this._chartModel.mainSeries().dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved.bind(this)),this._chartModel.mainSeries().onRestarted().subscribe(this,this._onSeriesRestarted.bind(this)),this._chartModel.sourcePropertiesChanged().subscribe(this,this._processPropertiesChanged.bind(this)),this._chartModel.sourceZOrderChanged().subscribe(this,this._processPropertiesChanged.bind(this)),this._linkKeyResolver=new di(e.layoutId,e.chartId,t.mainSeries().id()),this._brokerIdSession=new mi.FeatureToggleWatchedValue("broker_id_session",!1),this._loadWithoutSymbolResolving=new mi.FeatureToggleWatchedValue("chart_storage_with_broker_name",!1),this._removeFromContent=new mi.FeatureToggleWatchedValue("remove_line_tools_from_content",!1),this._removeFromContent.subscribe((e=>{e&&this.invalidateAll()})),this._saveSharedLineTools=new mi.FeatureToggleWatchedValue("save_shared_line_tools",!1),this._doNotSaveSharedLineToolsToChartsImpl=new mi.FeatureToggleWatchedValue("do_not_save_shared_line_tools_to_charts",!1),this._doNotSaveSharedLineToolsToCharts=(0,
v.combine)(((e,t)=>e&&t),this._doNotSaveSharedLineToolsToChartsImpl.weakReference(),this._saveSharedLineTools.weakReference()),this._sharingModesToUse().forEach((e=>{0===e&&this._loadAndMergeLineToolsOnStudies(e,!1),this._loadAndMergeLineToolsWithoutSymbol(e,!1)}))}destroy(){this._loadWithoutSymbolResolving.destroy(),this._removeFromContent.destroy(),this._brokerIdSession.destroy(),this._saveSharedLineTools.destroy(),this._doNotSaveSharedLineToolsToChartsImpl.destroy(),this._doNotSaveSharedLineToolsToCharts.destroy(),this._chartModel.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this),this._chartModel.mainSeries().onRestarted().unsubscribeAll(this),this._chartModel.sourcePropertiesChanged().unsubscribeAll(this),this._chartModel.sourceZOrderChanged().unsubscribeAll(this),this._chartModel.panesCollectionChanged().unsubscribeAll(this),this._chartModel.dataSourceCollectionChanged().unsubscribeAll(this),this._chartModel.lineToolsGroupModel().onChanged().unsubscribeAll(this)}reloadAllLineTools(){if(this._currentlyLoadedSymbol.clear(),this._sharingModesToUse().forEach((e=>{0===e&&this._loadAndMergeLineToolsOnStudies(e,!0),this._loadAndMergeLineToolsWithoutSymbol(e,!0)})),this._loadWithoutSymbolResolving.value())this._onSeriesRestarted();else{const e=this._chartModel.mainSeries().symbolInfo();e&&this._onSymbolResolved(e)}}hasChanges(){return this._hasChanges}setSaveChartService(e){this._saveChartService&&this._saveChartService.autoSaveEnabled().unsubscribe(this._onChangeAutosave),this._saveChartService=e,this._saveChartService.autoSaveEnabled().subscribe(this._onChangeAutosave)}prepareDTO(e=!1){const t=new Map;return this._sharingModesToUse().forEach((i=>{t.set(i,this._prepareDTOItem(e,i))})),t}deserializedChartsIdsProvider(){return this._deserializedChartsIds}markAsValidatedBecauseOfSavingToContent(e){this._invalidatedLineToolsAndStudyStubs.forEach((t=>{t.savedToChartContent=e})),this._invalidatedLineToolGroups.forEach((t=>{t.savedToChartContent=e})),this._recalculateHasChanges()}resetInvalidated(e,t,i){const s=(e,t,s,r)=>{var o,n;if(!s.has(r)||s.get(r)){if(s.has(r)){const s=e.get(r);if(0===i){t(r,{sharingMode:this._doNotSaveSharedLineToolsToCharts.value()?i:null!==(o=null==s?void 0:s.sharingMode)&&void 0!==o?o:i,duplicatedInChart:!this._doNotSaveSharedLineToolsToCharts.value()})}else t(r,{sharingMode:i,duplicatedInChart:null!==(n=null==s?void 0:s.duplicatedInChart)&&void 0!==n&&n})}}else{const s=e.get(r);s&&(s.sharingMode===i?t(r,null):0===i&&t(r,{...s,duplicatedInChart:!1}))}};if(null===t.sources)return;const{groups:r,sources:o,lineToolsToValidate:n,groupsToValidate:a}=t,l=Pi(this._invalidatedLineToolsAndStudyStubs,e,new Set(null!=n?n:o.keys()));this._invalidatedLineToolsAndStudyStubs=l.stillInvalidated,l.validated.forEach(s.bind(this,this._originalLineToolSharingMode,this._setOriginalLineToolSharingMode.bind(this),o));const c=Pi(this._invalidatedLineToolGroups,e,new Set(null!=a?a:r.keys()))
;l.validated.forEach(s.bind(this,this._originalLineToolGroupsSharingMode,this._setOriginalLineToolGroupsSharingMode.bind(this),r)),this._invalidatedLineToolGroups=c.stillInvalidated,this._recalculateHasChanges()}applyLineToolUpdateNotification(e,t){var i;const s=function(e){const t=Mi.exec(e);return 4===(null==t?void 0:t.length)?{layoutId:t[1],chartId:t[2],clientId:t[3]}:{layoutId:"",chartId:"",clientId:e}}(null!==(i=e.clientId)&&void 0!==i?i:"");s.clientId===this._origin.clientId&&s.chartId===this._origin.chartId||(this._chartModel.dataSources(),void 0!==e.symbol&&null===e.sources?this._withoutInvalidating((()=>{const i=this._chartModel.dataSources().filter(A.isLineTool).filter((i=>i.sharingMode().value()===t&&i.symbol()===e.symbol));i.length>0&&this._chartModel.undoModel().removeSources(i,!0,null)})):this._applyLineToolsAndGroupsDTO(e,t,s))}startApplyingLineToolUpdateNotification(){this._ignoreInvalidatingEventsDepth++}endApplyingLineToolUpdateNotification(){this._ignoreInvalidatingEventsDepth--,this._ignoreInvalidatingEventsDepth<0&&(yi.logError("Logic error, startApplyingLineToolUpdateNotification/endApplyingLineToolUpdateNotification mismatch, autofixing"),this._ignoreInvalidatingEventsDepth=0)}applyAlertIdByExternalSource(e,t){this._withoutInvalidating((()=>{const i=this._chartModel.dataSourceForId(e);i&&(0,A.isLineTool)(i)&&i.setAlert(t)}))}deleteAlertByExternalSource(e){this._withoutInvalidating((()=>{const t=this._chartModel.dataSourceForId(e);t&&(0,A.isLineTool)(t)&&t.removeAlert()}))}async markSyncedLineToolAsDeleted(e,t){if(this._linkKeyResolver){const i=await this._linkKeyResolver.resolveLinkKey(t,e,this._brokerName);if(null!==i){const t=(0,A.lineToolByLinkKey)(this._chartModel,e);null===t?this._invalidateLineToolOrStudyStub(i,performance.now()):this._withoutInvalidating((()=>{const e=(0,r.ensureNotNull)(this._chartModel.paneForSource(t)),i=this._allLineToolsAndStudyStubs.get(e.id())||new Map;t.detachAlert(),this._chartModel.removeSource(t),i.delete(t.id())})),this._debouncedSave()}return i}return null}invalidateAll(){const e=performance.now();this._allLineToolsAndStudyStubs.forEach((t=>{t.forEach(((t,i)=>{this._invalidateLineToolOrStudyStub(i,e)}))})),this._chartModel.lineToolsGroupModel().groupsForAllSymbols().forEach((t=>{this._invalidateLineToolGroup(t.id,e)})),this.markAsValidatedBecauseOfSavingToContent(!0)}setBroker(e){this._brokerName=e}executeSyncedAction(e){this._invalidateViaSync+=1;try{e()}finally{this._invalidateViaSync-=1}}invalidateViaSync(){return this._invalidateViaSync>0}flushPendingSavings(){return this._invalidatedLineToolGroups.size||this._invalidatedLineToolsAndStudyStubs.size?this._saveInvalidatedIfRequired(!1,!0):null}_assignAllLineTools(e){e.forEach((e=>{const t=e.dataSources().filter(Ti).map((e=>[e.id(),e.linkKey().value()])),i=new Map(t);this._allLineToolsAndStudyStubs.set(e.id(),i)}))}_processPropertiesChanged(e,t){Ti(t)&&this._invalidateLineToolOrStudyStub(t.id(),performance.now())}_processLineToolsGroupModelChanged(e,t){const i=performance.now()
;this._invalidateLineToolGroup(e,i),t&&(t.affectedLineTools||[]).forEach((e=>this._invalidateLineToolOrStudyStub(e,i)))}_processPanesCollectionChanged(e){const t=e.map((e=>e.id())),i=new Set(t),s=performance.now();Array.from(this._allLineToolsAndStudyStubs.keys()).filter((e=>!i.has(e))).forEach((e=>{Array.from((0,r.ensureDefined)(this._allLineToolsAndStudyStubs.get(e)).keys()).forEach((e=>{this._invalidateLineToolOrStudyStub(e,s)}))})),e.filter((e=>!this._allLineToolsAndStudyStubs.has(e.id()))).forEach((e=>{e.dataSources().filter(Ti).forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),s)))})),this._assignAllLineTools(e)}_processDataSourceCollectionChanged(e){const t=e.dataSources().filter(Ti),i=t.map((e=>[e.id(),e.linkKey().value()])),s=new Map(i);let o;const n=performance.now();if(this._allLineToolsAndStudyStubs.has(e.id())){const i=(0,r.ensureDefined)(this._allLineToolsAndStudyStubs.get(e.id()));o=t.filter((e=>!i.has(e.id()))),o.forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),n))),Array.from(i.entries()).filter((e=>!s.has(e[0]))).forEach((e=>{null!==e[1]&&this._debouncedSave(),this._invalidateLineToolOrStudyStub(e[0],n)}))}else o=t,t.forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),n)));o.forEach((e=>{if((0,A.isLineTool)(e)){this._setOriginalLineToolSharingMode(e.id(),{sharingMode:e.sharingMode().value(),duplicatedInChart:!1});const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);t&&this._setOriginalLineToolGroupsSharingMode(t.id,{sharingMode:e.sharingMode().value(),duplicatedInChart:!1})}})),this._allLineToolsAndStudyStubs.set(e.id(),s)}_unloadLineTools(e,t,i){const s=e.filter((e=>!this._invalidatedLineToolsAndStudyStubs.has(e))).map((e=>this._chartModel.dataSourceForId(e))).filter(A.isLineTool).filter(S.notNull).filter((e=>e.sharingMode().value()===i)).filter(t).filter((e=>{const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);return null===t||!this._invalidatedLineToolGroups.has(t.id)}));this._withoutInvalidating((()=>{s.forEach((e=>{var t;e.hasAlert.value()&&e.detachAlert();const i=(0,r.ensureNotNull)(this._chartModel.paneForSource(e));this._chartModel.removeSource(e);(null!==(t=this._allLineToolsAndStudyStubs.get(i.id()))&&void 0!==t?t:new Map).delete(e.id())})),this._chartModel.lineToolsGroupModel().removeLineTools(s)}))}_unloadLinesOnSeries(e,t,i){const s=this._chartModel.mainSeries();if(!(null==i?void 0:i.size))return;const r=Array.from(i.keys()).filter((t=>!e(t)));this._unloadLineTools(r,(e=>e.boundToSymbol()&&e.ownerSource()===s),t)}_isAutosaveEnabled(){return Boolean(this._saveChartService&&this._saveChartService.autoSaveEnabled().value())}async _saveInvalidatedIfRequired(e,t){if(null!==this._lastBanTime){if(!(performance.now()-this._lastBanTime>=3e5))return Promise.resolve();this._lastBanTime=null}if(!this._isAutosaveEnabled()&&!t||this._options.readOnlyMode||!window.is_authenticated||""===this._origin.layoutId)return;const i=this.prepareDTO(e),s=this._sharingModesToUse().map((e=>{var t,s;const o=i.get(e);if(!o||null===o.sources)return null
;const n=null!==(t=o.lineToolsToValidate)&&void 0!==t?t:Array.from(o.sources.keys()),a=null!==(s=o.groupsToValidate)&&void 0!==s?s:Array.from(o.groups.keys());if(0===n.length&&0===a.length)return null;const l=performance.now();if(o.sources.size||o.groups.size){this._applyToolsAndGroupsDTOToNonDeserializedCharts(o,e);const t=this._savingAbortControllersBySharingMode.get(e);t&&t.abort();const i=new AbortController;return this._savingAbortControllersBySharingMode.set(e,i),o.sources.forEach(((t,i)=>{t&&this._setOriginalLineToolSharingMode(i,{sharingMode:e,duplicatedInChart:!1})})),(0,r.ensureNotNull)(this._saveChartService).saveChartLineTools(this._origin.chartId,o,e,i.signal).then((()=>{this.resetInvalidated(l,o,e)})).catch((t=>{if(t instanceof li.SavingLineToolsError&&t.shouldBeCooled&&(this._lastBanTime=performance.now()),!(0,bi.isAbortError)(t))throw t;yi.logDebug(`Save request has beed aborted. ChartId: ${this._origin.chartId} sharingMode: ${e}`)}))}return this.resetInvalidated(l,o,e),null})).filter(S.notNull);return s.length?Promise.all(s).then((()=>{})):void 0}async _savePromise(e,t){var i,s;return this._isAutosaveEnabled()?null!==(s=null===(i=this._debouncedSave)||void 0===i?void 0:i.flush())&&void 0!==s?s:Promise.resolve():this._saveInvalidatedIfRequired(e,t)}_seriesLineToolsUnloader(e,t,i){const s=this._chartModel.mainSeries();this._removeFromContent.value()&&"mainSeriesLineTools"===e.requestType&&s.symbolSameAsCurrent(e.symbol)&&(this._unloadLinesOnSeries(i,e.sharingMode,t),this._currentlyLoadedSymbol.set(e.sharingMode,e.symbol))}_mainPaneLineToolsAndStubs(){const e=this._chartModel.mainSeries(),t=(0,r.ensureNotNull)(this._chartModel.paneForSource(e));return new Map(this._allLineToolsAndStudyStubs.get(t.id()))}_onSymbolResolved(e){if(this._loadWithoutSymbolResolving.value())return;const t=this._sharingModesToUse().map((t=>{const i={requestType:"mainSeriesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),symbol:e.pro_name,brokerName:"",sharingMode:t},s=this._seriesLineToolsUnloader.bind(this,i,this._mainPaneLineToolsAndStubs());return this._makeLoadRequestAndMerge(i,s)}));this._saveSharedLineTools.value()&&Promise.all(t).then((()=>{this._withoutInvalidating((()=>{this._chartModel.dataSources().filter(A.isLineTool).filter((e=>0===e.sharingMode().value()&&e.linkKey().value())).forEach((e=>{if(e.share(1),this._options.migrateSyncedLineTools){this._invalidateLineToolOrStudyStub(e.id(),performance.now(),!0);const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);t&&this._invalidateLineToolGroup(t.id,performance.now(),!0)}}))}))}))}_onSeriesRestarted(){if(!this._loadWithoutSymbolResolving.value())return;const e=e=>({requestType:"mainSeriesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),symbol:this._chartModel.mainSeries().properties().childs().symbol.value(),brokerName:this._brokerIdSession.value()?this._brokerName:"",sharingMode:e}),t=this._mainPaneLineToolsAndStubs();this._savePromise(!0).catch((()=>{})).then((async()=>{
if(this._doNotSaveSharedLineToolsToCharts.value())this._sharingModesToUse().forEach((i=>{const s=e(i);this._makeLoadRequestAndMerge(s,this._seriesLineToolsUnloader.bind(this,s,t))}));else{const i=e(0);await this._makeLoadRequestAndMerge(i,this._seriesLineToolsUnloader.bind(this,i,t)),this._sharingModesToUse().filter((e=>0!==e)).forEach((i=>{const s=e(i);this._makeLoadRequestAndMerge(s,this._seriesLineToolsUnloader.bind(this,s,t))}))}}))}async _makeLoadRequestAndMerge(e,t){var i;const s=this._chartModel.mainSeries(),r=null!==(i=this._currentlyLoadedSymbol.get(e.sharingMode))&&void 0!==i?i:"";if(!!s.symbolSameAsCurrent(r))return;this._currentlyLoadedSymbol.delete(e.sharingMode);const o=(0,ci.getChartStorage)();return this._savePromise("mainSeriesLineTools"===e.requestType).catch((()=>{})).then((()=>async function(e,t,i,s){const r=async()=>e.loadLineToolsAndGroups(t,i,s);return r().catch((()=>vi.value()?null:(0,gi.retriesWithDelays)((async()=>(await(0,pi.waitForOnline)(),r())),Si)))}(o,this._origin.layoutId,this._origin.chartId,e))).then((async i=>{if(null!==i&&null!==i.sources){const s=i.sources;t((e=>s.has(e))),await this._applyLineToolsAndGroupsDTO(i,e.sharingMode),i.serverRequestId&&console.log(`PROCESSED:${i.serverRequestId}`)}}))}_restoreGroups(e,t,i,s){const o=new Map;return(t.groups||new Map).forEach(((t,n)=>{const a=this._chartModel.lineToolsGroupModel().groupForId(n);if(null===t){if(a){const e=s&&s.layoutId===this._origin.layoutId&&s.chartId===this._origin.chartId;(a.lineTools()[0].sharingMode().value()===i||0===i&&!this._doNotSaveSharedLineToolsToCharts.value())&&(e&&0!==i||(new _i.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,a,a.lineTools()).redo(),this._setOriginalLineToolGroupsSharingMode(n,null)))}}else{if(a&&t.serverUpdateTime){const i=(0,r.ensureDefined)(t.serverUpdateTime);if(null!==e&&e>=i)return;a.setName(t.name)}else o.set(n,t);const s=this._originalLineToolGroupsSharingMode.get(n),l=!(!s||s.sharingMode===i&&!s.duplicatedInChart);this._setOriginalLineToolGroupsSharingMode(n,{sharingMode:i,duplicatedInChart:l})}})),o}_createNewLineTool(e){const t=this._chartModel.dataSourceForId(e.ownerSource);if(null===t)return null;const i=(0,r.ensureNotNull)(this._chartModel.paneForSource(t)),s=this._chartModel.panes().indexOf(i),o=this._chartModel.restoreSource(!1,s,null,e.state,null);if(null!==o){const e=this._allLineToolsAndStudyStubs.get(i.id())||new Map;e.set(o.id(),o.linkKey().value()),this._allLineToolsAndStudyStubs.set(i.id(),e)}return o}_migrateStateFromMetainfo(e){const t=void 0!==e.symbol&&e.symbol!==e.state.state.symbol;t&&(e.state.state.symbol=e.symbol);const i=void 0!==e.currencyId&&e.currencyId!==e.state.state.currencyId;i&&(e.state.state.currencyId=e.currencyId);const s=void 0!==e.unitId&&e.unitId!==e.state.state.unitId;return s&&(e.state.state.unitId=e.unitId),t||i||s}_restoreLineTool(e,t,i,s){var r;if((null!==(r=t.state.points)&&void 0!==r?r:[]).some((e=>!(0,S.isNumber)(e.time_t))))return null;let o=this._chartModel.dataSourceForId(t.id);if(null===o&&t.state.linkKey&&(o=(0,
A.lineToolByLinkKey)(this._chartModel,t.state.linkKey)),null!==o&&!(0,A.isLineTool)(o))return null;if(this._origin.clientId===(null==s?void 0:s.clientId)&&!o)return null;if(o&&t.serverUpdateTime){const r=t.serverUpdateTime,n=o.serverUpdateTime();if(null!==e&&e>=r||null!==n&&n>=r){if(this._saveSharedLineTools.value()&&0!==i){o.share(i);const e=this._originalLineToolSharingMode.get(o.id()),t=!(!e||e.sharingMode===i&&!e.duplicatedInChart);this._setOriginalLineToolSharingMode(o.id(),{sharingMode:i,duplicatedInChart:t})}return null}this._origin.clientId!==(null==s?void 0:s.clientId)&&(this._chartModel.restoreLineToolState(o,t.state,!1),o.calcIsActualSymbol())}0!==i&&(t.ownerSource=this._chartModel.mainSeries().id(),t.state.ownerSource=this._chartModel.mainSeries().id());const n=this._migrateStateFromMetainfo(t),a=o||this._createNewLineTool(t);return a&&(n&&this._invalidateLineToolOrStudyStub(t.id,performance.now(),!0),t.serverUpdateTime&&a.setServerUpdateTime(t.serverUpdateTime),t.state.alertId?a.setAlert(+t.state.alertId):a.detachAlert(),(0!==i||this._doNotSaveSharedLineToolsToCharts.value())&&a.share(i)),a}_removeLineTool(e){const t=this._chartModel.dataSourceForId(e);null!==t&&new ui.RemoveSourcesUndoCommand(this._chartModel,[t],null).redo()}_restoreLineDTO(e,t,i,s,o,n){if(!this._invalidatedLineToolsAndStudyStubs.get(t))if(null===e){const e=this._chartModel.dataSourceForId(t);if(!e)return;if(!(0,A.isLineTool)(e))return;const i=n&&n.layoutId===this._origin.layoutId&&n.chartId===this._origin.chartId;(e.sharingMode().value()===o||0===o&&!this._doNotSaveSharedLineToolsToCharts.value())&&(0===o||this._doNotSaveSharedLineToolsToCharts.value()||(e.share(0),i||this._invalidateLineToolOrStudyStub(t,performance.now(),!0)),this._origin.clientId!==(null==n?void 0:n.clientId)&&(i&&0!==o&&!this._doNotSaveSharedLineToolsToCharts.value()||(this._removeLineTool(t),this._setOriginalLineToolSharingMode(t,null))))}else{const a=this._restoreLineTool(s,e,o,n);if(a){if(e.groupId){const t=this._chartModel.lineToolsGroupModel().groupForLineTool(a),s=this._chartModel.lineToolsGroupModel().groupForId(e.groupId);if(null!==t&&s===t)return;if(null!==t&&(t.excludeLineTool(a),0===t.lineTools().length&&this._chartModel.lineToolsGroupModel().removeGroup(t)),s&&!s.containsLineTool(a))s.addLineTools([a]);else if(!s&&i.has(e.groupId)){const t=(0,r.ensureDefined)(i.get(e.groupId));this._chartModel.lineToolsGroupModel().createGroup([a],t.name,t.id)}}else{this._chartModel.lineToolsGroupModel().removeLineTools([a]).forEach((e=>{this._invalidateLineToolGroup(e,performance.now(),!0)}))}const s=this._originalLineToolSharingMode.get(t);(void 0===s||0!==o&&!this._doNotSaveSharedLineToolsToCharts.value())&&this._setOriginalLineToolSharingMode(t,{sharingMode:o,duplicatedInChart:!1});const n=!(!s||s.sharingMode===o&&!s.duplicatedInChart);(0,r.ensureDefined)(this._originalLineToolSharingMode.get(t)).duplicatedInChart=n}}}async _applyLineToolsAndGroupsDTO(e,t,i){
const s=this._chartModel.chartSaveTime(),r=this._withoutInvalidating((()=>this._restoreGroups(s,e,t,i))),o=`ChartStorage.Synchronizer.ApplyingDTO.${`${this._origin.layoutId}.${this._origin.chartId}`}`,n=new Set;(e.sources||new Map).forEach((e=>{e&&n.add(e.state.type)})),await Promise.all(Array.from(n).map((e=>(0,A.initLineTool)(e)))),(0,ai.perfMeasureOperation)(o,(()=>this._withoutInvalidating((()=>{(e.sources||new Map).forEach(((e,o)=>{try{this._restoreLineDTO(e,o,r,s,t,i)}catch(e){yi.logError(`Error restoring line tool ${o}: ${e}`)}})),(e.groups||new Map).forEach(((e,t)=>{this._invalidatedLineToolGroups.delete(t)})),this._recalculateHasChanges()}))))}_withoutInvalidating(e){try{return this._ignoreInvalidatingEventsDepth++,e()}finally{this._ignoreInvalidatingEventsDepth--}}_invalidateLineToolOrStudyStub(e,t,i){var s;if(this._ignoreInvalidatingEventsDepth>0&&!i)return;const r=null===(s=this._invalidatedLineToolsAndStudyStubs.get(e))||void 0===s?void 0:s.invalidatedViaSyncOnly,o=(void 0===r||r)&&this.invalidateViaSync();this._invalidatedLineToolsAndStudyStubs.set(e,{timestamp:t,invalidatedViaSyncOnly:o}),this._hasChanges.setValue(!0),this._debouncedSave()}_invalidateLineToolGroup(e,t,i){this._ignoreInvalidatingEventsDepth>0&&!i||(this._invalidatedLineToolGroups.set(e,{timestamp:t,invalidatedViaSyncOnly:this.invalidateViaSync()}),this._hasChanges.setValue(!0),this._debouncedSave())}_prepareDTOItem(e,t){const i=new Map,s=new Map,o=[],n=[];return this._invalidatedLineToolsAndStudyStubs.forEach(((n,a)=>{var l,c;if(0!==t&&n.invalidatedViaSyncOnly)return void o.push(a);const h=this._chartModel.dataSourceForId(a);if((0,fi.isStudyLineToolStub)(h))return;const d=()=>{var e;this._doNotSaveSharedLineToolsToCharts.value()&&0===t&&(null===(e=this._originalLineToolSharingMode.get(a))||void 0===e?void 0:e.duplicatedInChart)&&i.set(a,null)};if(null===h){((null===(l=this._originalLineToolSharingMode.get(a))||void 0===l?void 0:l.sharingMode)===t||0===t&&!this._doNotSaveSharedLineToolsToCharts.value())&&i.set(a,null),d()}else{if(h===this._chartModel.lineBeingCreated()||h===this._chartModel.lineBeingEdited()||!h.isSavedInChart())return;const o=h.ownerSource()===this._chartModel.mainSeries(),n=!e||o,l=h.sharingMode().value()===t||0===t&&!this._doNotSaveSharedLineToolsToCharts.value();if(n){const e=this._chartModel.lineToolsGroupModel().groupForLineTool(h);if(l)i.set(a,function(e,t){const i=t.lineToolsGroupModel().groupForLineTool(e),s={id:e.id(),ownerSource:(0,r.ensureNotNull)(e.ownerSource()).id(),state:e.state(!1)};return e.boundToSymbol()&&(s.symbol=e.symbol()),s.currencyId=e.properties().childs().currencyId.value(),s.unitId=e.properties().childs().unitId.value(),null!==i&&(s.groupId=i.id),s}(h,this._chartModel)),null!==e&&s.set(e.id,Ci(e,this._chartModel));else{const r=null===(c=this._originalLineToolSharingMode.get(a))||void 0===c?void 0:c.sharingMode;r===t&&i.set(a,null),null!==e&&r===t&&s.set(e.id,null)}}0!==h.sharingMode().value()&&d()}})),this._invalidatedLineToolGroups.forEach(((e,i)=>{
if(0!==t&&e.invalidatedViaSyncOnly)n.push(i);else if(!s.has(i)){const e=this._chartModel.lineToolsGroupModel().groupForId(i);if(null===e)s.set(i,null);else{(e.sharingMode().value()===t||0===t&&!this._doNotSaveSharedLineToolsToCharts.value())&&s.set(i,Ci(e,this._chartModel))}}})),{sources:i,groups:s,clientId:this._generateOrigin(),lineToolsToValidate:Array.from(i.keys()).concat(o),groupsToValidate:Array.from(s.keys()).concat(n)}}_setOriginalLineToolSharingMode(e,t){t?this._originalLineToolSharingMode.set(e,t):this._originalLineToolSharingMode.delete(e)}_setOriginalLineToolGroupsSharingMode(e,t){t?this._originalLineToolGroupsSharingMode.set(e,t):this._originalLineToolGroupsSharingMode.delete(e)}_sharingModesToUse(){return this._saveSharedLineTools.value()?[0,1,2]:[0]}_loadAndMergeLineToolsOnStudies(e,t){const i={requestType:"studiesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),sharingMode:e},s=this._chartModel.mainSeries();this._makeLoadRequestAndMerge(i,(i=>{const r=t?(0,ni.default)(Array.from(this._allLineToolsAndStudyStubs.values()).map((e=>Array.from(e.keys())))).filter((e=>!i(e))):[];this._unloadLineTools(r,(e=>e.ownerSource()!==s),e)}))}_loadAndMergeLineToolsWithoutSymbol(e,t){const i={requestType:"lineToolsWithoutSymbol",seriesSourceId:this._chartModel.mainSeries().id(),sharingMode:e},s=this._chartModel.mainSeries(),o=(0,r.ensureNotNull)(this._chartModel.paneForSource(s)),n=this._allLineToolsAndStudyStubs.get(o.id());this._makeLoadRequestAndMerge(i,(i=>{const r=t&&n?Array.from(n.keys()).filter((e=>!i(e))):[];this._unloadLineTools(r,(e=>!e.boundToSymbol()&&e.ownerSource()===s),e)}))}_recalculateHasChanges(){const e=Array.from(this._invalidatedLineToolsAndStudyStubs.values()).some((e=>!e.savedToChartContent)),t=Array.from(this._invalidatedLineToolGroups.values()).some((e=>!e.savedToChartContent));this._hasChanges.setValue(e||t)}_applyToolsAndGroupsDTOToNonDeserializedCharts(e,t){var i,s;if(null!==e.sources&&0===t&&this._duplicateOperationsForSerializedCharts()&&this._deserializedChartsIds().length>0){const t=new Map;for(const[r,o]of e.sources)null!==o&&"_seriesId"===o.ownerSource&&0!==wi(null===(i=this._originalLineToolSharingMode.get(r))||void 0===i?void 0:i.sharingMode)&&0===wi(o.state.sharingMode)?t.set(r,null):(null===o&&0!==wi(null===(s=this._originalLineToolSharingMode.get(r))||void 0===s?void 0:s.sharingMode)||null!==o&&"_seriesId"===o.ownerSource&&0!==wi(o.state.sharingMode))&&t.set(r,o);if(t.size>0){const i={groups:new Map,sources:t,clientId:e.clientId};for(const e of this._deserializedChartsIds()){const t=this._savingExternalChartsAbortControllers.get(e);t&&t.abort();const s=new AbortController;this._savingExternalChartsAbortControllers.set(e,s),(0,r.ensureNotNull)(this._saveChartService).saveChartLineTools(e,i,0,s.signal).catch((e=>{}))}}}}_generateOrigin(){return`${this._origin.layoutId}/${this._origin.chartId}/${this._origin.clientId}`}}var Ii=i(74439),Li=i(125226),ki=i(709404),Ai=i(405117),Ei=i(552279),Di=i(412304),Bi=i(147675),Ri=i(786559);const Ni=n.t(null,void 0,i(123536))
;function Vi(e){if("replaced_to_exchange"===e.type)return{text:Ni,warningIcon:Ri,warningType:"notaccurate",solutionId:Di.solutionIds.WHAT_IS_CBOE_BZX_EXCHANGE}}class Oi{constructor(e){this._activeHint=null,this._deferredPromise=null,this._chart=e;e.model().mainSeries().dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved)}destroy(){this._destroyActiveHint();this._chart.model().mainSeries().dataEvents().symbolResolved().unsubscribe(this,this._onSymbolResolved)}_destroyActiveHint(){null!==this._activeHint&&(this._activeHint.destroy(),this._activeHint=null),this._deferredPromise=null}async _createHint(){if(null===this._deferredPromise){const e=(0,d.createDeferredPromise)();this._deferredPromise=e,Promise.all([i.e(32109),i.e(6209),i.e(28497),i.e(50690),i.e(83129)]).then(i.bind(i,629981)).then((t=>{e.resolve(new t.ChartWarningHintRenderer(this._chart))}))}return this._deferredPromise.promise}_onSymbolResolved(e){const t=function(e){const t=(0,Bi.firstReplacedByBatsExchange)(e);return null!==t?{type:"replaced_to_exchange",exchange:t}:null}(e),i=t&&function(e){return`warning.noSubsc_${e.exchange}`}(t);if(null===t||null===i||Boolean(c.getBool(i)))return void this._destroyActiveHint();const s={...Vi(t),onClose:()=>{c.setValue(i,!0,{forceFlush:!0}),this._destroyActiveHint()}};null!==this._activeHint?this._activeHint.show(s):this._createHint().then((e=>{this._activeHint=e,this._activeHint.show(s)}))}}var Fi=i(33900);i(586463);const Wi=n.t(null,void 0,i(858018));class zi{constructor(e){this._lastResolvedSymbol=null,this._chart=e,this._chart.withModel(this,this._connectToModel)}show(){const e=this._getSymbol(),t=this._chart.defaultSymbol(),i=this._getProSymbol(),s=new URL("https://www.tradingview.com/chart/");s.searchParams.append("symbol",i),s.searchParams.append("utm_source","www.tradingview.com"),s.searchParams.append("utm_medium","widget"),s.searchParams.append("utm_campaign","chart"),s.searchParams.append("utm_term",i),(0,Fi.createNoticeDialog)({content:Wi.format({linkStart:`<a target="_blank" href="${s.toString()}">`,linkEnd:"</a>"})}).then((i=>{i.on("destroy",(()=>{let i;i=this._lastResolvedSymbol?this._lastResolvedSymbol:t!==e?t:"AAPL",this._chart.setSymbol(i)})),i.open()}))}_getProSymbol(){return this._chart.model().mainSeries().proSymbol()}_getSymbol(){return this._chart.model().mainSeries().actualSymbol()}_connectToModel(){const e=this._chart.model().mainSeries();e.dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved),e.dataEvents().symbolGroupNotPermitted().subscribe(this,this._onSymbolGroupNotPermitted),e.dataEvents().symbolNotPermitted().subscribe(this,this.show)}_onSymbolResolved(){this._lastResolvedSymbol=this._getSymbol()}_onSymbolGroupNotPermitted(){this.show()}}class Hi{constructor(){this._session={startDate:(new Date).toISOString(),url:window.location.href,entries:[]}}addPersistentLogEntry(e,t,i){this._session.entries.push({date:(new Date).toISOString(),level:t,message:e,category:i})}async getLastSessions(e){return[this._session]}pendingEntries(){return this._session.entries}}
var Ui=i(986738),Gi=i(444331),qi=i(731042);class ji{constructor(){this._draggingSource=null,this._activeTouchPanes=new Set,this._scrollingPane=null,this._pinchingPane=null}onPaneDestroyed(e){this._activeTouchPanes.delete(e),this._scrollingPane===e&&(this._scrollingPane=null),this._pinchingPane===e&&(this._pinchingPane=null)}startTouch(e){this._activeTouchPanes.add(e)}endTouch(e){this._activeTouchPanes.delete(e)}hasTouchesOnOtherPanes(e){return this._activeTouchPanes.size>1||1===this._activeTouchPanes.size&&!this._activeTouchPanes.has(e)}trySetDraggingSource(e,t){return!this.hasTouchesOnOtherPanes(t)&&((0,r.assert)(null===this._draggingSource||this._draggingSource===e),this._draggingSource=e,!0)}clearDraggingSource(){null!==this._draggingSource&&(this._draggingSource=null)}draggingSource(){return this._draggingSource}setScrollingPane(e){(0,r.assert)(null===e||null===this._scrollingPane||this._scrollingPane===e),this._scrollingPane=e}scrollingPane(){return this._scrollingPane}setPinchingPane(e){(0,r.assert)(null===e||null===this._pinchingPane||this._pinchingPane===e),this._pinchingPane=e}pinchingPane(){return this._pinchingPane}}let Yi=null;var Ki=i(370552);function Xi(e,t,s,r,o){return Promise.all([i.e(70166),i.e(44636),i.e(88601),i.e(33038),i.e(90674),i.e(36100),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(36884),i.e(46036),i.e(68992),i.e(87845),i.e(26855),i.e(58056),i.e(13152),i.e(21625),i.e(84281),i.e(91033),i.e(61631),i.e(90684),i.e(49205),i.e(40866),i.e(99916),i.e(43610),i.e(73954),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(98149),i.e(77807),i.e(89434),i.e(8740),i.e(58289),i.e(22486),i.e(24215),i.e(43445),i.e(12494),i.e(18511),i.e(26053),i.e(21895),i.e(22333),i.e(54474),i.e(15886),i.e(36740),i.e(75058),i.e(85256),i.e(18182),i.e(73606),i.e(24534),i.e(14127),i.e(88506),i.e(47391),i.e(61455),i.e(50690),i.e(30979),i.e(26300),i.e(29594),i.e(57413),i.e(67209),i.e(31142),i.e(85841),i.e(37457),i.e(68985),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(44111),i.e(85871),i.e(93656),i.e(81245),i.e(60807),i.e(46265)]).then(i.bind(i,816407)).then((i=>{const n=new(0,i.EditObjectDialogRenderer)(e,t,r,o);return n.show(s),n}))}let $i=null;var Zi=i(224153),Qi=i(364615);const Ji={[pt.TabNames.symbol]:"symbol",[pt.TabNames.legend]:"legend",[pt.TabNames.scales]:"scales",[pt.TabNames.trading]:"trading",[pt.TabNames.events]:"events",[pt.TabNames.eventsAndAlerts]:"events",[pt.TabNames.timezoneSessions]:"canvas",[pt.TabNames.text]:"text",[pt.TabNames.style]:"style",[pt.TabNames.visibility]:"visibility"},es={[pt.TabNames.style]:"style",[pt.TabNames.visibility]:"visibilities"};async function ts(e,t,s={},r,o){const n=r.activeChartWidget.value(),{initialTab:a,tabName:l}=s;if(l&&!a&&(s.initialTab=es[l]),(0,A.isStudyLineTool)(e)&&function(e){return[Zi.LineToolVbPFixed,Qi.LineToolAnchoredVolumeProfile].filter(S.notNull).some((t=>e instanceof t))
}(e))return n.propertiesDefinitionsForSource(e).then((i=>null!==i?Xi(e,t,s,o,i):null));if((0,D.isStudy)(e)&&function(e){const{shortId:t}=e.metaInfo();return"Overlay"===t}(e)||(0,A.isLineTool)(e))return n.propertiesDefinitionsForSource(e).then((r=>{if(null!==r){return function(e){return Promise.all([i.e(70166),i.e(44636),i.e(88601),i.e(90674),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(36884),i.e(46036),i.e(68992),i.e(87845),i.e(26855),i.e(58056),i.e(13152),i.e(21625),i.e(84281),i.e(91033),i.e(61631),i.e(90684),i.e(40866),i.e(99916),i.e(43610),i.e(73954),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(98149),i.e(77807),i.e(89434),i.e(8740),i.e(58289),i.e(22486),i.e(24215),i.e(43445),i.e(18511),i.e(26053),i.e(21895),i.e(22333),i.e(54474),i.e(15886),i.e(36740),i.e(75058),i.e(85256),i.e(18182),i.e(73606),i.e(24534),i.e(14127),i.e(88506),i.e(47391),i.e(98904),i.e(50690),i.e(30979),i.e(26300),i.e(29594),i.e(57413),i.e(67209),i.e(31142),i.e(85841),i.e(37457),i.e(68985),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(44111),i.e(85871),i.e(93656),i.e(81245),i.e(60807),i.e(46780)]).then(i.bind(i,757381)).then((t=>{const i=new(0,t.SourcePropertiesEditorRenderer)(e);return null!==$i&&$i.hide(),i.show({shouldReturnFocus:e.shouldReturnFocus}),$i=i,i}))}({propertyPages:r,model:t,source:e,activePageId:l&&Ji[l],shouldReturnFocus:s.shouldReturnFocus})}return null}));if((0,D.isStudy)(e)&&!(0,ct.isLollipopDataSource)(e))return Xi(e,t,s,o);{const t=(0,ct.isLollipopDataSource)(e)?"events":l&&Ji[l],i=r.getChartPropertiesDialogRenderer();return i.setActivePage(t),i.show(s)}}var is=i(15458),ss=i(560420),rs=i(792795),os=i(826989),ns=i(254355);class as{constructor(e,t){this._showed=!1,this._cw=e,this._element=document.createElement("div"),this._element.classList.add(ns.screen),t.appendChild(this._element),this._cw.withModel(this,this._connectToModel)}show(e){if(e){const e=this._cw.model().mainSeries().status();if(1!==e&&2!==e)return}this._cw.setInLoadingState(!0),this._showed||(this._showed=!0,this._show())}hide(){this._cw.setInLoadingState(!1),this._showed&&this._hide()}isShown(){return this._showed}_connectToModel(){const e=this._cw.model().mainSeries().dataEvents();e.symbolError().subscribe(this,(e=>{e!==os.permissionDenied&&this.hide()})),e.seriesError().subscribe(this,(()=>{(0,Ee.enabled)("hide_loading_screen_on_series_error")&&this.hide()})),e.completed().subscribe(this,this.hide)}_show(){const e=this._cw.properties().childs().paneProperties.childs();let t;if(e.backgroundType.value()===rs.ColorType.Solid)t=e.background.value();else{t=`linear-gradient(${e.backgroundGradientStartColor.value()},${e.backgroundGradientEndColor.value()})`}this._element.style.background=t,this._element.classList.add(ns.fade)}_hide(){this._showed=!1,this._element.classList.remove(ns.fade)}}var ls=i(674981),cs=i(395098),hs=i(331633),ds=i(61499);const us=(0,
F.getHexColorByName)("color-cold-gray-700"),_s=(0,F.getHexColorByName)("color-cold-gray-400");class ps{constructor(e){this._container=null,this._errorCardRenderer=null,this._mainSeriesErrorMessage=null,this._banErrorMessage=new Se.WatchedValue(null).spawn(),this._errorMessageHandler=e=>{this._chartWidget.hasModel()?this._updatePaneWidgets(e):this._renderErrorWithoutModel(e)},this._chartWidget=e,this._subscribeToMainSeriesErrors()}destroy(){var e,t;null===(e=this._mainSeriesErrorMessage)||void 0===e||e.destroy(),this._banErrorMessage.destroy(),null===(t=this._errorCardRenderer)||void 0===t||t.then((e=>{e.container.remove(),e.destroy()}))}updatePaneWidgets(){this._updatePaneWidgets()}setContainer(e){var t;if(this._container!==e){this._container=e,null===(t=this._errorCardRenderer)||void 0===t||t.then((e=>e.container.remove()));const i=this._getErrorMessage();i&&this._errorMessageHandler(i)}}_updatePaneWidgets(e=this._getErrorMessage()){this._chartWidget.paneWidgets().forEach((t=>t.setErrorMessage(e)))}async _renderErrorWithoutModel(e){if(null===this._container||null===e&&null===this._errorCardRenderer)return;const t=await this._getErrorCardRenderer();this._container.contains(t.container)||this._container.appendChild(t.container),t.update(this._createErrorCardRendererState(e))}async _getErrorCardRenderer(){return this._errorCardRenderer||(this._errorCardRenderer=this._createErrorCardRenderer())}async _createErrorCardRenderer(){return new(await(0,St.getErrorCardRenderer)())}_createErrorCardRendererState(e){return e?{message:e.message,icon:e.icon,textColor:hs.watchedTheme.value()===ds.StdTheme.Dark?_s:us,backgroundColor:hs.watchedTheme.value()===ds.StdTheme.Dark?"#131722":"#FFF",solutionId:e.solutionId}:{message:null}}_subscribeToMainSeriesErrors(){const e=this._chartWidget;this._banErrorMessage=(0,v.combine)((e=>{if(!e)return null;let t;if("banned by ip"===e.reason)t=n.t(null,void 0,i(311884));else t=n.t(null,void 0,i(115078));return{message:t,solutionId:Di.solutionIds.WHY_IS_MY_ACCOUNT_BANNED,icon:"stop-hand"}}),window.ChartApiInstance.connectionBanInfo().weakReference()),this._banErrorMessage.subscribe(this._errorMessageHandler,{callWithLast:!0}),e.withModel(this,(()=>{const t=e.model().model().mainSeries();this._mainSeriesErrorMessage=(0,v.combine)(((e,t)=>{if(e)return e;switch(t){case"invalid_symbol":return{message:"Invalid symbol",icon:"ghost"};case"no_data":return{message:"No data here",icon:"ghost"};case null:return null}}),this._banErrorMessage.weakReference(),(0,Gi.getSeriesDisplayErrorWV)(t).ownership()),this._mainSeriesErrorMessage.subscribe(this._errorMessageHandler,{callWithLast:!0})}))}_getErrorMessage(){var e;return this._banErrorMessage.value()||(null===(e=this._mainSeriesErrorMessage)||void 0===e?void 0:e.value())||null}}var ms=i(62745),gs=i(354950),Ss=i.n(gs);async function vs(e,t,s,r,o,a="default"){let l,c=[];const h=e.model().model(),d=(0,S.clone)(t),u=new(Ss())({inputs:d}),_=function(e,t){return"symbol"===t?e.inputs.filter((t=>t.id===e.symbolInputId())):e.inputs.filter((e=>e.confirm))}(s,a),p=()=>{
l&&h.removeCustomSource(l)},m=()=>{p(),o()},g=e=>{r({inputs:e,parentSources:c}),p()},v=_.filter(ms.isTimeOrPriceNotHiddenInput);if(v.length>0)try{const t=await Promise.all([i.e(70166),i.e(44636),i.e(88601),i.e(58337),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(36884),i.e(68992),i.e(87845),i.e(26855),i.e(58056),i.e(13152),i.e(21625),i.e(84281),i.e(91033),i.e(61631),i.e(90684),i.e(40866),i.e(99916),i.e(43610),i.e(73954),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(77807),i.e(89434),i.e(8740),i.e(58289),i.e(24215),i.e(43445),i.e(18511),i.e(21895),i.e(22333),i.e(54474),i.e(15886),i.e(36740),i.e(73606),i.e(71762),i.e(50690),i.e(30979),i.e(26300),i.e(31142),i.e(37457),i.e(68985),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(44111),i.e(85871),i.e(53030)]).then(i.bind(i,280881)),r=await t.selectInputValuesOnChart(e,v,u,s.shortDescription,s.inputs);if(l=r.customSourceId,r.destPane){const e=r.destPane.mainDataSource();c=e===h.mainSeries()?[]:[e]}else c=[]}catch(e){return void m()}v.length!==_.length?Promise.all([i.e(70166),i.e(44636),i.e(88601),i.e(58337),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(36884),i.e(68992),i.e(87845),i.e(26855),i.e(58056),i.e(13152),i.e(21625),i.e(84281),i.e(91033),i.e(61631),i.e(90684),i.e(40866),i.e(99916),i.e(43610),i.e(73954),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(77807),i.e(89434),i.e(8740),i.e(58289),i.e(24215),i.e(43445),i.e(18511),i.e(21895),i.e(22333),i.e(54474),i.e(15886),i.e(36740),i.e(73606),i.e(71762),i.e(50690),i.e(30979),i.e(26300),i.e(31142),i.e(37457),i.e(68985),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(44111),i.e(85871),i.e(53030)]).then(i.bind(i,49294)).then((t=>{const r=new t.ConfirmInputsDialogRenderer(function(e){if("symbol"===e)return n.t(null,void 0,i(345743));return n.t(null,void 0,i(846689))}(a),_,u,a,s,e.model(),g,m);return r.show(),r})):g(u.state().inputs||{})}var fs=i(547944),bs=i(223699);var ys=i(42292),Cs=i(533422),ws=i(982217),Ps=i(539706),Ts=(i(237218),i(234271));const Ms=(0,a.getLogger)("ChartWidget",{color:"#606"}),xs=(0,Ee.enabled)("chart_content_overrides_by_defaults"),Is=new z.TranslatedString("hide {title}",n.t(null,void 0,i(470301)));let Ls=null;if(location.search.toLowerCase().includes("logcanvassaverestoreleaks")){if(!h.isChrome)throw new Error("CanvasRenderingContext2D save/restore leak detection is available for now in Chrome only");i.e(15803).then(i.bind(i,128151)).then((e=>{e.enableCanvasRenderingContext2DSaveRestoreLeaksDetection(),Ls=e.reportCanvasRenderingContext2DSaveRestoreLeaks}))}const ks={addToWatchlistEnabled:!0,showFinancialsEnabled:!1,sourceSelectionEnabled:!0,propertyPagesEnabled:!0,paneContextMenuEnabled:!0,priceScaleContextMenuEnabled:!0,
currencyConversionEnabled:!1,unitConversionEnabled:!1,goToDateEnabled:!1,marketStatusWidgetEnabled:!0,chartWarningWidgetEnabled:!0,dataProblemWidgetEnabled:!0,paneControlsEnabled:!0,isSymbolAvailable:e=>Promise.resolve(!0),legendWidgetEnabled:!0,chartEventsEnabled:!0,esdEnabled:!1,latestUpdatesEnabled:{news:!1,minds:!1},continuousContractSwitchesEnabled:!1,futuresContractExpirationEnabled:!1,croppedTickMarks:!0,countdownEnabled:!0,lastPriceAnimationEnabled:!0,useKineticScroll:h.CheckMobile.any(),indicatorsDialogShortcutEnabled:!0,handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!0}},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!0}};function As(e,t,i,s=0){const r=t.mainSeries().syncModel(),o=e.mainSeries().syncModel();let n=i;if(null!==r&&null!==o){const t=e.createSyncPoint(r.syncSourceTarget(),o.syncSourceTarget());0!==s&&(i=r.projectTime(i,s)),n=t.sourceTimeToTargetTime(i)}return e.timeScale().points().roughIndex(n,o&&o.distance.bind(o))}const Es=["Overlay@tv-basicstudies","CorrelationCoefficient@tv-basicstudies","Correlation Coeff@tv-basicstudies","Spread@tv-basicstudies","Ratio@tv-basicstudies"];class Ds{constructor(e,t,s){this.activePaneWidget=null,this._model=null,this._paneWidgets=[],this._maximizedPaneWidget=null,this._timeAxisWidget=null,this._paneSeparators=[],this._controlBarNavigation=null,this._lineToolsSynchronizer=null,this._modelCreated=new le.Delegate,this._isDestroyed=!1,this._customLegendWidgetsFactoryMap=new Map,this._backgroundTopTheme=new Se.WatchedValue("light"),this._backgroundBasedTheme=new Se.WatchedValue("light"),this._backgroundBottomTheme=new Se.WatchedValue("light"),this._lhsAxesWidth=0,this._rhsAxesWidth=0,this._lhsPriceAxisWidthChanged=new le.Delegate,this._rhsPriceAxisWidthChanged=new le.Delegate,this._mainDiv=null,this._parent=null,this._elTooltipDiv=null,this._hotkeysListener=null,this._mouseWheelHelper=null,this._onWheelBound=null,this._justActivated=!1,this._inited=!1,this._containsData=!1,this._initialLoading=!1,this._defTimeframe=void 0,this._removeMaximizeHotkey=null,this._metaInfoRepository=null,this._invalidationMask=null,this._drawPlanned=!1,this._drawRafId=0,this._inLoadingState=!1,this._timingsMeter=null,this._tagsChanged=new le.Delegate,this._redraw=new le.Delegate,this._isVisible=new Se.WatchedValue(!0),this._collapsed=new Se.WatchedValue(!1),this._dataWindowWidget=null,this._resizeHandler=null,this._spinner=null,this._keydownEventListener=null,this._properties=null,this._symbolWV=new Se.WatchedValue,this._resolutionWV=new Se.WatchedValue,this._updateThemedColorBound=this._updateThemedColor.bind(this),this._disconnected=new le.Delegate,this._reconnectBailout=new le.Delegate,this._connected=new le.Delegate,this._chartWidgetInitialized=new le.Delegate,this._saveChartService=null,this._objectTreeDialogController=null,this._chartPaintedPromise=null,this._noExchangeSubscrptionWarning=null,this._paneWidgetsSharedState=new ji,this._brokerName="",this._onZoom=new le.Delegate,this._onScroll=new le.Delegate,
this._availableScreen=null,this._hoveredPriceAxes=new Set,this._anyAxisHovered=new Se.WatchedValue(!1),this._linkingGroupIndex=new Se.WatchedValue(null),this._showDataWindowAction=null,this._activeHint=null,this._hintDefferedPromise=null,this._setSymbolIntervalContentOverrides={},this._invalidationHandler=e=>{if(!(e instanceof R.InvalidationMask))throw new Error("Invalid mask");null!==this._invalidationMask?this._invalidationMask.merge(e):this._invalidationMask=e,this._drawPlanned||(this._drawPlanned=!0,this._options.visible.when((()=>{const e=!document.hidden,t=this.screen&&this.screen.isShown();null!==this._timingsMeter&&e&&!t&&this._timingsMeter.startWaitingDraw();const i=(0,r.ensureNotNull)((0,r.ensureNotNull)(this._parent).ownerDocument.defaultView);this._drawRafId=i.requestAnimationFrame(this._invalidationRAFCallback.bind(this))})))},this._onChartSessionIsConnectedChanged=e=>{e?this._onConnection():this._onDisconnect()},this._subscribeToBanInfo=e=>{var t,i;e?null===(t=this._spinner)||void 0===t||t.stop():null===(i=this._spinner)||void 0===i||i.spin()},this._id=t,this._layoutId=s,this._options=(0,S.merge)((0,S.clone)(ks),e),this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._subscribeToDrawingState(),this._chartWidgetCollection=this._options.chartWidgetCollection,this.withModel(this,(()=>{const e=this.model().model();e.backgroundTopColor().subscribe(this._updateThemedColorBound),e.backgroundColor().subscribe(this._updateThemedColorBound)})),this._errorRenderer=new ps(this),this._scrollHelper=new ri(this),this._objectTreeDialogController=m.getInstance(),this._properties=new B.DefaultProperty("chartproperties",void 0,void 0,this._options.useUserChartPreferences),this._properties.addExclusion("scalesProperties.axisHighlightColor"),this._properties.addExclusion("scalesProperties.axisLineToolLabelBackgroundColorActive"),this._properties.addExclusion("scalesProperties.axisLineToolLabelBackgroundColorCommon"),this._properties.addExclusion("scalesProperties.showPriceScaleCrosshairLabel"),this._properties.addExclusion("scalesProperties.showTimeScaleCrosshairLabel"),this._properties.addExclusion("scalesProperties.crosshairLabelBgColorLight"),this._properties.addExclusion("scalesProperties.crosshairLabelBgColorDark"),this._startSpinner(this._options.container.value()),window.ChartApiInstance.connectionBanInfo().subscribe(this._subscribeToBanInfo,{callWithLast:!0}),this._chartSession=new Ui.ChartSession(window.ChartApiInstance),this._metaInfoRepository=new I(this._chartSession),this._isMultipleLayout=(0,v.combine)((e=>(0,Cs.isMultipleLayout)(e)),this._chartWidgetCollection.layout.weakReference()),(0,h.onWidget)()||(this._persistentLogSwitcher=new mi.FeatureToggleWatchedValue("support_persistent_logs",!1),this._persistentLogSwitcher.subscribe((async e=>{var t;if(e){if((0,Ts.getPersistentLogger)())return;(0,Ts.setPersistentLogger)(new Hi);const{initPersistentLogger:e}=await i.e(94882).then(i.bind(i,327629))
;(null===(t=this._persistentLogSwitcher)||void 0===t?void 0:t.value())?e():(0,Ts.setPersistentLogger)(null)}else(0,Ts.setPersistentLogger)(null)}),{callWithLast:!0}))}destroy(){var e,t,i;null===(e=this._lineToolsSynchronizer)||void 0===e||e.destroy(),null===(t=this._noExchangeSubscrptionWarning)||void 0===t||t.destroy(),window.loginStateChange.unsubscribe(this,this._handleLoginStateChanged),null!==this._model&&(this._model.model().backgroundTopColor().unsubscribe(this._updateThemedColorBound),this._model.model().backgroundColor().unsubscribe(this._updateThemedColorBound),this._model.destroy()),window.ChartApiInstance.connectionBanInfo().unsubscribe(this._subscribeToBanInfo),this._customLegendWidgetsFactoryMap.clear(),this._scrollHelper.destroy(),this._errorRenderer.destroy(),this._chartSession.criticalError().unsubscribe(this,this._onChartSessionCriticalError),this._chartSession.isConnected().unsubscribe(this._onChartSessionIsConnectedChanged),this._chartSession.destroy(),null===(i=this._persistentLogSwitcher)||void 0===i||i.destroy(),this._isDestroyed=!0}emulateCriticalError(){this._chartSession.removeSeries("-1")}chartSession(){return this._chartSession}onDisconnected(){return this._disconnected}onReconnectBailout(){return this._reconnectBailout}onConnected(){return this._connected}chartWidgetInitialized(){return this._chartWidgetInitialized}setVisibleTimeRange(e,t,i,s){throw new Error("Not implemented")}fullSourceId(e){return{layoutId:this.layoutId(),chartId:this.id(),sourceId:e.id()}}lineToolsSynchronizer(){return this._lineToolsSynchronizer}requestFullscreen(){this.getResizerDetacher().requestFullscreen()}exitFullscreen(){this.getResizerDetacher().exitFullscreen()}inFullscreen(){return this.getResizerDetacher().fullscreen.value()}model(){return(0,r.ensureNotNull)(this._model)}id(){return this._id}layoutId(){return this._layoutId}crossHairSyncEnabled(){return this._chartWidgetCollection.lock.crosshair.value()}isVisible(){return this._isVisible.value()}setVisible(e){this._isVisible.setValue(e)}setCollapsed(e){this._collapsed.setValue(e)}isJustClonedChart(){return!!(this._options||{}).justCloned}getSymbol(e){var t,i,s,r;let o;return o=this._model?this._model.mainSeries().properties().childs():this.properties().childs().mainSeriesProperties.childs(),o?e&&o.shortName&&o.shortName.value()?null!==(i=null===(t=o.shortName)||void 0===t?void 0:t.value())&&void 0!==i?i:"":null!==(r=null===(s=o.symbol)||void 0===s?void 0:s.value())&&void 0!==r?r:"":""}setSymbol(e){this._model?(this._symbolWV.setValue(e),this._model.setSymbol(this._model.mainSeries(),e)):(this.properties().childs().mainSeriesProperties.merge({symbol:e}),this._symbolWV.setValue(e),this._setSymbolIntervalContentOverrides.symbol=e)}setResolution(e){this._model?(this._resolutionWV.setValue(e),this._model.setResolution(this._model.mainSeries(),e)):(this.properties().childs().mainSeriesProperties.merge({interval:e}),this._resolutionWV.setValue(e),this._setSymbolIntervalContentOverrides.interval=e)}getResolution(){
return this._model?this._model.mainSeries().properties().childs().interval.value():this.properties().childs().mainSeriesProperties.childs().interval.value()}symbolWV(){return this._symbolWV.readonly()}resolutionWV(){return this._resolutionWV.readonly()}loadRange(e){if(this._model){this.screen.show();this._model.loadRange(e)||this.screen.hide()}}async showGeneralChartProperties(e,t){if(!Ee.enabled("show_chart_property_page"))return Promise.resolve(null);const s=await this._showChartProperties(this.model().mainSeries(),e,{doNotCloseOnBgClick:!0,onResetToDefault:async()=>{this.model().restorePreferences();const e=await i.e(83767).then(i.bind(i,429874)),t=e.getCurrentTheme().name;e.loadTheme(this.chartWidgetCollection(),{themeName:t,standardTheme:!0})},shouldReturnFocus:null==t?void 0:t.shouldReturnFocus});if(null===s)return null;const r=()=>{s.hide(),this._chartWidgetCollection.activeChartWidget.unsubscribe(r)};return this._chartWidgetCollection.activeChartWidget.subscribe(r),s}showChartPropertiesForSource(e,t,i,s){return Ee.enabled("property_pages")&&e.userEditEnabled()?e===this.model().model().mainSeries()?this.showGeneralChartProperties(t):((i=i||{}).onResetToDefault=()=>{((0,A.isLineTool)(e)||(0,D.isStudy)(e))&&this.model().restorePropertiesForSource.bind(this._model,e)},this._showChartProperties(e,t,i,s)):Promise.resolve(null)}async showChartPropertiesForSources(e){if(!(0,Ee.enabled)("property_pages"))return Promise.resolve(null);const{sources:t,title:s,tabName:o,renamable:a}=e,l=(0,r.ensureNotNull)(this._model),c=ti(t.map((e=>e.properties().childs()))),h=ti(t.map((e=>e.properties().childs().intervalsVisibilities))),[{createPropertyPage:d},{getSelectionStylePropertiesDefinitions:u},{getSelectionIntervalsVisibilitiesPropertiesDefinition:_},{getSelectionCoordinatesPropertyDefinition:p}]=await Promise.all([Promise.all([i.e(33038),i.e(15913),i.e(25900),i.e(56386),i.e(18537)]).then(i.bind(i,402417)),Promise.all([i.e(33038),i.e(15913),i.e(25900),i.e(56386),i.e(18537)]).then(i.bind(i,136172)),Promise.all([i.e(33038),i.e(15913),i.e(25900),i.e(56386),i.e(18537)]).then(i.bind(i,46622)),Promise.all([i.e(33038),i.e(15913),i.e(25900),i.e(56386),i.e(18537)]).then(i.bind(i,678904))]);return async function(e){
const{SourcesPropertiesEditorRenderer:t}=await Promise.all([i.e(70166),i.e(44636),i.e(88601),i.e(90674),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(38669),i.e(35649),i.e(5145),i.e(88194),i.e(89842),i.e(30006),i.e(25190),i.e(93502),i.e(72639),i.e(32109),i.e(36884),i.e(46036),i.e(68992),i.e(87845),i.e(26855),i.e(58056),i.e(13152),i.e(21625),i.e(84281),i.e(91033),i.e(61631),i.e(90684),i.e(40866),i.e(99916),i.e(43610),i.e(73954),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(98149),i.e(77807),i.e(89434),i.e(8740),i.e(58289),i.e(22486),i.e(24215),i.e(43445),i.e(18511),i.e(26053),i.e(21895),i.e(22333),i.e(54474),i.e(15886),i.e(36740),i.e(75058),i.e(85256),i.e(18182),i.e(73606),i.e(24534),i.e(14127),i.e(88506),i.e(47391),i.e(98904),i.e(50690),i.e(30979),i.e(26300),i.e(29594),i.e(57413),i.e(67209),i.e(31142),i.e(85841),i.e(37457),i.e(68985),i.e(15277),i.e(37070),i.e(50186),i.e(46491),i.e(44111),i.e(85871),i.e(93656),i.e(81245),i.e(60807),i.e(46780)]).then(i.bind(i,578569)),s=new t(e);return null!==Yi&&(Yi.hide(),Yi=s),s.show(),s}({sources:t,propertyPages:[d(u(c,l),"style",n.t(null,void 0,i(832733))),d({definitions:[p(t,l)]},"displacement",n.t(null,void 0,i(962764))),d(_(h,l),"visibility",n.t(null,void 0,i(221852)))],undoModel:l,title:s,activeTabId:o,renamable:a})}getPriceAxisWidthChangedByName(e){return"left"===e?this._lhsPriceAxisWidthChanged:this._rhsPriceAxisWidthChanged}getPriceAxisMaxWidthByName(e){return"left"===e?this._lhsAxesWidth:this._rhsAxesWidth}timeAxisHeight(){return null!==this._timeAxisWidget?this._timeAxisWidget.size.height:0}withModel(e,t){null!==this._model?t.call(e):this.modelCreated().subscribe(e,t,!0)}hasModel(){return null!==this._model}onRedraw(){return this._redraw}copyLineToOtherCharts(){const e=(0,r.ensureNotNull)(this._model),t=e.selection().lineDataSources().filter((e=>e.isSynchronizable()));e.model().copyToOtherCharts(t,!0)}hideDataSources(e){if(e.length){const t=e.map((e=>e.properties().visible)),i=e.map((()=>!1));this.model().setProperties(t,i,Is.format({title:new z.TranslatedString(e[0].name(),e[0].title(ws.TitleDisplayTarget.StatusLine))}))}}hideSelectedObject(){this.hideDataSources(this.model().selection().dataSources().filter((e=>!(0,ve.isAlertLabel)(e))))}unlinkSelectedLine(){const e=(0,r.ensureNotNull)(this._model),t=e.selection().lineDataSources();e.unlinkLines(t)}selectPointMode(){return(0,r.ensureNotNull)(this._model).model().selectPointMode()}cancelRequestSelectPoint(){const e=(0,r.ensureNotNull)(this._model);e.model().cancelRequestSelectPoint(),e.model().setReplayStatus(Ii.ReplayStatus.Undefined),this.model().model().clearCurrentPosition()}requestSelectPoint(e,t){const i=(0,r.ensureNotNull)(this._model);return e.selectPointMode===K.SelectPointMode.Replay&&i.model().setReplayStatus(Ii.ReplayStatus.PointSelect),new Promise(((s,r)=>{const o=()=>!!this.isVisible()||(r("Chartwidget must be visible"),this.cancelRequestSelectPoint(),!1);if(!o())return;(0,K.resetToCursor)(!0),
i.lineBeingCreated()&&i.cancelCreatingLine();let n=!1;const a={};i.model().onPointSelected().subscribe(a,((e,t)=>{n=!0,this._isVisible.unsubscribe(o),this._hideHint(),s({point:e,pane:t})}),!0),i.model().requestSelectPoint(e),this.startTrackingMode(),void 0!==t&&this._showHint(t),this._isVisible.subscribe(o),this.selectPointMode().subscribe((()=>{setTimeout((()=>{n||(this.selectPointMode().value()===K.SelectPointMode.None&&this._hideHint(),i.model().onPointSelected().unsubscribeAll(a),this._isVisible.unsubscribe(o),r("cancelled"))}))}),{once:!0})}))}onScroll(){return this._onScroll}onZoom(){return this._onZoom}images(e){window.TradingView.printing=!0;const t=this.model().selection().allSources();this.model().selectionMacro((e=>e.clearSelection())),this.model().model().recalculateAllPanes((0,Ct.globalChangeEvent)());const i=(t,i)=>{t.paint(i);const s={showCollapsedStudies:Boolean(null==e?void 0:e.showCollapsedStudies),status:null==e?void 0:e.status};return t.getScreenshotData(s)},s=[];if(null!==this._maximizedPaneWidget){const e=this._paneWidgets.indexOf(this._maximizedPaneWidget);s.push(i(this._maximizedPaneWidget,R.InvalidationMask.light().invalidateForPane(e)))}else for(let e=0;e<this._paneWidgets.length;++e){const t=this._paneWidgets[e];s.push(i(t,R.InvalidationMask.light().invalidateForPane(e))),e<this._paneWidgets.length-1&&s.push(this._paneSeparators[e].image())}let r;this._timeAxisWidget&&(this._timeAxisWidget.paint(R.InvalidationLevel.Light),r=this._timeAxisWidget.getScreenshotData()),window.TradingView.printing=!1,this.model().selectionMacro((e=>{t.forEach((t=>{e.addSourceToSelection(t)}))})),this.model().model().recalculateAllPanes((0,Ct.globalChangeEvent)()),this.model().model().lightUpdate();const o=this.mainSeriesQuotesAndMetainfo();return{panes:s,timeAxis:r,colors:{text:this.properties().childs().scalesProperties.childs().textColor.value(),bg:this.properties().childs().paneProperties.childs().background.value(),scales:this.properties().childs().scalesProperties.childs().lineColor.value()},meta:o.meta,ohlc:o.ohlc,quotes:o.quotes}}insertStudy(e,t,i,s){return new Promise((r=>{0!==t.length?window.runOrSignIn((()=>{r(this._insertStudy(e,t,i,s))}),{source:"study on study"}):r(this._insertStudy(e,t,i,s))})).catch((()=>null))}addOverlayStudy(e,t,i){const s=this.model();return this._options&&this._options.isSymbolAvailable?this._options.isSymbolAvailable(e).then((r=>{if(!r)return null;const o=s.createStudyInserter({type:"java",studyId:"Overlay@tv-basicstudies"},[]),n={allowExtendTimeScale:i};if(Ee.enabled("use_overrides_for_overlay")){const e=(0,ys.factoryDefaults)("study_Overlay@tv-basicstudies.style");n.style=e}return o.setPropertiesState(n),o.setForceOverlay(t),o.insert((()=>Promise.resolve({inputs:{symbol:e},parentSources:[]})))})):Promise.resolve(null)}addCompareStudy(e){const t=this.model();return this._options&&this._options.isSymbolAvailable?this._options.isSymbolAvailable(e).then((i=>i?t.createStudyInserter({type:"java",studyId:"Compare@tv-basicstudies"},[]).insert((()=>Promise.resolve({inputs:{symbol:e
},parentSources:[]}))):null)):Promise.resolve(null)}showIndicators(e,t){if(window.studyMarket)return window.studyMarket.visible().value()?void window.studyMarket.hide():(window.studyMarket.show(e,t),window.studyMarket)}setSaveChartService(e){this._saveChartService=e,null!==this._lineToolsSynchronizer&&this._lineToolsSynchronizer.setSaveChartService(e)}getSaveChartService(){return this._saveChartService}mainSeriesQuotesAndMetainfo(){let e,t,i;const s=this._model&&this._model.mainSeries();if(s){const r=e=>null==e?"":s.formatter().format(e,void 0,void 0,!0,!1)+"",o=e=>null==e?"":e+"";e={resolution:s.interval(),symbol:s.symbol(),values:s.valuesProvider().getValues(null)};const n=s.symbolInfo();n&&(e.symbol=n.full_name,e.description=n.description,e.exchange=n.exchange);const a=s.bars().last();null!==a&&(t=a.value.slice(1,5).map(r));const l=s.quotes();l&&(i={change:r(l.change),changePercent:o(l.change_percent),last:r(l.last_price)})}return{meta:e,ohlc:t,quotes:i}}isMultipleLayout(){return this._isMultipleLayout}updateCrossHairPositionIfNeeded(){if(this._model){const e=K.tool.value();this._model.model().setCurrentTool(e);const t=(0,H.lastMouseOrTouchEventInfo)();if(t.isTouch){const e=this._maximizedPaneWidget||this._paneWidgets[0];if(e.hasState()&&(!t.stylus&&(this._isLineToolModeExceptBrush()||(0,K.toolIsMeasure)(K.tool.value()))||this.selectPointMode().value()!==K.SelectPointMode.None)){const t=e.state(),i=.5*this._model.model().timeScale().width(),s=.5*t.defaultPriceScale().height();this._model.model().setAndSaveCurrentPosition(i,s,t)}}if(this._model&&t.isTouch){const e=this._model.model().crossHairSource();e.updateAllViews((0,Ct.sourceChangeEvent)(e.id()))}}}trackingModePaneWidget(){if(!(0,H.lastMouseOrTouchEventInfo)().isTouch)return null;for(const e of this.paneWidgets())if(e.trackingModeEnabled())return e;return null}startTrackingMode(){if((0,H.lastMouseOrTouchEventInfo)().isTouch){this.exitTrackingMode(),this.updateCrossHairPositionIfNeeded();const e=this._maximizedPaneWidget||this._paneWidgets[0],t=this.model().model().crossHairSource().currentPoint();e.startTrackingMode(t,t)}}exitTrackingMode(){(0,H.lastMouseOrTouchEventInfo)().isTouch&&this.paneWidgets().some((e=>e.trackingModeEnabled()))&&(this.paneWidgets().forEach((e=>e.exitTrackingMode())),this.model().model().clearCurrentPosition())}onToolChanged(){this.model().lineBeingCreated()&&this._cancelCreatingLine(),this.selectPointMode().value()!==K.SelectPointMode.None&&this.cancelRequestSelectPoint(),this.exitTrackingMode()}setInLoadingState(e){this._inLoadingState=e}paint(e){const t=null!=e?e:R.InvalidationMask.full();t.validationActions().forEach((e=>e())),this._paneWidgets.forEach(((e,i)=>{null!==this._maximizedPaneWidget&&this._maximizedPaneWidget!==e||e.paint(t.invalidateForPane(i))})),this._timeAxisWidget&&this._timeAxisWidget.paint(t.invalidateForTimeScale()),null==Ls||Ls(),this._redraw.fire()}GUIResetScales(){(0,ye.trackEvent)("GUI","Reset Scales"),null!==this._model&&this._model.resetScales()}toggleMaximizePane(e){var t;if(!(this._paneWidgets.length<2)){
this._maximizedPaneWidget?(this._maximizedPaneWidget.state().maximized().setValue(!1),this._maximizedPaneWidget=null,this._paneSeparators.forEach((e=>e.show()))):(this._maximizedPaneWidget=e,this._maximizedPaneWidget.state().maximized().setValue(!0),this._paneSeparators.forEach((e=>e.hide())));for(let e=this._paneWidgets.length;e--;)this._paneWidgets[e].updateControls(),this._paneWidgets[e].updatePriceAxisWidgetsStates();this._errorRenderer.updatePaneWidgets(),null===(t=this._timeAxisWidget)||void 0===t||t.updatePriceAxisStubs(),this._adjustSize(),this.updateCrossHairPositionIfNeeded()}}maximizedPaneWidget(){return this._maximizedPaneWidget}isMaximizedPane(){return null!==this._maximizedPaneWidget}unsetActivePaneWidget(){this.activePaneWidget=null}setActivePaneWidget(e){this.activePaneWidget=e}onPaneWidgetDestroyed(e){this.activePaneWidget===e&&(this.activePaneWidget=null)}backgroundTopTheme(){return this._backgroundTopTheme.readonly()}backgroundBasedTheme(){return this._backgroundBasedTheme.readonly()}backgroundBottomTheme(){return this._backgroundBottomTheme.readonly()}lineToolsAndGroupsDTO(){return(0,r.ensureNotNull)(this._lineToolsSynchronizer).prepareDTO()}resetLineToolsInvalidated(e,t,i){(0,r.ensureNotNull)(this._lineToolsSynchronizer).resetInvalidated(e,t,i)}applyLineToolUpdateNotification(e,t){(0,r.ensureNotNull)(this._lineToolsSynchronizer).applyLineToolUpdateNotification(e,t)}reloadAllLineTools(){(0,r.ensureNotNull)(this._lineToolsSynchronizer).reloadAllLineTools()}startApplyingLineToolUpdateNotification(){var e;null===(e=this._lineToolsSynchronizer)||void 0===e||e.startApplyingLineToolUpdateNotification()}endApplyingLineToolUpdateNotification(){var e;null===(e=this._lineToolsSynchronizer)||void 0===e||e.endApplyingLineToolUpdateNotification()}applyAlertIdByExternalSource(e,t){var i;null===(i=this._lineToolsSynchronizer)||void 0===i||i.applyAlertIdByExternalSource(e,t)}deleteAlertByExternalSource(e,t){var i;null===(i=this._lineToolsSynchronizer)||void 0===i||i.deleteAlertByExternalSource(e)}shouldBeSavedEvenIfHidden(){return this._model?this.model().model().shouldBeSavedEvenIfHidden():!!this._options.content.shouldBeSavedEvenIfHidden}showObjectsTreeDialog(){var e;null===(e=this._objectTreeDialogController)||void 0===e||e.show()}addCustomWidgetToLegend(e,t){this._customLegendWidgetsFactoryMap.set(e,t);for(const i of this.paneWidgets())i.addCustomWidgetToLegend(e,t)}applyIndicatorsToAllChartsAvailable(){if(!this.chartWidgetCollection().applyIndicatorsToAllChartsAvailable())return!1;for(const e of this.model().model().panes()){if(e.sourcesByGroup().all().some((e=>(0,D.isStudy)(e)&&!(0,ct.isLollipopDataSource)(e))))return!0}return!1}restoreState(e,t,s){this._adjustSize();const o=(0,r.ensureNotNull)(this._model),n=o.restoreState(this._content,t,s),a=o.mainSeries().properties().childs();this._symbolWV.setValue(a.symbol.value()),this._resolutionWV.setValue(a.interval.value()),this._setActions(),
n&&n.lines_limit_exceeded&&!this.readOnly()&&Promise.all([i.e(58755),i.e(36088),i.e(39843),i.e(34873),i.e(33371),i.e(54712),i.e(25977),i.e(90940),i.e(11595),i.e(60505),i.e(90609)]).then(i.bind(i,215079)).then((({showLinetoolsLimitExceededDialog:e})=>{e(this)}))}addCompareAsOverlay(e,t,i){const s=this.model();return(0,r.ensureDefined)(this._options.isSymbolAvailable)(e).then((r=>{if(!r)return null;const o=s.createStudyInserter({type:"java",studyId:"Overlay@tv-basicstudies"},[]);return o.setForceOverlay(!0),o.setPreferredPriceScale("as-series"),!0!==i&&o.setTargetPriceScaleMode({percentage:!0}),void 0!==t&&o.setPropertiesState({allowExtendTimeScale:t}),o.insert((async()=>({inputs:{symbol:e},parentSources:[]})))}))}scrollHelper(){return this._scrollHelper}setBroker(e){var t;this._brokerName=e,null===(t=this._lineToolsSynchronizer)||void 0===t||t.setBroker(e)}chartPainted(){return this._drawPlanned?(null===this._chartPaintedPromise&&(this._chartPaintedPromise=(0,d.createDeferredPromise)()),this._chartPaintedPromise.promise):Promise.resolve()}setDataWindowWidget(e){this._dataWindowWidget=e}removeDataWindowWidget(){this._dataWindowWidget=null}showSelectedSourcesProperties(e){const t=(0,r.ensureNotNull)(this._model).selection().dataSources();if(1===t.length)this.showSourceProperties(t[0],e);else{const i=t.filter(A.isLineTool);i.length>0&&this.showChartPropertiesForSources({sources:i,tabName:e})}}connect(){this._chartSession.isConnected().subscribe(this._onChartSessionIsConnectedChanged),this._chartSession.criticalError().subscribe(this,this._onChartSessionCriticalError),this._chartSession.connect(this._onData.bind(this))}finishInitWithoutConnect(){this._chartSession.disable(),this._init(),this._chartWidgetInitialized.fire()}reconnect(){this._chartSession.disconnect(),this._chartSession.connect()}update(){if(this.hasModel()){for(const e of this._paneWidgets)e.update();this._timeAxisWidget&&this._timeAxisWidget.update()}}setPriceAxisHovered(e,t){t?this._hoveredPriceAxes.add(e):this._hoveredPriceAxes.delete(e),this._anyAxisHovered.setValue(this._hoveredPriceAxes.size>0)}anyPriceAxisHovered(){return this._anyAxisHovered.readonly()}linkingGroupIndex(){return this._linkingGroupIndex}offsetInDocument(e){const t=this._paneWidgets.find((t=>t.state()===e));if(void 0===t)return{left:NaN,top:NaN};const i=t.getElement().getBoundingClientRect();return{left:Math.round(i.left+document.body.scrollLeft),top:Math.round(i.top+document.body.scrollTop)}}_createShowDataWindowAction(){return this._showDataWindowAction=new y.Action({actionId:"Chart.DataWindow.Show",label:n.t(null,void 0,i(653831)),statName:"DataWindow",hotkeyGroup:this._hotkeys,hotkeyHash:o.Modifiers.Alt+68,icon:Ps,onExecute:this._showOrHideDataWindowWidget.bind(this)}),this._showDataWindowAction}_clearSelectionHotkey(){return{desc:"Cancel selection",hotkey:27,handler:()=>{var e;if(this.selectPointMode().value()!==K.SelectPointMode.None)return this.selectPointMode().value()===K.SelectPointMode.Replay&&this._chartWidgetCollection.getAll().forEach((e=>{
e!==this&&e.selectPointMode().value()===K.SelectPointMode.Replay&&e.cancelRequestSelectPoint()})),void this.cancelRequestSelectPoint();null===(e=this._model)||void 0===e||e.selectionMacro((e=>{this._cancelCreatingLine(),e.clearSelection()}))},isDisabled:()=>{const e=this._model;if(!e)return!0;const t=0===e.selection().allSources().length,i=null===e.crossHairSource().measurePane().value(),s=this.selectPointMode().value()===K.SelectPointMode.None;return t&&i&&s}}}_insertStudy(e,t,s,o){const a=(0,r.ensureNotNull)(this._model).createStudyInserter(e,t,s);a.setForceOverlay("java"===e.type&&"Volume@tv-basicstudies"===e.studyId&&Ee.enabled("volume_force_overlay"));const l=a.insert(((e,i,s)=>new Promise(((r,n)=>{var a;this.selectPointMode().value()!==K.SelectPointMode.None&&this.cancelRequestSelectPoint(),o?r(o(e,i,s)):!function(e){return Es.includes(e.id)}(s)?(null!=(a=i)?a:[]).some((e=>e.confirm))?((0,ye.trackEvent)("GUI","Confirmation dialogs","Inputs confirmation dialog"),vs(this,e,s,r,n)):r({inputs:{},parentSources:t}):((0,ye.trackEvent)("GUI","Confirmation dialogs","Symbol confirmation dialog"),vs(this,e,s,r,n,"symbol"))}))));return l.then((()=>{(0,K.hideAllIndicators)().value()&&(0,W.toggleHideMode)()})).catch((e=>{e===Ki.InsertionErrorCode.StudyCannotBeChild&&(0,Fi.showNoticeDialog)({type:"modal",title:n.t(null,void 0,i(900850)),content:n.t(null,void 0,i(465943))}),e===Ki.InsertionErrorCode.CannotCompilePub&&(0,Fi.showNoticeDialog)({type:"modal",title:n.t(null,void 0,i(900850)),content:n.t(null,void 0,i(81214))}),e===Ki.InsertionErrorCode.CannotGetMetainfo&&(0,Fi.showNoticeDialog)({type:"modal",title:n.t(null,void 0,i(900850)),content:n.t(null,void 0,i(164968))})})),l}async _showChartProperties(e,t,i,s){if(!this._model)return null;t&&((0,c.setValue)("properties_dialog.active_tab.chart",t),i.tabName=t);const r=await ts(e,this._model,i,this._options.chartWidgetCollection,s);return(null==r?void 0:r.visible().value())?r:null}_createLineToolsSynchronizerIfNeeded(){var e;{const t={readOnlyMode:this.readOnly(),migrateSyncedLineTools:this===this._options.chartWidgetCollection.getAll()[0]};this._lineToolsSynchronizer=new xi({layoutId:this._layoutId,chartId:this._id,clientId:this._chartWidgetCollection.clientId},this.model().model(),t,(()=>this._chartWidgetCollection.isFirstChartInLayout(this)),(()=>this._chartWidgetCollection.deserializedChartIds())),null!==this._saveChartService&&this._lineToolsSynchronizer.setSaveChartService(this._saveChartService),this._lineToolsSynchronizer.setBroker(this._brokerName),(0,Li.isFeatureEnabled)("remove_line_tools_from_content")&&(0,r.ensureNotNull)(this._lineToolsSynchronizer).invalidateAll(),null===(e=this._model)||void 0===e||e.model().setLineToolsSynchronizer(this._lineToolsSynchronizer)}}_updateThemedColor(){const e=this.model().model(),t=e.backgroundColorAtYPercentFromTop(.5);let i=e.backgroundTopColor().value(),s=e.backgroundColor().value();const r=(0,be.isColorDark)(t),o=(0,be.isColorDark)(i),n=(0,be.isColorDark)(s);this.widget().classList.toggle("chart-widget--themed-dark",r),
this.widget().classList.toggle("chart-widget--themed-light",!r),this.widget().classList.toggle("chart-widget__top--themed-dark",o),this.widget().classList.toggle("chart-widget__top--themed-light",!o),this.widget().classList.toggle("chart-widget__bottom--themed-dark",n),this.widget().classList.toggle("chart-widget__bottom--themed-light",!n),this._backgroundTopTheme.setValue(o?"dark":"light"),this._backgroundBasedTheme.setValue(r?"dark":"light"),this._backgroundBottomTheme.setValue(n?"dark":"light"),i===s&&(0,ee.isStdThemedDefaultValue)("chartProperties.paneProperties.background",i,this._backgroundBasedTheme.value())&&(i=null,s=null);for(const e of this._paneWidgets)e.updateThemedColors({topColor:i,bottomColor:s})}_isLineToolModeExceptBrush(){const e=K.tool.value();return(0,E.isLineToolName)(e)&&!(0,E.isLineDrawnWithPressedButton)(e)&&this.selectPointMode().value()===K.SelectPointMode.None}_cancelCreatingLine(){const e=(0,r.ensureNotNull)(this._model).model(),t=e.lineBeingCreated();if(null!==t){const i=(0,r.ensureNotNull)(e.paneForSource(t));(0,r.ensureNotNull)(this.paneByState(i)).cancelCreatingLineTool(),t.toolname===K.tool.value()&&(0,K.resetToCursor)()}const i=e.crossHairSource().measurePane().value();if(null!==i){(0,r.ensureNotNull)(this.paneByState(i)).cancelMeasuring()}}_adjustSize(e){var t;let i=0;const r=null===this._model?null:this._model.model().priceScaleSlotsCount(),o=new Uint32Array(null===r?0:r.left),n=new Uint32Array(null===r?0:r.right),a=(0,ge.getCanvasDevicePixelRatio)(document.body),l=(e,t)=>e+t,c=(e,t)=>{t.forEach(((t,i)=>{e[i]=Math.max(e[i],t)}))},h=this._width(),d=this._height(),_=this._paneSeparators.length,p=this.isMaximizedPane()?0:jt.height()*_,m=null!==this._timeAxisWidget?this._timeAxisWidget.optimalHeight():0;let g=d-m>=61?m:0;g%2&&(g+=1);const S=Math.max(1,Math.floor((d-p-g)/this._paneWidgets.length));let v=0,f=null;for(const e of this._paneWidgets)if(!this._maximizedPaneWidget||this._maximizedPaneWidget===e){e.leftPriceAxisesContainer().updateCurrencyLabels();const t=e.leftPriceAxisesContainer().optimalWidths();e.rightPriceAxisesContainer().updateCurrencyLabels();const s=e.rightPriceAxisesContainer().optimalWidths();c(o,t),c(n,s),this._maximizedPaneWidget!==e&&e.state().collapsed().value()?v+=Math.min(S,e.collapsedHeight()):(i+=e.stretchFactor(),f=e)}let b=o.reduce(l,0),y=n.reduce(l,0),C=Math.max(h-b-y,0);if(C<=102){b=0,y=0,C=h;for(let e=0;e<o.length;e++)o[e]=0;for(let e=0;e<n.length;e++)n[e]=0}for(const e of this._paneSeparators)e.adjustSize();const w=p+v+g,P=d<w?0:d-w,T=P/i;let M=0,x=!1;const I=null===(t=this._model)||void 0===t?void 0:t.model();for(let e=0;e<this._paneWidgets.length;++e){const t=this._paneWidgets[e];void 0!==I&&t.setState(I.panes()[e]);let i=0;if(this.isMaximizedPane())i=this._maximizedPaneWidget===t?P:0;else if(t.state().collapsed().value())i=Math.min(S,t.collapsedHeight());else{const e=t===f?Math.ceil((P-M)*a)/a:Math.round(t.stretchFactor()*T*a)/a;i=Math.max(e,2),M+=i}t.setPriceAxisSizes("left",i,o),t.setPriceAxisSizes("right",i,n),x=x||i!==t.height(),t.setSize((0,
s.size)({width:C,height:i})),I&&t.state()&&I.setPaneHeight(t.state(),i)}null!==this._timeAxisWidget&&this._timeAxisWidget.setSizes((0,s.size)({width:C,height:g}),o,n),I&&I.setWidth(C,e),this._controlBarNavigation&&this._controlBarNavigation.updatePosition(),this._lhsAxesWidth!==b&&(this._lhsAxesWidth=b,this._lhsPriceAxisWidthChanged.fire(b)),this._rhsAxesWidth!==y&&(this._rhsAxesWidth=y,this._rhsPriceAxisWidthChanged.fire(y)),x&&u.emit("panes_height_changed")}_makePaneWidgetsAndSeparators(){const e=this.model().model().panes(),t=e.length,i=this._paneWidgets.length;for(let e=t;e<i;e++){(0,r.ensureDefined)(this._paneWidgets.pop()).destroy();const e=this._paneSeparators.pop();e&&e.destroy()}const s=this._options.containsData;for(let r=i;r<t;r++){const t={contextMenuEnabled:this._options.paneContextMenuEnabled,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,handleScale:this._options.handleScale,handleScroll:this._options.handleScroll,priceScaleContextMenuEnabled:this._options.priceScaleContextMenuEnabled,legendWidgetEnabled:this._options.legendWidgetEnabled,sourceStatusesWidgetEnabled:!s,sourceStatusesWidget:this._options.sourceStatusesWidget,marketStatusWidgetEnabled:this._options.marketStatusWidgetEnabled&&!s,chartWarningWidgetEnabled:this._options.chartWarningWidgetEnabled&&!s,chartWarningWidget:this._options.chartWarningWidget,dataProblemWidgetEnabled:this._options.dataProblemWidgetEnabled&&!s,legendWidget:this._options.legendWidget,propertyPagesEnabled:this._options.propertyPagesEnabled,sourceSelectionEnabled:this._options.sourceSelectionEnabled,controlsEnabled:this._options.paneControlsEnabled,croppedTickMarks:this._options.croppedTickMarks,countdownEnabled:this._options.countdownEnabled,customLegendWidgetFactories:new Map(this._customLegendWidgetsFactoryMap),useKineticScroll:this._options.useKineticScroll};void 0!==this._options.paneContextMenu&&(t.contextMenu=this._options.paneContextMenu),void 0!==this._options.priceScaleContextMenu&&(t.priceScaleContextMenu=this._options.priceScaleContextMenu);const i=new Gt(this,e[r],t,this._paneWidgetsSharedState);if(this._paneWidgets.push(i),r>0){const e=new jt(this,r-1,r);this._paneSeparators.push(e),this._timeAxisWidget?this._elMainTable.insertBefore(e.getElement(),this._timeAxisWidget.getElement()):this._elMainTable.appendChild(e.getElement())}this._timeAxisWidget?this._elMainTable.insertBefore(i.getElement(),this._timeAxisWidget.getElement()):this._elMainTable.appendChild(i.getElement())}for(let i=0;i<t;i++){const t=e[i],s=this._paneWidgets[i];s.hasState()&&s.state()===t?s.updatePriceAxisWidgetsStates():s.setState(t)}for(let e=t;e--;)this._paneWidgets[e].updateControls();this._errorRenderer.updatePaneWidgets(),this._updateThemedColor()}_width(){return this._options.width.value()}_height(){return this._options.height.value()}_update(e,t){var i,s;const r=e?e.fullInvalidation():R.InvalidationLevel.Full,o=!!e&&e.isVisibleTimeRangeLockedOnResize()
;if(null!==this._timingsMeter&&this._timingsMeter.startDraw(r),r===R.InvalidationLevel.Full&&(this._model?this._updateGui(o):this._adjustSize(o)),r>R.InvalidationLevel.Cursor&&(null===(i=this._timeAxisWidget)||void 0===i||i.update(),this._paneWidgets.forEach((e=>{e.updatePriceAxisWidgets()})),this._applyTimeScaleInvalidations(e,t),(null===(s=this._invalidationMask)||void 0===s?void 0:s.fullInvalidation())===R.InvalidationLevel.Full&&(this._invalidationMask.merge(e),this._adjustSize(this._invalidationMask.isVisibleTimeRangeLockedOnResize()),this._applyTimeScaleInvalidations(this._invalidationMask,t),e=this._invalidationMask,this._invalidationMask=null)),this.paint(e),this._dataWindowWidget){const t=e.maxPaneInvalidation();t===R.InvalidationLevel.Full?this._dataWindowWidget.fullUpdate():t>R.InvalidationLevel.None&&this._dataWindowWidget.update()}for(let t=0;t<this._paneWidgets.length;t++)this._paneWidgets[t].updateStatusWidget(e.invalidateForPane(t));null!==this._timingsMeter&&this._timingsMeter.stopDraw(),e&&e.panesOrderInvalidated()&&u.emit("panes_order_changed")}_onMousewheel(e){if(!this.model().model().zoomEnabled()||null===this._mouseWheelHelper)return;if(!(0,h.onWidget)()&&parent&&parent!==window&&parent.IS_DEMO_PAGE)return;if(null===this._model)return;if(this.model().timeScale().isEmpty())return;const t=this._mouseWheelHelper.processWheel(e),i=t.deltaX,s=-t.deltaY;if(0!==i&&this._options.handleScroll.mouseWheel||0!==s&&this._options.handleScale.mouseWheel){if(e.cancelable&&e.preventDefault(),0!==s&&this._options.handleScale.mouseWheel){const t=Math.sign(s)*Math.min(1,Math.abs(s)),i=(0,r.ensureNotNull)(this._mainDiv).getBoundingClientRect(),o=e.clientX-this._lhsAxesWidth-i.left;if(!Number.isFinite(o)||!Number.isFinite(t))return void Ms.logWarn("Incorrect mouse wheel processing: scrollPosition: "+o+", zoomScale: "+t);const n=new j.EnvironmentState(e).mod();this.model().model().zoomTime(o,t,!!n||void 0),this._onZoom.fire(n)}0!==i&&this._options.handleScroll.mouseWheel&&this.model().scrollChart(-80*i)}}_updateGui(e){this._model&&(this._makeTimeAxisWidget(),this._makePaneWidgetsAndSeparators(),this._elMainTable.style.userSelect="none",this._adjustSize(e))}_setElement(e){if(this._mainDiv){this._mainDiv.remove();const e=document.createRange();e.selectNodeContents((0,r.ensureNotNull)(this._parent)),e.deleteContents()}this._controlBarNavigation&&(this._controlBarNavigation.destroy(),this._controlBarNavigation=null),null!==this._removeMaximizeHotkey&&this._removeMaximizeHotkey(),this._removeMaximizeHotkey=this._initMaximizeHotkey(e);const t=e.ownerDocument,i=t.createElement("div");i.classList.add("chart-container-border"),e.insertBefore(i,e.firstChild),this._parent=i;const s=t.createElement("div");if(s.classList.add("chart-widget"),this._mainDiv=s,this._elTooltipDiv=t.createElement("div"),this._elTooltipDiv.className="tooltip-wrapper",this._mainDiv.appendChild(this._elTooltipDiv),this._elMainTable=t.createElement("table"),this._elMainTable.className="chart-markup-table",this._elMainTable.setAttribute("cellpading","0"),
this._elMainTable.setAttribute("cellspacing","0"),this._mainDiv.appendChild(this._elMainTable),this._hotkeysListener&&this._hotkeysListener.destroy(),this._errorRenderer.setContainer(this._parent),this._hotkeysListener=new ft.ChartHotkeysListener(this,this._mainDiv),(this._options.controlBarEnabled||(0,Ee.enabled)("control_bar"))&&this._createControlBar(),this._options.handleScale.mouseWheel||this._options.handleScroll.mouseWheel){this._mouseWheelHelper=new Ie;const e=this._onMousewheel.bind(this);this._onWheelBound=e,this._mainDiv.addEventListener("wheel",e,{passive:!1})}this.resize(),this._justActivated=!1,this.withModel(this,(()=>{i.appendChild(s),s.addEventListener("mousedown",this._beginRequestActive.bind(this)),s.addEventListener("mouseup",this._endRequestActive.bind(this)),s.addEventListener("touchstart",this._beginRequestActive.bind(this)),s.addEventListener("touchmove",this._endRequestActive.bind(this)),s.addEventListener("touchend",this._endRequestActive.bind(this)),s.addEventListener("click",this._requestActive.bind(this))})),this._inited&&(null!==this._timeAxisWidget&&(this._timeAxisWidget.destroy(),this._timeAxisWidget=null),this._paneWidgets.forEach((e=>{e.destroy()})),this._paneWidgets.length=0,this._paneSeparators.forEach((e=>{e.destroy()})),this._paneSeparators.length=0,this._update(R.InvalidationMask.full(),performance.now()))}_init(){this.hasModel()&&this.model().mainSeries().clearData(),this._initColors(),this._makeDefaultGui();this._makeDefaultModel(),(()=>{this._checkObsoleteTimezone(),this._chartSession&&this._chartSession.connected()&&this.model().model().restart(),this._content&&(this._initColors(),this._updateGui(),this.update()),this._resizeHandler=()=>{this._invalidationHandler(R.InvalidationMask.full())},this._resizeHandler(),(0,r.ensureNotNull)(this._parent).appendChild((0,r.ensureNotNull)(this._mainDiv)),this._spinner&&(this._spinner.stop(),this._spinner=null),this._keydownEventListener=e=>{27===e.which&&e.preventDefault()},window.addEventListener("keydown:chart_"+this._id,this._keydownEventListener),this._activateSymbolSearchHotkeys(),this.model().timeScale().onScroll().subscribe(this,(()=>this._onScroll.fire())),this._inited=!0})()}_makeDefaultModel(){let e;if(this._content&&this._content.timeScale.points){const t=this._content.timeScale.points.items[0];e={startDate:t}}if(!(0,r.ensureNotNull)(this._metaInfoRepository).getInternalMetaInfoArray())throw new Error("Cannot create chart model: studies metainfo is absent");const t=()=>{var t,i;const s={readOnly:this.readOnly(),isSnapshot:!!this._containsData,...l(this._options,["timeScale","crossHair","chartEventsEnabled","esdEnabled","latestUpdatesEnabled","continuousContractSwitchesEnabled","futuresContractExpirationEnabled","countdownEnabled","lastPriceAnimationEnabled","currencyConversionEnabled","unitConversionEnabled","watermarkEnabled","shiftVisibleRangeOnNewBar","hideIdeas","onWidget"])},o=function(e,t,i,s,r,o,n,a,l,c,h,d){const u=new b.ChartUndoModel(e,t,i,s,r,o,n,a,l,c,h,d);return u.model().fullUpdate(),u
}(this._chartSession,this._invalidationHandler,this.properties(),e,(0,r.ensureNotNull)(this._metaInfoRepository),this,this._options.undoHistory,this._options.barsMarksContainersFactory,s,this._collapsed,this._linkingGroupIndex,null!==(i=null===(t=this._saveChartService)||void 0===t?void 0:t.autoSaveEnabled())&&void 0!==i?i:new Se.WatchedValue(!0));return this._createSessions(o.model()),this._createPrePostMarket(o.model()),o};(0,Ee.enabled)("lean_chart_load")?this._model=this._model||t():this._model=t(),this._model.model().setChartSaveTime(1e3*this._chartWidgetCollection.metaInfo.lastModified.value()),this._createVolumeIfNeeded();if(this._content){let e=this._setSymbolIntervalContentOverrides;xs&&this._initialLoading&&(e={...e,symbol:this._defSymbol,interval:this._defInterval,style:this._defStyle}),this.restoreState(this._content,this._containsData,e),this._setSymbolIntervalContentOverrides={},xs&&this._defSymbol&&this.model().model().recalculatePriceRangeOnce()}else this._setActions();this._createLineToolsSynchronizerIfNeeded(),(()=>{const e=(0,r.ensureNotNull)(this._model);e.onTagsChanged().subscribe(this,(()=>this.onModelTagsChanged())),this._initBackgroundColor(),this._updateGui(),this._modelCreated.fire(e),this._tagsChanged.fire();const t=e.mainSeries(),s=t.properties().childs();this._defTimeframe&&t.setDefaultTimeframe(this._defTimeframe),t.dataEvents().symbolNotPermitted().subscribe(null,(e=>t.setSymbolParams({symbol:e}))),this._symbolWV.setValue(s.symbol.value()),s.symbol.subscribe(this,(e=>this._symbolWV.setValue(e.value()))),this._resolutionWV.setValue(s.interval.value()),s.interval.subscribe(this,(e=>this._resolutionWV.setValue(e.value()))),window.loginStateChange.subscribe(this,this._handleLoginStateChanged),this._handleLoginStateChanged(),t.dataEvents().symbolResolved().subscribe(this,(e=>{const i=e.pro_name,s=e.pro_perm;i&&this._options.isSymbolAvailable&&this._options.isSymbolAvailable(i,s).then((e=>{e||t.setSymbolParams({symbol:window.DEFAULT_SYMBOL})}))})),void 0!==this._options.requestFallbackSymbol&&t.dataEvents().symbolGroupNotPermitted().subscribe(this,(e=>{(0,r.ensureDefined)(this._options.requestFallbackSymbol)(s.symbol.value(),{type:"group_not_permitted",symbolGroup:e}).then((e=>{e&&t.setSymbolParams({symbol:e})}))})),(0,r.ensureDefined)(t.onInReplayStateChanged).bind(t)().subscribe(this.screen,this.screen.show),s.style.unsubscribe(this,this._onChartStyleChanged),s.style.subscribe(this,this._onChartStyleChanged),t.dataEvents().completed().subscribe(this,(()=>this._addPerfMark("SeriesCompleted")),!0),t.dataEvents().barReceived().subscribe(this,(()=>this._addPerfMark("SeriesFirstDataReceived")),!0);const o=this._options;t.dataEvents().chartTypeNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"D"}),o.muteSessionErrors||((0,Ai.trackGoProFeature)("kagiRenko"),(0,Ei.reloginOrGoPro)({feature:"kagiRenko"}))})),t.dataEvents().intradaySpreadNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"D"}),o.muteSessionErrors||(0,Ei.reloginOrGoPro)({feature:"intradaySpread"})})),
t.dataEvents().customIntervalNotPermitted().subscribe(null,(i=>{const s=e.model().defaultResolutions(),r=s.find((e=>(0,qi.compareResolutions)(e,i)>=0)),n=null!=r?r:s[s.length-1];t.setSymbolParams({interval:n}),o.muteSessionErrors||(0,Ei.reloginOrGoPro)({feature:"customIntervals"})})),t.dataEvents().secondsIntervalNotPermitted().subscribe(null,(()=>{const e=t.getSupportedResolution("1",!1);t.setSymbolParams({interval:e}),o.muteSessionErrors||(0,Ei.reloginOrGoPro)({feature:"secondsIntervals",forceUpgradeBtn:!0})})),t.dataEvents().intradayExchangeNotPermitted().subscribe(null,(()=>{if(t.setSymbolParams({interval:"D"}),!o.muteSessionErrors){let e=(0,r.ensureNotNull)(t.symbolInfo()).listed_exchange;(0,ki.getExchanges)().forEach((t=>{t.value===e&&(e=t.name)})),(0,Ei.reloginOrGoPro)({feature:"intradayExchange"})}}));{const e=n.t(null,void 0,i(993213));t.requestingIntradayWhenNotSupported.subscribe(null,(()=>{if(!o.muteSessionErrors){const t=document.createElement("div"),s=n.t(null,void 0,i(687692)).format({p_start:"<p>",p_end:"</p>",b_start:"<b>",b_end:"</b>"});t.innerHTML=s,(0,Fi.showNoticeDialog)({title:e,content:t})}})),t.requestingResolutionLessThanFrequency.subscribe(null,((t,s)=>{if(!o.muteSessionErrors){const r=document.createElement("div"),o=n.t(null,void 0,i(15795)).format({p_start:"<p>",p_end:"</p>",b_start:"<b>",b_end:"</b>",data_frequency:t,min_interval:s});r.innerHTML=o,(0,Fi.showNoticeDialog)({title:e,content:r})}}))}t.requestingStyleIsNotSupported.subscribe(null,(()=>{const i=t.interval(),s=e.model().defaultResolutions(),r=(0,Gi.getLastUsedSingleValueBasedStyle)(),o=(0,qi.getResolutionByChartStyle)(r,i,s);t.setChartStyleWithIntervalIfNeeded(r,o)})),t.requestingStyleSupportRecovered.subscribe(null,(i=>{const s=t.interval(),r=e.model().defaultResolutions(),o=(0,qi.getResolutionByChartStyle)(i,s,r);t.setChartStyleWithIntervalIfNeeded(i,o)}))})()}_startSpinner(e){this._spinner||e&&(this._spinner=(new g.Spinner).spin(e))}_handleLoginStateChanged(){(0,Ee.enabled)("popup_hints")&&window.user&&window.user.is_pro?this._noExchangeSubscrptionWarning=new Oi(this):null!==this._noExchangeSubscrptionWarning&&(this._noExchangeSubscrptionWarning.destroy(),this._noExchangeSubscrptionWarning=null)}_checkObsoleteTimezone(){const e=this.properties().childs().timezone.value();(0,is.timezoneIsAvailable)(e)||this.properties().childs().timezone.setValue({UTC:"Etc/UTC",EST:"America/New_York",CST:"America/Chicago",PST:"America/Los_Angeles"}[e]||"exchange")}_initColors(){const e=this.properties().childs(),t=e.scalesProperties.childs();t.lineColor.listeners().subscribe(this,this._updateAndPaint),t.textColor.listeners().subscribe(this,this._updateAndPaint),e.paneProperties.childs().separatorColor.listeners().subscribe(this,this._setPaneSeparatorLineColor)}_setPaneSeparatorLineColor(){this._paneSeparators.forEach((e=>e.update())),this._updateAndPaint()}_updateAndPaint(){this.update(),this.paint()}_makeDefaultGui(){this._makeLoadingScreen(),this.onWidget()&&this._makeAvailableOnTVPopup(),this.hasModel()&&(this._makeTimeAxisWidget(),
this._makePaneWidgetsAndSeparators()),this._adjustSize(),this._updateScalesActions(),(0,Z.disableSelection)(this._elMainTable),this._updateAndPaint()}_makeLoadingScreen(){if(Ee.enabled("lean_chart_load")){if(this.screen)return;this.screen=new as(this,(0,r.ensureNotNull)(this._parent))}else this.screen=new as(this,(0,r.ensureNotNull)(this._mainDiv))}_makeAvailableOnTVPopup(){this._availableScreen||(this._availableScreen=new zi(this))}_activateSymbolSearchHotkeys(){this.readOnly()||this._options.hideSymbolSearch||(0,ss.activateKeyPressHandler)()}_makeTimeAxisWidget(){if(this._timeAxisWidget)return void this._timeAxisWidget.updatePriceAxisStubs();const e=this.model();this._timeAxisWidget=new Jt(this,this._options.timeScaleWidget,this._titlesProvider.bind(this),this._menuItemsProvider.bind(this),this._backgroundBasedTheme),this._elMainTable.appendChild(this._timeAxisWidget.getElement()),this._timeAxisWidget.updatePriceAxisStubs(),this._timeAxisWidget.onLabelHovered().subscribe(this,((t,i)=>{const s=this._maximizedPaneWidget?this._maximizedPaneWidget.state():e.paneForSource(e.mainSeries()),o=(0,r.ensureNotNull)(this.paneByState((0,r.ensureNotNull)(s))).highlightedPriceAxis(),n=o.value();(i||n.owner===t.owner)&&(o.setValue({owner:t.owner,axis:i?t.axis:null}),this.model().model().lightUpdate())}))}_titlesProvider(e,t){const i=this.model(),s=(0,r.ensureNotNull)(this._maximizedPaneWidget?this._maximizedPaneWidget.state():i.paneForSource(i.mainSeries())),o="right"===e?s.rightPriceScales():s.leftPriceScales();if(o.length<t+1)return[];let n=o[t].orderedSources().filter((e=>e===i.mainSeries()||(0,D.isStudy)(e)));return n.reverse(),n=(0,ls.moveToHead)(n,i.mainSeries()),n.map((e=>e.title(ws.TitleDisplayTarget.StatusLine,!0,void 0,!1)))}_menuItemsProvider(e,t){const i=this.model(),s=(0,r.ensureNotNull)(this._maximizedPaneWidget?this._maximizedPaneWidget.state():i.paneForSource(i.mainSeries())),o="right"===e?s.visibleRightPriceScales():s.visibleLeftPriceScales();if(o.length<t+1)return[];const n=o[t],a=i.model().panes().indexOf(s),l=this._paneWidgets[a],c="right"===e?l.rightPriceAxisesContainer():l.leftPriceAxisesContainer();return(0,r.ensureNotNull)(c.findAxisWidgetForScale(n)).getContextMenuActions()}_invalidationRAFCallback(e){if(this._drawPlanned=!1,this._drawRafId=0,!this._inLoadingState){if(this._invalidationMask){const t=this._invalidationMask;this._invalidationMask=null,this._update(t,e);for(const i of t.timeScaleInvalidations())if(0===i.type&&!i.value.finished(e)){this.model().model().setTimeScaleAnimation(i.value);break}}null!==this._chartPaintedPromise&&(this._chartPaintedPromise.resolve(),this._chartPaintedPromise=null)}}_applyTimeScaleInvalidations(e,t){for(const i of e.timeScaleInvalidations())this._applyTimeScaleInvalidation(i,t)}_applyTimeScaleInvalidation(e,t){var i,s,r;const o=null===(i=this._model)||void 0===i?void 0:i.timeScale();if(o&&0===e.type)o.setRightOffset(e.value.getPosition(t)),o.requestHistoryPointsIfNeeded(),e.value.finished(t)&&(null===(r=(s=e.value).onFinish)||void 0===r||r.call(s,!0))}
_onChartSessionCriticalError(e,t){this._disconnected.fire(!0)}_onData(e){if("reconnect_bailout"===e.method)this._reconnectBailout.fire();else this.model().model().onData(e)}_onConnection(){this._requestMetadata(),this.hasModel()&&(this.model().model().restart(),this.model().model().fullUpdate(),this._connected.fire())}_onDisconnect(){this.hasModel()&&this.model().model().disconnect(),this._model&&this._model.model().fullUpdate(),this._disconnected.fire()}async _requestMetadata(){this._addPerfMark("RequestMetadataStart"),Ms.logInfo("RequestMetadataStart");const e=(0,r.ensureNotNull)(this._metaInfoRepository);await e.requestMetaInfo(),this._addPerfMark("RequestMetadataEnd"),Ms.logInfo("RequestMetadataEnd, already initialized: "+Boolean(this._inited)),this._inited?this.model().model().setStudiesMetaData(e.getInternalMetaInfoArray(),e.getMigrations()):(await(0,A.initAllLineToolsFromContent)(this._content),this._init(),this._chartWidgetInitialized.fire(),Ee.enabled("charting_library_base")||Ms.logDebug("initialized"))}async _createControlBar(){const e=await Promise.all([i.e(29284),i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(26855),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(56388),i.e(9227),i.e(48450),i.e(22652),i.e(50690),i.e(26300),i.e(59255),i.e(10758),i.e(10395),i.e(745),i.e(37457),i.e(5093)]).then(i.bind(i,897195));this._controlBarNavigation=new e.ControlBarNavigation(this,(0,r.ensureNotNull)(this._mainDiv),this._options.controlBar),this._model&&this._adjustSize()}_subscribeToDrawingState(){if(this._options.readOnly)return;(0,K.init)();const e=(e,t)=>{const i=this._model;if(null===i)return;const s=i.model();e.model!==s&&(this._lineToolsSynchronizer?this._lineToolsSynchronizer.executeSyncedAction((()=>t(s,i))):t(s,i))};K.createdLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,r.ensureNotNull)(e.paneForSource(e.mainSeries()));let o,n=null;if(void 0===t.pointPositionPercents){if(n=As(e,t.model,t.point.timeStamp),null===n)return;o=t.point.price}else{const i=t.pointPositionPercents.x*e.timeScale().width(),s=e.mainSeries().priceScale(),r=t.pointPositionPercents.y*s.height(),a=e.mainSeries().firstValue();if(null===a)return;n=e.timeScale().coordinateToIndex(i),o=s.coordinateToPrice(r,a)}const a={index:(0,r.ensureNotNull)(n),price:o},l=i.createLineTool({pane:s,point:a,linetool:t.linetool,properties:t.properties,linkKey:t.linkKey,ownerSource:e.mainSeries(),disableSynchronization:!0,id:t.id,sharingMode:t.sharingMode});null!==l&&!Boolean(this.model().lineBeingCreated())&&t.finalState&&l.restoreExternalPoints(t.finalState,{indexesChanged:!0,pricesChanged:!0})}))})),K.continuedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const r=As(e,t.model,t.point.timeStamp);if(null===r)return;const o={index:r,price:t.point.price},n=e.lineBeingCreated();if(null===n)return;i.continueExternalLine(o,null!==(s=t.envState)&&void 0!==s?s:void 0,!!t.finalState)&&t.finalState&&n.restoreExternalPoints(t.finalState,{indexesChanged:!0,pricesChanged:!0})}))
})),K.cancelledLineTool.subscribe(null,(t=>{e(t,((e,t)=>{e.cancelCreatingLine()}))})),K.beenSetLineToolLastPoint.subscribe(null,(t=>{e(t,((e,i)=>{const s=e.lineBeingCreated();if(null===s||s.linkKey().value()!==t.linkKey)return;const r=As(e,t.model,t.point.timeStamp);if(null===r)return;const o={index:r,price:t.point.price};s.setLastPoint(o),s.updateAllViews((0,Ct.sourceChangeEvent)(s.id())),e.lightUpdate()}))})),K.startedMovingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const r=t.linkKeys.map(A.lineToolByLinkKey.bind(null,e)).filter(S.notNull);if(r.length){const i=As(e,t.model,t.point.timeStamp);if(null===i)return;const o={index:i,price:t.point.price},n=null!==(s=t.activeItem)&&void 0!==s?s:null,a=r[0].pointToScreenPoint(o);a&&e.startMovingSources(r,{logical:o,screen:a},n,t.pointPositionPercents,null===t.envState?void 0:t.envState,!0)}}))})),K.movedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const r=e.sourcesBeingMoved().filter(A.isLineTool).filter((e=>(e=>t.linkKeys.some((t=>e.linkKey().value()===t)))(e)));if(!r.length)return;const o=As(e,t.model,t.point.timeStamp);if(null===o)return;const n={index:o,price:t.point.price},a=r[0].pointToScreenPoint(n);a&&e.moveSources({logical:n,screen:a},t.pointPositionPercents,null!==(s=t.envState)&&void 0!==s?s:void 0,!0)}))})),K.finishedMovingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=e.sourcesBeingMoved().filter(A.isLineTool);if(0===s.length)return;s.forEach((i=>{const s=(e=>{for(let i=0;i<t.linkKeys.length;i++)if(t.linkKeys[i]===e.linkKey().value())return{state:t.finalStates[i],changes:t.changes[i]};return null})(i);e.endMovingSources(null!==s,!0),null!==s&&(i.restoreExternalPoints(s.state,s.changes),s.state.pointPositionPercents&&i.restorePositionPercents(s.state.pointPositionPercents))}))}))})),K.startedChangingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const r=(0,A.lineToolByLinkKey)(e,t.linkKey);if(null!==r){const i=r.getPoint(t.pointIndex),o=i?i.index:As(e,t.model,t.point.timeStamp);if(null===o)return;if(r.isActualSymbol()&&r.isActualCurrency()&&r.isActualUnit()){const i={index:o,price:t.point.price};e.startChangingLinetool(r,i,t.pointIndex,null!==(s=t.envState)&&void 0!==s?s:void 0,!0)}}}))})),K.changedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=e.lineBeingEdited();if(null===s||s.linkKey().value()!==t.linkKey)return;let o=null;if(o=t.changes.indexesChanged?As(e,t.model,t.point.timeStamp):(0,r.ensureNotNull)(e.linePointBeingChanged()).index,null!==o&&s.isActualSymbol()&&s.isActualCurrency()&&s.isActualUnit()){const i={index:o,price:t.point.price};e.changeLinePoint(i,void 0,!0)}}))})),K.finishedChangingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,A.lineToolByLinkKey)(e,t.linkKey);null!==s&&s.isActualSymbol()&&s.isActualCurrency()&&s.isActualUnit()&&null!==e.lineBeingEdited()&&e.endChangingLinetool(!!t.finalState,!0),null!==s&&t.finalState&&s.restoreExternalPoints(t.finalState,t.changes)}))})),K.removedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const{withUndo:s,unlink:r,linkKey:o}=t,n=(0,A.lineToolByLinkKey)(e,o);if(null!==n)r&&n.detachAlert(),
s?i.removeSource(n,!1):(e.lineToolsGroupModel().removeLineTools([n]),e.removeSource(n));else if(this._lineToolsSynchronizer){const{sourceTitle:e,symbol:n,lineToolState:a}=t;i.removeUnloadedLineTool({state:a,unlink:r,sourceTitle:e,linkKey:o,symbol:n,withUndo:s})}}))})),K.finishedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,A.lineToolByLinkKey)(e,t.linkKey);null!==s&&(0,E.isLineToolFinishRequiredWhenCreatedByApi)(s.toolname)&&s.finish()}))})),K.changedLineStyle.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,A.lineToolByLinkKey)(e,t.linkKey);null!==s&&(s.restoreExternalState(t.state),s.propertiesChanged(!0),t.alertId&&s.syncAlert(t.alertId))}))})),K.restoredLineToolState.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,A.lineToolByLinkKey)(e,t.linkKey);if(null!==s){const i={...t.state};i.indexes=t.state.points.map((i=>({index:As(e,t.model,i.time_t),price:i.price}))),e.restoreLineToolState(s,i,!1)}}))})),K.restoredLineTool.subscribe(null,(t=>{e(t,((e,i)=>{e.restoreSource(t.state.restorePane,t.state.paneIndex,t.state.paneState,t.state.sourceState,null)}))})),K.copiedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,r.ensureNotNull)(e.paneForSource(e.mainSeries()));let o;const n={...t.state,intervalsVisibilities:(0,cs.mergeIntervalVisibilitiesDefaults)(t.state.intervalsVisibilities)},a=(0,A.createLineToolProperties)(t.linetool,n,e),l=e.dataSourceForId(t.id);if(l){if(!(0,A.isLineTool)(l))return void Ms.logError(`Error sync creating line tool. Object with id ${t.id} is already in use and it is not a line tool`);if(l.toolname!==t.linetool)return void Ms.logError(`Error sync creating line tool. Object with id ${t.id} is already in use and its type differs: ${l.toolname} and ${t.linetool}`)}if(l&&(l.linkKey().setValue(t.linkKey),l.share(t.sharingMode)),t.pointPositionPercents){const e={index:0,price:0};if(o=null!=l?l:i.createLineTool({pane:s,point:e,linetool:t.linetool,properties:a,linkKey:t.linkKey,disableSynchronization:!0,id:t.id}),null===o)return;o.restorePositionPercents((0,r.ensureDefined)(t.pointPositionPercents))}else{const n=t.points.map((i=>({index:(0,r.ensureNotNull)(As(e,t.model,i.timeStamp)),price:i.price}))),c=n[0];if(l)o=l;else if(t.withUndo)o=i.createLineTool({pane:s,point:c,linetool:t.linetool,properties:a,linkKey:t.linkKey,sharingMode:t.sharingMode,disableSynchronization:!0,id:t.id});else{const e=new f.CreateLineToolUndoCommand({model:i.model(),pane:s,lineTool:t.linetool,ownerSource:(0,r.ensureNotNull)(s.mainDataSource()),drawOnAllChartsMode:t.sharingMode,id:t.id});e.redo(),e.startCreatingLine(c,a,t.linkKey||null,t.sharingMode),o=(0,r.ensureNotNull)(e.line())}if(null===o)return;if(e.lineBeingCreated())for(let e=1;e<n.length;e++)e===n.length-1&&(0,E.isLineToolFinishRequiredWhenCreatedByApi)(t.linetool)&&o.finish(),t.withUndo?i.continueCreatingLine(n[e],new j.EnvironmentState(void 0,!0),e<n.length-1,!0):i.model().continueCreatingLine(n[e],new j.EnvironmentState(void 0,!0),e<n.length-1,!0)}o.properties().interval.setValue(t.state.interval),o.restoreExternalState(t.state),o.restoreData&&o.restoreData(t),
o.setZorder(t.zOrder),o.propertiesChanged(!0),t.finalState&&(o.calcIsActualSymbol(),o.restoreExternalPoints(t.finalState,{pricesChanged:!0,indexesChanged:!0},!0)),t.alertId&&o.syncAlert(t.alertId)}))}))}_setFirstRequestNumbarsUsingTimeframeAndInterval(e){const t=function(e){var t,i,s,r,o,n,a,l,c,h,d,u,_;const p=null!==(t=e.numberExtraBars)&&void 0!==t?t:0,m=e.barSpacing||6,g=Math.ceil(e.width/m)+p;if(e.timeFrame){if(!e.interval)return{barCount:g};const t=bs.Interval.parse(e.interval);if("string"==typeof e.timeFrame){if("ALL"===e.timeFrame)return{barCount:g};let l=e.timeFrame;"YTD"===e.timeFrame&&(l=`${Math.floor(((new Date).valueOf()-new Date((new Date).getFullYear(),0,0).valueOf())/1e3/60/60/24)}D`);const c=bs.Interval.parse(l),h=Date.now().valueOf(),d=h-c.inMilliseconds();return{barCount:(0,fs.getPeriodsBetweenDates)(null!==(s=null===(i=e.symbolInfo)||void 0===i?void 0:i.session)&&void 0!==s?s:"24x7",null!==(o=null===(r=e.symbolInfo)||void 0===r?void 0:r.session_holidays)&&void 0!==o?o:"",null!==(a=null===(n=e.symbolInfo)||void 0===n?void 0:n.corrections)&&void 0!==a?a:"",t.letter(),t.multiplier(),d,h)+p,message:`based on period of ${l}`,shouldAdjustBarSpacing:!0}}if("time-range"===e.timeFrame.type)return{barCount:(0,fs.getPeriodsBetweenDates)(null!==(c=null===(l=e.symbolInfo)||void 0===l?void 0:l.session)&&void 0!==c?c:"24x7",null!==(d=null===(h=e.symbolInfo)||void 0===h?void 0:h.session_holidays)&&void 0!==d?d:"",null!==(_=null===(u=e.symbolInfo)||void 0===u?void 0:u.corrections)&&void 0!==_?_:"",t.letter(),t.multiplier(),1e3*e.timeFrame.from,1e3*e.timeFrame.to)+p,message:`based on time range: ${e.timeFrame.from} ... ${e.timeFrame.to}`,shouldAdjustBarSpacing:!0}}return{barCount:g}}({width:e.timeScale().width(),barSpacing:e.timeScale().barSpacing(),timeFrame:this.options().defTimeframe,interval:this.options().defInterval});if(Ee.enabled("charting_library_debug_mode")&&console.log(`Setting initial data request count to ${t.barCount} bars${t.message?` (${t.message})`:""}`),e.mainSeries().seriesSource().setInitialRequestOptions({count:t.barCount}),t.shouldAdjustBarSpacing&&"number"==typeof t.barCount&&t.barCount>0){const i=Math.ceil(e.timeScale().width()/t.barCount);e.timeScale().setBarSpacing(i)}}_showOrHideDataWindowWidget(){const e=window.widgetbar,t=null==e?void 0:e.layout;if(!t)return;const i=t.getActivePage();i&&"data-window"===i.name||(t.setMinimizedState(!1),e.setPage("data-window"))}_createHint(){if(null===this._hintDefferedPromise){const e=(0,d.createDeferredPromise)();this._hintDefferedPromise=e,Promise.all([i.e(9817),i.e(93280),i.e(50690),i.e(26166)]).then(i.bind(i,410837)).then((t=>{e.resolve(new t.ChartEventHintRenderer(this._chartWidgetCollection.getContainer()))}))}return this._hintDefferedPromise?(0,r.ensureDefined)(this._hintDefferedPromise).promise:null}_showHint(e){if(Ee.enabled("popup_hints"))if(null!==this._activeHint)this._activeHint.show(e);else{const t=this._createHint();null!==t&&t.then((t=>{if(null!==t){if(this._activeHint=t,void 0===e)return;this._activeHint.show(e)}}))}}_hideHint(){
null!==this._activeHint&&this._activeHint.hide()}}},459296:(e,t,i)=>{"use strict";i.r(t),i.d(t,{activeLinkingGroupWV:()=>Ti,allInitialModelsCreated:()=>li,allInitialSymbolsResolved:()=>ai,allLinkingGroupsWV:()=>xi,applyIndicatorToAllChartsImpl:()=>gt,applyIndicatorsToAllChartsImpl:()=>mt,applyLineToolUpdateNotificationImpl:()=>Pt,applyThemeImpl:()=>di,chartsSymbolsImpl:()=>It,checkProFeatureImpl:()=>ci,combinedTrackTimeLock:()=>Ei,computeContentBoxImpl:()=>Ot,copyScreenshotToClipboard:()=>Dt,createBroadcastChannel:()=>ri,createChartStorageSubscriptionsIfRequired:()=>Lt,createClipboardHandler:()=>Mt,createLeftBottomChartWidgetWV:()=>Rt,deserializedChartIds:()=>Ct,destroyBroadcastChannel:()=>oi,downloadScreenshot:()=>Et,generateNewChartId:()=>qt,getAllLinkingGroups:()=>Mi,getAsyncStateForChartImpl:()=>bt,getChartWidgetsForIntervalLock:()=>Ci,getClientSnapshot:()=>Vt,getLinkingGroupCharts:()=>Ii,getSnapshot:()=>Nt,getStateForChartImpl:()=>ft,getVisuallyAdjacentDefImpl:()=>Ut,handleConnectionLimitReachedChanged:()=>ki,handleDateRangeLockChange:()=>Si,handleInternalDateRangeLockChange:()=>gi,handleInternalIntervalLockChange:()=>pi,handleInternalSymbolLockChange:()=>ui,handleInternalTrackTimeLockChange:()=>vi,handleIntervalLockChange:()=>mi,handleSymbolLockChange:()=>_i,handleTrackTimeLockChange:()=>fi,hideChartImpl:()=>$t,isFirstChartInLayout:()=>yt,lineToolsAndGroupsDTOsImpl:()=>vt,removeChartWidgetSubscriptionsImpl:()=>Zt,resetLineToolsInvalidatedImpl:()=>wt,setBrokerImpl:()=>xt,setChartLayoutWithUndoImpl:()=>hi,setLayoutImpl:()=>ti,setResolution:()=>wi,setSymbol:()=>bi,setSymbolAll:()=>yi,someOfWidgetsAreInSelectingReplayPointMode:()=>Ai,syncCrosshairImpl:()=>si,syncScrollImpl:()=>ni,takeScreenshot:()=>kt,takeServerScreenshot:()=>At,updateLayoutImpl:()=>Ht,updateLayoutPartialImpl:()=>zt,updateLinkingGroupCharts:()=>Li});var s=i(650151),r=i(86441),o=i(201089),n=i(444372),a=i(912445),l=i(638456),c=i(809796),h=i(244842);function d(e){const t={};return{promise:new Promise(((i,s)=>{e.subscribe(t,i,!0)})),destroy:()=>{e.unsubscribeAll(t)}}}var u=i(401580),_=i(270294),p=i(142257);class m extends p.UndoCommand{constructor(e,t){super(null),this._chartModel=e,this._targetIndex=t}redo(){const e=this._chartModel.createPane(this._targetIndex,void 0,this._paneId);this._paneId=e.id()}undo(){const e=(0,s.ensureDefined)(this._paneId),t=this._chartModel.panes().find((t=>t.id()===e));void 0!==t&&this._chartModel.removePane(t)}createdPaneId(){return this._paneId}}class g extends p.UndoCommand{constructor(e,t,i,s){super(s),this._setter=e,this._oldValue=t,this._newValue=i}redo(){this._setter(this._newValue)}undo(){this._setter(this._oldValue)}}class S extends g{constructor(e,t,i,s){super((e=>this._vwState.setValue(e)),t,i,s),this._vwState=e}}var v=i(919476),f=i(963239),b=i(793993);const y=(0,o.getLogger)("Clipboard");class C{constructor(e){this._e=e}write(e){return(0,f.writeImpl)(this._toRaw(e),this._e)}_toRaw(e){const t={files:[]};t.text=e.text,void 0!==e.app?t.html=this._serializeAppData(e.app,e.text):e.html&&(t.html=e.html)
;for(const i of e.files||[])t.files.push(i);return t}_serializeAppData(e,t){return`<meta charset="utf-8"><span data-tradingview-clip="${(0,v.htmlEscape)(e)}">${t?(0,v.htmlEscape)(t.slice(0,256)):"&#128200;"}</span>`}}class w{constructor(e){this._e=e}async read(){this._e&&0===this._e.eventPhase&&(y.logWarn("Cannot use an already dispatched ClipboardEvent for reading"),this._e=null);const e=this._e?this._readUsingEvent(this._e):await this._readUsingApi();return this._fromRaw(e)}_readUsingEvent(e){const t=(0,s.ensure)(e.clipboardData);e.preventDefault();const i={files:[]};for(let e=0;e<t.files.length;e++)i.files.push(t.files[e]);for(let e=0;e<t.items.length;e++){const s=t.items[e];"string"===s.kind&&("text/plain"===s.type?i.text=t.getData(s.type):"text/html"===s.type?i.html=t.getData(s.type):i.files.push(new Blob([t.getData(s.type)],{type:s.type})))}return i}async _readUsingApi(){const e=(0,b.getClipboard)();if(!e||!e.read)throw new DOMException("ClipboardApi is not supported","NotSupportedError");let t,i;const s=[],r=await e.read();for(const e of r)for(const r of e.types)"text/html"===r?t=e.getType(r).then(this._readBlobAsText):"text/plain"===r?i=e.getType(r).then(this._readBlobAsText):s.push(e.getType(r));return{text:await i,html:await t,files:await Promise.all(s)}}_fromRaw(e){const t={};if(void 0!==e.text&&(t.text=e.text),void 0!==e.html){const i=this._parseAppData(e.html);i?t.app=i:t.html=e.html}return e.files.length>0&&(t.files=e.files),t}_parseAppData(e){if(-1===e.slice(0,1024).indexOf("data-tradingview-clip"))return;const t=(new DOMParser).parseFromString(e,"text/html").querySelector("[data-tradingview-clip]");return t?t.getAttribute("data-tradingview-clip")||"":void 0}_readBlobAsText(e){return new Promise(((t,i)=>{const s=new FileReader;s.onloadend=()=>{t(s.result)},s.onerror=()=>{i(s.error)},s.readAsText(e)}))}}var P=i(515312);function T(e){const t=e.target;return null!==t&&1===t.nodeType&&(0,P.isTextEditingField)(t)}function M(e){const t=e.target;if(null===t)return!1;const i=(t.ownerDocument||t).getSelection();return null!==i&&!i.isCollapsed}class x extends class{constructor(e){this._callbacks=Object.assign({},e),this._boundOnCopy=this._onCopyEv.bind(this),this._boundOnCut=this._onCutEv.bind(this),this._boundOnPaste=this._onPasteEv.bind(this)}listen(){document.addEventListener("copy",this._boundOnCopy),document.addEventListener("cut",this._boundOnCut),document.addEventListener("paste",this._boundOnPaste)}async peek(){if("granted"!==(await navigator.permissions.query({name:"clipboard-read"})).state)throw new Error("clipboard-read is not granted");return new w(null).read()}uiRequestCopy(e){this._callbacks.copyRequested&&this._callbacks.copyRequested(new C(null),e)}uiRequestCut(e){this._callbacks.cutRequested&&this._callbacks.cutRequested(new C(null),e)}uiRequestPaste(e){this._callbacks.pasteRequested&&this._callbacks.pasteRequested(new w(null),e)}destroy(){document.removeEventListener("copy",this._boundOnCopy),document.removeEventListener("cut",this._boundOnCut),
document.removeEventListener("paste",this._boundOnPaste)}_onCopyEv(e){e.defaultPrevented||this._callbacks.copyRequested&&this._callbacks.copyRequested(new C(e))}_onCutEv(e){e.defaultPrevented||this._callbacks.cutRequested&&this._callbacks.cutRequested(new C(e))}_onPasteEv(e){e.defaultPrevented||this._callbacks.pasteRequested&&this._callbacks.pasteRequested(new w(e))}}{_onCopyEv(e){if(!T(e)&&!M(e))return super._onCopyEv(e)}_onCutEv(e){if(!T(e)&&!M(e))return super._onCutEv(e)}_onPasteEv(e){if(!T(e))return super._onPasteEv(e)}}const I=()=>i.e(54389).then(i.bind(i,425471));function L(e,t={}){return I().then((i=>i.copyToClipboardImageOfChart(e,t)))}function k(e,t={}){return I().then((i=>i.getImageOfChartSilently(e,t)))}var A=i(470316),E=i(410864),D=i(588948),B=i(877009);const R=(0,o.getLogger)("TimingsMeter.Service"),N=(0,o.getLogger)("TimingsMeter.Stats",{maxCount:160});function V(){return{[B.InvalidationLevel.None]:{count:0,lastTime:0,maxTime:0,totalTime:0},[B.InvalidationLevel.Cursor]:{count:0,lastTime:0,maxTime:0,totalTime:0},[B.InvalidationLevel.Light]:{count:0,lastTime:0,maxTime:0,totalTime:0},[B.InvalidationLevel.Full]:{count:0,lastTime:0,maxTime:0,totalTime:0}}}function O(e,t){e.lastTime=t,e.totalTime+=t,++e.count,t>e.maxTime&&(e.maxTime=t)}function F(e){return e.toFixed(2)}function W(e){const t=e.count;if(0===t)return"no events";const i=e.totalTime/t,s=F(e.maxTime);return`count=${t}, last=${F(e.lastTime)}, max=${s}, avg=${F(i)}`}class z{constructor(e){this._waitDrawStartTime=-1,this._startDrawTime=-1,this._currentDrawLevel=B.InvalidationLevel.Full,this._currentDrawItems=V(),this._currentWaitingItem={count:0,lastTime:0,maxTime:0,totalTime:0},this._dumpTimingsStatsInterval=0,this._logPrefix=`[${e}]`}destroy(){this.stopCollect()}startCollect(){0!==this._dumpTimingsStatsInterval&&(R.logWarn(`${this._logPrefix} Multiple start detected`),this.stopCollect()),this._clearCurrentState(),this._dumpTimingsStatsInterval=setInterval(this._dumpTimingsStats.bind(this),15e3),R.logNormal(`${this._logPrefix} Collecting started`)}stopCollect(){0!==this._dumpTimingsStatsInterval&&(clearInterval(this._dumpTimingsStatsInterval),this._dumpTimingsStatsInterval=0,R.logNormal(`${this._logPrefix} Collecting stopped. Dumping last state...`),this._dumpTimingsStats())}startWaitingDraw(){this._waitDrawStartTime=window.performance.now()}startDraw(e){this._startDrawTime=window.performance.now(),this._currentDrawLevel=e}stopDraw(){const e=window.performance.now();if(-1===this._startDrawTime||-1===this._waitDrawStartTime)return;const t=this._startDrawTime-this._waitDrawStartTime;O(this._currentWaitingItem,t),this._waitDrawStartTime=-1;const i=e-this._startDrawTime;O(this._currentDrawItems[this._currentDrawLevel],i),this._startDrawTime=-1}_dumpTimingsStats(){const e=[this._logPrefix," awaiting:",W(this._currentWaitingItem),"; cursor:",W(this._currentDrawItems[B.InvalidationLevel.Cursor]),"; light:",W(this._currentDrawItems[B.InvalidationLevel.Light]),"; full:",W(this._currentDrawItems[B.InvalidationLevel.Full])].join("");N.logNormal(e),
this._clearCurrentState()}_clearCurrentState(){this._currentDrawItems=V(),this._currentWaitingItem={count:0,lastTime:0,maxTime:0,totalTime:0}}}var H=i(922850),U=i(616117);function G(e){return{...e,panes:(t=e.panes,t.map((e=>{return{...e,sources:(t=e.sources,t.filter((e=>!(0,U.isLineToolName)(e.type))))};var t})))};var t}function q(e,t){var i;const s=e.find((e=>e.tools.includes(t)));return null!==(i=null==s?void 0:s.id)&&void 0!==i?i:null}function j(e){var t,i;const r=e.panes.map((e=>e.sources.filter((e=>(0,U.isLineToolName)(e.type))))).reduce(((e,t)=>t.concat(e)),[]),o=null!==(i=null===(t=e.lineToolsGroups)||void 0===t?void 0:t.groups)&&void 0!==i?i:[],n=new Map;r.forEach((e=>{const t=e.id;n.set(t,function(e,t){var i;return{id:e.id,symbol:e.state.symbol,ownerSource:(0,s.ensureDefined)(e.ownerSource),state:e,groupId:null!==(i=q(t,e.id))&&void 0!==i?i:void 0}}(e,o))}));const a=new Map;return o.forEach((e=>{const t=function(e,t){var i,s;if(0===e.tools.length)return null;const r=e.tools[0];return null!==(s=null===(i=t.get(r))||void 0===i?void 0:i.symbol)&&void 0!==s?s:null}(e,n);null!==t&&a.set(e.id,{id:e.id,name:e.name,symbol:t})})),{sources:n,groups:a}}var Y=i(531005),K=i(405117),X=i(778016),$=i(833813),Z=i(960337),Q=i(371927),J=i(154765),ee=i(500521),te=i(175203),ie=i(314802),se=i(125226),re=i(368654),oe=i(45696),ne=i(594520),ae=i(944454),le=i(266325),ce=i(930003);const he=new class{constructor(){this._timerWorker=null,this._timerIdCounter=1,this._timersMap=new Map,this._rejectsToCall=new Set,this._processMessage=e=>{const t=this._timersMap.get(e.data.turnaround);switch(e.data.type){case"timerCreated":t&&(t.scheduledForRemoving?("interval"===t.type?this._getTimerWorker().postMessage({type:"clearInterval",id:e.data.id}):this._getTimerWorker().postMessage({type:"clearTimeout",id:e.data.id}),this._deleteTimerFromMap(e.data.turnaround)):t.workerTimerId=e.data.id);break;case"timerFired":t&&(t.callback(),"timeout"===t.type&&this._deleteTimerFromMap(e.data.turnaround))}}}destroy(){var e;this._rejectsToCall.forEach((e=>e((0,le.createAbortError)()))),null===(e=this._timerWorker)||void 0===e||e.terminate(),this._timerWorker=null,this._timersMap.clear()}setTimeout(e,t){return this._setTimeoutImpl(e,t,"timeout")}clearTimeout(e){const t=this._timersMap.get(e);t&&(t.workerTimerId?(this._getTimerWorker().postMessage({type:"clearTimeout",id:t.workerTimerId}),this._deleteTimerFromMap(e)):t.scheduledForRemoving=!0)}setInterval(e,t){const i=this._nextTimerId();return this._timersMap.set(i,{callback:e,type:"interval"}),this._getTimerWorker().postMessage({type:"setInterval",delay:t,turnaround:i}),i}clearInterval(e){const t=this._timersMap.get(e);t&&(t.workerTimerId?(this._getTimerWorker().postMessage({type:"clearInterval",id:t.workerTimerId}),this._deleteTimerFromMap(e)):t.scheduledForRemoving=!0)}async createTimeout(e,t){let i;return new Promise(((s,r)=>{var o;i=r,this._rejectsToCall.add(i);const n=this.setTimeout(s,e);null===(o=null==t?void 0:t.signal)||void 0===o||o.addEventListener("abort",(()=>{this.clearTimeout(n),r((0,
le.createAbortError)())}))})).finally((()=>{this._rejectsToCall.delete(i)}))}async*createInterval(e,t){let i=()=>{},s=e=>{};const r=this.setInterval((()=>{i()}),e);t.signal.addEventListener("abort",(()=>{this.clearInterval(r),s((0,le.createAbortError)())}));try{for(;;)await new Promise(((e,t)=>{i=e,this._rejectsToCall.delete(s),s=t,this._rejectsToCall.add(s)})),yield}catch(e){if(!(0,le.isAbortError)(e))throw e}}_getTimerWorker(){return null===this._timerWorker&&(this._timerWorker=new ce.Worker(new URL(i.p+i.u(77050),i.b),{name:"Timer worker"}),this._timerWorker.onmessage=this._processMessage),this._timerWorker}_setTimeoutImpl(e,t,i){const s=this._nextTimerId();return this._timersMap.set(s,{callback:e,type:i}),this._getTimerWorker().postMessage({type:"setTimeout",delay:t,turnaround:s}),s}_deleteTimerFromMap(e){if(this._timersMap.delete(e),0===this._timersMap.size){const e=this._setTimeoutImpl((()=>{var t;1===this._timersMap.size&&this._timersMap.has(e)&&(this._timersMap.delete(e),null===(t=this._timerWorker)||void 0===t||t.terminate(),this._timerWorker=null)}),6e4,"terminal_timer")}}_nextTimerId(){return this._timerIdCounter++}};var de=i(707957),ue=i(359663);const _e=new Set(["chart_storage_hibernation_delay_60min","chart_storage_hibernation_delay_10min","chart_storage_hibernation_delay_5min"]);const pe=new u.WatchedValue(me());function me(){return(0,se.isFeatureEnabled)("chart_storage_hibernation_delay_60min")?36e5:(0,se.isFeatureEnabled)("chart_storage_hibernation_delay_10min")?6e5:(0,se.isFeatureEnabled)("chart_storage_hibernation_delay_5min")?3e5:6e4}(0,se.onFeaturesStateChanged)().subscribe(null,(e=>{if(!function(e){return _e.has(e)}(e))return;const t=me();pe.setValue(t,!1)}));const ge=pe.readonly();function Se(e){const t=document.querySelector('link[rel~="chart-storage-notifications"]');return(null==t?void 0:t.href)?e?new URL(e,t.href):new URL(t.href):null}const ve=new ue.FeatureToggleWatchedValue("do_not_reload_line_tools_on_reconnection",!1);function fe(e,t){return Boolean(e.metaInfo.uid.value())&&!t.containsData&&!t.onWidget&&(0,se.isFeatureEnabled)("subscribe_line_tool_notifications")&&function(){if(!(0,ie.isOnMobileAppPage)("new"))return!0;const e=/TradingView\/(\d+)\.(\d+)\.(\d+)\.?/.exec(navigator.userAgent);if(null===e)return!0;const t=Number(e[1])-1,i=Number(e[2])-15,s=Number(e[3])-0;if(t>0||0===t&&i>0||0===t&&0===i&&s>0)return!0;return!1}()&&null!==Se()}const be=(0,o.getLogger)("ChartStorageChangesSubscription");class ye extends re.PersistentEventSourceTransport{constructor(e,t){super((e=>this._onMessage(e))),this._destroyed=!1,this._onChangeVisibilityBound=this._onChangeVisibility.bind(this),this._hibernateTimerId=null,this._hibernateDelay=ge.spawn(),this._beforeUnhibernating=new de.Delegate,this._haveEverBeenHibernated=!1,this._chartWidgetsCollection=e,this._layoutVisibility=e.resizerBridge().visible.spawn(),this._layoutVisibility.subscribe(this._onChangeVisibilityBound,{callWithLast:!0}),te.telemetry.sendLineToolsStorageReport("line_tools_subscription_initial_connect"),
this._connectionStatus.subscribe((e=>{e===ae.ConnectionStatus.Closed&&te.telemetry.sendLineToolsStorageReport("line_tools_subscription_disconnected")})),this._subscribeForSharingLayout=t,this.connect(),this._hibernateDelay.subscribe((e=>{null!==this._hibernateTimerId&&this._scheduleHibernation(e)}))}destroy(){this._layoutVisibility.destroy(),this._hibernateDelay.destroy(),this.disconnect(),this._destroyed=!0}beforeUnhibernating(){return this._beforeUnhibernating}async _prepareParamsForConnection(e){const t=this._chartWidgetsCollection.metaInfo.uid.value();if(this._destroyed)return Promise.reject("Subscription is being destroyed");const i=await(0,oe.getStorageTarget)(t,"",0),s=Se(`/charts-storage/layout/${t}/subscribe`);null!==s?(s.searchParams.delete("jwt"),s.searchParams.append("jwt",i.token),this._subscribeForSharingLayout&&window.user.id&&window.user.is_pro&&s.searchParams.append("id",""+window.user.id),this._url=s.toString()):this._url=""}_tryReconnectImpl(){super._tryReconnectImpl(),te.telemetry.sendLineToolsStorageReport("line_tools_subscription_reconnecting")}_onMessage(e){if("string"!=typeof e)throw new Error("Wrong message type, expected string");const t=JSON.parse(e);Object.entries(t).forEach((e=>{const t=(0,ne.parseLineToolsAndGroupsDTO)(e[1],""),i=e[0];let s=0;i===oe.sharedChartId?s=1:i===oe.globallySharedChartId&&(s=2),this._chartWidgetsCollection.applyLineToolUpdateNotification(i,t,s)}))}_onChangeVisibility(){const e=this._layoutVisibility.value();e&&this.connectionStatus().value()===ae.ConnectionStatus.Closed?(this.connect(),this._beforeUnhibernating.fire(),this._haveEverBeenHibernated&&(be.logNormal("Connect due to becoming visible"),te.telemetry.sendLineToolsStorageReport("line_tools_unhibenate_subscription"))):e||this._scheduleHibernation(ge.value())}_scheduleHibernation(e){null!==this._hibernateTimerId&&he.clearTimeout(this._hibernateTimerId),this._hibernateTimerId=he.setTimeout((()=>this._disconnectIfInvisible()),e)}_disconnectIfInvisible(){this._hibernateTimerId=null,!this._layoutVisibility.value()&&(0,se.isFeatureEnabled)("hibernate_line_tool_notifications")&&(be.logNormal("Disconnect due to becoming invisible"),this.disconnect(),te.telemetry.sendLineToolsStorageReport("line_tools_hibenate_subscription"),this._haveEverBeenHibernated=!0)}}var Ce=i(850775),we=i(743354),Pe=i(251954),Te=i(429874),Me=i(228018),xe=i(674981),Ie=i(541558),Le=i(533422),ke=i(581996),Ae=i(300426),Ee=i(208044),De=i(103221),Be=i(431912),Re=i(237872);const Ne=new c.TranslatedString("change chart layout to {title}",n.t(null,void 0,i(130501)));class Ve extends p.UndoCommand{constructor(e,t){super(Ne.format({title:Le.layouts[t].title})),this._chartWidgetCollection=e,this._newLayoutType=t,this._oldLayoutType=e.layout.value()}redo(){this._chartWidgetCollection.setLayout(this._newLayoutType)}undo(){this._chartWidgetCollection.setLayout(this._oldLayoutType)}}var Oe=i(389137),Fe=i(331633);const We=new c.TranslatedString("apply toolbars theme",n.t(null,void 0,i(558570)));class ze extends p.UndoCommand{constructor(e,t,i=!0){super(We),
this._prevThemeName=e,this._themeName=t,this._syncState=i}undo(){(0,Te.isStdThemeName)(this._prevThemeName)&&((0,Fe.setTheme)(this._prevThemeName),this._syncState&&(0,Te.syncTheme)())}redo(){(0,Te.isStdThemeName)(this._themeName.toLowerCase())&&((0,Fe.setTheme)(this._themeName.toLowerCase()),this._syncState&&(0,Te.syncTheme)())}}var He=i(66732),Ue=i(784547),Ge=i(885482),qe=i(938550),je=i(223699),Ye=i(779923),Ke=i(731042),Xe=i(581501);i(877825);const $e=!l.CheckMobile.any(),Ze=(0,o.getLogger)("ChartWidgetCollectionBase"),Qe=new c.TranslatedString("apply indicators to entire layout",n.t(null,void 0,i(744547))),Je=new c.TranslatedString("sync time",n.t(null,void 0,i(260635))),et=new c.TranslatedString("resize layout",n.t(null,void 0,i(113034))),tt=new c.TranslatedString("reset layout sizes",n.t(null,void 0,i(830910))),it=new c.TranslatedString("apply chart theme",n.t(null,void 0,i(766568))),st=new c.TranslatedString("symbol lock",n.t(null,void 0,i(292831))),rt=new c.TranslatedString("interval lock",n.t(null,void 0,i(128916))),ot=new c.TranslatedString("date range lock",n.t(null,void 0,i(390621))),nt=new c.TranslatedString("track time",n.t(null,void 0,i(247122))),at=n.t(null,void 0,i(46669)),lt=n.t(null,void 0,i(398478)),ct=n.t(null,void 0,i(834004)),ht=n.t(null,void 0,i(796260)),dt=n.t(null,void 0,i(838641)),ut=n.t(null,void 0,i(110160)),_t=n.t(null,void 0,i(219149)),pt=n.t(null,void 0,i(838660));function mt(e,t){const i=t.model().model().studyTemplate();e.undoHistory.beginUndoMacro(Qe);for(let s=0;s<e.chartWidgetsDefs.length;s++){const r=e.chartWidgetsDefs[s].chartWidget;r!==t&&(r.hasModel()&&r.model().applyStudyTemplate(i,""))}e.undoHistory.endUndoMacro()}async function gt(e,t,i,r,o){e.undoHistory.beginUndoMacro(o);for(let n=0;n<e.chartWidgetsDefs.length;n++){const a=e.chartWidgetsDefs[n].chartWidget;if(a!==t&&a&&a.hasModel()){const t=a.model();let n;if(r.isOnMainPane)n=(0,s.ensureNotNull)(t.model().paneForSource(a.model().model().mainSeries()));else{const i=new m(t.model(),r.paneIndex);e.undoHistory.pushUndoCommand(i);const o=(0,s.ensureDefined)(i.createdPaneId());n=(0,s.ensureDefined)(t.model().panes().find((e=>e.id()===o)))}const l=await t.pasteSourceFromClip(n,i,!0);if(l&&1===l.length){const e=l[0];if(r.asCompare){const i=(0,s.ensureNotNull)(t.mainSeries().priceScale());t.moveToScale(e,(0,s.ensureDefined)(n),i,o),t.setPriceScaleMode({percentage:!0},i,null)}}t.model().lightUpdate()}}e.undoHistory.endUndoMacro()}function St(e){let t=1;for(;e.has(""+t);)t++;return""+t}function vt(e){const t=new Map,i=e.chartsCountToSave(),s=new Set;for(let r=0;r<i;r++)if(r<e.chartWidgetsDefs.length){const i=e.chartWidgetsDefs[r].chartWidget,o=i.id(),n=i.lineToolsAndGroupsDTO();t.set(o,n),s.add(o)}else{const i=e.savedChartWidgetOptions[r-e.chartWidgetsDefs.length].content;i.chartId||(i.chartId=St(s));const o=new Map;o.set(0,j(i)),t.set(i.chartId,o),s.add(i.chartId)}return t}function ft(e,t,i,s,r,o){if(t<e.chartWidgetsDefs.length){const n=e.chartWidgetsDefs[t].chartWidget
;return t<e.actualLayoutCount()||n.shouldBeSavedEvenIfHidden()?n.state(i,s,r,o):null}return function(e,t,i,s,r){return r?G(e):e}(e.savedChartWidgetOptions[t-e.chartWidgetsDefs.length].content,0,0,0,o)}function bt(e,t){return t<e.chartWidgetsDefs.length?e.chartWidgetsDefs[t].chartWidget.asyncState():Promise.resolve({})}function yt(e,t){return e.chartWidgetsDefs[0].chartWidget===t}function Ct(e){return e.savedChartWidgetOptions.map((e=>(0,s.ensureDefined)(e.content.chartId)))}function wt(e,t,i){const s=e.chartsCountToSave();i.forEach((i=>{const s=(r=i.chartId,null!==(n=null===(o=e.chartWidgetsDefs.find((e=>e.chartWidget.id()===r)))||void 0===o?void 0:o.chartWidget)&&void 0!==n?n:null);var r,o,n;null==s||s.resetLineToolsInvalidated(t,i.savedDto,i.sharingMode)}));for(let t=e.chartWidgetsDefs.length;t<s;t++){const i=G(e.savedChartWidgetOptions[t-e.chartWidgetsDefs.length].content);e.savedChartWidgetOptions[t-e.chartWidgetsDefs.length].content=i}}function Pt(e,t,i,s){const r=e.map((e=>e.chartWidget)).filter((e=>e.hasModel())).filter((e=>e.id()===t||0!==s));try{r.forEach((e=>e.startApplyingLineToolUpdateNotification())),r.forEach((e=>e.applyLineToolUpdateNotification(i,s)))}finally{r.forEach((e=>e.endApplyingLineToolUpdateNotification()))}}function Tt(e){return e instanceof Error?e.message:null}function Mt(e){return new x({copyRequested:(t,i)=>{e.activeChartWidget.value().model().clipboardCopy(t,i).catch((t=>{var i;null===(i=e.toastsFactory)||void 0===i||i.getChartToasts().then((e=>{var i;(0,s.ensureNotNull)(e).showSimpleToast({title:lt,text:null!==(i=Tt(t))&&void 0!==i?i:at.format({keystroke:(0,A.humanReadableHash)(A.Modifiers.Mod+67)}),role:"alert",intent:E.ToastIntent.Warning})}))}))},cutRequested:(t,i)=>{e.activeChartWidget.value().model().clipboardCut(t,i).catch((t=>{var i;null===(i=e.toastsFactory)||void 0===i||i.getChartToasts().then((e=>{var i;(0,s.ensureNotNull)(e).showSimpleToast({title:ct,text:null!==(i=Tt(t))&&void 0!==i?i:at.format({keystroke:(0,A.humanReadableHash)(A.Modifiers.Mod+88)}),role:"alert",intent:E.ToastIntent.Warning})}))}))},pasteRequested:(t,i)=>{(i?i.model().undoModel():e.activeChartWidget.value().model()).clipboardPaste(t,i).catch((t=>{var i;null===(i=e.toastsFactory)||void 0===i||i.getChartToasts().then((e=>{var i;(0,s.ensureNotNull)(e).showSimpleToast({title:ht,text:null!==(i=Tt(t))&&void 0!==i?i:at.format({keystroke:(0,A.humanReadableHash)(A.Modifiers.Mod+86)}),role:"alert",intent:E.ToastIntent.Warning})}))}))}})}function xt(e,t){(0,Y.setBroker)(t),e.chartWidgetsDefs.forEach((e=>{var i;return null===(i=e.chartWidget)||void 0===i?void 0:i.setBroker(t)}))}function It(e){const t={};return e.chartWidgetsDefs.map((e=>e.chartWidget)).forEach((e=>t[e.id()]=function(e){var t,i,r,o,n;const a={};if(!e.hasModel()){const o=e.options().content;if(!o)return a;const n=(0,s.ensureNotNull)(o.panes.reduce(((e,t)=>{var i;return null!==(i=null!=e?e:t.sources.find((e=>"MainSeries"===e.type)))&&void 0!==i?i:null}),null));return a.resolution=null===(t=n.state)||void 0===t?void 0:t.interval,
a.symbol=null===(i=n.state)||void 0===i?void 0:i.symbol,a.short_name=null===(r=n.state)||void 0===r?void 0:r.shortName,a}const l=e.model().mainSeries(),c=l.properties().childs(),h=l.symbolInfo();a.resolution=c.interval.value(),a.symbol_type=null!==h&&h.type||"",a.exchange=null!==h&&h.exchange||"",a.listed_exchange=null!==h&&h.listed_exchange||"";const d=null!==(o=null==h?void 0:h.legs)&&void 0!==o?o:[];if(null!==h&&l.isSpread()){const e=d[0];let t=h.base_name[0];t=t.split(":")[1],a.symbol=e,a.short_name=t,a.expression=h.full_name}else a.symbol=null!==h&&h.ticker||c.symbol.value(),a.short_name=c.shortName.value();const u=null!==(n=null==h?void 0:h.base_name)&&void 0!==n?n:[];return a.legs=d.map(((e,t)=>({symbol:e,pro_symbol:u[t]}))),a}(e))),t}function Lt(e,t){if(fe(e,t.widgetOptions)){const i=new ye(e,!e.readOnly());i.beforeUnhibernating().subscribe(e,(()=>{ve.value()||function(e){e.chartWidgetsDefs.map((e=>e.chartWidget)).forEach((e=>e.reloadAllLineTools()))}(t)})),t.setChartStorageNotificationSubscription(i)}}function kt(e,t){const i={snapshotUrl:e};return i.asyncSave=!window.TVD,k(t,i).then((e=>((0,Pe.emit)("onScreenshotReady",e),e)))}function At(e,t){const i={snapshotUrl:e};i.asyncSave=!window.TVD;const s=(0,ie.isOnMobileAppPage)("any");return(s?k:L)(t,i).then((e=>((0,Pe.emit)("onScreenshotReady",e),s||(0,Pe.emit)("onServerScreenshotCopiedToClipboard"),e)))}function Et(e){return function(e){return I().then((t=>t.downloadClientScreenshot(e)))}(e)}function Dt(e){return function(e){return I().then((t=>t.copyToClipboardClientScreenshot(e)))}(e).then((()=>{(0,Pe.emit)("onClientScreenshotCopiedToClipboard")}))}const Bt={s:0,"2h":0,"2v":1,"2-1":1,"3s":0,"3h":0,"3v":2,4:1,6:1,8:1,"1-2":1,"3r":1,"4h":0,"4v":3,"4s":0,"5h":0,"6h":0,"7h":0,"8h":0,"1-3":1,"2-2":3,"2-3":2,"1-4":1,"5s":0,"6c":4,"8c":6,"10c5":1,"12c6":1,"12c4":3,"14c7":1,"16c8":1,"16c4":3};function Rt(e,t,i,s){let r=0;const o=(0,Ue.createWVFromGetterAndSubscriptions)((()=>++r),[i,s]);return(0,He.combine)((t=>{var i;return null!==(i=e()[Bt[t]])&&void 0!==i?i:null}),t.weakReference(),o.ownership())}function Nt(e,t,i,s){const r=Math.max(1,window.devicePixelRatio||1),o=e.getAll();let n;{const s=t||"TradingView.com";let r=e.activeChartWidget.value().properties().childs().timezone.value();if("exchange"===r){const t=e.activeChartWidget.value().model().mainSeries().symbolInfo();r=t?t.timezone:r}const o={timezone:r,dateFormat:"MMM dd, yyyy"},a=new we.DateTimeWithTzFormatter(o).format(window.ChartApiInstance.serverTime()/1e3),l=e.metaInfo.username.value(),c=!l||e.readOnly()||i?ut:dt,h=[c.split(/{date}/)[0].format({userName:l,customer:s}).trim(),a],d=[c.format({userName:l,customer:s,date:a}).trim()];n="phone-vertical"===Ce.mediaState.device?h:d}const a=e.maximizedChartWidget().value();if(s&&s.onlyActiveChart||a)return{layout:"s",hidpiRatio:r,theme:(0,Te.getCurrentTheme)().name,charts:[e.activeChartWidget.value().images(s)],publishedBy:n};const l=[],c=Le.layouts[e.layout.value()].count,h={showCollapsedStudies:(s=s||{}).showCollapsedStudies,status:s.status}
;for(let e=0;e<o.length&&e<c;e++)l.push(o[e].images(h));return{layout:e.layout.value(),hidpiRatio:r,theme:(0,Te.getCurrentTheme)().name,charts:l,publishedBy:n}}function Vt(e,t,i,s){const r=s||{},o={hideResolution:Boolean(r.hideResolution)};return r.showHeaderPublishedBy=!0,(0,Me.clientSnapshot)(Nt(e,t,i,{showCollapsedStudies:!1,status:o}),r)}function Ot(e){var t,i,s,r,o,n;const a=(null!==(t=e.options.edge)&&void 0!==t?t:0)+(null!==(i=e.options.border)&&void 0!==i?i:0),l=null!==(r=null===(s=e.bottomToolbar.value())||void 0===s?void 0:s.offsetHeight)&&void 0!==r?r:0,c=null!==(n=null===(o=e.replayContainer)||void 0===o?void 0:o.offsetHeight)&&void 0!==n?n:0;return{width:e.widthWV.value()-2*a,height:e.heightWV.value()-l-c-a,top:0,left:a}}function Ft(e){return`chart-widget-collection-border-${e}`}class Wt{constructor(e,t,i){this._onShiftPressed=e=>{const t=this._state.currentLayoutResizeAction.value();t&&this._applyMouseMove(t.delta,e)},this._state=e,this._splitterElement=t,this._splitter=i,(0,Re.shiftPressed)().subscribe(this._onShiftPressed)}destroy(){(0,Re.shiftPressed)().unsubscribe(this._onShiftPressed)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e)}mouseEnterEvent(e){this._highlightSplitters(e.shiftKey)}mouseLeaveEvent(e){const t=Ft(this._splitter.className);Array.from(this._state.parent.getElementsByClassName(t)).forEach((e=>e.classList.remove(Xe.hovered)))}mouseDoubleClickEvent(e){const t=(0,Ee.layoutInitialSizingState)(this._state.layoutTemplate.value().expression);this._state.undoHistory.beginUndoMacro(tt),this._state.undoHistory.pushUndoCommand(new S(this._state.sizingState,this._state.sizingState.value(),t,tt));const i=this._state.layoutTemplate.value().layoutType;this._state.undoHistory.pushUndoCommand(new g((e=>e?this._state.allLayoutSizesState.set(i,e):this._state.allLayoutSizesState.delete(i)),this._state.allLayoutSizesState.get(this._state.layoutTemplate.value().layoutType),t,tt)),this._state.undoHistory.endUndoMacro()}_highlightSplitters(e){const t=Ft(this._splitter.className);Array.from(this._state.parent.getElementsByClassName(t)).forEach((e=>e.classList.remove(Xe.hovered)));(e?Array.from(this._state.parent.getElementsByClassName(t)):[this._splitterElement]).forEach((e=>e.classList.add(Xe.hovered)))}_mouseDownOrTouchStartEvent(e){const t=new r.Point(e.localX+this._splitterElement.offsetLeft,e.localY+this._splitterElement.offsetTop),i=(0,De.deepCopy)(this._state.sizingState.value());this._state.currentLayoutResizeAction.setValue({point:t,splitter:this._splitter,initialState:i,alignedState:this._state.layoutTemplate.value().syncSublayoutsBySplitter(this._splitter,(0,De.deepCopy)(i)),shiftState:e.shiftKey,delta:0}),this._splitterElement.classList.add(Xe["i-active"]),this._highlightSplitters(e.shiftKey)}
_pressedMouseOrTouchMoveEvent(e){const t=this._state.currentLayoutResizeAction.value();if(!t)return;t.shiftState!==e.shiftKey&&(this._highlightSplitters(e.shiftKey),t.shiftState=e.shiftKey);const i=new r.Point(e.localX+this._splitterElement.offsetLeft,e.localY+this._splitterElement.offsetTop);t.delta="v"===t.splitter.orientation?i.y-t.point.y:i.x-t.point.x,this._applyMouseMove(t.delta,e.shiftKey)}_mouseUpOrTouchEndEvent(e){const t=this._state.currentLayoutResizeAction.value();if(t&&(this._splitterElement.classList.remove(Xe["i-active"]),this._state.currentLayoutResizeAction.setValue(null),t.currentState)){this._state.undoHistory.beginUndoMacro(et),this._state.undoHistory.pushUndoCommand(new S(this._state.sizingState,t.initialState,t.currentState,et));const e=this._state.layoutTemplate.value().layoutType;this._state.undoHistory.pushUndoCommand(new g((t=>t?this._state.allLayoutSizesState.set(e,t):this._state.allLayoutSizesState.delete(e)),this._state.allLayoutSizesState.get(this._state.layoutTemplate.value().layoutType),this._state.sizingState.value(),tt)),this._state.undoHistory.endUndoMacro(),this._state.layoutSizesChanged.setValue(!0)}}_applyMouseMove(e,t){var i;const r=(0,s.ensureNotNull)(this._state.currentLayoutResizeAction.value()),o=t?r.alignedState:r.initialState,n=null!==(i=this._state.options.padding)&&void 0!==i?i:2,a=Ot(this._state);r.currentState=this._state.layoutTemplate.value().resizeApplier(a,n,e,r.splitter,(0,De.deepCopy)(o),t),this._state.sizingState.setValue(r.currentState)}}function zt(e,t,i,s,r){var o,n;const a=null!==(o=e.options.padding)&&void 0!==o?o:2,l=null!==(n=e.options.border)&&void 0!==n?n:0;r=null!=r?r:e.layoutTemplate.value();const c=Ot(e),h=r.sizer(c,i,s,a+l,$e?e.sizingState.value():void 0);h.width=Math.max(Math.round(h.width),0),h.height=Math.max(Math.round(h.height),0),h.top=Math.round(h.top),h.left=Math.round(h.left),t.metrics=h;const d=t.container.value();if(d){d.style.width=h.width+"px",d.style.height=h.height+"px",d.style.top=h.top+"px",d.style.left=h.left+"px";const e=1===s;d.classList.toggle("single-visible",e);const t=Math.round(c.width),i=0===h.top&&0===h.left,r=0===h.top&&h.left+h.width===t,o=0===h.top&&h.width===t;d.classList.toggle("top-left-chart",!e&&!o&&i),d.classList.toggle("top-right-chart",!e&&!o&&r),d.classList.toggle("top-full-width-chart",e||o)}t.width.setValue(h.width),t.height.setValue(h.height)}function Ht(e){var t,i,s;let r;const o=e.layoutTemplate.value(),n=e.maximizedChartDef.value();if(r=n?[n]:e.chartWidgetsDefs.slice(0,o.count).filter((e=>!e.hiddenInLayout.value())),r.forEach(((t,i)=>zt(e,t,i,r.length))),$e&&!e.maximizedChartDef.value()){const r=Ot(e),n=null!==(t=e.options.padding)&&void 0!==t?t:2,a=null!==(i=e.options.border)&&void 0!==i?i:0,l=o.splitters(r,n+a,e.sizingState.value()),c=null!==(s=e.splitters.value())&&void 0!==s?s:[];c.forEach(((e,t)=>{t>=l.length&&(e.splitterElement.remove(),e.mouseHandler.destroy(),e.mouseListener.destroy())}));const h=l.map(((t,i)=>{const s=i<c.length?c[i].splitterElement:document.createElement("div");let r,o
;i<c.length?(r=c[i].mouseListener,o=c[i].mouseHandler):(r=new Wt(e,s,t),o=new Be.MouseEventHandler(s,r));const n=t.metrics,a=s.classList.contains(Xe.hovered),l=s.classList.contains(Xe["i-active"]);return s.className="",s.classList.add(Xe.chartsSplitter),s.classList.add(Ft(t.className)),a&&s.classList.add(Xe.hovered),l&&s.classList.add(Xe["i-active"]),s.style.left=n.left+"px",s.style.top=n.top+"px",s.style.width=n.width+"px",s.style.height=n.height+"px","v"===t.orientation?s.style.cursor="ns-resize":s.style.cursor="ew-resize",e.parent.appendChild(s),{splitter:t,splitterElement:s,mouseHandler:o,mouseListener:r}}));e.splitters.setValue(h)}}function Ut(e,t,i){const s=e.chartWidgetsDefs.slice(0,e.layoutTemplate.value().count).map(((t,i,s)=>({def:t,metrics:e.layoutTemplate.value().sizer({top:0,left:0,width:256,height:256},i,s.length,0)}))).sort(((e,t)=>e.metrics.top-t.metrics.top||e.metrics.left-t.metrics.left)).map((e=>e.def));if(s.length<2)return null;let r=s.indexOf(t);return-1===r?null:(r=(r+(i?s.length-1:1))%s.length,s[r])}function Gt(e,t){return e.chartWidgetsDefs.some((e=>{var i;return(null===(i=e.chartWidget)||void 0===i?void 0:i.id())===t}))}function qt(e){let t=1;for(;e(""+t);)t++;return""+t}function jt(e){const t=e.activeChartWidget.value();if(t){const i=t.state();return i.chartId=qt((t=>Gt(e,t))),i.shouldBeSavedEvenIfHidden=!1,i.panes.forEach((e=>{e.sources.forEach((e=>{"alertId"in e&&(e.alertId=void 0)}))})),{content:i}}}function Yt(e,t,i){const s=[];if(null==i?void 0:i.publishedChartsEnabled){const i=new H.PublishedChartsTimeline(e,(e=>function(e,t){e={...e,chartWidgetCollection:t},(0,ee.pushChartPage)(e)}(e,t)));s.push(i)}return s}function Kt(e,t,i){var r,o;const{toastsFactory:n,chartWidgetsDefs:a,customLegendWidgetsFactoriesMap:c}=e;let h={chartWidgetCollection:t,isActive:0===a.length,barsMarksContainersFactory:i=>Yt(i,t,e.options),undoHistory:e.undoHistory,readOnly:e.readOnly,initialLoading:e.initialLoading,getToasts:n?()=>n.getChartToasts():void 0,...null!=i?i:{}};void 0!==c&&(h.customLegendWidgetFactories=new Map(c));const d=document.createElement("div");d.classList.add("chart-container"),d.style.position="absolute",d.style.overflow="hidden",e.parent.appendChild(d),l.isEdge&&(d.style.touchAction="none",d.style.msTouchAction="none"),h.className&&d.classList.add(h.className);const _={alive:new u.WatchedValue(!0),container:new u.WatchedValue(d),width:new u.WatchedValue,height:new u.WatchedValue,collapsed:new u.WatchedValue(!1),hiddenInLayout:new u.WatchedValue(!1),visible:new u.WatchedValue,rdState:new ke.ResizerDetacherState,requestFullscreen:()=>{e.globalDetachable.value()&&(e.setMaximized(_),e.activeChartWidget.setValue((0,s.ensureNotNull)(_.chartWidget)))},exitFullscreen:()=>{e.activeChartWidget.value()===_.chartWidget&&e.setMaximized(null)},detachable:e.globalDetachable,fullscreenable:e.globalDetachable,fullscreen:new u.WatchedValue,chartWidget:null};_.rdState.pushOwner(_),a.push(_);const p=()=>{_.visible.setValue(!_.hiddenInLayout.value()&&e.options.resizerBridge.visible.value())}
;_.hiddenInLayout.subscribe((()=>{(0,s.ensureNotNull)(_.chartWidget).setVisible(!_.hiddenInLayout.value()),p()})),_.collapsed.subscribe((()=>(0,s.ensureNotNull)(_.chartWidget).setCollapsed(_.collapsed.value()))),e.options.resizerBridge.visible.subscribe(p),p(),function(e,t){let i=0,s=0;const r=t.layoutTemplate.value();for(let o=0;o<r.count;o++)t.chartWidgetsDefs[o]===e&&(s=i),i++;zt(t,e,s,i,r)}(_,e),h={...h,..._.rdState.bridge()};const m=h.content?(0,s.ensureDefined)(h.content.chartId):qt((t=>Gt(e,t))),g=_.chartWidget=new Ae.ChartWidget(h,m,t.metaInfo.uid.value());e.saveChartService&&g.setSaveChartService(e.saveChartService),e.readOnly||(_.timingsMeter=new z(String(a.length-1)),g.setTimingsMeter(_.timingsMeter)),h.containsData?g.finishInitWithoutConnect():g.connect(),g.withModel(null,(()=>{const t=g.model().model();e.customSources.forEach(((e,i)=>{t.addCustomSource(i,e.factory,e.layer)}))})),e.updateWatchedValue(),e.updateActivityView();const S=null!==(o=null===(r=null==h?void 0:h.content)||void 0===r?void 0:r.linkingGroup)&&void 0!==o?o:null;g.linkingGroupIndex().setValue(S),g.linkingGroupIndex().subscribe(e.updateLinkingGroupCharts);const v=Ii(e,S).value();return v.length>0&&(e.symbolLock.value()&&g.setSymbol(v[0].symbolWV().value()),e.intervalLock.value()&&g.setResolution(v[0].resolutionWV().value())),e.updateLinkingGroupCharts(),e.chartWidgetCreatedDelegate.fire(g),_}function Xt(e,t,i,s){const r={...e.widgetOptions,...e.savedChartWidgetOptions.shift()||jt(e),...0===i||e.symbolLock.value()?void 0:{defSymbol:null}},o=Kt(e,t,r),{chartWidget:n}=o;return n.modelCreated().subscribe(null,(()=>{s?s():e.checkAllPendingModelsAlreadyCreated(),e.dateRangeLock.value()&&n===e.activeChartWidget.value()&&e.subscribeToCompletedEventForDateRangeSync(n,!0)}),!0),o}function $t(e){e.hiddenInLayout.setValue(!0);const t=e.container.value();t.parentNode&&t.parentNode.removeChild(t),e.fullscreen.setValue(!1)}function Zt(e,t){e.chartWidgetsDefs.forEach((i=>{const r=(0,s.ensureNotNull)(i.chartWidget);r.onZoom().unsubscribeAll(t),r.onScroll().unsubscribeAll(t),r.withModel(null,(()=>{const t=r.lineToolsSynchronizer();null!==t&&(t.hasChanges().unsubscribe(e.recalcHasChanges),e.recalcHasChanges())}))}))}function Qt(e,t){e.chartWidgetsDefs.forEach((i=>{const r=(0,s.ensureNotNull)(i.chartWidget);r.onZoom().subscribe(t,(t=>e.onZoom.fire(t))),r.onScroll().subscribe(t,(()=>e.onScroll.fire())),r.withModel(null,(()=>{const t=r.lineToolsSynchronizer();null!==t&&(t.hasChanges().subscribe(e.recalcHasChanges),e.recalcHasChanges())}))}))}const Jt=["2-3","5h","6h","7h","8h"],ei=["10c5","12c6","12c4","14c7","16c8","16c4"];async function ti(e,t,i){var r,o;(0,D.getInitData)().is_mobile_new&&(Jt.includes(t)&&!(0,h.enabled)("mobile_app_supports_new_layout_types")||ei.includes(t)&&!(0,h.enabled)("mobile_app_supports_new_layout_types_2"))&&(t="s");try{const t=e.chartWidgetsDefs.map((e=>{var t,i,s;return null!==(s=null===(i=null===(t=e.chartWidget)||void 0===t?void 0:t.lineToolsSynchronizer())||void 0===i?void 0:i.flushPendingSavings())&&void 0!==s?s:null
})).filter(Oe.notNull);t.length&&await Promise.all(t)}catch(e){Ze.logError(`Error flushing line tools: ${e}`)}(t=e.checkProFeature(t))in Le.layouts||(t="s"),Zt(e,i);const n=e.layoutType,a=Le.layouts[t].count;(0,Pe.emit)("layout_about_to_be_changed",t),(null!==(r=e.splitters.value())&&void 0!==r?r:[]).forEach(((e,t)=>{e.splitterElement.remove(),e.mouseHandler.destroy()})),e.splitters.setValue([]);const l=Le.layouts[t];e.layoutTemplate.setValue(l);const c=null!==(o=e.allLayoutSizesState.get(l.layoutType))&&void 0!==o?o:(0,Ee.layoutInitialSizingState)(l.expression);e.allLayoutSizesState.set(l.layoutType,c),e.sizingState.setValue(c);const d=e.maximizedChartDef.value();if(e.isPhoneSize.value()&&e.viewMode.value()===_.CollectionViewMode.ForceFullscreen)if(d){const t=e.chartWidgetsDefs.indexOf(d);(t<0||t>=a)&&e.maximizedChartDef.setValue(e.chartWidgetsDefs[0])}else e.maximizedChartDef.setValue(e.chartWidgetsDefs[0]);else n!==t&&e.maximizedChartDef.value()&&e.maximizedChartDef.setValue(null);d&&e.activeChartWidget.setValue((0,s.ensureNotNull)(d.chartWidget));for(let t=0;t<a||t<e.chartWidgetsDefs.length;t++){let r,o=e.chartWidgetsDefs[t];const n=t>=a;if(r=e.maximizedChartDef.value()?e.maximizedChartDef.value()===o:t<a,r){if(o){if(e.parent.appendChild(o.container.value()),o.hiddenInLayout.setValue(!1),e.loadingContent){const t=e.savedChartWidgetOptions.shift();t&&(e.setLoadingContent(!0),(0,s.ensureNotNull)(o.chartWidget).loadContent(t.content,e.initialLoading),e.setLoadingContent(!1))}}else Xt(e,i,t,void 0),o=e.chartWidgetsDefs[t];o.container.value().classList.toggle("multiple",a>1),o.fullscreen.setValue(e.maximizedChartDef.value()===o),o.collapsed.setValue(n)}else o?($t(o),o.collapsed.setValue(n)):e.isPhoneSize.value()&&e.viewMode.value()===_.CollectionViewMode.ForceFullscreen&&(Xt(e,i,t,void 0),$t(e.chartWidgetsDefs[t]),e.chartWidgetsDefs[t].collapsed.setValue(n))}e.sizingState.setValue(c),Ht(e),e.layoutWV.setValue(t),e.setLayoutType(t),e.updateWatchedValue(),function(e){const t=e.layoutTemplate.value().count;e.inlineChartsCount.setValue(t),e.globalDetachable.setValue(t>1)}(e),e.checkAllPendingModelsAlreadyCreated(),Qt(e,i),e.initialLoading||e.updateViewMode(),e.inlineChartsCount.value()<1&&a>0&&e.chartWidgetsDefs[a-1].rdState.bridge().attach()}function ii(e,t,i,s,r){const o=e.actualLayoutCount();return e.chartWidgetsDefs.slice(0,o).filter((e=>e.rdState.bridge().visible.value())).map((e=>e.chartWidget)).filter((t=>t.id()!==i&&(!!t.hasModel()&&(t.selectPointMode().value()===Ge.SelectPointMode.Replay&&"AllCharts"===J.replayModeProperty.value()||(s||e.crosshairLockRaw))))).forEach((e=>e.model().model().setExternalPosition(t,r))),!0}function si(e,t,i,s,r){if(ii(e,t,i,s,r)){const i=e.crossHairSyncBroadcast;if(i){const e={type:"crosshair",payload:{point:t,envState:r,sourceUniqueId:i.uniqueId}};i.channel.postMessage(e)}}}function ri(e){const t=new BroadcastChannel("ChartWidgetsCollection");return t.onmessage=t=>{const i=t.data,s=e()
;if(s.crossHairSyncBroadcast&&"crosshair"===i.type)s.crossHairSyncBroadcast.uniqueId!==i.payload.sourceUniqueId&&ii(s,i.payload.point,null,!1,i.payload.envState)},{channel:t,uniqueId:(0,Ie.randomHashN)(6)}}function oi(e){var t;null===(t=e.crossHairSyncBroadcast)||void 0===t||t.channel.close()}function ni(e,t,i){if(!e.combinedTrackTimeLock.value()||e.dateRangeLock.value())return;const s=e.layoutTemplate.value().count;e.undoHistory.beginUndoMacro(Je),e.chartWidgetsDefs.slice(0,s).filter((e=>e.chartWidget.hasModel()&&e.chartWidget.model().model()!==i)).forEach((e=>{const i=e.chartWidget.model().model(),s=i.mainSeries().syncModel();s&&i.syncTimeWithModel(s.syncSourceTarget(),t)})),e.undoHistory.endUndoMacro()}function ai(e){return Promise.all(e.map((e=>{const t=e.model().mainSeries();return t.symbolResolvingActive().value()?d(t.dataEvents().symbolResolved()).promise:t.symbolInfo()})))}function li(e){return e.chartWidgetsDefs.every((e=>e.chartWidget.hasModel()))?Promise.resolve(e.chartWidgetsDefs.map((e=>e.chartWidget))):Promise.all(e.chartWidgetsDefs.map((e=>e.chartWidget.hasModel()||d(e.chartWidget.modelCreated()).promise))).then((()=>li(e)))}function ci(e,t){var i,r,o;if((0,h.enabled)("charting_library_base"))return t;if("s"===t||e.widgetOptions.containsData||e.readOnly||(0,X.enabled)($.ProductFeatures.MULTIPLE_CHARTS)&&(0,s.ensure)(null===(i=(0,X.getConfig)($.ProductFeatures.MULTIPLE_CHARTS))||void 0===i?void 0:i.limit)>=Le.layouts[t].count)return t;let n="s";{let t=1;const i=null!==(o=null===(r=(0,X.getConfig)($.ProductFeatures.MULTIPLE_CHARTS))||void 0===r?void 0:r.limit)&&void 0!==o?o:0;for(const e of Object.keys(Le.layouts)){const s=Le.layouts[e].count;s<=i&&s>t&&(n=e,t=s)}li(e).then(ai).then((()=>{(0,K.trackGoProFeature)("multipleCharts"),(0,Z.createGoProDialog)({feature:"multipleCharts"})}))}return n}async function hi(e,t,i){if(i=ci(e,i),e.layoutWV.value()===i)return!1;const s=e.chartWidgetsDefs.map((e=>{var t,i,s;return null!==(s=null===(i=null===(t=e.chartWidget)||void 0===t?void 0:t.lineToolsSynchronizer())||void 0===i?void 0:i.flushPendingSavings())&&void 0!==s?s:null})).filter(Oe.notNull);if(s.length)try{await Promise.all(s)}catch(e){Ze.logError(`Error flushing line tools: ${e}`)}return e.undoHistory.pushUndoCommand(new Ve(t,i)),!0}async function di(e,t,i){const{theme:s,onlyActiveChart:r,restoreNonThemeDefaults:o,themeName:n,standardTheme:a,syncState:l=!0,noUndo:c}=i,h=(0,Te.getCurrentTheme)().name;let d;r?d=[e.activeChartWidget.value()]:(Zt(e,t),await Promise.all(e.savedChartWidgetOptions.map(((i,s)=>new Promise((i=>{$t(Xt(e,t,s,i))}))))),d=e.chartWidgetsDefs.map((e=>e.chartWidget)),Qt(e,t)),c?(a&&new ze(h,n,l).redo(),d.forEach((e=>{e.model().model().restoreTheme(s,o,c)}))):(e.undoHistory.beginUndoMacro(it),a&&e.undoHistory.pushUndoCommand(new ze(h,n,l)),d.forEach((e=>{e.model().model().restoreTheme(s,o)})),e.undoHistory.endUndoMacro())}function ui(e,t){e.symbolLock.setValue(t)}function _i(e,t){
const{internalSymbolLock:i,activeChartWidget:s,undoHistory:r,dateRangeLock:o,loadingContent:n,linkingGroupsCharts:l,chartWidgetsDefs:c}=e;if(t!==i.value())if(n)i.setValue(t);else{if(e.undoHistory.beginUndoMacro(st),t){const t=s.value(),i=c.map((e=>e.chartWidget));l.forEach(((s,r)=>{const n=t.linkingGroupIndex().value()===r?t:i.find((e=>e.linkingGroupIndex().value()===r));if(void 0!==n){(0,a.muteLinkingGroup)(r,!0);for(const t of s.value())t!==n&&t.symbolWV().value()!==n.symbolWV().value()&&(t.setSymbol(n.symbolWV().value()),o.value()&&e.subscribeToCompletedEventForDateRangeSync(t,!0));(0,a.muteLinkingGroup)(r,!1)}}))}r.setWatchedValue(i,t,st),r.endUndoMacro()}}function pi(e,t){e.intervalLock.setValue(t)}function mi(e,t){const{internalIntervalLock:i,activeChartWidget:s,undoHistory:r,dateRangeLock:o,loadingContent:n,chartWidgetsDefs:l,linkingGroupsCharts:c}=e;if(t!==i.value())if(n)i.setValue(t);else{if(r.beginUndoMacro(rt),t&&t){const t=s.value(),i=l.map((e=>e.chartWidget));c.forEach(((s,r)=>{const n=t.linkingGroupIndex().value()===r?t:i.find((e=>e.linkingGroupIndex().value()===r));if(void 0!==n){(0,a.muteLinkingGroup)(r,!0);for(const t of s.value())t!==n&&t.resolutionWV().value()!==n.resolutionWV().value()&&(t.setResolution(n.resolutionWV().value()),o.value()&&e.subscribeToCompletedEventForDateRangeSync(t,!0));(0,a.muteLinkingGroup)(r,!1)}}))}r.setWatchedValue(i,t,rt),r.endUndoMacro()}}function gi(e,t){const i=e.activeChartWidget.value();if(i&&i.hasModel()){const s=i.model();t?(e.subscribeToEventsForDateRangeSync(s),e.syncChartsDateRangesWithActiveChartRange()):e.unsubscribeFromEventsForDateRangeSync(s)}e.dateRangeLock.setValue(t)}function Si(e,t){const{internalDateRangeLock:i,undoHistory:s,loadingContent:r}=e;r?i.setValue(t):s.setWatchedValue(i,t,ot)}function vi(e,t){e.trackTimeLock.setValue(t)}function fi(e,t){const{internalTrackTimeLock:i,undoHistory:s,loadingContent:r}=e;r?i.setValue(t):s.setWatchedValue(i,t,nt)}function bi(e,t,i){e.symbolLock.value()?yi(e,t,i):e.activeChartWidget.value().setSymbol(t)}function yi(e,t,i){const s=e.activeChartWidget.value();void 0===i&&(i=s.linkingGroupIndex().value());for(const s of e.chartWidgetsDefs){const e=s.chartWidget;(e.hasModel()?e.model().mainSeries().symbolSameAsCurrent(t):e.symbolWV().value()===t)||void 0!==i&&e.linkingGroupIndex().value()!==i||e.setSymbol(t)}}function Ci(e){return e.intervalLock.value()?e.chartWidgetsDefs.map((e=>e.chartWidget)):[e.activeChartWidget.value()]}function wi(e,t,i){if(e.flags.loadingChart||e.flags.setTimeFrameActive||e.flags.setNewResolution)return;let s="";{let r=!1;const o=je.Interval.isRange(t),n=je.Interval.isTicks(t);if(o||n){const t=Ci(e);for(const e of t){if(!e.hasModel())continue;const t=e.model().model();if(t.isInReplay()){if(o&&11!==t.mainSeries().style()){r=!0,s=_t;break}n&&(r=!0,s=pt)}}}!r||e.flags.isConfirmationAboutReplayLocked?Pi(e,t,i):(0,Ye.showConfirm)({text:s,onConfirm:s=>{e.flags.isConfirmationAboutReplayLocked=!0,Pi(e,t,i),e.flags.isConfirmationAboutReplayLocked=!1,s.dialogClose()}})}}function Pi(e,t,i){(0,
Ke.setLastUsedResolution)(t),e.flags.setNewResolution=!0;const s=e.activeChartWidget.value();if(void 0===i&&(i=s.linkingGroupIndex().value()),e.intervalLock.value())for(const s of e.chartWidgetsDefs){const e=s.chartWidget;e.resolutionWV().value()===t||void 0!==i&&e.linkingGroupIndex().value()!==i||e.setResolution(t)}else s.setResolution(t);e.flags.setNewResolution=!1}function Ti(e){const t=new u.WatchedValue(null),i=()=>{t.setValue(e.value().linkingGroupIndex().value())};e.value()&&i();const s=e.spawn();let r;return s.subscribe((e=>{null==r||r.destroy(),r=e.linkingGroupIndex().spawn(),r.subscribe(i),i()})),t.spawn((()=>{s.destroy(),null==r||r.destroy()}))}function Mi(e){const t=new Set(e.map((e=>e.chartWidget.linkingGroupIndex().value())));return Array.from(t).sort(((e,t)=>(null!=e?e:-1)-(null!=t?t:-1)))}function xi(e){const t=new qe.WatchedObject(Mi(e.chartWidgetsDefs)),i=()=>{t.setValue(Mi(e.chartWidgetsDefs))};e.chartWidgetsDefs.forEach((e=>e.chartWidget.linkingGroupIndex().subscribe(i)));const s=e=>{e.linkingGroupIndex().subscribe(i),i()};return e.chartWidgetCreatedDelegate.subscribe(null,s),t.spawn((()=>{e.chartWidgetsDefs.forEach((e=>e.chartWidget.linkingGroupIndex().unsubscribe(i))),e.chartWidgetCreatedDelegate.unsubscribe(null,s)}))}function Ii(e,t){let i=e.linkingGroupsCharts.get(t);return void 0===i&&(i=new qe.WatchedObject([],xe.compareTwoCollectionsByIds),e.linkingGroupsCharts.set(t,i)),i}function Li(e){var t;const i=new Map;for(const t of e.chartWidgetsDefs){const e=t.chartWidget.linkingGroupIndex().value();let s=i.get(e);void 0===s&&(s=[],i.set(e,s)),s.push(t.chartWidget)}for(const s of(0,xe.join)(new Set(e.linkingGroupsCharts.keys()),new Set(i.keys())))Ii(e,s).setValue(null!==(t=i.get(s))&&void 0!==t?t:[])}function ki(e){if(e){const e=function(){var e,t,i,r;const o=null!==(t=null===(e=(0,X.getConfig)($.ProductFeatures.BACKEND_CONNECTIONS))||void 0===e?void 0:e.limit)&&void 0!==t?t:0,n=(0,s.ensureDefined)(window.pro),a=n.getProductsByType(n.PRODUCT_TYPES.pro_plan);for(const e of a)if((null!==(r=null===(i=(0,X.getConfig)($.ProductFeatures.BACKEND_CONNECTIONS,(0,s.ensureDefined)(e.id)))||void 0===i?void 0:i.limit)&&void 0!==r?r:0)>o)return{connectionCount:o,moreConnectionsPlanAvailable:!0};return{connectionCount:o,moreConnectionsPlanAvailable:!1}}(),t=[{text:n.t(null,void 0,i(881492)),action:Q.PredefinedAction.Close,variant:"secondary",color:"gray",compactMode:!0,onClick:()=>window.ChartApiInstance.connect()}];e.moreConnectionsPlanAvailable&&t.push({action:Q.PredefinedAction.OpenGopro,text:n.t(null,void 0,i(834805)),compactMode:!0}),(0,Z.createGoProDialog)({feature:"connectionsLimit",actionButtonsLayout:Q.ActionButtonsLayout.Row,actions:t,customParams:e})}}function Ai(e,t){let i=[];const s={},r=()=>{i.forEach((e=>e.unsubscribe(a))),i=t.filter((e=>e.chartWidget.hasModel())).map((e=>e.chartWidget.selectPointMode())),i.forEach((e=>e.subscribe(a))),t.forEach((e=>{e.chartWidget.hasModel()||e.chartWidget.withModel(s,(()=>{r(),a()}))}))};r()
;const o=()=>i.some((e=>e.value()===Ge.SelectPointMode.Replay))&&"AllCharts"===J.replayModeProperty.value(),n=new u.WatchedValue(o()),a=()=>n.setValue(o()),l=()=>{r(),a()};e.subscribe(l),J.replayModeProperty.subscribe(n,a);return n.spawn((()=>{J.replayModeProperty.unsubscribe(n,a),e.unsubscribe(l),i.forEach((e=>e.subscribe(a)))}))}function Ei(e,t,i){return(0,He.combine)(((e,t)=>e||t),t.weakReference(),Ai(e,i).ownership())}},300426:(e,t,i)=>{"use strict";var s=i(809796).TranslatedString,r=i(650151).assert,o=i(440617).Series,n=i(244842),a=i(608415).ActionBinder,l=i(62802).setValue,c=i(794349).TabNames,h=i(277774).showGoToDateDialog,d=i(470316),u=i(799786),_=i(419250).createAddNoteAction,p=i(854798).Version,m=i(663554).showDeleteStudyTreeConfirm,g=i(779923).showConfirm,S=i(992393).confirmDatasourceRemoving;const v=i(700134).showFinancialsDialog,f=i(232650).openFinancialsWebview;var b=i(67302).showThemeSwitcher,y=i(67302).showThemeAction,C=i(514315).updateThemeActions,w=i(263955).showScriptInfoErrorNoticeDialog,P=i(693435).Study,T=i(860142).StudyStub,M=i(161488).isStudy,x=i(821979).LineDataSource,I=i(713473),L=I.isLineTool,k=I.isStudyLineTool,A=i(368135).STUDYPLOTDISPLAYTARGET,E=i(373571).Action,D=i(607509).ACTION_ID,B=i(885482),R=i(223699).Interval,N=i(444331),V=N.getDefaultStyle,O=N.hasVolume,F=i(568247).showSymbolInfoDialog,W=i(877009).InvalidationMask,z=i(583912).linking,H=i(230296).showChangeIntervalDialogAsync,U=i(158566).TVAction,G=i(105580).showDetailsDialog,q=i(72368).isMobile,j=i(776734).getTracker,Y=i(125226).isFeatureEnabled,K=i(56998).WatchlistWithSubmenuAction,X=i(993294).createSymbolSearchAction,$=i(15458),Z=$.availableTimezones,Q=$.timezoneIsAvailable,J=i(951713).toggleHideMode,ee=i(526075).StudyMetaInfo,te=i(345848).trackEvent,ie=i(86121).lastMouseOrTouchEventInfo,se=i(42292);const{viewportChangeEvent:re}=i(964824);var oe=i(707957).Delegate,ne=i(201089).getLogger("ChartWidget",{color:"#606"}),ae=i(167975).appendEllipsis,le=i(895370).addPerfMark,ce=i(837032).combineProperty,he=i(655068).ChartWidgetBase,de=i(638456).CheckMobile.any(),ue=i(315347).TIMEFRAMETYPE,_e=i(360758).addPlusButtonProperty
;var pe=new s("change timezone",i.tf(null,void 0,i(820505))),me=new s("scale price chart only",i.tf(null,void 0,i(599042))),ge=new s("stay in drawing mode",i.tf(null,void 0,i(52010))),Se=new s("hide all drawing tools",i.tf(null,void 0,i(454781))),ve=new s("hide marks on bars",i.tf(null,void 0,i(744974))),fe=new s("change symbol last value visibility",i.tf(null,void 0,i(253150))),be=new s("change symbol previous close value visibility",i.tf(null,void 0,i(112707))),ye=new s("change previous close price line visibility",i.tf(null,void 0,i(259883))),Ce=new s("change symbol labels visibility",i.tf(null,void 0,i(109402))),we=new s("change indicators and financials name labels visibility",i.tf(null,void 0,i(559820))),Pe=new s("change indicators and financials value labels visibility",i.tf(null,void 0,i(90512))),Te=new s("change bid and ask labels visibility",i.tf(null,void 0,i(805100))),Me=new s("change bid and ask lines visibility",i.tf(null,void 0,i(432311))),xe=new s("change pre/post market price label visibility",i.tf(null,void 0,i(549889))),Ie=new s("change pre/post market price line visibility",i.tf(null,void 0,i(16750))),Le=new s("change high and low price lines visibility",i.tf(null,void 0,i(992556))),ke=new s("change high and low price labels visibility",i.tf(null,void 0,i(466805))),Ae=(new s("change average close price line visibility",i.tf(null,void 0,i(498866))),new s("change average close price label visibility",i.tf(null,void 0,i(739402))),new s("change countdown to bar close visibility",i.tf(null,void 0,i(58108)))),Ee=new s("change plus button visibility",i.tf(null,void 0,i(450190))),De=new s("change price line visibility",i.tf(null,void 0,i(867761))),Be=new s("unlock {title}",i.tf(null,void 0,i(192421))),Re=new s("lock {title}",i.tf(null,void 0,i(850193))),Ne=new s("change session breaks visibility",i.tf(null,void 0,i(115403))),Ve=i.tf(null,void 0,i(615241)),Oe=i.tf(null,void 0,i(529404)),Fe=i.tf(null,void 0,i(844302)),We=i.tf(null,void 0,i(994338));e.exports.ChartWidget=class extends he{constructor(e,t,i){super(e,t,i),this._options.timeScaleWidget&&(this._options.timeScaleWidget.pressedMouseMoveScale=this._options.handleScale.axisPressedMouseMove.time);var s=this,r=this._options.content,o=this._options.readOnly;this._removeMaximizeHotkey=null,s._hotkeys=u.createGroup({desc:"Chart actions",isDisabled:function(){return!s._isActive}});var n=this._options.containsData,a=this._options.onWidget,l=this._options.onCmeWidget;l&&ne.logWarn("[ChartWidget] 'onCmeWidget' option is depricated");var c=this._options.widgetCustomer,h=this._options.timezone,d=this._options.hideSymbolSearch,_=this._options.defSymbol,p=R.isValid(this._options.defInterval)?this._options.defInterval:void 0,m=parseInt(this._options.defStyle),g=N.isValidStyle(m)?m:void 0,S=this._options.defSessionId,v=void 0!==this._options.defTimeframe?"string"==typeof this._options.defTimeframe?{value:this._options.defTimeframe.toUpperCase(),type:ue.PeriodBack}:{...this._options.defTimeframe,type:ue.TimeRange}:void 0;this._content=r,
this._initialLoading=this._options.initialLoading,this._readOnly=o,this._containsData=n,this._defSymbol=_,this._defInterval=p,this._defTimeframe=v,this._defStyle=g,this._onWidget=!!a,this._compareSymbols=this._options.compareSymbols,this._onWidget&&(l?this._widgetCustomer="cme":c&&(this._widgetCustomer=c)),this._hideSymbolSearch=d,this._frameTime=30,this._model=null,this._metaInfo={},this._drawRafId=0,this._compareDialog=this._chartWidgetCollection.getCompareDialogRenderer();var f=this._contentSeriesProperties();f&&(_=f.symbol,p=f.interval),void 0===this._options.useUserChartPreferences&&(this._options.useUserChartPreferences=!0);var b="chartproperties.mainSeriesProperties",y=this._options.useUserChartPreferences?se.defaults(b):se.factoryDefaults(b);this._properties.mainSeriesProperties.merge(y),this._properties.mainSeriesProperties.hasChild("esdBreaksStyle")&&this._properties.mainSeriesProperties.removeProperty("esdBreaksStyle"),p=p||y.interval||"D",N.isValidStyle(g)||(g=N.isValidStyle(y.style)?y.style:V(R.isRange(p))),this._properties.mainSeriesProperties.merge({visible:!0,symbol:_||DEFAULT_SYMBOL,shortName:"",timeframe:"",onWidget:this._onWidget,interval:p,currencyId:null,unitId:null,style:g,sessionId:S}),this._symbolWV.setValue(this.getSymbol()),this._resolutionWV.setValue(this.getResolution()),this._containsData&&this._properties.mainSeriesProperties.merge({showCountdown:!1}),h&&Q(h)&&this._properties.timezone.setValue(h),this._tagsChanged=new oe,this._timingsMeter=null,this._isActive=this._options.isActive,this._options.container.subscribe((function(e){s._setElement(e)}),{callWithLast:!0});var C=function(){s.resize()};this._options.width.subscribe(C),this._options.height.subscribe(C),this._options.visible.subscribe(this._updateTimingsMeterState.bind(this)),this._aboutToBeDestroyed=new oe,this._actions=null,this._definitionsViewModel=null,this._backgroundTopColorSpawn=null,this._backgroundBottomColorSpawn=null}isInitialized(){return Boolean(this._inited)}compareSymbols(){return this._compareSymbols}async _getChartPropertyDefinitionsViewModel(){if(null===this._definitionsViewModel){const{ChartPropertyDefinitionsViewModel:e}=await Promise.all([i.e(88601),i.e(56894),i.e(96788),i.e(25900),i.e(47924),i.e(83596)]).then(i.bind(i,3775));if(this._isDestroyed)throw new Error("Chart widget already destroyed");await new Promise((e=>this.withModel(null,e))),null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this.model(),this.properties(),this._options))}return this._definitionsViewModel}_initMaximizeHotkey(e){var t=this;function i(e){e.defaultPrevented||d.modifiersFromEvent(e)===d.Modifiers.Alt&&e.stopPropagation()}function s(e){e.defaultPrevented||d.modifiersFromEvent(e)===d.Modifiers.Alt&&(e.preventDefault(),e.stopPropagation(),t.toggleFullscreen())}return e.addEventListener("mousedown",i,!0),e.addEventListener("click",s,!0),function(){e.removeEventListener("mousedown",i,!0),e.removeEventListener("click",s,!0)}}toggleFullscreen(){var e=this.getResizerDetacher()
;e.fullscreenable.value()&&(e.fullscreen.value()?e.exitFullscreen():e.requestFullscreen())}_beginRequestActive(){var e=this._chartWidgetCollection.activeChartWidget.value()!==this;if(this._chartWidgetCollection.activeChartWidget.setValue(this),e){const e=ie();e.isTouch&&!e.stylus&&this._isLineToolModeExceptBrush()&&this.updateCrossHairPositionIfNeeded(),this._justActivated=!0}}_endRequestActive(){var e=this;this._justActivated&&setTimeout((function(){e._justActivated=!1}),0)}_requestActive(){this._beginRequestActive(),this._endRequestActive()}justActivated(){return this._justActivated}setTimezone(e){e&&Q(e)?this._properties.timezone.setValue(e):console.warn("Incorrect timezone: "+JSON.stringify(e))}getTimezone(){return this._properties.timezone.value()}refreshMarks(){this.model().barsMarksSources().forEach((function(e){e.refreshData()}))}clearMarks(e){this.model().barsMarksSources().forEach((function(t){t.clearMarks(e)}))}metaInfoRepository(){return this._metaInfoRepository}_initBackgroundColor(){null===this._backgroundTopColorSpawn&&(this._backgroundTopColorSpawn=this._model.model().backgroundTopColor().spawn(),this._backgroundTopColorSpawn.subscribe(this._onBackgroundColorChanged.bind(this))),null===this._backgroundBottomColorSpawn&&(this._backgroundBottomColorSpawn=this._model.model().backgroundColor().spawn(),this._backgroundBottomColorSpawn.subscribe(this._onBackgroundColorChanged.bind(this)))}paneWidgets(){return this._paneWidgets}paneByCanvas(e){for(var t=0;t<this._paneWidgets.length;t++)if(this._paneWidgets[t].hasCanvas(e))return this._paneWidgets[t];return null}paneByState(e){for(var t=0;t<this._paneWidgets.length;t++)if(this._paneWidgets[t].state()===e)return this._paneWidgets[t];return null}timeAxisByCanvas(e){return this._timeAxisWidget.hasCanvas(e)?this._timeAxisWidget:null}properties(){return this._properties}readOnly(){return this._readOnly}modelCreated(){return this._modelCreated}updateActions(){for(var e=this.actions(),t=this._model.dataSources(),s=!1,r=!1,o=0,n=t.length;o<n;o++){var a=t[o];TradingView.isInherited(a.constructor,x)&&a.isUserDeletable()&&(s=!0),TradingView.isInherited(a.constructor,P)&&a.removeByRemoveAllStudies()&&(r=!0),TradingView.isInherited(a.constructor,T)&&(r=!0)}this._readOnly||(e.paneRemoveAllStudies&&e.paneRemoveAllStudies.update({disabled:!r}),e.paneRemoveAllDrawingTools&&e.paneRemoveAllDrawingTools.update({disabled:!s}),e.paneRemoveAllStudiesDrawingTools&&e.paneRemoveAllStudiesDrawingTools.update({disabled:!r&&!s})),!(b()||y()||window.is_authenticated)||C(this);var l=this,c=[],h=function(e){return e.id===l.model().model().properties().timezone.value()};Z.forEach((function(e){if(!e.separator){var t=new E({actionId:D.ChartChangeTimeZone,label:e.title,checkable:!0,checked:h(e),statName:"SetTimeZone",onExecute:function(){l.model().setProperty(l.model().model().properties().timezone,e.id,pe)}});c.push(t)}}),this),e.applyTimeZone.update({subItems:c}),e.addToWatchlist&&(e.addToWatchlist.request(),e.addToWatchlist.updateLabel(this.getSymbol(!0))),
e.addToTextNotes&&e.addToTextNotes.update({label:i.tf(null,void 0,i(134810)).format({symbol:this.getSymbol(!0)})}),e.moveChartAction&&e.moveChartAction.update({disabled:!this._chartWidgetCollection.activeChartCanBeMoved()})}actions(){return null===this._actions&&this._setActions(),this._actions}_setActions(){this._actions&&this._actions.addToWatchlist&&(this._actions.addToWatchlist.destroy(),delete this._actions.addToWatchlist);var e=this;this._hotkeys.add({desc:"Maximize",hotkey:u.Modifiers.Alt+13,handler:function(){e.toggleFullscreen()},isDisabled:function(){return!e._options.fullscreenable.value()}}),this._hotkeys.add(this._clearSelectionHotkey()),e.withModel(null,(function(){var t=function(){e._hotkeys.promote()};e._model.onSelectedSourceChanged().subscribe(null,t),e._model.crossHairSource().measurePane().subscribe((e=>{null!==e&&t()}))}));var t=new E({actionId:D.ChartScalesReset,label:i.tf(null,void 0,i(834301)),icon:i(139267),statName:"ResetChart",onExecute:this.GUIResetScales.bind(this),hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Alt+82}),s=new E({actionId:D.ChartSeriesPriceScaleToggleInvertPriceScale,label:i.tf(null,void 0,i(353239)),statName:"Invert Scale",checkable:!0,onExecute:function(){e._model.invertPriceScale(e._model.mainSeries().priceScale())},hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Alt+73}),r=new E({actionId:D.ChartSeriesPriceScaleToggleAutoScale,label:i.tf(null,void 0,i(550834)),checkable:!0,onExecute:function(){var t=e._model.mainSeries().priceScale();e._model.togglePriceScaleAutoScaleMode(t),r.update({checked:t.isAutoScale()})}}),o=new E({actionId:D.ChartScalesToggleLockPriceToBarRatio,label:i.tf(null,void 0,i(518219)),checkable:!0,statName:"ToggleLockScale",onExecute:function(){e._model.togglePriceScaleLockScaleMode(e._model.mainSeries().priceScale())}}),p=new E({actionId:D.ChartSeriesPriceScaleToggleRegular,label:i.tf(null,{context:"scale_menu"},i(172116)),checkable:!0,statName:"ToggleRegularScale",onExecute:function(){var t=e._model.mainSeries().priceScale();e._model.setPriceScaleRegularScaleMode(t),p.update({checked:t.isRegular()})}}),m=new E({actionId:D.ChartSeriesPriceScaleTogglePercentage,label:i.tf(null,void 0,i(351102)),checkable:!0,statName:"TogglePercantage",onExecute:function(){e._model.togglePriceScalePercentageScaleMode(e._model.mainSeries().priceScale())},hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Alt+80}),g=new E({actionId:D.ChartSeriesPriceScaleToggleIndexedTo100,label:i.tf(null,void 0,i(520062)),checkable:!0,statName:"ToggleIndexedTo100",onExecute:function(){e._model.togglePriceScaleIndexedTo100ScaleMode(e._model.mainSeries().priceScale())}}),S=new E({actionId:D.ChartSeriesPriceScaleToggleLogarithmic,label:i.tf(null,void 0,i(512285)),statName:"ToggleLogScale",checkable:!0,onExecute:function(){e._model.togglePriceScaleLogScaleMode(e._model.mainSeries().priceScale())},hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Alt+76}),C=new E({actionId:D.ChartUndo,label:i.tf(null,void 0,i(881320)),onExecute:function(){te("GUI","Undo"),e._model.undoHistory().undo()},
disabled:!0,hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Mod+90}),w=new E({actionId:D.ChartRedo,label:i.tf(null,void 0,i(641615)),onExecute:function(){te("GUI","Redo"),e._model.undoHistory().redo()},disabled:!0,hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Mod+89});e.withModel(null,(function(){e._model.undoHistory().undoStack().onChange().subscribe(e,e.updateUndoRedo),e._model.undoHistory().redoStack().onChange().subscribe(e,e.updateUndoRedo)}));var P=!(b()||y()||window.is_authenticated)?null:new U({name:"apply-color-theme",label:i.tf(null,void 0,i(132409)),icon:i(527409),subItems:[new U({label:i.tf(null,void 0,i(25911))})],statName:"ColorTheme"}),T=new E({actionId:D.ChartChangeTimeZone,label:i.tf(null,void 0,i(164375)),statName:"TimeZone"}),M=X();l("symboledit.dialog_last_entry","");var x={actionId:D.ChartDialogsShowChangeInterval,label:ae(i.tf(null,void 0,i(699374))),statName:"ChangeInterval",onExecute:function(){H({initVal:z.interval.value(),selectOnInit:!0})}};!n.enabled("show_interval_dialog_on_key_press")||this.readOnly()||this._hideSymbolSearch||(x.shortcutHint=",",x.hotkeyGroup=this._hotkeys,x.hotkeyHash=188);var I,L,k=new E(x);if(!TradingView.onWidget()){if(this._options.addToWatchlistEnabled){const e={hotkeyGroup:this._hotkeys};I=new K(this,e)}L=_(this,{hotkeyGroup:this._hotkeys},q())}var A=new E({actionId:D.ChartTimeScaleReset,label:i.tf(null,void 0,i(825333)),icon:i(139267),statName:"ResetScale",onExecute:function(){e.model().resetTimeScale()},hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Mod+u.Modifiers.Alt+81}),R=new E({actionId:D.ChartRemoveAllIndicators,label:i.tf(null,void 0,i(413951)),statName:"RemoveAllIndicators",onExecute:this.removeAllStudies.bind(this)}),N=new E({actionId:D.ChartRemoveAllLineTools,label:i.tf(null,void 0,i(801434)),statName:"RemoveAllDrawingTools",onExecute:this.removeAllDrawingTools.bind(this)}),V=new E({actionId:D.ChartRemoveAllIndicatorsAndLineTools,label:i.tf(null,void 0,i(897305)),statName:"RemoveAllIndicatorsAndDrawingTools",onExecute:this.removeAllStudiesDrawingTools.bind(this)}),O=this.chartWidgetCollection(),Y=new E({actionId:D.ChartApplyIndicatorsToAllCharts,label:i.tf(null,void 0,i(295910)),statName:"ApplyIndicatorsToAllCharts",onExecute:function(){O.applyIndicatorsToAllCharts(e)}}),$={actionId:D.ChartDialogsShowInsertIndicators,label:ae(i.tf(null,void 0,i(398767))),statName:"InsertIndicator",onExecute:function(){e.showIndicators()}};this._options.indicatorsDialogShortcutEnabled&&($.hotkeyGroup=this._hotkeys,$.hotkeyHash=191,this._hotkeys.add({handler:function(){this.showIndicators()}.bind(this),desc:"Show insert indicator dialog",hotkey:111}));var Z,Q=new E($),ee=new E({actionId:D.ChartDialogsShowCompareOrAddSymbol,label:ae(i.tf(null,void 0,i(220229))),statName:"CompareOrAddSymbol",onExecute:this.toggleCompareOrAdd.bind(this)}),ie=new E({actionId:D.ChartObjectTreeShow,label:ae(i.tf(null,void 0,i(500675))),statName:"ObjectsTree",onExecute:this.showObjectsTreePanelOrDialog.bind(this)}),se=new E({actionId:D.ChartDialogsShowGeneralSettings,
label:ae(i.tf(null,void 0,i(389517))),icon:i(951983),statName:"ChartProperties",onExecute:function(){e.showGeneralChartProperties()}}),oe=new E({actionId:D.ChartDialogsShowGeneralSettingsSymbolTab,label:ae(i.tf(null,void 0,i(389517))),icon:i(951983),statName:"MainSeriesProperties",onExecute:function(){e.showGeneralChartProperties(c.symbol)}}),ne=new E({actionId:D.ChartDialogsShowGeneralScalesTab,label:ae(i.tf(null,void 0,i(389517))),icon:i(951983),statName:"ScalesProperties",onExecute:function(){e.showGeneralChartProperties(c.scales)}}),le=new E({actionId:D.ChartSelectedObjectToggleLocked,label:i.tf(null,void 0,i(101441)),statName:"ToggleLockSelectedObject",onExecute:this.toggleLockSelectedObject.bind(this)}),he=new E({actionId:D.ChartSelectedObjectHide,label:i.tf(null,void 0,i(831971)),icon:i(484959),statName:"HideSelectedObject",onExecute:this.hideSelectedObject.bind(this)});n.enabled("property_pages")&&(Z=new E({actionId:D.ChartSelectedObjectShowSettingsDialog,label:ae(i.tf(null,void 0,i(389517))),icon:i(951983),statName:"EditSelectedObject",onExecute:function(){e.showSelectedSourcesProperties()}})),this.withModel(null,(function(){var t=e.model().mainSeries(),i=t.properties();i.priceAxisProperties.subscribe(e,e._updateScalesActions),t.priceScaleAboutToBeChanged().subscribe(e,(function(){i.priceAxisProperties.unsubscribeAll(e)})),t.priceScaleChanged().subscribe(e,(function(){i.priceAxisProperties.subscribe(e,e._updateScalesActions),e._updateScalesActions()}))}));var de=new E({actionId:D.ChartPriceScaleToggleAutoScaleSeriesOnly,label:i.tf(null,void 0,i(937207)),checkable:!0,statName:"ScalePriceChartOnly"});de.binder=new a(de,this._properties.scalesProperties.scaleSeriesOnly,this.model(),me);var ue=this.model().model();this._properties.scalesProperties.scaleSeriesOnly.listeners().subscribe(null,(function(){ue.recalculateAllPanes(re()),ue.invalidate(W.full())}));var pe=new E({actionId:D.ChartDrawingToolbarToggleVisibility,label:i.tf(null,void 0,i(222903)),checkable:!0,statName:"ToggleDrawingToolbar"}),Be=this._options.isDrawingToolbarVisible;Be&&(Be.subscribe((function(e){pe.update({checked:e})}),{callWithLast:!0}),pe.update({onExecute:function(){Be.setValue(!Be.value())}}));var Re,Ne=new E({actionId:"",label:i.tf(null,void 0,i(593161)),checkable:!0,statName:"ToggleStayInDrawingMode"});Ne.binder=new a(Ne,B.properties().stayInDrawingMode,this.model(),ge),(Re=new U({label:i.tf(null,void 0,i(647617)),checkable:!0,statName:"ToggleHideAllDrawingTools",hotkeyHash:u.Modifiers.Mod+u.Modifiers.Alt+72,hotkeyGroup:this._hotkeys})).binder=new a(Re,B.hideAllDrawings(),this.model(),Se,(function(){J()}));var ze=new E({actionId:D.ChartMarksToggleVisibility,label:i.tf(null,void 0,i(2441)),checkable:!0,statName:"ToggleHideMarksOnBars"});ze.binder=new a(ze,B.hideMarksOnBars(),this.model(),ve,(function(){B.hideMarksOnBars().setValue(this.value())}));const He=this.properties().scalesProperties;var Ue=new E({actionId:D.ChartPriceScaleLabelsToggleSeriesLastValueVisibility,label:i.tf(null,void 0,i(752054)),checkable:!0,checked:!1,
statName:"ToggleSymbolLastValue"});Ue.binder=new a(Ue,He.showSeriesLastValue,this.model(),fe);var Ge=new E({actionId:D.ChartPriceScaleLabelsToggleSymbolPrevCloseValueVisibility,label:i.tf(null,void 0,i(590537)),checkable:!0,checked:!1,statName:"ToggleSymbolPrevCloseValue"});Ge.binder=new a(Ge,He.showSeriesPrevCloseValue,this.model(),be);var qe=new E({actionId:D.ChartLinesToggleSeriesPrevCloseLineVisibility,label:i.tf(null,void 0,i(336857)),checkable:!0,checked:!1,statName:"ToggleSymbolPrevCloseLine"});qe.binder=new a(qe,this.model().mainSeries().properties().showPrevClosePriceLine,this.model(),ye),this.model().mainSeries().onRestarted().subscribe(this,(function(){this.updateActionForIntradayOnly(Ge),this.updateActionForIntradayOnly(qe)}));var je=new E({actionId:D.ChartPriceScaleLabelsToggleSymbolNameLabelsVisibility,label:i.tf(null,void 0,i(390932)),checkable:!0,checked:!1,statName:"ToggleSymbolLabels"});je.binding=new a(je,He.showSymbolLabels,this.model(),Ce);const Ye=ce(((e,t)=>e||t),He.showStudyLastValue.weakReference(),He.showFundamentalLastValue.weakReference());var Ke=new E({actionId:D.ChartPriceScaleLabelsToggleIndicatorsValueLabelsVisibility,label:i.tf(null,void 0,i(192945)),checkable:!0,checked:!1,statName:"ToggleStudiesAndFundamentalsPriceLabels"});Ke.binder=new a(Ke,Ye,this.model(),null,(()=>{const e=!Ye.value();this.model().beginUndoMacro(Pe),this.model().setProperty(He.showStudyLastValue,e,null),this.model().setProperty(He.showFundamentalLastValue,e,null),this.model().endUndoMacro()}));const Xe=ce(((e,t)=>e||t),He.showStudyPlotLabels.weakReference(),He.showFundamentalNameLabel.weakReference());var $e=new E({actionId:D.ChartPriceScaleLabelsToggleIndicatorsNameLabelsVisibility,label:i.tf(null,void 0,i(47587)),checkable:!0,checked:!1,statName:"ToggleStudiesAndFundamentalsNameLabels"});$e.binding=new a($e,Xe,this.model(),null,(()=>{const e=!Xe.value();this.model().beginUndoMacro(we),this.model().setProperty(He.showStudyPlotLabels,e,null),this.model().setProperty(He.showFundamentalNameLabel,e,null),this.model().endUndoMacro()}));var Ze=new E({actionId:D.ChartPriceScaleLabelsToggleBidAskLabelsVisibility,label:i.tf(null,void 0,i(665287)),checkable:!0,checked:!1,statName:"ToggleBidAskLabels"});Ze.binding=new a(Ze,He.showBidAskLabels,this.model(),Te);var Qe=new E({actionId:D.ChartLinesToggleBidAskLinesVisibility,label:i.tf(null,void 0,i(240548)),checkable:!0,checked:!1,statName:"ToggleBidAskLines"});Qe.binding=new a(Qe,this.model().mainSeries().properties().bidAsk.visible,this.model(),Me);var Je=new U({label:i.tf(null,void 0,i(11240)),checkable:!0,checked:!1,statName:"TogglePrePostMarketPriceLabel"});Je.binding=new a(Je,He.showPrePostMarketPriceLabel,this.model(),xe);var et=new U({label:i.tf(null,void 0,i(296768)),checkable:!0,checked:!1,statName:"TogglePrePostMarketPriceLine"});et.binding=new a(et,this.model().mainSeries().properties().prePostMarket.visible,this.model(),Ie),this.model().mainSeries().isPrePostMarketPricesAvailableProperty().subscribe(this,(function(e){Je.update({disabled:!e.value()}),et.update({
disabled:!e.value()})}));var tt=this.model().mainSeries().properties().highLowAvgPrice,it=new E({actionId:D.ChartPriceScaleLabelsToggleHighLowPriceLabelsVisibility,label:i.tf(null,void 0,i(953150)),checkable:!0,checked:!1,statName:"ToggleHighLowPriceLabels"});it.binding=new a(it,tt.highLowPriceLabelsVisible,this.model(),ke);var st,rt,ot=new E({actionId:D.ChartLinesToggleHighLowLinesVisibility,label:i.tf(null,void 0,i(321803)),checkable:!0,checked:!1,statName:"ToggleHighLowPriceLine"});ot.binding=new a(ot,tt.highLowPriceLinesVisible,this.model(),Le);var nt=new E({actionId:D.ChartPriceScaleToggleCountdownToBarCloseVisibility,label:i.tf(null,void 0,i(894370)),checkable:!0,checked:!1,statName:"ToggleCountdown"});nt.binder=new a(nt,this.model().mainSeries().properties().showCountdown,this.model(),Ae);var at=new E({actionId:D.ChartPriceScaleToggleAddOrderPlusButtonVisibility,label:i.tf(null,void 0,i(897378)),checkable:!0,checked:_e.value(),statName:"ToggleAddOrderPlusButton"});at.binder=new a(at,_e,this.model(),Ee);var lt=null;this._options.goToDateEnabled&&(lt=new E({actionId:D.ChartDialogsShowGoToDate,label:ae(i.tf(null,void 0,i(475190))),statName:"GoToDate",onExecute:function(){var t=e._chartWidgetCollection.activeChartWidget.value();h(t)},hotkeyGroup:this._hotkeys,hotkeyHash:u.Modifiers.Alt+71}));var ct,ht=new E({actionId:D.ChartDialogsShowSymbolInfo,label:ae(q()?i.tf(null,void 0,i(270255)):i.tf(null,void 0,i(665986))),icon:i(437924),checkable:!1,statName:"SymbolInfo",onExecute:function(){if(q())n.enabled("mobile_app_action_open_details_webview")&&e._options.onDetailsWebviewOpen?e._options.onDetailsWebviewOpen():G(),te("ContextMenuClick","Mobile","SymbolInfo");else{var t=e.model().model(),i=t.mainSeries().symbol(),s=t.mainSeries().symbolInfo(),r=t.availableUnits(),o={symbolInfo:s,showUnit:t.unitConversionEnabled(),unitDescription:e=>r.description(e),dateFormatter:t.dateFormatter()};F(i,o)}}}),dt=new E({actionId:D.ChartPriceScaleMergeAllScalesToLeft,label:Ve,statName:"MergeAllScalesToLeft",onExecute:function(){e.model().mergeAllScales("left")}}),ut=new E({actionId:D.ChartPriceScaleMergeAllScalesToRight,label:Oe,statName:"MergeAllScalesToRight",onExecute:function(){e.model().mergeAllScales("right")}}),_t=new E({actionId:D.ChartPriceScaleMoveToLeft,label:Fe,statName:"MoveScaleToLeft",onExecute:function(){e.model().mergeAllScales("left")}}),pt=new E({actionId:D.ChartPriceScaleMoveToRight,label:We,statName:"MoveScaleToRight",onExecute:function(){e.model().mergeAllScales("right")}});ct=new E({actionId:D.ChartMoveChartInLayout,label:i.tf(null,void 0,i(456462)),subItems:[new E({actionId:D.ChartMoveChartInLayoutForward,label:i.tf(null,void 0,i(472781)),statName:"MoveChartRight",onExecute:function(){e._chartWidgetCollection.moveActiveChartWithUndo(!1)}}),new E({actionId:D.ChartMoveChartInLayoutBack,label:i.tf(null,void 0,i(762592)),statName:"MoveChartLeft",onExecute:function(){e._chartWidgetCollection.moveActiveChartWithUndo(!0)}})]});var mt=n.enabled("show_object_tree");let gt;if(this._options.showFinancialsEnabled&&(gt=new U({
label:ae(i.tf(null,void 0,i(677720))),icon:i(428026),statName:"Financials",onExecute:()=>{n.enabled("mobile_app_action_open_financials_webview")?f(new URLSearchParams):v(),window.matchMedia("screen and (max-width: 430px)").matches&&te("ContextMenuClick","","Financials"),j().then((e=>{null!==e&&e.trackFinancialsDialog(z.proSymbol.value(),"contextMenu")}))}})),this._actions={chartProperties:se,mainSeriesPropertiesAction:oe,scalesProperties:ne,timeScaleReset:A,chartReset:t,invertSeriesScale:s,logSeriesScale:S,autoSeriesScale:r,lockSeriesScale:o,regularSeriesScale:p,percentSeriesScale:m,indexedTo100SeriesScale:g,compareOrAdd:ee,paneObjectTree:mt?ie:void 0,insertIndicator:Q,symbolSearch:M,showSymbolInfoDialog:ht,changeInterval:k,seriesHide:he,studyHide:he,lineToggleLock:le,lineHide:he,scaleSeriesOnly:de,drawingToolbarAction:pe,stayInDrawingModeAction:Ne,hideAllMarks:ze,applyTimeZone:T,showCountdown:nt,addPlusButton:at,showSeriesLastValue:Ue,showSeriesPrevCloseValue:Ge,showSeriesPrevCloseLine:qe,showBidAskLabels:Ze,showBidAskLines:Qe,showPrePostMarketPriceLabel:Je,showPrePostMarketPriceLine:et,showHighLowPriceLabels:it,showHighLowPriceLines:ot,showAverageClosePriceLabel:st,showAverageClosePriceLine:rt,showSymbolLabelsAction:je,showStudyLastValue:Ke,showStudyPlotNamesAction:$e,undo:C,redo:w,mergeLeftScalesAction:dt,mergeRightScalesAction:ut,moveScaleToLeft:_t,moveScaleToRight:pt,moveChartAction:ct},this._actions.showDataWindow=this._createShowDataWindowAction(),P&&(this._actions.applyColorTheme=P),I&&(this._actions.addToWatchlist=I),gt&&(this._actions.showFinancials=gt),Re&&(this._actions.hideAllDrawingsAction=Re),n.enabled("show_source_code")&&(this._actions.viewSourceCode=new U({label:ae(i.tf(null,void 0,i(966324))),statName:"OpenSelectedObjectSource",onExecute:this.openSelectedObjectSource.bind(this)})),!TradingView.onWidget()&&n.enabled("text_notes")&&(this._actions.addToTextNotes=L),null!==lt&&(this._actions.gotoDate=lt),this.createSessionBreaksActions(),!this.readOnly()){var St=new E({actionId:D.ChartSelectedObjectRemove,label:i.tf(null,void 0,i(734596)),icon:i(535149),statName:"RemoveSelectedObject",onExecute:function(){var e=this._chartWidgetCollection.activeChartWidget.value();e||(e=this),e.removeSelectedSources()}.bind(this),hotkeyGroup:this._hotkeys,hotkeyHash:d.isMacKeyboard?8:46});this._hotkeys.add({handler:function(){this.removeSelectedSources()}.bind(this),desc:"Remove selected source",hotkey:d.isMacKeyboard?46:8}),this._actions.paneRemoveAllStudies=R,this._actions.paneRemoveAllDrawingTools=N,this._actions.paneRemoveAllStudiesDrawingTools=V,this._actions.applyStudiesToAllCharts=Y,this._actions.studyRemove=St,this._actions.lineRemove=St,n.enabled("property_pages")&&(this._actions.format=Z)}this._actions.showPriceLine=new E({actionId:D.ChartLinesToggleSeriesPriceLineVisibility,label:i.tf(null,void 0,i(491492)),checkable:!0,statName:"TogglePriceLine"}),this._actions.showPriceLine.binding=new a(this._actions.showPriceLine,this.model().mainSeries().properties().showPriceLine,this.model(),De),
this.readOnly()||(this._hotkeys.add({desc:"Draw Horizontal Line here",hotkey:u.Modifiers.Alt+72,handler:function(){e.activePaneWidget&&e.activePaneWidget.drawRightThere("LineToolHorzLine")}}),this._hotkeys.add({desc:"Draw Horizontal Ray here",hotkey:u.Modifiers.Alt+74,handler:function(){e.activePaneWidget&&e.activePaneWidget.drawRightThere("LineToolHorzRay")}}),this._hotkeys.add({desc:"Draw Vertical Line here",hotkey:u.Modifiers.Alt+86,handler:function(){e.activePaneWidget&&e.activePaneWidget.drawRightThere("LineToolVertLine")}}),this._hotkeys.add({desc:"Draw Cross Line here",hotkey:u.Modifiers.Alt+67,handler:function(){e.activePaneWidget&&e.activePaneWidget.drawRightThere("LineToolCrossLine")}}),this._hotkeys.add({desc:"Draw Trend Line",hotkey:u.Modifiers.Alt+84,handler:function(){e.activePaneWidget&&B.tool.setValue("LineToolTrendLine")}}),this._hotkeys.add({desc:"Draw Fib Retracement",hotkey:u.Modifiers.Alt+70,handler:function(){e.activePaneWidget&&B.tool.setValue("LineToolFibRetracement")}})),this._updateScalesActions()}options(){return this._options}executeActionById(e){if("takeScreenshot"===e)return console.warn('Action "takeScreenshot" is deprecated. Use method "takeScreenshot" instead'),void this._chartWidgetCollection.takeScreenshot();"hideAllDrawingsAction"===e&&console.warn('Action "hideAllDrawingsAction" is deprecated. Use method "hideAllDrawingTools" instead'),e in this._actions?this._actions[e]instanceof E&&this._actions[e].execute():console.warn("Unknown action id: "+e)}getCheckableActionState(e){if(e in this._actions){var t=this._actions[e];if(t instanceof E&&t.isCheckable())return t.isChecked();console.warn("Action "+e+" has no state")}else console.warn("Unknown action id: "+e);return null}_updateScalesActions(){if(null!==this._actions){var e=this.model().mainSeries(),t=e.priceScale(),i=e.properties(),s=t.isLockScale(),r=i.style.value()===o.STYLE_PNF;this._actions.percentSeriesScale.update({disabled:s||r,checked:t.isPercentage()}),this._actions.logSeriesScale.update({disabled:s||r,checked:t.isLog()}),this._actions.regularSeriesScale.update({disabled:s||r,checked:t.isRegular()}),this._actions.indexedTo100SeriesScale.update({disabled:s||r,checked:t.isIndexedTo100()}),this._actions.invertSeriesScale.update({checked:t.isInverted()}),this._actions.lockSeriesScale.update({checked:t.isLockScale()}),this._actions.autoSeriesScale.update({checked:t.isAutoScale(),disabled:t.properties().autoScaleDisabled.value()})}}removeAllStudies(){this._model.removeAllStudies()}removeAllDrawingTools(){this._model.removeAllDrawingTools()}removeAllStudiesDrawingTools(){this._model.removeAllStudiesAndDrawingTools()}defaultSymbol(){return this._defSymbol}widget(){return this._mainDiv}_onBackgroundColorChanged(){for(var e=0;e<this._paneWidgets.length;e++)this._paneWidgets[e].setCursorForTool();this.update(),this.model().model().fullUpdate()}setTimingsMeter(e){this._timingsMeter=e,this._updateTimingsMeterState()}ownerDocument(){return this._parent.ownerDocument}_updateTimingsMeterState(){var e=this._options.visible.value()
;null!==this._timingsMeter&&(e?this._timingsMeter.startCollect():this._timingsMeter.stopCollect())}_createVolumeIfNeeded(){var e=n.enabled("create_volume_indicator_by_default")&&this._options.addVolume,t=!this._content,i=n.enabled("charting_library_base"),s=n.enabled("create_volume_indicator_by_default_once"),r=this._content&&!this._content.loading;e&&(t||i&&r&&!s)&&this._model.mainSeries().dataEvents().symbolResolved().subscribe(this,(function(){var e=this;setTimeout((function(){var t=e._model.model().mainSeries().symbolInfo();if(t){var i=O(t);if(!e.containsVolume()&&i){var s=se.factoryDefaults("chartproperties.volumePaneSize"),r=e._model.model().createStudyInserter({type:"java",studyId:"Volume@tv-basicstudies"});r.setForceOverlay(n.enabled("volume_force_overlay")),r.setPaneSize(s),n.enabled("hide_volume_ma")&&r.setPropertiesState({styles:{vol_ma:{display:A.None}}}),r.insert()}else if(!i&&e.containsVolume()){var o=e.model().dataSources().filter((function(e){return e instanceof P&&"Volume"===e.metaInfo().shortId}))[0];e._model.model().removeSource(o)}}}),0)}),s)}_createSessions(e){var t=this.showGeneralChartProperties.bind(this,c.events);e.createSessions(t)}_createPrePostMarket(e){var t=this.showGeneralChartProperties.bind(this,c.symbol);e.createPrePostMarket(t)}_onChartStyleChanged(){te("Chart","Chart Style "+this._model.mainSeries().getStyleShortName().toUpperCase())}_applyStudiesOverrides(){ee.overrideDefaults(this._metaInfoRepository.getInternalMetaInfoArray())}studiesMetaData(){return this._model.studiesMetaData()}getTimeScale(){return this._timeAxisWidget}chartWidgetCollection(){return this._chartWidgetCollection}setSeriesStyle(e,t){this._model.setProperty(e.properties().style,t)}showObjectsTreePanelOrDialog(){var e=!1,t=window.widgetbar;if(t&&t.isVisible()){var i=t.setPage("object_tree");Y("move_data_window_to_object_tree")&&t.layout.getWidgetByType("object_tree").widgetObject.selectWidget("object_tree"),e="object_tree"===i.name}e||this.showObjectsTreeDialog()}generalPropertiesDefinitions(){return this._getChartPropertyDefinitionsViewModel().then((function(e){return e.propertyPages()}))}propertiesDefinitionsForSource(e){return L(e)||M(e)||k(e)?e.getPropertyDefinitionsViewModel().then((function(e){return null===e?null:e.propertyPages()})).catch((function(e){return ne.logWarn(e),null})):Promise.resolve(null)}toggleCompareOrAdd(){this._compareDialog.visible().value()?this._compareDialog.hide():this._compareDialog.show()}showFundamentals(e){this.showIndicators(e,"financials")}removeSelectedSources(){this.removeDataSources(this._model.selection().dataSources())}removeDataSources(e){var t=e.filter(function(e){return e!==this._model.mainSeries()&&e!==this._model.lineBeingCreated()&&e.isUserDeletable()}.bind(this));if(0!==t.length){var i=null;M(t[0])&&(r(1===t.length,"Cannot remove several studies (no multi select for studies)"),i=t[0]),t.find((function(e){return e.hasAlert.value()}))?S().then(function(e){e&&this._model.removeSelectedSources()
}.bind(this)):i&&i.hasChildren()?m(this._model.removeSelectedSources.bind(this._model)):this._model.removeSelectedSources()}}toggleLockSelectedObject(){var e=this._model;e.selection().lineDataSources().forEach((function(t){var i=t.properties().frozen.value();e.setProperty(t.properties().frozen,!i,(i?Be:Re).format({title:new s(t.name(),t.title())}))}))}showSourceProperties(e,t=null){e===this._model.mainSeries()&&(t=c.symbol),this.showChartPropertiesForSource(e,t)}openSelectedObjectSource(e){var t=this._model.selection().dataSources()[0];if(t&&t.metaInfo){var s=t.metaInfo();if(s&&s.scriptIdPart&&s.pine)if(TradingView.bottomWidgetBar)i(516684).getPineSourceCode(s.scriptIdPart,s.pine.version).done((e=>{var i=p.parse(e.version),r=e.lastVersionMaj?p.parse(e.lastVersionMaj):new p(0,0),o={scriptSource:e.source,scriptIdPart:s.scriptIdPart,scriptName:e.scriptName,scriptTitle:e.scriptTitle,version:e.version,isOld:!r.isZero()&&r.major()!==i.major(),fullSourceIdentifier:JSON.stringify(this.fullSourceId(t))};TradingView.bottomWidgetBar.activateScriptEditorTab(o)})).fail(w)}}tags(){return this._model?this._model.calculateDefaultTags():[]}state(e,t,i,s){if(this._model){const r=this._model.state(e,t,i,s);return r.chartId=this.id(),r}return this._content?this._content:{}}metaInfo(){var e=this._metaInfo;return this._model&&(e.systemTags=this._model.calculateDefaultTags()),e}onTagsChanged(){return this._tagsChanged}onModelTagsChanged(){this._tagsChanged.fire()}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}destroy(){this._aboutToBeDestroyed.fire(),null!==this._removeMaximizeHotkey&&(this._removeMaximizeHotkey(),this._removeMaximizeHotkey=null),0!==this._drawRafId&&this._parent.ownerDocument.defaultView.cancelAnimationFrame(this._drawRafId),null!==this._backgroundTopColorSpawn&&this._backgroundTopColorSpawn.destroy(),null!==this._backgroundBottomColorSpawn&&this._backgroundBottomColorSpawn.destroy(),null!==this._timingsMeter&&(this._timingsMeter.stopCollect(),this._timingsMeter=null);for(var e=0;e<this._paneWidgets.length;e++)this._paneWidgets[e].destroy();this._paneWidgets.length=0;for(e=0;e<this._paneSeparators.length;e++)this._paneSeparators[e].destroy();for(var t in this._paneSeparators.length=0,this._hotkeysListener&&this._hotkeysListener.destroy(),this._barsButton&&this._barsButton.destroy(),this._controlBarNavigation&&(this._controlBarNavigation.destroy(),this._controlBarNavigation=void 0),this._mainDiv&&this._mainDiv.remove(),this._actions){var i=this._actions[t];i instanceof E&&(i.destroy(),i.binder&&i.binder.destroy())}null!==this._timeAxisWidget&&(this._timeAxisWidget.destroy(),this._timeAxisWidget=null),null!==this._definitionsViewModel&&this._definitionsViewModel.destroy(),this._hotkeys&&(this._hotkeys.destroy(),this._hotkeys=null),this._mainDiv.removeEventListener("wheel",this._onWheelBound),window.removeEventListener("keydown:chart_"+this._id,this._keydownEventListener),super.destroy()}title(){return i.tf(null,void 0,i(614412))}symbolProperty(){
return this._model.mainSeries().properties().shortName?this._model.mainSeries().properties().shortName:this._model.mainSeries().properties().symbol}loadContent(e,t){this.screen.show();var i=this;this.isMaximizedPane()&&this.toggleMaximizePane(null);var s,r=i._model.model().dataSources(),o=i._model.mainSeries(),n=i._model.crossHairSource();n.clearMeasure();for(var a=0;a<r.length;a++){var l=r[a];l!==o&&l!==n&&i._model.model().removeSource(l,!0)}this._model.disconnect(),i.activePaneWidget=null,o.purgeSymbolInfo(),e.loading=!0,this._content=e,this._setSymbolIntervalContentOverrides={},this._initialLoading=Boolean(t);for(a=0;a<e.panes.length;++a)for(var c=0;c<e.panes[a].sources.length;++c)if(e.panes[a].sources[c].state.symbol){s=e.panes[a].sources[c].state;break}if(!s)throw Error("An error occured while determining main series ion the chart");i._properties.mainSeriesProperties.mergeAndFire({visible:!0,symbol:s.symbol,timeframe:"",onWidget:i._onWidget,interval:s.interval||"D",style:s.style}),i._init(),i._model.undoHistory().clearStack()}_contentSeriesProperties(){if(this._content)for(var e=this._content.panes.length;e-- >0;)for(var t=this._content.panes[e].sources,i=t.length;i-- >0;)if("MainSeries"===t[i].type)return t[i].state}updateUndoRedo(){this._model&&(this.actions().undo.update({disabled:this._model.undoHistory().undoStack().isEmpty()}),this.actions().redo.update({disabled:this._model.undoHistory().redoStack().isEmpty()}))}createSessionBreaksActions(){var e=new E({actionId:D.ChartSessionBreaksToggleVisibility,label:i.tf(null,void 0,i(259827)),checkable:!0,statName:"ToggleSessionBreaks"});e.binder=new a(e,this._model.chartModel().sessions().properties().graphics.vertlines.sessBreaks.visible,this.model(),Ne),this._actions.sessionBreaks=e}updateActionForIntradayOnly(e){e&&e instanceof E&&e.update({disabled:this.model().mainSeries().isDWM()})}containsVolume(){return this.model().dataSources().some((function(e){return e instanceof P&&"Volume"===e.metaInfo().shortId}))}containsStudyByPredicate(e){return!!this._model&&this._model.dataSources().some((function(t){if(!(t instanceof P))return!1;var i=t.metaInfo();return e(i)}))}containsStudy(e){return this.containsStudyByPredicate((function(t){return t.id===e||t.fullId===e}))}isSmall(){return this._width()<550||this._height()<300}onWidget(){return this._onWidget}onCmeWidget(){return"cme"===this.widgetCustomer()}widgetCustomer(){return this._widgetCustomer}resize(){var e=this._height()+"px",t=this._width()+"px";this._mainDiv.style.height=e,this._mainDiv.style.width=t,this._elMainTable.style.height=e,this._elMainTable.style.width=t,this._resizeHandler&&this._mainDiv&&this._resizeHandler()}applyOverrides(e){var t={};for(var i in e)i.startsWith("mainSeriesProperties.priceAxisProperties")||(t[i]=e[i]);if(applyPropertiesOverrides(this.properties(),null,!1,t,null),this._model){applyPropertiesOverrides(this._model.model().properties(),null,!1,t),applyPropertiesOverrides(this._model.mainSeries().properties(),null,!1,t,"mainSeriesProperties"),
this._model.model().sessions().applyOverrides(t);const e=this._model.chartModel().watermarkSource();null!==e&&e.applyOverrides(t)}}applyStudiesOverrides(e){ee.mergeDefaultsOverrides(e),this._applyStudiesOverrides()}setActive(e){this._isActive=e,ie().isTouch&&(e&&0!==this.selectPointMode().value()?this.startTrackingMode():this.exitTrackingMode()),this._paneWidgets.forEach((function(e){e.update()})),e||this.model().selectionMacro((function(e){e.clearSelection()}))}isActive(){return this._isActive}showReplayOrderConfirmationDialog(){return this.model().isInReplay()?new Promise((function(e,t){g({text:i.tf(null,void 0,i(180623)),onConfirm:function(t){e(),t.dialogClose()},onClose:t})})):Promise.resolve()}_addPerfMark(e){le("ChartWidget."+this._id+"."+e)}getResizerDetacher(){return this._options}}},325050:(e,t,i)=>{"use strict";var s=i(650151).assert,r=i(268222).createDeferredPromise,o=i(809796).TranslatedString,n=i(533422).layouts,a=i(176019).createUndoHistory,l=i(885482),c=i(799786),h=i(470316),d=i(251954),u=i(244842),_=i(401580).WatchedValue,p=i(201089).getLogger("Chart.ChartWidgetCollection"),m=i(777466).preventDefaultForContextMenu,g=i(339315),S=i(161590).GeneralChartPropertiesRenderer,v=i(834698).CompareDialogRenderer,f=i(314802).isOnMobileAppPage,b=i(988124),y=i(444331),C=i(707957).Delegate;const{isSupportedLayout:w,tryGuessingTheMostSuitableLayout:P}=i(533422);var T=i(270294).CollectionViewMode,M=i(850775).mediaState,x=i(744728).SwapChartsUndoCommand,I=i(394905).ToastsFactory,L=i(531005).reconnectChartApi,k=i(397245).marketStatusText,A=i(779923).showConfirm;const E=i(541558).randomHash;var D=i(459296),B=D.applyIndicatorsToAllChartsImpl,R=D.applyIndicatorToAllChartsImpl,N=D.lineToolsAndGroupsDTOsImpl,V=D.getStateForChartImpl,O=D.resetLineToolsInvalidatedImpl,F=D.applyLineToolUpdateNotificationImpl,W=D.createClipboardHandler,z=D.chartsSymbolsImpl,H=D.updateLayoutImpl,U=D.computeContentBoxImpl,G=D.getVisuallyAdjacentDefImpl,q=D.setLayoutImpl,j=D.removeChartWidgetSubscriptionsImpl,Y=D.generateNewChartId,K=D.syncCrosshairImpl,X=D.createBroadcastChannel,$=D.destroyBroadcastChannel,Z=D.syncScrollImpl,Q=D.allInitialModelsCreated,J=D.allInitialSymbolsResolved,ee=D.applyThemeImpl,te=D.isFirstChartInLayout,ie=D.deserializedChartIds,se=D.handleDateRangeLockChange,re=D.handleInternalDateRangeLockChange,oe=D.handleTrackTimeLockChange,ne=D.handleInternalTrackTimeLockChange,ae=D.handleIntervalLockChange,le=D.handleInternalIntervalLockChange,ce=D.handleSymbolLockChange,he=D.handleInternalSymbolLockChange,de=D.handleConnectionLimitReachedChanged,ue=D.createLeftBottomChartWidgetWV,_e=D.setBrokerImpl,pe={saveChartEnabled:!0,takeScreenshotEnabled:!0,publishedChartsEnabled:!0},me=new o("change series style",i.tf(null,void 0,i(53438))),ge=i.tf(null,void 0,i(219149));e.exports=function(e){var t=this,o=Object.assign({},pe,e),Se=new _,ve=o.readOnly||!1,fe=E(),be=[],ye=0,Ce=new _,we=new _,Pe=new _,Te="s",Me=new _(null),xe=new Map,Ie=new _([]),Le=new _;Le.setValue(T.ForceFullscreen);var ke=[];const Ae={isConfirmationAboutReplayLocked:!1,
loadingChart:!1,setTimeFrameActive:!1,setNewResolution:!1};var Ee=!1,De=!1,Be=new _(!1),Re=new _(null),Ne=new _(!1),Ve=new _(!1);Ve.subscribe((e=>ce(Mt(),e)));var Oe=new _(Ve.value());Oe.subscribe((e=>he(Mt(),e)));var Fe=new _(!1);Fe.subscribe((e=>ae(Mt(),e)));var We=new _(Fe.value());We.subscribe((e=>le(Mt(),e)));var ze=new _(Te),He=new _(!1);He.subscribe((e=>oe(Mt(),e)));var Ue=D.combinedTrackTimeLock(ze,He,be);He.subscribe((e=>oe(Mt(),e)));var Ge=new _(Ue.value());Ge.subscribe((e=>ne(Mt(),e)));var qe=new _(!1);qe.subscribe((e=>se(Mt(),e))),Me.subscribe(ai);var je=new _(qe.value());je.subscribe((e=>re(Mt(),e)));var Ye=new _(TVSettings.getBool("chart.syncCrosshair",!0)),Ke=c.createGroup({desc:"Layout"}),Xe=null,$e=null,Ze=null,Qe=null;if(window.TVD){var Je=window.TVD.crosshairSyncEnabled;Je?(Je.value()&&(Ze=X(Mt)),Qe=Je.subscribe((e=>{e?Ze=X(Mt):($(Mt()),Ze=null)}))):Ze=X(Mt)}var et=Ye.value();Ye.subscribe((function(e){et=e=!!e,TVSettings.setValue("chart.syncCrosshair",e);for(var t=0;t<be.length;++t){var i=be[t].chartWidget;i.hasModel()&&i.model().model().lightUpdate()}}));var tt=o.resizerBridge.width,it=o.resizerBridge.height,st=new _(null),rt=new _(null);st.subscribe((e=>{rt.setValue(null===e?null:e.chartWidget)}));var ot=o.widgetOptions||{},nt=o.metaInfo||{},at={id:new _(nt.id||null),name:new _(nt.name),description:new _(nt.description),username:new _(nt.username),uid:new _(nt.uid),lastModified:new _(nt.lastModified)},lt=a();lt.onChange().subscribe(null,(function(e){d.emit("undo_redo_state_changed",e)}));var ct=o.resizerBridge.container.value();ct.addEventListener("contextmenu",m);var ht,dt=r(),ut=new C,_t=new C,pt=new C,mt=new _(!1),gt=new _(null),St=null,vt=null;o.seriesControlBarEnabled&&(ht="0px",gt.setValue(document.createElement("div")),gt.value().style.left=ht,gt.value().style.right=ht,gt.value().style.bottom=ht,gt.value().classList.add("chart-toolbar","chart-controls-bar"),gt.value().setAttribute("data-is-chart-toolbar-component","true"),ct.appendChild(gt.value()),Promise.all([i.e(66445),i.e(22666),i.e(5993),i.e(4015),i.e(53842),i.e(66639),i.e(35649),i.e(5145),i.e(30006),i.e(46036),i.e(58056),i.e(91033),i.e(99916),i.e(67080),i.e(15518),i.e(45166),i.e(64619),i.e(79497),i.e(50690),i.e(22189),i.e(47260)]).then(i.bind(i,648393)).then((({BottomToolbarRenderer:e})=>{var i=o.resizerBridge,s=[i.container.spawn(),i.width.spawn(),i.height.spawn()],r=i.container.value(),n=function(){var e=r.getBoundingClientRect(),t=U(Mt());return t.top=e.top+t.top,t.left=e.left+t.left,t},a=new C,l=function(){a.fire()};s.forEach((function(e){e.subscribe(l)}));var c=function(){s.forEach((function(e){e.destroy()})),a.destroy(),window.ChartApiInstance.connectionsLimitReached().unsubscribe(de)};St=new e(gt.value(),a,n,t,ChartApiInstance,ot,o.seriesControlBar),vt=function(){null!==St&&(St.destroy(),St=null,gt.value().remove(),gt.setValue(null)),c()}})));var ft=new S(t),bt=new v(t),yt=null;function Ct(){mt.setValue(be.some((e=>{const t=e.chartWidget.lineToolsSynchronizer();return null!==t&&t.hasChanges().value()})))}function wt(e){
return D.checkProFeatureImpl(Mt(),e)}yt=new I(o.resizerBridge,(function(){return gt.value()?gt.offsetHeight:0})),window.ChartApiInstance.connectionsLimitReached().subscribe(de,{callWithLast:!0}),Re.subscribe((()=>At()));const Pt=new Map,Tt=()=>D.updateLinkingGroupCharts(Mt());function Mt(){return{undoHistory:lt,chartWidgetsDefs:be,chartsCountToSave:xt,actualLayoutCount:It,savedChartWidgetOptions:ke,activeChartWidget:Se,options:o,parent:ct,toastsFactory:yt,crosshairLockRaw:et,crossHairSyncBroadcast:Ze,setChartStorageNotificationSubscription:e=>{$e=e},maximizedChartDef:st,setMaximized:Wt,layoutTemplate:Pe,widthWV:tt,heightWV:it,checkProFeature:wt,lineToolsSynchronizerHasChanges:mt,recalcHasChanges:Ct,onZoom:_t,onScroll:pt,layoutType:Te,layoutWV:ze,setLayoutType:e=>{Te=e},isPhoneSize:Be,viewMode:Le,updateViewMode:Ht,loadingContent:Ee,setLoadingContent:e=>{Ee=e},initialLoading:De,inlineChartsCount:we,updateWatchedValue:Ut,checkAllPendingModelsAlreadyCreated:zt,readOnly:ve,symbolLock:Ve,internalSymbolLock:Oe,intervalLock:Fe,internalIntervalLock:We,dateRangeLock:je,internalDateRangeLock:je,trackTimeLock:He,internalTrackTimeLock:Ge,crosshairLock:Ye,customLegendWidgetsFactoriesMap:fi,globalDetachable:Ce,saveChartService:Xe,customSources:Si,updateActivityView:Gt,chartWidgetCreatedDelegate:ut,sizingState:Re,currentLayoutResizeAction:Me,allLayoutSizesState:xe,splitters:Ie,widgetOptions:ot,bottomToolbar:gt,replayContainer:vi,layoutSizesChanged:Ne,subscribeToCompletedEventForDateRangeSync:ri,subscribeToEventsForDateRangeSync:oi,unsubscribeFromEventsForDateRangeSync:ni,syncChartsDateRangesWithActiveChartRange:ci,combinedTrackTimeLock:Ue,flags:Ae,linkingGroupsCharts:Pt,updateLinkingGroupCharts:Tt}}function xt(){return be.length+ke.length}function It(){return n[Te].count}function Lt(e,t,i,s,r){return V(Mt(),e,t,i,s,r)}function kt(e){return e.value()?1:0}function At(){H(Mt())}tt.subscribe(At),it.subscribe(At),this.updateLayout=At;const Et=D.activeLinkingGroupWV(Se),Dt=D.allLinkingGroupsWV(Mt());var Bt;Be.setValue(!1);var Rt=["phone","phone-vertical"];function Nt(e,t){o.mobileForceChartMaximizeEnabled&&(!Rt.includes(M.device)||t&&Rt.includes(t)?Rt.includes(M.device)||t&&!Rt.includes(t)||Be.setValue(!1):Be.setValue(!0))}function Vt(){if(window.is_authenticated){var e=u.enabled("app_phone");!u.enabled("app_tablet")&&(e||Be.value())?Le.value()===T.ForceFullscreen&&(Bt=st.value(),Se.value().requestFullscreen()):Bt||(Wt(null),Ht())}}function Ot(e){return e.rdState.owner.value()!==e}function Ft(e){return q(Mt(),e,t)}function Wt(e){st.value()!==e&&(st.setValue(e),Ft(Te))}function zt(){be.every((e=>e.chartWidget.hasModel()))&&(Ut(),d.emit("layout_changed"))}function Ht(){"s"===Te||st.value()?Le.setValue(T.ForceFullscreen):Le.setValue(T.Multichart)}function Ut(){var e=Math.min(Pe.value().count,be.length)-1;if(e<0)Se.deleteValue();else{var t=ye;t<0&&(t=0),t>e&&(t=e),Se.setValue(be[t].chartWidget)}}function Gt(){for(var e=be.length;e--;){var t=e===ye;be[e].container.value().classList.toggle("active",t),
be[e].container.value().classList.toggle("inactive",!t)}}function qt(e,t){return G(Mt(),e,t)}function jt(e){var t=qt(be[ye],e);t&&(Se.setValue(t.chartWidget),st.value()&&Ft(Te))}const Yt=new C;function Kt(e,t){var i=be.findIndex((function(t){return t.chartWidget===e})),s=be.findIndex((function(e){return e.chartWidget===t}));if(-1===i||-1===s)throw new Error("chart is not in the layout");var r=be[i],o=be[s];be[i]=o,be[s]=r,ye===i?ye=s:ye===s&&(ye=i),At(),Yt.fire()}var Xt=new C,$t=new _,Zt=new _([]);function Qt(e,t){var i=e.model(),s=i.mainSeries().properties().style;i.setChartStyleProperty(s,t,me)}var Jt=null;function ei(e){var t=e.mainSeries().properties();t.style.subscribe(null,ti),ti(t.style),e.model().onSelectedSourceChanged().subscribe(null,ii),qe.value()&&(oi(e),ci()),ii(e.selection().allSources())}function ti(e){$t.setValue(e.value())}function ii(){var e=Jt.model();Zt.setValue(e.selection().allSources())}Se.subscribe((function(e){if(e){for(var t,i=be.length;i--;)if(be[i].chartWidget===e){t=i;break}if(!isFinite(t))throw new Error("Cannot make detached ChartWidget active");if(ye!==t){st.value()&&(Ot(be[t])||st.setValue(be[t])),ye=t,Gt();for(i=be.length;i--;)be[i].chartWidget!==e&&be[i].chartWidget.setActive(!1);Li(),e.setActive(!0),l.activePointSelectionMode.setValue(e.selectPointMode().value())}!function(e){if(Jt!==e){if(Jt&&(Jt.modelCreated().unsubscribe(null,ei),Jt.hasModel())){var t=Jt.model();qe.value()&&ni(t),t.mainSeries().properties().style.unsubscribe(null,ti),t.model().onSelectedSourceChanged().unsubscribe(null,ii),Jt=null}e&&(Jt=e,e.hasModel()?ei(e.model()):e.modelCreated().subscribe(null,ei))}}(e)}}),{callWithLast:!0});var si=new Map;function ri(e,t){var i=e.id();if(!si.has(i)){var s=function(){const i=e.id();si.has(i)&&(si.delete(i),ci(t?e:void 0))};e.model().mainSeries().dataEvents().completed().subscribe(null,s,!0),si.set(i,{cw:e,callback:s})}}function oi(e){e.timeScale().visibleBarsStrictRangeChanged().subscribe(null,li)}function ni(e){e.timeScale().visibleBarsStrictRangeChanged().unsubscribe(null,li),si.forEach((function(e){var t=e.cw,i=e.callback;t.model().mainSeries().dataEvents().completed().unsubscribe(null,i)})),si.clear()}function ai(e){qe.value()&&null===e&&ci()}function li(e,t){ci()}function ci(e){if(qe.value()&&null===Me.value()){var t=Se.value(),i=t.model().mainSeries();if(y.isTimeBasedStyle(i.style())){var s=t.model().timeScale(),r=s.visibleBarsStrictRange();if(null!==r){var o=s.points().range().value(),n=s.indexToTimePoint(r.firstBar());null===n&&i.endOfData()&&(n=s.indexToTimePoint(o.firstIndex));var a=s.indexToTimePoint(r.lastBar());if(null===a&&(a=s.indexToTimePoint(o.lastIndex)),null!==n&&null!==a){si.delete(t.id());var l=1e3*n,c=1e3*a;if(i.isDWM()){var h=new Date(l),d=new Date(c);b.set_hms(h,0,0,0,0),b.set_hms(d,0,0,0,0),l=h.getTime(),c=d.getTime()}for(var u=0;u<be.length;u++){var _=be[u].chartWidget;_.hasModel()&&_!==t&&(void 0===e||_===e)&&y.isTimeBasedStyle(_.model().mainSeries().style())&&setTimeout(hi.bind(null,_,l,c))}}else ri(t,!1)}}}}function hi(e,t,i){
e.model().model().gotoTimeRange(t,i)}var di=new C;function ui(){o.resizerBridge.requestFullscreen()}function _i(){o.resizerBridge.exitFullscreen()}function pi(){return o.resizerBridge.fullscreenable}function mi(){return o.resizerBridge.fullscreen}function gi(e){if(0!==be.length){for(var t=be.length;t--;)be[t].chartWidget.setActive(!1);be[ye].chartWidget.setActive(e)}}ve||(Ke.add({desc:"Switch active chart",hotkey:9,handler:function(){jt(!1)}}),Ke.add({desc:"Switch active chart",hotkey:h.Modifiers.Shift+9,handler:function(){jt(!0)}})),Ke.add({desc:"Fullscreen mode",hotkey:h.Modifiers.Shift+70,isDisabled:u.enabled("widget")||!pi().value(),handler:function(){mi().value()?_i():ui()}}),o.takeScreenshotEnabled&&(Ke.add({desc:"Screenshot server",hotkey:h.Modifiers.Alt+83,handler:D.takeServerScreenshot.bind(this,o.snapshotUrl,t)}),f("any")||(Ke.add({desc:"Download client screenshot",hotkey:h.Modifiers.Mod+h.Modifiers.Alt+83,handler:D.downloadScreenshot.bind(this,t)}),Ke.add({desc:"Copy client screenshot",hotkey:h.Modifiers.Mod+h.Modifiers.Shift+83,handler:D.copyScreenshotToClipboard.bind(this,t)}))),o.saveChartEnabled&&Ke.add({desc:"Save Chart Layout",hotkey:h.Modifiers.Mod+83,handler:function(){Xt.fire()}});var Si=new Map,vi=null,fi=new Map;const bi=W(Mt());o.globalEvents&&bi.listen();const yi=Ve.spawn(),Ci=Fe.spawn(),wi=qe.spawn(),Pi=He.spawn(),Ti=Ye.spawn(),Mi=()=>be.map((e=>e.chartWidget)),xi=ue(Mi,ze.readonly(),Yt,ut);function Ii(e,t){if(Ee=!0,De=Boolean(t),ke.splice(0),e){if(e.charts||(e={layout:"s",charts:[e]}),e.layoutsSizes)for(const t of Object.keys(e.layoutsSizes))xe.set(t,e.layoutsSizes[t]);var i=new Set;e.charts.forEach((function(e){e.chartId&&i.add(e.chartId)})),e.charts.forEach((function(e){if(!e.chartId){var t=Y((function(e){return i.has(e)}));i.add(t),e.chartId=t}}));let t=e.layout;if(!w(t)){const e=P(t);p.logError(`Loading unsupported layout ${t}. Force migration to ${e}`),t=e}Te=wt(t||"s");for(var s=0;s<e.charts.length;s++){var r=e.charts[s];ke.push({content:r})}void 0!==e.symbolLock&&Ve.setValue(Boolean(e.symbolLock)),void 0!==e.intervalLock&&Fe.setValue(Boolean(e.intervalLock)),void 0!==e.trackTimeLock&&He.setValue(Boolean(e.trackTimeLock)),void 0!==e.dateRangeLock&&qe.setValue(Boolean(e.dateRangeLock)),void 0!==e.crosshairLock&&Ye.setValue(Boolean(e.crosshairLock))}Ft(Te),"s"===Te||o.mobileForceChartMaximizeEnabled||Le.setValue(T.Multichart),l.init(),l.tool.subscribe(ki),l.tool.subscribe(Li),Ee=!1,De=!1}function Li(){var e=Se.value();be.forEach((function(t){t.chartWidget!==e&&t.chartWidget.updateCrossHairPositionIfNeeded()})),e&&e.updateCrossHairPositionIfNeeded()}function ki(){be.forEach((function(e){e.chartWidget.onToolChanged()}))}Object.assign(this,{getAll:Mi,maximizedChartWidget:()=>rt.readonly(),leftBottomChartWidget:()=>xi,activeLinkingGroup:()=>Et,allLinkingGroups:()=>Dt,linkingGroupsCharts:e=>D.getLinkingGroupCharts(Mt(),e).readonly(),destroy:function(){if(di.fire(),gi(!1),null!==vt&&(vt(),vt=null),j(Mt()),yi.destroy(),Ci.destroy(),Pi.destroy(),wi.destroy(),Ue.destroy(),Ti.destroy(),
Me.unsubscribe(ai),be.forEach((function(e){void 0!==e.timingsMeter&&e.timingsMeter.destroy(),e.chartWidget.linkingGroupIndex().unsubscribe(Tt),e.chartWidget.destroy()})),o.resizerBridge.remove(),Ie.value().forEach((e=>{e.mouseHandler.destroy(),e.mouseListener.destroy()})),window.removeEventListener("resize",At),M.off("changeDevice",Nt),o.mobileForceChartMaximizeEnabled&&!o.handleMaximizedChartOnResizeDisabled&&M.off("changeDevice",Vt),l.tool.unsubscribe(Li),l.tool.unsubscribe(ki),dt.resolve(),ct.remove(),Si.clear(),fi.clear(),Ke.destroy(),$e&&$e.destroy(),bi&&bi.destroy(),Et.destroy(),Dt.destroy(),window.TVD){const e=window.TVD.crosshairSyncEnabled;e&&e.unsubscribe(Qe),$(Mt())}xi.destroy()},onAboutToBeDestroyed:di,layout:ze.readonly(),setLayout:Ft,activeChartWidget:Se,viewMode:Le,activeChartStyle:$t.readonly(),setChartStyleToWidget:function(e,t){if(t||(t=Se.value()),t){for(var i=!1,s=D.getChartWidgetsForIntervalLock(Mt()),r=0;r<s.length;r++){var o=s[r].model().model();if(o.isInReplay()&&!o.isSeriesStyleSupported(e)){i=!0;break}}!i||Ae.isConfirmationAboutReplayLocked?Qt(t,e):A({text:ge,onConfirm:function(i){Ae.isConfirmationAboutReplayLocked=!0,Qt(t,e),Ae.isConfirmationAboutReplayLocked=!1,i.dialogClose()}})}},selectedSources:Zt.readonly(),metaInfo:at,state:function(e,i,s,r){for(var o=[],n=xt(),a=0;a<n;a++){var l=Lt(a,e,i,s,r);l&&o.push(l)}var c={name:t.metaInfo.name.value(),layout:Te,charts:o};return c.symbolLock=kt(Ve),c.intervalLock=kt(Fe),c.trackTimeLock=kt(He),c.dateRangeLock=kt(qe),c.crosshairLock=kt(Ye),c.layoutsSizes={},xe.forEach(((e,t)=>{c.layoutsSizes[t]=e})),c},lineToolsAndGroupsDTOs:function(){return N(Mt())},resetLineToolsInvalidated:function(e,t){return O(Mt(),e,t)},applyLineToolUpdateNotification:F.bind(null,be),readOnly:function(){return ve},onZoom:function(){return _t},onScroll:function(){return pt},resizerBridge:function(){return o.resizerBridge},lock:{symbol:yi,interval:Ci,dateRange:wi,crosshair:Ti,trackTime:Pi},setSymbol:(e,t)=>D.setSymbol(Mt(),e,t),setSymbolAll:(e,t)=>D.setSymbolAll(Mt(),e,t),setResolution:(e,t)=>D.setResolution(Mt(),e,t),setTimeFrame:function(e){Ae.loadingChart||Ae.setTimeFrameActive||(Ae.setTimeFrameActive=!0,Fe.value()?be.forEach((function(t){t.chartWidget.loadRange(e)})):Se.value().loadRange(e),Ae.setTimeFrameActive=!1)},updateLayout:At,setChartLayoutWithUndo:function(e){return D.setChartLayoutWithUndoImpl(Mt(),this,e)},images:D.getSnapshot.bind(this,this,o.widgetOptions.customerReadableName,ot.onWidget),clientSnapshot:D.getClientSnapshot.bind(this,this,o.widgetOptions.customerReadableName,ot.onWidget),tags:function(){for(var e=[],t=0;t<be.length&&t<Pe.value().count;t++)e=e.concat(be[t].chartWidget.tags());return e=(e=Array.from(new Set(e))).map((function(e){return e.toLowerCase().replace(/\W+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}))},syncCrosshair:(e,t,i,s)=>K(Mt(),e,t,i,s),syncScroll:function(e,t){return Z(Mt(),e,t)},clearChartMetaInfo:function(){at.id.setValue(null),at.uid.setValue(void 0),at.name.setValue(void 0)},
takeScreenshot:D.takeScreenshot.bind(this,o.snapshotUrl,this),takeServerScreenshot:D.takeServerScreenshot.bind(this,o.snapshotUrl,this),loadContent:Ii,purgeUnusedWidgets:function(){for(var e=n[Te].count;e<be.length;e++)be[e].chartWidget.destroy();be.splice(n[Te].count)},applyOverrides:function(e){for(var t=0;t<be.length;t++)be[t].chartWidget.applyOverrides(e)},applyStudiesOverrides:function(e){for(var t=0;t<be.length;t++)be[t].chartWidget.applyStudiesOverrides(e)},switchChart:jt,startFullscreen:ui,exitFullscreen:_i,fullscreen:mi,fullscreenable:pi,destroyPromise:function(){return dt.promise()},chartWidgetCreated:function(){return ut},saveKeysPressed:function(){return Xt},getContainer:function(){return ct},onWidget:ot.onWidget,applyTheme:function(e){return ee(Mt(),t,e)},applyIndicatorsToAllCharts:function(e){B(Mt(),e)},applyIndicatorsToAllChartsAvailable:function(){return!ve&&It()>1},applyIndicatorToAllCharts:async function(e,t,i,s){await R(Mt(),e,t,i,s)},setActive:gi,inlineChartsCount:we.readonly(),revertToInline:function(){if(!Be.value()||Le.value()!==T.ForceFullscreen){Wt(null);for(var e=0;e<be.length;e++)be[e].rdState.bridge().attach()}},chartMarketStatuses:function(){return be.map((function(e){var t=e.chartWidget.hasModel()?e.chartWidget.model().mainSeries().marketStatusModel():null;return null!==t?k(t.status()):"-"}))},chartSeriesStatuses:function(){return be.map((function(e){var t=e.chartWidget.hasModel()?e.chartWidget.model().mainSeries().status():null;return(null===t?"":g.SERIES_STATUS_TEXT[t])+" ("+t+")"}))},undoHistory:lt,lineToolsSynchronizerHasChanges:mt,applyPreferencesToAllCharts:function(e){var t=e.model().preferences();be.forEach((function(i){i.chartWidget._model!==e&&i.chartWidget._model.applyPreferences(t)}))},getToasts:function(){return yt.getChartToasts()},addCustomSource:function(e,t,i){s(!Si.has(e),"Cannot create the same custom source multiple times"),Si.set(e,{factory:t,layer:i});for(var r=0;r<be.length;++r){var o=be[r].chartWidget;o.hasModel()&&o.model().model().addCustomSource(e,t,i)}},removeCustomSource:function(e){s(Si.has(e),"Cannot remove not created custom source"),Si.delete(e);for(var t=0;t<be.length;++t){var i=be[t].chartWidget;i.hasModel()&&i.model().model().removeCustomSource(e)}},addCustomWidgetToLegend:function(e,t){s(!fi.has(e),"Cannot create the same custom widget in legend multiple times"),fi.set(e,t);for(var i=0;i<be.length;++i)be[i].chartWidget.addCustomWidgetToLegend(e,t)},addReplayWidget:function(e){s(null===vi,"Cannot create replay container multiple times"),(vi=document.createElement("div")).style.position="absolute",vi.style["min-height"]="51px",vi.style.overflow="hidden",vi.style.left="0px",vi.style.right="0px";var t=null===gt.value()?0:gt.value().offsetHeight;vi.style.bottom=`${t}px`,vi.setAttribute("data-is-chart-toolbar-component","true"),ct.prepend(vi),e(vi,(()=>At())),At()},destroyReplayWidget:function(){s(null!==vi,"Cannot remove replay container, container is not created"),vi.remove(),vi=null,At()},setViewMode:function(e){Le.setValue(e)},
moveActiveChartWithUndo:function(e){var t=be[ye],i=qt(t,e);i&&lt.pushUndoCommand(new x(Kt,t.chartWidget,i.chartWidget))},activeChartCanBeMoved:function(){return!(ve||we.value()<2||Ot(be[ye]))},generalPropertiesDefinitions:function(){return Se.value().generalPropertiesDefinitions()},reconnectChartApi:function(e){L(e)},setBroker:function(e){_e(Mt(),e)},setSaveChartService:function(e){Xe=e;for(var t=0;t<be.length;++t){be[t].chartWidget.setSaveChartService(e)}},getCompareDialogRenderer:function(){return bt},getChartPropertiesDialogRenderer:function(){return ft},clipboard:bi,chartsSymbols:function(){return z(Mt())},isFirstChartInLayout:te.bind(null,Mt()),deserializedChartIds:ie.bind(null,Mt()),layoutSizesChanged:()=>Ne,clientId:fe}),D.createChartStorageSubscriptionsIfRequired(this,Mt()),Ii(o.content,!0),ze.subscribe((function(){Gt()})),ze.hook=function(e){return e===this.value()?e:wt(e)},ve&&(ze.writeLock=!0),window.addEventListener("resize",At),o.mobileForceChartMaximizeEnabled&&(M.on("changeDevice",Nt),o.handleMaximizedChartOnResizeDisabled||M.on("changeDevice",Vt),Nt(),Vt());var Ai=0;function Ei(){0===--Ai&&d.emitOnce("onChartReady")}be.forEach((function(e){if(e){Ai++;var t=e.chartWidget;t.withModel(null,(function(){o.metaInfo&&t.model().model().setChartSaveTime(1e3*o.metaInfo.lastModified);var e=t.model().mainSeries();if(e.bars().size()>0||e.isFailed())Ei();else{var i=e.dataEvents(),s=function(){Ei(),i.barReceived().unsubscribe(null,s),i.completed().unsubscribe(null,s),i.error().unsubscribe(null,s)};i.barReceived().subscribe(null,s),i.completed().subscribe(null,s),i.error().subscribe(null,s)}}))}})),Q(Mt()).then(J).then((function(){window.saver&&window.is_authenticated&&o.widgetOptions.justCloned&&window.saver.saveChartSilently()})).catch(p.logError.bind(p))}},419250:(e,t,i)=>{"use strict";i.d(t,{createAddNoteAction:()=>l});var s=i(444372),r=i(158566),o=i(470316),n=i(137674),a=i(324020);function l(e,t,l){return new r.TVAction({icon:a,label:s.t(null,void 0,i(534999)),statName:"AddToTextNotes",onExecute:()=>{window.runOrSignIn((()=>{var t;null===(t=window.widgetbar)||void 0===t||t.setPage("base"),(0,n.createSymbolNote)(e.symbolWV().value(),l)}),{source:"Add text note in chart context menu"})},hotkeyHash:o.Modifiers.Alt+78,...t})}},993294:(e,t,i)=>{"use strict";i.d(t,{createSymbolSearchAction:()=>l});var s=i(444372),r=i(373571),o=i(167975),n=i(560420),a=i(244842);function l(){return new r.Action({actionId:"Chart.Dialogs.ShowChangeSymbol",label:(0,o.appendEllipsis)(s.t(null,void 0,i(128089))),statName:"ChangeSymbol",onExecute:()=>{(0,n.showDialog)({defaultValue:"",trackResultsOptions:{trackResults:!a.enabled("widget"),emptySearchType:"empty_result__supercharts"}})}})}},794349:(e,t,i)=>{"use strict";var s;i.d(t,{TabNames:()=>s}),function(e){e.background="Background",e.coordinates="Coordinates",e.drawings="Drawings",e.events="Events",e.eventsAndAlerts="Events & Alerts",e.inputs="Inputs",e.properties="Properties",e.scales="Scales",e.legend="Legend",e.sourceCode="Source Code",e.style="Style",e.symbol="Symbol",
e.timezoneSessions="Timezone/Sessions",e.trading="Trading",e.visibility="Visibility",e.text="Text"}(s||(s={}))},175070:(e,t,i)=>{"use strict";i.d(t,{getPriceAxisNameInfo:()=>n});const s=["Z","Y","X","W","V","U","T","S"],r=["A","B","C","D","E","F","G","H"];class o{constructor(e){this.label=e}equals(e){return null!==e&&this.label===e.label}}function n(e,t){const i="left"===e?s:r;return new o(t<i.length?i[t]:"")}},12943:(e,t,i)=>{"use strict";i.d(t,{icons:()=>s});const s=["","","","",""]},453817:(e,t,i)=>{"use strict";i.d(t,{LayoutChartsSyncContextMenuAction:()=>a});var s=i(861814),r=i(444372),o=i(158566),n=i(12943);class a extends o.TVAction{constructor(e,t){super({icon:s,statName:"SetLayoutChartsSyncGroup",label:r.t(null,void 0,i(680818)),subItems:[new o.TVLoader]}),this._setLinkingGroupIndexImpl=e=>{this._setLinkingGroupIndex(this._linkingGroupIndex.value()===e?null:e)},this._linkingGroupIndex=e.spawn(),this._setLinkingGroupIndex=t,this._loadSubMenu()}async _loadSubMenu(){const[e,{LayoutChartsSyncContextMenuItem:t}]=await Promise.all([Promise.resolve().then(i.t.bind(i,50959,19)),Promise.all([i.e(68992),i.e(18182),i.e(9988),i.e(10184)]).then(i.bind(i,339148))]);this.update({subItems:[new o.TVAction({jsxLabel:e.createElement(t,{active:this._linkingGroupIndex,icons:n.icons,onClick:this._setLinkingGroupIndexImpl}),doNotCloseOnClick:!1,noInteractive:!0})]})}}},431912:(e,t,i)=>{"use strict";i.d(t,{MouseEventHandler:()=>h});var s=i(638456),r=i(650151),o=i(389137),n=i(196726),a=i(86121);const l=s.isSafari?"click":"auxclick",c={treatVertTouchDragAsPageScroll:!1,treatHorzTouchDragAsPageScroll:!1};class h{constructor(e,t,i){this._clickCount=0,this._clickTimeoutId=null,this._clickPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY},this._tapCount=0,this._tapTimeoutId=null,this._tapPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY},this._longTapTimeoutId=null,this._longTapActive=!1,this._mouseMoveStartPosition=null,this._touchMoveStartPosition=null,this._touchMoveExceededManhattanDistance=!1,this._cancelClick=!1,this._cancelTap=!1,this._unsubscribeOutsideMouseEvents=null,this._unsubscribeOutsideTouchEvents=null,this._unsubscribeMobileSafariEvents=null,this._unsubscribeMousemove=null,this._unsubscribeRootMouseEvents=null,this._unsubscribeRootTouchEvents=null,this._pinchInfo=null,this._pinchPrevented=!1,this._preventTouchDragProcess=!1,this._mousePressed=!1,this._lastTouchEventTimeStamp=0,this._activeTouchId=null,this._acceptMouseLeave=!s.CheckMobile.iOS(),this._onFirefoxOutsideMouseUp=e=>{this._mouseUpHandler(e)},this._onMobileSafariDoubleClick=e=>{if(this._firesTouchEvents(e)){const t=this._makeCompatEvent(e);if(++this._tapCount,this._tapTimeoutId&&this._tapCount>1){const{manhattanDistance:i}=this._touchMouseMoveWithDownInfo(u(e),this._tapPosition);i<30&&!this._cancelTap&&this._processTouchEvent(t,this._handler.doubleTapEvent),this._resetTapTimeout()}}else{const t=this._makeCompatEvent(e);if(++this._clickCount,this._clickTimeoutId&&this._clickCount>1){
const{manhattanDistance:i}=this._touchMouseMoveWithDownInfo(u(e),this._clickPosition);i<5&&!this._cancelClick&&this._processMouseEvent(t,this._handler.mouseDoubleClickEvent),this._resetClickTimeout()}}},this._target=e,this._handler=t,this._options=(0,o.merge)((0,o.clone)(c),i||{}),this._init()}destroy(){null!==this._unsubscribeOutsideMouseEvents&&(this._unsubscribeOutsideMouseEvents(),this._unsubscribeOutsideMouseEvents=null),null!==this._unsubscribeOutsideTouchEvents&&(this._unsubscribeOutsideTouchEvents(),this._unsubscribeOutsideTouchEvents=null),null!==this._unsubscribeMousemove&&(this._unsubscribeMousemove(),this._unsubscribeMousemove=null),null!==this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null),null!==this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null),null!==this._unsubscribeMobileSafariEvents&&(this._unsubscribeMobileSafariEvents(),this._unsubscribeMobileSafariEvents=null),this._clearLongTapTimeout(),this._resetClickTimeout()}_mouseEnterHandler(e){this._unsubscribeMousemove&&this._unsubscribeMousemove();const t=this._mouseMoveHandler.bind(this);if(this._unsubscribeMousemove=()=>{this._target.removeEventListener("mousemove",t)},this._target.addEventListener("mousemove",t),this._firesTouchEvents(e))return;const i=this._makeCompatEvent(e);this._processMouseEvent(i,this._handler.mouseEnterEvent),this._acceptMouseLeave=!0}_resetClickTimeout(){null!==this._clickTimeoutId&&clearTimeout(this._clickTimeoutId),this._clickCount=0,this._clickTimeoutId=null,this._clickPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY}}_resetTapTimeout(){null!==this._tapTimeoutId&&clearTimeout(this._tapTimeoutId),this._tapCount=0,this._tapTimeoutId=null,this._tapPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY}}_mouseMoveHandler(e){if(this._mousePressed||null!==this._touchMoveStartPosition)return;if(this._firesTouchEvents(e))return;const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.mouseMoveEvent),this._acceptMouseLeave=!0}_touchMoveHandler(e){const t=m(e.changedTouches,(0,r.ensureNotNull)(this._activeTouchId));if(null===t)return;if(this._lastTouchEventTimeStamp=p(e),null!==this._pinchInfo&&this._pinchInfo.accepted)return;if(this._preventTouchDragProcess)return;this._pinchPrevented=!0;const i=this._touchMouseMoveWithDownInfo(u(t),(0,r.ensureNotNull)(this._touchMoveStartPosition)),{xOffset:s,yOffset:o,manhattanDistance:a}=i;if(this._touchMoveExceededManhattanDistance||!(a<5)){if(!this._touchMoveExceededManhattanDistance){const e=.5*s,t=o>=e&&!this._options.treatVertTouchDragAsPageScroll,i=e>o&&!this._options.treatHorzTouchDragAsPageScroll;t||i||(this._preventTouchDragProcess=!0),this._touchMoveExceededManhattanDistance=!0,this._cancelTap=!0,this._clearLongTapTimeout(),this._resetTapTimeout()}if(!this._preventTouchDragProcess){const i=this._makeCompatEvent(e,t);this._processTouchEvent(i,this._handler.touchMoveEvent),(0,n.preventDefault)(e)}}}_mouseMoveWithDownHandler(e){
if(0!==e.button)return;const t=this._touchMouseMoveWithDownInfo(u(e),(0,r.ensureNotNull)(this._mouseMoveStartPosition)),{manhattanDistance:i}=t;if(i>=5&&(this._cancelClick=!0,this._resetClickTimeout()),this._cancelClick){const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.pressedMouseMoveEvent)}}_touchMouseMoveWithDownInfo(e,t){const i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y);return{xOffset:i,yOffset:s,manhattanDistance:i+s}}_touchEndHandler(e){let t=m(e.changedTouches,(0,r.ensureNotNull)(this._activeTouchId));if(null===t&&0===e.touches.length&&(t=e.changedTouches[0]),null===t)return;this._activeTouchId=null,this._lastTouchEventTimeStamp=p(e),this._clearLongTapTimeout(),this._touchMoveStartPosition=null,this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null);const i=this._makeCompatEvent(e,t);if(this._processTouchEvent(i,this._handler.touchEndEvent),++this._tapCount,this._tapTimeoutId&&this._tapCount>1){const{manhattanDistance:e}=this._touchMouseMoveWithDownInfo(u(t),this._tapPosition);e<30&&!this._cancelTap&&this._processTouchEvent(i,this._handler.doubleTapEvent),this._resetTapTimeout()}else this._cancelTap||(this._processTouchEvent(i,this._handler.tapEvent),this._handler.tapEvent&&(0,n.preventDefault)(e));0===this._tapCount&&(0,n.preventDefault)(e),0===e.touches.length&&this._longTapActive&&(this._longTapActive=!1,(0,n.preventDefault)(e))}_mouseUpHandler(e){if(0!==e.button)return;const t=this._makeCompatEvent(e);if(this._mouseMoveStartPosition=null,this._mousePressed=!1,this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null),s.isFF){this._target.ownerDocument.documentElement.removeEventListener("mouseleave",this._onFirefoxOutsideMouseUp)}if(!this._firesTouchEvents(e))if(this._processMouseEvent(t,this._handler.mouseUpEvent),++this._clickCount,this._clickTimeoutId&&this._clickCount>1){const{manhattanDistance:i}=this._touchMouseMoveWithDownInfo(u(e),this._clickPosition);i<5&&!this._cancelClick&&this._processMouseEvent(t,this._handler.mouseDoubleClickEvent),this._resetClickTimeout()}else this._cancelClick||(this._processMouseEvent(t,this._handler.mouseClickEvent),e.defaultPrevented&&--this._clickCount)}_clearLongTapTimeout(){null!==this._longTapTimeoutId&&(clearTimeout(this._longTapTimeoutId),this._longTapTimeoutId=null)}_touchStartHandler(e){if(null!==this._activeTouchId)return;const t=e.changedTouches[0];this._activeTouchId=t.identifier,this._lastTouchEventTimeStamp=p(e);const i=this._target.ownerDocument.documentElement;this._cancelTap=!1,this._touchMoveExceededManhattanDistance=!1,this._preventTouchDragProcess=!1,this._touchMoveStartPosition=u(t),this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null);{const t=this._touchMoveHandler.bind(this),s=this._touchEndHandler.bind(this);this._unsubscribeRootTouchEvents=()=>{i.removeEventListener("touchmove",t),i.removeEventListener("touchend",s)},i.addEventListener("touchmove",t,{passive:!1}),
i.addEventListener("touchend",s,{passive:!1}),this._clearLongTapTimeout(),this._longTapTimeoutId=setTimeout(this._longTapHandler.bind(this,e),240)}const s=this._makeCompatEvent(e,t);this._processTouchEvent(s,this._handler.touchStartEvent),this._tapTimeoutId||(this._tapCount=0,this._tapTimeoutId=setTimeout(this._resetTapTimeout.bind(this),500),this._tapPosition=u(t))}_wheelClickHandler(e){if(1!==e.button)return;if(this._firesTouchEvents(e))return;const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.wheelClickEvent)}_mouseDownHandler(e){if(0!==e.button)return;const t=this._target.ownerDocument.documentElement;s.isFF&&t.addEventListener("mouseleave",this._onFirefoxOutsideMouseUp),this._cancelClick=!1,this._mouseMoveStartPosition=u(e),this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null);{const e=this._mouseMoveWithDownHandler.bind(this),i=this._mouseUpHandler.bind(this);this._unsubscribeRootMouseEvents=()=>{t.removeEventListener("mousemove",e),t.removeEventListener("mouseup",i)},t.addEventListener("mousemove",e),t.addEventListener("mouseup",i)}if(this._mousePressed=!0,this._firesTouchEvents(e))return;const i=this._makeCompatEvent(e);this._processMouseEvent(i,this._handler.mouseDownEvent),this._clickTimeoutId||(this._clickCount=0,this._clickTimeoutId=setTimeout(this._resetClickTimeout.bind(this),500),this._clickPosition=u(e))}_init(){this._target.addEventListener("mouseenter",this._mouseEnterHandler.bind(this)),this._target.addEventListener("touchcancel",this._clearLongTapTimeout.bind(this));{const e=this._target.ownerDocument,t=e=>!e.target||!this._target.contains(e.target),i=e=>{if(!t(e))return;const i=e.changedTouches[0];this._lastTouchEventTimeStamp=p(e),this._processTouchEvent(this._makeCompatEvent(e,i),this._handler.touchStartOutsideEvent)},s=e=>{t(e)&&!this._firesTouchEvents(e)&&this._processMouseEvent(this._makeCompatEvent(e),this._handler.mouseDownOutsideEvent)};this._unsubscribeOutsideTouchEvents=()=>{e.removeEventListener("touchstart",i)},this._unsubscribeOutsideMouseEvents=()=>{e.removeEventListener("mousedown",s)},e.addEventListener("mousedown",s),e.addEventListener("touchstart",i,{passive:!0})}s.CheckMobile.iOS()&&(this._unsubscribeMobileSafariEvents=()=>{this._target.removeEventListener("dblclick",this._onMobileSafariDoubleClick)},this._target.addEventListener("dblclick",this._onMobileSafariDoubleClick)),this._target.addEventListener("mouseleave",this._mouseLeaveHandler.bind(this)),this._target.addEventListener("contextmenu",this._contextMenuHandler.bind(this)),this._target.addEventListener("touchstart",this._touchStartHandler.bind(this),{passive:!0}),(0,n.preventScrollByWheelClick)(this._target),this._target.addEventListener("mousedown",this._mouseDownHandler.bind(this)),this._target.addEventListener(l,this._wheelClickHandler.bind(this)),this._initPinch(),this._target.addEventListener("touchmove",(()=>{}),{passive:!1})}_initPinch(){
void 0===this._handler.pinchStartEvent&&void 0===this._handler.pinchEvent&&void 0===this._handler.pinchEndEvent||(this._target.addEventListener("touchstart",(e=>this._checkPinchState(e.touches)),{passive:!0}),this._target.addEventListener("touchmove",(e=>{if(null===this._pinchInfo||!this._pinchInfo.accepted)return;const t=m(e.touches,(0,r.ensureNotNull)(this._activeTouchId)),i=m(e.touches,this._pinchInfo.secondTouchId);if(t&&i&&void 0!==this._handler.pinchEvent){const{startPinchDistance:s,startPinchMiddlePoint:r}=this._pinchInfo,o=_(t,i)/s,a=d(this._target);this._handler.pinchEvent(r,{x:t.clientX-a.left,y:t.clientY-a.top},{x:i.clientX-a.left,y:i.clientY-a.top},o),(0,n.preventDefault)(e)}}),{passive:!1}),this._target.addEventListener("touchend",(e=>{this._checkPinchState(e.touches)})))}_checkPinchState(e){1===e.length&&(this._pinchPrevented=!1),2!==e.length||this._pinchPrevented||this._longTapActive?this._stopPinch():this._startPinch(e)}_startPinch(e){if(void 0!==this._handler.pinchStartEvent){const t=d(this._target);let i,s;e[0].identifier===this._activeTouchId?(i=e[0],s=e[1]):(i=e[1],s=e[0]);const r={x:i.clientX-t.left,y:i.clientY-t.top},o={x:s.clientX-t.left,y:s.clientY-t.top},n={x:(r.x+o.x)/2,y:(r.y+o.y)/2},a=this._handler.pinchStartEvent(n,r,o,{bothPointsOnTargetElement:this._target.contains(s.target)});this._pinchInfo={startPinchDistance:_(i,s),startPinchMiddlePoint:n,secondTouchId:s.identifier,accepted:a}}this._clearLongTapTimeout()}_stopPinch(){const e=this._pinchInfo;this._pinchInfo=null,null!==e&&e.accepted&&void 0!==this._handler.pinchEndEvent&&this._handler.pinchEndEvent()}_mouseLeaveHandler(e){if(this._unsubscribeMousemove&&this._unsubscribeMousemove(),this._firesTouchEvents(e))return;if(!this._acceptMouseLeave)return;const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.mouseLeaveEvent),this._acceptMouseLeave=!s.CheckMobile.iOS()}_longTapHandler(e){const t=m(e.touches,(0,r.ensureNotNull)(this._activeTouchId));if(null===t)return;const i=this._makeCompatEvent(e,t);this._processTouchEvent(i,this._handler.longTapEvent),this._processTouchEvent(i,this._handler.touchContextMenuEvent),this._cancelTap=!0,this._longTapActive=!0}_contextMenuHandler(e){if((0,n.preventDefault)(e),null!==this._touchMoveStartPosition)return;if(this._firesTouchEvents(e))return;const t=this._makeCompatEvent(e);this._processMouseEvent(t,this._handler.contextMenuEvent),this._cancelClick=!0}_firesTouchEvents(e){return e.sourceCapabilities&&void 0!==e.sourceCapabilities.firesTouchEvents?e.sourceCapabilities.firesTouchEvents:p(e)<this._lastTouchEventTimeStamp+500}_processTouchEvent(e,t){(0,a.setLastMouseOrTouchEventInfo)(e),t&&t.call(this._handler,e)}_processMouseEvent(e,t){"mouseleave"!==e.srcType&&(0,a.setLastMouseOrTouchEventInfo)(e),t&&t.call(this._handler,e)}_makeCompatEvent(e,t){const i=t||e,s=this._target.getBoundingClientRect()||{left:0,top:0};return{clientX:i.clientX,clientY:i.clientY,pageX:i.pageX,pageY:i.pageY,screenX:i.screenX,screenY:i.screenY,localX:i.clientX-s.left,localY:i.clientY-s.top,ctrlKey:e.ctrlKey,
altKey:e.altKey,shiftKey:e.shiftKey,metaKey:e.metaKey,isTouch:!e.type.startsWith("mouse")&&"contextmenu"!==e.type&&"click"!==e.type,stylus:"stylus"===(null==t?void 0:t.touchType),srcType:e.type,target:i.target,view:e.view,preventDefault:()=>{"touchstart"!==e.type&&(0,n.preventDefault)(e)}}}}function d(e){return e.getBoundingClientRect()||{left:0,top:0}}function u(e){return{x:e.pageX,y:e.pageY}}function _(e,t){const i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}function p(e){return e.timeStamp||performance.now()}function m(e,t){for(let i=0;i<e.length;++i)if(e[i].identifier===t)return e[i];return null}},535503:(e,t,i)=>{"use strict";i.d(t,{actualBehavior:()=>a,availableValues:()=>n,navigationButtonsVisibilityKey:()=>r,property:()=>o,restoreNavigationButtonsVisibilitySettingsValue:()=>l});var s=i(87053);const r="NavigationButtons.visibility",{property:o,availableValues:n,actualBehavior:a,restoreDefaultValue:l}=(0,s.createVisibilityController)(r)},939702:(e,t,i)=>{"use strict";i.d(t,{actualBehavior:()=>a,availableValues:()=>n,property:()=>o,restorePaneButtonsVisibilitySettingsValue:()=>l});var s=i(87053),r=i(535503);const{property:o,availableValues:n,actualBehavior:a,restoreDefaultValue:l}=(0,s.createVisibilityController)("PaneButtons.visibility",r.navigationButtonsVisibilityKey)},608415:(e,t,i)=>{"use strict";i.d(t,{ActionBinder:()=>s});class s{constructor(e,t,i,s,r=null){this._property=t,this._undoModel=i,this._undoText=s,this._action=e,this.setValue(t.value()),t.subscribe(this,this._propertyChanged),null!==r?e.update({onExecute:r.bind(this)}):e.update({onExecute:this._onActionCallback.bind(this)})}destroy(){this._property.unsubscribe(this,this._propertyChanged)}value(){return this._action.isChecked()}setValue(e){this._action.update({checked:Boolean(e)})}_onActionCallback(){this._undoModel.setProperty(this._property,this.value(),this._undoText)}_propertyChanged(e){this.setValue(e.value())}}},261525:(e,t,i)=>{"use strict";i.d(t,{isCustomStudy:()=>r});const s={LinearRegression:!0,PivotPointsHighLow:!0,VbPSessions:!0,VbPSessionsRoughDetailed:!0,VbPPeriodic:!0,VbPAutoAnchored:!0,ZigZag:!0,TPOPeriodic:!0,VbPFixed:!0,PivotPointsStandard:!0,VbPVisible:!0,VbPAnchored:!0};function r(e){return e in s}},827710:(e,t,i)=>{"use strict";i.d(t,{MetaInfoHelper:()=>u});var s=i(650151),r=i(526075),o=i(368135),n=i(389137),a=i(201089),l=i(62745);function c(e){return!e.groupId&&!e.isHidden&&e.id!==l.RangeDependentStudyInputNames.FirstBar&&e.id!==l.RangeDependentStudyInputNames.LastBar}var h=i(261525);const d=(0,a.getLogger)("Platform.GUI.PropertyDialog.Indicators.MetaInfo");class u{constructor(e){this._metaInfo=e}hasUserEditableInputs(){return this._metaInfo.inputs.some(c)}getUserEditableInputs(){return this._metaInfo.inputs.filter(c)}hasUserEditableProperties(){return r.StudyMetaInfo.isScriptStrategy(this._metaInfo)}hasUserEditableStyles(){const e=this._metaInfo;return e.plots.length>0||void 0!==e.bands||void 0!==e.filledAreas||(0,
h.isCustomStudy)(e.shortId)||r.StudyMetaInfo.isScriptStrategy(this._metaInfo)||Object.values(e.graphics).some((e=>void 0!==e))}getUserEditablePlots(){const e=new Set,t=this._metaInfo;return t.plots.filter((i=>{if((0,o.isColorerPlot)(i)||(0,o.isTextColorerPlot)(i)||(0,o.isDataOffsetPlot)(i)||(0,o.isOhlcColorerPlot)(i)||(0,o.isAlertConditionPlot)(i)||(0,o.isDataPlot)(i))return!1;if((0,o.isOhlcPlot)(i)){const r=i.target;if(e.has(r))return!1;e.add(r);const o=(0,s.ensureDefined)(t.ohlcPlots);return!(0,s.ensureDefined)(o[r]).isHidden}{const e=t.styles?t.styles[i.id]:void 0;return void 0===e||!e.isHidden}}))}hasUserEditableOptions(){return this.hasUserEditableInputs()||this.hasUserEditableProperties()||this.hasUserEditableStyles()}getStrategyProperties(){const e=this._metaInfo,t=e.inputs.filter(p),i={..._};for(const s of t){const t=s.internalID;i[t]=s,_.hasOwnProperty(t)||d.logWarn(`Unknown strategy input internal id ${t} in ${e.fullId}`)}return(0,n.clone)(i)}}const _={currency:void 0,backtest_fill_limits_assumption:void 0,calc_on_every_tick:void 0,calc_on_order_fills:void 0,commission_value:void 0,commission_type:void 0,initial_capital:void 0,pyramiding:void 0,slippage:void 0,default_qty_type:void 0,default_qty_value:void 0,margin_long:void 0,margin_short:void 0,use_bar_magnifier:void 0,process_orders_on_close:void 0,fill_orders_on_standard_ohlc:void 0};function p(e){return"strategy_props"===e.groupId}},263955:(e,t,i)=>{"use strict";i.d(t,{showScriptInfoErrorNoticeDialog:()=>o});var s=i(444372),r=i(33900);function o(){(0,r.showNoticeDialog)({type:"modal",title:s.t(null,void 0,i(457898)),content:s.t(null,void 0,i(27937))})}},14952:(e,t,i)=>{"use strict";i.d(t,{restoreShowMarketOpenStatusProperty:()=>l,showMarketOpenStatusProperty:()=>a});var s=i(152633),r=i(62802);const o="Chart.ShowMarketOpenStatus";function n(){return r.getBool(o,true)}const a=(0,s.createPrimitiveProperty)(n());function l(){a.setValue(true),r.remove(o)}r.onSync.subscribe(null,(()=>a.setValue(n()))),a.subscribe(null,(()=>r.setValue(o,a.value())))},515625:(e,t,i)=>{"use strict";i.d(t,{MarketStatusModel:()=>d});var s=i(650151),r=i(401580),o=i(44031),n=i(988124),a=i(444331);class l{constructor(e,t){this._utcTime=new r.WatchedValue(null),this._expired=new r.WatchedValue(!1),this._sessionSpec=new r.WatchedValue(null),this._sessionSpecCache=null,this._utcDayStart=new Date(0),this._timeoutId=null,this._expiredBySymbolInfoTypespecs=!1,this._expiredByQuotesTypespecs=null,this._marketStatusSpawn=e.spawn(),this._quotesUpdate=t,this._quotesUpdate.subscribe(this,this._onQuotesUpdate)}destroy(){this._marketStatusSpawn.destroy(),this._clearTimeoutIfNeeded(),this._quotesUpdate.unsubscribeAll(this)}reset(){this._expiredBySymbolInfoTypespecs=!1,this._expiredByQuotesTypespecs=null,this._utcTime.setValue(null),this._expired.setValue(!1)}utcTime(){return this._utcTime.readonly()}expired(){return this._expired.readonly()}utcDayStart(){return this._utcDayStart}sessionSpec(){return this._sessionSpec.readonly()}setSymbolInfo(e){var t;if(this._clearTimeoutIfNeeded(),null===e||!(0,
a.isFuturesContractSymbol)(e)||void 0===e.expiration)return this._utcTime.setValue(null),void this._expired.setValue(!1);null!==this._sessionSpecCache&&this._sessionSpecCache.timezone===e.timezone&&this._sessionSpecCache.session===e.session&&this._sessionSpecCache.corrections===e.corrections&&this._sessionSpecCache.holidays===e.session_holidays||(this._sessionSpecCache={timezone:e.timezone,session:e.session,corrections:e.corrections,holidays:e.session_holidays,spec:new o.SessionSpec(e.timezone,e.session,e.session_holidays,e.corrections)},this._sessionSpec.setValue(null));const i=this._sessionSpecCache.spec;this._utcDayStart=function(e){const t=Math.floor(e/1e4)%1e4,i=Math.floor(e/100)%100-1,s=e%100;return new Date(Date.UTC(t,i,s))}(e.expiration);const s=i.bordersOfDailyBar(this._utcDayStart);if(null===s)return this._utcTime.setValue(null),this._expired.setValue(!1),void this._sessionSpec.setValue(i);const r=(0,n.get_timezone)(e.timezone);this._utcTime.setValue((0,n.cal_to_utc)(r,s.to)+1e3),this._sessionSpec.setValue(i),this._expiredBySymbolInfoTypespecs=Boolean(null===(t=e.typespecs)||void 0===t?void 0:t.includes("expired")),this._updateExpired()}_updateExpired(){this._clearTimeoutIfNeeded();const e=this._utcTime.value();if(null===e)return;if(this._expiredByQuotesTypespecs||this._expiredBySymbolInfoTypespecs)return void this._expired.setValue(!0);const t=window.ChartApiInstance.serverTime();let i;switch(this._marketStatusSpawn.value()){case"out_of_session":case"holiday":i=e-3e5-t;break;case"market":case"pre_market":case"post_market":i=e+3e5-t;break;default:i=e-t}i>0&&(this._timeoutId=setTimeout((()=>this._updateExpired()),i)),this._expired.setValue(i<=0)}_clearTimeoutIfNeeded(){null!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null)}_onQuotesUpdate(e,t){var i,s;let r=!1;if(null===this._expiredByQuotesTypespecs)this._expiredByQuotesTypespecs=Boolean(null===(i=e.values.typespecs)||void 0===i?void 0:i.includes("expired")),r=this._expiredByQuotesTypespecs;else if(void 0!==t.values.typespecs){const e=Boolean(null===(s=t.values.typespecs)||void 0===s?void 0:s.includes("expired"));r=this._expiredByQuotesTypespecs!==e,this._expiredByQuotesTypespecs=e}r&&null!==this._utcTime.value()&&this._updateExpired()}}function c(){return window.ChartApiInstance.serverTime()/1e3}function h(e,t,i){return e<=i?t<=i?1/0:t/1e3:Math.min(e,t)/1e3}class d{constructor(e){this._marketStatus=new r.WatchedValue(null),this._lastMarketStatus=null,this._sessionsSpec=null,this._nextSessionEdgeInternal=null,this._nextSessionEdge=new r.WatchedValue(null),this._recalcNextSessionEdgeTimerId=null,this._futuresContractExpirationTime=null,this._quotesProvider=e,e.quotesUpdate().subscribe(this,this._update.bind(this)),this._futuresContractExpirationTime=new l(this._marketStatus.readonly(),e.quotesUpdate()),e.quoteSymbolChanged().subscribe(this,(()=>{(0,s.ensureNotNull)(this._futuresContractExpirationTime).reset(),this._nextSessionEdgeInternal=null,this._recalculateNextSessionEdge()})),e.quoteSymbolChanged().subscribe(this,this._resetStatus)
}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this),this._quotesProvider.quoteSymbolChanged().unsubscribeAll(this),null!==this._recalcNextSessionEdgeTimerId&&clearTimeout(this._recalcNextSessionEdgeTimerId),(0,s.ensureNotNull)(this._futuresContractExpirationTime).destroy()}futuresContractExpirationTime(){return this._futuresContractExpirationTime}setSymbolInfo(e){var t,i,r,n,a;if((0,s.ensureNotNull)(this._futuresContractExpirationTime).setSymbolInfo(e),this._nextSessionEdgeInternal=null,null===e)return void(this._sessionsSpec=null);const l=new o.SessionSpec(e.timezone,null!==(t=e.session_display)&&void 0!==t?t:e.session,e.session_holidays,e.corrections);let c,h;const d=null===(i=e.subsessions)||void 0===i?void 0:i.find((e=>"premarket"===e.id)),u=null===(r=e.subsessions)||void 0===r?void 0:r.find((e=>"postmarket"===e.id));void 0!==d&&(c=new o.SessionSpec(e.timezone,null!==(n=d["session-display"])&&void 0!==n?n:d.session,e.session_holidays,d["session-correction"])),void 0!==u&&(h=new o.SessionSpec(e.timezone,null!==(a=u["session-display"])&&void 0!==a?a:u.session,e.session_holidays,u["session-correction"])),this._sessionsSpec={general:l,preMarket:c,postMarket:h},this._recalculateNextSessionEdge()}status(){return this._marketStatus}nextSessionEdge(){return this._nextSessionEdge}_resetStatus(){this._lastMarketStatus=null,this._marketStatus.setValue(null)}_update(e){void 0!==e&&void 0!==e.values.current_session&&(this._lastMarketStatus=e.values.current_session),null!==this._lastMarketStatus?this._marketStatus.setValue(this._lastMarketStatus):this._resetStatus()}_getNextSessionEdgeInternal(){var e;if(null===this._sessionsSpec||"24x7"===this._sessionsSpec.general.spec())return null;const t=1e3*c();if(null===this._nextSessionEdgeInternal||(null!==(e=this._nextSessionEdgeInternal.timestamp)&&void 0!==e?e:1/0)<=t/1e3){const{general:e,preMarket:i,postMarket:s}=this._sessionsSpec,r=(0,n.get_timezone)(e.timezone()),o=(0,n.utc_to_cal)(r,t),a=h((0,n.cal_to_utc)(r,e.alignToNearestSessionStart(o,1)),(0,n.cal_to_utc)(r,e.alignToNearestSessionEnd(o,1)),t),l=h(void 0!==i?(0,n.cal_to_utc)(r,i.alignToNearestSessionStart(o,1)):1/0,void 0!==i?(0,n.cal_to_utc)(r,i.alignToNearestSessionEnd(o,1)):1/0,t),d=h(void 0!==s?(0,n.cal_to_utc)(r,s.alignToNearestSessionStart(o,1)):1/0,void 0!==s?(0,n.cal_to_utc)(r,s.alignToNearestSessionEnd(o,1)):1/0,t);let u=Math.min(a,l,d);if(u===1/0){const t=c(),i=6e4,s=new Date(Math.round(new Date(1e3*t).getTime()/i)*i).getTime()+i,o=(0,n.utc_to_cal)(r,s),a=h((0,n.cal_to_utc)(r,e.alignToNearestSessionStart(o,1)),(0,n.cal_to_utc)(r,e.alignToNearestSessionEnd(o,1)),s),_=Math.min(a,l,d);_!==1/0?(this._nextSessionEdgeInternal={timestamp:u},u=_):this._nextSessionEdgeInternal={timestamp:null}}this._nextSessionEdgeInternal=u===d?{timestamp:u,status:"post_market"}:u===l?{timestamp:u,status:"pre_market"}:{timestamp:u}}return this._nextSessionEdgeInternal}_recalculateNextSessionEdge(){const e=this._getNextSessionEdgeInternal();if(null===e||null===e.timestamp)return void this._nextSessionEdge.setValue(null)
;const t={status:e.status,remainingSeconds:Math.max(0,e.timestamp-c())};if(null===this._recalcNextSessionEdgeTimerId){const e=Number.isFinite(t.remainingSeconds)?Math.ceil(t.remainingSeconds%60):1;this._recalcNextSessionEdgeTimerId=setTimeout((()=>this._recalculateNextSessionEdgeByTimer()),1e3*e)}this._nextSessionEdge.setValue(t)}_recalculateNextSessionEdgeByTimer(){this._recalcNextSessionEdgeTimerId=null,this._recalculateNextSessionEdge()}}},397245:(e,t,i)=>{"use strict";i.d(t,{marketStatusText:()=>r});var s=i(380271);function r(e){const t=e.value();if(null!==t){const e=s.titleMap.get(t);if(void 0!==e)return e}return""}},147675:(e,t,i)=>{"use strict";i.d(t,{DELAY_WITHOUT_AGREEMENT:()=>d,firstReplacedByBatsExchange:()=>u,getExchange:()=>f,isDelay:()=>p,isDelayForGuest:()=>S,isDelayWithoutMarketAgreement:()=>v,isEod:()=>_,isTickByTick:()=>g,witoutRealtime:()=>m});var s=i(650151),r=i(59171),o=i.n(r),n=i(833813),a=i(778016),l=i(519073);const c=["DJ","JSE","BELEX"],h=["NZX"],d=["ICESG","TURQUOISE","TAIFEX"];function u(e){const t=o().getExchanges(e.pro_name),i=o().getExchanges(e.full_name);for(let e=0;e<i.length;++e)if("BATS"===i[e].toUpperCase())return t[e];return null}function _(e,t){return o().hasEodSymbols(e.full_name)||6===t}function p(e){return void 0!==e&&e>0}function m(e){return"index"===e.type&&c.includes(e.listed_exchange)||"futures"===e.type&&h.includes(e.listed_exchange)}function g(e,t){return!((0,a.enabled)(n.ProductFeatures.TICK_BY_TICK_PUSH_DATA)||p(e.delay)||_(e,t)||(0,l.hasCryptoTypespec)(e.typespecs||[]))}function S(e,t){return t.listed_exchange===e&&!window.is_authenticated}function v(e){return d.includes(e.listed_exchange)}async function f(e){{const t=(0,s.ensureDefined)(window.pro);await new Promise((e=>{t.runOrUpdate(e)}));const i=t.getProduct(function(e){return`exchange-${e.pro_perm}`}(e)),r=function(e){let t;if(!window.pro)throw new Error("Pro module not defined");t=window.pro.getProductsByType(window.pro.PRODUCT_TYPES.exchange).find((t=>{var i;return Boolean(null===(i=t.included_exchanges)||void 0===i?void 0:i.includes(e))}));return t||null}(i.exchange||"");return r&&["cme-full","us-stocks"].includes(r.exchange)?i:r||i}}},380271:(e,t,i)=>{"use strict";i.d(t,{actionMap:()=>z,classNameMap:()=>E,countdownFnMap:()=>W,iconMap:()=>A,marketStatusDescription:()=>N,titleColorMap:()=>R,titleMap:()=>B,tooltipMap:()=>D});var s=i(987088),r=i(444372),o=i(553218),n=i(732140),a=i(262998),l=i(725230),c=i(315507),h=i(643401),d=i(85290),u=i(212462),_=i(364123)
;const p=r.t(null,void 0,i(383949)),m=r.t(null,void 0,i(356042)),g=r.t(null,void 0,i(429985)),S=r.t(null,void 0,i(895814)),v=r.t(null,void 0,i(988958)),f=r.t(null,void 0,i(269419)),b=r.t(null,void 0,i(801653)),y=r.t(null,void 0,i(540519)),C=r.t(null,void 0,i(957048)),w=r.t(null,void 0,i(987202)),P=r.t(null,void 0,i(539348)),T=r.t(null,void 0,i(107827)),M=r.t(null,void 0,i(19830)),x=r.t(null,void 0,i(735701)),I=r.t(null,void 0,i(298105)),L=r.t(null,void 0,i(950634)),k=r.t(null,void 0,i(574537)),A=new Map([["market",new Map([["small",n],["medium",a],["large",a]])],["pre_market",new Map([["small",d],["medium",u],["large",u]])],["post_market",new Map([["small",c],["medium",h],["large",h]])],["out_of_session",new Map([["small",o],["medium",o],["large",o]])],["holiday",new Map([["small",l],["medium",l],["large",l]])]]),E=new Map([["market",_.marketStatusOpen],["pre_market",_.marketStatusPre],["post_market",_.marketStatusPost],["out_of_session",_.marketStatusClose],["holiday",_.marketStatusHoliday]]),D=new Map([["market",p],["pre_market",m],["post_market",g],["out_of_session",S],["holiday",v]]),B=new Map([["market",p],["pre_market",m],["post_market",g],["out_of_session",S],["holiday",v]]),R=new Map([["market",s.colorsPalette["color-market-open"]],["pre_market",s.colorsPalette["color-pre-market"]],["post_market",s.colorsPalette["color-post-market"]],["out_of_session",s.colorsPalette["color-market-closed"]],["holiday",s.colorsPalette["color-market-holiday"]]]),N={market:f,pre_market:b,post_market:y,out_of_session:C,holiday:w};function V(e){return r.t(null,{plural:"{number} minutes",count:e},i(467151)).format({number:e.toString()})}function O(e){return r.t(null,{plural:"{number} hours",count:e},i(224430)).format({number:e.toString()})}function F(e){const t=Math.floor(e/86400),s=Math.floor((e-86400*t)/3600),o=Math.floor((e-86400*t-3600*s)/60);return 0===t&&0===s&&0===o?P:t>0?T.format({days:(n=t,r.t(null,{plural:"{number} days",count:n},i(458609)).format({number:n.toString()})),hours:O(s)}):s>0?M.format({hours:O(s),minutes:V(o)}):V(o);var n}const W={market:e=>("post_market"===e.status?L:I).format({remainingTime:F(e.remainingSeconds)}),pre_market:e=>x.format({remainingTime:F(e.remainingSeconds)}),post_market:e=>I.format({remainingTime:F(e.remainingSeconds)}),out_of_session:e=>("pre_market"===e.status?k:x).format({remainingTime:F(e.remainingSeconds)}),holiday:e=>("pre_market"===e.status?k:x).format({remainingTime:F(e.remainingSeconds)})},z=new Map([["market",null],["pre_market",null],["post_market",null],["out_of_session",null],["holiday",null]])},394905:(e,t,i)=>{"use strict";i.d(t,{ToastsFactory:()=>s});class s{constructor(e,t){this._chartToastsPromise=null,this._resizerBridge=e,this._bottomToolbarOffsetHeightProvider=t}async getChartToasts(){return null!==this._chartToastsPromise||(this._chartToastsPromise=async function(){
return Promise.all([Promise.all([i.e(56400),i.e(98899),i.e(4241),i.e(50690),i.e(53088)]).then(i.bind(i,814284)),Promise.all([i.e(98899),i.e(3630),i.e(50690),i.e(13830),i.e(94291)]).then(i.bind(i,13830))]).then((e=>[e[0].ChartToasts,e[1].globalToasts]))}().then((e=>{const t=e[0],i=e[1];return new t(this._resizerBridge,this._resizerBridge.container.value(),i,this._bottomToolbarOffsetHeightProvider())}))),this._chartToastsPromise}}},406849:(e,t,i)=>{"use strict";i.d(t,{createTradeContext:()=>r});var s=i(650151);async function r(e,t){let i=NaN,r=NaN,o="";const n=e.proSymbol(),a=(e.symbolInfo()||{name:null}).name||n,l=e.priceScale();if(t){const s=e.firstValue();i=null!==s?l.coordinateToPrice(t,s):null,o=null!==i?e.formatter().format(i):""}const c=e.bars().last();null!==c&&(r=(0,s.ensure)(c.value[TradingView.CLOSE_PLOT]));return{symbol:n,displaySymbol:a,value:i,formattedValue:o,last:r,symbolInfoTradable:!!(e.symbolInfo()||{is_tradable:!1}).is_tradable}}},439016:(e,t,i)=>{"use strict";i.d(t,{tradingService:()=>o,waitTradingService:()=>n});var s=i(564894);const r={id:"TradingService"};function o(){return(0,s.hasService)(r)?(0,s.service)(r):null}function n(){return(0,s.waitServiceRegistered)(r)}},834075:(e,t,i)=>{"use strict";i.d(t,{isMobileTradingAvailable:()=>d});var s=i(638456),r=i(125226),o=i(314802),n=i(244842);const a=(0,r.isFeatureEnabled)("mobile_trading_ios")&&s.CheckMobile.iOS()&&(0,o.isOnMobileAppPage)("old"),l=(0,r.isFeatureEnabled)("mobile_trading_android")&&s.CheckMobile.Android()&&(0,o.isOnMobileAppPage)("new"),c=(0,r.isFeatureEnabled)("mobile_trading_web")&&s.CheckMobile.any()&&!s.CheckMobile.isIPad()&&(window.matchMedia("screen and (orientation: portrait) and (max-width: 567px)").matches||window.matchMedia("screen and (orientation: landscape) and (max-height: 567px)").matches)&&!(0,o.isOnMobileAppPage)("any"),h=n.enabled("mobile_trading")&&(a||l||c);function d(){return h}},514315:(e,t,i)=>{"use strict";i.d(t,{updateThemeActions:()=>_});var s=i(444372),r=i(461794),o=i(345848),n=i(158566),a=i(373571),l=i(167975),c=i(104436),h=i(67302);const d=["system","dark","light"],u={dark:s.t(null,void 0,i(40890)),light:s.t(null,void 0,i(950020)),system:s.t(null,void 0,i(980899))};async function _(e){const[t,_]=await Promise.all([i.e(83767).then(i.bind(i,429874)),i.e(83767).then(i.bind(i,867432))]),p=async p=>{let m=[];if((0,h.showThemeSwitcher)()){const i=t.getStdThemeNames(),s=t.getCurrentTheme().name;m=i.map((i=>{const a=new n.TVAction({name:"theme-switch-to-"+i,label:(0,r.clean)(t.translateStdThemeName(i)),checkable:!0,checked:s===i,onExecute:()=>{a.update({checked:!0}),t.loadTheme(e.chartWidgetCollection(),{themeName:i,standardTheme:!0}).then((()=>{e.readOnly()||window.saver.saveChartSilently(),(0,o.trackEvent)("GUI","Themes","Switch to "+i+" theme")}))}});return a})),m.sort(((e,t)=>e.getLabel()>t.getLabel()?-1:1))}else if((0,h.showThemeAction)()&&window.TVD&&window.TVD.getThemeSetting){const e=await window.TVD.getThemeSetting();e&&(m=d.map((t=>{const i=new n.TVAction({name:"theme-switch-to-"+t,label:u[t],checkable:!0,
checked:e===t,onExecute:()=>{i.update({checked:!0}),window.TVD&&window.TVD.setThemeSetting&&window.TVD.setThemeSetting(t)}});return i})))}const g=[...m];if(window.is_authenticated){g.length&&g.push(new a.Separator);const t=new n.TVAction({name:"theme-save-as",label:(0,l.appendEllipsis)(s.t(null,void 0,i(309908))),onExecute:()=>_.showThemeSaveDialogAsync(e.model().model().theme())});g.push(t)}p&&p.length&&window.is_authenticated&&(g.length&&g.push(new a.Separator),p.forEach((i=>{const s=new n.TVAction({label:(0,r.clean)(t.translateStdThemeName(i)),checkable:!1,onExecute:()=>{t.loadTheme(e.chartWidgetCollection(),{themeName:i,standardTheme:!1}).then((()=>{window.saver.saveChartSilently(),(0,o.trackEvent)("GUI","Switch to custom theme")}))},toolbox:{type:c.ToolboxType.Delete,action:()=>_.showRemoveThemeDialogAsync(i)},showToolboxOnHover:!0});g.push(s)}))),e.actions().applyColorTheme.update({subItems:g})};window.is_authenticated?t.getThemeNames().then(p):p()}},56998:(e,t,i)=>{"use strict";i.d(t,{WatchlistWithSubmenuAction:()=>f});var s=i(444372),r=i(167975),o=i(470316),n=i(833813),a=i(552279),l=i(373571),c=i(158566),h=i(650151),d=i(845437),u=i(167222);function _(e,t){return{...t,actionId:"Chart.AddSymbolToWatchList",icon:d,statName:"AddToWatchlist",hotkeyHash:o.Modifiers.Alt+87,onExecute:()=>{(0,u.runOrSigninWithFeature)((()=>{var t;if(window.widgetbar){const i=null===(t=(0,h.ensureNotNull)(window.widgetbar.setPage("base")).widget("watchlist"))||void 0===t?void 0:t.widgetObject;if(!i)return;i.addSymbols([e.symbolWV().value()])}}),{feature:"watchList",source:"add symbol to watchlist"})}}}var p=i(306388),m=i(826939),g=i(72368),S=i(440498),v=i(244842);class f extends c.TVAction{constructor(e,t){super({..._(e,t),subItems:[new c.TVLoader]}),this._controller=new AbortController,this._hadSymbolOnInit=!1,this._isMobile=(0,g.isMobile)(),this._onRequest=null,this._chart=e,this._load()}updateLabel(e){this.update({label:s.t(null,void 0,i(655980)).format({symbol:e})})}request(){var e;this._hadSymbolOnInit=!1,this._isMobile=(0,g.isMobile)(),this.update({subItems:[new c.TVLoader]}),null===(e=this._onRequest)||void 0===e||e.call(this)}destroy(){super.destroy(),this._controller.abort(),this._chart=null,this._onRequest=null,this._options={actionId:"TVActionId"}}async _load(){const[e,t,h,u,_,g,f]=await Promise.all([Promise.resolve().then(i.t.bind(i,50959,19)),(0,
p.initSymbolListService)(),Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(88194),i.e(30006),i.e(26855),i.e(43610),i.e(96899),i.e(50690),i.e(26300),i.e(29594),i.e(10758),i.e(21065),i.e(745),i.e(37457),i.e(55404),i.e(87092),i.e(29772),i.e(4157),i.e(1867),i.e(1026)]).then(i.bind(i,38506)),Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(34465),i.e(69121),i.e(66639),i.e(88194),i.e(30006),i.e(26855),i.e(43610),i.e(96899),i.e(50690),i.e(26300),i.e(29594),i.e(10758),i.e(21065),i.e(745),i.e(37457),i.e(55404),i.e(87092),i.e(29772),i.e(4157),i.e(1867),i.e(1026)]).then(i.bind(i,244692)),Promise.all([i.e(78529),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(93502),i.e(36884),i.e(46036),i.e(88548),i.e(36747),i.e(26855),i.e(58056),i.e(21625),i.e(91033),i.e(54712),i.e(49205),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(67080),i.e(56388),i.e(9227),i.e(98149),i.e(8740),i.e(15518),i.e(58289),i.e(12494),i.e(52251),i.e(35542),i.e(56949),i.e(59185),i.e(51494),i.e(60682),i.e(21770),i.e(1793),i.e(37462),i.e(40153),i.e(61094),i.e(50690),i.e(30979),i.e(26300),i.e(29594),i.e(57413),i.e(58510),i.e(9240),i.e(37457),i.e(37070),i.e(87092),i.e(42767),i.e(4157),i.e(16926),i.e(91196)]).then(i.bind(i,15814)),Promise.all([i.e(78529),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(93502),i.e(36884),i.e(46036),i.e(88548),i.e(36747),i.e(26855),i.e(58056),i.e(21625),i.e(91033),i.e(54712),i.e(49205),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(67080),i.e(56388),i.e(9227),i.e(98149),i.e(8740),i.e(15518),i.e(58289),i.e(12494),i.e(52251),i.e(35542),i.e(56949),i.e(59185),i.e(51494),i.e(60682),i.e(21770),i.e(1793),i.e(37462),i.e(40153),i.e(61094),i.e(50690),i.e(30979),i.e(26300),i.e(29594),i.e(57413),i.e(58510),i.e(9240),i.e(37457),i.e(37070),i.e(87092),i.e(42767),i.e(4157),i.e(16926),i.e(91196)]).then(i.bind(i,436779)),Promise.all([i.e(78529),i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(66639),i.e(35649),i.e(88194),i.e(89842),i.e(30006),i.e(93502),i.e(36884),i.e(46036),i.e(88548),i.e(36747),i.e(26855),i.e(58056),i.e(21625),i.e(91033),i.e(54712),i.e(49205),i.e(99916),i.e(43610),i.e(36956),i.e(96899),i.e(67080),i.e(56388),i.e(9227),i.e(98149),i.e(8740),i.e(15518),i.e(58289),i.e(12494),i.e(52251),i.e(35542),i.e(56949),i.e(59185),i.e(51494),i.e(60682),i.e(21770),i.e(1793),i.e(37462),i.e(40153),i.e(61094),i.e(50690),i.e(30979),i.e(26300),i.e(29594),i.e(57413),i.e(58510),i.e(9240),i.e(37457),i.e(37070),i.e(87092),i.e(42767),i.e(4157),i.e(16926),i.e(91196)]).then(i.bind(i,631530))]);if(this._controller.signal.aborted)return;const{store:b}=t;this._onRequest=()=>b.dispatch(h.getCustomWatchlistsThunk(null));const y=b.subscribe((()=>{if(!this._chart)return;const t=b.getState()
;if(null===_.getCustomListsState(t).timestamp)return;const h=this._chart.symbolWV().value(),p=_.getCustomLists(t),{activeSymbolList:y}=t,C=p.find((e=>e.id===y));this._hadSymbolOnInit||(this._hadSymbolOnInit=!!C&&C.symbols.includes(h));const w=v.enabled("multiple_watchlists")?p.filter((e=>e.id!==y)).sort(g.sortComparator):[];let P=C?[C,...w]:w;P=P.filter((e=>!(0,S.isDeletedSymbolsList)(e.id)));const T=P.map((t=>{const i=t.symbols.includes(h);return new c.TVAction({jsxLabel:e.createElement(f.ContextMenuWatchlistItem,{title:t.name,isChecked:i,isSmallSize:this._isMobile}),shortcutHint:t.id===y?(0,o.humanReadableHash)(o.Modifiers.Alt+87):void 0,invisibleHotkey:t.id===y?i:void 0,doNotCloseOnClick:!0,onExecute:()=>{const e=i?u.removeSymbolsThunk(m.WATCHLIST_WIDGET_ID,h,t.id,!0):u.addSymbolsToCustomListThunk(m.WATCHLIST_WIDGET_ID,t.id,[h]);t.id!==y||window.is_authenticated||this._hadSymbolOnInit?b.dispatch(e):window.runOrSignIn((()=>{b.dispatch(e)}),{source:"Chart context menu"})}})})),M=new c.TVAction({label:(0,r.appendEllipsis)(s.t(null,void 0,i(732340))),icon:this._isMobile?d:void 0,onExecute:()=>{(0,a.runOrGoPro)((()=>{b.dispatch(u.userCreateWatchlistThunk(null,{symbols:[h]}))}),n.ProductFeatures.MULTIPLE_WATCHLISTS,{feature:"multipleWatchLists",featureLocation:"moveSymbolsToNew"})}});this.update({subItems:[...T,new l.Separator,M]})}));this._controller.signal.addEventListener("abort",(()=>y()),{once:!0})}}},360758:(e,t,i)=>{"use strict";i.d(t,{addPlusButtonProperty:()=>u,restoreAddPlusButtonSettingsValue:()=>_,showPlusButtonOnCursor:()=>h});var s=i(799786),r=(i(244842),i(62802)),o=i(152633),n=i(401580);const a="add_plus_button";function l(){const e=s.keyboardPressedKeysState.value();return void 0!==e&&(Boolean(e.modifiers&s.Modifiers.Alt&&e.modifiers&s.Modifiers.Mod)&&(void 0===e.code||e.altOrOptionCode()||e.controlOrMetaCode()))}const c=new n.WatchedValue(l());s.keyboardPressedKeysState.subscribe((()=>c.setValue(l())));const h=c.readonly();function d(){return r.getBool(a,!0)}const u=(0,o.createPrimitiveProperty)(d());function _(){u.setValue(!0),r.remove(a)}r.onSync.subscribe(null,(()=>u.setValue(d()))),u.subscribe(null,(()=>{r.setValue(a,u.value())}))},939243:(e,t,i)=>{"use strict";i.d(t,{getAlertColorLineByTheme:()=>C,getSettingsProperty:()=>b,restoreSettingsProperty:()=>y});var s=i(650151),r=i(822914),o=i(316230),n=i(712433),a=i(987088),l=i(62802),c=i(61499),h=i(354950),d=i.n(h),u=i(738232),_=i(42292);const p="alertLabels";let m;const g={visible:!0,line:{color:"",visible:!0}},S=new Map([[c.StdTheme.Light,{line:{color:(0,a.getHexColorByName)("color-cold-gray-900")}}],[c.StdTheme.Dark,{line:{color:(0,a.getHexColorByName)("color-cold-gray-200")}}]]);function v(){let e=(0,l.getJSON)(p,null);if(null===e){const t=(0,_.defaults)("chartproperties");t&&t.alertsProperties&&t.alertsProperties.labels&&(e=t.alertsProperties.labels)}null===e&&(e=(0,r.default)(g));const t=(0,u.extractAllPropertiesKeys)(g),i=(0,u.extractAllPropertiesKeys)(e);if(!(0,o.default)(t,i)){const i=(0,u.extractState)(e,t);e=(0,n.default)((0,r.default)(g),i)}
return e}function f(){m&&(0,l.setJSON)(p,m.state())}function b(){return m||(m=new(d())(v()),m.listeners().subscribe(null,f),l.onSync.subscribe(null,(()=>{m.mergeAndFire(v())})),m)}function y(){m&&m.mergeAndFire(g)}function C(e){const t=e.dark().value()?c.StdTheme.Dark:c.StdTheme.Light;return(0,s.ensureDefined)(S.get(t)).line.color}},91849:(e,t,i)=>{"use strict";i.d(t,{ALERT_LABEL_WIDTH:()=>G,AlertLabel:()=>K,isAlertLabel:()=>q});var s,r=i(650151),o=i(987088),n=i(996986),a=i(888929),l=i(354950),c=i.n(l),h=i(742391),d=i(223699),u=i(444331),_=i(345848),p=i(939243),m=i(86441),g=i(142119),S=i(315801),v=i(230058),f=i(458963),b=i(787123),y=i(239589),C=i(43192);!function(e){e[e.ConnectorOffsetFromIcon=28]="ConnectorOffsetFromIcon",e[e.ConnectorCircleRadius=4]="ConnectorCircleRadius",e[e.IconBackgroundRadius=3]="IconBackgroundRadius",e[e.IconWidth=21]="IconWidth",e[e.IconHeight=17]="IconHeight"}(s||(s={}));class w extends C.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e,t){const i=(0,y.interactionTolerance)().line;for(let s=0;s<this._data.levels.length;s++){const r=this._data.levels[s],[o,n]=this._calculateLeftRight(this._data,r,t.cssWidth,1),a=Math.min(o,n),l=Math.max(o,n);if(Math.abs(r.y-e.y)<=i&&e.x>=a&&e.x<=l)return new S.HitTestResult(S.HitTarget.MovePoint,{activeItem:s,hideCrosshairLinesOnHover:!0,areaName:S.AreaName.Line})}const r=this._data.levels.map((e=>e.y)),o=Math.min(...r),n=Math.max(...r),a=this._data.isLeft?Math.round(s.ConnectorOffsetFromIcon+s.IconWidth):Math.round(t.cssWidth-(s.ConnectorOffsetFromIcon+s.IconWidth));if(Math.abs(a-e.x)<i&&e.y>=o&&e.y<=n){const t=r.reduce(((t,i,s)=>{const r=Math.abs(t.level-e.y);return Math.abs(i-e.y)<r?{index:s,level:i}:t}),{index:0,level:r[0]});return new S.HitTestResult(S.HitTarget.MovePoint,{activeItem:t.index,hideCrosshairLinesOnHover:!0,areaName:S.AreaName.Line})}return null}_drawImpl(e){const t=e.context;if(t.lineWidth=Math.max(1,Math.floor(e.verticalPixelRatio)),t.strokeStyle=this._data.color,(0,b.setLineStyle)(t,f.LINESTYLE_DASHED),this._data.levels.forEach((i=>{const s=Math.round(i.y*e.verticalPixelRatio),[r,o]=this._calculateLeftRight(this._data,i,e.bitmapSize.width,e.horizontalPixelRatio);(0,b.drawHorizontalLine)(t,s,r,o)})),this._data.levels.length>1){const i=this._data.isLeft?Math.round((s.ConnectorOffsetFromIcon+s.IconWidth)*e.horizontalPixelRatio)+.5:Math.round(e.bitmapSize.width-(s.ConnectorOffsetFromIcon+s.IconWidth)*e.horizontalPixelRatio)+.5,r=this._data.levels.map((e=>e.y)),o=Math.min(...r),n=Math.max(...r);t.beginPath(),t.moveTo(i,o*e.verticalPixelRatio),t.lineTo(i,n*e.verticalPixelRatio),t.stroke();const a=Math.round(s.ConnectorCircleRadius*e.horizontalPixelRatio);(0,b.setLineStyle)(t,f.LINESTYLE_SOLID),t.fillStyle=this._data.connectorsBackColor,[o,n].forEach((s=>{const r=Math.round(s*e.verticalPixelRatio);t.beginPath(),t.arc(i,r,a,0,2*Math.PI,!0),t.fill(),t.stroke()}))}}_calculateLeftRight(e,t,i,r){const o=1===e.levels.length?0:Math.floor(s.ConnectorCircleRadius*r);let n,a;return this._data.isLeft?(a=0,
n="full"===t.mode?i:"toConnector"===t.mode?Math.round((s.ConnectorOffsetFromIcon+s.IconWidth-o)*r):Math.round(this._data.distanceToTooltip*r)):(n="full"===t.mode?0:"toConnector"===t.mode?Math.round(i-(s.ConnectorOffsetFromIcon+s.IconWidth-o)*r):Math.round(i-this._data.distanceToTooltip*r),a=i),[n,a]}}var P=i(934026),T=i(444372),M=i(455105),x=i(167975),I=i(674981),L=i(199471),k=i(422333),A=i(511131),E=i(294162);const D=(0,A.makeFont)(13,k.CHART_FONT_FAMILY);class B extends C.BitmapCoordinatesPaneRenderer{constructor(){super(),this._data=null,this._lastPaintTextWidth=null,this._lastPaintPaneWidth=null,this._widthCache=new E.TextWidthCache}setData(e){this._data=e}hitTest(e){const t=this._data;if(null===this._lastPaintTextWidth||!t||null===this._lastPaintPaneWidth)return null;const s=this._lastPaintTextWidth+16+26,r=this._calculatePoint(t,s,this._lastPaintPaneWidth);{const o=new m.Point(r.x-26+s,r.y-9.5),n=o.add(new m.Point(26,19));if((0,P.pointInBox)(e,(0,m.box)(o,n))){const e=()=>{t.alertId&&M.ActionCreators.deleteAlerts([t.alertId],T.t(null,void 0,i(734596)),{confirmation:{text:T.t(null,void 0,i(524183)).format({alertTitle:t.text}),title:T.t(null,void 0,i(588511))}}).execute()};return new S.HitTestResult(S.HitTarget.Custom,{activeItem:t.lineIndex,hideCrosshairLinesOnHover:!0,areaName:S.AreaName.Button,clickHandler:e,tapHandler:e})}}{const i=new m.Point(r.x,r.y-9.5),o=i.add(new m.Point(s,19));if((0,P.pointInBox)(e,(0,m.box)(i,o)))return new S.HitTestResult(S.HitTarget.MovePoint,{activeItem:t.lineIndex,hideCrosshairLinesOnHover:!0,areaName:S.AreaName.Tooltip})}return null}_drawImpl(e){const t=this._data;if(!t)return;const i=e.context;this._lastPaintPaneWidth=e.mediaSize.width,i.font=D,this._lastPaintTextWidth=this._widthCache.measureText(i,t.text);const s=this._lastPaintTextWidth+16+26,r=Math.max(20,.9*(e.mediaSize.width-80)),o=Math.min(s,r),n=Math.round(19*e.verticalPixelRatio);let a=t.text;if(o<s){a=function(e,t,i){const s=(0,I.lowerboundExt)((t=>e.substring(0,t)),t,((t,s)=>i(t===e?e:(0,x.appendEllipsis)(t))<s),0,e.length);return s===e.length?e:(0,x.appendEllipsis)(e.substring(0,s))}(a,o-16-26,(e=>this._widthCache.measureText(i,e)))}const l=Math.round(o*e.horizontalPixelRatio),c=this._calculatePoint(t,o,this._lastPaintPaneWidth);this._drawBorderAround(t,e,c,l,n,(e=>e.fill())),this._drawButton(t,e,c,l,n),this._drawText(t,e,c,l,a),this._drawBorderAround(t,e,c,l,n,(e=>e.stroke()))}_drawButton(e,t,i,s,r){const o=t.context;i=i.add(new m.Point(s/t.horizontalPixelRatio,0));{const s=Math.round((i.x-26)*t.horizontalPixelRatio)+.5,n=Math.round(i.y*t.verticalPixelRatio-.5*r)+.5;o.fillStyle=e.buttonBackColor,o.fillRect(s,n,26*t.horizontalPixelRatio,r),o.strokeStyle=e.buttonBorderColor,o.lineWidth=Math.max(1,Math.floor(t.verticalPixelRatio)),o.beginPath(),o.moveTo(s,n),o.lineTo(s,n+r),o.stroke()}o.strokeStyle=e.lineColor,o.beginPath();const n=Math.round((i.x-13-4+.5)*t.horizontalPixelRatio),a=Math.round((i.y-4+.5)*t.verticalPixelRatio),l=Math.round(8*t.horizontalPixelRatio),c=Math.round(8*t.verticalPixelRatio);o.moveTo(n,a),
o.lineTo(n+l,a+c),o.moveTo(n,a+c),o.lineTo(n+l,a),o.stroke()}_drawText(e,t,i,s,r){const o=t.context,n=Math.round((i.x+8)*t.horizontalPixelRatio),a=Math.round((i.y+5)*t.verticalPixelRatio);o.save(),o.translate(n,a),(0,L.drawScaled)(o,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{o.fillStyle=e.lineColor,o.fillText(r,0,0)})),o.restore()}_drawBorderAround(e,t,i,s,r,o){const n=t.context,a=Math.round(i.x*t.horizontalPixelRatio)+.5,l=Math.round(i.y*t.verticalPixelRatio-r/2)+.5;n.strokeStyle=e.lineColor,n.lineWidth=Math.max(1,Math.floor(t.verticalPixelRatio));const c=Math.round(4*t.horizontalPixelRatio);n.fillStyle=e.backColor,n.beginPath(),(0,b.drawRoundRect)(n,a,l,s,r,c),o(n)}_calculatePoint(e,t,i){const s=e.point;if(e.center){const r=Math.max(0,.5*(i-t));return e.isLeft?r<s.x?s:new m.Point(r,s.y):r+t<s.x?new m.Point(r,s.y):new m.Point(s.x-t,s.y)}return e.isLeft?s:s.subtract(new m.Point(t,0))}}var R;!function(e){e[e.SelectionPointOffset=35]="SelectionPointOffset",e[e.HeightRegular=10]="HeightRegular",e[e.NoLineModeOffsetSingleLine=47]="NoLineModeOffsetSingleLine",e[e.NoLineModeOffsetMultipleLines=62]="NoLineModeOffsetMultipleLines"}(R||(R={}));class N{constructor(e,t){this._invalidated=!0,this._compositeRenderer=new g.CompositeRenderer,this._tooltipRenderer=new B,this._alertLabel=e,this._model=t}update(){this._invalidated=!0}invalidate(){this._model.lightUpdate()}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._compositeRenderer}_updateImpl(){var e,t;this._compositeRenderer.clear();const i=this._alertLabel,s=i.alert(),o=s.condition();if(null===o)return;const n=(0,r.ensureNotNull)(this._model.paneForSource(i)),a=(0,r.ensureNotNull)(n.mainDataSource()).firstValue();if(null===a||!i.canDrawLabelForAlert())return;const l=(0,r.ensureNotNull)(i.priceScale()),c=e=>l.priceToCoordinate(e,a),h=[];if("channel"===o.type){const e=c(o.upper),t=c(o.lower);h.push(e),h.push(t)}else h.push(c(o.price));const d=s.isNew(),u=i.isSelected(),_=i.isHovered(),p=this._model.lastHittestData(),g=this._model.lastSelectedHittestData();let f=0;_&&(f=null!==(e=null==p?void 0:p.activeItem)&&void 0!==e?e:0),u&&(f=null!==(t=null==g?void 0:g.activeItem)&&void 0!==t?t:0);const b=this._alertLabel.colors(),y=d?b.newAlertColor:b.lineColor,C=h.map(((e,t)=>({y:e,mode:i.drawHorzLine()?"full":t===f&&1===h.length?"toTooltip":"toConnector"}))),P=n.leftPriceScales().includes(l),T=1===h.length?R.NoLineModeOffsetSingleLine:R.NoLineModeOffsetMultipleLines,M={distanceToTooltip:T,levels:C,color:y,connectorsBackColor:b.connectorBackColor,iconBackgroundWithCorners:u||_,iconColor:b.iconColor,isLeft:P};if((i.drawHorzLine()||u||_)&&this._compositeRenderer.append(new w(M)),u){const e=n.height(),t=h.map((t=>this._model.backgroundColorAtYPercentFromTop(t/e))),i=P?R.SelectionPointOffset:n.width()-R.SelectionPointOffset,s={points:h.map((e=>new m.Point(i,e))),hittestResult:S.HitTarget.MovePoint,bgColors:t,visible:!0,barSpacing:this._model.timeScale().barSpacing()};this._compositeRenderer.append(new v.SelectionRenderer(s))}
if((u||_)&&!this._alertLabel.isMoving()){const e=_&&(null==p?void 0:p.areaName)===S.AreaName.Button,t=P?T:n.width()-T,r={isLeft:P,point:new m.Point(t,h[f]),lineIndex:f,center:i.drawHorzLine(),text:s.name()||(s.isBeingEdited().value()||i.isMoving()?s.defaultDescription():s.description()),lineColor:y,backColor:b.connectorBackColor,buttonBorderColor:b.tooltipButtonBorderColor,buttonBackColor:e?b.tooltipButtonBorderColorHovered:b.connectorBackColor,alertId:this._alertLabel.alert().id().value()};this._tooltipRenderer.setData(r),this._compositeRenderer.append(this._tooltipRenderer)}}}var V=i(246733),O=i(229765),F=i(601183);const W=new Path2D("M6.21 5.27 1.68 1.06A1 1 0 0 0 0 1.79v8.42a1 1 0 0 0 1.68.73l4.53-4.2a1 1 0 0 0 0-1.47Z");class z{constructor(){this._data=null,this._commonData=null,this._bodyBox=null}setData(e,t){this._data=e,this._commonData=t}lastDrawnBodyBox(){return this._bodyBox}draw(e,t,i,s,r,o,n){var a;const l=this._data,c=this._commonData;if(!l||!c)return;e.save(),e.fillStyle=null!==(a=l.backgroung)&&void 0!==a?a:c.background;const h="right"===o?s*n:0;e.translate(h,Math.round((c.coordinate-6.5+1)*n)),(0,L.drawScaled)(e,"right"===o?-n:n,n,(()=>{e.fill(W)})),e.restore();const d="right"===o?s-7:0;this._bodyBox=(0,m.box)((0,m.point)(d,c.coordinate-6.5),(0,m.point)(d+7,c.coordinate+6.5))}topBottomTotalHeight(e){return{top:0,bottom:0,total:0}}hitTest(e,t,i){return this._data?(0,F.hittestByData)(this._data,e):null}}class H extends O.PriceAxisView{constructor(e,t){super(),this._collapsedAxisRenderer=new z,this._lastDrawnAxisBox=null,this._alertLabel=e,this._levelIndex=t,this._collapsedAxisRenderer.setData(this._axisRendererData,this._commonRendererData)}renderer(){return this._updateRendererDataIfNeeded(),this._rendererImpl()}ignoreAlignment(){return!0}_updateRendererData(e,t,i){var s,r,o;e.visible=!1;const n=this._alertLabel.priceScale();if(!n)return;const a=n.mainSource(),l=null!==a?a.firstValue():null;if(n.isEmpty()||null===l)return;const c=this._alertLabel.priceOfLevel(this._levelIndex);if(null===c)return;const h=this._alertLabel.colors();i.background=(0,V.resetTransparency)(this._alertLabel.alert().isNew()?h.newAlertColor:h.lineColor),i.textColor=h.iconColor,i.coordinate=n.priceToCoordinate(c,l),e.text=n.formatPrice(c,l);const d=null!==(o=null===(r=(s=this._rendererImpl()).lastDrawnBodyBox)||void 0===r?void 0:r.call(s))&&void 0!==o?o:this._lastDrawnAxisBox;this._lastDrawnAxisBox=null!=d?d:this._lastDrawnAxisBox,this._lastDrawnAxisBox&&(e.hitTestData={hoverModelFromAxis:!0,itemBox:this._lastDrawnAxisBox,activeItem:this._levelIndex}),e.hitTarget=S.HitTarget.Regular,e.visible=!0}_rendererImpl(){return this._alertLabel.isHovered()||this._alertLabel.isSelected()?this._axisRenderer:this._collapsedAxisRenderer}}const U=a.sortSourcesPreOrdered.AlertLabel,G=5;function q(e){return e instanceof K}const j={newAlertColor:(0,o.getHexColorByName)("color-cold-gray-450"),connectorBackColor:(0,o.getHexColorByName)("color-cold-gray-900"),iconColor:(0,o.getHexColorByName)("color-cold-gray-900"),tooltipButtonBorderColor:(0,
o.getHexColorByName)("color-cold-gray-800"),tooltipButtonBorderColorHovered:(0,o.getHexColorByName)("color-cold-gray-800")},Y={newAlertColor:(0,o.getHexColorByName)("color-cold-gray-550"),connectorBackColor:(0,o.getHexColorByName)("color-white"),iconColor:(0,o.getHexColorByName)("color-white"),tooltipButtonBorderColor:(0,o.getHexColorByName)("color-cold-gray-100"),tooltipButtonBorderColorHovered:(0,o.getHexColorByName)("color-cold-gray-100")};class K extends n.DataSource{constructor(e,t,i,s){super(),this._priceAxisViews=[],this._paneLabelsPaneViews=[],this._propertyMock=new(c()),this._startMovingPoint=null,this._currentMovingPoint=null,this._resetUserEditEnabled=()=>{const e=this._alert;this._userEditEnabled=!(e.isBeingEdited().value()||e.isNew()||!e.isPrice()||null===e.condition())},this._onAlertSelectedChanged=e=>{this.canDrawLabelForAlert()&&(e?this._selectAlertLabel():this._unselectAlertLabel())},this._propertyMock.addProperty("visible",!0),this._model=e,this._alert=t,this._alertOwnerSource=i,this._paneView=new N(this,e),this._invokeAlertEditor=s,this._resetUserEditEnabled(),this.hasAlert.setValue(!0),this._alertSeriesId=(0,r.ensureNotNull)(t.seriesState()).id,t.id().subscribe(this._resetUserEditEnabled),t.extraUpdated().subscribe(this,this._resetUserEditEnabled),t.extraUpdated().subscribe(this,(()=>e.lightUpdate())),t.isBeingEdited().subscribe(this._resetUserEditEnabled),t.selected().subscribe(this._onAlertSelectedChanged),t.selected().value()&&this.canDrawLabelForAlert()&&this._selectAlertLabel(),(0,p.getSettingsProperty)().listeners().subscribe(this,(()=>{e.updateSource(this)}))}destroy(){(0,p.getSettingsProperty)().listeners().unsubscribeAll(this)}model(){return this._model}zorder(){return U}colors(){return{...this._model.dark().value()?j:Y,lineColor:this.labelLineColor()}}alertOwnerSource(){return this._alertOwnerSource}alertSeriesId(){return this._alertSeriesId}alignCrossHairToMovePoint(){return!0}name(){return"AlertLabel"}isSpeciallyZOrderedSource(){return!0}stop(){this._alert.id().unsubscribe(this._resetUserEditEnabled),this._alert.extraUpdated().unsubscribeAll(this),this._alert.isBeingEdited().unsubscribe(this._resetUserEditEnabled),this._alert.selected().unsubscribe(this._onAlertSelectedChanged)}alert(){return this._alert}isMoving(){return null!==this._startMovingPoint}isHovered(){return this===this._model.hoveredSource()}isSelected(){return this._model.selection().isSelected(this)}alertId(){return this.alert().id().value()}getAlert(){return Promise.resolve(this._alert)}getAlertSync(){return this._alert}movable(){return!0}priceOfLevel(e){const t=this.alert().condition();return t?"channel"===t.type?[t.upper,t.lower][e]:t.price:null}convertYCoordinateToPriceForMoving(e,t){const i=this.priceScale();if(!t||!i||i.isEmpty())return null;const s=t.firstValue();return null===s?null:i.coordinateToPrice(e,s)}isSynchronizable(){return!1}state(){const e=this.alert().condition(),t=[];return null!==e&&("channel"===e.type?(t.push({price:e.upper}),t.push({price:e.lower})):t.push({price:e.price})),{id:this._id,
type:"AlertLabel",zorder:this.zorder(),points:t}}restorePoints(e){"channel"===(0,r.ensureNotNull)(this.alert().condition()).type?this.alert().setCondition({type:"channel",upper:e[0].price,lower:e[1].price}):this.alert().setCondition({type:"price",price:e[0].price})}createServerPoints(){}properties(){return this._propertyMock}paneViews(){return window.TradingView.printing?null:this.labelVisible()?[this._paneView,...this.canDrawLabelForAlert()?this._paneLabelsPaneViews:[]]:null}dataWindowView(){return null}priceAxisViews(e,t){return this.canDrawLabelForAlert()&&this.priceScale()===t?this._priceAxisViews:[]}updateAllViews(e){this._paneView.update();const t=this._targetPriceAxisViewsCount();for(let e=this._priceAxisViews.length;e<t;e++){const t=new H(this,e);this._priceAxisViews.push(t),this._paneLabelsPaneViews.push(new h.PanePriceAxisView(t,this,this._model))}this._priceAxisViews=this._priceAxisViews.slice(0,t),this._paneLabelsPaneViews=this._paneLabelsPaneViews.slice(0,t),this._priceAxisViews.forEach((t=>t.update(e))),this._paneLabelsPaneViews.forEach((t=>t.update(e)))}pointsCount(){return 0}title(){return this.alert().title()}startMoving(e,t,i,s){this._userEditEnabled=!1,this._startMovingPoint=e,this.alert().saveState()}move(e,t,i,s){if(!e.logical||null===t)return;const o=e.logical.price,n=this.alert(),a=(0,r.ensureNotNull)(n.condition());if(this._currentMovingPoint={...e},"channel"===a.type){let{upper:e,lower:i}=a;const s=this._alertOwnerSource.base()||100;0===t?(0,r.ensureDefined)(this._currentMovingPoint.logical).price=e=Math.max(o,i+1/s):1===t&&((0,r.ensureDefined)(this._currentMovingPoint.logical).price=i=Math.min(o,e-1/s)),n.setCondition({...a,lower:i,upper:e})}else n.setCondition({type:"price",price:o})}endMoving(){const e=this._startMovingPoint,t=this._currentMovingPoint;if(this._userEditEnabled=!0,this._startMovingPoint=null,this._currentMovingPoint=null,!e||!t||e===t)return;(0,_.trackEvent)("chart_alert","edit","move"),this._invokeAlertEditor({dataSourceHub:this._model,alert:this.alert(),type:"edit_alert",onEditCancel:()=>{setTimeout((()=>{this.alert().restoreState(),this._model.lightUpdate()}),0)},silent:!0,actionSource:"alert_label_move"})}currentMovingPoint(){return this._currentMovingPoint}showInObjectTree(){return!1}isRemovedByStudyTemplates(){return!1}isUserDeletable(){return!1}doesMovingAffectsUndo(){return!1}drawHorzLine(){return this.labelLineVisible()}canDrawLabelForAlert(){const e=this.alert(),t=e.mainSeriesState(),i=t&&t.style,s=this._model.mainSeries(),r=s&&s.properties().childs(),o=r&&r.style&&r.style.value(),n=d.Interval.isEqual(e.resolution(),s.interval())||e.crossInterval(),a=!e.isRangeBasedStyle()&&!(0,u.isRangeBasedStyle)(s.style())||i===o;return e.isPrice()&&n&&a}labelVisible(){const e=this._alertOwnerSource.symbolSource();return(!e||!e.isConvertedToOtherCurrency()&&!e.isConvertedToOtherUnit())&&(!this._model.isInReplay()&&(0,p.getSettingsProperty)().childs().visible.value())}labelLineColor(){const e=(0,p.getSettingsProperty)().childs().line.childs().color.value();return e||(0,
p.getAlertColorLineByTheme)(this.model())}labelLineVisible(){return(0,p.getSettingsProperty)().childs().line.childs().visible.value()}_selectAlertLabel(){this._model.selectionMacro((e=>{e.selection().isSelected(this)||(e.clearSelection(),e.addSourceToSelection(this))}))}_unselectAlertLabel(){this._model.selectionMacro((e=>{e.selection().isSelected(this)&&e.removeSourceFromSelection(this)}))}_targetPriceAxisViewsCount(){const e=this.alert().condition();return e?"channel"===e.type?2:1:0}}},108039:(e,t,i)=>{"use strict";i.d(t,{AppliedTimeFrame:()=>r});var s=i(938550);class r{constructor(e){this._appliedTimeFrame=new s.WatchedObject(null),this._appliedTimeFrameInfo=null,this._appliedTimeFrameChangedBound=this._appliedTimeFrameChanged.bind(this),this._model=e,e.mainSeries().dataEvents().seriesTimeFrame().subscribe(this,this._onSeriesTimeFrame),this._appliedTimeFrame.subscribe(this._appliedTimeFrameChangedBound)}destroy(){this._appliedTimeFrame.unsubscribe(this._appliedTimeFrameChangedBound),this._model.timeScale().logicalRangeChanged().unsubscribeAll(this),this._model.mainSeries().dataEvents().seriesTimeFrame().unsubscribeAll(this)}appliedTimeFrame(){return this._appliedTimeFrame}_appliedTimeFrameChanged(){this._model.timeScale().logicalRangeChanged().unsubscribe(this,this._invalidateAppliedTimeFrame)}_onSeriesTimeFrame(e,t,i,s){if(s){const e=this._model.timeScale();this._appliedTimeFrameInfo={logicalRange:e.logicalRange(),baseIndex:e.baseIndex()},e.logicalRangeChanged().subscribe(this,this._invalidateAppliedTimeFrame)}}_invalidateAppliedTimeFrame(){if(null===this._appliedTimeFrameInfo)return;const e=this._model.timeScale(),t=e.logicalRange(),i=e.baseIndex(),s=this._appliedTimeFrameInfo.logicalRange,r=this._appliedTimeFrameInfo.baseIndex;(null===t||null===s||Math.abs(i-t.left()-(r-s.left()))>=.01||Math.abs(i-t.right()-(r-s.right()))>=.01)&&this._appliedTimeFrame.setValue(null)}}},679356:(e,t,i)=>{"use strict";i.d(t,{defaultsPreferencesByWhiteList:()=>I,preferencesByWhiteList:()=>x});var s=i(389137),r=i(507795),o=i(488530),n=i(201089),a=i(909598),l=i(42292),c=i(530239),h=i(329806),d=i(792795),u=i(987088);const _={visible:!1,lineStyle:i(458963).LINESTYLE_DOTTED,lineWidth:1,bidLineColor:u.colorsPalette["color-tv-blue-500"],askLineColor:u.colorsPalette["color-ripe-red-400"]};var p=i(993171);const m=(0,n.getLogger)("Chart.ApplyPreferencesToAllCharts"),g={color:"",style:0},S={autoScale:!1,autoScaleDisabled:!1,lockScale:!1,percentage:!1,percentageDisabled:!1,log:!1,logDisabled:!1,alignLabels:!1,isInverted:!1,indexedTo100:!1},v={backgroundType:d.ColorType.Solid,background:"",backgroundGradientStartColor:"",backgroundGradientEndColor:"",topMargin:0,bottomMargin:0,rightOffset:0,gridLinesMode:"both",horzGridProperties:(0,h.deepExtend)({},g),vertGridProperties:(0,h.deepExtend)({},g),crossHairProperties:(0,h.deepExtend)({},{color:"",style:0,transparency:0,width:0}),legendProperties:(0,h.deepExtend)({},{showStudyArguments:!1,showStudyTitles:!1,showStudyValues:!1,showSeriesTitle:!1,showSeriesOHLC:!1,showLegend:!1,showBarChange:!0,
showVolume:!1,showPriceSource:!1,showBackground:!0,backgroundTransparency:0,showLogo:!0}),axisProperties:(0,h.deepExtend)({},S),separatorColor:""},f={lineColor:"",textColor:"",fontSize:0,scaleSeriesOnly:!1,showSeriesLastValue:!1,seriesLastValueMode:a.PriceAxisLastValueMode.LastValueAccordingToScale,showSeriesPrevCloseValue:!1,showStudyLastValue:!1,showSymbolLabels:!1,showStudyPlotLabels:!1,showBidAskLabels:!1,showPrePostMarketPriceLabel:!0,showFundamentalLastValue:!1,showFundamentalNameLabel:!1,showPriceScaleCrosshairLabel:!0,showTimeScaleCrosshairLabel:!0},b={...f},y={visible:!1,futureOnly:!1,breaks:(0,h.deepExtend)({},{color:"",visible:!1,style:0,width:0})},C={style:0,minTick:"",showPriceLine:!1,priceLineWidth:0,priceLineColor:"",baseLineColor:"",showPrevClosePriceLine:!1,showCountdown:!0,prevClosePriceLineWidth:0,sessionId:"regular",prevClosePriceLineColor:"",esdShowDividends:!1,esdShowSplits:!1,esdShowEarnings:!1,esdShowBreaks:!1,showContinuousContractSwitches:!1,showContinuousContractSwitchesBreaks:!1,showFuturesContractExpiration:!1,showLastNews:!1,dividendsAdjustment:!1,backAdjustment:!1,settlementAsClose:!0,statusViewStyle:(0,h.deepExtend)({},{fontSize:16,showExchange:!0,showInterval:!0,symbolTextSource:"description"}),priceAxisProperties:(0,h.deepExtend)({},S),bidAsk:(0,h.deepExtend)({},_),prePostMarket:(0,h.deepExtend)({},p.defaultPrePostMarketPreferences),highLowAvgPrice:(0,h.deepExtend)({},{highLowPriceLinesVisible:!1,highLowPriceLabelsVisible:!1,averageClosePriceLabelVisible:!1,averageClosePriceLineVisible:!1,highLowPriceLinesColor:"",highLowPriceLinesWidth:0,averagePriceLineColor:"",averagePriceLineWidth:0}),candleStyle:(0,h.deepExtend)({},o.candleStylePreferencesDefault),hollowCandleStyle:(0,h.deepExtend)({},o.hollowCandlePreferencesStyleDefault),barStyle:(0,h.deepExtend)({},o.barStylePreferencesDefault),lineStyle:(0,h.deepExtend)({},o.lineStyleDefault),lineWithMarkersStyle:(0,h.deepExtend)({},o.lineStyleDefault),steplineStyle:(0,h.deepExtend)({},o.lineStyleDefault),areaStyle:(0,h.deepExtend)({},o.areaStylePreferencesDefault),hlcAreaStyle:(0,h.deepExtend)({},o.hlcAreaStylePreferencesDefault),baselineStyle:(0,h.deepExtend)({},o.baselineStylePreferencesDefault),hiloStyle:(0,h.deepExtend)({},o.hiloStylePreferencesDefault),haStyle:(0,h.deepExtend)({},o.haStylePreferencesDefault),renkoStyle:(0,h.deepExtend)({},o.renkoStylePreferencesDefault),pbStyle:(0,h.deepExtend)({},o.pbStylePreferencesDefault),kagiStyle:(0,h.deepExtend)({},o.kagiStylePreferencesDefault),pnfStyle:(0,h.deepExtend)({},o.pnfStylePreferencesDefault),rangeStyle:(0,h.deepExtend)({},o.rangeStylePreferencesDefault),columnStyle:(0,h.deepExtend)({},o.columnStylePreferencesDefault)},w={priceScaleSelectionStrategyName:"auto",timeScale:(0,h.deepExtend)({},{defaultRightOffset:0,defaultRightOffsetPercentage:5,usePercentageRightOffset:!1}),mainSeries:(0,h.deepExtend)({},C),sessions:(0,h.deepExtend)({},c.sessionsPreferencesDefault),paneProperties:(0,h.deepExtend)({},v),chartEventsSourceProperties:(0,h.deepExtend)({},y),tradingProperties:(0,
h.deepExtend)({},r.tradingPreferencesDefault)},P={timezone:"",scalesProperties:(0,h.deepExtend)({},b),...w},T={scalesProperties:(0,h.deepExtend)({},f),...w};function M(e,t,i,r,o=!0){if(void 0===t[e])return m.logDebug(`We haven't had this property ${r}.${e} yet, please, remove it from whiteList`),null;if((0,s.isObject)(i[e])){const s=Object.keys(i[e]);let n="";return s.map((s=>({[s]:M(s,t[e],i[e],`${r}.${e}`,o)}))).reduce(((e,t)=>(n=Object.keys(t)[0],e[n]=t[n],e)),{})}return o?t[e].value():t[e]}function x(e,t,i=P){const s={timezone:"",priceScaleSelectionStrategyName:"auto",timeScale:{defaultRightOffset:e.timeScale().defaultRightOffset().value(),defaultRightOffsetPercentage:e.timeScale().defaultRightOffsetPercentage().value(),usePercentageRightOffset:e.timeScale().usePercentageRightOffset().value()},mainSeries:{},sessions:{},paneProperties:{},scalesProperties:{},chartEventsSourceProperties:{},tradingProperties:{}},r=["timeScale","mainSeries","sessions"],o=i.mainSeries,n=Object.keys(i),a=Object.keys(o),l=t.properties(),c=e.properties(),h=i.sessions,d=Object.keys(h),u=e.sessions().properties();return a.forEach((e=>{s.mainSeries[e]=M(e,l,o,"mainSeries")})),d.forEach((e=>{s.sessions[e]=M(e,u,h,"sessions")})),n.forEach((e=>{r.includes(e)||(s[e]=M(e,c,i,"preferences"))})),s}function I(e,t,i=T,s=!0){const r={timeScale:{defaultRightOffset:e.timeScale().rightOffsetDefaultValue(),defaultRightOffsetPercentage:e.timeScale().defaultRightOffsetPercentage().value(),usePercentageRightOffset:e.timeScale().usePercentageRightOffset().value()},mainSeries:{},sessions:(0,h.deepExtend)({},c.sessionsPreferencesDefault),paneProperties:{},scalesProperties:{},chartEventsSourceProperties:{},tradingProperties:{},priceScaleSelectionStrategyName:"auto"},o=["timeScale","mainSeries","sessions"],n=i.mainSeries,a=Object.keys(i),d=Object.keys(n),u=(0,l.factoryDefaults)("chartproperties.mainSeriesProperties"),_=(0,l.factoryDefaults)("chartproperties");return d.forEach((e=>{s&&"style"===e||(r.mainSeries[e]=M(e,u,n,"mainSeries",!1))})),a.forEach((e=>{o.includes(e)||(r[e]=M(e,_,i,"preferences",!1))})),r}},480059:(e,t,i)=>{"use strict";i.d(t,{autoLogButtonsVisibilityOptions:()=>o,autoLogButtonsVisibilityProperty:()=>r,restoreAutoLogButtonsVisibilitySettingsValue:()=>n});var s=i(87053);const{property:r,availableValues:o,restoreDefaultValue:n}=(0,s.createVisibilityController)("PriceAxisAutoLogButtons.visibility")},736029:(e,t,i)=>{"use strict";i.d(t,{extrapolateBarsFrontByCount:()=>o,extrapolateBarsFrontToTime:()=>r});var s=i(987571);function r(e,t,i,s,o=!1){if(t>i){const n=r(e,i,t,s,o);return n.count=-n.count,n}return n(e,t,1,((e,t)=>t>i||0!==s&&e>s),o)}function o(e,t,i,s=!1){const r=i<0?-1:1;return n(e,t,r,((e,t)=>e>=i*r),s)}function n(e,t,i,r,o){let n=0,a=t;e.moveTo(a);let l=0,c=Number.MAX_VALUE,h=!1,d=t;const u=[];for(;!r(n,a);){if(l>15)throw new Error("Internal error 0x10 while extrapolating.");const r=e.indexOfBar(a);if(r===s.SessionStage.PRE_SESSION&&1===i)a=e.startOfBar(0),
e.moveTo(a);else if(r===s.SessionStage.PRE_SESSION&&-1===i)a=e.startOfBar(s.SessionStage.PRE_SESSION),e.moveTo(a);else if(r===s.SessionStage.POST_SESSION&&1===i)a=e.startOfBar(s.SessionStage.POST_SESSION),e.moveTo(a);else{if(r===s.SessionStage.POST_SESSION&&-1===i)throw new Error("Internal error 0x12 while extrapolating.");{const _=e.startOfBar(r);if(_>t&&i>0||t>_&&i<0){if(h&&c===_)throw new Error("Internal error 0x11 while extrapolating.");h=!0,c=_,l=0,n++,d=_,o&&u.push(d)}if(0===r&&-1===i)a=_-1;else{a=e.startOfBar(r+i);const t=e.startOfBar(s.SessionStage.POST_SESSION);a>t&&(e.moveTo(t),a=e.startOfBar(0))}}}l++}return{time:d,times:u,count:n}}},838042:(e,t,i)=>{"use strict";i.d(t,{BarsMarksContainer:()=>m});var s=i(650151),r=i(201089),o=i(62802),n=i.n(o),a=i(244842),l=i(223699),c=i(389137),h=i(444331),d=i(996986),u=i(964824);const _=(0,r.getLogger)("Chart.BarsMarksContainer"),p=Math.round(new Date(2037,0,1).getTime()/1e3);class m extends d.DataSource{constructor(e,t,i){const r=e.onWidget();let o;o=r?!e.hideIdeas():!!a.enabled("bars_marks")&&n().getBool("BarsMarksContainer.visibile",!1),t.merge({visible:o}),t.childs().visible.subscribe(null,(t=>{r||e.isSnapshot()||!a.enabled("bars_marks")||n().setValue("BarsMarksContainer.visibile",!!t.value())})),super(i),this._paneViews=[],this._model=e,this._properties=t,this._requests=[],this._marks={},this._loadedRange=null,this._getDataTimeout=null,this._collectedRange=null,this._lastRange=null;const l=this._model.mainSeries();l.onSymbolIntervalChanged().subscribe(this,this.clearMarks),l.dataEvents().symbolResolved().subscribe(this,this.clearMarks),l.dataEvents().completed().subscribe(this,(()=>{var e,t;const i=l.data();if(0===i.size())return;const r=(0,s.ensureNotNull)(i.first()).index,o=(0,s.ensureNotNull)(i.last()).index,n=this.timeScale();this.getData({start:null!==(e=n.indexToTimePoint(r))&&void 0!==e?e:1/0,end:null!==(t=n.indexToTimePoint(o))&&void 0!==t?t:-1/0})})),this._initialize(),this._pinnedTooltips={}}destroy(){const e=this._model.mainSeries();e.onSymbolIntervalChanged().unsubscribeAll(this),e.dataEvents().symbolResolved().unsubscribeAll(this),e.dataEvents().completed().unsubscribeAll(this)}properties(){return this._properties}marks(){return this._marks}pinTooltip(e,t){this._pinnedTooltips[e]=t}timeScale(){return this._model.timeScale()}getIntervalInTicks(){const e=this._model.mainSeries().properties().childs().interval.value(),t=l.Interval.parse(e);if(!t.isValid())throw new TypeError("Unexpected interval");return t.isRange()?60:t.inMilliseconds()/1e3}getVisibleTickMarksRange(){var e,t;if(this.timeScale().isEmpty())return{start:0,end:0};const i=(0,s.ensureNotNull)(this.timeScale().visibleBarsStrictRange()),{firstIndex:r,lastIndex:o}=(0,s.ensureNotNull)(this.timeScale().points().range().value());if(!(i.lastBar()>r&&i.firstBar()<o))return{start:0,end:0};let n;n=i.lastBar()<o?this.timeScale().indexToTimePoint(i.lastBar()):p;const a={start:this.timeScale().indexToTimePoint(Math.max(i.firstBar(),r)),end:n};return{start:null!==(e=a.start)&&void 0!==e?e:1/0,
end:null!==(t=a.end)&&void 0!==t?t:-1/0}}getVisibleRangePlates(){const e=[],t=this.getVisibleTickMarksRange(),i=this.getIntervalInTicks();return Object.keys(this._marks).forEach((s=>{var r,o;const n=this._marks[s],a=n.tickmark;a>=(null!==(r=t.start)&&void 0!==r?r:1/0)&&a<=(null!==(o=t.end)&&void 0!==o?o:-1/0)+i&&e.push(n)})),e}getPublishedPlates(){const e={};return window.is_authenticated?(this.getVisibleRangePlates().forEach((t=>{t.is_public&&(this._pinnedTooltips[t.id]||t.user__id===window.user.id)&&(e[t.id]=t)})),e):e}filterDisplayedPlates(e){const t=e.reduce(((e,t)=>{const i=this._getIndex(t.tickmark);return null!==i&&(e[i]=e[i]||[],e[i].push(t)),e}),{});return Object.keys(t).reduce(((e,i)=>{let s=t[i];return s=s.sort(((e,t)=>t.views_count-e.views_count)),s=s.slice(0,10),e.concat(s)}),[])}getPlatesViewData(){var e,t,i;const r=this._model.mainSeries();if(r.data().isEmpty())return[];const o=(0,h.isPriceSourceStyle)(r.style())?r.barFunction():null,n=this.filterDisplayedPlates(this.getVisibleRangePlates()),a={},l=null!==(e=this._model.lastHittestData())&&void 0!==e?e:this._model.lastSelectedHittestData();let c=null;null!==l&&this._model.hoveredSource()===this&&(c=null!==(t=l.activeItem)&&void 0!==t?t:null);const d=[];for(const e of n){const t=(0,s.ensureNotNull)(this._getIndex(e.tickmark)),i=this._getBar(t);if(null===i)continue;const r=this._layout(e.direction),n=this._theme(e.direction),l=c===e.id,h=this.timeScale().indexToCoordinate(t),u=this._offset(r,i,o),_=(0,s.ensureNotNull)(this.priceScale()).isInverted();let p=0;t in a||(a[t]={up:0,down:0}),p=a[t][r]++,d.push({id:e.id,x:h,y:u,yInverted:_,order:p,direction:r,theme:n,hovered:l,pinned:!0===this._pinnedTooltips[e.id],user__id:e.user__id,label:e.label,labelFontColor:e.labelFontColor||"#444",minSize:e.minSize||5,...this._plateViewData(e)})}const u=d.filter((e=>!0===e.hovered));for(let e=0;e<n.length;e++)n[e].user__id===(null===(i=u[0])||void 0===i?void 0:i.user__id)&&(n[e].highlightByAuthor=!0);return d.sort(((e,t)=>e.hovered&&!t.hovered?1:0)),d}priceAxisViews(){return null}updateAllViews(e){for(const t of this._paneViews)t.update(e)}updateAllViewsAndRepaint(){this.updateAllViews((0,u.sourceChangeEvent)(this.id())),this._model.updateSource(this)}roundRange(e){return{start:Math.round(e.start),end:Math.round(e.end)}}refreshData(){null!==this._lastRange&&this.getData(this._lastRange)}getData(e){(0,c.isNumber)(e.start)&&(0,c.isNumber)(e.end)?(this._lastRange=e,e.end=p,this._pushGetDataStack(Object.assign({},e))):_.logError("Wrong range")}clearMarks(){this._abortAllRequests(),this._marks={},this._loadedRange=null}isUserDeletable(){return!1}isSavedInChart(e){return!1}isSpeciallyZOrderedSource(){return!0}showInObjectTree(){return!1}_plateViewData(e){return{}}_layout(e){switch(e){default:case 0:case 2:case 3:case 4:case 5:case 6:return"up";case 1:return"down"}}_theme(e){switch(e){default:case 0:return"neutral";case 1:case 5:return"green";case 2:case 6:return"red";case 3:return"yellow";case 4:return"blue"}}_offset(e,t,i){let r;switch(e){default:case"up":r=null===i?t[2]:i(t)
;break;case"down":r=null===i?t[3]:i(t)}return(0,s.ensureNotNull)(this.priceScale()).priceToCoordinate(r,(0,s.ensureNotNull)((0,s.ensureNotNull)(this.ownerSource()).firstValue()))}_getIndex(e){return this.timeScale().timePointToIndex(e)}_getBar(e){return this._model.mainSeries().data().valueAt(e)}_rangeDifference(e){return e=Object.assign({start:1/0,end:-1/0},e),this._loadedRange&&(e.start<this._loadedRange.start?e.end=this._loadedRange.start:e.end>this._loadedRange.end&&(e.start=this._loadedRange.end)),e}_rangeUnion(e,t){return e=Object.assign({start:1/0,end:-1/0},e),t&&(e.start=Math.min(t.start,e.start),e.end=Math.max(t.end,e.end)),e}_pushGetDataStack(e){(0,c.isNumber)(e.start)&&(0,c.isNumber)(e.end)?(this._getDataTimeout&&clearTimeout(this._getDataTimeout),this._collectedRange=this._rangeUnion(e,this._collectedRange),this._getDataTimeout=setTimeout((()=>{this._getData(this._collectedRange),this._getDataTimeout=this._collectedRange=null}),300)):_.logError("Wrong tickmark range")}_abortAllRequests(){this._requests.forEach((e=>{e.cancel()})),this._requests=[],this._getDataTimeout&&clearTimeout(this._getDataTimeout),this._getDataTimeout=this._collectedRange=null}}},384874:(e,t,i)=>{"use strict";i.d(t,{BarsRange:()=>r});var s=i(650151);class r{constructor(e,t){(0,s.assert)(e<=t,"The last bar in the bars range should be greater than or equal to the first bar"),this._firstBar=e,this._lastBar=t}firstBar(){return this._firstBar}lastBar(){return this._lastBar}count(){return this._lastBar-this._firstBar+1}contains(e){return this._firstBar<=e&&e<=this._lastBar}equals(e){return this._firstBar===e.firstBar()&&this._lastBar===e.lastBar()}static compare(e,t){return null===e||null===t?e===t:e.equals(t)}}},702236:(e,t,i)=>{"use strict";i.d(t,{ChartEventsSource:()=>U,supportedCurrenciesForChartEvents:()=>W});var s=i(650151),r=i(996986),o=i(888929),n=i(354950),a=i.n(n),l=i(627492),c=i(327714),h=i(86441),d=i(987088),u=i(849204),_=i(752604),p=i(199471),m=i(458963),g=i(315801),S=i(142119),v=i(758363),f=i(992543),b=i(714688),y=i(464539),C=i(934026),w=i(787123);class P{constructor(){this._data=null,this._hitTest=null}setData(e){this._data=e}setHitTest(e){this._hitTest=e}draw(e,t){const i=this._data;if(null===i)return;const s=i.centerPoint.x,r=i.centerPoint.y,o=i.diameter,n=o/2;e.fillStyle=i.backColor,(0,p.drawScaled)(e,t.pixelRatio,t.pixelRatio,(()=>{(0,w.createCircle)(e,s,r,n-1),e.fill(),e.drawImage(i.template,s-n,r-n,o,o)}))}hitTest(e,t){const i=this._data;return null!==i&&(0,C.pointInCircle)(e,new h.Point(i.centerPoint.x,i.centerPoint.y),i.diameter/2)?this._hitTest:null}}var T=i(988124),M=i(827023);const x=d.colorsPalette["color-banana-yellow-500"],I=d.colorsPalette["color-tan-orange-500"],L=d.colorsPalette["color-ripe-red-500"],k=(0,u.getLogoUrlResolver)();function A(e){const t=f.dateFormatProperty.value();return new b.DateTimeFormatter({dateFormat:t,timeFormat:(0,y.getHourMinuteFormat)(M.timeHoursFormatProperty.value()),dateTimeSeparator:"   "}).format(e)}class E{constructor(e,t,i){this._renderer=new S.CompositeRenderer,
this._invalidated=!1,this._templatesCache=null,this._clickedSource=null,this._series=e,this._source=t,this._showTooltipHandler=i}update(){this._invalidated=!0}renderer(e,t){return this._invalidated&&(this._updateImpl(e,t),this._invalidated=!1),this._renderer}processClickOutside(e){this.clearLastClicked()}clearLastClicked(){this._clickedSource=null}_updateImpl(e,t){this._createTemplates();const i=(0,s.ensureNotNull)(this._templatesCache);this._renderer.clear();const r=this._source.getAllGroups();if(null===r)return;const o=this._series.model().lastHittestData(),n=this._source.properties().childs().breaks,a=n.childs().visible.value();if(a)for(let t=0;t<r.length;t++){const i=r[t].groups.length,s=new v.VerticalLineRenderer;s.setData({color:n.childs().color.value(),linestyle:n.childs().style.value(),linewidth:n.childs().width.value(),x:r[t].x,top:0,bottom:e-2-22*i-3*(i-1)}),this._renderer.append(s)}const l=(0,c.size)({width:t,height:e}),d=this._chartEventBackgroundColor();let u,_;for(let t=r.length-1;t>=0;t--){const n=r[t];for(let c=n.groups.length-1;c>=0;c--){const p=n.groups[c],S=p.items[0].currency,f=p.maxImportance,b=new P;let y=!1;if(this._series.model().hoveredSource()===this._source&&null!==o){const e=o.activeItem;y=e.groupIndex===r[t].index&&e.itemIndex===c}const C=this._clickedSource&&this._clickedSource.groupIndex===n.index&&this._clickedSource.itemIndex===c;let w;w=y||C?i.hovered.get(S):f<-.5?i.low.get(S):f<.5?i.mid.get(S):i.hi.get(S);const T=new h.Point(n.x,e-2-22*(c+.5)-3*c),M={template:(0,s.ensureDefined)(w),centerPoint:T,diameter:22,backColor:d},x={activeItem:{groupIndex:n.index,itemIndex:c},hideCrosshairLinesOnHover:!0,clickHandler:this._chartEventMouseClickHandler.bind(this,n,c,T,l),tapHandler:this._chartEventMouseClickHandler.bind(this,n,c,T,l)};if(b.setData(M),b.setHitTest(new g.HitTestResult(g.HitTarget.Custom,x)),C){if(u=b,!a){_=new v.VerticalLineRenderer;const t=n.groups.length;_.setData({color:"#535353",linestyle:m.LINESTYLE_DASHED,linewidth:1,x:n.x,top:0,bottom:e-2-22*t-3*(t-1)})}}else this._renderer.append(b)}}_&&this._renderer.append(_),u&&this._renderer.append(u)}_chartEventBackgroundColor(){return this._series.model().dark().value()?d.colorsPalette["color-cold-gray-900"]:d.colorsPalette["color-white"]}_chartEventMouseClickHandler(e,t,i,s,r){if(null!==this._clickedSource&&this._clickedSource.groupIndex===e.index&&this._clickedSource.itemIndex===t)return void(this._clickedSource=null);this._clickedSource={groupIndex:e.index,itemIndex:t};const o={target:r.target,targetSize:s,point:new h.Point(i.x,i.y-11-10),marginTop:15};this._showTooltipHandler(o,(()=>{const i=e.groups[t].items.slice(),s=this._source.timezone();return i.sort(((e,t)=>{var i,s;const r=null!==(i=e.importance)&&void 0!==i?i:0;return(null!==(s=t.importance)&&void 0!==s?s:0)-r})).map((e=>this._createTooltipContentForItem(e,s)))}))}_createTooltipContentForItem(e,t){let i;const s=e.importance;return i=!Number.isFinite(s)||s<0?x:s<1?I:L,{type:"common",title:e.title,subTitle:A((0,T.utc_to_cal)(t,e.timestamp)),content:[{content:[{
name:"Actual",value:null!==e.actual?e.actual.toString():""},{name:"Forecast",value:null!==e.forecast?e.forecast.toString():""},{name:"Previous",value:null!==e.previous?e.previous.toString():""}]}],style:{color:i}}}_createTemplates(){if(!this._templatesCache){this._templatesCache={hi:new Map,hovered:new Map,low:new Map,mid:new Map};for(let e=0;e<W.length;e++){const t=W[e];this._createTemplateCircle(this._templatesCache.low,t,x),this._createTemplateCircle(this._templatesCache.mid,t,I),this._createTemplateCircle(this._templatesCache.hi,t,L),this._createTemplateCircle(this._templatesCache.hovered,t,d.colorsPalette["color-brand-hover"])}}}_createTemplateCircle(e,t,i){const s=(0,p.createDisconnectedCanvas)(document,(0,c.size)({width:44,height:44})),r=(0,p.getPrescaledContext2D)(s);e.set(t,s);const o=()=>{const i=new Image;i.onload=()=>{e.set(t,i)},i.src=s.toDataURL()},n=Math.floor(22),a=32,l=()=>{r.beginPath(),r.arc(n,n,20.5,0,2*Math.PI),r.closePath(),r.lineWidth=3,r.strokeStyle=i,r.stroke()},h=t.slice(0,2);if((0,_.isCountryCode)(h)){const e=new Image;e.onload=()=>{(e=>{e.width=a,e.height=a,r.drawImage(e,n-16,n-16,a,a),r.globalCompositeOperation="destination-in",r.beginPath(),r.arc(n,n,16,0,2*Math.PI),r.closePath(),r.fillStyle="white",r.fill(),r.globalCompositeOperation="source-over"})(e),l(),o(),this._source.invalidate()},e.crossOrigin="anonymous",e.src=k.getCountryFlagUrl(h,u.LogoSize.Medium)+"?resetCache=true"}else l(),o()}}var D=i(223699),B=i(44031),R=i(549621),N=i(444331),V=i(519073),O=i(964824),F=i(65455);const W=["EUR","USD","JPY","GBP","CHF","AUD","CAD","NZD","CNY"],z=o.sortSourcesPreOrdered.ChartEventsSource;function H(e,t,i){return i?e.getTime():(0,T.cal_to_utc)(t,e)}class U extends r.DataSource{constructor(e,t){if(super("ChartEventsSource"),this.toolname="ChartEventsSource",this._distribution=null,this._coordinates=null,this._timezone=(0,T.get_timezone)("invalid"),this._chartEvents=null,this._cachedTimescaleState=null,this._symbolName=null,this._sessionSpecCache=null,this._destroyed=!1,this._model=e,this._series=e.mainSeries(),this._rangeSpawn=this._model.timeScale().points().range().spawn(),t&&t.fixedData){this._distribution=t.fixedData,this._model.mainPane().updateLollipopViews((0,O.sourceChangeEvent)(this.id()));const e=this._model.properties().childs().chartEventsSourceProperties.state();e.visible=!0,this._properties=new(a())(e)}else this._chartEvents=new l.ChartEvents({minImportance:1},!0,!0),this._properties=this._model.properties().childs().chartEventsSourceProperties;this.setOwnerSource(this._series),this._paneView=new E(this._series,this,this._showTooltip.bind(this)),this._series.dataEvents().completed().subscribe(this,this._recalcDistribution),this._rangeSpawn.subscribe((()=>Promise.resolve().then((()=>this._recalcDistribution())))),this._series.dataEvents().symbolResolved().subscribe(this,this._updateTimezone),this._chartEvents&&this._chartEvents.changed.subscribe(this,(()=>{this._recalcDistribution(),this._model.updateSource(this)})),this._properties.subscribe(this,this._recalcDistribution),
this._model.properties().childs().timezone.subscribe(this,this._updateTimezone),this._updateTimezone(),this._destroyPropertyBinder=(0,F.bindProperties)(e.properties().childs().chartEventsSourceProperties.childs().visible,this._properties.childs().visible),this._recalcDistribution()}destroy(){this._destroyed=!0,this._series.dataEvents().completed().unsubscribeAll(this),this._series.dataEvents().symbolResolved().unsubscribeAll(this),this._model.properties().childs().timezone.unsubscribeAll(this),this._properties.unsubscribeAll(this),this._rangeSpawn.destroy(),this._destroyPropertyBinder()}name(){return"ChartEventsSource"}lollipopsAtIndex(e){if(null==this._distribution)return 0;const t=this._distribution[e];return void 0===t?0:t.length}getAllGroups(){return this._coordinates||this._recalcCoordinates(),this._coordinates}timezone(){return this._timezone}zorder(){return z}isSpeciallyZOrderedSource(){return!0}title(){return"Chart Events"}showInObjectTree(){return!1}onClickOutside(){this._paneView.processClickOutside()}properties(){return this._properties}updateAllViews(){const e=this._model.timeScale();if(!e)return;this._paneView.update();const t={width:e.width(),barSpacing:e.barSpacing(),logicalRange:e.logicalRange()};this._cachedTimescaleState&&this._cachedTimescaleState.width===t.width&&this._cachedTimescaleState.barSpacing===t.barSpacing&&R.LogicalRange.compare(this._cachedTimescaleState.logicalRange,t.logicalRange)||(this._cachedTimescaleState=t,this._coordinates=null)}paneViews(){return this.isVisible()?[this._paneView]:null}invalidate(){this._model.updateSource(this)}isUserDeletable(){return!1}isSavedInChart(e){return!!e}state(e){if(this._distribution||this._recalcDistribution(),!this._distribution)return null;const t={type:"ChartEventsSource",id:this.id(),state:null,zorder:this.zorder()};if(e){const e={},i=Object.keys(this._distribution).map(Number).filter(isFinite).sort(((e,t)=>t-e));let s=1/0,r=1/0;const o=this._model.timeScale().visibleBarsStrictRange();null!==o&&(s=o.firstBar(),r=o.lastBar());let n=0;for(let t=0;t<i.length&&!(n>300);t++){const o=i[t];if(o>r)continue;if(o<s)break;e[o]=[];const a=this._distribution[o];for(let t=0;t<a.length&&!(n>400);t++){e[o][t]=[];const i=a[t];for(let s=0;s<i.items.length&&!(n>400);s++)e[o][t][s]=i.items[s],n++}}t.state={distribution:e}}return t}static options(e){var t,i,s,r,o;const n=e&&e.state&&e.state.distribution;if(!n)return null;const a={};for(const e of Object.keys(n)){const l=e,c=n[l];a[l]=[];for(const e of Object.keys(c)){const n=c[e],h=n.reduce(((e,t)=>e.importance>t.importance?e:t)).importance;a[l].push({items:n,maxImportance:h});for(const e of n)e.actual=null!==(t=e.actual)&&void 0!==t?t:null,e.forecast=null!==(i=e.forecast)&&void 0!==i?i:null,e.previous=null!==(s=e.previous)&&void 0!==s?s:null,e.title=null!==(r=e.title)&&void 0!==r?r:"",e.importance=null!==(o=e.importance)&&void 0!==o?o:0}}return{fixedData:a}}_recalcDistribution(){if(this._destroyed)return;const e=this._series.symbolInfo();if(null===e)return;if(!this._chartEvents)return;if(this._coordinates=null,
this._distribution=null,this._model.mainPane().updateLollipopViews((0,O.sourceChangeEvent)(this.id())),!this._properties.childs().visible.value())return;if(!e||!e.name||e.name.length<6)return;if(!(0,N.symbolHasEconomicEvents)(e))return;const t=this._model.timeScale().tickMarks(),i=this._rangeSpawn.value();if(null===i)return;const r=this._series.data().bars(),o=r.firstIndex(),n=r.lastIndex();if(null===o||null===n)return;let a=null;const l=e.name;let c=0;for(let t=0;t<2;t++){let t;(0,V.hasCryptoTypespec)(e.typespecs||[])&&"DOGE"===l.substring(c,c+4).toUpperCase()?(t="DOGE",c+=4):(t=l.substring(c,c+3).toUpperCase(),c+=3),-1!==W.indexOf(t)&&(a||(a={}),a[t]=!0)}if(!a)return;const h=D.Interval.parse(this._series.interval());if(!h.isValid())return;let d=NaN;switch(h.kind()){case D.ResolutionKind.Weeks:d=168*h.multiplier();break;case D.ResolutionKind.Days:d=24*h.multiplier();break;case D.ResolutionKind.Minutes:d=h.multiplier()/60;break;case D.ResolutionKind.Seconds:d=h.multiplier()/3600;break;default:return}if(d>=672)return;this._symbolName!==l&&(this._chartEvents.reset({minImportance:1,currencyFilter:Object.keys(a)}),this._symbolName=l);const u=this._chartEvents.items(),_={};this._distribution=_;let p=Math.max(o,i.firstIndex);if(this._properties.childs().futureOnly.value()&&(p=Math.max(p,n)),!isFinite(p))return;const m=i.lastIndex,g=u.length;let S=0;const v=h.isDWM(),f=this._timezone,b=t.indexToTime(m);if(b){const e=H(b,f,v);for(;S<u.length&&!(u[S].timestamp<=e);S++);}const y=H((0,s.ensureNotNull)(t.indexToTime(p)),f,v),C=this._getSessionSpec(e);for(let e=m;e>=p;e--){const i=t.indexToTime(e);if(!i)continue;const s=H(i,f,v);for(;S<g;S++){const t=u[S];let i,r=t.timestamp;if(v){const e=(0,T.utc_to_cal)(f,r);C.correctTradingDay(e),(0,T.set_hms)(e,0,0,0,0),r=e.getTime()}if(t.timestamp<s)break;for(_[e]||(_[e]=[]),i=_[e].length;i--;){const s=_[e][i];if(s.items[0].currency===t.currency){s.items.push(t),t.importance>s.maxImportance&&(s.maxImportance=t.importance);break}}i<0&&_[e].push({items:[t],maxImportance:t.importance})}this._chartEvents.minObtainedTimestamp>y&&this._chartEvents.requestMore({from:y})}}_recalcCoordinates(){this._distribution||this._recalcDistribution(),this._coordinates=null;const e=this._distribution;if(!e)return;const t=this._model.timeScale(),i=t.visibleBarsStrictRange();if(null===i)return;const s=i.lastBar(),r=[];for(let o=i.firstBar();o<=s;o++){const i=e[o];i&&r.push({x:t.indexToCoordinate(o),groups:i,index:o})}this._coordinates=r.length>0?r:null}async _showTooltip(e,t){const r=this._model,o=r.timeScale(),n=[o.onScroll(),o.barSpacingChanged(),this._series.onSymbolIntervalChanged(),(0,s.ensureNotNull)(r.paneForSource(this)).onSizeChanged()],a=this._paneView.processClickOutside.bind(this._paneView),l=this._paneView.clearLastClicked.bind(this._paneView)
;(await Promise.all([i.e(18562),i.e(22666),i.e(5993),i.e(4015),i.e(92191),i.e(53842),i.e(35649),i.e(89842),i.e(72639),i.e(88548),i.e(36747),i.e(50293),i.e(48986),i.e(67103),i.e(13821),i.e(6744),i.e(57215),i.e(42244),i.e(94345),i.e(27620),i.e(58666),i.e(92991),i.e(34884),i.e(2807),i.e(63823),i.e(50690),i.e(59255),i.e(66590),i.e(85841),i.e(6386),i.e(49039)]).then(i.bind(i,722832))).showLollipopTooltip({items:t(),position:e,customCloseSubscriptions:n,onClickOutside:a,onCustomClose:l,showScrollFades:!0,cardType:"mini"})}_getSessionSpec(e){return null!==this._sessionSpecCache&&this._sessionSpecCache.session===e.session&&this._sessionSpecCache.timezone===e.timezone&&this._sessionSpecCache.holidays===e.session_holidays&&this._sessionSpecCache.corrections===e.corrections||(this._sessionSpecCache={sessionSpec:new B.SessionSpec(e.timezone,e.session,e.session_holidays,e.corrections),session:e.session,timezone:e.timezone,holidays:e.session_holidays,corrections:e.corrections}),this._sessionSpecCache.sessionSpec}_updateTimezone(){let e=this._model.timezone();if(!e||"exchange"===e){const t=this._series.symbolInfo();e=null!==t?t.timezone:"invalid"}this._timezone=(0,T.get_timezone)(e)}}window.TradingView.ChartEventsSource=U},553406:(e,t,i)=>{"use strict";i.d(t,{ChartModelBase:()=>Js});var s=i(12481),r=i(822914),o=i(650151),n=i(86441),a=i(724377),l=i(987088),c=i(444372),h=i(331633),d=i(429874),u=i(345848),_=i(268222),p=i(251954),m=i(49437),g=i(507795),S=i(913984),v=i(674981),f=i(91849),b=i(713473);function y(e){return(0,b.isLineTool)(e)&&e.boundToSymbol()||(0,f.isAlertLabel)(e)}class C{constructor(){this._items=[],this._set=new Set,this._dataSourcesCache=null,this._customSourcesCache=null,this._lineSourcesCache=null}isEmpty(){return 0===this._items.length}add(e){if(this._items.length>0&&!y(this._items[0])&&this.clear(),y(e)){const t=(0,v.lowerbound)(this._items,e,((e,t)=>e.zorder()<t.zorder()));this._items.splice(t,0,e)}else this.clear(),this._items=[e];this._set.add(e),this._invalidateCache()}canBeAddedToSelection(e){return 0===this._items.length||y(this._items[0])&&y(e)}isSelected(e){return this._set.has(e)}allSources(){return this._items.slice(0)}dataSources(){return null===this._dataSourcesCache&&(this._dataSourcesCache=this._items.filter(S.isDataSource)),this._dataSourcesCache}lineDataSources(){return null===this._lineSourcesCache&&(this._lineSourcesCache=this._items.filter(b.isLineTool)),this._lineSourcesCache}customSources(){return null===this._customSourcesCache&&(this._customSourcesCache=this._items.filter((e=>!(0,S.isDataSource)(e)))),this._customSourcesCache}checkLineToolSelection(){this._items.forEach((e=>(0,b.isLineTool)(e)&&e.calcIsActualSymbol())),this._items=this._items.filter((e=>!(0,b.isLineTool)(e)||e.isActualSymbol())),this._invalidateCache()}remove(e){this._items=this._items.filter((t=>t!==e)),this._set.delete(e),this._invalidateCache()}clear(){this._items=[],this._set.clear(),this._invalidateCache()}_invalidateCache(){this._customSourcesCache=null,this._dataSourcesCache=null,this._lineSourcesCache=null}}
var w=i(691639),P=i(860142),T=i(311862),M=i(223699),x=i(853965),I=i(354950),L=i.n(I),k=i(511131),A=i(422333);class E{constructor(e){this._rendererOptions={borderSize:1,additionalPaddingInner:0,fontSize:NaN,font:"",color:"",paneBackgroundColor:"",paddingBottom:0,paddingInner:0,paddingOuter:0,paddingTop:0,lineSpacing:0},this._chartModel=e}options(){const e=this._rendererOptions,t=this._chartModel.properties().childs(),i=t.scalesProperties.childs().fontSize.value();return e.fontSize!==i&&(e.fontSize=i,e.font=(0,k.makeFont)(i,A.CHART_FONT_FAMILY,""),e.paddingTop=i/12*2.5,e.paddingBottom=i/12*2.5,e.paddingInner=i/12*4,e.additionalPaddingInner=i/12*4,e.paddingOuter=i/12*4,e.lineSpacing=i/12*2),e.color=t.scalesProperties.childs().textColor.value(),e.paneBackgroundColor=t.paneProperties.childs().background.value(),this._rendererOptions}}var D=i(405721),B=i(582533),R=i(624444),N=i(42292),V=i(949529),O=i(244842),F=i(444331),W=i(530239),z=i(964824);const H=new R.PriceFormatter,U="sessions";class G extends V.CustomSourceBase{constructor(e,t,i){super(e,t),this._studySource=null,this._paneViews=[],this._metaInfo=null,this._destroyed=!1,this._isStarted=!1,this._loadedGraphics=null,this._doubleClickHandler=i;const s=t.mainSeries();this._properties=new x.DefaultProperty("sessions"),(0,N.applyDefaultsOverrides)(this._properties.childs().graphics,void 0,!1,U),this._removeDuplicateProperties(),this._properties.subscribe(this,this._onPropertiesChanged),t.studyMetaInfoRepository().findById({type:"java",studyId:"Sessions@tv-basicstudies"}).then((i=>{this._destroyed||null===this._loadedGraphics&&(this._setMetaInfo(i),null!==this._metaInfo&&(this._studySource=new D.StudyDataSource(t.chartApi(),s.seriesSource(),"sessions_",this._metaInfo),this._createPaneViews(),this._studySource.dataCleared().subscribe(this,this.updateAllViews.bind(this,(0,z.sourceChangeEvent)(e))),this._studySource.dataUpdated().subscribe(this,this.updateAllViews.bind(this,(0,z.sourceChangeEvent)(e))),this._studySource.setInputs({}),this._processHibernate()))})),t.timeScale().onReset().subscribe(this,this._clearData),t.timeScale().logicalRangeChanged().subscribe(this,this.updateAllViews.bind(this,(0,z.viewportChangeEvent)())),t.mainSeries().sessionIdProxyProperty().subscribe(this,this._updateVisibleOfPreAndPostMarketBackground),t.mainSeries().properties().childs().interval.subscribe(this,this._processHibernate),this._updateVisibleOfPreAndPostMarketBackground(t.mainSeries().properties().childs().sessionId)}applyOverrides(e){(0,N.applyPropertiesOverrides)(this._properties.childs().graphics,void 0,!1,e,U),this._model.updateSource(this)}start(){this._isStarted=!0,this._processHibernate()}restart(){this._clearData(),O.enabled("stop_study_on_restart")&&this.stop(),this.start()}isStarted(){return this._isStarted}stop(){this._isStarted=!1,null!==this._studySource&&this._studySource.stop()}isHoveredEnabled(){return!1}paneViews(e){return this._paneViews}updateAllViews(e){this._paneViews.forEach((t=>t.update(e)))}updateViewsForPane(e,t){this.updateAllViews(t)}destroy(){
this._destroyed=!0,null!==this._studySource&&(this._studySource.dataCleared().unsubscribeAll(this),this._studySource.dataUpdated().unsubscribeAll(this),this._studySource.destroy(),this._studySource=null),this._model.timeScale().logicalRangeChanged().unsubscribeAll(this),this._model.timeScale().onReset().unsubscribeAll(this),this._model.mainSeries().sessionIdProxyProperty().unsubscribeAll(this),this._model.mainSeries().properties().childs().interval.unsubscribeAll(this),this._properties.unsubscribeAll(this)}series(){return this._model.mainSeries()}priceScale(){return this.series().priceScale()}graphics(){return this._loadedGraphics||(0,o.ensureNotNull)(this._studySource).graphics()}valueAt(e,t){return null}properties(){return this._properties}graphicsInfo(){return(0,o.ensureNotNull)(this._metaInfo).graphics}firstValue(e){return this._model.mainSeries().firstValue()}formatter(){return H}state(e){const t={properties:this._properties.state()};return e&&null!==this._metaInfo&&(t.data={graphics:(0,B.saveStudyGraphics)(this.graphics(),this._model.timeScale().visibleBarsStrictRange()),metaInfo:this._metaInfo}),t}restoreState(e,t){const i=e.properties;this._migrateOutOfSessionProperty(i),this._properties.mergeAndFire(i),this._removeDuplicateProperties(),this._updateVisibleOfPreAndPostMarketBackground(this._model.mainSeries().properties().childs().sessionId),void 0!==e.data&&t&&(this._loadStudyGraphics(e.data.graphics),this._setMetaInfo(e.data.metaInfo),this._createPaneViews())}restoreOldState(e,t){const i={properties:{graphics:e.state.graphics}};void 0!==e.data&&void 0!==e.metaInfo&&t&&(i.data={metaInfo:e.metaInfo,graphics:e.data.graphics}),this.restoreState(i,t)}applyPreferences(e){this._properties.mergePreferences(e)}metaInfo(){return(0,o.ensureNotNull)(this._metaInfo)}_loadStudyGraphics(e){const t=e.backgrounds;if(void 0!==t){const e=t.findIndex((e=>"inSession"===e.styleId));-1!==e&&t.splice(e,1)}this._loadedGraphics=(0,B.loadStudyGraphics)(e)}_setMetaInfo(e){const t=e.graphics.backgrounds;void 0!==t&&void 0!==t.inSession&&delete t.inSession,this._metaInfo=e}_updateVisibleOfPreAndPostMarketBackground(e){const t=!(0,F.isRegularSessionId)(e.value());this._outOfSessionVisibilityProperty().setValue(t),this._preMarketVisibilityProperty().setValue(t),this._postMarketVisibilityProperty().setValue(t)}_clearData(){null!==this._studySource&&this._studySource.clearData()}_createPaneViews(){const e={doubleClickHandler:this._doubleClickHandler};(0,B.createGraphicsPaneViews)(this,this._model,e).then((e=>{this._paneViews=e,this._model.lightUpdate()}))}_onPropertiesChanged(){this._processHibernate(),this.updateAllViews((0,z.sourceChangeEvent)(this.id()))}_processHibernate(){if(null!==this._studySource){const e=this._canBeHibernated(),t=this._isHibernated(),i=this._studySource.isStarted();!t&&e&&i?this._studySource.stop():!t||e||i||this._studySource.start()}}_canBeHibernated(){
const e=this._model.mainSeries(),t=this._preMarketVisibilityProperty().value()&&this._postMarketVisibilityProperty().value()&&this._outOfSessionVisibilityProperty().value();return e.isDWM()||!t&&!this._vertLinesVisibleProperty().value()}_isHibernated(){return this._isStarted&&(null===this._studySource||!this._studySource.isStarted())}_outOfSessionVisibilityProperty(){return this._properties.childs().graphics.childs().backgrounds.childs().outOfSession.childs().visible}_preMarketVisibilityProperty(){return this._properties.childs().graphics.childs().backgrounds.childs().preMarket.childs().visible}_postMarketVisibilityProperty(){return this._properties.childs().graphics.childs().backgrounds.childs().postMarket.childs().visible}_vertLinesVisibleProperty(){return this._properties.childs().graphics.childs().vertlines.childs().sessBreaks.childs().visible}_removeDuplicateProperties(){this._properties.hasChild("properties")&&(this._properties.removeProperty("properties"),(0,x.saveDefaultProperties)(!0),this._properties.childChanged(null),(0,x.saveDefaultProperties)(!1))}_migrateOutOfSessionProperty(e){const t=e.graphics.backgrounds;if(void 0!==t){const i=t.outOfSession;i.color===(0,o.ensureDefined)(W.sessionsPreferencesDefault.graphics.backgrounds).outOfSession.color||"postMarket"in t||(e.graphics.backgrounds={...t,postMarket:{color:i.color,transparency:i.transparency,visible:i.visible},preMarket:{color:i.color,transparency:i.transparency,visible:i.visible}})}}}var q=i(161488),j=i(707957),Y=i(401580),K=i(938550),X=i(877009),$=i(261066),Z=i(480059),Q=i(201089),J=i(541558),ee=i(234271),te=i(944876),ie=i(526075),se=i(389137),re=i(623336),oe=i(900569),ne=i(459711),ae=i(924788),le=i(974655),ce=i(888929);const he=new Map([["price",e=>(0,le.isPriceDataSource)(e)],["trading",e=>(0,b.isTrading)(e)],["drawing",e=>(0,b.isLineTool)(e)&&!(0,b.isTrading)(e)&&!e.isPhantom()],["drawingsForAllSymbols",e=>(0,b.isLineTool)(e)&&!(0,b.isTrading)(e)&&!e.isPhantom()],["phantom",e=>(0,b.isLineTool)(e)&&e.isPhantom()],["restRowSources",e=>!(0,b.isLineTool)(e)&&!(0,b.isTrading)(e)],["legendViewSources",e=>(0,le.isPriceDataSource)(e)||(0,b.isStudyLineTool)(e)],["leftPriceScale",(e,t)=>"left"===ue(e,t)],["rightPriceScale",(e,t)=>"right"===ue(e,t)],["overlayPriceScale",(e,t)=>"overlay"===ue(e,t)]]),de=new Map([["price","visibleSorted"],["trading","visibleSorted"],["drawing","visibleSorted"],["drawingsForAllSymbols","allSorted"],["phantom","visibleSorted"],["restRowSources","visibleSorted"],["legendViewSources","visibleSorted"],["leftPriceScale","visibleSorted"],["rightPriceScale","visibleSorted"],["overlayPriceScale","visibleSorted"]]);function ue(e,t){const i=e.priceScale();return null===i?"overlay":t.priceScalePosition(i)}class _e{constructor(e){this._groupedSources=new Map,this._sources=null,this._pane=e}clear(){this._groupedSources.clear(),this._sources=null}destroy(){this.clear()}all(){return this._groupedSources.has("visibleSorted")||this._sortSources(),(0,o.ensureDefined)(this._groupedSources.get("visibleSorted"))}allIncludingHidden(){
return this._groupedSources.has("allSorted")||this._sortSources(),(0,o.ensureDefined)(this._groupedSources.get("allSorted"))}allExceptSpecialSources(){if(!this._groupedSources.has("exceptSpecial")){const e=this.allIncludingHidden().filter((e=>!e.isSpeciallyZOrderedSource()));this._groupedSources.set("exceptSpecial",e)}return(0,o.ensureDefined)(this._groupedSources.get("exceptSpecial"))}tradingSources(){return this._getSourcesByGroupType("trading")}priceSources(){return this._getSourcesByGroupType("price")}lineSources(){return this._getSourcesByGroupType("drawing")}lineSourcesForAllSymbols(){return this._getSourcesByGroupType("drawingsForAllSymbols")}phantomSources(){return this._getSourcesByGroupType("phantom")}allExceptLineAndTradingSources(){return this._getSourcesByGroupType("restRowSources")}hitTestSources(){if(!this._groupedSources.has("hitTest")){const e=this.allExceptLineAndTradingSources().concat(this.lineSources());this._groupedSources.set("hitTest",e)}return(0,o.ensureDefined)(this._groupedSources.get("hitTest"))}generalSources(){if(!this._groupedSources.has("general")){const e=this.allExceptLineAndTradingSources().concat(this.lineSources());this._groupedSources.set("general",(0,ce.sortSources)(e))}return(0,o.ensureDefined)(this._groupedSources.get("general"))}leftPriceScalesSources(){return this._getSourcesByGroupType("leftPriceScale")}rightPriceScalesSources(){return this._getSourcesByGroupType("rightPriceScale")}overlayPriceScaleSources(){return this._getSourcesByGroupType("overlayPriceScale")}legendViewSources(){return this._getSourcesByGroupType("legendViewSources")}_getSourcesByGroupType(e){const t=(0,o.ensureDefined)(de.get(e));return this._groupedSources.has(t)?this._groupedSources.has(e)||this._groupSources(e):(this._sortSources(),this._groupSources(e)),(0,o.ensureDefined)(this._groupedSources.get(e))}_sortSources(){null===this._sources&&(this._sources=this._pane.dataSources());const e=(0,ce.sortSources)(this._sources),t=e.filter((e=>!(0,b.isLineTool)(e)||e.isActualSymbol()&&e.isActualCurrency()&&e.isActualUnit()));this._groupedSources.set("allSorted",e),this._groupedSources.set("visibleSorted",t)}_groupSources(e){const t=(0,o.ensureDefined)(de.get(e)),i=he.get(e);if(void 0!==i){const s=(0,o.ensureDefined)(this._groupedSources.get(t)).filter((e=>i(e,this._pane)));this._groupedSources.set(e,s)}}}var pe=i(616117),me=i(291784),ge=i(740086),Se=i(440617),ve=i(981107),fe=i(438907),be=i(678515);class ye{constructor(e,t){if(this._base=e,this._integralDividers=t,(0,be.isBaseDecimal)(this._base))this._fractionalDividers=[2,2.5,2];else{this._fractionalDividers=[];for(let e=this._base;1!==e;){if(e%2==0)this._fractionalDividers.push(2),e/=2;else{if(e%5!=0)throw new Error("unexpected base");this._fractionalDividers.push(2),this._fractionalDividers.push(2.5),e/=5}if(this._fractionalDividers.length>100)throw new Error("something wrong with base")}}}tickSpan(e,t,i){const s=0===this._base?0:1/this._base,r=Math.min(1e-14,(e-t)/1e3);let o=Math.pow(10,Math.max(0,Math.ceil((0,
be.log10)(e-t)))),n=0,a=this._integralDividers[0];for(;;){const e=(0,be.greaterOrEqual)(o,s,r)&&o>s+r,t=(0,be.greaterOrEqual)(o,i*a,r),l=(0,be.greaterOrEqual)(o,1,r);if(!(e&&t&&l))break;o/=a,a=this._integralDividers[++n%this._integralDividers.length]}if(o<=s+r&&(o=s),o=Math.max(1,o),this._fractionalDividers.length>0&&(0,be.equal)(o,1,r))for(n=0,a=this._fractionalDividers[0];(0,be.greaterOrEqual)(o,i*a,r)&&o>s+r;)o/=a,a=this._fractionalDividers[++n%this._fractionalDividers.length];return o}}class Ce{constructor(e,t,i,s){this._marks=null,this._priceScale=e,this._base=t,this._coordinateToLogicalFunc=i,this._logicalToCoordinateFunc=s}base(){return this._base}setBase(e){if(e<0)throw new Error("base < 0");this._base=e}tickSpan(e,t,i=0){if(e<t)throw new Error("high < low");const s=this._priceScale.height(),r=(e-t)*this._tickMarkHeight()/s,o=new ye(this._base,[2,2.5,2]),n=new ye(this._base,[2,2,2.5]),a=new ye(this._base,[2.5,2,2]);let l=0;const c=o.tickSpan(e,t,r);c>i&&(l=c);const h=n.tickSpan(e,t,r);h>i&&(l=Math.min(l,h));const d=a.tickSpan(e,t,r);return d>i&&(l=Math.min(l,d)),l>0?l:e-t}rebuildTickMarks(){this._marks=null}marks(){return null===this._marks&&(this._marks=this._rebuildTickMarksImpl()),this._marks}_fontHeight(){return this._priceScale.fontSize()}_tickMarkHeight(){return Math.ceil(2.5*this._fontHeight())}_rebuildTickMarksImpl(){const e=this._priceScale,t=[],i=e.mainSource();if(e.isEmpty()||null===i)return t;let s=i.firstValue();null===s&&(s=0);const r=e.height(),o=this._coordinateToLogicalFunc(r-1,s),n=this._coordinateToLogicalFunc(0,s),a=Math.max(o,n),l=Math.min(o,n);if(a===l)return t;let c=this.tickSpan(a,l),h=a%c;h+=h<0?c:0;const d=a>=l?1:-1;let u=null;const _=e.formatter();let p=NaN;for(let i=a-h;i>l;i-=c){i===p&&(c=this.tickSpan(a,l,c)),p=i;const r=this._logicalToCoordinateFunc(i,s);null!==u&&Math.abs(r-u)<this._tickMarkHeight()||(t.push({coord:r,label:_.format(i)}),u=r,e.isLog()&&(c=this.tickSpan(i*d,l)))}return t}}var we=i(885482),Pe=i(541346);O.enabled("hide_price_scale_if_all_sources_hidden");const Te=new Pe.PercentageFormatter,Me=new R.PriceFormatter(100,1),xe={autoScale:!0,autoScaleDisabled:!1,lockScale:!1,percentage:!1,percentageDisabled:!1,log:!1,logDisabled:!1,alignLabels:!0,isInverted:!1,indexedTo100:!1};class Ie{constructor(e,t){this._marksCache=null,this._onMarksChanged=new j.Delegate,this.m_dataSources=[],this._sourcesForAutoscale=null,this._sourcesThatAffectVisibility=[],this._hasSeries=!1,this._studiesCount=0,this._drawingCount=0,this._seriesLikeSources=[],this._priceDataSources=[],this._mainSource=null,this._lastSourceRemoved=new j.Delegate,this._scaleSeriesOnly=!1,this._invalidatedForRange={isValid:!0,visibleBars:null},this.m_priceRange=null,this._logFormula=(0,ge.logFormulaForPriceRange)(null),this.m_height=0,this._margins={top:0,bottom:0},this._correctedMarginsCache=null,this._topPixelMargin=0,this._bottomPixelMargin=0,this._internalHeightCache=null,this._internalHeightChanged=new j.Delegate,this._priceRangeSnapshot=null,this._scrollStartPoint=null,this._currencyCache=null,
this._unitCache=null,this._measureUnitIdCache=null,this._recalculatePriceRangeOnce=!1,this._cachedOrderedSoruces=null,this._scaleStartPoint=null,this._twoPointsScaleStartPosition=null,this._maxPriceRange=null,this._minPriceRange=null,this._priceRangeChanged=new j.Delegate,this._modeChanged=new j.Delegate,this._sourcesToUpdateViews=null,this._markBuilder=new Ce(this,100,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._formatter=null,this._resetScaleAvailable=new Y.WatchedValue(!1),this._id="",this._isVisible=new Y.WatchedValue(!0),t=Object.assign({},xe,t),this._properties=new(L())(t),this._boundOnSourceIsActingAsSymbolSourceChanged=this._onSourceIsActingAsSymbolSourceChanged.bind(this),this._scalesProperties=e,this._properties.childs().isInverted.subscribe(this,this._onIsInvertedChanged),this._properties.subscribe(null,(()=>{const e=this.mainSource();if(e&&e.model()){const t=e.model().paneForSource(e);t&&e.model().updatePane(t)}})),this._scalesProperties.subscribe(this,(()=>{this._marksCache=null})),this._properties.childs().lockScale.subscribe(this,this._updateResetAvailableValue),this._properties.childs().autoScale.subscribe(this,this._updateResetAvailableValue),this._updateResetAvailableValue(),this.setId((0,J.randomHash)())}id(){return this._id}setId(e){this._id=e}isLog(){return this._properties.childs().log.value()}isPercentage(){return this._properties.childs().percentage.value()}isInverted(){return this._properties.childs().isInverted.value()}isIndexedTo100(){return this._properties.childs().indexedTo100.value()}isAutoScale(){return this._properties.childs().autoScale.value()&&!this.isLockScale()}isLockScale(){return this._properties.childs().lockScale.value()}isRegular(){return!this.isPercentage()&&!this.isLog()&&!this.isIndexedTo100()}properties(){return this._properties}height(){return this.m_height}setHeight(e){this.m_height!==e&&(this.m_height=e,this._invalidateInternalHeightCache(),this._marksCache=null)}internalHeight(){if(this._internalHeightCache)return this._internalHeightCache;const e=this.height()-this.topPixelMargin()-this.bottomPixelMargin();return this._internalHeightCache=e,e}fontSize(){return this._scalesProperties.childs().fontSize.value()}priceRange(){return this._makeSureItIsValid(),this.m_priceRange}setPriceRange(e,t,i){if(!(e instanceof me.PriceRange))throw new TypeError("incorrect price range");const s=this.m_priceRange;if(!t&&me.PriceRange.compare(s,e))return;const r=null!==this._maxPriceRange&&this._maxPriceRange.containsStrictly(e),o=null!==this._minPriceRange&&e.containsStrictly(this._minPriceRange);this.isLockScale()&&!t&&(r||o)||(this._marksCache=null,this.m_priceRange=e,i||this._priceRangeChanged.fire(s,e))}setMinPriceRange(e){this._minPriceRange=e}setMaxPriceRange(e){this._maxPriceRange=e}recalculatePriceRangeOnce(){this._recalculatePriceRangeOnce=!0}priceRangeShouldBeRecalculatedOnce(){if(!this._recalculatePriceRangeOnce||this.isLockScale())return!1;const e=this.mainSource();return null!==e&&e.priceRangeReady()}priceRangeChanged(){
return this._priceRangeChanged}mode(){const e=this._properties.childs();return{autoScale:e.autoScale.value(),lockScale:e.lockScale.value(),percentage:e.percentage.value(),indexedTo100:e.indexedTo100.value(),log:e.log.value()}}setMode(e){const t={},i=this.mode(),s=this._properties.state();let r=null;void 0!==e.autoScale&&e.autoScale!==s.autoScale&&(t.autoScale=e.autoScale,this._setAutoScaleValueWithDependentProperties(e.autoScale)),void 0!==e.lockScale&&e.lockScale!==s.lockScale&&(t.lockScale=e.lockScale,this._setLockScaleValueWithDependentProperties(e.lockScale)),void 0!==e.percentage&&e.percentage!==s.percentage&&(t.percentage=e.percentage,this._setPercentageValueWithDependentProperties(e.percentage),this._invalidatedForRange.isValid=!1),void 0!==e.indexedTo100&&e.indexedTo100!==s.indexedTo100&&(t.indexedTo100=e.indexedTo100,this._setIndexedTo100ValueWithDependentProperties(e.indexedTo100),this._invalidatedForRange.isValid=!1),void 0!==e.log&&e.log!==s.log&&(t.log=e.log,this._setLogValueWithDependentProperties(e.log));const o=this._properties.childs();s.log&&!o.log.value()&&(this._canConvertPriceRangeFromLog(this.m_priceRange)?(r=this._convertPriceRangeFromLog(this.m_priceRange),null!==r&&this.setPriceRange(r)):o.autoScale.setValue(!0)),!s.log&&o.log.value()&&(r=this._convertPriceRangeToLog(this.m_priceRange),null!==r&&this.setPriceRange(r)),s.autoScale!==o.autoScale.value()&&o.autoScale.listeners().fire(o.autoScale),s.autoScaleDisabled!==o.autoScaleDisabled.value()&&o.autoScaleDisabled.listeners().fire(o.autoScaleDisabled),s.lockScale!==o.lockScale.value()&&o.lockScale.listeners().fire(o.lockScale),s.percentage!==o.percentage.value()&&(o.percentage.listeners().fire(o.percentage),this.updateFormatter()),s.indexedTo100!==o.indexedTo100.value()&&(o.indexedTo100.listeners().fire(o.indexedTo100),this.updateFormatter()),s.percentageDisabled!==o.percentageDisabled.value()&&o.percentageDisabled.listeners().fire(o.percentageDisabled),s.log!==o.log.value()&&o.log.listeners().fire(o.log),s.logDisabled!==o.logDisabled.value()&&o.logDisabled.listeners().fire(o.logDisabled),void 0===t.log&&void 0===t.percentage&&void 0===t.lockScale&&void 0===t.autoScale&&void 0===t.indexedTo100||this._modeChanged.fire(i,this.mode())}modeChanged(){return this._modeChanged}isEmpty(){return this._makeSureItIsValid(),0===this.m_height||!this.m_priceRange||this.m_priceRange.isEmpty()}canDetachSource(e){return this.m_dataSources.some((t=>t!==e&&!(0,ae.isLollipopDataSource)(t)&&(0,le.isPriceDataSource)(t)&&!((0,q.isStudy)(t)&&t.isLinkedToSeries())))}updateAllViews(e){const t=this._getSourcesToUpdateViews();for(const i of t)i.updateAllViews(e)}logFormula(){return this._logFormula}state(){var e;const t=this._properties.childs();return{id:this._id,m_priceRange:this.isAutoScale()?null:(null===(e=this.priceRange())||void 0===e?void 0:e.serialize())||null,m_isAutoScale:this.isAutoScale(),m_isPercentage:t.percentage.value(),m_isIndexedTo100:t.indexedTo100.value(),m_isLog:t.log.value(),m_isLockScale:this.isLockScale(),m_isInverted:this.isInverted(),
m_topMargin:this._margins.top,m_bottomMargin:this._margins.bottom,alignLabels:t.alignLabels.value(),logFormula:(0,se.clone)(this._logFormula)}}restoreState(e){let t=e.m_priceRange;if(void 0===t)throw new TypeError("invalid state");if(void 0===e.m_isAutoScale)throw new TypeError("invalid state");void 0!==e.id&&(this._id=e.id);const i={autoScale:e.m_isAutoScale};void 0!==e.m_isPercentage&&(i.percentage=e.m_isPercentage),void 0!==e.m_isIndexedTo100&&(i.indexedTo100=e.m_isIndexedTo100),void 0!==e.m_isLog&&(i.log=e.m_isLog),void 0!==e.m_isLockScale&&(i.lockScale=e.m_isLockScale),void 0!==e.m_isInverted&&this._properties.childs().isInverted.setValue(e.m_isInverted),this.setMode(i),t?(t instanceof me.PriceRange||(t=new me.PriceRange(t)),this.setPriceRange(t,!0)):this.clearPriceRange(),e.logFormula&&(this._logFormula=e.logFormula),void 0!==e.m_topMargin&&(this._margins.top=e.m_topMargin),void 0!==e.m_bottomMargin&&(this._margins.bottom=e.m_bottomMargin),void 0!==e.alignLabels&&this._properties.childs().alignLabels.setValue(e.alignLabels),this._mainSource=null,this._scaleSeriesOnly=!1}priceToLogical(e){return this.isLog()&&e?(0,ge.toLog)(e,this._logFormula):e}logicalToPrice(e){return this.isLog()?(0,ge.fromLog)(e,this._logFormula):e}priceToCoordinate(e,t){const i=this._priceToPercentOrIndexedTo100IfNeeded(e,t);return this._logicalToCoordinate(i)}coordinateToPrice(e,t){let i=this._coordinateToLogical(e);return this.isPercentage()?i=(0,ge.fromPercent)(i,t):this.isIndexedTo100()&&(i=(0,ge.fromIndexedTo100)(i,t)),i}mainSource(){if(null!==this._mainSource)return this._mainSource;let e;for(const t of this._priceDataSources){if(t instanceof Se.Series){e=t;break}e||(e=t)}return this._mainSource=e||null,this._correctedMarginsCache=null,this._mainSource}priceToCoordinateFn(e){this._makeSureItIsValid();const t=this.bottomPixelMargin(),i=(0,o.ensureNotNull)(this.priceRange()),s=i.minValue(),r=i.maxValue(),n=this.internalHeight()-1,a=this.isInverted(),l=n/(r-s),c=this.m_height,h=e=>{const i=t+l*(e-s);return a?i:c-1-i};return this.isPercentage()?t=>h((0,ge.toPercent)(t,e)):this.isIndexedTo100()?t=>h((0,ge.toIndexedTo100)(t,e)):this.isLog()?e=>h((0,ge.toLog)(e,this._logFormula)):e=>h(e)}pricesArrayToCoordinates(e,t,i){this._makeSureItIsValid();const s=this.bottomPixelMargin(),r=(0,o.ensureNotNull)(this.priceRange()),n=r.minValue(),a=r.maxValue(),l=this.internalHeight()-1,c=this.isInverted(),h=l/(a-n);void 0===i&&(i=e.length);const d=this.isPercentage(),u=this.isIndexedTo100(),_=this.isLog(),p=this.m_height;let m,g;for(let r=0;r<i;r++)m=e[r],Number.isFinite(m)&&(d?m=(0,ge.toPercent)(m,t):u?m=(0,ge.toIndexedTo100)(m,t):_&&(m=(0,ge.toLog)(m,this._logFormula)),g=s+h*(m-n),e[r]=c?g:p-1-g)}pointsArrayToCoordinates(e,t,i){var s,r;this._makeSureItIsValid();const n=(0,o.ensureNotNull)(this.priceRange()),a=this.bottomPixelMargin(),l=n.minValue(),c=n.maxValue(),h=this.internalHeight()-1,d=this.isInverted(),u=h/(c-l),_=e,p=null!==(s=null==i?void 0:i.startItemIndex)&&void 0!==s?s:0,m=null!==(r=null==i?void 0:i.endItemIndex)&&void 0!==r?r:_.length
;if(this.isPercentage())for(let e=p;e<m;e++)_[e].y=(0,ge.toPercent)(_[e].y,t);if(this.isIndexedTo100())for(let e=p;e<m;e++)_[e].y=(0,ge.toIndexedTo100)(_[e].y,t);if(this.isLog())for(let e=p;e<m;e++)_[e].y=this.priceToLogical(_[e].y);for(let e=p;e<m;e++){const t=_[e].y;if(isNaN(t)||null==t)continue;const i=a+u*(t-l),s=d?i:this.m_height-1-i;_[e].y=s}}barPricesToCoordinates(e,t){this._makeSureItIsValid();const i=(0,o.ensureNotNull)(this.priceRange()),s=e,r=this.bottomPixelMargin(),n=i.minValue(),a=i.maxValue(),l=this.internalHeight()-1;let c=null;if(this.isPercentage()?c=ge.toPercent:this.isIndexedTo100()?c=ge.toIndexedTo100:this.isLog()&&(c=(e,t)=>e?(0,ge.toLog)(e,this._logFormula):e),0===s.length)return;const h="open"in s[0],d="close"in s[0];if(null!==c)for(let e=0;e<s.length;e++){if(!s[e])continue;const i=s[e];h&&(i.open=c(i.open,t)),i.high=c(i.high,t),i.low=c(i.low,t),d&&(i.close=c(i.close,t)),void 0!==i.additionalPrice&&(i.additionalPrice=c(i.additionalPrice,t))}const u=l/(a-n),_=this.isInverted();for(let e=0;e<s.length;e++){const t=s[e];if(!t)continue;if(h){const e=r+u*(t.open-n),i=_?e:this.m_height-1-e;t.open=i}const i=r+u*(t.high-n),o=_?i:this.m_height-1-i;t.high=o;const a=r+u*(t.low-n),l=_?a:this.m_height-1-a;if(t.low=l,d){const e=r+u*(t.close-n),i=_?e:this.m_height-1-e;t.close=i}if(void 0!==t.additionalPrice){const e=r+u*(t.additionalPrice-n);t.additionalPrice=_?e:this.m_height-1-e}}}formatter(){return null===this._formatter&&this.updateFormatter(),(0,o.ensureNotNull)(this._formatter)}updateFormatter(){this._marksCache=null;const e=this.mainSource();let t=100;e&&(t=e.base()),this._formatter=null,this.isPercentage()?(this._formatter=Te,t=100):this.isIndexedTo100()?(this._formatter=new R.PriceFormatter(100,1),t=100):this._formatter=e?e.formatter():Me,this._markBuilder=new Ce(this,t,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._markBuilder.rebuildTickMarks()}formatPrice(e,t,i){return this.isPercentage()?this.formatPricePercentage(e,t,i):this.isIndexedTo100()?this.formatPriceIndexedTo100(e,t):this.formatter().format(e)}formatPriceAbsolute(e){return this._mainSourceFormatter().format(e)}formatPricePercentage(e,t,i){return e=(0,ge.toPercent)(e,t),Te.format(e,i)}formatPriceIndexedTo100(e,t){const i=(0,ge.toIndexedTo100)(e,t);return this.formatter().format(i)}getFormattedValues(e,t,i){const s=this.formatPriceAbsolute(e),r=this.formatPricePercentage(e,t,i),o=this.formatPriceIndexedTo100(e,t);return{formattedPriceAbsolute:s,formattedPricePercentage:r,formattedPriceIndexedTo100:o,text:(0,ge.getCurrentModePriceText)(this,{formattedPriceAbsolute:s,formattedPricePercentage:r,formattedPriceIndexedTo100:o})}}resetScale(){this.setMode({autoScale:!0})}resetScaleAvailable(){return this._resetScaleAvailable.readonly()}dataSources(){return this.m_dataSources}seriesLikeSources(){return this._seriesLikeSources}addDataSource(e,t){this._addDataSourceImpl(e,t)}removeDataSource(e){const t=this.m_dataSources.indexOf(e);if((0,o.assert)(-1!==t,"Source is not attached to scale"),
this.m_dataSources.splice(t,1),(0,le.isPriceDataSource)(e)){const t=this._priceDataSources.indexOf(e);if((0,o.assert)(-1!==t,"Source is not found"),this._priceDataSources.splice(t,1),(0,ve.isSymbolSource)(e)){const t=this._seriesLikeSources.indexOf(e);(0,o.assert)(-1!==t,"Source is not found"),this._seriesLikeSources.splice(t,1),e.symbolResolved().unsubscribeAll(this),e.isActingAsSymbolSource().unsubscribe(this._boundOnSourceIsActingAsSymbolSourceChanged),e instanceof Se.Series&&(this._hasSeries=!1)}e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this)}this.mainSource()||this.setMode({autoScale:!0}),(0,q.isStudy)(e)&&(e.onIsActualIntervalChange().unsubscribe(this,this._dropScaleCache),e.onHibernationStateChange().unsubscribe(this,this._dropScaleCache),this._studiesCount--,0===this._studiesCount&&(0,we.hideAllIndicators)().unsubscribe(this,this._dropScaleCache)),(0,b.isLineTool)(e)&&(this._drawingCount--,0===this._drawingCount&&(0,we.hideAllDrawings)().unsubscribe(this,this._dropScaleCache));const i=this._sourcesThatAffectVisibility.indexOf(e);-1!==i&&(this._sourcesThatAffectVisibility.splice(i,1),e.properties().childs().visible.listeners().unsubscribe(this,this._onSourceVisibilityChanged)),e===this._mainSource&&(this._correctedMarginsCache=null,this._internalHeightCache=null,this._marksCache=null),this._mainSource=null,this._dropScaleCache(),this.updateFormatter(),this.invalidateSourcesCache(),this._updateIsVisible(),0===this.m_dataSources.length&&this._lastSourceRemoved.fire()}replaceSource(e,t){const i=(0,le.isPriceDataSource)(e)?this._priceDataSources.indexOf(e):void 0;return this._addDataSourceImpl(t,void 0,-1===i?void 0:i),this.removeDataSource(e),-1!==i}currency(e){if(null!==this._currencyCache&&e.size()===this._currencyCache.availableCurrenciesCount)return this._currencyCache.value;let t;const i=new Set,s=new Set,r=new Set,n=new Map;let a,l=0===this._seriesLikeSources.length,c=!0,h=0,d=0;const u=this._seriesLikeSources.filter(ve.isActingAsSymbolSource);for(const d of u){if(!d.isVisible())continue;const u=d.symbolInfo();if(null===u){t=null;break}const _=(0,F.symbolOriginalCurrency)(u);if(null===_){t=null;break}n.set(_,(0,o.ensureNotNull)((0,F.symbolOriginalCurrency)(u,!0)));const p=d.currency();if(null===p){t=null;break}n.set(p,(0,o.ensureNotNull)((0,F.symbolCurrency)(u,!0)));const m=(0,F.symbolBaseCurrency)(u);null!==m&&s.add(m),c=c&&_===p,r.add(p),i.add(_),void 0===a?a=p:null!==a&&a!==p&&(a=null),l||e.convertible(p)&&(0,F.symbolCurrencyConvertible)(u)||(l=!0),h+=1}if(null!==t)for(const i of this._priceDataSources){if(u.includes(i))continue;const s=i;if(!s.isCurrencySource()||!s.isVisible())continue;const c=s.currency();if(null===c){t=null;break}r.add(c),d+=1;const h=(0,o.ensureNotNull)(s.symbolSource()),_=s.currencySourceSymbolInfo();if(null===_){t=null;break}if(l||e.convertible(c)&&(0,F.symbolCurrencyConvertible)(_)||(l=!0),n.set(c,(0,o.ensureNotNull)((0,F.symbolCurrency)(_,!0))),u.includes(h)||(l=!0),void 0===a)a=c;else if(null!==a&&a!==c){a=null;break}}
return void 0===t&&(t=0===h&&0===d?null:{readOnly:l,selectedCurrency:a||null,currencies:r,originalCurrencies:i,baseCurrencies:s,symbolSourceCount:h,allCurrenciesAreOriginal:c,displayedValues:n}),this._currencyCache={value:t,availableCurrenciesCount:e.size()},t}unit(e){if(null!==this._unitCache&&e.size()===this._unitCache.availableUnitsCount)return this._unitCache.value;let t;const i=new Set,s=new Set,r=new Map,n=new Map;let a,l=0===this._seriesLikeSources.length?new Set:e.allGroups(),c=!0,h=0,d=0;const u=this._seriesLikeSources.filter(ve.isActingAsSymbolSource);for(const o of u){if(!o.isVisible())continue;const d=o.symbolInfo();if(null===d){t=null;break}const u=(0,F.symbolOriginalUnit)(d,o.model().unitConversionEnabled());if(null===u){t=null;break}r.set(u,e.name(u)),n.set(u,e.description(u));const _=o.unit();if(null===_){t=null;break}if(r.set(_,e.name(_)),n.set(_,e.description(_)),c=c&&u===_,s.add(_),i.add(u),void 0===a?a=_:null!==a&&a!==_&&(a=null),l.size>0){const t=(0,fe.unitConvertibleGroups)(d,_,e);l=(0,v.intersect)(l,new Set(t))}h+=1}if(null!==t)for(const i of this._priceDataSources){if(u.includes(i))continue;const c=i;if(!c.isUnitSource()||!c.isVisible())continue;const h=c.unit();if(null===h){t=null;break}s.add(h),d+=1;const _=(0,o.ensureNotNull)(c.symbolSource()),p=_.symbolInfo();if(null===p){t=null;break}if(l.size>0){const t=(0,fe.unitConvertibleGroups)(p,h,e);l=(0,v.intersect)(l,new Set(t))}if(r.set(h,e.name(h)),n.set(h,e.description(h)),u.includes(_)||(l=new Set),void 0===a)a=h;else if(null!==a&&a!==h){a=null;break}}if(void 0===t)if(0===h&&0===d)t=null;else{t={availableGroups:l,selectedUnit:a||null,units:s,originalUnits:i,symbolSourceCount:h,allUnitsAreOriginal:c,names:r,descriptions:n}}return this._unitCache={value:t,availableUnitsCount:e.size()},t}measureUnitId(e){if(null!==this._measureUnitIdCache&&e.size()===this._measureUnitIdCache.availableUnitsCount)return this._measureUnitIdCache.value;let t,i;const s=new Map,r=new Map,o=new Set;let n=0;const a=this._seriesLikeSources.filter(ve.isActingAsSymbolSource);for(const l of a){if(!l.isVisible())continue;const a=l.measureUnitId();if(null===a){t=null;break}o.add(a),s.set(a,e.name(a)),r.set(a,e.description(a)),void 0===i?i=a:null!==i&&i!==a&&(i=null),n+=1}return void 0===t&&(t=0===n?null:{selectedMeasureUnitId:i||null,measureUnitIds:o,names:s,descriptions:r,symbolSourceCount:n}),this._measureUnitIdCache={value:t,availableUnitsCount:e.size()},t}setMargins(e){if(!(0,se.isNumber)(e.top)||!(0,se.isNumber)(e.bottom))throw new TypeError("invalid margin");if(e.top<0||e.top>30||e.bottom<0||e.bottom>30)throw new RangeError("invalid margin");this._margins.top===e.top&&this._margins.bottom===e.bottom||(this._margins=e,this._correctedMarginsCache=null,this._invalidateInternalHeightCache(),this._marksCache=null)}topMargin(){return this._correctedMargins().top}bottomMargin(){return this._correctedMargins().bottom}invalidateMargins(){this._correctedMarginsCache=null}topPixelMargin(){
return this.isInverted()?this.bottomMargin()*this.height()+this._bottomPixelMargin:this.topMargin()*this.height()+this._topPixelMargin}bottomPixelMargin(){return this.isInverted()?this.topMargin()*this.height()+this._topPixelMargin:this.bottomMargin()*this.height()+this._bottomPixelMargin}marks(){return this.isEmpty()?(this._marksCache=null,[]):(null===this._marksCache&&(this._markBuilder.rebuildTickMarks(),this._marksCache=this._markBuilder.marks(),this._onMarksChanged.fire()),this._marksCache)}onMarksChanged(){return this._onMarksChanged}priceRangeInPrice(){if(this.isEmpty())return null;const e=this.mainSource();if(null===e)return null;const t=(0,o.ensureNotNull)(e.firstValue()),i=this.height();return{from:this.coordinateToPrice(i-1,t),to:this.coordinateToPrice(0,t)}}setPriceRangeInPrice(e){if(this.isPercentage()||this.isIndexedTo100())return;const t=this.isInverted(),i=t?this.bottomMargin():this.topMargin(),s=t?this.topMargin():this.bottomMargin(),r=this.isLog();let o=r?(0,ge.toLog)(e.from,this._logFormula):e.from,n=r?(0,ge.toLog)(e.to,this._logFormula):e.to;const a=n-o;o+=s*a,n-=i*a,this.setMode({autoScale:!1}),this.setPriceRange(new me.PriceRange(o,n)),this._marksCache=null,this._onMarksChanged.fire()}hasMainSeries(){return this._hasSeries}getStudies(){return this.dataSources().filter(q.isStudy)}lastSourceRemoved(){return this._lastSourceRemoved}sourcesForAutoscale(){return this._mainSource&&this._scaleSeriesOnly!==this._scalesProperties.childs().scaleSeriesOnly.value()&&(this._sourcesForAutoscale=null),this._sourcesForAutoscale||(this._sourcesForAutoscale=this._recalculateSourcesForAutoscale()),this._sourcesForAutoscale}recalculatePriceRange(e){this._invalidatedForRange={visibleBars:e,isValid:!1}}internalHeightChanged(){return this._internalHeightChanged}orderedSources(){if(this._cachedOrderedSoruces)return this._cachedOrderedSoruces;let e=this.m_dataSources.slice();return e=e.filter((e=>!(0,ae.isLollipopDataSource)(e))),e=(0,ce.sortSources)(e),this._cachedOrderedSoruces=e,this._cachedOrderedSoruces}invalidateSourcesCache(){this._cachedOrderedSoruces=null,this._sourcesToUpdateViews=null}startScale(e){var t,i;this.isEmpty()||this.isPercentage()||this.isIndexedTo100()||null!==this._scaleStartPoint||null!==this._priceRangeSnapshot||(this._scaleStartPoint=this.m_height-e,this._priceRangeSnapshot=null!==(i=null===(t=this.priceRange())||void 0===t?void 0:t.clone())&&void 0!==i?i:null)}scaleTo(e){if(this.isPercentage()||this.isIndexedTo100()||null===this._scaleStartPoint)return;this.setMode({autoScale:!1}),(e=this.m_height-e)<0&&(e=0);let t=(this._scaleStartPoint+.2*(this.m_height-1))/(e+.2*(this.m_height-1));const i=(0,o.ensureNotNull)(this._priceRangeSnapshot).clone();t=Math.max(t,.1),i.scaleAroundCenter(t),this.setPriceRange(i)}endScale(){this.isPercentage()||this.isIndexedTo100()||null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._priceRangeSnapshot=null)}startTwoPointsScale(e,t){if(this.isEmpty()||this.isPercentage()||this.isIndexedTo100()||null!==this._twoPointsScaleStartPosition)return
;const i=Math.min(e,t),s=Math.max(e,t);this._twoPointsScaleStartPosition={topLogical:this._coordinateToLogical(i),bottomLogical:this._coordinateToLogical(s)}}twoPointsScale(e,t){if(this.isPercentage()||this.isIndexedTo100()||null===this._twoPointsScaleStartPosition)return;this.setMode({autoScale:!1});const i=Math.min(e,t),s=Math.max(e,t),{topLogical:r,bottomLogical:o}=this._twoPointsScaleStartPosition,n=this.bottomPixelMargin(),a=this.internalHeight()-1,l=(this._invertedCoordinate(i)-n)/a,c=(o-r)/((this._invertedCoordinate(s)-n)/a-l);if(!Number.isFinite(c))return;const h=r-c*l,d=h+c;this.setPriceRange(new me.PriceRange(this.priceToLogical(h),this.priceToLogical(d)))}endTwoPointsScale(){this._twoPointsScaleStartPosition=null}startScroll(e){var t,i;this.isAutoScale()||null===this._scrollStartPoint&&null===this._priceRangeSnapshot&&(this.isEmpty()||(this._scrollStartPoint=e,this._priceRangeSnapshot=null!==(i=null===(t=this.priceRange())||void 0===t?void 0:t.clone())&&void 0!==i?i:null))}scrollTo(e){if(this.isAutoScale())return;if(null===this._scrollStartPoint||null===this._priceRangeSnapshot)return;const t=this.priceRange();if(null===t)return;let i=e-this._scrollStartPoint;this.isInverted()&&(i*=-1);const s=i*(t.length()/(this.internalHeight()-1)),r=this._priceRangeSnapshot.clone();r.shift(s),this.setPriceRange(r,!0),this._marksCache=null}endScroll(){this.isAutoScale()||null!==this._scrollStartPoint&&(this._scrollStartPoint=null,this._priceRangeSnapshot=null)}clearPriceRange(){this.m_priceRange=null,this.recalculatePriceRangeOnce()}isVisible(){return this._isVisible}_addDataSourceImpl(e,t,i){if(t||-1===this.m_dataSources.indexOf(e)){if((0,le.isPriceDataSource)(e)){if(void 0===i?this._priceDataSources.push(e):this._priceDataSources.splice(i,0,e),e.currencyChanged().subscribe(this,(()=>this._currencyCache=null)),e.unitChanged().subscribe(this,(()=>this._unitCache=null)),(0,ve.isSymbolSource)(e)&&(this._seriesLikeSources.push(e),e.symbolResolved().subscribe(this,(()=>{this._currencyCache=null,this._unitCache=null,this._measureUnitIdCache=null})),e.isActingAsSymbolSource().subscribe(this._boundOnSourceIsActingAsSymbolSourceChanged),e instanceof Se.Series)){const t=e.properties();this._hasSeries||(t.childs().lockScale&&(this.setMode({lockScale:t.childs().lockScale.value()}),t.removeProperty("lockScale")),t.childs().pnfStyle.child("lockScale")&&t.childs().pnfStyle.removeProperty("lockScale")),this._hasSeries=!0}e.isSpeciallyZOrderedSource()||(this._sourcesThatAffectVisibility.push(e),e.properties().childs().visible.listeners().subscribe(this,this._onSourceVisibilityChanged))}(0,q.isStudy)(e)&&(e.onIsActualIntervalChange().subscribe(this,this._dropScaleCache),e.onHibernationStateChange().subscribe(this,this._dropScaleCache),0===this._studiesCount&&(0,we.hideAllIndicators)().subscribe(this,this._dropScaleCache),this._studiesCount++),(0,b.isLineTool)(e)&&(0===this._drawingCount&&(0,we.hideAllDrawings)().subscribe(this,this._dropScaleCache),this._drawingCount++),this.m_dataSources.push(e),this._mainSource=null,
this.mainSource()===e&&(this._correctedMarginsCache=null,this._internalHeightCache=null,this._marksCache=null),this._dropScaleCache(),this.updateFormatter(),this._initScaleProperties(),this.invalidateSourcesCache(),this._updateIsVisible()}}_recalculateSourcesForAutoscale(){this._mainSource&&(this._scaleSeriesOnly=this._scalesProperties.childs().scaleSeriesOnly.value());const e=this._scaleSeriesOnly&&this._hasSeries;return this.m_dataSources.filter((t=>!!(t.properties().visible.value()||t instanceof Se.Series)&&(e?t instanceof Se.Series:(0,q.isStudy)(t)?!t.isSourceHidden()&&t.isIncludedInAutoScale():t.isIncludedInAutoScale())))}_updateAutoScaleDisabledProperty(e){const t=this._properties.childs(),i=t.indexedTo100.value()||t.percentage.value()||t.lockScale.value();e?t.autoScaleDisabled.setValueSilently(i):t.autoScaleDisabled.setValue(i)}_setAutoScaleValueWithDependentProperties(e){const t=this._properties.childs();t.autoScale.setValueSilently(e),e&&(t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.logDisabled.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setLockScaleValueWithDependentProperties(e){const t=this._properties.childs();t.lockScale.setValueSilently(e),e&&(t.autoScale.setValueSilently(!1),t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1),t.log.setValueSilently(!1)),t.percentageDisabled.setValueSilently(e),t.logDisabled.setValueSilently(e),this._updateAutoScaleDisabledProperty(!0)}_setPercentageValueWithDependentProperties(e){const t=this._properties.childs();t.percentage.setValueSilently(e),e&&(t.autoScale.setValueSilently(!0),t.log.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.indexedTo100.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setIndexedTo100ValueWithDependentProperties(e){const t=this._properties.childs();t.indexedTo100.setValueSilently(e),e&&(t.autoScale.setValueSilently(!0),t.log.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.percentage.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setLogValueWithDependentProperties(e){const t=this._properties.childs();t.log.setValueSilently(e),e&&(t.lockScale.setValueSilently(!1),t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_recalculatePriceRangeImpl(){const e=this._invalidatedForRange.visibleBars;if(null===e)return;let t=null;const i=this.sourcesForAutoscale(),s=this.isPercentage(),r=this.isIndexedTo100();let o=0,n=0;for(const a of i){if(!a.properties().visible.value())continue;const i=a.firstValue();if(null===i||s&&0===i)continue;const l=e.firstBar(),c=e.lastBar(),h=a.autoScaleInfo(l,c);let d=h.range;d&&(s?d=(0,ge.toPercentRange)(d,i):r&&(d=(0,ge.toIndexedTo100Range)(d,i)),t=null===t?d:t.merge(d)),void 0!==h.topPixelMargin&&(o=Math.max(o,h.topPixelMargin)),void 0!==h.bottomPixelMargin&&(n=Math.max(n,h.bottomPixelMargin))}if((Math.abs(o-this._topPixelMargin)>0||Math.abs(n-this._bottomPixelMargin)>0)&&(this._bottomPixelMargin=n,
this._topPixelMargin=o,this._marksCache=null,this._invalidateInternalHeightCache()),t){if(t.minValue()===t.maxValue()&&(t=new me.PriceRange(t.minValue()-.5,t.maxValue()+.5)),this.isLog()){const e=this._convertPriceRangeFromLog(t),i=(0,ge.logFormulaForPriceRange)(e);if(!(0,ge.logFormulasAreSame)(i,this._logFormula)){const s=this._priceRangeSnapshot?this._convertPriceRangeFromLog(this._priceRangeSnapshot):null;this._logFormula=i,t=this._convertPriceRangeToLog(e),s&&(this._priceRangeSnapshot=this._convertPriceRangeToLog(s))}}this.setPriceRange(t)}else this.m_priceRange||(this.setPriceRange(new me.PriceRange(-.5,.5)),this._logFormula=(0,ge.logFormulaForPriceRange)(null));this._invalidatedForRange.isValid=!0;const a=this.mainSource();null!==a&&this._recalculatePriceRangeOnce&&(this._recalculatePriceRangeOnce=!a.priceRangeReady())}_makeSureItIsValid(){this._invalidatedForRange.isValid||(this._invalidatedForRange.isValid=!0,this._recalculatePriceRangeImpl())}_invalidateInternalHeightCache(){this._internalHeightCache=null,this._internalHeightChanged.fire()}_coordinateToLogical(e){if(this._makeSureItIsValid(),this.isEmpty())return 0;const t=this._invertedCoordinate(e),i=(0,o.ensureNotNull)(this.priceRange()),s=i.minValue()+(i.maxValue()-i.minValue())*((t-this.bottomPixelMargin())/(this.internalHeight()-1));return this.logicalToPrice(s)}_logicalToCoordinate(e){if(this._makeSureItIsValid(),this.isEmpty())return 0;e=this.priceToLogical(e);const t=(0,o.ensureNotNull)(this.priceRange()),i=this.bottomPixelMargin()+(this.internalHeight()-1)*(e-t.minValue())/(t.maxValue()-t.minValue());return this._invertedCoordinate(i)}_convertPriceRangeFromLog(e){if(null===e)return null;const t=(0,ge.fromLog)(e.minValue(),this._logFormula),i=(0,ge.fromLog)(e.maxValue(),this._logFormula);return new me.PriceRange(t,i)}_convertPriceRangeToLog(e){if(null===e)return null;const t=(0,ge.toLog)(e.minValue(),this._logFormula),i=(0,ge.toLog)(e.maxValue(),this._logFormula);return new me.PriceRange(t,i)}_canConvertPriceRangeFromLog(e){if(null===e)return!1;const t=(0,ge.fromLog)(e.minValue(),this._logFormula),i=(0,ge.fromLog)(e.maxValue(),this._logFormula);return isFinite(t)&&isFinite(i)}_onSourceVisibilityChanged(){this._dropScaleCache(),this._updateIsVisible()}_dropScaleCache(){this._sourcesForAutoscale=null,this._currencyCache=null,this._unitCache=null,this._measureUnitIdCache=null}_updateIsVisible(){this._isVisible.setValue(!0)}_invertedCoordinate(e){return this.isInverted()?e:this.height()-1-e}_initScaleProperties(){const e=this.isLockScale(),t=this.properties().childs();e&&(t.percentage.setValue(!1),t.indexedTo100.setValue(!1),t.log.setValue(!1),t.autoScale.setValue(!1)),t.percentageDisabled.setValue(e),t.logDisabled.setValue(e),this._updateAutoScaleDisabledProperty(!1),t.percentage.value()&&(t.log.setValue(!1),t.indexedTo100.setValue(!1)),t.indexedTo100.value()&&(t.log.setValue(!1),t.percentage.setValue(!1))}_correctedMargins(){if(null===this._correctedMarginsCache){const e=this.mainSource()
;this._correctedMarginsCache=null!==e?e.correctScaleMargins(this._margins):this._margins}return this._correctedMarginsCache}_getSourcesToUpdateViews(){return this._sourcesToUpdateViews||(this._sourcesToUpdateViews=this.m_dataSources.filter((e=>!(0,b.isLineTool)(e)||e.isActualSymbol()&&e.isActualCurrency()))),this._sourcesToUpdateViews}_mainSourceFormatter(){const e=this.mainSource();return(null==e?void 0:e.formatter())||Me}_priceToPercentOrIndexedTo100IfNeeded(e,t){return this.isPercentage()?(0,ge.toPercent)(e,t):this.isIndexedTo100()?(0,ge.toIndexedTo100)(e,t):e}_onSourceIsActingAsSymbolSourceChanged(){this._dropScaleCache()}_onIsInvertedChanged(){this._marksCache=null,this._markBuilder.rebuildTickMarks()}_updateResetAvailableValue(){this._resetScaleAvailable.setValue(!this.isLockScale()&&!this.isAutoScale())}}var Le=i(915179),ke=i(46955),Ae=i(790524),Ee=i(339315),De=i(504101);const Be=[],Re=[];class Ne{constructor(e){this._studies={},this._deferreds={},this._container=e,Be.push(e),Re.push(this)}add(e,t){this._deferreds[e]&&(this._deferreds[e].resolve(t),delete this._deferreds[e]),this._studies[e]=t}get(e){return this._studies[e]?Promise.resolve(this._studies[e]):(this._deferreds[e]||(this._deferreds[e]=(0,_.createDeferredPromise)()),this._deferreds[e].promise)}reset(){const e=Be.indexOf(this._container);~e&&(Be.splice(e,1),Re.splice(e,1))}static instance(e){const t=Be.indexOf(e);return~t?Re[t]:new Ne(e)}}var Ve=i(960690);var Oe=i(395098),Fe=i(180148),We=i(844295),ze=i(167723),He=i(711755),Ue=i(247035),Ge=i(707621);const qe=(0,Q.getLogger)("Chart.Pane");function je(e,t,i){e.setMargins({top:t,bottom:i})}const Ye="chart.pane";class Ke{constructor(e,t,i,s){this.m_dataSources=[],this._sourceWatchedValuesSubscriptions=new Map,this.m_mainDataSource=null,this._cachedOrderedSources=new _e(this),this._sourcesById=new Map,this._priceSourcesById=new Map,this._sourcePropertiesChanged=new j.Delegate,this._sourcesZOrderChanged=new j.Delegate,this._tagsChanged=new j.Delegate,this._stretchFactor=1e3,this._isInInsertManyDataSourcesState=!1,this._lastLineDataSourceZOrder=null,this._rightPriceScales=[],this._leftPriceScales=[],this._lockedPriceScale=null,this._currentPriceScaleRatio=null,this._onPriceScalesChanged=new j.Delegate,this._isRecalculatingScales=!1,this._priceDataSources=[],this._symbolSources=[],this._lollipopDataSources=[],this._symbolSourceResolved=new j.Delegate,this._symbolSourceResolvingActive=new Y.WatchedValue(!1),this._bulkActions={activeCounter:0},this._height=0,this._width=0,this._sizeChanged=new j.Delegate,this._dataSourcesCollectionChanged=new j.Delegate,this._symbolSourceCollectionChanged=new j.Delegate,this._priceSourcesCollectionChanged=new j.Delegate,this._maximized=new Y.WatchedValue(!1),this._collapsed=new Y.WatchedValue(!1),this._resetPriceScalesAvailable=new Y.WatchedValue(!1),this._destroyed=new j.Delegate,this._executionsPositionController=null,this._seriesDisplayError=null,this._onPriceScaleIsVisibleChanged=()=>{this._model.fullUpdate()},this._recalcSymbolSourceResolvingActive=()=>{
for(const e of this._symbolSources)if(e.symbolResolvingActive().value())return void this._symbolSourceResolvingActive.setValue(!0);this._symbolSourceResolvingActive.setValue(!1)},this._onSymbolSourceCollectionChanged=()=>{0===this._bulkActions.activeCounter?this._symbolSourceCollectionChanged.fire():this._bulkActions.symbolSourceCollectionChanged=!0},this._onSeriesDisplayError=e=>{},this._updateResetPriceScalesAvailableValue=()=>{const e=e=>e.resetScaleAvailable().value(),t=this._leftPriceScales.some(e)||this._rightPriceScales.some(e);this._resetPriceScalesAvailable.setValue(t)},this._priceScaleSelectionStrategy=(0,te.createPriceScaleSelectionStrategy)(i.properties().childs().priceScaleSelectionStrategyName.value()),this._id=null!=s?s:(0,J.randomHashN)(6),this._timeScale=e,this.m_mainDataSource=null,this._properties=t,this._model=i,i.properties().childs().priceScaleSelectionStrategyName.subscribe(null,(e=>{this._priceScaleSelectionStrategy=(0,te.createPriceScaleSelectionStrategy)(e.value()),this._priceScaleSelectionStrategy.apply(this)})),this._timeScale.barSpacingChanged().subscribe(this,(()=>{this.m_mainDataSource===this._model.mainSeries()&&this._recalculatePriceScaleByScaleRatio(this.m_mainDataSource.priceScale())})),t.childs().topMargin.subscribe(this,this._updateMargins),t.childs().bottomMargin.subscribe(this,this._updateMargins),this._updateMargins()}destroy(){var e;this._properties.childs().topMargin.unsubscribeAll(this),this._properties.childs().bottomMargin.unsubscribeAll(this),this._model.properties().childs().priceScaleSelectionStrategyName.unsubscribeAll(this),this._timeScale.barSpacingChanged().unsubscribeAll(this),this._leftPriceScales.concat(this._rightPriceScales).forEach((e=>{e.modeChanged().unsubscribeAll(this),e.priceRangeChanged().unsubscribeAll(this),e.internalHeightChanged().unsubscribeAll(this),e.isVisible().unsubscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().unsubscribe(this._updateResetPriceScalesAvailableValue)}));for(const e of this.m_dataSources)this.removeSourceFromPriceScale(e),e.destroy&&e.destroy();null===(e=this._seriesDisplayError)||void 0===e||e.destroy(),this._destroyed.fire()}id(){return this._id}bulkActionMacro(e){const t=this._bulkActions;t.activeCounter+=1,e(),t.activeCounter-=1,0===t.activeCounter&&(this._dataSourcesCollectionChanged.fire(),t.symbolSourceCollectionChanged&&(this._symbolSourceCollectionChanged.fire(),t.symbolSourceCollectionChanged=!1),t.priceSourcesCollectionChanged&&(this._priceSourcesCollectionChanged.fire(),t.priceSourcesCollectionChanged=!1))}defaultPriceScale(){var e,t;const i=null!==(t=null===(e=this.m_mainDataSource)||void 0===e?void 0:e.priceScale())&&void 0!==t?t:null;if(null!==i)return i;const s=this.properties().childs().axisProperties.state();return s.autoScale=!0,new Ie(this._model.properties().childs().scalesProperties,s)}leftPriceScales(){return this._leftPriceScales}rightPriceScales(){return this._rightPriceScales}visibleLeftPriceScales(){var e
;const t=this._model.priceScaleSlotsCount(),i=this._leftPriceScales.filter((e=>e.isVisible().value())),s=null===(e=this.mainDataSource())||void 0===e?void 0:e.priceScale();if(i.length>t.left&&(null==s?void 0:s.isVisible().value())){const e=(0,v.moveToHead)(i,s);return e.splice(t.left),e}return i}visibleRightPriceScales(){var e;const t=this._model.priceScaleSlotsCount(),i=this._rightPriceScales.filter((e=>e.isVisible().value())),s=null===(e=this.mainDataSource())||void 0===e?void 0:e.priceScale();if(i.length>t.right&&(null==s?void 0:s.isVisible().value())){const e=(0,v.moveToHead)(i,s);return e.splice(t.right),e}return i}clearSeries(e){const t=this._model.mainSeries();for(let i=this.m_dataSources.length-1;i>=0;i--)this.m_dataSources[i]===t&&this._removeSourceFromCollections(i,e)}sourcesByGroup(){return this._cachedOrderedSources}dataSourceForId(e){return this._sourcesById.get(e)||null}changeSourceId(e,t){var i;e===this._model.mainSeries()&&(null===(i=(0,ee.getPersistentLogger)())||void 0===i||i.addPersistentLogEntry(`changeSourceId for series from ${e.id()} to ${t}`,Q.LOGLEVEL.INFO,Ye)),(0,o.assert)(this.hasDataSource(e));const s=e.id();e.setId(t),this._sourcesById.delete(s),this._sourcesById.set(t,e),(0,le.isPriceDataSource)(e)&&(this._priceSourcesById.delete(s),this._priceSourcesById.set(t,e))}movePriceScale(e,t,i){const s=this.priceScalePosition(e);if(s!==t)this.removePriceScale(e),this._placePriceScale(e,t,i),e.invalidateMargins(),this._invalidateSourcesCache();else if(void 0!==i&&"overlay"!==s){const t="left"===s?this._leftPriceScales:this._rightPriceScales,r=t.indexOf(e);t.splice(r,1),t.splice(i,0,e)}}mainDataSource(){return this.m_mainDataSource}isEmpty(){return null===this.m_mainDataSource}recalculatePriceScale(e,t){if(!e)return;const i=e.sourcesForAutoscale();if((e.isAutoScale()||e.priceRangeShouldBeRecalculatedOnce())&&i&&i.length>0&&!this.timeScale().isEmpty()){const t=this.timeScale().visibleBarsStrictRange();e.recalculatePriceRange(t)}e.updateAllViews(t)}onSourceTagsChanged(){this._tagsChanged.fire()}insertDataSource(e,t,i,s){e.setZorder(i),t||(s=!1,t=this.findSuitableScale(e)),this._addSourceToCollections(e);let r=!1;e===this.model().mainSeries()?(this.m_mainDataSource=this.model().mainSeries(),r=!0):null===this.m_mainDataSource&&(0,le.isPriceDataSource)(e)&&(this.m_mainDataSource=e,r=!0),s||t.addDataSource(e,this._isInInsertManyDataSourcesState),e.setPriceScale(t),t.invalidateMargins(),e.onTagsChanged&&e.onTagsChanged().subscribe(this,this.onSourceTagsChanged),r&&this._processMainSourceChange(),this._tagsChanged.fire(),(0,le.isPriceDataSource)(e)&&this.recalculatePriceScale(t,(0,z.sourceChangeEvent)(e.id())),this._invalidateSourcesCache(),this._isInInsertManyDataSourcesState||(0,o.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(e)}addDataSource(e,t,i){let s=e.zorder();i||((0,b.isLineTool)(e)&&!e.isSpeciallyZOrderedSource()?(s=null!==this._lastLineDataSourceZOrder?this._lastLineDataSourceZOrder+1:this.newLineToolZOrder(),
this._isInInsertManyDataSourcesState&&(this._lastLineDataSourceZOrder=s)):(0,q.isStudy)(e)&&!e.isSpeciallyZOrderedSource()&&(s=this.newStudyZOrder())),this.insertDataSource(e,t,s)}removeDataSource(e,t,i,s){const r=this.m_dataSources.indexOf(e);if(-1===r)return void qe.logDebug("removeDataSource: invalid data source");(0,o.ensureNotNull)(this.model().alertsWatcher()).detachSourceAlertLabels(e),this._removeSourceFromCollections(r,!!i),e!==this.m_mainDataSource||t||(this.m_mainDataSource=null);const n=e.priceScale();s||this.removeSourceFromPriceScale(e),e.onTagsChanged&&e.onTagsChanged().unsubscribe(this,this.onSourceTagsChanged),(0,le.isPriceDataSource)(e)&&!t&&this._processMainSourceChange(),this._tagsChanged.fire(),n&&(0,le.isPriceDataSource)(e)&&this.recalculatePriceScale(n,(0,z.sourceChangeEvent)(e.id())),this._invalidateSourcesCache()}hasDataSource(e){return this._sourcesById.has(e.id())}hasPriceDataSource(e){return this._priceSourcesById.has(e.id())}dataSources(){return this.m_dataSources}priceDataSources(){return this._priceDataSources}lollipopDataSources(){return this._lollipopDataSources}symbolSources(){return this._symbolSources}replaceSource(e,t,i){const s=this.m_mainDataSource===e,r=e.zorder(),o=null==i?void 0:i.replaceSource(e,t);this.insertDataSource(t,i,r,o),this.removeDataSource(e,s,void 0,o),this._sourcesById.set(t.id(),t),(0,le.isPriceDataSource)(t)&&this._priceSourcesById.set(t.id(),t),s&&(this.m_mainDataSource=t,this._processMainSourceChange())}findSuitableScale(e,t,i){return this._priceScaleSelectionStrategy.findSuitableScale(this,e,t,i)}createNewPriceScaleIfPossible(){return this._priceScaleSelectionStrategy.createNewPriceScaleIfPossible(this)}canCreateNewPriceScale(){return this._priceScaleSelectionStrategy.canCreateNewPriceScale(this)}isOverlay(e){const t=e.priceScale();return null===t||"overlay"===this.priceScalePosition(t)}recalculate(e){this._leftPriceScales.forEach((t=>this.recalculatePriceScale(t,e))),this._rightPriceScales.forEach((t=>this.recalculatePriceScale(t,e)));for(const t of this.m_dataSources)this.isOverlay(t)&&!(0,b.isLineTool)(t)&&this.recalculatePriceScale(t.priceScale(),e);this.updateAllViews(e),this._model.updatePane(this)}updateAllViews(e){for(const t of this.m_dataSources)t.updateAllViews(e);for(const t of this.model().customSources())t.updateViewsForPane(this,e)}updateLollipopViews(e){for(const t of this._lollipopDataSources)t.updateAllViews(e)}priceScalePosition(e){return this._leftPriceScales.includes(e)?"left":this._rightPriceScales.includes(e)?"right":"overlay"}createPriceScaleAtPosition(e,t){const i=this.properties().childs().axisProperties.state();i.autoScale=!0;const s=new Ie(this.model().properties().childs().scalesProperties,i);return s.setHeight(this.height()),je(s,this._defaultTopMargin(),this._defaultBottomMargin()),this._placePriceScale(s,e,t),s}removePriceScale(e){e.modeChanged().unsubscribeAll(this),e.priceRangeChanged().unsubscribeAll(this),e.internalHeightChanged().unsubscribeAll(this),e.isVisible().unsubscribe(this._onPriceScaleIsVisibleChanged),
e.resetScaleAvailable().unsubscribe(this._updateResetPriceScalesAvailableValue),e===this._lockedPriceScale&&(this._lockedPriceScale=null,this._currentPriceScaleRatio=null);const t=this._leftPriceScales.indexOf(e);-1!==t&&(this._leftPriceScales[t].invalidateMargins(),this._leftPriceScales.splice(t,1));const i=this._rightPriceScales.indexOf(e);if(-1!==i&&(this._rightPriceScales[i].invalidateMargins(),this._rightPriceScales.splice(i,1)),null===e.mainSource()){const t=e.dataSources().length;0!==t&&qe.logError("Invalid priceScale state: empty mainSource but non-empty data sources="+t)}this._onPriceScalesChanged.fire(),this._updateResetPriceScalesAvailableValue()}priceScaleIndex(e,t){switch(t){case"left":return this.leftPriceScales().indexOf(e);case"right":return this.rightPriceScales().indexOf(e)}}move(e,t,i){const s=e.priceScale();this.removeSourceFromPriceScale(e),t.addDataSource(e),e.setPriceScale(t),t.invalidateMargins(),this._processMainSourceChange(),this._invalidateSourcesCache(),e.isIncludedInAutoScale()&&(null!==s&&this.recalculatePriceScale(s,(0,z.sourceChangeEvent)(e.id())),this.recalculatePriceScale(t,(0,z.sourceChangeEvent)(e.id()))),this._onPriceScalesChanged.fire()}setZOrders(e){e.forEach(((e,t)=>{t.setZorder(e)})),this._invalidateSourcesCache(),0===this._bulkActions.activeCounter&&this._dataSourcesCollectionChanged.fire(),this.model().lightUpdate()}isMainPane(){return this.hasDataSource(this.model().mainSeries())}isLast(){const e=this.model().panes();return e[e.length-1]===this}newStudyZOrder(){return(0,ke.newStudyZOrder)(this._priceDataSources)}newLineToolZOrder(e){return(0,ke.newLineToolZOrder)(this.m_dataSources,e)}model(){return this._model}containsMainSeries(){return this._sourcesById.has(this.model().mainSeries().id())}applyPriceScaleRatio(e,t){var i;null!==this._lockedPriceScale&&this._lockedPriceScale!==e||this._currentPriceScaleRatio===t||!this.isMainPane()||null===this._lockedPriceScale&&e!==(null===(i=this.mainDataSource())||void 0===i?void 0:i.priceScale())||(this._setNewPriceRangeByScaleRatio(e,t,this._mainSourceVisiblePriceRange(e),!0,!0),null!==this._lockedPriceScale?this._tryToApplyNewPriceScaleRatio():e.isLog()||this.model().mainSeriesScaleRatioPropertyOnChanged())}sendToBack(e){const t=this.sourcesByGroup().allExceptSpecialSources();this._batchReorder(e,t[0],ke.moveBeforeSource)}bringToFront(e){const t=this.sourcesByGroup().allExceptSpecialSources();this._batchReorder(e,t[t.length-1],ke.moveAfterSource)}sendBackward(e){const t=this.sourcesByGroup().allIncludingHidden(),i=t.indexOf(e[0]);if(0===i)this.bringToFront(e);else{const s=t[i-1];this.insertBefore(e,s)}}bringForward(e){const t=this.sourcesByGroup().allExceptSpecialSources(),i=t.indexOf(e[e.length-1]);if(i===t.length-1)this.sendToBack(e);else{const s=t[i+1];this.insertAfter(e,s)}}insertAfter(e,t){this._batchReorder(e,t,ke.moveAfterSource)}insertBefore(e,t){this._batchReorder(e,t,ke.moveBeforeSource)}maximized(){return this._maximized}collapsed(){return this._collapsed}getPriceScaleById(e){const t=this.m_dataSources.find((t=>{var i
;return(null===(i=t.priceScale())||void 0===i?void 0:i.id())===e}));return void 0===t?null:t.priceScale()}priceScaleSelectionStrategy(){return this._priceScaleSelectionStrategy}setPriceScaleSelectionStrategy(e){this._priceScaleSelectionStrategy=e,e.apply(this)}findTargetPriceAxisViews(e,t,i,s){if((0,S.isDataSource)(e)&&this.model().paneForSource(e)!==this)return[];const r=e.priceScale();if(t===r)return i;if(null===r)return[];if("overlay"===this.priceScalePosition(r))return t===this.defaultPriceScale()?i:[];const o=this.priceScalePosition(t);if(o!==this.priceScalePosition(r))return[];const n="left"===o?this.leftPriceScales():this.rightPriceScales();return n.indexOf(t)<n.indexOf(r)?s:[]}actionNoScaleIsEnabled(e){return!(!this.isOverlay(e)&&(0,le.isPriceDataSource)(e))||this._nonOverlayPricesSourcesCount()>1}properties(){return this._properties}setPriceAutoScale(e,t){e.setMode({autoScale:t}),this.timeScale().isEmpty()||this.recalculatePriceScale(e,(0,z.viewportChangeEvent)())}state(e,t,i,s,r,o){var n,a;const l={sources:[],mainSourceId:null===(n=this.m_mainDataSource)||void 0===n?void 0:n.id(),stretchFactor:this._stretchFactor,leftAxisesState:[],rightAxisesState:[],overlayPriceScales:{},priceScaleRatio:this._currentPriceScaleRatio,isCollapsed:this._collapsed.value()},c=new Map,h=e=>{if(c.has(e))return c.get(e);let n=null;const a=i&&!e.isSavedInStudyTemplates()||(0,f.isAlertLabel)(e)||!e.state||(0,b.isLineTool)(e)&&o||!e.isSavedInChart(Boolean(t))||!(n=e.state(t,r))||s&&(0,b.isLineTool)(e)&&e.isActualSymbol&&!e.isActualSymbol()||e.isPhantom()?null:n;return c.set(e,a),a};if(e){l.sources=[];for(let e=0;e<this.m_dataSources.length;e++){const t=h(this.m_dataSources[e]);null!==t&&l.sources.push(t)}}const d=e=>null!==c.get(e),u=e=>!o||!(0,b.isLineTool)(e);l.leftAxisesState=this._leftPriceScales.map((e=>({state:e.state(),sources:e.dataSources().filter(d).filter(u).map((e=>e.id()))}))),l.rightAxisesState=this._rightPriceScales.map((e=>({state:e.state(),sources:e.dataSources().filter(d).filter(u).map((e=>e.id()))}))),l.overlayPriceScales={};for(const e of this.m_dataSources)if(this.isOverlay(e)&&e.isSavedInChart(Boolean(t))){const t=e.priceScale();l.overlayPriceScales[e.id()]=null!==(a=null==t?void 0:t.state())&&void 0!==a?a:null}return l}restoreState(e,t,i,s,r,n,a){var l;null===(l=(0,ee.getPersistentLogger)())||void 0===l||l.addPersistentLogEntry(`Restoring pane with seriesId ${s}`,Q.LOGLEVEL.INFO,Ye),r=r||{},e.stretchFactor&&(this._stretchFactor=e.stretchFactor),s=null!=s?s:this._model.mainSeries().id();const c={};if(e.sources){const o=e.sources.filter((e=>{var t;return!!e&&("MainSeries"===e.type||(!(null===(t=e.points)||void 0===t?void 0:t.some((e=>null===e.time_t||!isFinite(e.time_t))))||(qe.logNormal("Dropped invalid "+e.type+". Reason: non-numeric point time"),!1)))})),l=o.findIndex(Ae.isMainSeriesState);-1!==l&&this.model().mainSeries().setObsoleteZOrder(o[l].zorder),i<3&&(0,ke.reorderDataSourcesStateZOrder)(o);const h=-1!==this.m_dataSources.indexOf(this._model.mainSeries());this.clearSeries(Boolean(a)),
this.m_mainDataSource=null,h&&this._addSourceToCollections(this._model.mainSeries(),a),(()=>{const t=o.find((t=>t.id===e.mainSourceId));if(void 0===t)return void qe.logWarn("There is no main source with id "+e.mainSourceId+", total sources="+o.length);if(!window.TradingView[t.type]||!(0,pe.isLineToolName)(t.type))return void qe.logNormal("The type of main source is not line tool - fix is unnecessary");let i=null;for(const e of o)if(!window.TradingView[t.type]||!(0,pe.isLineToolName)(e.type)){if(null!==i)return void qe.logWarn("Pane contains more than 1 possibly main sources - auto fix cannot be applied");i=e}if(null===i)return void qe.logWarn("Pane contains only line tools - possible we need to remove this pane?");const s=e.mainSourceId;let r=0;e.mainSourceId=i.id,o.forEach((e=>{e.ownerSource===s&&(e.ownerSource=null==i?void 0:i.id,r+=1)})),qe.logNormal("Auto fix broken pane is applied, changed line tools="+r+", changed from="+s+" to="+i.id)})();for(const e of o)if("study_Sessions"===e.type){this.model().sessions().restoreOldState(e,t);break}for(const e of o)"study_Sessions"!==e.type&&(null===this._model.dataSourceForId(e.id)||"MainSeries"===e.type?(c[e.id]=e.ownerSource,(0,Ae.isMainSeriesState)(e)?this._restoreMainSeries(e,t,h,r,n,a):(0,Ae.isStudyState)(e)?this.restoreStudy(e,t,s,r,a):(0,Ae.isLineToolState)(e)?(e.state&&(e.state.zOrderVersion=2),this.restoreLineTool(e,t,void 0,a)):"ChartEventsSource"===e.type&&this._restoreSpecialSource(e,t,a)):qe.logError("Duplicate id while restoring pane: "+e.type+","+e.id))}const h=new Set,d=(e,t)=>{e.priceScale()!==t&&(this.removeSourceFromPriceScale(e),e.setPriceScale(t),t.addDataSource(e))},u=(e,t,i)=>{if(h.has(e))return;h.add(e);const s=i.m_showSymbolLabels;void 0!==s&&e===this.model().mainSeries()&&this.model().properties().childs().scalesProperties.childs().showSymbolLabels.setValue(s),this._model.children(e,!0).forEach((e=>u(e,t,i))),d(e,t)},_=e=>{const t=(0,N.defaults)("chartproperties").paneProperties.axisProperties,i=new Ie(this.model().properties().childs().scalesProperties,t);return i.restoreState(e.state),i.setHeight(this._height),e.sources.forEach((e=>{const s=this.dataSourceForId(e);s&&u(s,i,t)})),0===i.dataSources().length?null:i},p=e=>e.map(_).filter((e=>null!==e));let m;if(e.leftAxisesState)m=p(e.leftAxisesState);else{const t=_({state:e.leftAxisState,sources:e.leftAxisSources});m=null!==t?[t]:[]}let g;if(this._leftPriceScales.slice().forEach((e=>this.removePriceScale(e))),this._leftPriceScales=[],m.forEach((e=>this._placePriceScale(e,"left"))),e.rightAxisesState)g=p(e.rightAxisesState);else{const t=_({state:e.rightAxisState,sources:e.rightAxisSources});g=null!==t?[t]:[]}this._rightPriceScales.slice().forEach((e=>this.removePriceScale(e))),this._rightPriceScales=[],g.forEach((e=>this._placePriceScale(e,"right"))),this._currentPriceScaleRatio=e.priceScaleRatio||e.leftPriceScaleRatio||e.rightPriceScaleRatio||null;const S=new Map;for(const t of this.m_dataSources){if(h.has(t))continue;let i;if(e.overlayPriceScales&&e.overlayPriceScales[t.id()]){
let s=e.overlayPriceScales[t.id()];S.has(null==s?void 0:s.id)?i=S.get(null==s?void 0:s.id):(s=(0,o.ensure)(s),i=new Ie(this._model.properties().childs().scalesProperties),i.setHeight(this._height),s.m_isAutoScale=!0,s.m_isLog=!1,s.m_isPercentage=!1,s.m_isLockScale=!1,i.restoreState(s),S.set(s.id,i))}else i=new Ie(this._model.properties().childs().scalesProperties),i.setHeight(this._height);d(t,i)}for(const e of Object.keys(c)){const t=c[e],i=this.dataSourceForId(e);t&&i&&null===i.ownerSource()&&i.setOwnerSource(this.dataSourceForId(t))}if(e.mainSourceId&&!this.containsMainSeries()&&(this.m_mainDataSource=this.dataSourceForId(e.mainSourceId)),!this.m_mainDataSource)for(const e of this.m_dataSources)if((0,le.isPriceDataSource)(e)){this.m_mainDataSource=e;break}for(const e of this.m_dataSources)(0,b.isLineTool)(e)?(e.ownerSource()||e.setOwnerSource(this.mainDataSource()),e.isFixed()&&e.restoreFixedPoint()):(0,q.isStudy)(e)&&!e.ownerSource()&&e.isLinkedToSeries()&&e.setOwnerSource(this.model().mainSeries());this._updateMargins(),this._cachedOrderedSources.clear()}onPriceScalesChanged(){return this._onPriceScalesChanged}setPaneSize(e){let t;switch(e){case"large":t=1;break;case"medium":t=.6;break;case"small":t=.3;break;case"tiny":t=.15;break;default:throw new Error("Unknown size enum value: "+e)}this._stretchFactor=1e3*t}stretchFactor(){return this._stretchFactor}setStretchFactor(e){this._stretchFactor=e}customSources(e){return this.model().customSources(e)}createDrawingsCaches(){0}clearDrawingCaches(){0}executionsPositionController(){return null}width(){return this._width}height(){return this._height}setHeight(e){if(this._height!==e){this._height=e,this._leftPriceScales.forEach((t=>t.setHeight(e))),this._rightPriceScales.forEach((t=>t.setHeight(e)));for(let t=0;t<this.m_dataSources.length;t++){const i=this.m_dataSources[t];this.isOverlay(i)&&i.priceScale()&&(0,o.ensureNotNull)(i.priceScale()).setHeight(e)}this.updateAllViews((0,z.viewportChangeEvent)()),this._sizeChanged.fire()}}setWidth(e){this._width!==e&&(this._width=e,this.updateAllViews((0,z.viewportChangeEvent)()),this._sizeChanged.fire())}onSizeChanged(){return this._sizeChanged}onTagsChanged(){return this._tagsChanged}onDestroyed(){return this._destroyed}dataSourcesCollectionChanged(){return this._dataSourcesCollectionChanged}symbolSourceCollectionChanged(){return this._symbolSourceCollectionChanged}priceSourcesCollectionChanged(){return this._priceSourcesCollectionChanged}symbolSourceResolved(){return this._symbolSourceResolved}symbolSourceResolvingActive(){return this._symbolSourceResolvingActive}sourcePropertiesChanged(){return this._sourcePropertiesChanged}sourceZOrderChanged(){return this._sourcesZOrderChanged}lineToolsForArea(e){const t=this.height(),i=this.width(),s=this.logicalRectToPixels(e);return[...this.m_dataSources,...this.model().multiPaneSources(this)].filter(b.isLineTool).filter((e=>(e.paneViews(this)||[]).some((e=>{const r=e.renderer(t,i);return r&&r.doesIntersectWithBox&&r.doesIntersectWithBox(s)}))))}logicalRectToPixels(e){
const t=this.defaultPriceScale(),i=this.timeScale(),s=(0,o.ensureNotNull)((0,o.ensureNotNull)(t.mainSource()).firstValue()),r=t.priceToCoordinate(e.p1.price,s),a=i.indexToCoordinate(e.p1.index),l=t.priceToCoordinate(e.p2.price,s),c=i.indexToCoordinate(e.p2.index),h=new n.Point(Math.min(a,c),Math.min(r,l)),d=new n.Point(Math.max(a,c),Math.max(r,l));return(0,n.box)(h,d)}timeScale(){return this._timeScale}restoreLineTool(e,t,s,r,n){var a,l,h,d,u,_,p,m,g,S,v,f;delete e.state.lastUpdateTime,e.state.intervalsVisibilities=(0,Oe.mergeIntervalVisibilitiesDefaults)(e.state.intervalsVisibilities),s=void 0===s||s,Ve.LineToolElliott.migrateState(e),"LineToolGannComplex"!==(f=e).type||void 0!==f.version&&1!==f.version||(f.type="LineToolGannFixed"),Array.isArray(e.positionPercents)&&(e.positionPercents=e.positionPercents[0]);const y=e.type,C=e.id,w=e.state,P=s?e.zorder:this.newLineToolZOrder();(0,o.assert)((0,pe.isLineToolName)(y),"invalid data source type:"+y+" (expected to be a Line Tool)");let T,M,x=null;if((0,Ae.isStudyLineToolState)(e)){x=this._model.studyVersioning();const s=x.patchPointsBasedStudyState(e);e=s;const o=s.metaInfo;if(Object.assign(o,ie.StudyMetaInfo.parseIdString(null==o?void 0:o.fullId)),!t&&o){const t=o.productId;if(!(null===(a=window.pro)||void 0===a?void 0:a.hasPackage(t))){const t=new ne.StudyLineToolStub(this._model,e,o.shortDescription);return t.setId(C),this._addSourceToCollections(t,r),void 0!==P&&t.setZorder(P),t.setFailed(c.t(null,void 0,i(994125))),null}}const n=x.updateMetaInfo(o)||o;M=(0,b.createStudyLineToolProperties)(y,o,n,w,x),T=(0,b.createLineTool)(y,this._model,M,n,!0)}else M=(0,b.createLineToolProperties)(y,w,this._model),t?null===(l=M.child("fixedSize"))||void 0===l||l.setValue(!1):null===(h=M.child("fixedSize"))||void 0===h||h.setValue(!0),T=(0,b.createLineTool)(y,this._model,M,null,!0);T.setId(C),T.linkKey().setValue(e.linkKey||null);const I=e.alertId;I&&T.canHasAlert()&&O.enabled("alerts")&&!this._model.readOnly()&&!this._model.isJustClonedChart()&&T.setAlert(+I);let L=null!==(d=e.indexes)&&void 0!==d?d:[];if(L=L.slice(0,null!==(_=null===(u=e.points)||void 0===u?void 0:u.length)&&void 0!==_?_:L.length),T.isFixed()?void 0!==e.positionPercents?T.restorePositionPercents(e.positionPercents):T.restorePositionPercents({x:.5,y:.5}):e.points&&T.restorePoints(e.points,L,t),T instanceof Fe.LineToolBarsPattern||T instanceof We.LineToolCallout||T instanceof ze.LineToolTrendAngle||T instanceof He.LineToolGhostFeed||T instanceof Ue.LineToolParallelChannel||T instanceof re.LineToolTweet||T instanceof oe.LineToolIdea)null===(m=(p=T).restoreData)||void 0===m||m.call(p,e);else if(t&&(0,Ae.isStudyLineToolState)(e)&&T.restoreData){const t=e;x&&(t.graphics=x.patchPointsBasedStudyData(t.metaInfo,t.graphics)),null===(g=T.restoreData)||void 0===g||g.call(T,t)}const k=null==e.version?1:e.version,A=null==T.version?1:T.version;if(k!==A&&(null===(v=(S=T).migrateVersion)||void 0===v||v.call(S,k,A,{pane:this,model:this._model,properties:M})),void 0!==P&&T.setZorder(P),n)(0,
b.prepareLineToolPropertiesByOwnerSource)(T.properties(),n),T.setOwnerSource(n);else{const t=e.ownerSource?this.dataSourceForId(e.ownerSource):null;T.setOwnerSource(t)}return void 0!==e.sharingMode&&T.share(e.sharingMode),this._addSourceToCollections(T,r),this._cachedOrderedSources.clear(),T}restoreStudy(e,t,s,r,o){var n;if(t&&void 0===e.data&&void 0===e.nonSeriesData&&void 0===e.indexes)return qe.logError("Cannot restore (skipping) study without data "+e.id+", "+e.metaInfo.id),null;const a=e.id,l=e.state,c=e.zorder;s=null!=s?s:this._model.mainSeries().id();const h=(null!==(n=e.parentSources)&&void 0!==n?n:e.ownerSource?[e.ownerSource]:[]).filter((e=>e!==s));let d=(0,se.clone)(e.metaInfo);if(Object.assign(d,ie.StudyMetaInfo.parseIdString(d.id)),function(e){return"Script$TV_EARNINGS@tv-scripting"===e||"Script$TV_DIVIDENDS@tv-scripting"===e||"Script$TV_SPLITS@tv-scripting"===e||"ESD$TV_EARNINGS@tv-scripting"===e||"ESD$TV_DIVIDENDS@tv-scripting"===e||"ESD$TV_SPLITS@tv-scripting"===e||"Earnings@tv-basicstudies"===e||"Dividends@tv-basicstudies"===e||"Splits@tv-basicstudies"===e||"BarSetContinuousRollDates@tv-corestudies"===e}(d.id)&&!t)return qe.logNormal("Skipping study "+d.id),null;let u=l;const _=this._model.studyVersioning(),m=_.patchPropsStateAndMetaInfo(u,d,{oldShowStudyLastValueProperty:t&&!(null==r?void 0:r.showStudyLastValueProperty)});u=m.propsState,d=m.metaInfo;const g=new P.StudyStub(this._model,e,d.shortDescription);let S;g.setId(a),g.setZorder(c);const v=i=>{g.setStatus({type:De.StudyStatusType.Undefined});const s=i||new ie.StudyMetaInfo(d),r=Ne.instance(this._model),o=o=>{var n;const l=(0,T.prepareStudyPropertiesForLoadChart)(d,i,u,_),c=(0,q.createStudy)(this._model,l,o,s);if(c.setId(a),c.setOwnFirstValue(null!==(n=e.ownFirstValue)&&void 0!==n?n:null),e.customFields&&c.restoreStateCustomFields(e.customFields),t){const t=e,{data:i,nsData:s,indexes:r}=_.patchStudyData(d,t.data,t.nonSeriesData,t.indexes);c.restoreData(i,s,r)}this._model.replaceStudyStub(g,c)||(S=c),r.add(a,c)};if(h.length>0){const e=h.map((e=>r.get(e)));Promise.all(e).then(o)}else o([])};if(t)v(null);else{let e=null;this._model.isSnapshot()||(e=i.e(37819).then(i.bind(i,532338)).then((e=>{const{pineIdForJavaId:t,migrateJavaStateToPine:i}=e,s=t(d.id);return s?this.model().studyMetaInfoRepository().findById({pineId:s,pineVersion:"last",type:"pine"}).then((e=>(i(l,d,e),d=e,p.emit("chart_migrated"),e))):d})));const t=e=>{const t=_.updateMetaInfoAsync(e);t.sync?v(t.result):t.result.then(v).catch((e=>g.setFailed("error: "+e)))};e?e.then(t):t(d)}const f=null!=S?S:g;if(f){f.setZorder(c);const t=e.metaInfo.linkedToSeries?this._model.mainSeries():h.length?this.dataSourceForId(h[0]):null;f.setOwnerSource(t),this._addSourceToCollections(f,o),this._processMainSourceChange()}return this._cachedOrderedSources.clear(),f}clipboardLineToolOwnerSource(e){const t=this.dataSourceForId(e);if(null!==t){const e=t.ownerSource();if(null!==e&&null!==e.firstValue())return e}const i=this.mainDataSource();if(null!==i&&null!==i.firstValue())return i
;for(const e of this.dataSources())if((0,le.isPriceDataSource)(e)&&null!==e.firstValue())return e;return null}realignLineTools(e){var t;let i=!1;for(const s of this.m_dataSources)!(0,b.isLineTool)(s)||void 0!==e&&(null===(t=null==s?void 0:s.ownerSource())||void 0===t?void 0:t.symbolSource())!==e&&(0,ve.isActingAsSymbolSource)(e)||(s.realign(),s.updateAllViews((0,z.sourceChangeEvent)(s.id())),i=!0);return i&&this._invalidateSourcesCache(),i}startScalePrice(e,t){e.startScale(t)}scalePriceTo(e,t){e.scaleTo(t),this.updateAllViews((0,z.viewportChangeEvent)())}endScalePrice(e){e.endScale()}startScrollPrice(e,t){e.startScroll(t)}scrollPriceTo(e,t){e.scrollTo(t),this.updateAllViews((0,z.viewportChangeEvent)())}endScrollPrice(e){e.endScroll()}resetPriceScale(e){const t=this.timeScale().visibleBarsStrictRange();e.resetScaleAvailable().value()&&e.resetScale(),e.recalculatePriceRange(t),this.updateAllViews((0,z.viewportChangeEvent)())}resetPriceScalesAvailable(){return this._resetPriceScalesAvailable.readonly()}restorePriceScaleState(e,t){e.restoreState(t),this.updateAllViews((0,z.viewportChangeEvent)())}beginInsertManyLineDataSources(){this._isInInsertManyDataSourcesState=!0,this._lastLineDataSourceZOrder=null}endInsertManyLineDataSources(){this._isInInsertManyDataSourcesState=!1,this._lastLineDataSourceZOrder=null;{const e=(0,o.ensureNotNull)(this.model().alertsWatcher());for(const t of this.m_dataSources)e.syncSourceAlertLabels(t)}}removeSourceFromPriceScale(e){const t=e.priceScale();if(null!==t){const i=t.dataSources();i.indexOf(e)>=0&&t.removeDataSource(e),0===i.length&&this.removePriceScale(t)}}_invalidateSourcesCache(){this._cachedOrderedSources.clear(),this._leftPriceScales.forEach((e=>e.invalidateSourcesCache())),this._rightPriceScales.forEach((e=>e.invalidateSourcesCache()))}_processMainSourceChange(){let e=!1;if(null===this.m_mainDataSource)for(const t of this.m_dataSources)if((0,le.isPriceDataSource)(t)&&!this.isOverlay(t)&&(!(0,q.isStudy)(t)||!t.isLinkedToSeries())){this.m_mainDataSource=t,e=!0;break}if(this.m_mainDataSource&&e){let e=this.m_dataSources.filter(b.isLineTool);e=(0,ce.sortSources)(e);for(const t of e)this.move(t,(0,o.ensureNotNull)(this.m_mainDataSource.priceScale()),!0)}else if(!this.m_mainDataSource||this.isOverlay(this.m_mainDataSource)&&0===this._nonOverlayPricesSourcesCount()){let e=null;if(this.m_dataSources.includes(this._model.mainSeries()))e=this._model.mainSeries();else for(const t of this.m_dataSources)if((0,le.isPriceDataSource)(t)&&this.isOverlay(t)&&t.showInObjectTree()){e=t;break}if(null!==e){const t=this.m_mainDataSource===e;this.m_mainDataSource=e;const i=this.createNewPriceScaleIfPossible();if(t&&e===this._model.mainSeries()){const t=(0,o.ensureNotNull)(e.priceScale());this._model.children(e,!0).forEach((e=>{this.removeSourceFromPriceScale(e),i.addDataSource(e),e.setPriceScale(i)})),this.removePriceScale(t)}this.move(e,i,!0),this.recalculatePriceScale(e.priceScale(),(0,z.globalChangeEvent)())}}}_addSourceToCollections(e,t){this.m_dataSources.push(e),this._sourcesById.set(e.id(),e),
this._invalidateSourcesCache();const i=()=>{this._sourcePropertiesChanged.fire(e)};e.properties().subscribe(this,i),e.zOrderChanged().subscribe(this,(t=>this._sourcesZOrderChanged.fire(e,t))),(0,b.isLineTool)(e)&&(e.normalizedPointsChanged().subscribe(this,i),e.fixedPointChanged().subscribe(this,i),e.hasAlert.subscribe(i),e.sharingMode().subscribe(i),e.linkKey().subscribe(i),this._sourceWatchedValuesSubscriptions.set(e.id(),i));const s=(0,ve.isSymbolSource)(e)?e:null;(0,le.isPriceDataSource)(e)&&(this._priceSourcesById.set(e.id(),e),e.currencyChanged().subscribe(this,(()=>this._invalidateSourcesCache())),e.unitChanged().subscribe(this,(()=>this._invalidateSourcesCache())),this._priceDataSources.push(e),this._onPriceSourcesCollectionChanged(),null!==s&&(this._symbolSources.push(s),s.symbolResolved().subscribe(this,(()=>this._symbolSourceResolved.fire(e))),s.symbolResolvingActive().subscribe(this._recalcSymbolSourceResolvingActive),s.symbolHibernated().subscribe(this._onSymbolSourceCollectionChanged),this._recalcSymbolSourceResolvingActive(),this._onSymbolSourceCollectionChanged())),e.isMultiPaneAvailable()&&this.model().addMultiPaneSource(e),(0,ae.isLollipopDataSource)(e)&&(this._lollipopDataSources.push(e),this.updateLollipopViews((0,z.sourceChangeEvent)(e.id()))),t||0!==this._bulkActions.activeCounter||this._dataSourcesCollectionChanged.fire()}_removeSourceFromCollections(e,t){const i=this.m_dataSources[e];i.properties().unsubscribeAll(this),i.zOrderChanged().unsubscribeAll(this),this.m_dataSources.splice(e,1),this._sourcesById.delete(i.id());const s=i.id();if((0,b.isLineTool)(i)&&(i.normalizedPointsChanged().unsubscribeAll(this),i.fixedPointChanged().unsubscribeAll(this),this._sourceWatchedValuesSubscriptions.has(s))){const e=this._sourceWatchedValuesSubscriptions.get(s);i.hasAlert.unsubscribe(e),i.linkKey().unsubscribe(e)}this._invalidateSourcesCache();const r=(0,ve.isSymbolSource)(i)?i:null;(0,le.isPriceDataSource)(i)&&(this._priceSourcesById.delete(i.id()),i.currencyChanged().unsubscribeAll(this),i.unitChanged().unsubscribeAll(this),(0,v.removeItemFromArray)(this._priceDataSources,i),this._onPriceSourcesCollectionChanged(),null!==r&&((0,v.removeItemFromArray)(this._symbolSources,r),r.symbolResolved().unsubscribeAll(this),r.symbolResolvingActive().unsubscribe(this._recalcSymbolSourceResolvingActive),r.symbolHibernated().unsubscribe(this._onSymbolSourceCollectionChanged),this._recalcSymbolSourceResolvingActive(),this._onSymbolSourceCollectionChanged())),i.isMultiPaneAvailable()&&this.model().removeMultiPaneSource(i),(0,ae.isLollipopDataSource)(i)&&((0,v.removeItemFromArray)(this._lollipopDataSources,i),this.updateLollipopViews((0,z.sourceChangeEvent)(i.id()))),t||0!==this._bulkActions.activeCounter||this._dataSourcesCollectionChanged.fire()}_recalculatePriceScaleByScaleRatio(e){this.isMainPane()&&e===this._lockedPriceScale&&(null!==this._currentPriceScaleRatio?this._applyOldScaleRatioToPriceScale():this._tryToApplyNewPriceScaleRatio())}_defaultBottomMargin(){
return.01*this.properties().childs().bottomMargin.value()}_defaultTopMargin(){return.01*this.properties().childs().topMargin.value()}_updateMargins(){const e=this._defaultTopMargin(),t=this._defaultBottomMargin();for(const i of this._leftPriceScales)je(i,e,t);for(const i of this._rightPriceScales)je(i,e,t);for(const i of this.m_dataSources)if(this.isOverlay(i)){const s=i.priceScale();null!==s&&(je(s,e,t),this.recalculatePriceScale(s,(0,z.viewportChangeEvent)()))}for(const e of this._leftPriceScales)this.recalculatePriceScale(e,(0,z.viewportChangeEvent)());for(const e of this._rightPriceScales)this.recalculatePriceScale(e,(0,z.viewportChangeEvent)());this.updateAllViews((0,z.viewportChangeEvent)())}_batchReorder(e,t,i){i(this.sourcesByGroup().allExceptSpecialSources(),e,t),this._invalidateSourcesCache(),this._dataSourcesCollectionChanged.fire(),this.model().fullUpdate()}_placePriceScale(e,t,i){if("overlay"===t)return void e.invalidateMargins();const s="left"===t?this._leftPriceScales:this._rightPriceScales,r=void 0===i?s.length:i;s.splice(r,0,e),e.modeChanged().subscribe(this,this._onPriceScaleModeChanged.bind(this,e)),e.internalHeightChanged().subscribe(this,this._recalculatePriceScaleByScaleRatio.bind(this,e)),e.priceRangeChanged().subscribe(this,this._recalculateTimeScaleByScaleRatio.bind(this,e)),e.priceRangeChanged().subscribe(this,this._onPriceScaleSetMinMaxPriceRange.bind(this,e)),e.isVisible().subscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().subscribe(this._updateResetPriceScalesAvailableValue),e.isLockScale()&&((0,o.assert)(null===this._lockedPriceScale),this._lockedPriceScale=e,this._currentPriceScaleRatio=null),e.invalidateMargins(),this._onPriceScalesChanged.fire(),this._updateResetPriceScalesAvailableValue()}_onPriceScaleModeChanged(e,t,i){if(i.lockScale&&(this._lockedPriceScale!==e&&null!==this._lockedPriceScale&&this._lockedPriceScale.setMode({lockScale:!1}),this._lockedPriceScale=e,this._currentPriceScaleRatio=(0,Le.scaleRatio)(this.timeScale(),e)),t.lockScale&&!i.lockScale&&(this._lockedPriceScale=null,this._currentPriceScaleRatio=null),t.percentage===i.percentage&&t.indexedTo100===i.indexedTo100)return;const s=this.timeScale().visibleBarsStrictRange();null!==s&&(e.recalculatePriceRange(s),e.updateAllViews((0,z.viewportChangeEvent)()))}_applyOldScaleRatioToPriceScale(){this._isRecalculatingScales||null===this._currentPriceScaleRatio||null===this._lockedPriceScale||(this._isRecalculatingScales=!0,this._setNewPriceRangeByScaleRatio(this._lockedPriceScale,this._currentPriceScaleRatio,this._mainSourceVisiblePriceRange(this._lockedPriceScale)),this._isRecalculatingScales=!1)}_setNewPriceRangeByScaleRatio(e,t,i,s,r){const o=(0,Le.priceRangeByScaleRatio)(e,this.timeScale().barSpacing(),t);e.setPriceRange(null!==o?o:i,s,r)}_applyOldScaleRatioToTimeScale(){this._isRecalculatingScales||null===this._currentPriceScaleRatio||(this._isRecalculatingScales=!0,this._setNewBarSpacingByScaleRatio(),this._isRecalculatingScales=!1)}_tryToApplyNewPriceScaleRatio(){const e=(0,
o.ensureNotNull)(this._lockedPriceScale),t=(0,Le.scaleRatio)(this.timeScale(),e);this._currentPriceScaleRatio===t||e.isLog()||(this._currentPriceScaleRatio=t,this.model().mainSeriesScaleRatioPropertyOnChanged())}_recalculateTimeScaleByScaleRatio(e){e===this._lockedPriceScale&&(null!==this._currentPriceScaleRatio?this._applyOldScaleRatioToTimeScale():this._tryToApplyNewPriceScaleRatio())}_setNewBarSpacingByScaleRatio(){const e=this.timeScale().getValidBarSpacing((0,Le.barSpacingByScaleRatio)((0,o.ensureNotNull)(this._lockedPriceScale),this._currentPriceScaleRatio));this.timeScale().isValidBarSpacing(e)&&this.timeScale().setBarSpacing(e)}_mainSourceVisiblePriceRange(e){const t=this.timeScale().visibleBarsStrictRange();return null!==t?(0,o.ensureNotNull)((0,o.ensureNotNull)(e.mainSource()).priceRange(t.firstBar(),t.lastBar())):new me.PriceRange(-.5,.5)}_setMinMaxPriceRange(){const e=(0,o.ensureNotNull)(this._lockedPriceScale),t=(0,Le.priceRangeByScaleRatio)(e,this.timeScale().maxBarSpacing(),this._currentPriceScaleRatio),i=(0,Le.priceRangeByScaleRatio)(e,this.timeScale().minBarSpacing(),this._currentPriceScaleRatio);null!==t&&e.setMaxPriceRange(t),null!==i&&e.setMinPriceRange(i)}_onPriceScaleSetMinMaxPriceRange(e){e===this._lockedPriceScale&&this._setMinMaxPriceRange()}_onPriceSourcesCollectionChanged(){0===this._bulkActions.activeCounter?this._priceSourcesCollectionChanged.fire():this._bulkActions.priceSourcesCollectionChanged=!0}_nonOverlayPricesSourcesCount(){return this.m_dataSources.filter((e=>(!(0,q.isStudy)(e)||!e.isLinkedToSeries())&&((0,le.isPriceDataSource)(e)&&e.showInObjectTree()&&!this.isOverlay(e)))).length}_restoreMainSeries(e,t,i,s,r,o){var n,a;const l=e.id,c=e.state;if(c&&r&&(c.style=r.style||c.style,c.interval=r.interval||c.interval,r.symbol&&r.symbol!==c.symbol&&(c.symbol=r.symbol,delete c.currencyId,delete c.unitId)),c&&["candleStyle","hollowCandleStyle","haStyle"].forEach((e=>{c[e]&&(c[e].wickUpColor=c[e].wickUpColor||c[e].wickColor,c[e].wickDownColor=c[e].wickDownColor||c[e].wickColor)})),c&&(c.statusViewStyle=c.statusViewStyle||{},!c.statusViewStyle.symbolTextSource)){const e=!!c.statusViewStyle.showSymbolAsDescription;c.statusViewStyle.symbolTextSource=e?"ticker":"description"}if(c){c.extendedHours?c.sessionId="extended":c.sessionId||(c.sessionId="regular"),delete c.extendedHours,(0,Ge.allChartStyles)().includes(c.style)||(c.style=2);const e=c.lineStyle.styleType;let t;delete c.lineStyle.styleType,0===e&&(t=14,c.lineWithMarkersStyle=(0,se.clone)(c.lineStyle)),1===e&&(t=15,c.steplineStyle=(0,se.clone)(c.lineStyle)),void 0!==t&&2===c.style&&(c.style=t)}if(!i){const e=this._model.mainSeries();this._model.mainPane().removeDataSource(e,!1,o),this._addSourceToCollections(e,o)}const h=this.model().mainSeries(),d=h.properties().childs();this.m_mainDataSource=h;const u=c&&c.style?c.style:void 0
;if(6===u&&"ATR"===d.pnfStyle.childs().inputs.childs().style.value()?d.pnfStyle.childs().inputs.childs().style.setValueSilently("Traditional"):4===u&&"ATR"===d.renkoStyle.childs().inputs.childs().style.value()&&d.renkoStyle.childs().inputs.childs().style.setValueSilently("Traditional"),c&&!c.hasOwnProperty("showSessions")&&(c.showSessions=!1),c&&void 0===c.settlementAsClose&&(c.settlementAsClose=!1),c&&t&&(c.showCountdown=!1),c&&(t&&!("showSeriesLastValueProperty"in s)&&"showLastValue"in c&&this._model.properties().childs().scalesProperties.childs().showSeriesLastValue.setValue(c.showLastValue),delete c.showLastValue),c){const t={haStyle:(0,F.chartStyleStudyId)(8,!0),renkoStyle:(0,F.chartStyleStudyId)(4,!0),pbStyle:(0,F.chartStyleStudyId)(7,!0),kagiStyle:(0,F.chartStyleStudyId)(5,!0),pnfStyle:(0,F.chartStyleStudyId)(6,!0),rangeStyle:(0,F.chartStyleStudyId)(11,!0)},i=this._model.studyVersioning(),s=h.styleStudyInfos(),r=Object.keys(Ee.SYMBOL_STRING_DATA);for(let o=0;o<r.length;o++){const n=Ee.STYLE_SHORT_NAMES[r[o]]+"Style",a=n in e?e[n].studyId:t[n],l=c[n];if(null==l)continue;const h=l.inputs,d=ie.StudyMetaInfo.parseIdString(a),u=s[n].studyId,_=ie.StudyMetaInfo.parseIdString(u),p=i.updateStudyInputs(d.id,d.version,_.version,h,null);l.inputs=p}}const _=h.sessionId();null===(n=(0,ee.getPersistentLogger)())||void 0===n||n.addPersistentLogEntry(`Restore series. source.id: ${e.id} id: ${l}`,Q.LOGLEVEL.INFO,Ye),h.restoreState(e,t),this.changeSourceId(h,l),null===(a=(0,ee.getPersistentLogger)())||void 0===a||a.addPersistentLogEntry(`Series has been successfully restored. id: ${h.id()}`,Q.LOGLEVEL.INFO,Ye),h.sessionId()!==_&&d.sessionId.listeners().fire(d.sessionId)}_restoreSpecialSource(e,t,i){"ChartEventsSource"===e.type&&t&&this._model.restoreChartEvents(e)}}var Xe=i(81979),$e=i(329806),Ze=i(384874),Qe=i(549621);const Je=(0,Q.getLogger)("Chart.TimePoints");function et(e,t){return null===e||null===t?e===t:e.firstIndex===t.firstIndex&&e.lastIndex===t.lastIndex}class tt{constructor(){this._zoffset=0,this._items=[],this._range=new K.WatchedObject(null,et)}clear(){this._zoffset=0,this._items=[],this._range.setValue(null)}size(){return this._items.length}range(){return this._range.readonly()}merge(e,t,i){const s=this._mergeImpl(e,t,i);return this._updateFirstAndLastIndex(),s}addTail(e,t){for(let i=t?1:0;i<e.length;i++)this._items.push(e[i]);this._updateFirstAndLastIndex()}remove(e){const t=this._indexToOffset(e);if(null===t)return[];const i=this._items.splice(t),s=[];for(let t=0;t<i.length;t++)s.push({change:"remove",index:e+t,value:i[t]});return this._updateFirstAndLastIndex(),s}valueAt(e){const t=this._indexToOffset(e);return null!==t?this._items[t]:null}indexOf(e,t){if(this._items.length<1)return null;if(e>this._items[this._items.length-1])return t?this._validOffsetToIndex(this._items.length-1):null;for(let i=0;i<this._items.length;++i){if(e===this._items[i])return this._validOffsetToIndex(i);if(e<this._items[i])return t?this._validOffsetToIndex(i):null}return null}state(e){var t,i;let s=0,r=this._items.length
;return null!==e&&(s=null!==(t=this._indexToOffset(e.firstBar()))&&void 0!==t?t:0,r=(null!==(i=this._indexToOffset(e.lastBar()))&&void 0!==i?i:r-1)+1),{items:this._items.slice(s,r),zoffset:this._zoffset-s}}restoreState(e){null!==e&&(this._items=e.items,this._zoffset=e.zoffset,this._updateFirstAndLastIndex())}roughTime(e,t=null){e=Math.round(e);const i=this.valueAt(e);if(null!==i)return i;const s=this._items;if(!s.length||s.length<2)return null;const r=s.length-1,o=this._validOffsetToIndex(0),n=this._validOffsetToIndex(r),a=s[0],l=s[r],c=(l-a)/(n-o);if(e<o){return a-(o-e)*c}if(e>n){const i=e-n;if(i<500&&null!=t)return t(l,i);return l+i*c}return null}roughIndex(e,t=null){const i=this._items;if(!i.length||i.length<2)return null;const s=i.length-1,r=this._validOffsetToIndex(0),o=this._validOffsetToIndex(s),n=i[0],a=i[s];if(e>=n&&e<=a)return this.closestIndexLeft(e);const l=(a-n)/(o-r);if(e<n){const t=n-e;return r-Math.round(t/l)}if(e>a){const i=e-a;let s=Math.trunc(i/l);if(s<500&&null!==t){const i=t(a,e);i.success&&(s=i.result)}return o+s}return null}closestIndexLeft(e){const t=this._items;if(!t.length)return null;if(Number.isNaN(e))return null;let i=t.length-1;if(e>=t[i])return this._validOffsetToIndex(i);let s=0;const r=t[s];if(e<r)return null;if(e===r)return this._validOffsetToIndex(s);for(;i>s+1;){const r=s+i>>1,o=t[r];if(o>e)i=r;else{if(!(o<e))return o===e?this._validOffsetToIndex(r):null;s=r}}return this._validOffsetToIndex(s)}_mergeImpl(e,t,i){if(0===i.length)return Je.logError("merge: 'values' does not contain any time points"),[];if(t>this._zoffset&&e+t>0)return Je.logError("merge: when the first time point index is updated, we should fill the time points starting from the first one"),[];if(0===this._items.length)return this._items=i.slice(),this._zoffset=t,[{change:"rebuild",index:this._validOffsetToIndex(0)}];const s=e+this._zoffset;if(s<0){const r=Math.abs(s);if(i.length<r)return Je.logError("merge: 'values' does not contain enough time points to fill in the new items. 'index': "+e.toString()+", previous 'zoffset': "+this._zoffset.toString()+", new 'zoffset': "+t.toString()+", 'values.length': "+i.length),[];this._items=new Array(r).concat(this._items),this._zoffset=t;for(let s=0;s<i.length;++s)this._items[e+s+t]=i[s];return[{change:"rebuild",index:this._validOffsetToIndex(0)}]}const r=[];let o=s;for(;o<this._items.length&&o-s<i.length;++o)this._items[o]=i[o-s],r.push({change:"update",index:this._validOffsetToIndex(o),value:i[o-s]});const n=s+i.length;if(n>this._items.length){const e=n-this._items.length;for(let t=o;t<o+e;++t){const e=this._items.length;this._items.push(i[t-s]),r.push({change:"append",index:this._validOffsetToIndex(e),value:i[t-s]})}}else{for(let e=n;e<this._items.length;++e)r.push({change:"remove",index:this._validOffsetToIndex(e),value:this._items[e]});this._items.length=n}return this._zoffset=t,r}_updateFirstAndLastIndex(){const e=this._offsetToIndex(0),t=this._offsetToIndex(this._items.length-1);this._range.setValue(null===e||null===t?null:{firstIndex:e,lastIndex:t})}
_validOffsetToIndex(e){return e-this._zoffset}_offsetToIndex(e){return 0<=e&&e<this.size()?this._validOffsetToIndex(e):null}_indexToOffset(e){const t=e+this._zoffset;return 0<=t&&t<this.size()?t:null}}var it=i(732149);const st=new Map([[0,.1],[11,.1],[1,.35],[9,.35],[12,.35],[8,.35]]);class rt{constructor(e,t){this._styleSpecificRanges=new Map,this._logicalRange=e,this._defaultStyle=t}strictRange(e){if(null===this._logicalRange)return null;void 0===e&&(e=this._defaultStyle);let t=this._styleSpecificRanges.get(e);if(void 0===t){const i=(st.get(e)||0)/2;t=new Ze.BarsRange(Math.floor(this._logicalRange.left()+i),Math.ceil(this._logicalRange.right()-i)),this._styleSpecificRanges.set(e,t)}return t}logicalRange(){return this._logicalRange}isValid(){return null!==this._logicalRange}static invalid(){return new rt(null,1)}}var ot=i(167258),nt=i(970109);class at{constructor(e,t=50){this._actualSize=0,this._usageTick=1,this._oldestTick=1,this._cache=new Map,this._tick2Labels=new Map,this._format=e,this._maxSize=t}format(e){const t=this._cache.get(e.valueOf());if(void 0!==t)return t.string;if(this._actualSize===this._maxSize){const e=this._tick2Labels.get(this._oldestTick);this._tick2Labels.delete(this._oldestTick),this._cache.delete((0,o.ensureDefined)(e)),this._oldestTick++,this._actualSize--}const i=this._format(e);return this._cache.set(e.valueOf(),{string:i,tick:this._usageTick}),this._tick2Labels.set(this._usageTick,e.valueOf()),this._actualSize++,this._usageTick++,i}}var lt=i(551775);let ct;var ht=i(827023),dt=i(716714),ut=i(464539),_t=i(534741),pt=i(764005);const mt={duration:250,easing:Xe.easingFunc.easeOutCubic};class gt{constructor(e){this._onFinishCalled=!1,this._options={...mt,...e},this._startTime=performance.now()}getPosition(e){const t=this._calculateProgress(e);return 1===t?(this._options.onFinish&&!this._onFinishCalled&&(this._options.onFinish(!0),this._onFinishCalled=!0),this._options.to):(0,pt.lerp)(this._options.from,this._options.to,this._options.easing(t))}finished(e){return 1===this._calculateProgress(e)}onFinish(e){var t,i;this._onFinishCalled||(null===(i=(t=this._options).onFinish)||void 0===i||i.call(t,e),this._onFinishCalled=!0)}_calculateProgress(e){const t=e-this._startTime;return t>=this._options.duration?1:t/this._options.duration}}const St={preserveBarSpacing:!1,lockVisibleTimeRangeOnResize:!1,rightBarStaysOnScroll:!0,minBarSpacing:.5},vt=O.enabled("low_density_bars"),ft=vt?1:2,bt=(0,Q.getLogger)("Chart.TimeScale");class yt{constructor(e,t){this._width=0,this._widthChanged=new j.Delegate,this._rightOffset=10,this._rightOffsetChanged=new j.Delegate,this._maxRightOffsetChanged=new j.Delegate,this._defaultRightOffset=new Y.WatchedValue(10),this._defaultRightOffsetPercentage=new Y.WatchedValue(5),this._usePercentageRightOffset=new Y.WatchedValue(!1),this._lastDefaultRightOffset=void 0,this._baseIndex=null,this._leftEdgeIndex=null,this._barSpacingChanged=new j.Delegate,this._barSpacing=6,this._visibleBars=rt.invalid(),this._visibleBarsInvalidated=!0,this._visibleBarsChanged=new j.Delegate,
this._logicalRangeChanged=new j.Delegate,this._points=new tt,this._tickMarks=new ot.Tickmarks,this._onScroll=new j.Delegate,this._resetDelegate=new j.Delegate,this._scrollStartPoint=null,this._scaleStartPoint=null,this._commonTransitionStartState=null,this._formattedBySpan=new Map,this._requestingMoreData=!1,this._requestedTickmarksCount=0,this._endOfData=!1,this._lockBarsAndLogicalRangeEvents=!1,this._timeout=void 0,this._prevRO=void 0,this._resetAvailable=new Y.WatchedValue(!1),this._options=(0,$e.deepExtend)({},St,t),this._model=e,this._scalesProperties=e.properties().childs().scalesProperties,this._defaultRightOffset.subscribe((()=>{this._usePercentageRightOffset.setValue(!1),this._defaultRightOffsetOptionsUpdated()})),this._defaultRightOffsetPercentage.subscribe((e=>{if(e>=100||e<0){const t=Math.max(0,Math.min(e,99));this._defaultRightOffsetPercentage.setValue(t)}else this._usePercentageRightOffset.setValue(!0),this._defaultRightOffsetOptionsUpdated()})),this._usePercentageRightOffset.subscribe((()=>{this._defaultRightOffsetOptionsUpdated()})),this._options.preserveBarSpacing&&(this._barSpacing=this._scalesProperties.childs().barSpacing.value()||6),this._barSpacingChanged.subscribe(this,this._maxRightOffsetOnChanged),this._barSpacingChanged.subscribe(this,this._updateResetAvailableValue),this._rightOffsetChanged.subscribe(this,this._updateResetAvailableValue),this._widthChanged.subscribe(this,this._maxRightOffsetOnChanged),this._updateResetAvailableValue()}destroy(){this._barSpacingChanged.unsubscribeAll(this),this._barSpacingChanged.destroy(),this._widthChanged.unsubscribeAll(this),this._widthChanged.destroy()}isEmpty(){return 0===this._width||!this.canNormalize()}canNormalize(){return this._points.size()>0}update(e,t,i,s){this._visibleBarsInvalidated=!0,i.length>0&&this._points.merge(e,t,i),this._tickMarks.merge(s),this.correctOffset()}addTail(e,t,i){this._tickMarks.removeTail(t);const s=e.params,r=(0,o.ensureDefined)(this._tickMarks.maxIndex)+(i?0:1);for(let e=0;e<s.marks.length;e++)s.marks[e].index=r+e;this._tickMarks.addTail(s.marks),this._points.addTail(s.changes,i);const n=this._rightOffset-s.changes.length;this._updateRightOffset(n)}state(e){const t={m_barSpacing:this.barSpacing(),m_rightOffset:this._defaultRightOffset.value(),rightOffsetPercentage:this._defaultRightOffsetPercentage.value(),usePercentageRightOffset:this._usePercentageRightOffset.value()};if(e){t.m_rightOffset=Math.max(0,this._rightOffset);const e=this.visibleExtendedDataRange(this._model.mainSeries().data(),0);t.points=this._points.state(e),t.tickmarks=this._tickMarks.state(e),t.width=this._width}return t}restoreState(e,t){if(void 0===e.m_barSpacing)return void bt.logDebug("restoreState: invalid state");if(void 0===e.m_rightOffset)return void bt.logDebug("restoreState: invalid state");let i=e.m_barSpacing;const s=e.m_rightOffset<0&&!t?this.rightOffsetDefaultValue():e.m_rightOffset,r=s<0?this.rightOffsetDefaultValue():Math.round(s);this._defaultRightOffset.setValue(r),
void 0!==e.rightOffsetPercentage&&Number.isFinite(e.rightOffsetPercentage)&&this._defaultRightOffsetPercentage.setValue(e.rightOffsetPercentage),this._usePercentageRightOffset.setValue(Boolean(e.usePercentageRightOffset)),this._rightOffset=s,t&&(this._requestedTickmarksCount=1/0,this._endOfData=!0,this._points.restoreState(e.points||null),this._tickMarks.restoreState(e.tickmarks||null),e.width&&this._width>0&&(i*=this._width/e.width)),this._tryToUpdateBarSpacing(this._barSpacing,i),this.correctOffset(),this._usePercentageRightOffset.value()&&(this._rightOffset=this.percentsToBarIndexLength(this._defaultRightOffsetPercentage.value())),this._rightOffsetChanged.fire(this._rightOffset)}marks(){if(this.isEmpty())return null;const e=this._barSpacing,t=5*((this._scalesProperties.childs().fontSize.value()||0)+4),i=Math.round(t/e),s=(0,o.ensureNotNull)(this.visibleBarsStrictRange()),r=Math.max(s.firstBar(),s.firstBar()-i),n=Math.max(s.lastBar(),s.lastBar()-i),a=this._tickMarks.build(e,t),l=[];for(const e of a){if(!(r<=e.index&&e.index<=n))continue;const t=this._tickMarks.indexToTime(e.index);null!==t&&l.push({coord:this.indexToCoordinate(e.index),label:this.formatLabel(t,e.span),span:e.span,major:e.label>=nt.DAY_SPAN})}return l}visibleBarsStrictRange(){return this._visibleBarsInvalidated&&(this._visibleBarsInvalidated=!1,this._updateVisibleBars()),this._visibleBars.strictRange()}visibleBarsStrictRangeChanged(){return this._visibleBarsChanged}visibleStrictDataRange(e){const t=this.visibleBarsStrictRange();if(null===t)return null;const i=e.search(t.firstBar(),_t.PlotRowSearchMode.NearestRight),s=e.search(t.lastBar(),_t.PlotRowSearchMode.NearestLeft);return null===i||null===s?null:new Ze.BarsRange(i.index,s.index)}visibleExtendedDataRange(e,t){const i=this.visibleBarsStrictRange();if(null===i)return null;let s=1===t?null:e.search(i.firstBar()-1,_t.PlotRowSearchMode.NearestLeft),r=0===t?null:e.search(i.lastBar()+1,_t.PlotRowSearchMode.NearestRight);return null===s&&(s=e.search(i.firstBar(),_t.PlotRowSearchMode.NearestRight)),null===r&&(r=e.search(i.lastBar(),_t.PlotRowSearchMode.NearestLeft)),null===s||null===r?null:new Ze.BarsRange(s.index,r.index)}logicalRangeChanged(){return this._logicalRangeChanged}tickMarks(){return this._tickMarks}points(){return this._points}width(){return this._width}setWidth(e,t){if(!Number.isFinite(e)||e<=0)return void bt.logWarn(`setWidth: invalid argument: ${e}`);if(this._width===e)return;const i=this._usePercentageRightOffset.value()&&this._rightOffset>0?this.barIndexLengthToPercents(this._rightOffset):-1;if(this._visibleBarsInvalidated=!0,(t||this._options.lockVisibleTimeRangeOnResize)&&this._width){const t=this._barSpacing*e/this._width;this._tryToUpdateBarSpacing(this._barSpacing,t)}else this._width&&this.setBarSpacing(this._barSpacing);if(null!==this._leftEdgeIndex){if((0,o.ensureNotNull)(this.visibleBarsStrictRange()).firstBar()<=this._leftEdgeIndex){const t=this._width-e;this._rightOffset-=Math.round(t/this._barSpacing)+1}}this._width=e,this._widthChanged.fire(e);const s=this._rightOffset
;i>0?this._rightOffset=this.percentsToBarIndexLength(i):this.correctOffset(),this._rightOffset!==s&&this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}setLeftEdgeFix(e){this._leftEdgeIndex=e;const t=this.visibleBarsStrictRange();if(null===t)return;const i=t.firstBar()-e;if(i<0){const e=this._rightOffset-i-1;this.scrollToOffsetAnimated(e,500)}}indexToCoordinate(e){if(this.isEmpty())return 0;const t=this.baseIndex()+this._rightOffset-e;return this._width-(t+.5)*this._barSpacing}indexToUserTime(e){return this._tickMarks.indexToTime(e)}timePointToIndex(e,t){switch(t){case 0:return this._points.indexOf(e,!1);case 1:return this._points.closestIndexLeft(e);default:return this._points.indexOf(e,!0)}}indexToTimePoint(e){return this._points.valueAt(e)}timeToCoordinate(e){const t=this._points.closestIndexLeft(e);if(null===t)return null;const i=(0,o.ensureNotNull)(this._points.valueAt(t)),s=this.indexToCoordinate(t);if(s<=0||s>=this._width)return null;const r=this.barSpacing(),n=this.baseIndex(),a=s+(e-i)/((0,o.ensureNotNull)(this._points.valueAt(n))-(0,o.ensureNotNull)(this._points.valueAt(n-1)))*r+1;return a<=0||a>=this._width?null:a}barIndexesToCoordinates(e){const t=this.baseIndex();for(const i of e){const e=i.time,s=t+this._rightOffset-e,r=this._width-(s+.5)*this._barSpacing;i.time=r}}timedValuesToCoordinates(e,t,i){var s,r;const o=this.baseIndex()+this._rightOffset,n=this._width-o*this._barSpacing-.5*this._barSpacing,a=null!==(s=null==t?void 0:t.startItemIndex)&&void 0!==s?s:0;let l=a;const c=null!==(r=null==t?void 0:t.endItemIndex)&&void 0!==r?r:e.length;!0===i&&(l=(0,v.upperbound)(e,it.UNPLOTTABLE_TIME_POINT_INDEX,((e,t)=>e<t.x),a,c));for(let t=l;t<c;++t){const i=e[t];i.x=n+i.x*this._barSpacing}for(let t=a;t<l;++t)e[t].x=-500}indexesToCoordinates(e,t){if(this.isEmpty())return;void 0===t&&(t=e.length);const i=this.baseIndex()+this._rightOffset,s=this._width-i*this._barSpacing-.5*this._barSpacing,r=this._barSpacing,o=e;for(let i=0;i<t;++i)(0,se.isInteger)(e[i])?o[i]=s+e[i]*r:o[i]=0}rightOffsetForTimePoint(e){const t=this.timeToCoordinate(e);return null===t?null:this._rightOffsetForCoordinate(t)}scrollToRealtime(e,t){let i=this.targetDefaultRightOffset();i<0&&(i=this.rightOffsetDefaultValue());const s=()=>{void 0!==t&&t(),this._requestMoreData()};if(e){const e=this._rightOffset,t=this.maxRightOffset();return t>0&&i>t&&(i=t),void this._model.setTimeScaleAnimation(new gt({from:e,to:i,duration:1e3,easing:Xe.easingFunc.easeInOutQuint,onFinish:s}))}this._visibleBarsInvalidated=!0,this._updateRightOffset(i),this._onScroll.fire(),s()}scrollToFirstBar(e=(()=>{})){this._model.gotoTime(new Date("1800-01-01").getTime()).then(e),this._onScroll.fire()}scrollToOffsetAnimated(e,t){if(!isFinite(e))throw new RangeError("offset is required and must be finite number");const i=void 0===t?400:t;if(!isFinite(i)||i<=0)throw new RangeError("animationDuration (optional) must be finite positive number");const s=this._rightOffset,r=Date.now(),o=()=>{this._visibleBarsInvalidated=!0;const t=(Date.now()-r)/i
;if(t>=1)return this._updateRightOffset(e),this._visibleBarsInvalidated=!0,this._model.recalculateAllPanes((0,z.viewportChangeEvent)()),void this._model.lightUpdate();const n=s+(e-s)*t;this._updateRightOffset(n),this._model.recalculateAllPanes((0,z.viewportChangeEvent)()),setTimeout(o,20)};o()}defaultRightOffset(){return this._defaultRightOffset}rightOffsetDefaultValue(){return 10}defaultRightOffsetPercentage(){return this._defaultRightOffsetPercentage}usePercentageRightOffset(){return this._usePercentageRightOffset}barSpacing(){return this._barSpacing}setBarSpacing(e){Number.isFinite(e)?(e=this.getValidBarSpacing(e),this._tryToUpdateBarSpacing(this._barSpacing,e)&&(this.correctOffset(),this._options.preserveBarSpacing&&((0,x.saveDefaultProperties)(!0),this._scalesProperties.childs().barSpacing.setValue(this._barSpacing),(0,x.saveDefaultProperties)(!1)),this._model.recalculateAllPanes((0,z.viewportChangeEvent)()),this._model.lightUpdate())):bt.logWarn(`setBarSpacing: invalid argument: ${e}`)}barSpacingChanged(){return this._barSpacingChanged}getValidBarSpacing(e){return null==e&&(e=this.barSpacing()),e<this.minBarSpacing()?this.minBarSpacing():e>this.maxBarSpacing()?this.maxBarSpacing():e}isValidBarSpacing(e){return e>=this.minBarSpacing()&&e<=this.maxBarSpacing()}preserveBarSpacing(){return this._options.preserveBarSpacing}normalizeBarIndex(e){let t=0,i=0;const s=this.baseIndex(),r=(0,o.ensureNotNull)(this._points.range().value()).firstIndex;return e<r?(t=(0,o.ensureNotNull)(this._points.valueAt(r)),i=e-r):e>s?(t=(0,o.ensureNotNull)(this._points.valueAt(s)),i=e-s):(t=(0,o.ensureNotNull)(this._points.valueAt(e)),i=0),{time_t:t,offset:i}}denormalizeTimePoint(e){const t=this._points.indexOf(e.time_t,!1);if(null!==t)return t+e.offset}rightOffset(){return this._rightOffset}rightOffsetChanged(){return this._rightOffsetChanged}minRightOffset(){var e;const t=null===(e=this.points().range().value())||void 0===e?void 0:e.firstIndex,i=this._baseIndex;if(void 0===t||null===i)return null;if(null!==this._leftEdgeIndex){const e=this.width()/this._barSpacing;return this._leftEdgeIndex-i+e-1}return t-i-1+ft}maxRightOffset(){return this.width()/this._barSpacing-ft}maxRightOffsetChanged(){return this._maxRightOffsetChanged}onReset(){return this._resetDelegate}scrollStartPoint(){return this._scrollStartPoint}baseIndex(){return this._baseIndex||0}zoom(e,t,i){if(!Number.isFinite(e)||!Number.isFinite(t))return void bt.logWarn(`zoom: invalid arguments: ${e}, ${t}, ${i}`);const s=this.rightOffset(),r=void 0!==i?!i:this._options.rightBarStaysOnScroll,o=r&&this.usePercentageRightOffset().value()&&s>=0,n=o?this.barIndexLengthToPercents(s):void 0,a=this.coordinateToIndex(e),l=this.barSpacing(),c=l+t*(l/10);this.setBarSpacing(c),r||this.setRightOffset(s-.5+(a-this.coordinateToFloatIndex(e))),o&&void 0!==n&&this.setRightOffset(this.percentsToBarIndexLength(n)),this._requestMoreData()}zoomToBarsRange(e,t){if(null!==this._leftEdgeIndex&&(e=Math.max(e,this._leftEdgeIndex)),t<=e)return;const i=this.baseIndex(),s=this._rightOffset
;this._rightOffset=t-i;const r=Math.max(t-e+1,ft);this.setBarSpacing(this.width()/r),this._visibleBarsInvalidated=!0,this.correctOffset(),this._rightOffset!==s&&this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}coordinateToIndex(e){return Math.round(this.coordinateToFloatIndex(e))}coordinateToFloatIndex(e){const t=this._rightOffsetForCoordinate(e),i=this.baseIndex()+this.rightOffset()-t;return Math.round(1e6*i)/1e6}coordinateToVisibleIndex(e){let t=this.coordinateToIndex(e);const i=this.visibleBarsStrictRange();return null===i||i.contains(t)||(t=Math.min(Math.max(i.firstBar(),t),i.lastBar())),t}canZoomIn(){return this.barSpacing()<this.maxBarSpacing()}canZoomOut(){return this.barSpacing()>this._options.minBarSpacing}minBarSpacing(){return this._options.minBarSpacing}maxBarSpacing(){const e=this.width();return vt?e:e/ft}minVisibleBarCount(){return ft}resetRightOffset(){this.setRightOffset(this.targetDefaultRightOffset())}reset(){this._visibleBarsInvalidated=!0,this._points.clear(),this._scrollStartPoint=null,this._scaleStartPoint=null,this._clearCommonTransitionsStartState(),this._tickMarks.reset(),this._leftEdgeIndex=null,this._resetDelegate.fire(),this.disconnect()}resetAvailable(){return this._resetAvailable.readonly()}disconnect(){this._requestingMoreData=!1,this._requestedTickmarksCount=0,this._endOfData=!1}setBaseIndex(e){Number.isFinite(e)?(this._visibleBarsInvalidated=!0,this._baseIndex=e,this.correctOffset()):bt.logDebug(`setBaseIndex: invalid argument: ${e}`)}resetBaseIndex(){this._visibleBarsInvalidated=!0,this._baseIndex=null}setRightOffset(e){Number.isFinite(e)?(this._visibleBarsInvalidated=!0,this._updateRightOffset(e)):bt.logWarn(`setRightOffset: invalid argument: ${e}`)}correctBarSpacing(){this.isEmpty()||this.points().size()<this.width()/this.barSpacing()&&(this.setRightOffset(this.targetDefaultRightOffset()),this.setBarSpacing(this.width()/(this.points().size()+this.rightOffset())))}correctOffset(){const e=this.maxRightOffset();this._rightOffset>e&&(this._rightOffset=e,this._visibleBarsInvalidated=!0);const t=this.minRightOffset();null!==t&&this._rightOffset<t&&(this._rightOffset=t,this._visibleBarsInvalidated=!0)}logicalRange(){return this._visibleBarsInvalidated&&(this._visibleBarsInvalidated=!1,this._updateVisibleBars()),this._visibleBars.logicalRange()}restoreDefault(){this._visibleBarsInvalidated=!0,this._lockBarsAndLogicalRangeEvents=!0;const e=this._visibleBars;this.setBarSpacing(6),this.resetRightOffset(),this._lockBarsAndLogicalRangeEvents=!1,this._fireVisibleBarsChangedIfRequired(e,this._visibleBars),this._requestMoreData()}startScale(e){this._scrollStartPoint&&this.endScroll(),null===this._scaleStartPoint&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scaleStartPoint=e,this._saveCommonTransitionsStartState()))}scaleTo(e){if(null===this._commonTransitionStartState)return;const t=(0,be.clamp)(this._width-e,0,this._width),i=(0,be.clamp)(this._width-(0,o.ensureNotNull)(this._scaleStartPoint),0,this._width);if(0===t||0===i)return
;const s=this.barIndexLengthToPercents(this.rightOffset());this.setBarSpacing(this._commonTransitionStartState.barSpacing*t/i),this.usePercentageRightOffset().value()&&this.setRightOffset(this.percentsToBarIndexLength(s))}endScale(){null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._clearCommonTransitionsStartState(),this._requestMoreData())}startScroll(e){null===this._scrollStartPoint&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scrollStartPoint=e,this._saveCommonTransitionsStartState()))}scrollTo(e){if(this._visibleBarsInvalidated=!0,null===this._scrollStartPoint)return;const t=(this._scrollStartPoint-e)/this.barSpacing(),i=(0,o.ensureNotNull)(this._commonTransitionStartState).rightOffset+t;this._updateRightOffset(i),this._onScroll.fire()}endScroll(){if(null===this._scrollStartPoint)return clearInterval(this._timeout),void(this._prevRO=void 0);this._scrollStartPoint=null,this._clearCommonTransitionsStartState(),this._requestMoreData(),this._timeout=setInterval((()=>{this._prevRO!==this.rightOffset()&&(this._prevRO=this.rightOffset(),this._requestMoreData())}),100)}formatLabel(e,t){const i="24-hours"===ht.timeHoursFormatProperty.value()?t.toString():`${t}_ampm`;let s=this._formattedBySpan.get(i);return void 0===s&&(s=new at((e=>this.formatLabelImpl(e,t))),this._formattedBySpan.set(i,s)),s.format(new Date(e))}formatLabelImpl(e,t){if(!(e&&e instanceof Date))return"incorrect time";const s=function(e,t){if(e<nt.MINUTE_SPAN&&t)return"TimeWithSeconds";if(e<nt.DAY_SPAN&&t)return"Time";if(e<nt.WEEK_SPAN)return"DayOfMonth";if(e<nt.MONTH_SPAN)return"DayOfMonth";if(e<nt.YEAR_SPAN)return"Month";return"Year"}(t,!this._model.mainSeries().isDWM());return null!==lt.customFormatters.tickMarkFormatter?lt.customFormatters.tickMarkFormatter(e,s):function(e,t){switch(t){case"TimeWithSeconds":case"Time":const s="TimeWithSeconds"===t?(0,ut.getHourMinuteSecondFormat)(ht.timeHoursFormatProperty.value()):(0,ut.getHourMinuteFormat)(ht.timeHoursFormatProperty.value());return new dt.TimeFormatter(s).format(e);case"DayOfMonth":return e.getUTCDate().toString();case"Month":return(void 0===ct&&(ct=[c.t(null,void 0,i(795425)),c.t(null,void 0,i(835050)),c.t(null,void 0,i(651369)),c.t(null,void 0,i(442762)),c.t(null,{context:"short"},i(227991)),c.t(null,void 0,i(715224)),c.t(null,void 0,i(6215)),c.t(null,void 0,i(38465)),c.t(null,void 0,i(757902)),c.t(null,void 0,i(73546)),c.t(null,void 0,i(671230)),c.t(null,void 0,i(92203))]),ct)[e.getUTCMonth()];case"Year":return e.getUTCFullYear().toString()}}(e,s)}onScroll(){return this._onScroll}invalidateVisibleBars(){this._visibleBarsInvalidated=!0}onTimeScaleCompleted(e){var t;if(this._requestingMoreData=!1,this._endOfData=e,O.enabled("fix_left_edge")&&this._endOfData){const e=null===(t=this._points.range().value())||void 0===t?void 0:t.firstIndex;void 0!==e&&this.setLeftEdgeFix(e)}this._requestMoreData()}requestMoreHistoryPoints(e){this._model.mainSeries().requestMoreData(e)}targetDefaultRightOffset(){
return this.usePercentageRightOffset().value()?this.percentsToBarIndexLength(this._defaultRightOffsetPercentage.value()):this._defaultRightOffset.value()}percentsToBarIndexLength(e){return.01*e*this._width/this._barSpacing}barIndexLengthToPercents(e){return 100*e*this._barSpacing/this._width}requestHistoryPointsIfNeeded(){this._model.mainSeries().requestMoreData()}_requestMoreData(){this._requestFutureTickmarksIfNeeded(),this.requestHistoryPointsIfNeeded()}_requestFutureTickmarksIfNeeded(){this._model.mainSeries().requestMoreData()}_requestHistoryPoints(e){this._model.chartApi().isConnected().value()&&(this._requestingMoreData?bt.logNormal("Skipping loading more data due active loading"):(this._requestingMoreData=!0,this._model.chartApi().requestMoreData(e)))}_updateVisibleBars(){const e=this._visibleBars;if(this.isEmpty())return void(this._visibleBars.isValid()&&(this._visibleBars=rt.invalid(),this._visibleBarsChanged.fire(null,e.strictRange()),this._logicalRangeChanged.fire(null,e.logicalRange())));const t=this.baseIndex(),i=this.width()/this._barSpacing,s=this._rightOffset+t,r=s-i+1;Number.isFinite(r)&&Number.isFinite(s)?(this._visibleBars=new rt(new Qe.LogicalRange(r,s),this._model.mainSeries().style()),this._lockBarsAndLogicalRangeEvents||this._fireVisibleBarsChangedIfRequired(e,this._visibleBars)):bt.logWarn(`updateVisibleBars error: baseIndex: ${t}, barSpacing: ${this._barSpacing}, rightOffset: ${this._rightOffset}`)}_fireVisibleBarsChangedIfRequired(e,t){Ze.BarsRange.compare(e.strictRange(),t.strictRange())||this._visibleBarsChanged.fire(t.strictRange(),e.strictRange()),Qe.LogicalRange.compare(e.logicalRange(),t.logicalRange())||this._logicalRangeChanged.fire(t.logicalRange(),e.logicalRange())}_rightOffsetForCoordinate(e){return(this._width-e)/this._barSpacing-.5}_tryToUpdateBarSpacing(e,t){return e!==t&&(this._visibleBarsInvalidated=!0,this._barSpacing=t,this._barSpacingChanged.fire(t),!0)}_saveCommonTransitionsStartState(){this._commonTransitionStartState={barSpacing:this.barSpacing(),rightOffset:this.rightOffset()}}_clearCommonTransitionsStartState(){this._commonTransitionStartState=null}_maxRightOffsetOnChanged(){this._maxRightOffsetChanged.fire(this.maxRightOffset())}_updateRightOffset(e){const t=this._rightOffset;this._rightOffset=e,this.correctOffset(),this._rightOffset!==t&&this._rightOffsetChanged.fire(this._rightOffset),this._model.recalculateAllPanes((0,z.viewportChangeEvent)()),this._model.lightUpdate()}_defaultRightOffsetOptionsUpdated(){this.rightOffset();this.setRightOffset(this.targetDefaultRightOffset()),this._updateResetAvailableValue(),this._lastDefaultRightOffset=this._defaultRightOffsetPercentage.value()}_updateResetAvailableValue(){this._resetAvailable.setValue(6!==this.barSpacing()||this.rightOffset()!==this.targetDefaultRightOffset())}}var Ct=i(714688),wt=i(157954),Pt=i(992543),Tt=i(391534);class Mt{constructor(e){this._onChanged=new j.Delegate,this._groups=[],this._groups=e||[],this._groups.forEach((e=>{e.onChanged().subscribe(null,(t=>this._onChanged.fire(e.id,t)))}))}groups(){
return this._groups.filter((e=>e.isActualSymbol()))}groupsForAllSymbols(){return this._groups}createGroup(e,t,i){t=t||this._generateNextName();const s=new Tt.LineToolsGroup(e,t,i);this._groups.push(s),s.onChanged().subscribe(null,(e=>this._onChanged.fire(s.id,e)));const r={visibilityChanged:!1,lockedChanged:!1,isActualIntervalChanged:!1,affectedLineTools:e.map((e=>e.id()))};return this._onChanged.fire(s.id,r),s}addGroup(e){this._groups.push(e),e.onChanged().subscribe(null,(t=>this._onChanged.fire(e.id,t))),this._onChanged.fire(e.id)}removeGroup(e){const t=this._groups.findIndex((t=>t.id===e.id));this._groups.splice(t,1),this._onChanged.fire(e.id)}groupForId(e){return this._groups.find((t=>t.id===e))||null}groupForLineTool(e){return this._groups.find((t=>t.containsLineTool(e)))||null}removeLineTools(e){const t=new Set;this._groups.forEach((i=>{const s=e.filter(i.containsLineTool.bind(i));s.length&&(i.excludeLineTools(s),t.add(i.id))}));return this._groups.filter((e=>0===e.lineTools().length)).forEach((e=>this.removeGroup(e))),Array.from(t)}state(e){return{groups:(e?this._groups.filter((e=>e.isActualSymbol())):this._groups).map((e=>e.state()))}}onChanged(){return this._onChanged}fireChangedAll(){this._groups.forEach((e=>{this._onChanged.fire(e.id)}))}static fromState(e,t){const i=[];for(const s of t.groups){const t=Tt.LineToolsGroup.fromState(e,s);null!==t&&i.push(t)}return new Mt(i)}_generateNextName(){const e=new Set(this.groups().map((e=>e.name().value())));for(let t=1;;t++){const i=`Group ${t}`,s=`Group_${t}`;if(!e.has(i)&&!e.has(s))return i}}}var xt=i(74439),It=i(988124),Lt=i.n(It),kt=i(547944);let At=null;function Et(e){return Boolean(e.symbolInfo.timezone)&&Boolean(e.symbolInfo.session)}class Dt{constructor(e,t){var i,s;this._sourceTargetBarBuilder=null,this._cache=new Map,this._source=e,this._sourceSession=kt.SessionInfo.fromState(e.session),this._target=t,this._targetSession=kt.SessionInfo.fromState(t.session),this._isResolutionTheSame=M.Interval.isEqual(e.resolution,t.resolution),this._isSessionTheSame=(i=e.symbolInfo,s=t.symbolInfo,i.timezone===s.timezone&&i.session===s.session&&i.session_holidays===s.session_holidays&&i.corrections===s.corrections),this._shouldCorrectTradingDay=M.Interval.isDWM(e.resolution)&&!this._isSessionTheSame}sourceTimeToTargetTime(e){if(this._isSessionTheSame&&this._isResolutionTheSame)return e;if(!Et(this._source)||!Et(this._target))return e;let t=this._cache.get(e);if(void 0===t){let i=1e3*e;if(this._shouldCorrectTradingDay){let e=Lt().utc_to_cal(this._sourceSession.timezone,i);e=this._sourceSession.spec.correctTradingDay(e);const t=new Date(e);Lt().set_hms(t,0,0,0,0,this._sourceSession.timezone),i=t.valueOf()}const s=this._sourceTargetBuilder();s.moveTo(i);const r=s.indexOfBar(i);t=s.startOfBar(Math.max(0,r))/1e3,this._cache.set(e,t)}return t}_sourceTargetBuilder(){if(null===this._sourceTargetBarBuilder){const e=this._isSessionTheSame?this._targetSession:(null===At&&(At=new kt.SessionInfo("Etc/UTC","24x7")),At);this._sourceTargetBarBuilder=(0,
kt.newBarBuilder)(this._target.resolution,this._targetSession,e)}return this._sourceTargetBarBuilder}}var Bt=i(314802),Rt=i(919346);const Nt="#000000";var Vt=i(370552),Ot=i(921692),Ft=i(454373),Wt=i(702236);const zt=(0,Q.getLogger)("Chart.ESDWatcher");class Ht{constructor(e){this._cancellationTokens=new Map,this._propertyToPineOrSourceIdMap={},this._customFactories={futures_contract_expiration:e=>new Ot.FuturesContractExpiration(e),latestUpdates:e=>new Ft.LatestUpdatesSource(e,e.lollipopSourcesOptions().latestUpdatesEnabled),ChartEventsSource:e=>new Wt.ChartEventsSource(e)},this._detachedDources={},this._model=e;const t=this._model.mainSeries().properties().childs();this._properties={esdShowDividends:t.esdShowDividends,esdShowSplits:t.esdShowSplits,esdShowEarnings:t.esdShowEarnings,showContinuousContractSwitches:t.showContinuousContractSwitches,showFuturesContractExpiration:t.showFuturesContractExpiration,showLastNews:t.showLastNews,showChartEvents:this._model.properties().childs().chartEventsSourceProperties.childs().visible};const i=this._propertyToPineOrSourceIdMap,s=this._model.lollipopSourcesOptions();s.esdEnabled&&(i.esdShowDividends="Dividends@tv-basicstudies",i.esdShowSplits="Splits@tv-basicstudies",i.esdShowEarnings="Earnings@tv-basicstudies"),s.continuousContractSwitchesEnabled&&(i.showContinuousContractSwitches="BarSetContinuousRollDates@tv-corestudies"),s.futuresContractExpirationEnabled&&(i.showFuturesContractExpiration="futures_contract_expiration"),(s.latestUpdatesEnabled.minds||s.latestUpdatesEnabled.news)&&(i.showLastNews="latestUpdates"),s.chartEventsEnabled&&(i.showChartEvents="ChartEventsSource"),this._subscribeOnProperties(),this.syncSources()}destroy(){Object.keys(this._propertyToPineOrSourceIdMap).forEach((e=>{var t,i;const s=e;this._properties[s].unsubscribeAll(this);const r=this._detachedDources[s];if(void 0!==r)return null===(t=r.stop)||void 0===t||t.call(r),void(null===(i=r.destroy)||void 0===i||i.call(r));const o=this._propertyToPineOrSourceIdMap[s];this._customFactories[o]?this._removeSourceById(s,o,!1):(this._cancelPendingInsertion(o),this._removeAllStudies(o,s,!1))}))}syncSources(){zt.logNormal("Force syncing studies"),Object.keys(this._propertyToPineOrSourceIdMap).forEach((e=>this._syncSource(e)))}restoreChartEvents(e){const t=Wt.ChartEventsSource.options(e);if(null===t)return;this._propertyToPineOrSourceIdMap.showChartEvents="ChartEventsSource";const i=e=>new Wt.ChartEventsSource(e,t);this._customFactories.ChartEventsSource=i,this._subscribeOnProperty("showChartEvents"),this._properties.showChartEvents.value()&&this._model.mainPane().addDataSource(i(this._model),this._model.mainSeries().priceScale(),!0)}_subscribeOnProperties(){Object.keys(this._propertyToPineOrSourceIdMap).forEach((e=>{this._subscribeOnProperty(e)}))}_subscribeOnProperty(e){this._properties[e].subscribe(this,(t=>{this._syncSource(e)}))}_syncSource(e){var t;const i=this._propertyToPineOrSourceIdMap[e],s=this._customFactories[i];s?this._removeSourceById(e,i,!0):(this._cancelPendingInsertion(i),
this._removeAllStudies(i,e,!0));const r=this._model.mainSeries();if(this._properties[e].value()){const o=null!==(t=this._detachedDources[e])&&void 0!==t?t:null==s?void 0:s(this._model);o?(this._model.mainPane().addDataSource(o,r.priceScale(),!0),this._detachedDources[e]=void 0):this._insertStudy(i)}}_insertStudy(e){this._cancelPendingInsertion(e);const t=this._model.createStudyInserter({type:"java",studyId:e});t.setForceOverlay(!0);const i=function(){const e={cancelled:!1,cancel:()=>{e.cancelled=!0}};return e}();this._cancellationTokens.set(e,i),zt.logNormal(`Inserting ${e}`),t.insert(void 0,i).then((()=>{zt.logNormal(`Inserting ${e} is succeeded`)})).catch((e=>{e!==Vt.InsertionErrorCode.Cancelled&&zt.logError("Error: "+e)})).then((()=>{this._cancellationTokens.get(e)===i&&this._cancellationTokens.delete(e)}))}_removeAllStudies(e,t,i){const s=this._model.allStudies().filter((t=>t.metaInfo().id===e));for(let e=0;e<s.length;++e)0===e?(this._detachedDources[t]=i?s[0]:void 0,this._model.removeSource(s[e],i)):this._model.removeSource(s[e])}_cancelPendingInsertion(e){const t=this._cancellationTokens.get(e);void 0!==t&&(t.cancel(),this._cancellationTokens.delete(e),zt.logNormal(`Inserting ${e} has been cancelled`))}_removeSourceById(e,t,i){const s=this._model.dataSourceForId(t);null!==s&&(this._model.removeSource(s,i),this._detachedDources[e]=i?s:void 0)}}var Ut=i(558793);async function Gt(e){(await(0,Ut.getChartAlertsFacade)()).invokeAlertEditor(e)}class qt{constructor(e){this._alertLabelsBySource=new Map,this._alertsByAlertSeriesId=new Map,this._alertSeriesIdByAlert=new Map,this._alertLabelsOwnerSourcesByAlert=new Map,this._chartModel=e}destroy(){this.removeAllAlertLabels()}removeAllAlertLabels(){const e=this._alertLabelsBySource;this._alertLabelsBySource=new Map,this._alertsByAlertSeriesId.clear(),this._alertSeriesIdByAlert.clear(),this._alertLabelsOwnerSourcesByAlert.clear(),e.forEach((e=>{e.forEach((e=>this._chartModel.removeSource(e)))}))}removeSourceAlertLabels(e){for(const t of this._getAlertLabelsBySource(e))this.removeAlertLabel(t)}syncSourceAlertLabels(e){if(!(0,le.isPriceDataSource)(e)||!e.hasStateForAlert())return;for(const t of this._getAlertLabelsBySource(e))t.alertOwnerSource().idForAlert()===t.alertSeriesId()||t.alert().isOHLC()||this.removeAlertLabel(t);const t=this._alertsByAlertSeriesId.get(e.idForAlert()),i=this._getAlertLabelsBySource(e);void 0!==t&&t.forEach((e=>{i.some((t=>t.alert()===e))||this._updateAlertLabelsByAlert(e,(0,o.ensureDefined)(this._alertSeriesIdByAlert.get(e)))}));const s=(0,o.ensureNotNull)(this._chartModel.paneForSource(e));for(const t of this._getAlertLabelsBySource(e)){const i=this._chartModel.paneForSource(t);i!==s?(null!==i&&i.removeDataSource(t),s.addDataSource(t,(0,o.ensureNotNull)(e.priceScale()),!1)):e.priceScale()!==t.priceScale()&&s.move(t,(0,o.ensureNotNull)(e.priceScale()))}}detachSourceAlertLabels(e){for(const t of this._getAlertLabelsBySource(e))this._chartModel.detachSource(t)}removeAlertLabel(e){const t=e.alertOwnerSource(),i=this._alertLabelsBySource.get(t)
;void 0!==i&&(i.delete(e),0===i.size&&this._alertLabelsBySource.delete(t));const s=e.alert(),r=this._alertLabelsOwnerSourcesByAlert.get(s);void 0!==r&&(r.delete(t),0===r.size&&this._alertLabelsOwnerSourcesByAlert.delete(s)),this._chartModel.removeSource(e)}addAlert(e,t){(0,o.assert)(!this._alertSeriesIdByAlert.has(e),"Alert is already added on the chart"),this._alertSeriesIdByAlert.set(e,t);let i=this._alertsByAlertSeriesId.get(t);void 0===i&&(i=new Set,this._alertsByAlertSeriesId.set(t,i)),i.add(e),this._updateAlertLabelsByAlert(e,t)}removeAlert(e){const t=this._alertLabelsOwnerSourcesByAlert.get(e);void 0!==t&&t.forEach((t=>{const i=this._alertLabelsBySource.get(t);void 0!==i&&i.forEach((t=>{t.alert()===e&&this.removeAlertLabel(t)}))}));const i=(0,o.ensureDefined)(this._alertSeriesIdByAlert.get(e));this._alertSeriesIdByAlert.delete(e);const s=this._alertsByAlertSeriesId.get(i);void 0!==s&&s.delete(e)}_findPanes(e){const t=[];for(const i of this._chartModel.panes()){const s=i.priceDataSources(),r=new Set;for(const t of s)t.hasStateForAlert()&&t.idForAlert()===e&&r.add(t);r.size>0&&t.push({pane:i,sources:r})}return t}_addLabelToPane(e,t,i,s){const r=new f.AlertLabel(this._chartModel,e,s,Gt);i.addDataSource(r,s.priceScale(),!1);let o=this._alertLabelsBySource.get(s);void 0===o&&(o=new Set,this._alertLabelsBySource.set(s,o)),o.add(r);let n=this._alertLabelsOwnerSourcesByAlert.get(e);void 0===n&&(n=new Set,this._alertLabelsOwnerSourcesByAlert.set(e,n)),n.add(s)}_updateAlertLabelsByAlert(e,t){const i=this._findPanes(t);if(i.length)for(const s of i)s.sources.forEach((i=>this._addLabelToPane(e,t,s.pane,i)));else if(e.isOHLC()){const i=this._chartModel.mainSeries();this._addLabelToPane(e,t,(0,o.ensureNotNull)(this._chartModel.paneForSource(i)),i)}this._chartModel.lightUpdate()}_getAlertLabelsBySource(e){const t=this._alertLabelsBySource.get(e);return void 0===t?[]:Array.from(t)}}var jt=i(993171),Yt=i(960337),Kt=i(778016),Xt=i(833813),$t=i(690142),Zt=i(922850),Qt=i(822122),Jt=i(255453),ei=i(371927),ti=i(125226),ii=i(458963),si=i(246733),ri=i(838042),oi=i(792795);function ni(e,t){return e.code<t.code?-1:e.code>t.code?1:0}class ai{constructor(e){this._convertibleItems=e,this._idsToItems=new Map;for(const t of e)this._idsToItems.set(t.id,t)}convertible(e){return void 0!==this._idsToItems.get(e)}item(e){var t;return null!==(t=this._idsToItems.get(e))&&void 0!==t?t:null}size(){return this._convertibleItems.length}filterConvertible(e,t){const i=this._convertibleItems.filter(function(e,t){return i=>!e.has(i.id)&&t(i.id)}(e,t));return i.sort(ni),i}}class li{constructor(e){this._allGroups=new Set,this._idToName=new Map,this._idToDescription=new Map,this._groupedUnitIds=new Map,this._groupedUnits=new Map,this._groupById=new Map,this._size=0,this._units=e;for(const t in e)if(e.hasOwnProperty(t)){this._allGroups.add(t),this._groupedUnitIds.set(t,new Set(e[t].map((e=>e.id)))),this._groupedUnits.set(t,e[t]);for(const i of e[t])this._size++,this._idToName.set(i.id,i.name),this._idToDescription.set(i.id,i.description),
this._groupById.set(i.id,t)}}unitsChanged(e){return this._units!==e}size(){return this._size}name(e){return this._idToName.get(e)||e}description(e){return this._idToDescription.get(e)||e}unitGroupById(e){return this._groupById.get(e)||null}allGroups(){return new Set(this._allGroups)}unitsByGroups(e){const t=[];return e.forEach((e=>{const i=this._groupedUnits.get(e);void 0!==i&&t.push({name:e,units:i})})),t}convertible(e,t){for(const i of t){const t=this._groupedUnitIds.get(i);if(void 0!==t&&t.has(e))return!0}return!1}}var ci=i(150335);class hi{constructor(e){this._source=null,this._sourcePane=null,this._currentToolSupportsPhantomMode=!1,this._model=e}destroy(){this._source=null,this._sourcePane=null}source(){return this._source}onToolChanged(){this._removeSource();const e=this._model.currentTool();this._currentToolSupportsPhantomMode=(0,pe.isLineToolName)(e)&&(0,b.supportsPhantomMode)(e)}onCursorPositionUpdated(){if(!this._currentToolSupportsPhantomMode)return;const e=this._model.crossHairSource();if(this._sourcePane!==e.pane&&this._removeSource(),null===e.pane||!(0,ci.isNumber)(e.index)||!(0,ci.isNumber)(e.price))return void this._removeSource();const t={index:e.index,price:e.price};null!==this._source?this._source.setPoint(0,t):(this._source=this._model.createLineTool(e.pane,t,this._model.currentTool(),void 0,null,0),this._sourcePane=e.pane)}_removeSource(){null!==this._source&&(this._model.removeSource(this._source),this._source=null,this._sourcePane=null)}}var di=i(315347),ui=i(80646),_i=i(451798);class pi{constructor(){this._lastValue=null}align(e,t,i){this._lastValue=null;let s=e;if(!(0,_i.magnetEnabled)().value())return s;const r=i.mainDataSource();if(null===r)return s;const n=r.model().mainSeries();if(r!==n)return s;const a=n.priceScale();if(a.isEmpty())return s;const l=function(e,t){const i=e.bars().valueAt(t);if(null===i)return;let s;if(null!==e.priceSource())s=[e.barFunction()(i)];else switch(e.style()){case 12:s=[i[2],i[3]];break;case 16:s=[i[2],i[4],i[3]];break;default:s=[i[1],i[2],i[3],i[4]]}return s}(n,t);if(!l)return s;const c=(0,o.ensure)(n.firstValue()),h=l.map((e=>({y:a.priceToCoordinate(e,c),price:e}))),d=a.priceToCoordinate(e,c);h.sort(((e,t)=>Math.abs(e.y-d)-Math.abs(t.y-d)));const u=h[0];return((0,_i.magnetMode)().value()===ui.MagnetMode.StrongMagnet||Math.abs(u.y-d)<50)&&(s=u.price,this._lastValue=s),s}lastValue(){return this._lastValue}resetLastValue(){this._lastValue=null}}var mi=i(242558),gi=i(996986),Si=i(787123),vi=i(43192);class fi extends vi.BitmapCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(e){return null}_drawImpl(e){if(null===this._data)return;const{context:t,verticalPixelRatio:i,horizontalPixelRatio:s,bitmapSize:r}=e,o=Math.max(1,Math.floor(s));t.lineWidth=o;const n=Math.ceil(r.height*i),a=Math.ceil(r.width*s);if(t.lineCap="butt",this._data.vertLinesVisible){t.strokeStyle=this._data.vertLinesColor,(0,Si.setLineStyle)(t,this._data.vertLineStyle);for(const e of this._data.timeMarks){const i=Math.round(e.coord*s);(0,
Si.drawVerticalLine)(t,i,0,n)}}if(this._data.horzLinesVisible){t.strokeStyle=this._data.horzLinesColor,(0,Si.setLineStyle)(t,this._data.horzLineStyle);for(const e of this._data.priceMarks){const s=Math.round(e.coord*i);(0,Si.drawHorizontalLine)(t,s,0,a)}}}}class bi{constructor(e){this._renderer=new fi,this._pane=e}update(){}renderer(){const e=this._pane.defaultPriceScale(),t=this._pane.model().timeScale();if(e.isEmpty()||t.isEmpty())return null;const i=this._pane.model().properties().childs().paneProperties.childs(),s=t.marks(),r=i.gridLinesMode.value(),o={horzLinesVisible:"both"===r||"horz"===r,vertLinesVisible:"both"===r||"vert"===r,horzLinesColor:i.horzGridProperties.childs().color.value(),vertLinesColor:i.vertGridProperties.childs().color.value(),horzLineStyle:i.horzGridProperties.childs().style.value(),vertLineStyle:i.vertGridProperties.childs().style.value(),priceMarks:e.marks(),timeMarks:null!==s?s:[]};return this._renderer.setData(o),this._renderer}}class yi extends gi.DataSource{id(){return"grid"}paneViews(e){return[new bi(e)]}name(){return"Grid"}}var Ci=i(229765);class wi extends Ci.PriceAxisView{constructor(e,t,i,s){super(),this._source=e,this._pane=t,this._priceScale=i,this._priceProvider=s,this._properties=e.model().properties().childs().scalesProperties}setHitTestData(e){this._hitTestData=e}setXCoord(e){this._xCoord=e}additionalPadding(e){return 0}_updateRendererData(e,t,i){e.visible=!1,t.visible=!1;const s=this._priceScale,r=s.mainSource(),o=null!==r?r.firstValue():null;if(!this._isVisible()||s.isEmpty()||null===o)return;const n=this._currentPrice(s);if(null===n)return;i.background=(0,si.resetTransparency)(this._bgColor()),i.textColor=this.generateTextColor(i.background);const a=this.additionalPadding(s.fontSize());i.additionalPaddingTop=a,i.additionalPaddingBottom=a,i.coordinate=s.priceToCoordinate(n,o),e.text=s.formatPrice(n,o),e.visible=!0,t.visible=!0,t.hitTestData=this._hitTestData,t.xCoord=this._xCoord}_currentPrice(e){return this._priceProvider(e)}}class Pi extends wi{additionalPadding(e){return 2/12*e}_isVisible(){const e=this._source.lockedPane();return this._properties.childs().showPriceScaleCrosshairLabel.value()&&(this._source.visible||null!==e)&&(null!=e?e:this._source.pane)===this._pane}_currentPrice(e){const t=we.crosshairLock.value();return null!==t&&1===t.type?this._pane===this._source.lockedPane()?t.price:null:super._currentPrice(e)}_bgColor(){const e=this._properties.childs();return this._source.model().dark().value()?e.crosshairLabelBgColorDark.value():e.crosshairLabelBgColorLight.value()}_updateRendererData(e,t,i){const s=t.visible;super._updateRendererData(e,t,i),this._source.isHovered()?t.backgroung=this._source.model().dark().value()?l.colorsPalette["color-cold-gray-600"]:l.colorsPalette["color-cold-gray-650"]:t.backgroung=void 0,s||(t.visible=s)}}class Ti extends wi{_isVisible(){return null!==this._source.measurePane().value()}_bgColor(){return this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}}
var Mi=i(742391),xi=i(439016),Ii=i(406849),Li=i(593379),ki=i(373571),Ai=i(167222),Ei=i(158566),Di=i(429589),Bi=i(703089),Ri=i(862297),Ni=i(726778),Vi=i(606271),Oi=i(381554),Fi=i(783375),Wi=i(982217),zi=i(360758);function Hi(e){const t=e.priceScale();return null===t?0:t.isPercentage()||t.isIndexedTo100()?2:1}const Ui=O.enabled("show_context_menu_in_crosshair_if_only_one_item");class Gi extends Mi.PanePriceAxisView{constructor(e,t,i,s,r){super(e,t,s),this._crossHairMenuCachedState=null,this._hasActions=!1,this._tooltipText=null,this._gaOrigin="CH menu",this._crosshairPriceAxisView=e,e.setPaneRendererLabelIcon(0),this._crosshair=t,this._scale=i,this._options=r,this._updateGaOrigin(),(0,xi.waitTradingService)().then((()=>{this._crossHairMenuCachedState=null}))}_updateImpl(e,t){const i=this._crosshair.y,s=this._chartModel.properties().childs().scalesProperties.childs().fontSize.value(),r=this._chartModel.timeScale().width(),o=this._crosshair.model().priceAxisRendererOptions(),a=s+2*this._crosshairPriceAxisView.additionalPadding(s)+o.paddingTop+o.paddingBottom,l=a,c=i-a/2,h=this._crosshair.pane,d=this._mainDataSourceOnPane(),u=d&&d.symbolSource(),_=!!u&&(u.isConvertedToOtherCurrency()||u.isConvertedToOtherUnit());if(this._updateGaOrigin(),null!==d){const e=Hi(d),t=d.idForAlert(),i=this._chartModel.isInReplay(),s=this._crossHairMenuCachedState,r=O.enabled("chart_crosshair_menu");null!==s&&s.id===t&&s.priceScale===e&&s.isCurrencyOrUnitConverted===_&&s.isInReplay===i&&s.isMenuEnabled===r||(this._updateTooltipAndActionsAvailability(d,e,_),this._crossHairMenuCachedState={id:t,priceScale:e,isCurrencyOrUnitConverted:_,isInReplay:i,isMenuEnabled:r})}null!==d&&(0,ve.isActingAsSymbolSource)(d)&&d.symbol();const p=null!==h&&(h.maximized().value()||!h.collapsed().value())&&this._hasActions;this._crosshairPriceAxisView.setPaneLabelVisible(p);const m=this._position();if(null!==m){const e=0,t=r-l,i=Boolean(zi.showPlusButtonOnCursor.value()),s=i?this._crosshair.x:void 0,o=void 0!==s?s-l/2:"left"===m?e:t,h=void 0!==s?s+l/2:"left"===m?e+l:t+l,d=(0,n.box)(new n.Point(o,c),new n.Point(h,c+a)),u=this._tooltipText?{text:this._tooltipText,rect:{x:d.min.x,y:d.min.y,w:d.max.x-d.min.x,h:d.max.y-d.min.y}}:void 0;this._data={itemBox:d,clickHandler:this._handleClick.bind(this,m,i,d),tooltip:u},this._crosshairPriceAxisView.setHitTestData(this._data),this._crosshairPriceAxisView.setXCoord(s)}super._updateImpl(e,t)}_priceScale(){return this._scale}_updateGaOrigin(){this._gaOrigin=Boolean(zi.showPlusButtonOnCursor.value())?"CH menu cursor":"CH menu"}_updateTooltipAndActionsAvailability(e,t,s){this._tooltipText=null,this._hasActions=!1;if(!(1===t))return;const r=!this._chartModel.isInReplay(),o=!s&&e.alertCreationAvailable().value()&&r,n=!this._options.disableDrawHorizLineMenuAction,a=!s&&e===this._chartModel.mainSeries()&&Boolean((0,xi.tradingService)())&&r;let l=0;a&&l++,o&&l++,n&&l++;let h=0;1!==l||Ui||(o?(h=1,this._tooltipText=c.t(null,void 0,i(108700))):this._tooltipText=a?c.t(null,void 0,i(750493)):n?c.t(null,void 0,i(63597)):""),
this._crosshairPriceAxisView.setPaneRendererLabelIcon(h),this._hasActions=0!==l}_handleClick(e,t,i,s,r){if(O.enabled("widget")&&O.enabled("referral_program_for_widget_owners"))return void(0,Bi.showGoToTradingViewReferralDialog)({feature:"plusMenu"});(0,u.trackEvent)(this._gaOrigin,"click");const o=this._mainDataSourceOnPane(),n=null!==o&&(0,ve.isActingAsSymbolSource)(o)?o.symbol():null,a={pageX:r.pageX,pageY:r.pageY,clientX:r.clientX,clientY:r.clientY,screenX:r.screenX,screenY:r.screenY,price:this._crosshair.price,symbol:n};p.emit("onPlusClick",a),this._getMenuItems(e).then((s=>{if(Ui&&s.length>0||s.length>1)return void this._showContextMenu(s,t,i,r,e);const o=s[0];1!==s.length||o.isDisabled()||o.execute()}))}_getMenuItems(e){const t=this._options.disableTradingMenuActions?null:(0,xi.tradingService)(),i=(0,o.ensureNotNull)(this._crosshair.pane).mainDataSource(),s=!this._chartModel.isInReplay(),r=s,n=i===this._chartModel.mainSeries()&&Boolean(t)&&s,a=r?this._createAlertMenuItems(e):Promise.resolve([]),l=n?this._createTradingMenuItems():Promise.resolve([]);return Promise.all([a,l]).then((([e,i])=>{i.length>0&&(0,o.ensureNotNull)(t).trackEvent(this._gaOrigin,"click");const s=this._createAddHorizontalLineMenuItem(),r=e.length>0&&i.length>0;return[...e,r?new ki.Separator:null,...i,(e.length>0||i.length>0)&&s.length>0?new ki.Separator:null,...s].filter((e=>null!==e))}))}_createAlertMenuItems(e){if(null===this._crosshair.pane)return Promise.resolve([]);const t=this._crosshair.pane.mainDataSource();if(null===t)return Promise.resolve([]);const i=t.symbolSource();if(!!i&&(i.isConvertedToOtherCurrency()||i.isConvertedToOtherUnit()))return Promise.resolve([]);const s=this._crosshair.y;if(this._options.menuForMainSourceOnly){if(t.alertCreationAvailable().value()&&t.isVisible()){const e=this._getActionAddAlert({source:t,y:s,isDisabled:!1});return Promise.resolve(null===e?[]:[e])}return Promise.resolve([])}const r=(0,o.ensureNotNull)(this._crosshair.pane).sourcesByGroup();let n=("left"===e?r.leftPriceScalesSources():r.rightPriceScalesSources()).filter((e=>(0,le.isPriceDataSource)(e)&&e.alertCreationAvailable().value()&&e.isVisible()));return n.reverse(),n=(0,v.moveToHead)(n,this._chartModel.mainSeries()),(0,Ni.filterAccessibleDataSources)(n).then((e=>{const t=new Set(e),i=[];for(const e of n){const r=this._getActionAddAlert({source:e,y:s,isDisabled:!t.has(e)});null!==r&&i.push(r)}return i}))}_createTradingMenuItems(){const e=this._crosshair.y,t=(0,xi.tradingService)();if(null===t||null===this._crosshair.pane)return Promise.resolve([]);const i=this._crosshair.pane.mainDataSource();if(null===i)return Promise.resolve([]);const s=i.symbolSource(),r=!!s&&(s.isConvertedToOtherCurrency()||s.isConvertedToOtherUnit()),o=Hi(i);return r||1!==o?Promise.resolve([]):(0,Ii.createTradeContext)(i,e).then((e=>t.chartContextMenuActions(e,{onlyMainActions:!0,hideNotExecutableAction:!0,gaOrigin:this._gaOrigin})))}_createAddHorizontalLineMenuItem(){if(null===this._crosshair.pane)return[];const e=this._crosshair.pane.mainDataSource();if(null===e)return[]
;const t=this._crosshair.y,i=this._getActionAddHorizontalLine({source:e,y:t,pane:this._crosshair.pane});return null===i?[]:[i]}_getActionAddAlert(e){const{source:t,y:s,isDisabled:r}=e,o=this._getValue(t,s);if(null===o)return null;const n=this._formatValue(o,t),a=(0,ve.isActingAsSymbolSource)(t)?t.symbolTitle(Wi.TitleDisplayTarget.StatusLine,!0,!0):t.title(Wi.TitleDisplayTarget.StatusLine,!0,{},!0),l={label:(0,Vi.isFirstAlertPlotUsual)(t)?c.t(null,{replace:{title:a,price:n}},i(107005)):c.t(null,{replace:{title:a}},i(764615)),icon:Oi};return r?l.disabled=!0:l.onExecute=()=>this._addAlert(o,t),new Ei.TVAction(l)}_getActionAddHorizontalLine(e){if(this._options.disableDrawHorizLineMenuAction)return null;const{source:t,y:s,pane:r}=e,o=this._getValue(t,s);if(null===o)return null;const n=this._formatValue(o,t),a={actionId:"Chart.Crosshair.PlusButton.DrawHorizontalLine",label:c.t(null,void 0,i(508338))+` ${n}`,icon:Li};return a.onExecute=()=>this._addHorizontalLineTool(r,o),new ki.Action(a)}_getValue(e,t){const i=e.priceScale(),s=e.firstValue();if(null===i||null===s)return null;return i.isPercentage()||i.isIndexedTo100()?null:i.coordinateToPrice(t,s)}_formatValue(e,t){return t.formatter().format(e)}async _addAlert(e,t){const{createAlertSilently:s,getAlertEditorSource:r,getEditableAlertState:o}=await async function(){const[{createAlertSilently:e},{getAlertEditorSource:t},{getEditableAlertState:s}]=await Promise.all([Promise.all([i.e(36999),i.e(69752),i.e(33617),i.e(72359),i.e(17344)]).then(i.bind(i,568729)),Promise.all([i.e(36999),i.e(69752),i.e(33617),i.e(72359),i.e(17344)]).then(i.bind(i,606271)),Promise.all([i.e(36999),i.e(69752),i.e(33617),i.e(72359),i.e(17344)]).then(i.bind(i,220037))]);return{createAlertSilently:e,getAlertEditorSource:t,getEditableAlertState:s}}(),n=async()=>{const i=this._chartModel.mainSeries();if((0,ti.isFeatureEnabled)("alerts-create-alerts-silently-via-facade")){await(0,Ri.ensureSeriesIsNotOffline)(i),await(0,Ri.ensureResolvedSymbolInfo)(i);const n=r(t),a=n&&o(n,e);if(a)return s(a,n),void(0,u.trackEvent)(this._gaOrigin,"alert")}const n={dataSourceHub:this._chartModel,silent:!0,actionSource:"crosshair_menu"};(0,b.isLineTool)(t)?n.drawing=t:(n.series=t,n.value=e),(0,Di.invokeAlertEditorWithOnlineSeries)(n),(0,u.trackEvent)(this._gaOrigin,"alert")};(0,Ai.runOrSigninWithFeature)((()=>n()),{feature:"alert",source:this._gaOrigin})}_addHorizontalLineTool(e,t){this._chartModel.undoModel().createLineTool({pane:e,point:{price:t,index:0},linetool:"LineToolHorzLine"})}_showContextMenu(e,t,i,s,r){const n="left"===r;setTimeout((()=>{const r=s.clientX-s.localX,a=s.clientY-s.localY,l=i.min.x+r,c=i.max.x+r,h=i.min.y+a,d=c-l,u=i.max.y+a-h,_=t?we.crosshairLock.value():void 0;if(void 0!==_){const e=(0,o.ensureNotNull)(this._chartModel.timeScale().points().roughTime(this._crosshair.index));we.crosshairLock.setValue({type:1,price:this._crosshair.price,time:e,modelId:this._chartModel.id(),paneId:(0,o.ensureNotNull)(this._crosshair.pane).id()})}Fi.ContextMenuManager.showMenu(e,{clientX:s.clientX,clientY:s.clientY,box:{x:l,
w:d,y:h,h:u},attachToXBy:t?"auto":n?"left":"right",attachToYBy:"auto-strict",marginX:t?0:-d},void 0,{menuName:"CrosshairMenuView"},(()=>{void 0!==_&&we.crosshairLock.setValue(_)}))}))}_mainDataSourceOnPane(){const e=this._crosshair.pane;return null!==e?e.mainDataSource():null}}var qi=i(86121),ji=i(315801);class Yi extends vi.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return void 0===this._data.clickHandler?null:new ji.HitTestResult(ji.HitTarget.Custom,{clickHandler:this._data.clickHandler,tapHandler:this._data.clickHandler})}_drawImpl(e){const t=this._data.vertLinesVisible,i=this._data.horzLinesVisible;if(!t&&!i)return;const{context:s,horizontalPixelRatio:r,verticalPixelRatio:o,bitmapSize:n}=e;s.lineWidth=Math.max(1,Math.floor(this._data.lineWidth*r)),s.strokeStyle=this._data.color,s.fillStyle=this._data.color,s.lineCap="butt",(0,Si.setLineStyle)(s,this._data.lineStyle);const a=Math.round(this._data.x*r),l=Math.round(this._data.y*o),c=Math.ceil(n.width*r),h=Math.ceil(n.height*o);t&&a>=0&&(0,Si.drawVerticalLine)(s,a,0,h),i&&l>=0&&(0,Si.drawHorizontalLine)(s,l,0,c),this._data.drawCenter&&(s.beginPath(),s.arc(a,l,Math.round(3*r),0,2*Math.PI,!0),s.fillStyle=this._data.color,s.fill()),this._data.scissors&&function(e,t,i){const{context:s,bitmapSize:r,horizontalPixelRatio:o,verticalPixelRatio:n}=e,a=24*o,l=Math.round(t-a/2);let c=Math.round(i-a/2);if(c<0)c=0;else{const e=r.height-a;c>e&&(c=e)}s.translate(l,c),s.scale(o,n),s.fillStyle="#131722",s.fill(Ki),s.strokeStyle="#fff",s.lineWidth=1,s.stroke(Ki)}(e,a,l)}}const Ki=new Path2D("m15.68 3.72-3.82 5.52-3.83-5.52-.28-.42-.42.3a2.84 2.84 0 0 0-.68 3.92l3.27 4.73-1.16 1.68a3.34 3.34 0 0 0-4.26 3.22 3.34 3.34 0 0 0 3.32 3.35 3.34 3.34 0 0 0 3.08-4.6l1-1.44 1.13 1.62a3.34 3.34 0 0 0 3.15 4.42c1.84 0 3.32-1.5 3.32-3.35a3.34 3.34 0 0 0-4.42-3.17l-1.23-1.78 3.22-4.65a2.86 2.86 0 0 0-.69-3.96l-.41-.29-.29.42ZM7.82 16.27c.47 0 .86.39.86.88 0 .48-.39.87-.86.87a.87.87 0 0 1-.86-.87c0-.5.4-.88.86-.88Zm8.36 0c.47 0 .86.39.86.88 0 .48-.4.87-.86.87a.87.87 0 0 1-.86-.87c0-.5.39-.88.86-.88Z");const Xi=l.colorsPalette["color-tv-blue-500"];class $i{constructor(e,t){this._rendererData={},this._renderer=new Yi(this._rendererData),this._source=e,this._pane=t}update(){}renderer(e,t){var i,s;const r=this._source.selectPointMode().value()!==we.SelectPointMode.None,n=this._source.lockedPane(),a=(this._source.visible||null!==n)&&(this._source.areLinesVisible||r)&&!this._source.linesShouldBeHidden(),l=this._rendererData;if(!a||null===this._pane)return null;const c=this._source.paneForPointSelect(),h=this._source.isReplaySelection(),d=null!=n?n:this._source.pane,u=this._pane===d,_=h||(null!==c?d===c&&this._pane===c:u);if(l.scissors=!1,r&&(h||this._source.isOnHoveredChartWidget())&&_){const e=(0,o.ensureNotNull)(this._source.pointToSelect());l.color=this._source.lineColor()||Xi,h?(l.lineWidth=2,l.scissors=u):l.lineWidth=1,l.lineStyle=ii.LINESTYLE_SOLID,l.horzLinesVisible=!0,l.vertLinesVisible=!0,l.drawCenter=!1,
"time"===e?l.horzLinesVisible=!1:"price"===e&&(l.vertLinesVisible=!1)}else{const e=this._source.properties(),t=this._source.model().currentTool(),i=(0,qi.lastMouseOrTouchEventInfo)(),s=i.isTouch&&!i.stylus&&((0,pe.isLineToolName)(t)||(0,we.toolIsMeasure)(t));let r;r=s?Xi:e.childs().color.value();const o=e.childs().transparency.value();!s&&o>0&&(r=(0,si.generateColor)(r,o)),l.color=r,l.horzLinesVisible=this._pane===d&&(this._pane.maximized().value()||!this._pane.collapsed().value()),l.vertLinesVisible=!0,l.lineWidth=e.childs().width.value(),l.lineStyle=e.childs().style.value(),l.drawCenter=s&&this._pane===d}return l.x=null!==(i=this._source.lockedX())&&void 0!==i?i:this._source.x,l.y=null!==(s=this._source.lockedY())&&void 0!==s?s:this._source.y,this._renderer}}var Zi=i(189767);const Qi={backgroundColor:(0,si.generateColor)(l.colorsPalette["color-tv-blue-500"],70),borderColor:(0,si.generateColor)(l.colorsPalette["color-tv-blue-500"],20)};class Ji{constructor(e){this._renderer=new Zi.RectangleRenderer,this._rectangle=null,this._crosshair=e}update(){const e=this._crosshair.selection();null!==e&&null!==this._crosshair.pane?this._rectangle=this._crosshair.pane.logicalRectToPixels(e):this._rectangle=null}renderer(e,t){if(!this._rectangle)return null;const i={backcolor:Qi.backgroundColor,color:Qi.borderColor,fillBackground:!0,linewidth:1,points:[this._rectangle.min,this._rectangle.max],extendLeft:!1,extendRight:!1};return this._renderer.setData(i),this._renderer}}var es=i(31341),ts=i(639958),is=i(754480),ss=i(943994),rs=i(541801),os=i(535698),ns=i(142119),as=i(855152);const ls=c.t(null,void 0,i(33355)),cs=c.t(null,{context:"study"},i(32819)),hs=new Pe.PercentageFormatter,ds=new is.TimeSpanFormatter,us=new ss.VolumeFormatter,_s=(0,l.getHexColorByName)("color-tv-blue-500"),ps=(0,l.getHexColorByName)("color-ripe-red-400"),ms={bgColorPositive:(0,si.generateColor)(_s,80),bgColorNegative:(0,si.generateColor)(ps,80),colorPositive:(0,l.getHexColorByName)("color-tv-blue-600"),colorNegative:(0,l.getHexColorByName)("color-ripe-red-400"),labelBgColorPositive:_s,labelBgColorNegative:ps};class gs{constructor(e,t){this._pipFormatter=null,this._lastSymbolInfo=null,this._horzTrenRenderer=new rs.TrendLineRenderer,this._vertTrenRenderer=new rs.TrendLineRenderer,this._bgRenderer=new Zi.RectangleRenderer,this._labelRenderer=new os.TextRenderer,this._p1=null,this._p2=null,this._label=null,this._source=e,this._pane=t}update(e){var t,i;const[s,r]=this._source.measurePoints();if(void 0===r)return this._p1=null,void(this._p2=null);const a=(0,o.ensureNotNull)(this._source.measurePane().value()),l=s.price,c=r.price,h=r.index-s.index,d=(0,es.forceLTRStr)(""+h),u=(0,o.ensureNotNull)(a.mainDataSource()),_=(0,o.ensureNotNull)(u.formatter()),p=r.price-l;let m=null!==(i=null===(t=_.formatChange)||void 0===t?void 0:t.call(_,r.price,l))&&void 0!==i?i:_.format(p);if(Math.abs(l)>1e-8){const e=p/Math.abs(l);m+=" ("+hs.format(100*e)+")"}const g=(0,es.forceLTRStr)(m);this._label=g+"\n"+ls.format({count:d});const S=(0,
o.ensureNotNull)(u.firstValue()),v=this._source.model().timeScale().indexToCoordinate(s.index),f=this._source.model().timeScale().indexToCoordinate(r.index),b=a.defaultPriceScale().priceToCoordinate(l,S),y=a.defaultPriceScale().priceToCoordinate(c,S);this._p1=new n.Point(v,b),this._p2=new n.Point(f,y);const C=this._source.model().timeScale().indexToUserTime(s.index),w=this._source.model().timeScale().indexToUserTime(r.index);let P=null;if(null!==C&&null!==w){const e=this._pane.model().mainSeries().symbolInfo();null!==e&&e!==this._lastSymbolInfo&&(this._pipFormatter=new ts.PipFormatter(e.pricescale,e.minmov,e.type,e.minmove2,e.typespecs),this._lastSymbolInfo=e),P=(w.valueOf()-C.valueOf())/1e3}const T=this._pipFormatter?this._pipFormatter.format(p):null,M=null!==T?" , "+T:"",x=null!==P?ds.format(P):null,I=null!==x?", "+(0,es.startWithLTR)(x):"";this._label=(0,es.forceLTRStr)(g+M)+"\n"+ls.format({count:d})+I;const L=this._source.measureVolume();Number.isNaN(L)||(this._label+=`\n${cs} ${us.format(L)}`);const k=c<l?ms.bgColorNegative:ms.bgColorPositive,E=c<l?ms.colorNegative:ms.colorPositive,D=c<l?ms.labelBgColorNegative:ms.labelBgColorPositive,B={points:[this._p1,this._p2],linewidth:0,fillBackground:!0,color:k,backcolor:k,extendLeft:!1,extendRight:!1};this._bgRenderer.setData(B);const R=this._p1.add(this._p2).scaled(.5);{const e=Math.round(R.y),t=new n.Point(this._p1.x,e),i=new n.Point(this._p2.x,e),s={points:[t,i],color:E,linewidth:1,linestyle:ii.LINESTYLE_SOLID,extendleft:!1,extendright:!1,leftend:as.LineEnd.Normal,rightend:Math.abs(t.x-i.x)>=50?as.LineEnd.Arrow:as.LineEnd.Normal};this._horzTrenRenderer.setData(s)}{const e=Math.round(R.x),t=new n.Point(e,this._p1.y),i=new n.Point(e,this._p2.y),s={points:[t,i],color:E,linewidth:1,linestyle:ii.LINESTYLE_SOLID,extendleft:!1,extendright:!1,leftend:as.LineEnd.Normal,rightend:Math.abs(t.y-i.y)>=50?as.LineEnd.Arrow:as.LineEnd.Normal};this._vertTrenRenderer.setData(s)}const N={x:0,y:10},V=.5*(this._p1.x+this._p2.x),O=this._p2.y,F=new n.Point(V,O),W=(z=(0,o.ensureNotNull)(this._label),{points:[F],text:z,color:"#FFFFFF",horzAlign:"center",vertAlign:"middle",font:A.CHART_FONT_FAMILY,offsetX:N.x,offsetY:N.y,bold:!1,italic:!1,fontsize:12,padding:8,highlightBorder:!1,backgroundColor:D,backgroundTransparency:10,backgroundVertInflate:5,backgroundHorzInflate:5,backgroundRoundRect:4});var z;this._labelRenderer.setData(W);const H=this._labelRenderer.measure(),U=(0,os.calculateLabelPosition)(H,this._p1,this._p2,N,this._pane.height());this._labelRenderer.setPoints([U])}renderer(){if(null===this._p1||null===this._p2)return null;const e=new ns.CompositeRenderer;return e.append(this._bgRenderer),e.append(this._horzTrenRenderer),e.append(this._vertTrenRenderer),e.append(this._labelRenderer),e}}var Ss=i(710455);class vs extends Ss.MediaCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return null}_drawImpl(e){const t=e.context;t.translate(this._data.x-this._data.width/2,this._data.y-this._data.height/2),t.strokeStyle="rgba(153,153,153,.3)",t.lineWidth=2,t.beginPath(),
this._drawShackle(t),t.stroke(),t.closePath(),t.strokeStyle="rgba(153,153,153,.7)",t.lineWidth=1,t.beginPath(),t.rect(0,this._data.height-this._data.bodyHeight+.5,this._data.width,this._data.bodyHeight),t.closePath(),t.stroke(),t.translate(0,-1),t.strokeStyle="#777",t.beginPath(),this._drawShackle(t),t.stroke(),t.closePath(),t.fillStyle="rgba(255,255,255,.7)",t.beginPath(),t.rect(1,this._data.height-this._data.bodyHeight+1.5,this._data.width-2,this._data.bodyHeight-2),t.fill(),t.beginPath(),t.rect(.5,this._data.height-this._data.bodyHeight+1,this._data.width-1,this._data.bodyHeight-1),t.stroke(),t.closePath(),t.fillStyle="#777",t.fillRect(this._data.width/2-.5,this._data.height-this._data.bodyHeight/2,1,2)}_drawShackle(e){const t=(this._data.width-3)/2,i=this._data.height-this._data.bodyHeight;e.moveTo(1.5,t),e.arc(this._data.width/2,t,t,Math.PI,2*Math.PI),i>t&&(e.moveTo(1.5,t),e.lineTo(1.5,i),e.moveTo(this._data.width-1.5,t),e.lineTo(this._data.width-1.5,i))}}class fs{constructor(e,t,i){this._horzVisible=!1,this._source=e,this._pane=t,this._axis=i||"x"}update(){}renderer(e,t){var i;const s=this._source.visible&&this._source.areLinesVisible,r=0===(null===(i=we.crosshairLock.value())||void 0===i?void 0:i.type),n=s&&this._horzVisible,a=s||r;if("y"===this._axis&&!n||!a)return null;const l="y"===this._axis?this._pane.width()-4.5:(0,o.ensureNotNull)(this._source.lockedX())+1,c="y"===this._axis?this._source.y:this._pane.height()-5.5-1;return new vs({x:l,y:c,width:9,height:11,bodyHeight:7})}}var bs=i(638456);const ys=30;class Cs{constructor(e,t,i){this._renderer=new Zi.RectangleRenderer,this._invalidated=!0,this._source=e,this._pane=t,this._model=i}update(){this._invalidated=!0}renderer(e,t){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){var e;if(this._renderer.setData(null),!this._pane||!this._source.visible)return;if(!this._source.model().mainSeries().lastValueData(void 0,!0,!0).index)return;const t=new n.Point(null!==(e=this._source.lockedX())&&void 0!==e?e:this._source.x,0),i=new n.Point(this._pane.width(),this._pane.height()),s={backcolor:(0,si.applyTransparency)(this._model.backgroundColorAtYPercentFromTop(.5),ys),color:(0,si.applyTransparency)(this._model.backgroundColorAtYPercentFromTop(.5),ys),fillBackground:!0,linewidth:0,points:[t,i],nohittest:!0,extendLeft:!1,extendRight:!1};this._renderer.setData(s)}}var ws=i(154765),Ps=i(782086),Ts=i(60897);class Ms extends Ps.DataWindowView{constructor(e){super(),this._invalidated=!0,this._dateItem=new Ps.DataWindowItem("",c.t(null,void 0,i(676912)),""),this._timeItem=new Ps.DataWindowItem("",c.t(null,void 0,i(631976)),""),this._model=e,this._items.push(this._dateItem),this._items.push(this._timeItem)}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}_updateImpl(){const e=this._model.mainSeries().isDWM();if(this._timeItem.setVisible(!e),this._timeItem.setValue(Ts.notAvailable),this._dateItem.setValue(Ts.notAvailable),this._model.timeScale().isEmpty())return
;let t=this._model.crossHairSource().appliedIndex();if(!(0,ci.isNumber)(t)){const e=this._model.mainSeries().data().last();if(null===e)return;t=e.index}const i=this._model.timeScale().indexToUserTime(t);null!==i&&(this._dateItem.setValue(this._model.dateFormatter().format(i)),e||this._timeItem.setValue(this._model.timeFormatter().format(i)))}}var xs=i(161164);const Is=l.colorsPalette["color-tv-blue-500"],Ls=c.t(null,{context:"Replay"},i(420747));class ks extends xs.TimeAxisView{constructor(e,t,i,s=!1){super(e),this._indexProvider=i,this._highlighted=s,this._source=t,this._properties=e.properties().childs().scalesProperties}_getText(e){if(this._source.isReplaySelection()){const t=this._model.timeScale().indexToUserTime(e);return null!==t?`${Ls}: ${this._model.dateTimeFormatter().format(t)}`:""}return super._getText(e)}_getBgColor(){if(this._source.isReplaySelection())return Is;const e=this._properties.childs();return this._highlighted?e.axisLineToolLabelBackgroundColorCommon.value():this._model.dark().value()?e.crosshairLabelBgColorDark.value():e.crosshairLabelBgColorLight.value()}_getIndex(){return this._model.crossHairSource().visible||null!==this._source.lockedPane()?this._indexProvider():null}_isVisible(){return this._properties.childs().showTimeScaleCrosshairLabel.value()}}var As=i(3140),Es=i(731042);const Ds={menuEnabled:!1,menuForMainSourceOnly:!1,disableTradingMenuActions:!1,disableDrawHorizLineMenuAction:!1};let Bs=0;const Rs=(0,Q.getLogger)("Chart.Crosshair");class Ns extends gi.DataSource{constructor(e,t,i){super(),this.pane=null,this.price=NaN,this.index=NaN,this.visible=!0,this.areLinesVisible=!0,this.x=NaN,this.y=NaN,this._lockData=null,this._measurePane=new Y.WatchedValue(null),this._measurePaneViewCache=new WeakMap,this._startMeasurePoint=null,this._endMeasurePoint=null,this._lastValidMeasurePoint=null,this._isOnHoveredChartWidget=!1,this._crossHairSelectPointMode=new Y.WatchedValue(we.SelectPointMode.None),this._selectionPane=null,this._selectionView=new Ji(this),this._selectionStartPoint=null,this._timeLockPaneView=null,this._crosshairPaneViewCache=new WeakMap,this._pointSelectionPaneViewCache=new WeakMap,this._priceAxisViews=new Map,this._panePriceAxisViews=new Map,this._startMeasurePriceAxisViews=new Map,this._endMeasurePriceAxisViews=new Map,this._originX=NaN,this._originY=NaN,this._subscribed=!1,this._movedDelegate=new j.Delegate,this._pointSelectedDelegate=new j.Delegate,this._requestedPoint=null,this._paneForRequestedPoint=null,this._selectLineColor=null,this._volumeCalculator=null,this._selectFromAllChartsIfOutOfData=null,this._currentMeasurePointsetAndSymbolId=null,this._model=e,this._options=Object.assign({},Ds,i||{}),this._linesShouldBeHidden=this._model.readOnly(),this._dataWindowView=new Ms(e),this.setSelectionEnabled(!1);const s=e=>t=>t===(0,o.ensureNotNull)(this._measurePane.value()).defaultPriceScale()?e():null;this._currentPosPriceProvider=e=>{const t=(0,o.ensureNotNull)(this.pane);if(e===t.defaultPriceScale())return this.price;const i=(0,
o.ensureNotNull)(t.defaultPriceScale().mainSource()).firstValue();if(null===i)return null;const s=t.defaultPriceScale().priceToCoordinate(this.price,i),r=(0,o.ensureNotNull)(e.mainSource()).firstValue();return null===r?null:e.coordinateToPrice(s,r)},this._startMeasurePriceProvider=s((()=>(0,o.ensureNotNull)(this._startMeasurePoint).price)),this._endMeasurePriceProvider=s((()=>(0,o.ensureNotNull)(this._lastMeasurePoint()).price)),this._properties=t;this._timeAxisView=new ks(e,this,(()=>this.appliedIndex()),!1),this._startMeasureTimeAxisView=new ks(e,this,(()=>(0,o.ensureNotNull)(this._startMeasurePoint).index),!0),this._endMeasureTimeAxisView=new ks(e,this,(()=>(0,o.ensureNotNull)(this._lastMeasurePoint()).index),!0),e.readOnly()||we.cursorTool.subscribe((e=>this.areLinesVisible="arrow"!==e),{callWithLast:!0}),this._crosshairLock=we.crosshairLock.spawn(),this._showPlusButtonOnCursor=zi.showPlusButtonOnCursor.spawn();const r=()=>{this.updateAllViews((0,z.sourceChangeEvent)(this.id())),this._model.lightUpdate()};this._crosshairLock.subscribe(r),this._showPlusButtonOnCursor.subscribe(r)}destroy(){null!==this._volumeCalculator&&this._volumeCalculator.destroy(),this._measurePane.setValue(null),this._crosshairLock.destroy(),this._showPlusButtonOnCursor.destroy(),this._removeMeasurePointset()}name(){return"Crosshair"}moved(){return this._movedDelegate}originX(){return this._originX}originY(){return this._originY}saveOriginCoords(e,t){this._originX=e,this._originY=t}clearOriginCoords(){this._originX=NaN,this._originY=NaN}currentPoint(){return new n.Point(this.x,this.y)}model(){return this._model}appliedIndex(){var e;return null!==(e=this._getLockData().index)&&void 0!==e?e:this.index}lockedX(){var e;return null!==(e=this._getLockData().xCoord)&&void 0!==e?e:null}lockedY(){var e;return null!==(e=this._getLockData().yCoord)&&void 0!==e?e:null}lockedPane(){const e=we.crosshairLock.value();return null===e||1!==e.type?null:this._model.id()===e.modelId?this._model.paneForId(e.paneId):this._model.mainPane()}invalidateLockPosition(){this._lockData=null}startMeasurePoint(){return this._startMeasurePoint||null}endMeasurePoint(){return this._endMeasurePoint||null}measureVolume(){if(null===this._volumeCalculator)return NaN;const[e,t]=this.measurePoints();return void 0===t?NaN:this._volumeCalculator.volume(e.index,t.index)}measurePane(){return this._measurePane.readonly()}startMeasuring(e,t){this._startMeasurePoint=e,this._measurePane.setValue(t),t.containsMainSeries()&&((0,o.assert)(null===this._volumeCalculator),this._volumeCalculator=new As.SeriesTimeRangeVolumeCalculator(this.model().mainSeries())),this._model.updatePane(t)}finishMeasure(e){this._endMeasurePoint=e,this._createMeasurePointset((0,o.ensureNotNull)(this._startMeasurePoint),this._endMeasurePoint)}clearMeasure(){this._removeMeasurePointset(),this._measurePane.setValue(null),delete this._startMeasurePoint,delete this._endMeasurePoint,delete this._lastValidMeasurePoint,this._model.lightUpdate(),null!==this._volumeCalculator&&(this._volumeCalculator.destroy(),
this._volumeCalculator=null)}measurePoints(){const e=[(0,o.ensureNotNull)(this._startMeasurePoint)],t=this._lastMeasurePoint();return null!==t&&e.push(t),e}startSelection(e){this._selectionStartPoint=this.currentLogicalPoint(),this._selectionPane=e}clearSelection(){this._selectionStartPoint=null,this._selectionPane=null}selection(){return this._selectionStartPoint?{p1:this._selectionStartPoint,p2:this.currentLogicalPoint()}:null}currentLogicalPoint(){return{index:this.appliedIndex(),price:this.price}}selectPointMode(){return this._crossHairSelectPointMode}lineColor(){return this._selectLineColor}cancelRequestSelectPoint(){this._crossHairSelectPointMode.value()!==we.SelectPointMode.None&&this._setSelectPointModeState(we.SelectPointMode.None),this._selectFromAllChartsIfOutOfData=null}requestSelectPoint(e){(0,o.assert)(this._crossHairSelectPointMode.value()===we.SelectPointMode.None,"Point already requested");const{pointType:t,pane:i,lineColor:s=null,selectFromAllChartsIfOutOfData:r,selectPointMode:n=we.SelectPointMode.Study}=e;i&&((0,o.assert)(-1!==this._model.panes().indexOf(i),"Chartmodel doesn't contains specified pane"),this._paneForRequestedPoint=i,this._model.panesCollectionChanged().subscribe(this,this._paneCollectionChanged)),this._selectLineColor=s,this._requestedPoint=t,this._selectFromAllChartsIfOutOfData=null!=r?r:null,this._setSelectPointModeState(n)}onPointSelected(){return this._pointSelectedDelegate}trySelectCurrentPoint(){var e;const t=(0,o.ensureNotNull)(this._requestedPoint);let i=null;if(!this._model.mainSeries().bars().search(this.index,_t.PlotRowSearchMode.Exact)&&"price"!==t&&(this._selectFromAllChartsIfOutOfData&&(i=null!==(e=Math.min(...Array.from(we.barTimesUnderCursor.values())))&&void 0!==e?e:null),null===i))return;const s=(0,o.ensureNotNull)(this.pane);if(this._paneForRequestedPoint&&this._paneForRequestedPoint!==s)return;let r,n=i;if("price"===t||null!==i||(n=this._model.timeScale().indexToTimePoint(this.index),null!==n)){if("time"!==t){const e=s.mainDataSource();if(null===e)return;const t=e.firstValue(),i=e.priceScale();if(null===t||null===i)return;r=i.coordinateToPrice(this.y,t)}this._setSelectPointModeState(we.SelectPointMode.None),this._pointSelectedDelegate.fire({time:null!=n?n:void 0,price:r},s)}}isOnHoveredChartWidget(){return this._isOnHoveredChartWidget}setOnHoveredChartWidget(e){this._isOnHoveredChartWidget=e}isReplaySelection(){return("AllCharts"===ws.replayModeProperty.value()||this._isOnHoveredChartWidget)&&this._crossHairSelectPointMode.value()===we.SelectPointMode.Replay}clearPosition(){this.visible=!1,this.index=NaN,this.price=NaN,this.x=NaN,this.y=NaN,this.pane=null,this.clearOriginCoords(),this._updateVisibilityDependentPaneViews()}setPosition(e,t,i){this._subscribed||(this._model.mainSeries().onRestarted().subscribe(this,this.clearMeasure),this._subscribed=!0),this.visible=!0;const s=this._model.id(),r=this._model.mainSeries().bars().search(this.index,_t.PlotRowSearchMode.NearestRight);return r&&we.barTimesUnderCursor.set(s,r.value[0]),this._tryToUpdateViews(e,t,i)}
setLinesShouldBeHidden(e){this._linesShouldBeHidden=e}linesShouldBeHidden(){return this._linesShouldBeHidden}handleContextMenuEvent(e){this._crossHairSelectPointMode.value()!==we.SelectPointMode.None&&this._setSelectPointModeState(we.SelectPointMode.None)}properties(){return this._properties}priceAxisViews(e,t){var i;const s=null===this._requestedPoint||"time"!==this._requestedPoint||!this._isOnHoveredChartWidget,r=[];return(null!==(i=this.lockedPane())&&void 0!==i?i:this.pane)===e&&s&&r.push(this._createPriceAxisViewOnDemand(this._priceAxisViews,this._panePriceAxisViews,e,t,this._currentPosPriceProvider,Pi,!0)[0]),this._startMeasurePoint&&r.push(this._createPriceAxisViewOnDemand(this._startMeasurePriceAxisViews,null,e,t,this._startMeasurePriceProvider,Ti)[0]),this._lastMeasurePoint()&&r.push(this._createPriceAxisViewOnDemand(this._endMeasurePriceAxisViews,null,e,t,this._endMeasurePriceProvider,Ti)[0]),r}timeAxisViews(){const e=[],t=null===this._requestedPoint||"price"!==this._requestedPoint||!this._isOnHoveredChartWidget;return this._linesShouldBeHidden||!this.visible&&null===we.crosshairLock.value()||!t||e.push(this._timeAxisView),this._startMeasurePoint&&e.push(this._startMeasureTimeAxisView),this._lastMeasurePoint()&&e.push(this._endMeasureTimeAxisView),e}paneViews(e){var t,i;if(void 0===e)return null;const s=[];if(this.isReplaySelection()){let t=this._pointSelectionPaneViewCache.get(e);t||(t=new Cs(this,e,this._model),this._pointSelectionPaneViewCache.set(e,t)),s.push(t)}let r=this._crosshairPaneViewCache.get(e);if(r||(r=new $i(this,e),this._crosshairPaneViewCache.set(e,r)),s.push(r),e===this._selectionPane&&s.push(this._selectionView),e===this._measurePane.value()){let t=this._measurePaneViewCache.get(e);t||(t=new gs(this,e),this._measurePaneViewCache.set(e,t)),t.update((0,z.sourceChangeEvent)(this.id())),s.push(t)}if((zi.addPlusButtonProperty.value()||this._showPlusButtonOnCursor.value())&&1!==(null===(t=we.crosshairLock.value())||void 0===t?void 0:t.type)){const t=e===this.pane,i=!bs.CheckMobile.any()||window.screen.width>=320,r=we.tool.value(),o=(0,pe.isLineToolName)(r),n=null!==this._model.lineBeingEdited()||null!==this._model.lineBeingCreated()||this._model.sourcesBeingMoved().length>0||null!==this._model.customSourceBeingMoved()||(0,we.toolIsMeasure)(r);if(t&&this._isOnHoveredChartWidget&&this._crossHairSelectPointMode.value()===we.SelectPointMode.None&&i&&!o&&!n){const t=e.mainDataSource();if(null!==t){const i=t.priceScale();if(null!==i){const t=this._createPriceAxisViewOnDemand(this._priceAxisViews,this._panePriceAxisViews,e,i,this._currentPosPriceProvider,Pi,!0)[1];null!==t&&s.push(t)}}}}return 0===(null===(i=we.crosshairLock.value())||void 0===i?void 0:i.type)&&(null===this._timeLockPaneView&&(this._timeLockPaneView=new fs(this,e)),s.push(this._timeLockPaneView)),s}dataWindowView(){return this._dataWindowView}updateAllViews(e){this._priceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._panePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),
this._startMeasurePoint&&(this._startMeasurePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._startMeasureTimeAxisView.update(e)),this._lastMeasurePoint()&&(this._endMeasurePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._endMeasureTimeAxisView.update(e)),this._timeAxisView.update(e),this._selectionView.update(),this._dataWindowView.update(),this._updateVisibilityDependentPaneViews()}isMenuEnabled(){return this._options.menuEnabled}isHoveredEnabled(){return zi.addPlusButtonProperty.value()||this._showPlusButtonOnCursor.value()}isHovered(){return this._model.hoveredSource()===this}pointToSelect(){return this._requestedPoint}paneForPointSelect(){return this._paneForRequestedPoint}_lastMeasurePoint(){return this._endMeasurePoint?this._endMeasurePoint:(null!==this.pane&&this._measurePane.value()===this.pane&&(this._lastValidMeasurePoint={price:this._model.magnet().align(this.price,this.index,this.pane),index:this.index}),this._lastValidMeasurePoint||null)}_createPriceAxisViewOnDemand(e,t,i,s,r,n,a=!1){let l=e.get(i),c=null!==t?t.get(i):void 0;void 0===l&&(l=new Map,e.set(i,l),this.isMenuEnabled()&&null!==t&&(c=new Map,t.set(i,c)),a&&i.onDestroyed().subscribe(this,(()=>this._onPaneDestroyed(i))));let h=l.get(s);if(void 0===h){if(h=new n(this,i,s,r),l.set(s,h),void 0!==c){const e=new Gi(h,this,s,this._model,this._options);c.set(s,e)}a&&s.lastSourceRemoved().subscribe(this,(()=>this._onPriceScaleCleared(s)))}let d=null;return void 0!==c&&(d=(0,o.ensureDefined)(c.get(s))),[h,d]}_onPaneDestroyed(e){e.onDestroyed().unsubscribeAll(this),this._priceAxisViews.delete(e),this._panePriceAxisViews.delete(e),this._startMeasurePriceAxisViews.delete(e),this._endMeasurePriceAxisViews.delete(e)}_onPriceScaleCleared(e){e.lastSourceRemoved().unsubscribeAll(this),this._priceAxisViews.forEach((t=>t.delete(e))),this._panePriceAxisViews.forEach((t=>t.delete(e))),this._startMeasurePriceAxisViews.forEach((t=>t.delete(e))),this._endMeasurePriceAxisViews.forEach((t=>t.delete(e)))}_tryToUpdateViews(e,t,i){return!!this._tryToUpdateData(e,t,i)&&(this.updateAllViews((0,z.sourceChangeEvent)(this.id())),this._movedDelegate.fire({index:this.index,price:this.price}),!0)}_tryToUpdateData(e,t,i){const s=this.x,r=this.y,n=this.price,a=this.index,l=this.pane,c=this._priceScaleByPane(i);if(this.index=e,this.x=isNaN(e)?NaN:this._model.timeScale().indexToCoordinate(e),null!==c&&null!==i){this.pane=i,this.price=t;const e=(0,o.ensureNotNull)(i.mainDataSource()).firstValue();this.y=null===e?NaN:c.priceToCoordinate(t,e)}else this.pane=null,this.price=NaN,this.y=NaN;return s!==this.x||r!==this.y||a!==this.index||n!==this.price||l!==this.pane}_priceScaleByPane(e){return e&&!e.defaultPriceScale().isEmpty()?e.defaultPriceScale():null}_setSelectPointModeState(e){e===we.SelectPointMode.None&&(this._requestedPoint=null,this._selectLineColor=null,this._paneForRequestedPoint&&(this._paneForRequestedPoint=null,this._model.panesCollectionChanged().unsubscribe(this,this._paneCollectionChanged))),we.activePointSelectionMode.setValue(e),
this._crossHairSelectPointMode.setValue(e),this._model.lightUpdate()}_paneCollectionChanged(e){const t=this._paneForRequestedPoint;null!==t&&-1===e.indexOf(t)&&this.cancelRequestSelectPoint()}_updateVisibilityDependentPaneViews(){var e;for(const t of this.model().panes())null===(e=this._pointSelectionPaneViewCache.get(t))||void 0===e||e.update()}_getLockData(){var e;if(null===this._lockData){const t=we.crosshairLock.value();if(null===t)this._lockData={};else{const i=this._model.timeScale(),s=null!==(e=i.points().roughIndex(t.time))&&void 0!==e?e:void 0,r=void 0===s?void 0:i.indexToCoordinate(s);switch(t.type){case 0:this._lockData={index:s,xCoord:r};break;case 1:{let e;const i=this.lockedPane();if(null!==i){const s=i.mainDataSource();if(null!==s){const i=s.firstValue(),r=s.priceScale();null!==r&&null!==i&&(e=r.priceToCoordinate(t.price,i))}}this._lockData={index:s,xCoord:r,yCoord:e}}}}}return this._lockData}_createMeasurePointset(e,t){const i=this._normalizePoint(e),s=this._normalizePoint(t),r=[[i.time_t,i.offset],[s.time_t,s.offset]];this._removeMeasurePointset(),++Bs,this._currentMeasurePointsetAndSymbolId={measurePointsetId:Bs,symbolId:(0,o.ensureNotNull)(this._model.mainSeries().seriesSource().symbolInstanceId())};const n=(0,Es.getServerInterval)(this._model.mainSeries().interval());this._model.chartApi().createPointset(this._currentMeasurePointsetIdWithPrefix(),"turnaround",this._currentMeasurePointsetAndSymbolId.symbolId,n,r,this._onPointsetResponse.bind(this))}_removeMeasurePointset(){null!==this._currentMeasurePointsetAndSymbolId&&this._model.chartApi().isConnected().value()&&this._model.chartApi().removePointset(this._currentMeasurePointsetIdWithPrefix()),this._currentMeasurePointsetAndSymbolId=null}_currentMeasurePointsetIdWithPrefix(){return"pointsetMeasure_"+(0,o.ensureNotNull)(this._currentMeasurePointsetAndSymbolId).measurePointsetId}_normalizePoint(e){return{...this._model.timeScale().normalizeBarIndex(e.index),price:e.price}}_onPointsetResponse(e){if("pointset_error"===e.method)return void Rs.logError(`Error getting pointset: ${e.params[0]} ${e.params[1]}`);if(e.params.customId!==this._currentMeasurePointsetIdWithPrefix())return;if(null===this._startMeasurePoint||null===this._endMeasurePoint)return;const t=e.params.plots;if(2!==t.length)return;const i=t[0].value[0],s=t[1].value[0];this._startMeasurePoint.index=i,this._endMeasurePoint.index=s,this.updateAllViews((0,z.sourceChangeEvent)(this.id())),this._model.updateSource(this)}}var Vs=i(983898),Os=i(679356),Fs=i(808068),Ws=i(809796),zs=i(677305),Hs=i(772466),Us=i(62802);class Gs{constructor(e){this._priceSourceNamesById=new Map,e.forEach((e=>this._priceSourceNamesById.set(e.id,e.name)))}name(e){var t;return null!==(t=this._priceSourceNamesById.get(e))&&void 0!==t?t:null}priceSourcesChanged(e){return e.length!==this._priceSourceNamesById.size}}var qs=i(66732);const js=new Ws.TranslatedString("remove deselected empty line tools",c.t(null,void 0,i(59211))),Ys=O.enabled("auto_enable_symbol_labels"),Ks=(0,
ti.isFeatureEnabled)("save_shared_line_tools"),Xs=(0,Q.getLogger)("Chart.ChartModel");function $s(e,t){const i=e.indexOf(t);return-1!==i&&(e.splice(i,1),!0)}function Zs(e){var t,i;for(let s=e.length;s--;){const r=e[s].dataSources();for(let e=r.length;e--;)null===(t=r[e].dataWindowView())||void 0===t||t.update();const o=e[s].priceDataSources();for(let e=o.length;e--;)null===(i=o[e].legendView())||void 0===i||i.update()}}const Qs={isSnapshot:!1,readOnly:!1,watermarkEnabled:!0,shiftVisibleRangeOnNewBar:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,countdownEnabled:!0,lastPriceAnimationEnabled:!0,onWidget:!1,hideIdeas:!1};class Js{constructor(e,t,i,r,o,n,a,l,c,d,u){this._onRearrangePanes=new j.Delegate,this._lineToolsGroupModel=new Mt,this._sourcesBeingMoved=[],this._activeItemBeingMoved=null,this._lineBeingEdited=null,this._linePointBeingEdited=null,this._linePointBeingChanged=null,this._customSourceBeingMovedHitTestData=null,this._customSourceBeingMoved=null,this._dataSourceCollectionChanged=new j.Delegate,this._sourceProperitesChanged=new j.Delegate,this._sourceZOrderChanged=new j.Delegate,this._symbolSourceResolved=new j.Delegate,this._symbolSourceResolvingActive=new Y.WatchedValue(!1),this._adjustForDividendsAvailability=new Y.WatchedValue(0),this._adjustForDividendsEnabled=new Y.WatchedValue(!1),this._sessions=null,this._currentTool="",this._lineBeingCreated=null,this._paneBeingCreatedLineOn=null,this._lineCancelled=new j.Delegate,this._phantomSourceContainer=new hi(this),this._destroyed=!1,this._isSettingsExternalPosition=!1,this._isTimeScrolling=!1,this._magnet=new pi,this._scrollingState=null,this._modelIntervals=[],this._rendererOptionsProvider=new E(this),this._studyInserted=new j.Delegate,this._cachedStudiesMaxOffset=0,this._replayStatus=new Y.WatchedValue(xt.ReplayStatus.Undefined),this._panes=[],this._tagsChanged=new j.Delegate,this._strategySources=[],this._strategySourcesChange=new j.Delegate,this._activeStrategySource=new Y.WatchedValue(null),this._paneCollapsingAvailable=new Y.WatchedValue(!1),this._panesCollectionChanged=new j.Delegate,this._scrollEnabled=O.enabled("chart_scroll"),this._zoomEnabled=O.enabled("chart_zoom"),this._lollipopSourcesWatcher=null,this._alertsWatcher=null,this._hoveredSource=null,this._hoveredSourceChanged=new j.Delegate,this._lastHoveredHittestData=null,this._lastSelectedHittestData=null,this._topmostCustomSources=[],this._fgCustomSources=[],this._bgCustomSources=[],this._allCustomSources=[],this._customSourcesMap=new Map,this._multiPaneSources=[],this._showLegendProperty=new(L()),this._id=(0,J.guid)(),this._chartSaveTime=null,this._availableCurrenciesList=null,this._availableCurrencies=new ai([]),this._availablePriceSources=new Gs([]),this._availableUnitsObject=null,this._availableUnits=new li({}),this._availablePriceSourcesList=null,this._shouldBeSavedEvenIfHidden=!1,this._watchedThemeSpawn=h.watchedTheme.spawn(),this._gradientColorsCache=null,this._studiesWV=new K.WatchedObject([],v.compareTwoCollectionsByIds),
this._studiesExcludeInternalWV=new K.WatchedObject([],v.compareTwoCollectionsByIds),this._resetScalesAvailable=new Y.WatchedValue(!1),this._recalcVRStudiesParams={},this._recalcColorStudiesParams={},this._recalcVisibleRangeStudiesImplDebounced=(0,s.default)(this._recalcVisibleRangeStudiesImpl.bind(this,this._recalcVRStudiesParams),500),this._recalcColorStudiesImplDebounced=(0,s.default)(this._recalcColorStudiesImpl.bind(this,this._recalcColorStudiesParams),250),this._width=0,this._resetScales=new j.Delegate,this._chartThemeLoaded=new j.Delegate,this._selection=new C,this._selectedSourceChanged=new j.Delegate,this._symbolSourceCollectionChanged=new j.Delegate,this._gridSource=new yi,this._syncPointCache=new Map,this._lastAppliedGotoTimeRange=null,this._lastGotoTimeRange=null,this._clearSelection=()=>{this._lastSelectedHittestData=null,this._selection.clear()},this._removeSourceFromSelection=e=>{this._selection.remove(e)},this._addSourceToSelection=(e,t)=>{const i=this._selection.isSelected(e);i&&this._lastSelectedHittestData===t||e&&!e.isSelectionEnabled()||(this._lastSelectedHittestData=t||null,i||this._selection.add(e))},this._recalcSymbolResolvingActive=()=>{for(const e of this._panes)if(e.symbolSourceResolvingActive().value())return void this._symbolSourceResolvingActive.setValue(!0);this._symbolSourceResolvingActive.setValue(!1)},this._recalcAdjustForDividendsAvailibility=()=>{var e,t,i,s;if(this._symbolSourceResolvingActive.value())return void this._adjustForDividendsAvailability.setValue(0);const r=this.mainSeries();switch(null!==(t=null===(e=r.symbolInfo())||void 0===e?void 0:e.allowed_adjustment)&&void 0!==t?t:"none"){case"dividends":return void this._adjustForDividendsAvailability.setValue(2);case"splits":return void this._adjustForDividendsAvailability.setValue(1);case"any":return void this._adjustForDividendsAvailability.setValue(3)}for(const e of this.symbolSources().filter(ve.isActingAsSymbolSource)){if(e.symbolHibernated().value()||e===r)continue;if("any"===(null!==(s=null===(i=e.symbolInfo())||void 0===i?void 0:i.allowed_adjustment)&&void 0!==s?s:"none"))return void this._adjustForDividendsAvailability.setValue(3)}this._adjustForDividendsAvailability.setValue(0)},this._recalcAdjustForDividendsEnabled=()=>{switch(this._adjustForDividendsAvailability.value()){case 2:return void this._adjustForDividendsEnabled.setValue(!0);case 0:case 1:return void this._adjustForDividendsEnabled.setValue(!1)}this._adjustForDividendsEnabled.setValue(this.mainSeries().properties().childs().dividendsAdjustment.value())},this._recalcPaneCollapsingAvailable=e=>{let t=this._panes.filter((e=>!e.collapsed().value())).length;0===t&&e&&this._panes.length>0&&(this._panes[0].collapsed().setValue(!1),t=1),this._paneCollapsingAvailable.setValue(t>1)},this._updateResetScalesAvailableValue=()=>{const e=this._timeScale.resetAvailable().value()||this._panes.some((e=>e.resetPriceScalesAvailable().value()));this._resetScalesAvailable.setValue(e)},this._chartApi=e,this._invalidateHandler=t,this._undoModel=n,this._properties=i,
this._options=(0,se.merge)((0,se.clone)(Qs),l),this._hibernateWV=c,this._linkingGroupIndex=d,this._isAutoSaveEnabled=u,this._studiesMetaInfoRepository=o,this._readOnly=this._options.readOnly,this._isSnapshot=this._options.isSnapshot,this._alertsWatcher=new qt(this),this.onWidget()||$t.withWeekdayProperty.subscribe(this,(()=>this._updateDateTimeFormatter())),this._chartSaveTime=(new Date).valueOf(),this._backgroundColor=new Y.WatchedValue(this._getBackgroundColor()),this._backgroundTopColor=new Y.WatchedValue(this._getBackgroundColor(!0)),this._properties.childs().paneProperties.childs().background.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundType.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundGradientStartColor.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundGradientEndColor.subscribe(this,this._updateBackgroundColor),this._backgroundColor.subscribe(this.recalcColorStudies.bind(this,!1)),this._backgroundTopColor.subscribe(this.recalcColorStudies.bind(this,!1)),this._backgroundCounterColor=new Y.WatchedValue(this._getBackgroundCounterColor()),this._backgroundColor.subscribe((()=>this._backgroundCounterColor.setValue(this._getBackgroundCounterColor()))),this._isDark=(0,qs.combine)((e=>"white"===e),this._backgroundCounterColor.weakReference()),this._watchedThemeSpawn.subscribe(this._updateBackgroundColor.bind(this)),this._symbolSourceResolvingActive.subscribe(this._recalcAdjustForDividendsAvailibility),this.setStudiesMetaData(this._studiesMetaInfoRepository.getInternalMetaInfoArray(),this._studiesMetaInfoRepository.getMigrations()),(0,we.init)();const _=this._readOnly?new(L())((0,N.defaults)("chartproperties.paneProperties.crossHairProperties")):this._properties.childs().paneProperties.childs().crossHairProperties;this.m_crossHairSource=new Ns(this,_,this._options.crossHair),this._crossHairSelectPointMode=this.m_crossHairSource.selectPointMode().spawn(),this._crossHairSelectPointMode.subscribe((e=>{if(e!==we.SelectPointMode.None&&this.lineBeingCreated()){const e=we.tool.value();this.cancelCreatingLine(),we.tool.setValue(e)}})),this._tagsChanged=new j.Delegate;const p=new x.DefaultProperty("chartproperties.mainSeriesProperties");p.addExclusion("minTick"),p.addExclusion("priceAxisProperties.lockScale"),p.addExclusion("priceAxisProperties.percentage"),p.addExclusion("priceAxisProperties.indexedTo100"),p.addExclusion("priceAxisProperties.isInverted"),p.addExclusion("priceAxisProperties.log"),p.addExclusion("priceAxisProperties.logDisabled"),p.addExclusion("priceAxisProperties.percentageDisabled"),p.addExclusion("priceAxisProperties.autoScaleDisabled"),p.merge(i.childs().mainSeriesProperties.state()),this._timeScale=new yt(this,this._options.timeScale),this._timeScale.resetAvailable().subscribe(this._updateResetScalesAvailableValue);const m={countdownEnabled:this._options.countdownEnabled,lastPriceAnimationEnabled:this._options.lastPriceAnimationEnabled}
;this.m_mainSeries=new Se.Series(this,p,m,r),this.m_mainSeries.onStyleChanged().subscribe(this._timeScale,this._timeScale.invalidateVisibleBars);const g=()=>this.fullUpdate();this.m_mainSeries.properties().childs().showCountdown.subscribe(this,(()=>{this.m_mainSeries.updateAllViews((0,z.sourceChangeEvent)(this.m_mainSeries.id())),g()})),(0,$.currencyUnitVisibilityProperty)().subscribe(this,g),(0,Z.autoLogButtonsVisibilityProperty)().subscribe(this,g),this._timeScale.visibleBarsStrictRangeChanged().subscribe(this.m_mainSeries,this.m_mainSeries.clearHighLowPriceCache),this._timeScale.visibleBarsStrictRangeChanged().subscribe(this.m_mainSeries,this.m_mainSeries.clearAveragePriceCache),this.createPane(void 0,{axisProperties:p.childs().priceAxisProperties.state(["autoScale"])}),this._adjustForDividendsAvailability.subscribe(this._recalcAdjustForDividendsEnabled),this.mainSeries().properties().childs().dividendsAdjustment.subscribe(this,this._recalcAdjustForDividendsEnabled),this._recalcAdjustForDividendsEnabled(),this._boundUpdateStudiesMaxOffset=this._updateStudiesMaxOffset.bind(this),this.mainSeries().dataEvents().seriesTimeFrame().subscribe(this,((e,t,i,s)=>{if(null!==this._lastAppliedGotoTimeRange&&null!==i&&s&&(0,di.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i)){const e=this.appliedTimeFrame().value();null!==e&&!this._lastAppliedGotoTimeRange.actual&&(0,di.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,e.val)&&this.appliedTimeFrame().setValue(null),this._lastAppliedGotoTimeRange=null}})),this.mainSeries().dataEvents().completed().subscribe(this,(e=>{null===this._lastAppliedGotoTimeRange&&null!==this._lastGotoTimeRange&&(this.gotoTimeRange(this._lastGotoTimeRange.from,this._lastGotoTimeRange.to),this._lastGotoTimeRange=null)}));const S=this._panes[0];S.setStretchFactor(2*S.stretchFactor()),this._properties.listeners().subscribe(this,this.lightUpdate),this._properties.childs().timezone.subscribe(null,(()=>{this._chartApi&&this._chartApi.isConnected().value()&&this._chartApi.switchTimezone(this.timezone())})),S.addDataSource(this.m_mainSeries,S.findSuitableScale(this.m_mainSeries),!1),this._barsMarksSources=a(this);for(const e of this._barsMarksSources)e.setOwnerSource(this.m_mainSeries),S.addDataSource(e,this.m_mainSeries.priceScale(),!0);this.m_mainSeries.symbolResolved().subscribe(this,this._clearAvailablePriceSources)}setStudiesMetaData(e,t){this._studiesMetaData=e,this._studyVersioning=new w.StudyVersioning(this._studiesMetaData,t)}restart(){this._chartApi.switchTimezone(this.timezone()),this._timeScale.reset(),this.m_mainSeries.restart();for(const e of this.dataSources())e.restart&&e!==this.m_mainSeries&&e.restart();this.sessions().restart()}version(){return 3}collapsed(){return this._hibernateWV}chartSaveTime(){return this._chartSaveTime}setChartSaveTime(e){this._chartSaveTime=e}destroy(){this._phantomSourceContainer.destroy(),this._hoveredSourceChanged.destroy(),null!==this._watermarkSource&&(this._watermarkSource.destroy(),this._watermarkSource=null),
Array.from(this._customSourcesMap.keys()).forEach(this._removeCustomSource,this),(0,o.assert)(0===this._topmostCustomSources.length),(0,o.assert)(0===this._fgCustomSources.length),(0,o.assert)(0===this._bgCustomSources.length),(0,o.assert)(0===this._allCustomSources.length),(0,o.assert)(0===this._customSourcesMap.size),null!==this._lollipopSourcesWatcher&&(this._lollipopSourcesWatcher.destroy(),this._lollipopSourcesWatcher=null),null!==this._alertsWatcher&&this._alertsWatcher.destroy(),this.onWidget()||$t.withWeekdayProperty.unsubscribeAll(this),this._properties.childs().paneProperties.childs().background.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundType.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundGradientEndColor.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundGradientStartColor.unsubscribeAll(this),this._watchedThemeSpawn.destroy(),this._lastHoveredHittestData=null,this._lastSelectedHittestData=null,(0,$.currencyUnitVisibilityProperty)().unsubscribeAll(this),(0,Z.autoLogButtonsVisibilityProperty)().unsubscribeAll(this),this._alertsList&&(this._alertsList.destroy(),this._alertsList=void 0),window.loginStateChange.unsubscribeAll(this),this._crossHairSelectPointMode.destroy(),this.m_mainSeries.symbolResolved().unsubscribe(this,this._clearAvailablePriceSources),this._destroyed=!0}undoModel(){return this._undoModel}onData(e){switch(e.method){case"timescale_update":{const t=e.params;this._updateTimeScale({index:t.index,zoffset:t.zoffset,values:t.changes,indexDiffs:t.index_diff,baseIndex:t.baseIndex,marks:t.marks,clearFlag:t.clear});break}case"timescale_completed":{const t=Boolean(e.params[0]);this._timeScale.onTimeScaleCompleted(t);break}}}addStrategySource(e,t){1!==t&&-1===this._strategySources.indexOf(e)&&(this._strategySources.push(e),this._strategySourcesChange.fire(t),this.setActiveStrategySource(e))}removeStrategySource(e,t){if(1===t)return;const i=this._strategySources.indexOf(e);if(-1!==i){if(this._strategySources.splice(i,1)[0]===this._activeStrategySource.value()&&this.unsetActiveStrategySource(),this._strategySources.length>0){const e=this._strategySources[this._strategySources.length-1];this.setActiveStrategySource(e)}this._strategySourcesChange.fire(t)}}setActiveStrategySource(e){-1!==this._strategySources.indexOf(e)&&this._activeStrategySource.setValue(e)}unsetActiveStrategySource(){this._activeStrategySource.setValue(null)}activeStrategySource(){return this._activeStrategySource}strategySources(){return this._strategySources}strategySourcesChange(){return this._strategySourcesChange}setScrollEnabled(e){this._scrollEnabled=e}scrollEnabled(){return this._scrollEnabled}setZoomEnabled(e){this._zoomEnabled=e}zoomEnabled(){return this._zoomEnabled}zoomToViewport(e,t,i,s,r){this.setTimeViewport(e,t);let o=Math.min(i,s),n=Math.max(i,s);const a=r.defaultPriceScale();a.isPercentage()||a.setMode({autoScale:!1}),a.isLog()&&(o=a.priceToLogical(o),n=a.priceToLogical(n)),a.setPriceRange(new me.PriceRange(o,n)),
this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.invalidate(this._paneInvalidationMask(r,X.InvalidationLevel.Light))}setTimeViewport(e,t){const i=this.appliedTimeFrame().value();null!==this._lastAppliedGotoTimeRange&&null!==i&&(0,di.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i.val)&&!this._lastAppliedGotoTimeRange.actual||(this.timeScale().zoomToBarsRange(e,t),this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.recalcVisibleRangeStudies(),this.lightUpdate())}onTagsChanged(){return this._tagsChanged}canZoomIn(){return this._timeScale.canZoomIn()&&this._zoomEnabled}canZoomOut(){return this._timeScale.canZoomOut()&&this._zoomEnabled}onPaneTagsChanged(){this._tagsChanged.fire()}panesCollectionChanged(){return this._panesCollectionChanged}dataSourceCollectionChanged(){return this._dataSourceCollectionChanged}symbolSourceCollectionChanged(){return this._symbolSourceCollectionChanged}symbolSourceResolved(){return this._symbolSourceResolved}symbolSourceResolvingActive(){return this._symbolSourceResolvingActive}adjustForDividendsAvailability(){return this._adjustForDividendsAvailability}adjustForDividendsEnabled(){return this._adjustForDividendsEnabled}paneCollapsingAvailable(){return this._paneCollapsingAvailable}sourcePropertiesChanged(){return this._sourceProperitesChanged}sourceZOrderChanged(){return this._sourceZOrderChanged}zoomTime(e,t,i){if(!this._zoomEnabled)return;const s=this.timeScale();if(s.isEmpty()||0===t)return;const r=s.width();e=Math.max(1,Math.min(e,r-2)),s.zoom(e,t,i),this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.lightUpdate(),this.recalcVisibleRangeStudies()}lineBeingEdited(){return this._lineBeingEdited}linePointBeingEdited(){return this._linePointBeingEdited}activeItemBeingMoved(){return this._activeItemBeingMoved}linePointBeingChanged(){return this._linePointBeingChanged}updateAllPaneViews(e){for(const t of this._panes)t.updateAllViews(e)}dataSources(){const e=[this.crossHairSource()];for(const t of this._panes)for(const i of t.dataSources())e.push(i);return e}priceDataSources(){const e=[];for(const t of this._panes)for(const i of t.priceDataSources())e.push(i);return e}symbolSources(){const e=[];for(const t of this._panes)for(const i of t.symbolSources())e.push(i);return e}selection(){return this._selection}selectionMacro(e,t=!1){const i=this.selection().allSources();e({removeSourceFromSelection:this._removeSourceFromSelection,addSourceToSelection:this._addSourceToSelection,clearSelection:this._clearSelection,selection:this.selection.bind(this)});const s=(0,v.subtract)(i,this.selection().allSources()),r=(0,v.subtract)(this.selection().allSources(),i);r.concat(i).forEach((e=>e.updateAllViews((0,z.selectionChangeEvent)())));let o=[];s.forEach((e=>{if((0,b.isLineTool)(e)){const i=e.hasAlert.value()&&e.getAlertSync();i&&i.setSelected(!1),!t&&e.shouldBeRemovedOnDeselect()&&o.push(e)}})),r.forEach((e=>{const t=(0,b.isLineTool)(e)&&e.hasAlert&&e.hasAlert.value()&&e.getAlertSync();t&&t.setSelected(!0)})),o=o.filter((e=>null!==this.dataSourceForId(e.id()))),
o.length>0&&this._undoModel.removeSources(o,!1,js),this.lightUpdate(),(s.length>0||r.length>0)&&this._selectedSourceChanged.fire()}onSelectedSourceChanged(){return this._selectedSourceChanged}checkLineToolSelection(){const e=this.selection().allSources();this._selection.checkLineToolSelection(),e.length!==this.selection().allSources().length&&this._selectedSourceChanged.fire()}lineToolsGroupModel(){return this._lineToolsGroupModel}restoreLineToolsGroups(e){this._lineToolsGroupModel=Mt.fromState(this,e)}realignLineTools(e){for(const t of this._panes)(void 0===e||t.hasDataSource(e))&&t.realignLineTools(e)&&this._dataSourceCollectionChanged.fire(t)}copyToOtherCharts(e,t){const i=this.mainSeries(),s=i.syncModel(),r=this.timeScale();if(s)for(const n of e){if(!n.isSynchronizable())continue;const e=n.linkKey().value()||(0,J.randomHash)();n.linkKey().setValue(e);const a=n.state(!1),l=n.normalizedPoints(),c=n.properties().interval.value(),h=i.interval();let d;if(M.Interval.isEqual(c,h))d=l.map((e=>{const t=(0,o.ensureNotNull)(r.timePointToIndex(e.time_t))+e.offset;return{price:e.price,timeStamp:(0,o.ensureNotNull)(this.externalTimeStamp(t))}}));else{const e=s.createNewModelWithResolution(c);d=l.map((t=>({price:t.price,timeStamp:0===t.offset?t.time_t:e.projectTime(t.time_t,t.offset)})))}const u={...a,id:n.id(),linkKey:e,points:d,linetool:n.toolname,model:this,symbol:i.symbol(),withUndo:t,zOrder:n.zorder(),finalState:{points:l,interval:c},pointPositionPercents:n.isFixed()?n.calcPositionPercents():void 0,sharingMode:n.sharingMode().value()};(0,we.copyLineTool)(u)}}isSnapshot(){return this._isSnapshot}onWidget(){return this._options.onWidget}hideIdeas(){return this._options.hideIdeas}updateSource(e){const t=this._invalidationMaskForSource(e);null!==t&&this.invalidate(t)}updateSourcePriceScale(e){const t=this._invalidationMaskForSourcePriceScale(e);null!==t&&this.invalidate(t)}updatePane(e){this.invalidate(this._paneInvalidationMask(e))}updateTimeScaleBaseIndex(e){const t=this.mainSeries().bars();t.isEmpty()||this._updateBaseIndex((0,o.ensureNotNull)(t.lastIndex()),!!(e&&e.index>0))}setInterval(e,t){const i=setInterval(e,t);return this._modelIntervals.push(i),i}clearInterval(e){clearInterval(e);const t=this._modelIntervals.indexOf(e);t>-1&&this._modelIntervals.splice(t,1)}clearIntervals(){for(let e=0;e<this._modelIntervals.length;e++)clearInterval(this._modelIntervals[e]);this._modelIntervals=[]}insertStudyWithParams(e,t,i,s,n,a,l,c,h,d,u){var _,p,m;let g=null;if(!n&&void 0!==e.groupingKey){const t=this.findNonOverlayStudyWithGroupingKey(e.groupingKey);null!==t&&(g=t.pane)}null===g&&(n||e.is_price_study?g=(0,o.ensureNotNull)(this.paneForSource(null!==(_=null==a?void 0:a[0])&&void 0!==_?_:this.m_mainSeries)):(g=this.createPane(),void 0!==d&&g.setPaneSize(d))),"Compare@tv-basicstudies"===e.id&&this.m_mainSeries.priceScale().setMode({log:!1,percentage:!0});const S=(0,se.merge)((0,r.default)(null!=s?s:{}),{inputs:t,parentSources:[]}),v=null!=a?a:[],f=(0,T.prepareStudyProperties)(e,S,g,this.studyVersioning(),v),b=(0,
q.createStudy)(this,f,v,e,u);this._recalcVisibleRangeStudiesImpl({studies:[b],oldEndVisibleIndex:-1,oldStartVisibleIndex:-1,force:!0,timerId:null});const y=g.findSuitableScale(b,null!==(p=null==a?void 0:a[0])&&void 0!==p?p:this.mainSeries(),l);if(y===this.mainSeries().priceScale()&&(0,ve.isSymbolSource)(b)){const e=c?(0,zs.sourceNewCurrencyOnPinningToPriceScale)(b,y,this,!0):null,t=h?(0,fe.sourceNewUnitOnPinningToPriceScale)(b,y,this,!0):null;null===e&&null===t||b.setSymbolParams({currency:e||void 0,unit:t||void 0})}(0,ve.isSymbolSource)(b)&&(0,o.ensureNotNull)(g).hasDataSource(this.mainSeries())&&Ys&&!Us.getBool("enable_symbol_labels_on_inserting_compare_once",!1)&&((0,x.saveDefaultProperties)(!0),this.properties().childs().scalesProperties.childs().showSymbolLabels.setValue(!0),(0,x.saveDefaultProperties)(!1),Us.setValue("enable_symbol_labels_on_inserting_compare_once",!0));const C=b.start();if(i&&g.id()===i.paneId)g.insertDataSource(b,y,i.zorder);else{g.addDataSource(b,y,!1);null!==b.preferredZOrder()&&g.insertAfter([b],this.mainSeries())}return b.isLinkedToSeries()&&b.setOwnerSource(this.mainSeries()),this.recalculatePane(g,(0,z.sourceChangeEvent)(b.id())),this.fullUpdate(),this._invalidateBarColorerCaches(),this._recalcVisibleRangeStudiesImpl({studies:[b],force:!0}),this._recalcColorStudiesImpl({studies:[b],force:!0}),this._studyInserted.fire(b),null===(m=this.alertsWatcher())||void 0===m||m.syncSourceAlertLabels(b),b.maxOffset().subscribe(this._boundUpdateStudiesMaxOffset,{callWithLast:!0}),{study:b,startPromise:C}}replaceStudyStub(e,t){const i=this.paneForSource(e);if(null===i)return!1;const s=e.priceScale(),r=e.zorder(),o=e.ownerSource();return this.paneForSource(e)===i?i.replaceSource(e,t,s):(i.insertDataSource(t,s,r),this.removeSource(e)),t.setOwnerSource(o),this.dataSources().forEach((i=>{i.ownerSource()===e&&i.setOwnerSource(t)})),this._invalidateBarColorerCaches(),t.start(),this.recalculatePane(i,(0,z.sourceChangeEvent)(t.id())),this.fullUpdate(),!0}insertStudyStub(e){const t=this.mainSeries(),i=(0,o.ensureNotNull)(this.paneForSource(t)),s=new P.StudyStub(this,null,e),r=i.createPriceScaleAtPosition("overlay");return i.addDataSource(s,r,!1),this.recalculatePane(i,(0,z.sourceChangeEvent)(s.id())),this.fullUpdate(),s}removeStudyStub(e){const t=this.dataSourceForId(e);return null===t?(Xs.logNormal("StudyStub id="+e+" is not found in chart model"),!1):(this.removeSource(t),!0)}allLineTools(){return this._getAllSources(b.isLineTool)}setHoveredSource(e,t=null){const i=this._hoveredSource!==e;if(!i&&this._lastHoveredHittestData===t)return;this._lastHoveredHittestData=t;let s=null;if(this._hoveredSource){this._hoveredSource.updateAllViews((0,z.selectionChangeEvent)()),s=new X.InvalidationMask(X.InvalidationLevel.Cursor);const e=this._invalidationMaskForSource(this._hoveredSource,X.InvalidationLevel.Light);null!==e&&s.merge(e)}if(this._hoveredSource=e,e){e.updateAllViews((0,z.selectionChangeEvent)()),s||(s=new X.InvalidationMask(X.InvalidationLevel.Cursor))
;const t=this._invalidationMaskForSource(e,X.InvalidationLevel.Light);null!==t&&s.merge(t)}s&&this.invalidate(s),i&&this._hoveredSourceChanged.fire(e)}properties(){return this._properties}chartApi(){return this._chartApi}disconnect(){this.sessions().stop();for(const e of this.dataSources())e.disconnect&&e.disconnect();this._timeScale.disconnect()}crossHairSource(){return this.m_crossHairSource}gridSource(){return this._gridSource}publishedChartsTimelineSource(){for(const e of this._barsMarksSources)if(e instanceof Zt.PublishedChartsTimeline)return e;return null}hoveredSource(){return this._hoveredSource}hoveredSourceChanged(){return this._hoveredSourceChanged}lastHittestData(){return this._lastHoveredHittestData}lastSelectedHittestData(){return this._lastSelectedHittestData}syncTimeWithModel(e,t){const i=this.mainSeries().syncModel();if(null===i)return;const s=1e3*this.createSyncPoint(e,i.syncSourceTarget()).sourceTimeToTargetTime(t/1e3),r=(0,It.get_timezone)(this.timezone());let o=(0,It.utc_to_cal)(r,s);this.mainSeries().isDWM()&&(o=i.getSession().spec.correctTradingDay(o),(0,It.set_hms)(o,0,0,0,0,(0,It.get_timezone)("Etc/UTC"))),this._gotoTimeImpl(o.getTime(),{centerIfVisible:!1})}gotoTime(e){return this._gotoTimeImpl(e,{centerIfVisible:!0})}recalculatePane(e,t){null==e||e.recalculate(t)}recalculateAllPanes(e){this._panes.forEach((t=>t.recalculate(e))),this.updateAllPaneViews(e),this.crossHairSource().updateAllViews(e)}gotoTimeRange(e,t){const i=this.timeScale(),s=i.tickMarks(),r=this.mainSeries();if(void 0===s.minIndex)return void(this._lastGotoTimeRange={from:e,to:t});let n=e,a=t;const l=r.symbolInfo();if(null!==l){let i=this.properties().childs().timezone.value();"exchange"===i&&(i=l.timezone);const s=(0,It.get_timezone)(i),o=(0,It.utc_to_cal)(s,e),c=(0,It.utc_to_cal)(s,t);if(r.isDWM()){const e=(0,It.get_timezone)("Etc/UTC");(0,It.set_hms)(o,0,0,0,0,e),(0,It.set_hms)(c,0,0,0,0,e)}n=o.getTime(),a=c.getTime()}const c=(0,o.ensureDefined)(s.maxIndex),h=(0,o.ensureDefined)(s.minIndex);if(n>=(0,o.ensureNotNull)(s.indexToTime(h)).valueOf()||r.endOfData()){const e=(e,t)=>e<t,t=e=>(0,o.ensureNotNull)(s.indexToTime(e)).valueOf(),l=(0,v.lowerboundExt)(t,n,e,s.nearestIndex(n),c);let d=n===a?l:(0,v.lowerboundExt)(t,a,e,s.nearestIndex(a),c);this._lastGotoTimeRange=null,null!==this._lastAppliedGotoTimeRange&&(this._lastAppliedGotoTimeRange.actual=!1);const u=i.baseIndex();if(l+Math.max(d-l+1,i.minVisibleBarCount())>u){const e=i.targetDefaultRightOffset();d-u<e&&(d=u+e)}if(l!==d)i.zoomToBarsRange(l,d),this.lightUpdate();else if(l===h&&r.endOfData())i.zoomToBarsRange(l-1,d),this.lightUpdate();else{const e=((0,o.ensureNotNull)(i.logicalRange()).left()-l+1)*i.barSpacing();this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime()}}else{const i={type:"time-range",from:e/1e3,to:t/1e3};null===this._lastAppliedGotoTimeRange?(this._lastAppliedGotoTimeRange={range:i,actual:!0},r.loadDataTo(i)):(0,di.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i)||(this._lastGotoTimeRange={from:e,to:t})}}paneForSource(e){if(!(0,
S.isDataSource)(e))return Array.from(this._customSourcesMap.values()).includes(e)?this.paneForSource(this.mainSeries()):null;for(let t=this._panes.length-1;t>=0;t--)if(this._panes[t].hasDataSource(e))return this._panes[t];return e instanceof ri.BarsMarksContainer?this.paneForSource(this.mainSeries()):null}mainPane(){for(const e of this._panes)if(e.isMainPane())return e;throw new Error("Main pane is not found")}lastPane(){return this._panes[this._panes.length-1]}removeSource(e,t){this.selectionMacro((t=>t.removeSourceFromSelection(e)),!0),this._hoveredSource===e&&(this._hoveredSource=null,this._lastHoveredHittestData=null),this._sourcesBeingMoved.includes(e)&&(this._sourcesBeingMoved=this._sourcesBeingMoved.filter((t=>t!==e)),this._sourcesBeingMoved.length||(this._activeItemBeingMoved=null)),e===this._lineBeingEdited&&(this._lineBeingEdited=null,we.isToolEditingNow.setValue(!1)),e===this._lineBeingCreated&&(this._lineBeingCreated=null,we.isToolCreatingNow.setValue(!1)),!t&&e.stop&&e.stop();(0,o.ensureNotNull)(this.alertsWatcher()).removeSourceAlertLabels(e);const i=this.detachSource(e),s=this.mainSeries().priceScale();return(0,q.isStudy)(e)&&(0,ve.isActingAsSymbolSource)(e)&&e.priceScale()===s&&s.isPercentage()&&1===s.seriesLikeSources().filter(ve.isActingAsSymbolSource).length&&s.setMode({percentage:!1}),this.fullUpdate(),this._invalidateBarColorerCaches(),(0,q.isStudy)(e)&&((0,p.emit)("study_event",e.id(),"remove"),e.isChildStudy()&&e.parentSources().forEach((t=>t.unsetChild(e))),e.maxOffset().unsubscribe(this._boundUpdateStudiesMaxOffset)),!t&&e.destroy&&e.destroy(),(0,b.isLineTool)(e)&&(e.removeAlert(),(0,p.emit)("drawing_event",e.id(),"remove")),i}allStudies(e){const t=e?e=>(0,q.isStudy)(e)&&!(0,ae.isLollipopDataSource)(e):q.isStudy;return this._getAllSources(t)}studiesWV(e){return e?this._studiesExcludeInternalWV.readonly():this._studiesWV.readonly()}findNonOverlayStudyWithGroupingKey(e,t){const i=void 0!==t?[t]:this._panes;for(const t of i){const i=t.dataSources().find((i=>(0,q.isStudy)(i)&&i.metaInfo().groupingKey===e&&!t.isOverlay(i)));if(void 0!==i)return{pane:t,study:i}}return null}movePaneUp(e){this.movePane(e,e-1)}movePaneDown(e){this.movePane(e,e+1)}movePane(e,t){const i=this._panes[e];this._panes.splice(e,1),this._panes.splice(t,0,i),this._panesCollectionChanged.fire(this._panes),this._onRearrangePanes.fire(),this.invalidate(X.InvalidationMask.panesOrder())}toggleCollapsedPane(e){const t=this._panes[e];t.collapsed().setValue(!t.collapsed().value()),this.fullUpdate()}backgroundColor(){return this._backgroundColor}backgroundTopColor(){return this._backgroundTopColor}backgroundColorAtYPercentFromTop(e){const t=this.backgroundColor().value(),i=this.backgroundTopColor().value();if(t===i)return t;if(e=Math.max(0,Math.min(100,Math.round(100*e))),null===this._gradientColorsCache||this._gradientColorsCache.topColor!==i||this._gradientColorsCache.bottomColor!==t)this._gradientColorsCache={topColor:i,bottomColor:t,colors:new Map};else{const t=this._gradientColorsCache.colors.get(e);if(void 0!==t)return t}
const s=(0,si.gradientColorAtPercent)(i,t,e/100);return this._gradientColorsCache.colors.set(e,s),s}backgroundCounterColor(){return this._backgroundCounterColor.readonly()}dark(){return this._isDark}defaultResolutions(){return this.chartApi().defaultResolutions()}availableCurrencies(){const e=this._getAvailableCurrencies();return e.length!==this._availableCurrencies.size()&&(this._availableCurrencies=new ai(e)),this._availableCurrencies}currencyConversionEnabled(){return this._options.currencyConversionEnabled}availableUnits(){const e=this._getAvailableUnits();return this._availableUnits.unitsChanged(e)&&(this._availableUnits=new li(e)),this._availableUnits}unitConversionEnabled(){return this._options.unitConversionEnabled}availablePriceSources(){const e=this._getAvailablePriceSources();return null!==e&&this._availablePriceSources.priceSourcesChanged(e)&&(this._availablePriceSources=new Gs(e)),this._availablePriceSources}resetDeferredStudies(){Ne.instance(this).reset()}isJustClonedChart(){return this._undoModel.isJustClonedChart()}studyTemplate(e,t,i){const s={panes:[],version:this.version()};for(const e of this.panes())s.panes.push(e.state(!0,!1,!0));const r=this.mainSeries();return e&&(s.symbol=r.symbol(),this.currencyConversionEnabled()&&i&&(s.currency=r.currency()),this.unitConversionEnabled()&&i&&(s.unit=r.unit())),t&&(s.interval=r.interval()),s}getStudyById(e){const t=this.dataSourceForId(e);return null!==t&&(0,q.isStudy)(t)?t:null}getLineToolById(e){const t=this.dataSourceForId(e);return null!==t&&(0,b.isLineTool)(t)?t:null}restoreLineToolState(e,t,i){var s;e.restorePoints(t.points,t.indexes||[]),t.state.intervalsVisibilities=(0,Oe.mergeIntervalVisibilitiesDefaults)(t.state.intervalsVisibilities),e.properties().merge(t.state),e.restoreData&&e.restoreData(t),e.linkKey().setValue(t.linkKey||null),e.createServerPoints(),e.setZorder(null!==(s=t.zorder)&&void 0!==s?s:e.zorder()),this.fullUpdate();const r=e.linkKey().value();null!==r&&i&&(0,we.restoreLineToolState)({model:this,linkKey:r,state:t})}preferences(){return(0,Os.preferencesByWhiteList)(this,this.mainSeries())}restoreTheme(e,t,i){e.mainSourceProperties.hollowCandleStyle||(e.mainSourceProperties.hollowCandleStyle=e.mainSourceProperties.candleStyle),this._undoModel.chartLoadTheme(e,t,i)}onResetScales(){return this._resetScales}startMovingSources(e,t,i,s,r,n){this._sourcesBeingMoved=e,this._activeItemBeingMoved=i;let a=!1;if(this._sourcesBeingMoved.forEach((e=>{!a&&(0,q.isStudy)(e)&&(a=!0);const l=(0,o.ensureNotNull)(this.paneForSource(e)),c=(0,b.isLineTool)(e),h=c&&e.linkKey().value();if(!1!==h&&null!==h&&s.has(h)&&c&&e.isFixed()){const t=(0,o.ensureDefined)(s.get(h)),a={screen:this._percentPositionToPoint(t,l)};e.startMoving(a,i,r,n)}else e.startMoving(t,i,r,n);const d=this._paneInvalidationMask(l,X.InvalidationLevel.Light);this.invalidate(d)})),!n){const s=e.filter(b.isLineTool).filter((e=>e.linkKey().value()&&e.isSynchronizable())).map((e=>e.linkKey().value()));if(s.length&&t.logical){const n=this.externalTimeStamp(t.logical.index),a={linkKeys:s,
model:this,symbol:this.mainSeries().symbol(),point:{price:t.logical.price,timeStamp:n},activeItem:null!==i?i:void 0,envState:r,pointPositionPercents:new Map};e.forEach((e=>{if((0,b.isLineTool)(e)){const i=e.linkKey().value();if(i&&e.isSynchronizable()&&e.isFixed()){const s=(0,o.ensureNotNull)(this.paneForSource(e));a.pointPositionPercents.set(i,this._pointToPercentPosition((0,o.ensureDefined)(t.screen),s))}}})),(0,we.startMovingLineTool)(a)}}we.isToolMovingNow.setValue(!0),a&&we.isStudyEditingNow.setValue(!0)}moveSources(e,t,i,s){if(this._sourcesBeingMoved.filter((e=>!e.isLocked||!e.isLocked())).forEach((r=>{const n=(0,b.isLineTool)(r)?r.linkKey().value():null;if(null!==n&&t.has(n)){const e=(0,o.ensureNotNull)(this.paneForSource(r)),a=(0,o.ensureDefined)(t.get(n)),l={screen:this._percentPositionToPoint(a,e)};r.move(l,this._activeItemBeingMoved,i,s)}else r.move(e,this._activeItemBeingMoved,i,s)})),this.lightUpdate(),!s&&e.logical){const t=this._sourcesBeingMoved.filter(b.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey().value())).map((e=>e.linkKey().value())),s=this.externalTimeStamp(e.logical.index),r={linkKeys:t,model:this,point:{price:e.logical.price,timeStamp:s},envState:i,pointPositionPercents:new Map};this._sourcesBeingMoved.filter(b.isLineTool).forEach((t=>{if(t.linkKey().value()&&t.isSynchronizable()&&t.isFixed()){const i=(0,o.ensureNotNull)(this.paneForSource(t));r.pointPositionPercents.set(t.linkKey().value(),this._pointToPercentPosition((0,o.ensureDefined)(e.screen),i))}})),(0,we.moveLineTool)(r)}}endMovingSources(e,t,i){const s=this._sourcesBeingMoved.map((s=>{const r=(0,o.ensureNotNull)(this.paneForSource(s)),n=s.endMoving(e,t,i),a=this._paneInvalidationMask(r,X.InvalidationLevel.Light);return a.invalidateAll(X.InvalidationLevel.Light),this.invalidate(a),n})),r=this._sourcesBeingMoved.filter(b.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey().value())).map((e=>e.linkKey().value())),n=this._sourcesBeingMoved.filter(b.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey)).map((e=>{const t={points:e.normalizedPoints(),interval:this.mainSeries().interval()};return e.isFixed()&&(t.pointPositionPercents=e.calcPositionPercents()),t}));r.length&&(0,we.finishMovingLineTool)({linkKeys:r,model:this,finalStates:n,changes:s}),this._sourcesBeingMoved=[],this._activeItemBeingMoved=null,we.isToolMovingNow.setValue(!1),we.isStudyEditingNow.setValue(!1)}sourcesBeingMoved(){return this._sourcesBeingMoved}setMovingCustomSource(e,t){this._customSourceBeingMoved=e,this._customSourceBeingMovedHitTestData=null!==t?{beingMoved:!1,...t}:null}processingCustomSourceMove(){null!==this._customSourceBeingMovedHitTestData&&(this._customSourceBeingMovedHitTestData.beingMoved=!0)}customSourceMovingHitTestData(){return this._customSourceBeingMovedHitTestData}customSourceBeingMoved(){return null!==this._customSourceBeingMovedHitTestData&&this._customSourceBeingMovedHitTestData.beingMoved?this._customSourceBeingMoved:null}lineToolsSynchronizer(){return this._lineToolsSynchronizer}setLineToolsSynchronizer(e){
this._lineToolsSynchronizer=e}width(){return this._width}setWidth(e,t){this._width=e,this._timeScale.setWidth(e,t);for(const t of this._panes)t.setWidth(e);this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.recalcVisibleRangeStudies()}setPaneHeight(e,t){e.setHeight(t),this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.lightUpdate()}resetScalesAvailable(){return this._resetScalesAvailable.readonly()}panes(){return this._panes}paneForId(e){return this._panes.find((t=>t.id()===e))||null}createPane(e,t,i){const s=this._undoModel.chartWidget();s.isMaximizedPane()&&s.toggleMaximizePane(null);const r=this._properties.childs().paneProperties;t&&r.merge(t);const o=new Ke(this._timeScale,r,this,i);return void 0!==e?this._panes.splice(e,0,o):this._panes.push(o),o.onTagsChanged().subscribe(this,Js.prototype.onPaneTagsChanged),o.dataSourcesCollectionChanged().subscribe(this,(()=>this._dataSourceCollectionChanged.fire(o))),o.symbolSourceCollectionChanged().subscribe(this,(()=>this._onSymbolSourceCollectionChanged(o))),o.priceSourcesCollectionChanged().subscribe(this,(()=>this._onPriceSourcesCollectionChanged(o))),o.sourcePropertiesChanged().subscribe(this,(e=>this._sourceProperitesChanged.fire(o,e))),o.sourceZOrderChanged().subscribe(this,(e=>this._sourceZOrderChanged.fire(o,e))),o.symbolSourceResolved().subscribe(this,(e=>this._symbolSourceResolved.fire(o,e))),o.symbolSourceResolvingActive().subscribe(this._recalcSymbolResolvingActive),o.collapsed().subscribe(this._recalcPaneCollapsingAvailable),o.resetPriceScalesAvailable().subscribe(this._updateResetScalesAvailableValue,{callWithLast:!0}),this._recalcPaneCollapsingAvailable(),this._panesCollectionChanged.fire(this._panes),this.invalidate(X.InvalidationMask.panesOrder()),o}removePane(e){const t=this._undoModel.chartWidget();t.isMaximizedPane()&&t.toggleMaximizePane(null);const i=e;i.destroy();const s=this._panes.indexOf(i);-1!==s&&(this._panes.splice(s,1),e.dataSourcesCollectionChanged().unsubscribeAll(this),e.symbolSourceCollectionChanged().unsubscribeAll(this),e.priceSourcesCollectionChanged().unsubscribeAll(this),e.sourcePropertiesChanged().unsubscribeAll(this),e.onTagsChanged().unsubscribeAll(this),e.symbolSourceResolved().unsubscribeAll(this),i.symbolSourceResolvingActive().unsubscribe(this._recalcSymbolResolvingActive),e.collapsed().unsubscribe(this._recalcPaneCollapsingAvailable),e.resetPriceScalesAvailable().unsubscribe(this._updateResetScalesAvailableValue),this._recalcPaneCollapsingAvailable(!0)),this._updateResetScalesAvailableValue();this.crossHairSource().pane===e&&this.clearCurrentPosition(),this._panesCollectionChanged.fire(this._panes),this.invalidate(X.InvalidationMask.panesOrder())}changePanesHeight(e,t){if(this._panes.length<2)return;(0,o.assert)(e>=0&&e<this._panes.length,"Invalid pane index");const i=this._panes[e],s=this._panes.reduce(((e,t)=>e+t.stretchFactor()),0),r=this._panes.reduce(((e,t)=>e+t.height()),0),n=r-30*(this._panes.length-1);t=Math.min(n,Math.max(30,t));const a=s/r,l=i.height();i.setStretchFactor(t*a)
;let c=t-l,h=this._panes.length-1;for(const e of this._panes)if(e!==i){const t=Math.min(n,Math.max(30,e.height()-c/h));c-=e.height()-t,h-=1;const i=t*a;e.setStretchFactor(i)}this.fullUpdate()}clearCurrentPosition(){const e=this.crossHairSource();e.clearPosition(),(0,o.ensureNotNull)(e.dataWindowView()).update(),Zs(this._panes),this.invalidate(X.InvalidationMask.cursor());const t=this._undoModel.chartWidget();t.chartWidgetCollection().syncCrosshair(null,t.id()),this._phantomSourceContainer.onCursorPositionUpdated()}setAndSaveCurrentPosition(e,t,i,s){this.crossHairSource().saveOriginCoords(e,t),this.setCurrentPosition(e,t,i,s)}setCurrentPosition(e,t,i,s){var r,n,a,l,c,h;let d=NaN;const u=this._timeScale.coordinateToVisibleIndex(e),_=null!==(a=null===(n=null!==(r=this._lineBeingEdited)&&void 0!==r?r:this._lineBeingCreated)||void 0===n?void 0:n.priceScale())&&void 0!==a?a:i.defaultPriceScale();let p=null;!_.isEmpty()&&Number.isFinite(t)&&(p=(0,o.ensureNotNull)(i.mainDataSource()).firstValue(),null!==p&&(d=_.coordinateToPrice(t,p)));const m=this._crossHairSelectPointMode.value()!==we.SelectPointMode.None,g=this.currentTool(),S=this.mainSeries(),v=this.crossHairSource(),f=v.index,b=v.price,y=m||we.isStudyEditingNow.value(),C=_===this.m_mainSeries.priceScale()&&(this._lineBeingCreated||this._lineBeingEdited||(0,pe.isLineToolName)(g)||(0,we.toolIsMeasure)(g)||y);!this._isSettingsExternalPosition&&C?(d=this._magnet.align(d,u,i),null!==p&&this._setCorrectedPositionToCrosshair(u,d,i)):this._magnet.resetLastValue();let w=null;if(isNaN(d)||(w=i),this._isTimeScrolling){if(!this._isSettingsExternalPosition&&m){const e=S.bars().firstIndex(),t=S.bars().lastIndex();if(null!==e&&null!==t){const s=Math.min(Math.max(u,e),t);s!==u&&this._setCorrectedPositionToCrosshair(s,d,i)}}else v.setPosition(v.index,d,w);return}v.setOnHoveredChartWidget(!0),v.setPosition(u,d,w),(0,o.ensureNotNull)(v.dataWindowView()).update(),Zs(this._panes);const P=S.syncModel();if(this.crossHairSource().startMeasurePoint()||this._lineBeingCreated?this.lightUpdate():this.invalidate(X.InvalidationMask.cursor()),this._lineBeingCreated){const e=this._lineBeingCreated.linkKey().value();if(!this._isSettingsExternalPosition){const t=this._lineBeingCreated.setLastPoint({index:u,price:d},s);if(this._lineBeingCreated.updateAllViews((0,z.sourceChangeEvent)(this._lineBeingCreated.id())),t.price===d&&t.index===u||this._setCorrectedPositionToCrosshair(t.index,t.price,i),P&&e){const i=this._timeScale.points().roughTime(t.index,P.projectTime.bind(P));(0,we.setLineToolLastPoint)({model:this,linkKey:e,point:{timeStamp:(0,o.ensureNotNull)(i),price:t.price}})}}}if(!this._isSettingsExternalPosition&&null!==this._lineBeingEdited&&null!==this._linePointBeingEdited){const e={index:u,price:d};if(null===(l=this._linePointBeingChanged)||void 0===l?void 0:l.nonDiscreteIndex){const t=this.crossHairSource().originX();Number.isFinite(t)&&(e.index=this._timeScale.coordinateToFloatIndex(t))}this.changeLinePoint(e,s)
;const t=this._lineBeingEdited.alignCrossHairToAnchor(this._linePointBeingEdited)?this._lineBeingEdited.getPoint(this._linePointBeingEdited):e;null!==t&&this._setCorrectedPositionToCrosshair(t.index,t.price,i)}if(!this._isSettingsExternalPosition&&1===this._sourcesBeingMoved.length){const e=this._sourcesBeingMoved[0];if(null===(c=e.alignCrossHairToMovePoint)||void 0===c?void 0:c.call(e)){const t=null===(h=e.currentMovingPoint)||void 0===h?void 0:h.call(e);t&&t.logical&&this._setCorrectedPositionToCrosshair(t.logical.index,t.logical.price,i)}}if(!this._isSettingsExternalPosition&&y){const e=S.bars().firstIndex(),t=S.bars().lastIndex();if(null!==e&&null!==t){const s=Math.min(Math.max(u,e),t);s!==u&&this._setCorrectedPositionToCrosshair(s,d,i)}}(f!==u||b!==d)&&this._syncCrosshair(s)}setExternalPosition(e,t){let i;const s=this.crossHairSource();if(s.setOnHoveredChartWidget(!1),null!==e&&(0,se.isNumber)(e.timeStamp)){const t=this.mainSeries().syncModel();if(t){const s=this.createSyncPoint(e.syncSourceTarget,t.syncSourceTarget()).sourceTimeToTargetTime(e.timeStamp);i=this._timeScale.points().roughIndex(s,t.distance.bind(t))}}if(null!==e&&null!=i&&Number.isFinite(i)){this._isSettingsExternalPosition=!0;const r=(0,o.ensureNotNull)(this.paneForSource(this.mainSeries())),n=this._timeScale.indexToCoordinate(i),a=(0,o.ensureNotNull)(r.mainDataSource()).firstValue();if(null!==a){let i=NaN;void 0!==e.price&&Number.isFinite(e.price)&&(i=this.mainSeries().priceScale().priceToCoordinate(e.price,a)),s.clearOriginCoords(),this.setCurrentPosition(n,i,r,t)}return s.setOnHoveredChartWidget(!1),void(this._isSettingsExternalPosition=!1)}s.clearPosition(),(0,o.ensureNotNull)(s.dataWindowView()).update(),Zs(this._panes),this.invalidate(X.InvalidationMask.cursor())}startScaleTime(e){this._timeScale.startScale(e)}scaleTimeTo(e){this._timeScale.scaleTo(e),this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.lightUpdate()}endScaleTime(){this._timeScale.endScale(),this.lightUpdate(),this.recalcVisibleRangeStudies()}resetTimeScale(){this._timeScale.restoreDefault(),this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.recalcVisibleRangeStudies(),this.lightUpdate(),this._resetScales.fire()}startScalePrice(e,t,i){e.startScalePrice(t,i)}scalePriceTo(e,t,i){e.scalePriceTo(t,i),this.mainSeries().priceScale().isLockScale()?this.lightUpdate():this.invalidate(this._paneInvalidationMask(e,X.InvalidationLevel.Light))}endScalePrice(e,t){e.endScalePrice(t),this.invalidate(this._paneInvalidationMask(e,X.InvalidationLevel.Light))}startTwoPointsScalePrice(e,t,i,s){t.startTwoPointsScale(i,s)}twoPointsScalePriceTo(e,t,i,s){t.twoPointsScale(i,s),this.invalidate(this._paneInvalidationMask(e))}endTwoPointsScalePrice(e,t){t.endTwoPointsScale(),this.invalidate(this._paneInvalidationMask(e))}resetPriceScale(e,t){e.resetPriceScale(t),this.invalidate(this._paneInvalidationMask(e,X.InvalidationLevel.Light))}restorePriceScaleState(e,t,i){e.restorePriceScaleState(t,i),this.invalidate(this._paneInvalidationMask(e,X.InvalidationLevel.Light))}currentTool(){
return this._currentTool}setCurrentTool(e){this._currentTool!==e&&((0,pe.isLineToolName)(e)&&this.selectionMacro((e=>{e.clearSelection()})),this._currentTool=e,this._phantomSourceContainer.onToolChanged())}detachSource(e){const t=this.paneForSource(e);return!!t&&(t.removeDataSource(e),t.isEmpty()?(this._lineBeingCreated&&t===this._paneBeingCreatedLineOn&&this.cancelCreatingLine(),this.removePane(t),!0):(this.fullUpdate(),!1))}children(e,t){return this.dataSources().filter((i=>(0,q.isStudy)(i)&&!(0,ae.isLollipopDataSource)(i)?!t&&i.parentSources().includes(e):i.ownerSource()===e))}onRearrangePanes(){return this._onRearrangePanes}finishLineTool(e){const t=e.linkKey().value();(0,we.drawOnAllCharts)().value()&&null!==t&&e.isSynchronizable()&&(0,we.finishLineTool)({linkKey:t,model:this})}startChangingLinetool(e,t,i,s,r){this._lineBeingEdited=e,this._linePointBeingChanged=t||null,this._linePointBeingEdited=void 0===i?null:i,this._lineBeingEdited.startChanging(i,t,r),we.isToolEditingNow.setValue(!0);const n=(0,o.ensureNotNull)(this.paneForSource(e));this._lineBeingEdited.startDragPoint&&void 0!==i&&void 0!==t&&this._lineBeingEdited.startDragPoint(i,t),r||void 0===i||void 0===t||this._lineBeingEdited.setPoint(i,t,s,r),this._lineBeingEdited.updateAllViews((0,z.sourceChangeEvent)(this._lineBeingEdited.id()));const a=this._paneInvalidationMask(n,X.InvalidationLevel.Light);this.invalidate(a);const l=e.linkKey().value();if(l&&e.isSynchronizable()&&void 0!==i&&void 0!==t){const e=(0,o.ensureNotNull)(this.externalTimeStamp(t.index));(0,we.startChangingLineTool)({linkKey:l,model:this,symbol:this.mainSeries().symbol(),point:{price:t.price,timeStamp:e},pointIndex:i,envState:s||null})}}createLineTool(e,t,i,s,r,a,l,c){if((0,o.assert)((0,pe.isLineToolName)(i),`Cannot create unknown line tool: ${i}`),s){const e={...Fs.intervalsVisibilitiesDefaults},t=s.childs().intervalsVisibilities.state();(0,se.merge)(e,null!=t?t:{});const r=s.state();r.intervalsVisibilities=e,s=(0,b.createLineToolProperties)(i,r,this)}const h=(0,b.createLineTool)(i,this,s,null,void 0,c);if("LineToolExecution"!==i){let e;switch(i){case"LineToolIcon":e=h.properties().childs().icon.value().toString(16).toUpperCase();break;case"LineToolEmoji":e=h.properties().childs().emoji.value();break;case"LineToolSticker":e=h.properties().childs().sticker.value()}(0,u.trackEvent)("drawings","Study_Drawing_"+i,e)}(0,b.isStudyLineTool)(h)&&(0,u.trackEvent)("studies",`Study_${h.metaInfo().id}`);const d=!h.linkKey().value()&&!r;l=(0,o.ensureDefined)(l||(0,o.ensureNotNull)(e.mainDataSource())),s||(0,b.prepareLineToolPropertiesByOwnerSource)(h.properties(),l),h.setOwnerSource(l);const _=l.priceScale();if(h.setPriceScale(_),Ks&&l===this.mainSeries()&&h.share(a),e.addDataSource(h,_,!1),null!==h.preferredZOrder()&&e.insertAfter([h],this.mainSeries()),(0,we.drawOnAllCharts)().value()){const e=h.isSynchronizable()?r||(0,J.randomHash)():null;h.linkKey().setValue(e)}else h.linkKey().setValue(r);let p;if(h.isFixed()){const i=(0,o.ensureNotNull)((0,
o.ensureNotNull)(e.mainDataSource()).firstValue()),s=this._timeScale.indexToCoordinate(t.index),r=(0,o.ensureNotNull)(_).priceToCoordinate(t.price,i);p=h.addFixedPoint(new n.Point(s,r))}else p=h.addPoint(t);return p||(this._lineBeingCreated=h,this._paneBeingCreatedLineOn=e,we.isToolCreatingNow.setValue(!0)),d&&h.enableCurrentIntervalVisibility(),this.fullUpdate(),h}endChangingLinetool(e,t){const i=(0,o.ensureNotNull)(this._lineBeingEdited),s=i.endChanging(!1,e,t);this._lineBeingEdited=null,we.isToolEditingNow.setValue(!1),this._linePointBeingEdited=null,this._linePointBeingChanged=null,this.lightUpdate();const r={points:i.normalizedPoints(),interval:this.mainSeries().interval()},n=i.linkKey().value();null!==n&&i.isSynchronizable()&&!t&&(0,we.finishChangingLineTool)({model:this,linkKey:n,symbol:this.mainSeries().symbol(),finalState:r,changes:s})}continueCreatingLine(e,t,i,s){const r=(0,o.ensureNotNull)(this._lineBeingCreated),n=r.addPoint(e,t,i);r.updateAllViews((0,z.sourceChangeEvent)(r.id()));const a=new X.InvalidationMask(X.InvalidationLevel.Light);return n&&(this._paneBeingCreatedLineOn=null,this._lineBeingCreated=null,we.isToolCreatingNow.setValue(!1)),this.invalidate(a),n}cancelCreatingLine(){if(!this._lineBeingCreated)return;const e=this._lineBeingCreated;this.removeSource(this._lineBeingCreated),this._lineBeingCreated=null,this._lineCancelled.fire(),we.isToolCreatingNow.setValue(!1),(0,we.drawOnAllCharts)().value()&&e.isSynchronizable()&&(0,we.cancelLineTool)({model:this})}lineBeingCreated(){return this._lineBeingCreated}paneBeingCreatedLineOn(){return this._paneBeingCreatedLineOn}lineCancelled(){return this._lineCancelled}isPhantomLine(e){return this._phantomSourceContainer.source()===e}changeLinePoint(e,t,i){const s=(0,o.ensureNotNull)(this._lineBeingEdited),r=(0,o.ensureNotNull)(this._linePointBeingEdited);let n=e.price,a=e.index;if(s.setPoint(r,e,t,i),!i){const t=s.alignCrossHairToAnchor(r)?s.getPoint(r):e;null!==t&&(a=t.index,n=t.price)}s.updateAllViews((0,z.sourceChangeEvent)(s.id())),this.lightUpdate();const l=s.linkKey().value();if(!i&&null!==l&&s.isSynchronizable()){const e=(0,o.ensureNotNull)(this._linePointBeingChanged),i={indexesChanged:a!==e.index,pricesChanged:n!==e.price},c=s.getChangePointForSync(r);if(null!==c){const e=this.externalTimeStamp(a);null!==e&&(n=c.price,(0,we.changeLineTool)({linkKey:l,model:this,symbol:this.mainSeries().symbol(),point:{price:n,timeStamp:e},envState:t,changes:i}))}}}changeLinePoints(e,t,i){const s=e.points(),r=e.linkKey().value();!i&&r&&e.isSynchronizable()&&t.forEach(((t,i)=>{const n=s[i],a=n.price!==t.price,l=n.index!==t.index;if(e.getChangePointForSync(i)){const e=(0,o.ensureNotNull)(this.externalTimeStamp(t.index));(0,we.changeLineTool)({linkKey:r,model:this,symbol:this.mainSeries().symbol(),point:{price:t.price,timeStamp:e},changes:{pricesChanged:a,indexesChanged:l}})}})),e.setPoints(t),e.updateAllViews((0,z.sourceChangeEvent)(e.id())),this.lightUpdate()}startScrollTime(e){this._timeScale.startScroll(e),this._isTimeScrolling=!0,
this.mainSeries().clearGotoDateResult()}scrollTimeTo(e){this._timeScale.scrollTo(e),this.recalculateAllPanes((0,z.viewportChangeEvent)()),this.lightUpdate()}endScrollTime(){this._timeScale.endScroll(),this.lightUpdate(),this.recalcVisibleRangeStudies(),this._isTimeScrolling=!1}startScrollPrice(e,t,i){e.startScrollPrice(t,i)}scrollPriceTo(e,t,i){e.scrollPriceTo(t,i),this.invalidate(this._paneInvalidationMask(e,X.InvalidationLevel.Light))}endScrollPrice(e,t){e.endScrollPrice(t),this.invalidate(this._paneInvalidationMask(e,X.InvalidationLevel.Light))}addCustomSource(e,t,i=g.CustomSourceLayer.Foreground){this._customSourcesMap.has(e)&&Xs.logWarn(`Attempt to add the same custom source multiple time "${e}"`),Xs.logNormal(`Adding custom source "${e}"`);const s=t(e,this);switch(i){case g.CustomSourceLayer.Background:this._bgCustomSources.push(s);break;case g.CustomSourceLayer.Foreground:this._fgCustomSources.push(s);break;case g.CustomSourceLayer.Topmost:this._topmostCustomSources.push(s);break;default:throw new Error(`Unknown custom sources layer ${i}`)}this._allCustomSources.push(s),this._customSourcesMap.set(e,s),this.lightUpdate()}removeCustomSource(e){this._removeCustomSource(e),this.lightUpdate()}hasCustomSource(e){return this._customSourcesMap.has(e)}customSourceForName(e){return this._customSourcesMap.get(e)||null}customSourceName(e){let t=null;return this._customSourcesMap.forEach(((i,s)=>{i===e&&(t=s)})),t}customSources(e){switch(e){case g.CustomSourceLayer.Background:return this._bgCustomSources;case g.CustomSourceLayer.Foreground:return this._fgCustomSources;case g.CustomSourceLayer.Topmost:return this._topmostCustomSources;default:return this._allCustomSources}}addMultiPaneSource(e){this._multiPaneSources.push(e),this.lightUpdate()}removeMultiPaneSource(e){const t=this._multiPaneSources.indexOf(e);-1===t?Xs.logWarn("Attempt to remove multi-pane source which does not exist in the model"):this._multiPaneSources.splice(t,1),this.lightUpdate()}multiPaneSources(e){return this._multiPaneSources.filter((t=>!e.hasDataSource(t)))}magnet(){return this._magnet}dateTimeFormatter(){return this._dateTimeFormatter}dateFormatter(){return this._dateFormatter}timeFormatter(){return this._timeFormatter}isUnmergeAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;return(0,o.ensureNotNull)(this.paneForSource(e)).dataSources().filter(this._unmergeAvailable,this).length>1}isMergeDownAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;const t=this.paneForSource(e),i=this.panes();return t!==i[i.length-1]}isMergeUpAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;return this.paneForSource(e)!==this.panes()[0]}sessions(){return(0,o.ensureNotNull)(this._sessions)}createSessions(e){(0,o.assert)(null===this._sessions,"Sessions are already created"),this.addCustomSource("sessions",((t,i)=>(this._sessions=new G(t,i,e),this._sessions.start(),this._sessions)),g.CustomSourceLayer.Background)}createPrePostMarket(e){this.addCustomSource("prePostMarket",((t,i)=>new jt.PrePostMarket(t,i,e)))}watermarkContentProvider(){
return null}replayStatus(){return this._replayStatus}setReplayStatus(e){this._replayStatus.setValue(e)}isInReplay(){return this.m_mainSeries.isInReplay()}theme(){const e=this.properties().childs().paneProperties.state(["horzGridProperties.style","vertGridProperties.style"]);delete e.topMargin,delete e.bottomMargin;const t=this.mainSeries().state().state;t&&(delete t.symbol,delete t.interval,delete t.currencyId,delete t.unitId);const i={mainSourceProperties:t,sessions:this.sessions().properties().state(),chartProperties:{paneProperties:e,scalesProperties:this.properties().childs().scalesProperties.state()},version:this.version()};return i.version=this.version(),i}onChartThemeLoaded(){return this._chartThemeLoaded}chartThemeLoaded(){this._chartThemeLoaded.fire()}state(e,t,i,s){var r;const o=this.publishedChartsTimelineSource(),n=this.properties().childs(),a=n.tradingProperties.state(),l={panes:this._panes.map((r=>r.state(!0,e,!1,t,i,s))),timeScale:this._timeScale.state(e),chartProperties:{paneProperties:n.paneProperties.state(["horzGridProperties.style","vertGridProperties.style"]),scalesProperties:n.scalesProperties.state(),publishedChartsTimelineProperties:o?o.state(e):void 0,chartEventsSourceProperties:null===(r=n.chartEventsSourceProperties)||void 0===r?void 0:r.state(),tradingProperties:a,priceScaleSelectionStrategyName:n.priceScaleSelectionStrategyName.value()},sessions:this.sessions().state(e),version:this.version(),timezone:this.timezone(),shouldBeSavedEvenIfHidden:this._shouldBeSavedEvenIfHidden,linkingGroup:this._linkingGroupIndex.value()};return s||(l.lineToolsGroups=this.lineToolsGroupModel().state(t)),l}restoreState(e,t,s){var r;Ne.instance(this).reset();const o={};if(!e.panes)return void Xs.logDebug("ChartModel.restoreState: invalid state");if(!Array.isArray(e.panes))return void Xs.logDebug("ChartModel.restoreState: invalid state");if(e.panes.length<1)return void Xs.logDebug("ChartModel.restoreState: invalid state");for(const e of this._barsMarksSources)this.detachSource(e);if(this._shouldBeSavedEvenIfHidden=void 0===e.shouldBeSavedEvenIfHidden||e.shouldBeSavedEvenIfHidden,e.chartProperties&&!e.chartProperties.timezone&&(e.chartProperties.timezone=e.timezone),e.chartProperties){const i=(0,N.factoryDefaults)("chartproperties").scalesProperties;(0,se.merge)(i,e.chartProperties.scalesProperties),!("showLastValue"in i)||"showSeriesLastValue"in i||"showStudyLastValue"in i||(i.showSeriesLastValueProperty=i.showLastValue,i.showStudyLastValueProperty=i.showLastValue),"showSeriesLastValue"in i&&(o.showSeriesLastValueProperty=!0),"showStudyLastValue"in i&&(o.showStudyLastValueProperty=!0),(!this.isSnapshot()&&!this.readOnly()&&"showCurrency"in i||"showUnit"in i)&&((0,$.migrateShowCurrencyAndShowUnitProperties)(i.showCurrency,i.showUnit),delete i.showCurrency,delete i.showUnit);{const{paneProperties:t}=e.chartProperties;t.vertGridProperties=t.vertGridProperties||(0,se.clone)(t.gridProperties),t.horzGridProperties=t.horzGridProperties||(0,se.clone)(t.gridProperties),
t.horzGridProperties.style=t.vertGridProperties.style=ii.LINESTYLE_SOLID,"backgroundType"in t||(t.backgroundType=oi.ColorType.Solid),"separatorColor"in t||(t.separatorColor=(0,d.getThemedColor)("color-chart-page-bg")),this._properties.childs().paneProperties.mergeAndFire(t)}this._properties.childs().scalesProperties.mergeAndFire(i),e.chartProperties.timezone&&this._properties.childs().timezone.setValue(e.chartProperties.timezone),e.chartProperties.chartEventsSourceProperties&&this._properties.hasChild("chartEventsSourceProperties")&&this._properties.childs().chartEventsSourceProperties.mergeAndFire(e.chartProperties.chartEventsSourceProperties),e.chartProperties.tradingProperties&&this._properties.hasChild("tradingProperties")&&(void 0===e.chartProperties.tradingProperties.horizontalAlignment&&(e.chartProperties.tradingProperties.horizontalAlignment=(n=e.chartProperties.tradingProperties.lineLength)<=40?g.TradedGroupHorizontalAlignment.Right:n>=60?g.TradedGroupHorizontalAlignment.Left:g.TradedGroupHorizontalAlignment.Center),this._properties.childs().tradingProperties.mergeAndFire(e.chartProperties.tradingProperties)),this._timeScale.restoreState(e.timeScale,t),this._updateDateTimeFormatter()}var n;if(e.timeScale&&this._timeScale.restoreState(e.timeScale,t),!this.readOnly()){const t=this._getExceedingChildStudies(e.panes);if(t.length){for(let i=e.panes.length-1;i>=0;--i){const s=e.panes[i];for(let e=s.sources.length-1;e>=0;--e){const i=s.sources[e];~t.indexOf(i)&&s.sources.splice(e,1)}s.sources.length||e.panes.splice(i,1)}{const e=window.user.pro_plan;setTimeout((()=>(0,Yt.createGoProDialog)({feature:"studyOnStudy",actions:e&&[Qt.ExpertPlans.PremiumExpert,Qt.ExpertPlans.PremiumExpert+Jt.TRIAL_SUFFIX].includes(e)?[{text:c.t(null,void 0,i(875139)),action:ei.PredefinedAction.Close}]:void 0})),500)}}}const a=e.version||0,l=e.panes;let h="_seriesId";for(const e of l){const t=e.sources.find((e=>"MainSeries"===e.type));if(t){h=t.id;break}}this.panes()[0].restoreState(l[0],t,a,h,o,s,!0);let u=1;for(let i=1;i<e.panes.length;i++){const r=e.panes[i];if(0===r.sources.length){Xs.logWarn("Empty pane detected - restoring is skipped. idx="+i+", state="+JSON.stringify(r));continue}const n=this.panes()[u]||this.createPane();n.restoreState(r,t,a,h,o,s,!0),n.mainDataSource()?u+=1:this.removePane(n)}if(this.panes().forEach(((e,t)=>{e.collapsed().value()!==l[t].isCollapsed&&(e.collapsed().setValue(l[t].isCollapsed),this.fullUpdate())})),e.chartProperties&&e.chartProperties.publishedChartsTimelineProperties){const i=this.publishedChartsTimelineSource();i&&i.restoreData(e.chartProperties.publishedChartsTimelineProperties,t)}this._invalidateBarColorerCaches();const _=this.dataSources();let p=0;for(let e=0;e<_.length;e++){const t=_[e];(0,b.isLineTool)(t)&&(p++,t.calcIsActualSymbol())}this.updateTimeScaleBaseIndex(),this.recalculateAllPanes((0,z.globalChangeEvent)()),this.fullUpdate(),this.syncLollipopSources();const S=this.mainPane();for(const e of this._barsMarksSources)this.detachSource(e),
S.addDataSource(e,this.m_mainSeries.priceScale(),!0);let v=m.TVLocalStorage.getItem("linetools_limit")||1e3;return window.is_authenticated&&window.user&&window.user.settings&&(v=window.user.settings.linetools_limit||v),e.sessions&&this.sessions().restoreState(e.sessions,t),e.lineToolsGroups&&(this._lineToolsGroupModel=Mt.fromState(this,e.lineToolsGroups)),p>v&&p%100==0?{lines_limit_exceeded:!0,line_tools_count:p}:(this.panes().forEach((e=>this._dataSourceCollectionChanged.fire(e))),this._lineToolsGroupModel.fireChangedAll(),this._linkingGroupIndex.setValue(null!==(r=e.linkingGroup)&&void 0!==r?r:null),{})}shouldBeSavedEvenIfHidden(){return this._shouldBeSavedEvenIfHidden}setShouldBeSavedEvenIfHidden(e){this._shouldBeSavedEvenIfHidden=e}externalTimeStamp(e){const t=this.mainSeries().syncModel();return this.timeScale().points().roughTime(e,t&&t.projectTime.bind(t))}syncLollipopSources(){null!==this._lollipopSourcesWatcher&&this._lollipopSourcesWatcher.syncSources()}restoreChartEvents(e){null!==this._lollipopSourcesWatcher&&this._options.chartEventsEnabled&&this._lollipopSourcesWatcher.restoreChartEvents(e)}recalcVisibleRangeStudies(e){this._recalcVRStudiesParams.force=this._recalcVRStudiesParams.force||Boolean(e),this._recalcVisibleRangeStudiesImplDebounced()}recalcColorStudies(e){this._recalcColorStudiesParams.force=this._recalcColorStudiesParams.force||Boolean(e),this._recalcColorStudiesImplDebounced()}recalcStudyBasedLineTools(){this.dataSources().forEach((e=>{(0,b.isStudyLineTool)(e)&&e.recalcStudyIfNeeded()}))}alertsWatcher(){return this._alertsWatcher}showLegend(){return this._showLegendProperty}id(){return this._id}selectPointMode(){return this._crossHairSelectPointMode}cancelRequestSelectPoint(){this.m_crossHairSource.cancelRequestSelectPoint()}requestSelectPoint(e){return this.m_crossHairSource.requestSelectPoint(e)}onPointSelected(){return this.m_crossHairSource.onPointSelected()}recalculatePriceRangeOnce(){const e=this.mainSeries();for(const t of this._panes)for(const i of t.priceDataSources())i.symbolSource()===e&&i.disablePriceRangeReady()}invalidate(e){var t;null===(t=this._invalidateHandler)||void 0===t||t.call(this,e)}appliedTimeFrame(){return this._appliedTimeFrame.appliedTimeFrame()}barsMarksSources(){return this._barsMarksSources}createSyncPoint(e,t){return(0,Vs.getDefault2Lazy)(this._syncPointCache,e.uniqueId,t.uniqueId,(()=>new Dt(e,t)))}isAutoSaveEnabled(){return this._isAutoSaveEnabled}linkingGroupIndex(){return this._linkingGroupIndex}studyAwareDefaultRightOffset(){return this._timeScale.usePercentageRightOffset().value()?this._timeScale.percentsToBarIndexLength(this.studyAwareDefaultRightOffsetPercentage()):Math.max(this._timeScale.defaultRightOffset().value(),this._cachedStudiesMaxOffset)}studyAwareDefaultRightOffsetPercentage(){
return this._timeScale.usePercentageRightOffset().value()?Math.max(this._timeScale.defaultRightOffsetPercentage().value(),this._timeScale.barIndexLengthToPercents(this._cachedStudiesMaxOffset)):this._timeScale.barIndexLengthToPercents(this.studyAwareDefaultRightOffset())}clearAllStudies(){this.dataSources().forEach((e=>{var t;return null===(t=e.clearData)||void 0===t?void 0:t.call(e)}))}setTimeScaleAnimation(e){const t=X.InvalidationMask.light();t.setTimeScaleAnimation(e),this.invalidate(t)}stopTimeScaleAnimation(){const e=X.InvalidationMask.light();e.stopTimeScaleAnimation(),this.invalidate(e)}lollipopSourcesOptions(){const e=this._options;return{chartEventsEnabled:!this._options.isSnapshot&&this._options.chartEventsEnabled,esdEnabled:e.esdEnabled,continuousContractSwitchesEnabled:e.continuousContractSwitchesEnabled,futuresContractExpirationEnabled:e.futuresContractExpirationEnabled,latestUpdatesEnabled:e.latestUpdatesEnabled}}_initAlertsList(){return this._alertsListPromise||(this._alertsListPromise=(0,Ut.getChartAlertsFacade)().then((e=>{this._alertsList=e.createCollection((()=>this.mainSeries().interval()),(()=>this.mainSeries().actualSymbol())),this._alertsList.alertAdded().subscribe(this,this._addAlertLabelToChart.bind(this)),this._alertsList.alertRemoved().subscribe(this,this._removeAlertLabelFromChart.bind(this)),this._alertsList.collectionReset().subscribe(this,(()=>{if(this._alertsList){const e=this._alertsList.alerts();this._removeAllAlertLabelsFromChart();for(let t=e.length-1;t>=0;t--)this._addAlertLabelToChart(e[t])}})),this._alertsList.alertChanged().subscribe(this,(e=>{this._removeAlertLabelFromChart(e),this._addAlertLabelToChart(e)})),this._alertsList.sync();const t=e=>{this.mainSeries().dataEvents().symbolResolved()[e](this,i),this.mainSeries().dataEvents().symbolError()[e](this,this._removeAllAlertLabelsFromChart),this.mainSeries().properties().childs().interval[e](this,i)},i=()=>{e.ensureFullAlertsList({success:()=>{var e;return null===(e=this._alertsList)||void 0===e?void 0:e.sync()},error:()=>{var e;return null===(e=this._alertsList)||void 0===e?void 0:e.reset()}})};return window.loginStateChange.subscribe(this,(()=>{t(window.is_authenticated?"subscribe":"unsubscribe")})),window.is_authenticated&&(t("subscribe"),i()),this._alertsList}))),this._alertsListPromise}_updateStudiesMaxOffset(){const e=Math.max(...this.allStudies().map((e=>e.maxOffset().value())));this._cachedStudiesMaxOffset=e;const t=this._timeScale.rightOffset();if(t<0)return;if(e<=t)return;const i=this._timeScale.logicalRange();i?this._timeScale.zoomToBarsRange(i.left(),this._timeScale.baseIndex()+Math.max(this._timeScale.rightOffset(),e)):this._timeScale.setRightOffset(Math.max(t,e))}_updateBaseIndex(e,t){const i=this._timeScale,s=i.baseIndex(),r=i.logicalRange();if(null!==r&&t){const t=r.contains(s),o=e-s,n=t?null:i.rightOffset()-o;if(!this._options.shiftVisibleRangeOnNewBar&&t){const e=i.width()/i.barSpacing(),t=e/(e+o),s=Math.max(i.minBarSpacing(),i.barSpacing()*t);i.setBarSpacing(s)}null!==n&&i.setRightOffset(n)}
i.setBaseIndex(e)}_createLollipopSourcesWatcher(){this._lollipopSourcesWatcher=new Ht(this)}_updateDateTimeFormatter(){const e=Pt.dateFormatProperty.value(),t=this.onWidget()?void 0:$t.withWeekdayProperty.value();if(this._dateFormatter=new wt.DateFormatter(e,t),this.mainSeries().isDWM())this._dateTimeFormatter=new wt.DateFormatter(e,t),this._timeFormatter=new dt.TimeFormatter((0,ut.getHourMinuteFormat)(ht.timeHoursFormatProperty.value()));else{const i=M.Interval.parse(this.mainSeries().interval()),s=(0,ut.getTimeFormatForInterval)(i,ht.timeHoursFormatProperty.value());this._dateTimeFormatter=new Ct.DateTimeFormatter({dateFormat:e,withWeekday:t,timeFormat:s,dateTimeSeparator:"   "}),this._timeFormatter=new dt.TimeFormatter(s)}}_invalidationMaskForSource(e,t=X.InvalidationLevel.Light){if(e===this.crossHairSource())return X.InvalidationMask.cursor();if(this._watermarkSource===e)return this._paneInvalidationMask((0,o.ensureNotNull)(this.paneForSource(this.mainSeries())),t);if(-1!==this._allCustomSources.indexOf(e)){const e=new X.InvalidationMask;return e.invalidateAll(t),e}if(!(0,S.isDataSource)(e))return null;if(e.isMultiPaneEnabled())return new X.InvalidationMask(t);const i=this.paneForSource(e);return null!==i?this._paneInvalidationMask(i,t):null}_paneInvalidationMask(e,t=X.InvalidationLevel.Light){const i=new X.InvalidationMask,s=this._panes.indexOf(e);return i.invalidateAllPane(s,t),i}_invalidationMaskForSourcePriceScale(e,t=X.InvalidationLevel.Light){if(!(0,S.isDataSource)(e))return new X.InvalidationMask(t);const i=this.paneForSource(e);if(null===i)return null;let s=e.priceScale();if(null===s)return null;const r=this._panes.indexOf(i);let o=i.priceScalePosition(s);if("overlay"===o){const e=this._panes[r].defaultPriceScale();s=e,o=i.priceScalePosition(e)}const n=i.priceScaleIndex(s,o);if(void 0===n)return null;const a=new X.InvalidationMask;return a.invalidatePriceScale(r,o,n,t),a}_removeCustomSource(e){const t=this._customSourcesMap.get(e);if(void 0===t)return void Xs.logWarn(`Attempt to remove custom source which does not exist in the model - "${e}"`);Xs.logNormal(`Removing custom source "${e}"`),this.selectionMacro((e=>{e.removeSourceFromSelection(t)})),this._hoveredSource===t&&this.setHoveredSource(null),this._customSourceBeingMoved===t&&this.setMovingCustomSource(null,null);const i=$s(this._bgCustomSources,t),s=$s(this._fgCustomSources,t),r=$s(this._topmostCustomSources,t),n=$s(this._allCustomSources,t);(0,o.assert)(i||s||r,"Source should be presented in one of the layers"),(0,o.assert)(n,"Source should be presented in the array"),this._customSourcesMap.delete(e),t.destroy()}_updateShowLegendProperty(){const e=this._properties.childs().paneProperties.childs().legendProperties.childs().showLegend,t=this._showLegendProperty;if(e.value())t.setValue(!0);else{for(const e of this._panes){let i=0;for(const s of e.priceDataSources())if(null!==s.statusView()&&(i++,i>=2))return void t.setValue(!1)}t.setValue(!0)}}_pointToPercentPosition(e,t){return{x:e.x/this._timeScale.width(),y:e.y/(0,o.ensureNotNull)((0,
o.ensureNotNull)(t.mainDataSource()).priceScale()).height()}}_percentPositionToPoint(e,t){const i=e.x*this._timeScale.width(),s=e.y*(0,o.ensureNotNull)((0,o.ensureNotNull)(t.mainDataSource()).priceScale()).height();return new n.Point(i,s)}_recalcVisibleRangeStudiesImpl(e){var t,i,s;if(e.timerId=null,this.timeScale().isEmpty())return;const r=this.timeScale().visibleBarsStrictRange();if(null===r)return;const o=this.mainSeries().bars(),n=o.search(r.firstBar(),_t.PlotRowSearchMode.NearestRight),a=o.search(r.lastBar(),_t.PlotRowSearchMode.NearestLeft),l=o.lastIndex(),c=n?n.index:void 0,h=a?a.index:void 0,d=c===e.oldStartVisibleIndex,u=h===e.oldEndVisibleIndex;if(d&&u&&!e.force)return;e.force=!1,e.oldStartVisibleIndex=void 0!==c?c:NaN,e.oldEndVisibleIndex=void 0!==h?h:NaN;const _={first_visible_bar_time:1e3*(null!==(t=null==n?void 0:n.value[0])&&void 0!==t?t:0),last_visible_bar_time:1e3*(null!==(i=null==a?void 0:a.value[0])&&void 0!==i?i:0),subscribeRealtime:(null==a?void 0:a.index)===l},p=null!==(s=e.studies)&&void 0!==s?s:this.priceDataSources();e.studies=void 0;for(const e of p)if((0,q.isStudy)(e)){const t=e.metaInfo().inputs,i=[];for(const e of t)_.hasOwnProperty(e.id)&&i.push(e.id);const s=e.properties().childs().inputs;for(const e of i)s.childs()[e].setValueSilently(_[e]);i.length>0&&s.listeners().fire(s)}}_recalcColorStudiesImpl(e){var t;e.timerId=null;const i=this.backgroundColorAtYPercentFromTop(.5),s=this.dark().value()?l.colorsPalette["color-cold-gray-200"]:l.colorsPalette["color-cold-gray-900"],r=i===e.oldBgColor,o=s===e.oldFgColor;if(r&&o&&!e.force)return;e.force=!1,e.oldBgColor=i,e.oldFgColor=s;const n={__chart_bgcolor:i,__chart_fgcolor:s},a=null!==(t=e.studies)&&void 0!==t?t:this.priceDataSources();e.studies=void 0;for(const e of a)if((0,q.isStudy)(e)){const t=e.metaInfo().inputs,i=[];for(const e of t)n.hasOwnProperty(e.id)&&i.push(e.id);const s=e.properties().childs().inputs;for(const e of i)s.childs()[e].setValueSilently(n[e]);i.length>0&&s.listeners().fire(s)}}_getAllSources(e){const t=[];for(const i of this._panes){const s=i.sourcesByGroup().all();for(const i of s)e(i)&&t.push(i)}return t}_invalidateBarColorerCaches(){this.mainSeries().invalidateBarColorerCache()}_addAlertLabelToChart(e){{const t=e.seriesState();if(null===t)return;const i=t.id;(0,o.ensureNotNull)(this.alertsWatcher()).addAlert(e,i)}}_removeAlertLabelFromChart(e){(0,o.ensureNotNull)(this.alertsWatcher()).removeAlert(e)}_removeAllAlertLabelsFromChart(){(0,o.ensureNotNull)(this.alertsWatcher()).removeAllAlertLabels()}_updateTimeScale(e){var t,i,s,r;const{index:o,zoffset:n,values:a,indexDiffs:l,baseIndex:c,marks:h,clearFlag:d}=e;if(d){this._timeScale.reset();for(const e of this.dataSources())null===(t=e.clearData)||void 0===t||t.call(e)}if(l.length>0)for(const e of this.dataSources())null===(i=e.moveData)||void 0===i||i.call(e,l);const u=this._timeScale.indexToTimePoint(this._timeScale.baseIndex()),_=this._timeScale.canNormalize();this._timeScale.update(o,n,a,h);const p=this._timeScale.points().range().value()
;let m="ChartModel.prototype._updateTimeScale("+o+","+n+","+a.length+","+l.length+","+h.length+","+d+")";if(m+="TimeScale: {first:"+(null!==(s=null==p?void 0:p.firstIndex)&&void 0!==s?s:null)+",last:"+(null!==(r=null==p?void 0:p.lastIndex)&&void 0!==r?r:null)+"}",null===c){this._timeScale.resetBaseIndex();const e=this._timeScale.rightOffset();this._timeScale.setRightOffset(Math.max(e,this._cachedStudiesMaxOffset))}else if(void 0!==c){const e=this._timeScale.indexToTimePoint(c),t=null!==u&&null!==e&&e>u;this._updateBaseIndex(c,t)}if(Xs.logDebug(m),!_&&_!==this._timeScale.canNormalize())for(const e of this.dataSources())!(0,b.isLineTool)(e)||e.isFixed()||e.isSourceHidden()||e.processHibernate();this.recalculateAllPanes((0,z.globalChangeEvent)()),this.lightUpdate()}_getAvailableCurrencies(){return!this.currencyConversionEnabled()||this.isSnapshot()?[]:(0,se.isArray)(this._availableCurrenciesList)?this._availableCurrenciesList:(null!==this._availableCurrenciesList||(this._availableCurrenciesList=this.chartApi().availableCurrencies(),this._availableCurrenciesList.then((e=>{this._destroyed||(this._availableCurrenciesList=e,this.fullUpdate())})).catch((e=>{Xs.logWarn(`An error occurred while getting currencies config: ${e}`)}))),[])}_getAvailableUnits(){return!this.unitConversionEnabled()||this.isSnapshot()?{}:this._availableUnitsObject instanceof Promise||null===this._availableUnitsObject?(null!==this._availableUnitsObject||(this._availableUnitsObject=this.chartApi().availableUnits(),this._availableUnitsObject.then((e=>{this._destroyed||(this._availableUnitsObject=e,this.fullUpdate())})).catch((e=>{Xs.logWarn(`An error occurred while getting units config: ${e}`)}))),{}):this._availableUnitsObject}_getAvailablePriceSources(){return Array.isArray(this._availablePriceSourcesList)?this._availablePriceSourcesList:(this._availablePriceSourcesList=this.chartApi().availablePriceSources(this.m_mainSeries.getSymbolString()),this._availablePriceSourcesList.then((e=>{this._destroyed||(this._availablePriceSourcesList=e,this.fullUpdate())})).catch((e=>{Xs.logWarn(`An error occurred while getting price sources config: ${e}`)})),[])}_clearAvailablePriceSources(){this._availablePriceSourcesList=null}_getBackgroundColor(e){const t=this._properties.childs().paneProperties.childs();if(t.backgroundType.value()===oi.ColorType.Gradient){const i=t.backgroundGradientStartColor.value(),s=t.backgroundGradientEndColor.value();return function(e,t,i){if((0,d.getCurrentTheme)().name===Rt.StdTheme.Dark&&(0,Bt.isOnMobileAppPage)("any")&&(0,d.isStdThemedDefaultValue)("chartProperties.paneProperties.backgroundGradientStartColor",e,Rt.StdTheme.Dark)&&(0,d.isStdThemedDefaultValue)("chartProperties.paneProperties.backgroundGradientEndColor",t,Rt.StdTheme.Dark))return Nt;return i?e:t}(i,s,Boolean(e))}const i=t.background.value();return function(e){if((0,d.getCurrentTheme)().name===Rt.StdTheme.Dark&&(0,Bt.isOnMobileAppPage)("any")&&(0,d.isStdThemedDefaultValue)("chartProperties.paneProperties.background",e,Rt.StdTheme.Dark))return Nt;return e}(i)}
_getBackgroundCounterColor(){const e=this.backgroundColor().value();return"black"===(0,a.rgbToBlackWhiteString)((0,a.parseRgb)(e),150)?"white":"black"}_updateBackgroundColor(){this._backgroundColor.setValue(this._getBackgroundColor()),this._backgroundTopColor.setValue(this._getBackgroundColor(!0))}_syncCrosshair(e){if(!this._isSettingsExternalPosition){const t=this._undoModel.chartWidget(),i=this._undoModel.mainSeries(),s=i.syncModel(),r=this._undoModel.crossHairSource(),o=r.pane;if(null!==s&&null!==o){const n={timeStamp:this._timeScale.points().roughTime(r.index,s.projectTime.bind(s)),syncSourceTarget:s.syncSourceTarget()};o.mainDataSource()===i&&(n.price=r.price,n.symbol=i.symbol());let a=this._lineBeingCreated||null!==this._linePointBeingEdited||Boolean(this._sourcesBeingMoved.length);a=a&&(0,we.drawOnAllCharts)().value(),t.chartWidgetCollection().syncCrosshair(n,t.id(),a,e)}this._phantomSourceContainer.onCursorPositionUpdated()}}_gotoTimeImpl(e,t){const i=this.timeScale(),s=this.mainSeries();let r;if(void 0!==e){if(this._scrollingState&&this._scrollingState.deferred.reject(),r=(0,_.createDeferredPromise)(),!s.isDWM()){const t=s.symbolInfo();if(null!==t){let i=this.properties().childs().timezone.value();"exchange"===i&&(i=t.timezone);const r=(0,It.cal_to_utc)((0,It.get_timezone)(i),new Date(e)),o=(0,mi.createTimeToBarTimeAligner)(s.interval(),t)(r);e=(0,It.utc_to_cal)((0,It.get_timezone)(i),o).getTime()}}this._scrollingState={targetDate:e,deferred:r,centerIfVisible:t.centerIfVisible}}else{if(!this._scrollingState)return Xs.logError("scrollTo called without an argument"),Promise.reject();e=this._scrollingState.targetDate,r=this._scrollingState.deferred}if(void 0===i.tickMarks().minIndex)return r.resolve(void 0),r.promise;this.stopTimeScaleAnimation();let n=((e,t)=>{if((e=>(0,o.ensureNotNull)(i.tickMarks().indexToTime((0,o.ensureDefined)(i.tickMarks().minIndex))).valueOf()-e)(t)<0){let r=i.tickMarks().nearestIndex(t);const n=s.bars().lastIndex();if(null===n)return null;r=Math.min(r,n);let a=(0,o.ensureNotNull)(i.tickMarks().indexToTime(r)).valueOf();for(;a<t&&r<n;)r++,a=(0,o.ensureNotNull)(i.tickMarks().indexToTime(r)).valueOf();const l=(0,o.ensureNotNull)(i.visibleBarsStrictRange()),c=l.lastBar()-l.firstBar();return!e&&l.contains(r)||i.zoomToBarsRange(r-c/2,r+c/2),{timestamp:(0,o.ensureNotNull)(i.indexToTimePoint(r))}}return null})(this._scrollingState.centerIfVisible,this._scrollingState.targetDate);if(!n){const t=(0,o.ensureDefined)(i.tickMarks().minIndex),r=(0,o.ensureNotNull)(i.visibleBarsStrictRange()),a=r.lastBar()-r.firstBar();if(s.requestMoreDataAvailable()){const t=i.tickMarks().estimateLeft(e);i.requestMoreHistoryPoints(Math.ceil(t+a/2))}else i.zoomToBarsRange(t-a/2,t+a/2),n={timestamp:(0,o.ensureNotNull)(i.indexToTimePoint(t)),eod:!0}}if(n){if(this._scrollingState.centerIfVisible){const e=(0,o.ensureNotNull)(i.visibleBarsStrictRange());for(const t of this.panes()){for(const i of t.leftPriceScales())i.recalculatePriceRange(e);for(const i of t.rightPriceScales())i.recalculatePriceRange(e)}}
this.fullUpdate(),this._scrollingState=null,r.resolve(n)}return r.promise}_setCorrectedPositionToCrosshair(e,t,i){this.crossHairSource().setPosition(e,t,i)}_onSymbolSourceCollectionChanged(e){this._recalcAdjustForDividendsAvailibility(),this._symbolSourceCollectionChanged.fire(e)}_onPriceSourcesCollectionChanged(e){this._studiesWV.setValue(this.allStudies()),this._studiesExcludeInternalWV.setValue(this.allStudies(!0))}_unmergeAvailable(e){return e===this.m_mainSeries||(0,q.isStudy)(e)&&!e.isLinkedToSeries()&&!(0,Hs.isNonSeriesStudy)(e)&&e.showInObjectTree()}_getExceedingChildStudies(e){var t,i;let s=[];for(let t=0;t<e.length;++t)s=s.concat(e[t].sources||[]);let r=0,o=1;o=null!==(i=null===(t=(0,Kt.getConfig)(Xt.ProductFeatures.STUDY_ON_STUDY))||void 0===t?void 0:t.child_limit)&&void 0!==i?i:1;const n=[],a={};let l=0,c=1e6;for(;s.length&&--c;){const e=s[l];(e.ownerSource&&a[e.ownerSource]||!e.ownerSource)&&(a[e.id]=e,s.splice(s.indexOf(e),1),e.ownerSource&&(0,Ae.isStudyState)(e)&&e.state&&e.state.isChildStudy&&++r>o&&n.push(e)),l=(l+1)%s.length}return n}}},208697:(e,t,i)=>{"use strict";i.d(t,{ChartUndoModelBase:()=>Bs});var s=i(685459),r=i.n(s),o=i(316230),n=i(650151),a=i(86441),l=i(444372),c=i(81979),h=i(397150),d=i(526075),u=i(315347),_=i(223699);function p(e,t){return!!_.Interval.isEqual(e.res,t.res)&&(0,u.areEqualTimeFrames)(e.val,t.val)}var m=i(13294),g=i(356893),S=i(713473),v=i(764005),f=i(345848),b=i(677305),y=i(244842),C=i(201089),w=i(161488),P=i(142257),T=i(809796);const M=new T.TranslatedString("toggle collapsed pane state",l.t(null,void 0,i(74724)));class x extends P.UndoCommand{constructor(e,t){super(M),this._chartModel=e,this._paneIndex=t}redo(){this._chartModel.toggleCollapsedPane(this._paneIndex)}undo(){this._chartModel.toggleCollapsedPane(this._paneIndex)}}var I=i(125226),L=i(833813),k=i(778016),A=i(960337),E=i(405117),D=i(638456),B=i(822122),R=i(255453),N=i(371927),V=i(703089),O=i(389137);const F=new T.TranslatedString("move all scales to left",l.t(null,void 0,i(581898))),W=new T.TranslatedString("move all scales to right",l.t(null,void 0,i(622863))),z=(0,C.getLogger)("Chart.MergeAllScales");class H extends P.UndoCommand{constructor(e,t,i,s,r,o){super(o),this._model=e,this._paneIndex=e.panes().indexOf(t),this._targetPosition=s,this._targetIndex=r,this._scaleId=i.id(),this._sourcePosition=t.priceScalePosition(i),"overlay"!==this._sourcePosition&&(this._sourceIndex=t.priceScaleIndex(i,this._sourcePosition))}redo(){const e=this._model.panes()[this._paneIndex],t=(0,n.ensureNotNull)(e.getPriceScaleById(this._scaleId));e.movePriceScale(t,this._targetPosition,this._targetIndex),this._model.fullUpdate()}undo(){const e=this._model.panes()[this._paneIndex],t=(0,n.ensureNotNull)(e.getPriceScaleById(this._scaleId));e.movePriceScale(t,this._sourcePosition,this._sourceIndex),this._model.fullUpdate()}}class U extends P.UndoCommand{constructor(e,t,i,s){super(s),this._createdIds=[],this._model=e,this._withoutShift=i,this._origStates=t.map((e=>e.state(!0)));const r=e.lineToolsGroupModel();this._origGroups=t.map((e=>{
const t=r.groupForLineTool(e);return t&&t.id}))}redo(){const e=this._model.lineToolsGroupModel(),t=this._origStates.map(((t,i)=>{const s=(0,n.ensureNotNull)(this._model.dataSourceForId(t.id)),r=0===this._createdIds.length?void 0:(0,n.ensureDefined)(this._createdIds[i]),o=(0,S.cloneLineTool)(this._model,s,!this._withoutShift,r);void 0!==t.sharingMode&&o.share(t.sharingMode);const a=(0,n.ensureNotNull)(s.priceScale());(0,n.ensureNotNull)(this._model.paneForSource(s)).addDataSource(o,a,!1);const l=this._origGroups[i];if(null!==l){const t=e.groupForId(l);t&&t.addLineTools([o])}return this._model.updateSource(o),o}));0===this._createdIds.length&&(this._createdIds=t.map((e=>e.id()))),this._model.selectionMacro((e=>{e.clearSelection(),t.forEach((t=>{e.addSourceToSelection(t)}))})),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){const e=this._model.lineToolsGroupModel();this._createdIds.forEach((t=>{const i=(0,n.ensureNotNull)(this._model.dataSourceForId(t)),s=e.groupForLineTool(i);null!==s&&s.excludeLineTool(i),this._model.removeSource(i)}))}newIds(){return this._createdIds}}var G=i(558105),q=i(731327);class j extends P.UndoCommand{constructor(e,t,i,s=!0){super(i,s),this._newStates=[],this._model=e,this._savedStates=t.map((e=>e.state(!1)))}redo(){this._applyState(this._newStates)}undo(){0===this._newStates.length&&this.saveNewState(),this._applyState(this._savedStates)}saveNewState(){const e=this._savedStates.filter(O.notNull).map((e=>(0,n.ensureNotNull)(this._model.dataSourceForId(e.id))));this._newStates=e.map((e=>e.state(!1)))}_applyState(e){for(const t of e)if(null!==t){const e=this._model.dataSourceForId(t.id);if(null!==e)if((0,w.isStudy)(e)){const i=t.state.inputs,s=e.properties().childs().inputs.childs();for(const e in i)s[e]&&s[e].setValue(i[e])}else this._model.restoreLineToolState(e,t,!0)}}}class Y extends P.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._sourceId=t.id();const s=(0,n.ensureNotNull)(t.priceScale());this._initialPriceScaleId=s.id(),this._initialPriceScaleState=(0,n.ensureNotNull)(t.priceScale()).state();const r=(0,n.ensureNotNull)(e.paneForSource(t));this._initialPriceScalePosition=r.priceScalePosition(s),this._initialPriceScaleIndex=r.priceScaleIndex(s,this._initialPriceScalePosition),this._initialPaneIndex=e.panes().indexOf(r)}_newPriceScaleState(e){const t={...this._initialPriceScaleState};return delete t.m_isLockScale,delete t.id,delete t.m_topMargin,delete t.m_bottomMargin,t}_originalPriceScaleState(){return this._initialPriceScaleState}}class K extends Y{constructor(e,t,i){super(e,t,i)}redo(){const e=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),t=(0,n.ensureNotNull)(this._chartModel.paneForSource(e)),i=this._chartModel.children(e,!0);t.bulkActionMacro((()=>{i.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(e)}));const s=this._chartModel.createPane(this.targetPaneIndex()),r=s.findSuitableScale(e);s.bulkActionMacro((()=>{s.addDataSource(e,r,!1),i.forEach((e=>s.addDataSource(e,r,!1)))}));const o=(0,
n.ensureNotNull)(e.priceScale());o.restoreState(this._newPriceScaleState(s.isOverlay(e))),o.setHeight(s.height()),this._chartModel.fullUpdate(),this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){const e=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),t=(0,n.ensureNotNull)(this._chartModel.paneForSource(e)),i=this._chartModel.children(e,!0);t.bulkActionMacro((()=>{i.forEach((e=>this._chartModel.detachSource(e)));const t=this._chartModel.detachSource(e);(0,n.assert)(t,"Undo of detaching must remove pane")}));const s=this._chartModel.panes()[this._initialPaneIndex];let r=s.getPriceScaleById(this._initialPriceScaleId);null===r&&(r=s.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),s.bulkActionMacro((()=>{s.addDataSource(e,r,!0),i.forEach((e=>s.addDataSource(e,r,!1)))}));const o=(0,n.ensureNotNull)(e.priceScale());o.restoreState(this._originalPriceScaleState()),o.setHeight(s.height()),this._chartModel.fullUpdate()}}class X extends K{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._initialPaneIndex+1}}class $ extends K{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._initialPaneIndex}}class Z extends K{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._chartModel.panes().length}}class Q extends Y{constructor(e,t,i,s){super(e,t,i),this._restorePane=!1,this._keepZOrder=null!=s&&s}redo(){const e=this._chartModel.panes().length,t=this._chartModel.panes()[this._targetPaneIndex()],i=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),s=(0,n.ensureNotNull)(this._chartModel.paneForSource(i)),r=this._chartModel.children(i,!0);s.bulkActionMacro((()=>{r.forEach((e=>this._chartModel.detachSource(e))),this._restorePane=this._chartModel.detachSource(i)}));const o="overlay"===this._initialPriceScalePosition?this._initialPriceScalePosition:void 0,a=t.findSuitableScale(i,void 0,o),l=0===a.dataSources().length;if(t.bulkActionMacro((()=>{t.addDataSource(i,a,this._keepZOrder),r.forEach((e=>t.addDataSource(e,a,this._keepZOrder)))})),i===this._chartModel.mainSeries()){const e=t.priceScalePosition(a);t.movePriceScale(a,e,0)}if(l){const e=(0,n.ensureNotNull)(i.priceScale());e.restoreState(this._newPriceScaleState(t.isOverlay(i))),e.setHeight(t.height())}this._chartModel.fullUpdate(),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){let e;e=this._restorePane?this._chartModel.createPane(this._initialPaneIndex):this._chartModel.panes()[this._initialPaneIndex];const t=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),i=(0,n.ensureNotNull)(this._chartModel.paneForSource(t)),s=this._chartModel.children(t,!0);i.bulkActionMacro((()=>{s.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(t)}));let r=e.getPriceScaleById(this._initialPriceScaleId);null===r&&(r=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),e.bulkActionMacro((()=>{e.addDataSource(t,r,!0),s.forEach((t=>e.addDataSource(t,r,!1)))}))
;const o=(0,n.ensureNotNull)(t.priceScale());o.restoreState(this._originalPriceScaleState()),o.setHeight(e.height()),this._chartModel.fullUpdate()}}class J extends Q{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){return this._initialPaneIndex-1}}class ee extends Q{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){return this._initialPaneIndex+1}}class te extends Q{constructor(e,t,i,s,r){super(e,t,s,r),this._targetPane=i}_targetPaneIndex(){return this._targetPane}}var ie=i(888929),se=i(996986),re=i(553582),oe=i(982217);const ne=new T.TranslatedString("bring {title} to front",l.t(null,void 0,i(178246))),ae=new T.TranslatedString("send {title} to back",l.t(null,void 0,i(166781))),le=new T.TranslatedString("insert {title} after {targetTitle}",l.t(null,void 0,i(53146))),ce=new T.TranslatedString("insert {title} before {targetTitle}",l.t(null,void 0,i(667176))),he=new T.TranslatedString("send {title} backward",l.t(null,void 0,i(216259))),de=new T.TranslatedString("bring {title} forward",l.t(null,void 0,i(356763))),ue=new T.TranslatedString("send group {title} backward",l.t(null,void 0,i(404998))),_e=new T.TranslatedString("bring group {title} forward",l.t(null,void 0,i(27195)));function pe(e){return new T.TranslatedString(e.name(),e.title(oe.TitleDisplayTarget.StatusLine))}class me extends P.UndoCommand{constructor(e,t,i){super(i),this._sourcesByPanes=new Map,this._originalState=new Map,this._model=e,t.forEach((t=>{const i=(0,n.ensureNotNull)(e.paneForSource(t)),s=e.panes().indexOf(i),r=this._sourcesByPanes.get(s)||[];r.push(t.id()),this._sourcesByPanes.set(s,r)})),Array.from(this._sourcesByPanes.keys()).forEach((t=>{const i=e.panes()[t],s=new Map;i.sourcesByGroup().allIncludingHidden().forEach((e=>{s.set(e.id(),e.zorder())})),this._originalState.set(t,s)}))}undo(){this._originalState.forEach(((e,t)=>{const i=this._model.panes()[t],s=new Map;e.forEach(((e,t)=>{const r=(0,n.ensureNotNull)(i.dataSourceForId(t));s.set(r,e)})),i.setZOrders(s)}))}redo(){this._sourcesByPanes.forEach(((e,t)=>{const i=this._model.panes()[t],s=e.map((e=>(0,n.ensureNotNull)(i.dataSourceForId(e))));this._paneOperation(i,s)}))}}class ge extends me{constructor(e,t){super(e,t,ne.format({title:pe(t[0])}))}_paneOperation(e,t){e.bringToFront(t)}}class Se extends me{constructor(e,t){super(e,t,ae.format({title:pe(t[0])}))}_paneOperation(e,t){e.sendToBack(t)}}class ve extends me{constructor(e,t,i,s){super(e,t,s),this._targetSource=i}_paneOperation(e,t){e.insertAfter(t,this._targetSource)}}class fe extends ve{constructor(e,t,i){super(e,t,i,le.format({title:pe(t[0]),targetTitle:pe(i)}))}}class be extends me{constructor(e,t,i,s){super(e,t,s),this._targetSource=i}_paneOperation(e,t){e.insertBefore(t,this._targetSource)}}class ye extends be{constructor(e,t,i){super(e,t,i,ce.format({title:pe(t[0]),targetTitle:pe(i)}))}}function Ce(e,t){const i=t[0],s=e.sourcesByGroup().all().filter((e=>e.zorder()<i.zorder()));if(0===s.length)throw new Error("Cannot move backward source that alreadt on back");let r=s[s.length-1];if((0,S.isLineTool)(r)){
const t=e.model().lineToolsGroupModel().groupForLineTool(r);null!==t&&(r=t.lineTools()[0])}return r}class we extends be{constructor(e,t,i){super(e,i,Ce(t,i),he.format({title:pe(i[0])}))}}function Pe(e,t){const i=t[t.length-1],s=e.sourcesByGroup().allExceptSpecialSources().filter((e=>e.zorder()>i.zorder()));if(0===s.length)throw new Error("Cannot bring forward source that alreadt on back");let r=s[0];if((0,S.isLineTool)(r)){const t=e.model().lineToolsGroupModel().groupForLineTool(r);if(null!==t){const e=t.lineTools();r=e[e.length-1]}}return r}class Te extends ve{constructor(e,t,i){super(e,i,Pe(t,i),de.format({title:pe(i[0])}))}}function Me(e,t){return(0,n.ensureNotNull)(e.paneForSource(t.lineTools()[0]))}class xe extends be{constructor(e,t){super(e,t.lineTools(),Ce(Me(e,t),t.lineTools()),ue.format({title:t.name().value()}))}}class Ie extends ve{constructor(e,t){super(e,t.lineTools(),Pe(Me(e,t),t.lineTools()),_e.format({title:t.name().value()}))}}const Le=new T.TranslatedString("rearrange panes",l.t(null,void 0,i(233348)));class ke extends P.UndoCommand{constructor(e,t,i){super(Le),this._chartModel=e,this._index=t,(0,O.isNumber)(i)?this._dstIndex=i:this._dstIndex="up"===i?t-1:t+1}redo(){this._checkIndices()&&this._chartModel.movePane(this._index,this._dstIndex)}undo(){this._checkIndices()&&this._chartModel.movePane(this._dstIndex,this._index)}_checkIndices(){const e=this._chartModel.panes().length;return this._index>=0&&this._index<e&&this._dstIndex>=0&&this._dstIndex<e}}var Ae=i(89820),Ee=i(458527),De=i(853965),Be=i(444331),Re=i(583912),Ne=i(731042),Ve=i(964824);class Oe extends P.UndoCommand{constructor(e,t,i,s,r,o){super(s),this._prevPriceAxisProps={},this._property=e,this._mainSeries=i,this._value=t,this._model=r,this._chartWidget=o}redo(){const e=this._mainSeries,t=e.properties().childs();this._prevResolution=t.interval.value(),this._prevValue=this._property.value(),this._storePriceAxisProps(),(0,De.saveDefaultProperties)(!0);const i=t.interval.value(),s=this._model.defaultResolutions(),r=(0,Ne.getResolutionByChartStyle)(this._value,i,s);Re.linking.interval.setValue(r),e.setChartStyleWithIntervalIfNeeded(this._value,r),(0,Be.setLastUsedStyle)(this._value,e.symbolInfo()),(0,Be.preparePriceAxisProperties)(t),(0,De.saveDefaultProperties)(!1),this._invalidateModel(),this._chartWidget.screen.show(!0)}undo(){const e=this._mainSeries;(0,De.saveDefaultProperties)(!0),e.setChartStyleWithIntervalIfNeeded(this._prevValue,this._prevResolution),this._restorePriceAxisProps(),Re.linking.interval.setValue(this._prevResolution),(0,De.saveDefaultProperties)(!1),this._invalidateModel(),this._chartWidget.screen.show(!0)}_storePriceAxisProps(){const e=this._mainSeries.priceScale();this._prevPriceAxisProps=e.mode()}_restorePriceAxisProps(){this._mainSeries.priceScale().setMode(this._prevPriceAxisProps)}_invalidateModel(){this._model&&(this._model.recalculateAllPanes((0,Ve.sourceChangeEvent)(this._model.mainSeries().id())),this._model.lightUpdate())}}const Fe=new T.TranslatedString("change date range",l.t(null,void 0,i(207151)))
;class We extends P.UndoCommand{constructor(e,t){super(Fe),this._modelsData=[],this._rangeOptions=t,this._modelsData.push({model:e,prevResolution:e.mainSeries().properties().childs().interval.value(),barSpacing:e.timeScale().barSpacing(),rightOffset:e.timeScale().rightOffset(),rangeOptions:e.appliedTimeFrame().value()})}redo(){for(const e of this._modelsData){const t=e.model.mainSeries(),i=t.properties().childs().interval;_.Interval.isEqual(this._rangeOptions.res,i.value())?t.loadDataTo(this._rangeOptions.val):(t.setDefaultTimeframe(this._rangeOptions.val),t.setSymbolParams({interval:this._rangeOptions.res}))}}undo(){for(const e of this._modelsData){const t=e.model.mainSeries(),i=t.properties().childs().interval;e.prevResolution!==i.value()?(null!==e.rangeOptions&&t.setDefaultTimeframe(e.rangeOptions.val),t.setSymbolParams({interval:e.prevResolution})):null!==e.rangeOptions&&t.loadDataTo(e.rangeOptions.val);const s=e.model.timeScale();s.setBarSpacing(e.barSpacing),s.setRightOffset(e.rightOffset)}}canMerge(e){return e instanceof We&&p(e._rangeOptions,this._rangeOptions)}merge(e){if(!(e instanceof We))throw new Error("Invalid command to merge");this._modelsData=this._modelsData.concat(e._modelsData)}}var ze=i(391534);i(586463);class He extends P.UndoCommand{constructor(e,t,i){super(i),this._model=e,this._groupId=t.id,this._groupName=t.name().value(),this._lineToolsIds=t.lineTools().map((e=>e.id()))}redo(){const e=(0,n.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId));this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=new ze.LineToolsGroup(e,this._groupName,this._groupId);this._model.lineToolsGroupModel().addGroup(t)}}const Ue=new T.TranslatedString("create line tools group",l.t(null,void 0,i(3195)));class Ge extends P.UndoCommand{constructor(e,t){super(Ue),this._groupId=null,this._model=e,this._sourcesIds=t.map((e=>e.id()))}redo(){const e=this._sourcesIds.map((e=>this._model.dataSourceForId(e))),t=null===this._groupId?void 0:this._groupId;this._groupId=this._model.lineToolsGroupModel().createGroup(e,this._title,t).id}undo(){const e=(0,n.ensureNotNull)(this._model.lineToolsGroupModel().groupForId((0,n.ensureNotNull)(this._groupId)));this._model.lineToolsGroupModel().removeGroup(e)}createdGroupId(){return this._groupId}}const qe=new T.TranslatedString("add line tool(s) to group {group}",l.t(null,void 0,i(240242)));class je extends P.UndoCommand{constructor(e,t,i){super(qe.format({group:t.name().value()})),this._model=e,this._groupId=t.id,this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,n.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e)));e.addLineTools(t)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e)));(0,n.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)).excludeLineTools(e)}}class Ye extends P.UndoCommand{constructor(e,t,i,s,r){super(i),this._targetObj=e,this._newValue=t,
this._oldValue=this._targetObj.value(),this._model=s,r&&this.setCustomFlag("doesnt_affect_save",!0)}redo(){(0,De.saveDefaultProperties)(!0),this._targetObj.setValue(this._newValue),(0,De.saveDefaultProperties)(!1),this._model.recalculateAllPanes((0,Ve.globalChangeEvent)()),this._model.lightUpdate()}undo(){(0,De.saveDefaultProperties)(!0),this._targetObj.setValue(this._oldValue),(0,De.saveDefaultProperties)(!1),this._model.recalculateAllPanes((0,Ve.globalChangeEvent)()),this._model.lightUpdate()}}class Ke extends P.UndoCommand{constructor(e,t,i,s){super(s),this._chartModel=e,this._groupId=t.id,this._oldName=t.name().value(),this._newName=i}redo(){(0,n.ensureNotNull)(this._chartModel.lineToolsGroupModel().groupForId(this._groupId)).setName(this._newName)}undo(){(0,n.ensureNotNull)(this._chartModel.lineToolsGroupModel().groupForId(this._groupId)).setName(this._oldName)}}var Xe=i(885482),$e=i(541558);class Ze extends P.UndoCommand{constructor(e,t,i,s){super(s),this._model=i,this._id=e.id(),this._targetSharingMode=t,this._originSharingMode=e.sharingMode().value()}redo(){const e=this._model.dataSourceForId(this._id);e&&(e.share(this._targetSharingMode),0!==this._targetSharingMode&&0===this._originSharingMode&&(e.linkKey().setValue((0,$e.randomHash)()),this._model.copyToOtherCharts([e],!1)))}undo(){const e=this._model.dataSourceForId(this._id);e&&(e.share(this._originSharingMode),0===this._originSharingMode&&((0,Xe.removeLineTool)({withUndo:!1,model:this._model,symbol:e.symbol(),linkKey:(0,n.ensureNotNull)(e.linkKey().value()),sourceTitle:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e),lineToolState:e.state(!1),unlink:!0}),e.linkKey().setValue(null)))}}const Qe=new T.TranslatedString("create line tools group from selection",l.t(null,void 0,i(192659))),Je=new T.TranslatedString("removing line tools group {name}",l.t(null,void 0,i(578811))),et=new T.TranslatedString("add line tool {lineTool} to group {name}",l.t(null,void 0,i(799113))),tt=new T.TranslatedString("make group {group} visible",l.t(null,void 0,i(587927))),it=new T.TranslatedString("make group {group} invisible",l.t(null,void 0,i(445223))),st=new T.TranslatedString("lock group {group}",l.t(null,void 0,i(304963))),rt=new T.TranslatedString("unlock group {group}",l.t(null,void 0,i(551114))),ot=new T.TranslatedString("rename group {group} to {newName}",l.t(null,void 0,i(916338))),nt=!0;class at{constructor(e){this._environment=e}createGroupFromSelection(){const e=this._environment.model();(0,n.assert)(!e.selection().isEmpty(),"Cannot create group from empty selection");const t=(0,ie.sortSources)(e.selection().lineDataSources());(0,n.assert)(t.length===e.selection().allSources().length,"A group could contain line tools only");const i=t.length>1||null!==this._environment.model().lineToolsGroupModel().groupForLineTool(t[0]),s=t.reduce(((e,t)=>e.zorder()>t.zorder()?e:t),t[0]);let r=s;const o=e.lineToolsGroupModel().groupForLineTool(s);if(null!==o){const e=o.lineTools();r=e[e.length-1]}this._environment.beginUndoMacro(Qe,nt)
;const a=new Map,l=new Set;t.forEach((t=>{const i=this._groupForLineTool(t);if(null===i)return;const s=a.get(i)||[];s.push(t),a.set(i,s);const r=(0,n.ensureNotNull)(e.paneForSource(t));l.add(r)})),(0,n.assert)(l.size<=1,"All selected sources should be on the same pane"),a.forEach(((t,i)=>{const s=new q.ExcludeLineToolsFromGroupUndoCommand(e,i,t);this._environment.pushUndoCommand(s)}));const c=new Ge(e,(0,ie.sortSources)(t));if(this._environment.pushUndoCommand(c),i){const i=new fe(e,t,r);this._environment.pushUndoCommand(i)}this._environment.endUndoMacro();const h=(0,n.ensureNotNull)(c.createdGroupId());return(0,n.ensureNotNull)(e.lineToolsGroupModel().groupForId(h))}removeGroup(e){const t=this._environment.model(),i=e.lineTools();this._environment.beginUndoMacro(Je.format({name:e.name().value()}),nt);const s=new He(t,e,null);this._environment.pushUndoCommand(s);const r=new G.RemoveSourcesUndoCommand(t,i,null);this._environment.pushUndoCommand(r);const o=t.mainSeries().symbol();i.forEach((e=>{null!==e.linkKey().value()&&(0,Xe.removeLineTool)({withUndo:!0,model:t,symbol:o,sourceTitle:new T.TranslatedString(e.name(),e.title(oe.TitleDisplayTarget.DataWindow)),lineToolState:e.state(!1),linkKey:(0,n.ensureNotNull)(e.linkKey().value())})})),this._environment.endUndoMacro()}groups(){return this._environment.model().lineToolsGroupModel().groups()}excludeLineToolFromGroup(e,t){const i=this._environment.model(),s=new q.ExcludeLineToolsFromGroupUndoCommand(i,e,[t]);s.setCustomFlag("doesnt_affect_save",nt),this._environment.pushUndoCommand(s)}addLineToolToGroup(e,t){const i=this._environment.model(),s=i.lineToolsGroupModel().groupForLineTool(t);if(s===e)return;const r=et.format({lineTool:new T.TranslatedString(t.name(),t.title(oe.TitleDisplayTarget.StatusLine)),name:e.name().value()});if(this._environment.beginUndoMacro(r,nt),null!==s&&this._environment.pushUndoCommand(new q.ExcludeLineToolsFromGroupUndoCommand(i,s,[t])),(0,I.isFeatureEnabled)("save_shared_line_tools")){const s=e.sharingMode().value();t.sharingMode().value()!==s&&this._environment.pushUndoCommand(new Ze(t,s,i,null))}this._environment.pushUndoCommand(new je(i,e,[t])),this._environment.endUndoMacro()}bringToFront(e){const t=this._environment.model(),i=new ge(t,e.lineTools());i.setCustomFlag("doesnt_affect_save",nt),this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}sendToBack(e){const t=this._environment.model(),i=new Se(t,e.lineTools());i.setCustomFlag("doesnt_affect_save",nt),this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}bringForward(e){const t=this._environment.model(),i=new Ie(t,e);i.setCustomFlag("doesnt_affect_save",nt),this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}sendBackward(e){const t=this._environment.model(),i=new xe(t,e);i.setCustomFlag("doesnt_affect_save",nt),this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}insertAfter(e,t){const i=this._environment.model()
;let s;if(t instanceof ze.LineToolsGroup){const e=t.lineTools();s=e[e.length-1]}else s=t;const r=new fe(i,e.lineTools(),s);this._environment.pushUndoCommand(r),this._environment.emitEvent("changeZOrder",[e.lineTools()])}insertBefore(e,t){const i=this._environment.model();let s;if(t instanceof ze.LineToolsGroup){s=t.lineTools()[0]}else s=t;const r=new ye(i,e.lineTools(),s);this._environment.pushUndoCommand(r),this._environment.emitEvent("changeZOrder",[e.lineTools()])}availableZOrderOperations(e){const t=this._environment.model(),i=e.lineTools(),s=i[0],r=i[i.length-1],o=(0,n.ensureNotNull)(t.paneForSource(i[0])).sourcesByGroup().allExceptSpecialSources(),a=o[0],l=o[o.length-1];return{bringForwardEnabled:r!==l,bringToFrontEnabled:r!==l,sendBackwardEnabled:s!==a,sendToBackEnabled:s!==a}}setGroupVisibility(e,t){const i=(t?tt:it).format({group:e.name().value()}),s=this._environment.model();this._environment.beginUndoMacro(i,nt),e.lineTools().forEach((e=>{const i=e.properties().visible,r=new Ye(i,t,null,s);this._environment.pushUndoCommand(r)})),this._environment.endUndoMacro()}setGroupLock(e,t){const i=(t?st:rt).format({group:e.name().value()}),s=this._environment.model();this._environment.beginUndoMacro(i,nt),e.lineTools().forEach((e=>{const i=e.properties().frozen,r=new Ye(i,t,null,s);this._environment.pushUndoCommand(r)})),this._environment.endUndoMacro()}setGroupName(e,t){const i=this._environment.model(),s=ot.format({group:e.name().value(),newName:t}),r=new Ke(i,e,t,s);r.setCustomFlag("doesnt_affect_save",nt),this._environment.pushUndoCommand(r)}canBeGroupped(e){const t=this._environment.model();return new Set(e.map((e=>t.paneForSource(e)))).size<=1}_groupForLineTool(e){return this._environment.model().lineToolsGroupModel().groups().find((t=>t.containsLineTool(e)))||null}}var lt=i(712433),ct=i(569010),ht=i(790524),dt=i(46955);const ut=new T.TranslatedString("apply study template {template}",l.t(null,void 0,i(526065)));function _t(e){for(const t of e.panes)for(const e of t.sources)if((0,ht.isMainSeriesState)(e))return e.id;return null}class pt extends P.UndoCommand{constructor(e,t,i){var s,r;super(ut.format({template:i})),this._newSymbolParams={},this._model=e,this._templateContent=function(e,t){const i=(0,lt.default)({},e),s=(0,n.ensureNotNull)(_t(i));for(const e of i.panes){e.mainSourceId===s&&(e.mainSourceId=t);for(const i of e.sources)if(i.id===s){i.id=t;const r=e=>{const i=e.indexOf(s);-1!==i&&e.splice(i,1,t)};if(e.leftAxisesState&&e.rightAxisesState?(e.leftAxisesState.forEach((e=>r(e.sources))),e.rightAxisesState.forEach((e=>r(e.sources)))):(r(e.leftAxisSources),r(e.rightAxisSources)),e.overlayPriceScales){const i=e.overlayPriceScales[s];i&&(delete e.overlayPriceScales[s],e.overlayPriceScales[t]=i)}}else i.ownerSource===s&&(i.ownerSource=t)}return i}(t,e.mainSeries().id()),this._initialState=e.studyTemplate(!0,!0,!0);const o=e.mainSeries();t.symbol&&(this._newSymbolParams={symbol:t.symbol,currency:null!==(s=t.currency)&&void 0!==s?s:null,unit:null!==(r=t.unit)&&void 0!==r?r:null}),
t.interval&&(this._newSymbolParams.interval=t.interval,this._newSymbolParams.style=(0,Be.getChartStyleByResolution)(t.interval,o.style())),this._initialSymbolParams={symbol:o.symbol(),currency:o.currency(),unit:o.unit(),interval:o.interval(),style:o.style()},this._initialState=e.studyTemplate(),this._initialGroupsState=e.lineToolsGroupModel().state()}redo(){this._model.mainSeries().setSymbolParams(this._newSymbolParams);const e=this._merge(this._templateContent).filter(S.isLineTool);this._model.lineToolsGroupModel().removeLineTools(e);const t=this._model.mainSeries().properties();(0,Be.preparePriceAxisProperties)(t),this._model.recalcVisibleRangeStudies(!0),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){this._model.mainSeries().setSymbolParams(this._initialSymbolParams),this._merge(this._initialState)}_merge(e){const t=e.version||0,i=this._model,s=i.mainSeries();(0,n.assert)(s.id()===_t(e)),s.priceScale().properties().childs().lockScale.setValue(!1);const r=i.panes(),o=[];for(let e=r.length;e--;){const t=r[e],i=t.containsMainSeries(),s=t.dataSources();for(let e=s.length;e--;){const t=s[e];(!i||(0,w.isStudy)(t)&&t.isRemovedByStudyTemplates())&&o.push(t)}}i.resetDeferredStudies();const a=(0,ct.closeSourcesSet)(i,o);for(let e=0;e<a.length;++e)i.removeSource(a[e]);const l=e.panes;for(let e=0;e<l.length;e++){let s=-1;const o=(0,O.clone)(l[e]);o.sources.sort(((e,t)=>e.zorder-t.zorder));for(let e=0;e<o.sources.length;e++){const t=o.sources[e];if((0,ht.isMainSeriesState)(t)){delete t.state,s=e;break}}const a=s>-1,c=a?r[e]:i.createPane(e);if(a&&t<3&&(0,dt.reorderDataSourcesStateZOrder)(o.sources),c.restoreState(o,!1,t),null!==c.mainDataSource()){const e=(0,n.ensureNotNull)(this._model.alertsWatcher());for(const t of c.dataSources())e.syncSourceAlertLabels(t)}else i.removePane(c)}return i.syncLollipopSources(),s.priceScale().setMode({autoScale:!0}),i.startNotStartedStudies(),i.recalculateAllPanes((0,Ve.globalChangeEvent)()),i.fullUpdate(),a}}var mt=i(981107);const gt=(0,C.getLogger)("Chart.ChartUndoModel"),St=new T.TranslatedString("paste drawing",l.t(null,void 0,i(896916)));class vt extends P.UndoCommand{constructor(e,t,i,s,r){super(St),this._needCopyToOtherCharts=!1,this._sourceState=null,this._model=e,this._clipboardData=t,this._paneIndex=this._model.panes().indexOf(i||(0,n.ensureNotNull)(this._model.paneForSource(this._model.mainSeries()))),this._pasteWithData=!!s,this._keepZIndex=!!r}redo(){const e=this._model.panes()[this._paneIndex],t=(0,n.ensureNotNull)(e.clipboardLineToolOwnerSource(this._clipboardData.source.id)),i=t===this._model.mainSeries();null===this._sourceState&&(this._sourceState=this._getSourceState(t,i));const s=(0,n.ensureNotNull)(e.restoreLineTool(this._sourceState,this._pasteWithData,this._keepZIndex,void 0,t));(0,n.ensureNotNull)(t.priceScale()).addDataSource(s),this._clipboardData.centeredOnChart&&s.centerPosition&&s.centerPosition(),s.restoreFixedPoint(),s.createServerPoints(),this._needCopyToOtherCharts=Boolean(i&&s.isSynchronizable()&&0!==s.sharingMode().value()),
this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){if(!this._sourceState)return void gt.logError("This command was never executed - nothing to undo");const e=this.source();this._clipboardData.centeredOnChart&&(this._clipboardData.centeredOnChart=!1,this._sourceState.points=e.normalizedPoints()),this._model.removeSource(e)}source(){return(0,n.ensureNotNull)(this._model.dataSourceForId((0,n.ensureNotNull)(this._sourceState).id))}needCopyToOtherCharts(){return this._needCopyToOtherCharts}_getSourceState(e,t){const i=(0,O.clone)(this._clipboardData.source);delete i.state.symbol,t?(null!=i.linkKey||void 0!==i.sharingMode&&0!==i.sharingMode)&&(i.linkKey=(0,$e.randomHash)()):(i.linkKey=null,i.sharingMode=0);const s=(0,n.ensureNotNull)(e.priceScale()),r=this._model,{symbol:o,currencyId:l,unitId:c}=this._clipboardData.source.state,h=(0,n.ensureNotNull)(e.symbolSource());let d=!1;!h.symbolSameAsCurrent(o)||(null!==l?l!==(0,Be.symbolCurrency)(h.symbolInfo(),void 0,!0):h.isConvertedToOtherCurrency())||(null!==c?c!==(0,Be.symbolUnit)(h.symbolInfo(),this._model.unitConversionEnabled()):h.isConvertedToOtherUnit())||((0,mt.isActingAsSymbolSource)(e)?d=!0:(0,w.isStudy)(e)&&(d=Boolean(e.metaInfo().is_price_study)));const u=e=>{const t=e.x*r.timeScale().width(),i=e.y*s.height()-40;return new a.Point(t,i)},_=(0,n.ensureNotNull)(e.firstValue());if(this._model.id()===this._clipboardData.modelId||!d)for(let e=0;e<this._clipboardData.geometry.length;++e){const t=u(this._clipboardData.geometry[e]),o=r.timeScale().coordinateToIndex(t.x),n=r.timeScale().normalizeBarIndex(o);if(d){const t=s.priceToCoordinate(i.points[e].price,_)+-40;n.price=s.coordinateToPrice(t,_)}else n.price=s.coordinateToPrice(t.y,_);i.points[e]=n}return i.id=(0,$e.randomHashN)(6),i}}class ft extends P.UndoCommand{constructor(e,t,i,s){super(s),this._newSourcesCurrencies=new Map,this._oldSourcesCurrencies=new Map,this._showFade=!1,this._chartWidget=i;const r=i.model().mainSeries();for(const i of e.seriesLikeSources()){if(!i.isVisible()||!i.isActingAsSymbolSource().value())continue;const e=t||(0,Be.symbolOriginalCurrency)((0,n.ensureNotNull)(i.symbolInfo()));this._newSourcesCurrencies.set(i.id(),e),this._oldSourcesCurrencies.set(i.id(),i.currency()),this._showFade=this._showFade||i===r&&i.currency()!==e}}redo(){this._applyCurrencies(this._newSourcesCurrencies)}undo(){this._applyCurrencies(this._oldSourcesCurrencies)}_applyCurrencies(e){const t=this._chartWidget.model().model();e.forEach(((e,i)=>{(0,n.ensureNotNull)(t.dataSourceForId(i)).setCurrency(e)})),this._chartWidget.model().selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartWidget.screen.show(!0)}}class bt extends P.UndoCommand{constructor(e,t,i,s){super(s),this._newSourcesUnits=new Map,this._oldSourcesUnits=new Map,this._showFade=!1,this._chartWidget=i;const r=i.model().mainSeries();for(const i of e.seriesLikeSources()){if(!i.isVisible()||!i.isActingAsSymbolSource().value())continue;const e=t||(0,Be.symbolOriginalUnit)((0,
n.ensureNotNull)(i.symbolInfo()),this._chartWidget.model().model().unitConversionEnabled());this._newSourcesUnits.set(i.id(),e),this._oldSourcesUnits.set(i.id(),i.unit()),this._showFade=this._showFade||i===r&&i.unit()!==e}}redo(){this._applyUnits(this._newSourcesUnits)}undo(){this._applyUnits(this._oldSourcesUnits)}_applyUnits(e){const t=this._chartWidget.model().model();e.forEach(((e,i)=>{(0,n.ensureNotNull)(t.dataSourceForId(i)).setUnit(e)})),this._chartWidget.model().selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartWidget.screen.show(!0)}}class yt extends Y{constructor(e,t,i,s){super(e,t,s),this._sourcePaneRemoved=!1,this._targetPaneIndex=e.panes().indexOf(i)}redo(){const e=this._chartModel.panes()[this._initialPaneIndex],t=this._chartModel.panes()[this._targetPaneIndex],i=e!==t,s=this._targetPriceScale(t),r=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),o=this._chartModel.children(r,!0);for(const e of o)i?(this._chartModel.detachSource(e),t.addDataSource(e,s,!1)):t.move(e,s);i?(this._sourcePaneRemoved=this._chartModel.detachSource(r),t.addDataSource(r,s,!1)):t.move(r,s);const a=t.priceScalePosition(s);t.movePriceScale(s,a,this._targetPriceScaleIndex(r)),this._chartModel.fullUpdate()}undo(){this._sourcePaneRemoved&&this._chartModel.createPane(this._initialPaneIndex);const e=this._chartModel.panes()[this._initialPaneIndex],t=e!==this._chartModel.panes()[this._targetPaneIndex],i=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId));let s=e.getPriceScaleById(this._initialPriceScaleId);null===s&&(s=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex));const r=this._chartModel.children(i,!0);for(const i of r)t?(this._chartModel.detachSource(i),e.addDataSource(i,s,!1)):e.move(i,s);t?(this._chartModel.detachSource(i),e.addDataSource(i,s,!1)):e.move(i,s);const o=(0,n.ensureNotNull)(i.priceScale());o.restoreState(this._originalPriceScaleState()),o.setHeight(e.height()),this._chartModel.fullUpdate()}}class Ct extends yt{constructor(e,t,i,s,r){super(e,t,i,r),this._targetPriceScalePosition=s}_targetPriceScale(e){const t=e.createPriceScaleAtPosition(this._targetPriceScalePosition);return t.restoreState(this._newPriceScaleState("overlay"===this._targetPriceScalePosition)),t.setHeight(e.height()),t}_targetPriceScaleIndex(e){return e===this._chartModel.mainSeries()?0:void 0}}class wt extends yt{constructor(e,t,i,s,r){super(e,t,i,r),this._targetPriceScaleId=s.id()}_targetPriceScale(e){return(0,n.ensureNotNull)(e.getPriceScaleById(this._targetPriceScaleId))}_targetPriceScaleIndex(e){}}var Pt=i(912445);class Tt extends P.UndoCommand{constructor(e,t,i,s){super(e),this._charts=new Map,this._firstRedo=!0,this._creationTime=performance.now(),this._linkingGroupIndex=s.linkingGroupIndex().value(),this._charts.set(s,{sourceId:t.id(),newSymbolParams:i,prevSymbolParams:{symbol:t.symbol(),currency:t.currency(),unit:t.unit(),interval:t.interval(),style:t.style()},showFade:this._showFade(t,s),chartWidget:s})}redo(){this._firstRedo||(0,
Pt.muteLinkingGroup)(this._linkingGroupIndex,!0),this._charts.forEach((e=>{this._symbolSource(e).setSymbolParams(e.newSymbolParams),e.showFade&&e.chartWidget.screen.show(!0)})),this._firstRedo||(0,Pt.muteLinkingGroup)(this._linkingGroupIndex,!1),this._firstRedo=!1}undo(){(0,Pt.muteLinkingGroup)(this._linkingGroupIndex,!0),this._charts.forEach((e=>{this._symbolSource(e).setSymbolParams(e.prevSymbolParams),e.showFade&&e.chartWidget.screen.show(!0)})),(0,Pt.muteLinkingGroup)(this._linkingGroupIndex,!1)}canMerge(e){if(!(e instanceof Tt)||e._linkingGroupIndex!==this._linkingGroupIndex||!this._containsMainSeriesOnly()||!e._containsMainSeriesOnly()||e._creationTime-this._creationTime>500)return!1;for(const[t]of e._charts)if(this._charts.has(t))return!1;return!0}merge(e){if(e instanceof Tt)for(const[t,i]of e._charts)this._charts.set(t,i)}_showFade(e,t){return e===t.model().mainSeries()}_symbolSource(e){return(0,n.ensureNotNull)(e.chartWidget.model().model().dataSourceForId(e.sourceId))}_containsMainSeriesOnly(){for(const[e,t]of this._charts)if(t.sourceId!==e.model().mainSeries().id())return!1;return!0}}const Mt=new T.TranslatedString("change symbol",l.t(null,void 0,i(600526)));class xt extends Tt{constructor(e,t,i){super(Mt,e,{symbol:t,currency:null,unit:null},i),this._symbol=t}canMerge(e){return e instanceof xt&&e._symbol===this._symbol&&super.canMerge(e)}}const It=(0,C.getLogger)("Chart.ChartUndoModel"),Lt=new T.TranslatedString("paste indicator",l.t(null,void 0,i(780611)));class kt extends P.UndoCommand{constructor(e,t,i){super(Lt),this._sourceState=null,this._model=e,this._clipboardData=t,this._paneId=i}redo(){if(!this._sourceState){const e=(0,O.clone)(this._clipboardData.source);e.id=(0,$e.randomHashN)(6),this._sourceState=e}let e,t;e=this._paneId?(0,n.ensureNotNull)(this._model.paneForId(this._paneId)):this._sourceState.metaInfo.is_price_study?(0,n.ensureNotNull)(this._model.paneForSource(this._model.mainSeries())):this._model.createPane();const i=!e.mainDataSource();this._sourceState.zorder=e.newStudyZOrder();const s=(0,n.ensureNotNull)(e.restoreStudy(this._sourceState,!1));i||(t=this._sourceState.metaInfo.is_price_study?t=this._model.mainSeries().priceScale():this._paneId?e.findSuitableScale(s):e.defaultPriceScale(),t!==s.priceScale()&&e.move(s,t)),(0,w.isStudy)(s)&&s.start()}undo(){if(null===this._sourceState)return void It.logError("This command was never executed - nothing to undo");const e=(0,n.ensureNotNull)(this._model.dataSourceForId(this._sourceState.id));this._model.removeSource(e)}state(){return this._sourceState}}class At extends P.UndoCommand{constructor(e,t,i,s,r){super(null,!1),this._model=e,this._paneA=t,this._paneB=i,this._prevStretchA=s,this._currStretchA=r}redo(){const e=this._paneA.stretchFactor()+this._paneB.stretchFactor();this._paneA.setStretchFactor(this._currStretchA),this._paneB.setStretchFactor(e-this._currStretchA),this._model.fullUpdate()}undo(){const e=this._paneA.stretchFactor()+this._paneB.stretchFactor();this._paneA.setStretchFactor(this._prevStretchA),
this._paneB.setStretchFactor(e-this._prevStretchA),this._model.fullUpdate()}}var Et=i(950740);const Dt=new T.TranslatedString("move",l.t(null,void 0,i(647107)));class Bt extends P.UndoCommand{constructor(e,t,i,s){super(Dt,!1),this._endEvent=null,this._model=e,this._sourceId=t.id(),this._itemIndex=i,this._startEvent=s}move(e){this._endEvent=e,this._move(e)}hasChanges(){return null!==this._endEvent}undo(){this._move(this._startEvent)}redo(){this._move((0,n.ensureNotNull)(this._endEvent))}_move(e){const t=(0,n.ensureNotNull)(this._model.dataSourceForId(this._sourceId));(0,n.assert)(void 0!==t.moveItem,'The method "moveItem" is not defined'),t.moveItem&&t.moveItem(new a.Point(e.localX,e.localY),this._itemIndex,new Et.EnvironmentState(e))}}var Rt=i(247001),Nt=i(181728);class Vt extends P.UndoCommand{constructor(e,t,i,s,r,o,n,a,l,c,h,d,u){super(u),this._paneState=null,this._lastInsertionStartPromise=null,this._additionalStudiesIds=[],this._chartModel=e,this._studyMetaInfo=t,this._props=s,this._addAsOverlay=r,this._parentIds=o.map((e=>e.id())),this._inputs=i,this._targetZOrder=h,this._preferredPriceScale=n,this._allowChangeCurrency=a,this._allowChangeUnit=l,this._paneSize=c,this._studyId=null!=d?d:null}redo(){const e=this._parentIds.map((e=>this._chartModel.dataSourceForId(e))),t=this._chartModel.insertStudyWithParams(this._studyMetaInfo,this._inputs,this._targetZOrder,this._props,this._addAsOverlay,e,this._preferredPriceScale,this._allowChangeCurrency,this._allowChangeUnit,this._paneSize,null===this._studyId?void 0:this._studyId),i=t.study;if((0,w.isFundamentalStudy)(i))this._createCopiesOfNewFundamentalForAllStocks();else if((0,mt.isSymbolSource)(i)){null!==i.symbolInfo()?this._createCopiesOfExistingFundamentalsForNewStock():i.symbolResolved().subscribe(this,this._createCopiesOfExistingFundamentalsForNewStock,!0)}if(this._lastInsertionStartPromise=t.startPromise,this._studyId=i.id(),i.childStudyByRebind().subscribe(null,(()=>(0,f.trackEvent)("SOS","Apply SOS","Rebind SOS"))),(0,Rt.trackStudies)(i,"add"),this._chartModel.setShouldBeSavedEvenIfHidden(!0),null!==this._paneState){(0,n.ensureNotNull)(this._chartModel.paneForSource(i)).restoreState(this._paneState,!1,this._chartModel.version()),this._paneState=null}}undo(){const e=(0,n.ensureNotNull)(this._chartModel.dataSourceForId((0,n.ensureNotNull)(this._studyId)));(0,mt.isSymbolSource)(e)&&e.symbolResolved().unsubscribeAll(this);const t=(0,n.ensureNotNull)(this._chartModel.paneForSource(e)).state();this._additionalStudiesIds.forEach((e=>{const t=(0,n.ensureNotNull)(this._chartModel.dataSourceForId(e));this._chartModel.removeSource(t)})),this._additionalStudiesIds=[],this._chartModel.removeSource(e)&&(this._paneState=t)}insertedStudy(){return this._chartModel.dataSourceForId((0,n.ensureNotNull)(this._studyId))}lastInsertionStartPromise(){var e;return null!==(e=this._lastInsertionStartPromise)&&void 0!==e?e:Promise.resolve()}_createCopiesOfNewFundamentalForAllStocks(){const e=this._studyMetaInfo.symbolInputId();this._chartModel.allStudies(!0).filter((e=>(0,
mt.isSymbolSource)(e)&&e.isVisible())).map((e=>e.symbolSource())).forEach((t=>{const i=t.symbolInfo();if(null!==i&&(0,Nt.isStockSymbol)(i.type,i.typespecs)){const i={};i[(0,n.ensureNotNull)(e)]=t.symbol();const s=this._chartModel.insertStudyWithParams(this._studyMetaInfo,i,null,this._props,!1);this._additionalStudiesIds.push(s.study.id())}}))}_createCopiesOfExistingFundamentalsForNewStock(){const e=(0,n.ensureNotNull)(this._chartModel.dataSourceForId((0,n.ensureNotNull)(this._studyId))),t=e.symbolInfo();if(null!==t&&(0,Nt.isStockSymbol)(t.type,t.typespecs)){const t=new Set;this._chartModel.allStudies(!0).filter((e=>(0,w.isFundamentalStudy)(e)&&e.isVisible())).forEach((i=>{const s=i.metaInfo();if(!t.has(s.fullId)){const i={};i[(0,n.ensureNotNull)(s.symbolInputId())]=e.symbol();const r=this._chartModel.insertStudyWithParams(s,i,null,this._props,!1);this._additionalStudiesIds.push(r.study.id()),t.add(s.fullId)}}))}}}var Ot=i(209800),Ft=i(607113),Wt=i.n(Ft),zt=i(918208),Ht=i(438907),Ut=i(371764),Gt=i(972375),qt=i(62802),jt=i(520259);var Yt=i(606097),Kt=i(744084);class Xt extends P.UndoCommand{constructor(e){const{undoText:t,chartModel:i,linkKey:s,symbol:r,state:o,unlink:n}=e;super(t),this._chartModel=i,this._linkKey=s,this._symbol=r,this._state=o,this._unlink=n}redo(){const e=(0,S.lineToolByLinkKey)(this._chartModel,this._linkKey);e?(this._unlink&&e.detachAlert(),new Kt.RemoveLineDataSourcesUndoCommand({chartModel:this._chartModel,lineDataSourceIds:[e.id()],title:null}).redo()):this._chartModel.lineToolsSynchronizer().markSyncedLineToolAsDeleted(this._linkKey,this._symbol).then((e=>{if(null!==e){this._state.id=e;const t=(0,S.lineToolByLinkKey)(this._chartModel,this._linkKey);null!==t&&t.setId(e)}}))}undo(){}}var $t=i(953639),Zt=i(470130);const Qt=new T.TranslatedString("zoom",l.t(null,void 0,i(659833)));class Jt extends P.UndoCommand{constructor(e,t,i,s,r,o){super(Qt),this._barSpacing=null,this._rightBarsOffset=null,this._leftBarsOffset=null,this._priceMode=null,this._model=e,this._startBar=t,this._endBar=i,this._startPrice=s,this._endPrice=r,this._pane=o}redo(){const e=(0,n.ensureNotNull)(this._model.timeScale().visibleBarsStrictRange());this._leftBarsOffset=e.firstBar()-this._startBar,this._rightBarsOffset=e.lastBar()-this._endBar,this._barSpacing=this._model.timeScale().barSpacing(),this._priceMode=this._pane.defaultPriceScale().mode(),this._model.zoomToViewport(this._startBar,this._endBar,this._startPrice,this._endPrice,this._pane)}undo(){const e=this._model.timeScale(),t=this._pane.defaultPriceScale(),i=(0,n.ensureNotNull)(e.visibleBarsStrictRange());e.setBarSpacing((0,n.ensureNotNull)(this._barSpacing)),e.zoomToBarsRange(i.firstBar()+(0,n.ensureNotNull)(this._leftBarsOffset),i.lastBar()+(0,n.ensureNotNull)(this._rightBarsOffset)),t.setMode((0,n.ensureNotNull)(this._priceMode)),t.recalculatePriceRange((0,n.ensureNotNull)(e.visibleBarsStrictRange())),this._model.recalculateAllPanes((0,Ve.viewportChangeEvent)()),this._model.lightUpdate()}}const ei=(0,
C.getLogger)("Chart.ChartUndoModel"),ti=new T.TranslatedString("zoom",l.t(null,void 0,i(659833)));class ii extends P.UndoCommand{constructor(e,t,i){super(ti),this._baseCmd=e,this._zoomStack=t,this._inOut=i}undo(){if(this._inOut){if(this._baseCmd!==this._zoomStack.head())return void ei.logDebug("zoom stack inconsistency");this._baseCmd.undo(),this._zoomStack.pop()}else this._baseCmd.redo(),this._zoomStack.push(this._baseCmd)}redo(){if(this._inOut)this._baseCmd.redo(),this._zoomStack.push(this._baseCmd);else{if(this._baseCmd!==this._zoomStack.head())return void ei.logDebug("zoom stack inconsistency");this._baseCmd.undo(),this._zoomStack.pop()}}}const si=new T.TranslatedString("stop syncing drawing",l.t(null,void 0,i(598784)));class ri extends P.UndoCommand{constructor(e,t){super(si),this._model=e,this._sourceId=t.id(),this._linkKey=t.linkKey().value()}redo(){(0,n.ensureNotNull)(this._model.dataSourceForId(this._sourceId)).linkKey().setValue(null)}undo(){(0,n.ensureNotNull)(this._model.dataSourceForId(this._sourceId)).linkKey().setValue(this._linkKey)}}const oi=new T.TranslatedString("restore defaults",l.t(null,void 0,i(209608)));class ni extends P.UndoCommand{constructor(e,t,i=oi){super(i),this._chartModel=e,this._defaultProperty=t,this._state=t.state()}redo(){this._chartModel.restoreFactoryDefaults(this._defaultProperty)}undo(){this._defaultProperty.mergeAndFire(this._state),this._chartModel.mainSeries().onChartStyleChanged()}}var ai=i(808068);class li extends ni{redo(){this._defaultProperty.hasChild("intervalsVisibilities")&&this._defaultProperty.childs().intervalsVisibilities.mergeAndFire(ai.intervalsVisibilitiesDefaults),super.redo()}}class ci extends li{redo(){super.redo(),this._chartModel.recalcColorStudies(!0)}undo(){super.undo(),this._chartModel.recalcColorStudies(!0)}}var hi=i(395098),di=i(329806),ui=i(42292);function _i(e){const{visible:t,...i}=e;return i}function pi(e){const{visible:t,...i}=e;return i}function mi(e){const{drawWick:t,drawBorder:i,drawBody:s,barColorsOnPrevClose:r,...o}=e;return o}function gi(e){const{drawWick:t,drawBorder:i,drawBody:s,...r}=e;return r}function Si(e){const{drawWick:t,drawBorder:i,drawBody:s,showRealLastPrice:r,inputs:o,...n}=e;return n}function vi(e){const{barColorsOnPrevClose:t,dontDrawOpen:i,thinBars:s,...r}=e;return r}function fi(e){const{showBorders:t,showLabels:i,drawBody:s,...r}=e;return r}function bi(e){const{linestyle:t,linewidth:i,priceSource:s,...r}=e;return r}function yi(e){const{linestyle:t,linewidth:i,priceSource:s,...r}=e;return r}function Ci(e){const{inputs:t,...i}=e;return i}function wi(e){const{inputs:t,...i}=e;return i}function Pi(e){const{inputs:t,...i}=e;return i}function Ti(e){const{inputs:t,...i}=e;return i}function Mi(e){const{topLineWidth:t,bottomLineWidth:i,baseLevelPercentage:s,priceSource:r,...o}=e;return o}function xi(e){const{thinBars:t,inputs:i,...s}=e;return s}function Ii(e){
const{visible:t,style:i,symbol:s,interval:r,sessionId:o,highLowAvgPrice:n,showCountdown:a,bidAsk:l,prePostMarket:c,priceAxisProperties:h,candleStyle:d,hollowCandleStyle:u,haStyle:_,barStyle:p,hiloStyle:m,lineStyle:g,lineWithMarkersStyle:S,steplineStyle:v,areaStyle:f,renkoStyle:b,pbStyle:y,kagiStyle:C,pnfStyle:w,baselineStyle:P,rangeStyle:T,esdShowDividends:M,esdShowSplits:x,esdShowEarnings:I,esdShowBreaks:L,showContinuousContractSwitches:k,showContinuousContractSwitchesBreaks:A,showFuturesContractExpiration:E,showLastNews:D,...B}=e;return{bidAsk:_i(l),prePostMarket:pi(c),candleStyle:mi(d),hollowCandleStyle:gi(u),haStyle:Si(_),barStyle:vi(p),hiloStyle:fi(m),lineStyle:bi(g),lineWithMarkersStyle:bi(S),steplineStyle:bi(v),areaStyle:yi(f),renkoStyle:Ci(b),pbStyle:wi(y),kagiStyle:Pi(C),pnfStyle:Ti(w),baselineStyle:Mi(P),rangeStyle:xi(T),...B}}function Li(e){const{scaleSeriesOnly:t,showSeriesLastValue:i,showStudyLastValue:s,showSymbolLabels:r,showBidAskLabels:o,showPrePostMarketPriceLabel:n,showStudyPlotLabels:a,showFundamentalNameLabel:l,showFundamentalLastValue:c,seriesLastValueMode:h,...d}=e;return d}function ki(e){const{topMargin:t,bottomMargin:i,...s}=e;return s}const Ai=new T.TranslatedString("apply chart theme",l.t(null,void 0,i(766568)));class Ei extends P.UndoCommand{constructor(e,t,i){var s,r,o;super(Ai),this._model=e,this._newSessionProps=t.sessions||(0,ui.factoryDefaults)("sessions"),["candleStyle","hollowCandleStyle","haStyle"].forEach((e=>{t.mainSourceProperties[e].wickUpColor=t.mainSourceProperties[e].wickUpColor||t.mainSourceProperties[e].wickColor,t.mainSourceProperties[e].wickDownColor=t.mainSourceProperties[e].wickDownColor||t.mainSourceProperties[e].wickColor})),t.chartProperties=null!==(s=t.chartProperties)&&void 0!==s?s:{paneProperties:{},scalesProperties:void 0},t.chartProperties.paneProperties.vertGridProperties=null!==(r=t.chartProperties.paneProperties.vertGridProperties)&&void 0!==r?r:t.chartProperties.paneProperties.gridProperties,t.chartProperties.paneProperties.horzGridProperties=null!==(o=t.chartProperties.paneProperties.horzGridProperties)&&void 0!==o?o:t.chartProperties.paneProperties.gridProperties;const n=this._model.properties().state().paneProperties.legendProperties;delete n.backgroundTransparency,t.chartProperties.paneProperties.legendProperties={...t.chartProperties.paneProperties.legendProperties,...n};const a=(0,ui.factoryDefaults)("chartproperties"),l=(0,di.deepExtend)({},a,t.chartProperties);this._newChartProps={paneProperties:ki(l.paneProperties),scalesProperties:Li(l.scalesProperties)},e.timeScale().preserveBarSpacing()&&delete this._newChartProps.scalesProperties.barSpacing;const c=(0,ui.factoryDefaults)("chartproperties.mainSeriesProperties"),h=(0,di.deepExtend)({},c,t.mainSourceProperties);this._newSeriesProps=i?h:Ii(h);const d=e.properties().state();this._oldChartProps={paneProperties:ki(d.paneProperties),scalesProperties:Li(d.scalesProperties)};const u=e.mainSeries().properties().state();this._oldSeriesProps=i?u:Ii(u),
this._oldSessionProps=this._model.sessions().properties().state()}undo(){this._merge(this._oldChartProps,this._oldSeriesProps,this._oldSessionProps),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales(),this._model.chartThemeLoaded()}redo(){this._merge(this._newChartProps,this._newSeriesProps,this._newSessionProps),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales(),this._model.chartThemeLoaded()}_merge(e,t,i){var s,r,o,n;const a=this._model;(0,De.saveDefaultProperties)(!0),e&&(a.properties().childs().paneProperties.mergeAndFire(e.paneProperties),a.properties().childs().scalesProperties.mergeAndFire(e.scalesProperties)),"priceAxisProperties"in t&&a.mainSeries().priceScale().setMode({autoScale:null===(s=t.priceAxisProperties)||void 0===s?void 0:s.autoScale,percentage:null===(r=t.priceAxisProperties)||void 0===r?void 0:r.percentage,log:null===(o=t.priceAxisProperties)||void 0===o?void 0:o.log,lockScale:null===(n=t.priceAxisProperties)||void 0===n?void 0:n.lockScale}),a.mainSeries().properties().mergeAndFire(t),a.mainSeries().properties().saveDefaults(),a.mainSeries().createPaneView(),a.mainSeries().invalidateBarStylesCache(),a.recalculateAllPanes((0,Ve.globalChangeEvent)()),a.fullUpdate(),a.properties().saveDefaults(),a.sessions().restoreState({properties:i},!1),(0,De.saveDefaultProperties)(!1)}}const Di=new T.TranslatedString("change resolution",l.t(null,void 0,i(932303)));class Bi extends Tt{constructor(e,t,i){super(Di,e,function(e,t){let i;const s=(0,Be.isRangeStyle)(e.style()),r=_.Interval.isRange(t);return!s&&r?i=11:s&&!r&&(i=(0,Be.getLastUsedStyle)()),{interval:t,style:i}}(e,t),i),this._resolution=t}canMerge(e){return e instanceof Bi&&e._resolution===this._resolution&&super.canMerge(e)}_showFade(e,t){return!0}}var Ri=i(993713);class Ni extends Ri.SetWatchedValueCommand{constructor(){super(...arguments),this._firstRedo=!0}redo(){this._firstRedo||(0,Pt.muteLinkingGroup)(this._newValue,!0),(0,Pt.muteLinkingGroup)(this._oldValue,!0),super.redo(),this._firstRedo||(0,Pt.muteLinkingGroup)(this._newValue,!1),(0,Pt.muteLinkingGroup)(this._oldValue,!1),this._firstRedo=!1}undo(){(0,Pt.muteLinkingGroup)(this._newValue,!0),(0,Pt.muteLinkingGroup)(this._oldValue,!0),super.undo(),(0,Pt.muteLinkingGroup)(this._newValue,!1),(0,Pt.muteLinkingGroup)(this._oldValue,!1)}}var Vi=i(849245),Oi=i(251954)
;const Fi=new T.TranslatedString("send {title} backward",l.t(null,void 0,i(216259))),Wi=new T.TranslatedString("bring {title} forward",l.t(null,void 0,i(356763))),zi=new T.TranslatedString("insert {title} after {target}",l.t(null,void 0,i(974055))),Hi=new T.TranslatedString("insert {title} before {target}",l.t(null,void 0,i(411231))),Ui=new T.TranslatedString("cut {title}",l.t(null,void 0,i(78755))),Gi=new T.TranslatedString("cut sources",l.t(null,void 0,i(63649))),qi=new T.TranslatedString("remove {title}",l.t(null,void 0,i(839859))),ji=new T.TranslatedString("remove drawings group",l.t(null,void 0,i(570653))),Yi=new T.TranslatedString("move scale",l.t(null,void 0,i(804184))),Ki=new T.TranslatedString("stop syncing line tool(s)",l.t(null,void 0,i(157011))),Xi=new T.TranslatedString("zoom out",l.t(null,void 0,i(809645))),$i=new T.TranslatedString("zoom in",l.t(null,void 0,i(119813))),Zi=new T.TranslatedString("move drawing(s)",l.t(null,void 0,i(145356))),Qi=new T.TranslatedString("load default drawing template",l.t(null,void 0,i(354597))),Ji=new T.TranslatedString("apply factory defaults to selected sources",l.t(null,void 0,i(796996))),es=new T.TranslatedString("change currency",l.t(null,void 0,i(222641))),ts=new T.TranslatedString("change unit",l.t(null,void 0,i(239028))),is=new T.TranslatedString("clone line tools",l.t(null,void 0,i(205179))),ss=new T.TranslatedString("merge up",l.t(null,void 0,i(266143))),rs=new T.TranslatedString("merge down",l.t(null,void 0,i(162153))),os=new T.TranslatedString("merge to pane",l.t(null,void 0,i(170746))),ns=new T.TranslatedString("unmerge up",l.t(null,void 0,i(52540))),as=new T.TranslatedString("unmerge down",l.t(null,void 0,i(786949))),ls=new T.TranslatedString("unmerge to new bottom pane",l.t(null,void 0,i(220057))),cs=new T.TranslatedString("move {title} to new right scale",l.t(null,void 0,i(545544))),hs=new T.TranslatedString("move {title} to new left scale",l.t(null,void 0,i(411303))),ds=new T.TranslatedString("make {title} no scale (Full screen)",l.t(null,void 0,i(774642))),us=new T.TranslatedString("scroll time",l.t(null,void 0,i(170009))),_s=new T.TranslatedString("scale time",l.t(null,void 0,i(235962))),ps=new T.TranslatedString("reset time scale",l.t(null,void 0,i(855064))),ms=new T.TranslatedString("reset scales",l.t(null,void 0,i(721948))),gs=new T.TranslatedString("create {tool}",l.t(null,void 0,i(581791))),Ss=new T.TranslatedString("change {pointIndex} point",l.t(null,void 0,i(572032))),vs=new T.TranslatedString("paste {title}",l.t(null,void 0,i(441601))),fs=new T.TranslatedString("insert {title}",l.t(null,void 0,i(90743))),bs=new T.TranslatedString("remove all studies",l.t(null,void 0,i(415516))),ys=new T.TranslatedString("remove drawings",l.t(null,void 0,i(644656))),Cs=new T.TranslatedString("remove all studies and drawing tools",l.t(null,void 0,i(580171))),ws=new T.TranslatedString("turn line tools sharing off",l.t(null,void 0,i(128068))),Ps=new T.TranslatedString("share line tools in layout",l.t(null,void 0,i(977554))),Ts=new T.TranslatedString("share line tools globally",l.t(null,void 0,i(64704))),Ms=new T.TranslatedString("change linking group",l.t(null,void 0,i(323783))),xs=l.t(null,void 0,i(875139)),Is=(0,
C.getLogger)("Chart.ChartUndoModel"),Ls=(0,I.isFeatureEnabled)("hide_tweet_drawingtool"),ks=!0;function As(e,t){return{bringForwardEnabled:e.bringForwardEnabled||t.bringForwardEnabled,bringToFrontEnabled:e.bringToFrontEnabled||t.bringToFrontEnabled,sendBackwardEnabled:e.sendBackwardEnabled||t.sendBackwardEnabled,sendToBackEnabled:e.sendToBackEnabled||t.sendToBackEnabled}}const Es=(0,I.isFeatureEnabled)("save_shared_line_tools");function Ds(){return Es?(0,Xe.drawOnAllCharts)().value()?1===(0,Xe.drawOnAllChartsMode)().value()?1:2:0:(0,Xe.drawOnAllCharts)().value()?1:0}class Bs extends(r()){constructor(e,t,i,s,r,o,n,a,l,c,h,d){super(),this._createLineCommand=null,this._initialTimeScrollState=null,this._initialTimeScrollPos=null,this._scalePriceInfo=null,this._currentSourceMoveCommand=null,this._currentLineChangeCommand=null,this._currentCustomMoveCommand=null,this._zoomStack=new m.UndoStack,this._chartWidget=o,this.m_model=new(Wt())(e,t,i,s,r,this,a,l,c,h,d),this._undoHistory=n,this._lineToolsGroupController=new at({model:this._model.bind(this),pushUndoCommand:this._pushUndoCommand.bind(this),beginUndoMacro:(e,t)=>{this._undoHistory.beginUndoMacro(e).setCustomFlag("doesnt_affect_save",!!t)},endUndoMacro:this._undoHistory.endUndoMacro.bind(this._undoHistory),emitEvent:this.emitEvent.bind(this)})}undoHistory(){return this._undoHistory}setWatchedValue(e,t,i){this._undoHistory.setWatchedValue(e,t,i)}lineToolsGroupController(){return this._lineToolsGroupController}mergeAllScales(e){!function(e,t){e.beginUndoMacro("left"===t?F:W),e.model().panes().forEach((i=>{const s="left"===t?i.rightPriceScales():i.leftPriceScales(),r=("left"===t?i.leftPriceScales():i.rightPriceScales()).concat(s),o="overlay"===i.priceScalePosition(i.defaultPriceScale())?r[0]:i.defaultPriceScale();e.movePriceScale(i,o,t,0),r.forEach((t=>{if(t===o)return;let s=t.mainSource();for(;null!==s;){e.moveToScale(s,i,o,null,!0);const r=t.mainSource();if(r===s){z.logError("Loop detected while trying to merge scales");break}s=r}}))})),e.endUndoMacro(),e.model().fullUpdate()}(this,e)}movePriceScale(e,t,i,s){const r=new H(this._model(),e,t,i,s,Yi);this._pushUndoCommand(r)}createLineTool({pane:e,point:t,linetool:i,properties:s,linkKey:r,ownerSource:o,disableSynchronization:a,sharingMode:l=Ds(),id:c}){if(("LineToolRegressionTrend"===i||"LineToolAnchoredVWAP"===i)&&!this.canCreateStudy())return(0,h.showTooManyStudiesNotice)(),null;const d=gs.format({tool:new T.TranslatedString(i,zt.lineToolsLocalizedNames[i])});this.beginUndoMacro(d,ks);const u=!a;this._createLineCommand=new re.CreateLineToolUndoCommand({model:this._model(),pane:e,lineTool:i,ownerSource:o||(0,n.ensureNotNull)(e.mainDataSource()),drawOnAllChartsMode:l,id:c});const _=this._createLineCommand.startCreatingLine(t,s,r||null,l),p=(0,n.ensureNotNull)(this._createLineCommand.line());let m=null;if(_&&(u&&this.finishLineTool(p),this._pushUndoCommand(this._createLineCommand),this._createLineCommand=null,m={points:p.normalizedPoints(),interval:this.mainSeries().interval()}),u&&void 0===r&&(0,
Xe.drawOnAllCharts)().value()&&p.isSynchronizable()){const e=(0,n.ensureNotNull)(this.model().externalTimeStamp(t.index)),s={point:{price:t.price,timeStamp:e},linetool:i,properties:p.properties(),symbol:this.mainSeries().symbol(),model:this.model(),linkKey:(0,n.ensureNotNull)(p.linkKey().value()),finalState:m,id:p.id(),sharingMode:p.sharingMode().value()};p.isFixed()&&(s.pointPositionPercents=p.calcPositionPercents()),(0,Xe.createLineTool)(s)}return this.endUndoMacro(),p}continueCreatingLine(e,t,i,s){const r=(0,n.ensureNotNull)(this._createLineCommand);this.beginUndoMacro(r.text(),ks);const o=(0,n.ensureNotNull)(this._model().lineBeingCreated()),a=r.continueCreatingLine(e,t,i,s);let l=null;if(a&&(this.finishLineTool(o),this._pushUndoCommand(r),this._createLineCommand=null,l={points:o.normalizedPoints(),interval:this.mainSeries().interval()}),r.drawOnAllCharts()&&o.isSynchronizable()){const i=(0,n.ensureNotNull)(this._model().externalTimeStamp(e.index));(0,Xe.continueLineTool)({point:{price:e.price,timeStamp:i},envState:t,finalState:l,model:this._model()})}return this.endUndoMacro(),a}continueExternalLine(e,t,i){const s=(0,n.ensureNotNull)(this._createLineCommand),r=s.continueCreatingLine(e,t,i);return r&&(this._pushUndoCommand(s),this._createLineCommand=null),r}finishLineTool(e){this._model().finishLineTool(e)}pasteImageAsLineTool(e,t,i,s){const r=this._model().timeScale(),o=r.width(),a=i.height(),l=i.defaultPriceScale(),c=(0,n.ensureNotNull)((0,n.ensureNotNull)(l.mainSource()).firstValue()),h={price:l.coordinateToPrice(a/2,c),index:r.coordinateToIndex(o/2)},d=(0,S.createLineToolProperties)("LineToolImage",void 0,this.model());void 0!==s&&d.childs().transparency.setValue(s);const u=(0,n.ensureNotNull)(l.mainSource());(0,S.prepareLineToolPropertiesByOwnerSource)(d,u);const _=this.createLineTool({pane:i,point:h,linetool:"LineToolImage",properties:d});return _&&(_.setBlobImageUrl(t),this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(_,null)})),e.then((e=>{_.properties().childs().url.setValue(e)})).catch((e=>{const t=_.linkKey().value(),i=this.model();null!==t&&(0,Xe.removeLineTool)({withUndo:!1,model:i,linkKey:t,symbol:_.symbol(),sourceTitle:new T.TranslatedString(_.name(),_.translatedType()),lineToolState:_.state(!1)}),i.removeSource(_)}))),_}loadRange(e){const t=this._model(),i=t.mainSeries().getSupportedResolution(e.res),s={val:e.val,res:i},r=t.appliedTimeFrame().value();return(null===r||!p(r,s))&&(this._pushUndoCommand(new We(t,s)),!0)}unlinkLines(e){const t=this.model();this.beginUndoMacro(Ki,ks);for(const i of e)null!==i.linkKey().value()&&(0,Xe.removeLineTool)({withUndo:!0,model:this.model(),symbol:i.symbol(),linkKey:(0,n.ensureNotNull)(i.linkKey().value()),sourceTitle:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,i),lineToolState:i.state(!1),unlink:!0}),this._pushUndoCommand(new ri(t,i));this.endUndoMacro()}zoomFromViewport(){const e=new ii((0,n.ensureDefined)(this._zoomStack.head()),this._zoomStack,!1);this._pushUndoCommand(e)}zoomToViewport(e,t,i,s,r){
const o=new Jt(this.m_model,e,t,i,s,r),n=new ii(o,this._zoomStack,!0);this._pushUndoCommand(n)}zoomStack(){return this._zoomStack}hoveredSource(){return this.m_model.hoveredSource()}setProperty(e,t,i,s){if(e&&e.value()!==t){const r=new Ye(e,t,i,this.m_model,s);this._pushUndoCommand(r),this.emitEvent("setProperty")}}withMacro(e,t,i){const s=this.beginUndoMacro(e,i);try{t()}finally{this.endUndoMacro()}return s}barsMarksSources(){return this.m_model.barsMarksSources()}removeAllDrawingTools(){this.beginUndoMacro(ys,!0),this._removeAllDrawingToolsImpl(),this.endUndoMacro()}removeAllStudiesAndDrawingTools(){this.beginUndoMacro(Cs),this._removeAllDrawingToolsImpl(),this._removeAllStudiesImpl(),this.endUndoMacro()}removeAllStudies(){this.beginUndoMacro(bs),this._removeAllStudiesImpl(),this.endUndoMacro()}scrollChartByBar(e){if(!this.m_model.scrollEnabled())return;const t=e*this.m_model.timeScale().barSpacing();this.startScrollTime(0),this.scrollTimeTo(t),this.endScrollTime()}canZoomIn(){return this.model().canZoomIn()}canZoomOut(){return this.model().canZoomOut()}zoomOut(){const e=this.timeScale().width();if(this.canZoomOut()){try{this.beginUndoMacro(Xi)}catch(e){return}(0,v.doAnimate)({to:e/5,onStep:e=>{this.startScaleTime(0),this.scaleTimeTo(e),this.endScaleTime()},onComplete:()=>this.endUndoMacro()})}}zoomIn(){const e=this.timeScale().width();if(this.canZoomIn()){try{this.beginUndoMacro($i)}catch(e){return}(0,v.doAnimate)({to:e/5,onStep:e=>{this.startScaleTime(e),this.scaleTimeTo(0),this.endScaleTime()},onComplete:()=>this.endUndoMacro()})}}startMovingSources(e,t,i,s){e.filter((e=>e.doesMovingAffectsUndo())).length&&(this._currentSourceMoveCommand=new j(this.model(),e,Zi,!1),e.every(S.isLineTool)&&this._currentSourceMoveCommand.setCustomFlag("doesnt_affect_save",ks)),this.model().startMovingSources(e,t,i,new Map,s)}moveSources(e,t){this.model().moveSources(e,new Map,t)}endMovingSource(e,t){this.model().endMovingSources(e,void 0,t),null!==this._currentSourceMoveCommand&&(this._currentSourceMoveCommand.saveNewState(),this._pushUndoCommand(this._currentSourceMoveCommand)),this._currentSourceMoveCommand=null}startChangingLinetool(e,t,i,s,r){this._currentLineChangeCommand=new j(this.model(),[e],Ss.format({pointIndex:i}),!1),this._currentLineChangeCommand.setCustomFlag("doesnt_affect_save",ks),this.model().startChangingLinetool(e,t,i,s,r)}changeLinePoint(e,t){this.model().changeLinePoint(e,t)}endChangingLinetool(e){this.model().endChangingLinetool(e),null!==this._currentLineChangeCommand&&(this._currentLineChangeCommand.saveNewState(),this._pushUndoCommand(this._currentLineChangeCommand)),this._currentLineChangeCommand=null}setChartStyleProperty(e,t,i){if(e.value()!==t){const s=new Oe(e,t,this.mainSeries(),i,this.model(),this.chartWidget());this._pushUndoCommand(s),this.emitEvent("setChartStyleProperty"),(0,Ee.trackChartStyleChanged)(e.value())}}restorePropertiesForSource(e){(0,S.isLineTool)(e)?this._restoreLineToolFactoryDefaults(e):this._restoreStudyFactoryDefaults(e)}restoreLineToolsFactoryDefaults(e){
1===e.length?this._restoreLineToolFactoryDefaults(e[0]):(this.beginUndoMacro(Ji),e.forEach((e=>this._restoreLineToolFactoryDefaults(e))),this.endUndoMacro())}restoreState(e,t,i){return this.m_model.restoreState(e,t,i)}async clipboardCopy(e,t=this.selection().dataSources()){if(!(0,y.enabled)("datasource_copypaste"))return;const i=t.filter((e=>e.copiable()));if(0===i.length)return;for(const e of i)if((0,w.isStudy)(e)&&e.isChildStudy())throw new Error("Can not copy child study");const s=(0,g.clipboardDataForSources)(this._model().id(),i);return null!==s?e.write({app:JSON.stringify(s),text:s.title}):void 0}async clipboardCut(e,t=this.selection().dataSources()){if(!(0,y.enabled)("datasource_copypaste"))return;const i=t.filter((e=>e.copiable()));if(0===i.length)return;await this.clipboardCopy(e,i);const s=i.filter((e=>e.isUserDeletable()));if(0===s.length)return;const r=(1===s.length?Ui:Gi).format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,s[0])});this.beginUndoMacro(r),this.m_model.selectionMacro((()=>this.removeSources(s,!1,r)),!0),this.endUndoMacro()}async clipboardPaste(e,t){let i=null;if((0,y.enabled)("datasource_copypaste")&&(i=i||await e.read(),i.app)){const e=JSON.parse(i.app);if(null!==await this.pasteSourceFromClip(t,e))return}await this._processSpecialLineToolsContents(e,i,t)}applyStudyTemplate(e,t){const i=new pt(this._model(),e,t);this._pushUndoCommand(i),(0,Oi.emit)("load_study_template")}createStudyInserter(e,t,i){const s={createStudy:(e,t,i,s,r,o,n,a,l,c,h)=>this.checkIfFeatureAvailable(e,o)?((0,f.trackEvent)("studies","Study_"+e.id),"Compare@tv-basicstudies"===e.id&&(0,f.trackEvent)("compare","symbol:"+t.symbol),this._insertStudy(e,t,s,r,o,n,a,l,c,null,h)):(Is.logNormal("Cannot insert study "+e.id),null)};void 0!==i&&(s.createStub=()=>this.m_model.insertStudyStub(i).id(),s.removeStub=e=>this.m_model.removeStudyStub(e));const r=new Vi.StudyInserter(e,this.m_model.studyMetaInfoRepository(),s);return r.setParentSources(t),r}replayStatus(){return this.m_model.replayStatus()}setReplayStatus(e){return this.m_model.setReplayStatus(e)}startCustomMoving(e,t,i){this._currentCustomMoveCommand=new Bt(this.model(),e,t,i)}customMoveBeingProcessed(){return null!==this._currentCustomMoveCommand}processCustomMove(e){(0,n.ensureNotNull)(this._currentCustomMoveCommand).move(e)}endCustomMoving(){null!==this._currentCustomMoveCommand&&this._currentCustomMoveCommand.hasChanges()&&(this._pushUndoCommand(this._currentCustomMoveCommand),this._currentCustomMoveCommand=null)}panes(){return this.m_model.panes()}cloneLineTools(e,t){for(let t=0;t<Math.min(5,e.length);++t)(0,Ee.trackDrawingCloned)(e[t]);this.beginUndoMacro(is,ks);const i=new U(this._model(),e,t,is);this._pushUndoCommand(i);const s=i.newIds().map((e=>(0,n.ensureNotNull)(this.model().dataSourceForId(e)))).filter((e=>0!==e.sharingMode().value()));return s.length&&this._model().copyToOtherCharts(s,!0),this.endUndoMacro(),this.emitEvent("cloneLineTools"),i.newIds()}removeSource(e,t,i){
this.lineBeingCreated()!==e?this.removeSources([e],t,qi.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e)}),i):this.cancelCreatingLine()}removeSelectedSources(){const e=this._model().selection().dataSources();if(!e.length)return;const t=(e.length>1?ji:qi).format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e[0])});this.removeSources(e,!1,t)}removeSources(e,t,i,s){s||(e=e.filter((e=>e.isUserDeletable())));const r=this._model(),o=r.lineToolsGroupModel(),a=e.every(S.isLineTool)&&ks;this.beginUndoMacro(i,a),r.selectionMacro((s=>{const a=new Map;e.forEach((e=>{if((0,S.isLineTool)(e)){const t=o.groupForLineTool(e);if(null!==t){const i=a.get(t)||[];i.push(e),a.set(t,i)}null!==e.linkKey().value()&&(0,Xe.removeLineTool)({withUndo:!0,model:this.model(),linkKey:(0,n.ensureNotNull)(e.linkKey().value()),symbol:this.model().mainSeries().symbol(),lineToolState:e.state(!1),sourceTitle:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e)})}}));const l=new G.RemoveSourcesUndoCommand(r,e,i),c=l.removedIds();this._pushUndoCommand(l),!t&&c.length>0&&(1===c.length?this.emitEvent("removeSource",[c[0]]):this.emitEvent("removeSources",[c]))}),!0),this.endUndoMacro()}removeUnloadedLineTool({sourceTitle:e,linkKey:t,symbol:i,state:s,withUndo:r,unlink:o}){const n=new Xt({undoText:qi.format({title:e}),chartModel:this._model(),linkKey:t,symbol:i,state:s,unlink:o});r?this._pushUndoCommand(n):n.redo()}async scrollToLineTool(e){const t=this.timeScale().logicalRange();if(null===t)return;const i=this.timeScale().barSpacing();let s=t.left();const r=e.points().map((e=>e.index)),o=this.timeScale().points().range().value();if(null===o)return;let a=o.firstIndex;const l=o.lastIndex,h=t.length()/2;if(0===r.length||r.some((e=>t.contains(e))))return;const d=()=>{const t=e.points().map((e=>e.index)),i=t.filter((e=>e<=l)).reduce(((e,t)=>null===e?t:Math.max(e,t)),null);return null!==i?i:t.reduce(((e,t)=>Math.min(e,t)))};let u,_=d();if(a-h>_){const t=e.points().map((e=>e.time)).filter(O.notUndefined).map((e=>e.valueOf()));if(0===t.length)return;const i=t.reduce(((e,t)=>Math.min(e,t)),t[0]);await this.model().gotoTime(i),_=d();const r=(0,n.ensureNotNull)(this.timeScale().logicalRange());if(r.contains(_))return;s=r.left(),a=(0,n.ensureNotNull)(this.timeScale().points().range().value()).firstIndex}a-h>_?(u=(s-a+h)*i,this.mainSeries().setGotoDateResult({timestamp:(0,n.ensureNotNull)(this.timeScale().points().valueAt(a)),eod:!0})):u=(s-_+1+h)*i,this.startScrollTime(0),(0,v.doAnimate)({onStep:(e,t)=>this.scrollTimeTo(t),from:0,to:Math.round(u),easing:c.easingFunc.easeInOutCubic,duration:c.dur,onComplete:()=>this.endScrollTime()})}mergeSourceUp(e){const t=new J(this._model(),e,ss);this._mergeUnmergeSource(e,t)}mergeSourceDown(e){const t=new ee(this._model(),e,rs);this._mergeUnmergeSource(e,t)}mergeToPane(e,t,i){const s=this._model().panes().indexOf(t),r=new te(this._model(),e,s,os,i);this._mergeUnmergeSource(e,r)}unmergeSourceUp(e){const t=new $(this._model(),e,ns)
;this._mergeUnmergeSource(e,t)}unmergeSourceDown(e){const t=new X(this._model(),e,as);this._mergeUnmergeSource(e,t)}unmergeToNewBottomPane(e){const t=new Z(this._model(),e,ls);this._mergeUnmergeSource(e,t)}availableZOrderOperations(e){const t=this._model().lineToolsGroupModel(),i=e.filter(S.isLineTool),s=i.map((e=>t.groupForLineTool(e)));(0,n.assert)(new Set(s).size<=1,"Cannot move line tools from different group");const r=0===s.length?null:s[0];let o={bringForwardEnabled:!1,bringToFrontEnabled:!1,sendBackwardEnabled:!1,sendToBackEnabled:!1};const a=new Set(i);for(const t of(0,ie.sortSources)(e)){if((0,S.isLineTool)(t)&&null!==r){const e=(0,ie.sortSources)(r.lineTools().filter((e=>!a.has(e)||e===t)));o=As(o,{bringForwardEnabled:t!==e[e.length-1],bringToFrontEnabled:t!==e[e.length-1],sendBackwardEnabled:t!==e[0],sendToBackEnabled:t!==e[0]});continue}const e=(0,n.ensureNotNull)(this._model().paneForSource(t)).sourcesByGroup().allExceptSpecialSources();if(0===e.length)continue;const i=t.zorder(),s=e[0].zorder(),l=e[e.length-1].zorder();o=As(o,{bringForwardEnabled:i!==l,bringToFrontEnabled:i!==l,sendBackwardEnabled:i!==s,sendToBackEnabled:i!==s})}return o}sendToBack(e){if(!this.availableZOrderOperations(e).sendToBackEnabled)throw new Error("Send to back operation is unavailable");let t=null;const i=e[0];if((0,S.isLineTool)(i)){const s=this._model().lineToolsGroupModel().groupForLineTool(i);if(null!==s){const i=s.lineTools();t=new ye(this.model(),(0,ie.sortSources)(e),i[0])}}null===t&&(t=new Se(this.model(),(0,ie.sortSources)(e))),this._pushUndoCommand(t),this.emitEvent("changeZOrder",[e])}bringToFront(e){if(!this.availableZOrderOperations(e).bringToFrontEnabled)throw new Error("Bring to front operation is unavailable");let t=null;const i=e[0];if((0,S.isLineTool)(i)){const s=this._model().lineToolsGroupModel().groupForLineTool(i);if(null!==s){const i=s.lineTools();t=new fe(this.model(),(0,ie.sortSources)(e),i[i.length-1])}}null===t&&(t=new ge(this.model(),(0,ie.sortSources)(e))),this._pushUndoCommand(t),this.emitEvent("changeZOrder",[e])}sendBackward(e){if(!this.availableZOrderOperations(e).sendBackwardEnabled)throw new Error("Send backward operation is unavailable");const t=Fi.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e[0])});this._sendBackOrBringForward(t,(0,ie.sortSources)(e),((e,t)=>new we(this.model(),e,t)))}bringForward(e){if(!this.availableZOrderOperations(e).bringForwardEnabled)throw new Error("Bring forward operation is unavailable");const t=Wi.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e[0])});this._sendBackOrBringForward(t,(0,ie.sortSources)(e),((e,t)=>new Te(this.model(),e,t)))}insertAfter(e,t){e=(0,ie.sortSources)(e);const i=zi.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e[0]),target:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,t)});this._insertAfterOrBefore(i,e,t,(()=>new fe(this.model(),e,t)))}insertBefore(e,t){e=(0,ie.sortSources)(e);const i=Hi.format({title:(0,
se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e[0]),target:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,t)});this._insertAfterOrBefore(i,e,t,(()=>new ye(this.model(),e,t)))}detachToRight(e,t){(0,f.trackEvent)("Chart","Move to new right scale");const i=cs.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e)}),s=new Ct(this.model(),e,t,"right",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}detachToLeft(e,t){(0,f.trackEvent)("Chart","Move to new left scale");const i=hs.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e)}),s=new Ct(this.model(),e,t,"left",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}detachNoScale(e,t){(0,f.trackEvent)("Chart","Make source no scale");const i=ds.format({title:(0,se.getTranslatedStringForSource)(oe.TitleDisplayTarget.StatusLine,e)}),s=new Ct(this.model(),e,t,"overlay",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}moveToScale(e,t,i,s,r){(0,f.trackEvent)("Chart","Move source to target scale"),this.beginUndoMacro(s);const o=new wt(this.model(),e,t,i,s),n=r?null:(0,b.sourceNewCurrencyOnPinningToPriceScale)(e,i,this._model()),a=r?null:(0,Ht.sourceNewUnitOnPinningToPriceScale)(e,i,this._model());this._pushUndoCommand(o),null!==n&&this.setPriceScaleCurrency(i,n),null!==a&&this.setPriceScaleUnit(i,a),this.endUndoMacro(),this.emitEvent("moveSource",[e])}setLinkingGroupIndex(e){this._undoHistory.beginUndoMacro(Ms),this._pushUndoCommand(new Ni(this.model().linkingGroupIndex(),e,Ms)),this._model().setShouldBeSavedEvenIfHidden(!0),this._undoHistory.endUndoMacro()}startScrollTime(e){const t=this.timeScale();this._initialTimeScrollState={rightOffset:t.rightOffset(),barSpacing:t.barSpacing()},this._initialTimeScrollPos=e,this.model().startScrollTime(e)}scrollTimeTo(e){null!==this._initialTimeScrollPos&&null!==this._initialTimeScrollState&&Math.abs(e-this._initialTimeScrollPos)>20&&(this._pushUndoCommand(new Ae.TimeScaleChangeUndoCommand(this.model(),this._initialTimeScrollState,us)),this._initialTimeScrollPos=null,this._initialTimeScrollState=null),this.model().scrollTimeTo(e)}endScrollTime(){this.model().endScrollTime(),this._initialTimeScrollPos=null,this._initialTimeScrollState=null}startScaleTime(e){this.changeTimeScale(_s),this.model().startScaleTime(e)}scaleTimeTo(e){this.model().scaleTimeTo(e)}endScaleTime(){this.model().endScaleTime()}resetTimeScale(){this.changeTimeScale(ps),this.model().resetTimeScale()}changeTimeScale(e){const t=this.timeScale(),i={rightOffset:t.rightOffset(),barSpacing:t.barSpacing()};this._pushUndoCommand(new Ae.TimeScaleChangeUndoCommand(this.model(),i,e))}startScalePrice(e,t,i,s){this._scalePriceInfo={priceScaleState:t.state(),tryMergeConsecutiveScales:s},this.model().startScalePrice(e,t,i)}scalePriceTo(e,t,i){this.model().scalePriceTo(e,t,i)}endScalePrice(e,t){this.model().endScalePrice(e,t);const i=(0,n.ensureNotNull)(this._scalePriceInfo);(0,
o.default)(i.priceScaleState,t.state())||this._pushUndoCommand(new Ut.PriceScaleChangeUndoCommand(this.model(),e,t,i.priceScaleState,i.tryMergeConsecutiveScales)),this._scalePriceInfo=null}startTwoPointsScalePrice(e,t,i,s,r){this._scalePriceInfo={priceScaleState:t.state(),tryMergeConsecutiveScales:r},this.model().startTwoPointsScalePrice(e,t,i,s)}twoPointsScalePriceTo(e,t,i,s){this.model().twoPointsScalePriceTo(e,t,i,s)}endTwoPointsScalePrice(e,t){this.model().endTwoPointsScalePrice(e,t);const i=(0,n.ensureNotNull)(this._scalePriceInfo);(0,o.default)(i.priceScaleState,t.state())||this._pushUndoCommand(new Ut.PriceScaleChangeUndoCommand(this.model(),e,t,i.priceScaleState,i.tryMergeConsecutiveScales)),this._scalePriceInfo=null}resetPriceScale(e,t){const i=t.state();this.model().resetPriceScale(e,t),(0,o.default)(i,t.state())||this._pushUndoCommand(new Ut.PriceScaleChangeUndoCommand(this.m_model,e,t,i))}rearrangePanes(e,t){const i=new ke(this._model(),e,t);this._pushUndoCommand(i)}movePane(e,t){const i=new ke(this._model(),e,t);this._pushUndoCommand(i)}toggleCollapsedPane(e){const t=this.panes().findIndex((t=>t===e));t<0||this._pushUndoCommand(new x(this._model(),t))}readOnly(){return this.m_model.readOnly()}checkIfFeatureAvailable(e,t){var i;let s=this.canCreateStudy();const r=t.length>0;if(!this.readOnly()&&r&&(s=this.canCreateStudy(!0)),!s)return r?(0,A.createGoProDialog)({feature:"studyOnStudy",actions:window.user.pro_plan&&[B.ExpertPlans.PremiumExpert,B.ExpertPlans.PremiumExpert+R.TRIAL_SUFFIX].includes(window.user.pro_plan)?[{text:xs,action:N.PredefinedAction.Close}]:void 0}):(0,h.showTooManyStudiesNotice)(),!1;if(!this._isCountedStudy(e))return!0;const o=this.m_model.listUserStudies({dontCountVolume:!0,dontCountOverlay:!0,dontCountCompare:!0}),a=(0,k.enabled)(L.ProductFeatures.INDICATORS_ON_CHART)?(0,n.ensure)(null===(i=(0,k.getConfig)(L.ProductFeatures.INDICATORS_ON_CHART))||void 0===i?void 0:i.limit):1/0;return o.length<a||((0,D.onWidget)()?(0,V.showGoToTradingViewReferralDialog)({feature:"indicators"}):((0,E.trackGoProFeature)("studyLimit"),(0,A.createGoProDialog)({feature:"studyLimit",customParams:o,actions:window.user.pro_plan&&[B.ExpertPlans.PremiumExpert,B.ExpertPlans.PremiumExpert+R.TRIAL_SUFFIX].includes(window.user.pro_plan)?[{text:xs,action:N.PredefinedAction.Close}]:void 0})),!1)}async pasteSourceFromClip(e,t,i){const s=t;if(!s||0===s.sources.length)return null;const r=e||(0,n.ensureNotNull)(this.model().paneForSource(this.mainSeries()));if(!s.sources.some((e=>"drawing"!==e.type||null!==r.clipboardLineToolOwnerSource(e.source.id))))return null;const o=Array.from(new Set(s.sources.filter(g.isLineToolClipboardData).map((e=>e.source.type))));await Promise.all(o.map((e=>(0,S.initLineTool)(e)))),this.beginUndoMacro(vs.format({title:s.title}));let a=0;const l=[],c=[];for(const t of s.sources)if("drawing"===t.type&&null!==r.clipboardLineToolOwnerSource(t.source.id)){const e=this.pasteLineTool(r,t);a<5&&((0,Ee.trackDrawingPasted)(e),a+=1),c.push(e),l.push(e)
}else"study"===t.type&&t.source&&t.source.metaInfo&&this.checkIfFeatureAvailable(new d.StudyMetaInfo(t.source.metaInfo),[])&&l.push(this.pasteStudy(t,i?e:void 0));return c.length&&this.selectionMacro((e=>{e.clearSelection(),c.forEach((t=>{e.addSourceToSelection(t,null)}))})),this.endUndoMacro(),l}pasteLineTool(e,t,i,s){t.source.state.intervalsVisibilities=(0,hi.mergeIntervalVisibilitiesDefaults)(t.source.state.intervalsVisibilities),(0,hi.makeIntervalsVisibilitiesVisibleAtInterval)(t.source.state.intervalsVisibilities,_.Interval.parse(this.model().mainSeries().interval()));const r=new vt(this.model(),t,e,i,s);this._pushUndoCommand(r);const o=r.source();return r.needCopyToOtherCharts()&&this._model().copyToOtherCharts([o],!0),this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(o,null)})),o}pasteStudy(e,t){const i=new kt(this.model(),e,null==t?void 0:t.id());this._pushUndoCommand(i);const s=(0,n.ensureNotNull)(i.state()).id;return(0,Oi.emit)("study_event",s,"paste_study"),(0,n.ensureNotNull)(this._model().dataSourceForId(s))}setPriceScaleCurrency(e,t){const i=new ft(e,t,this.chartWidget(),es);this._pushUndoCommand(i)}setPriceScaleUnit(e,t){const i=new bt(e,t,this.chartWidget(),ts);this._pushUndoCommand(i)}setSymbol(e,t){e.symbol()!==t&&this._pushUndoCommand(new xt(e,t,this.chartWidget()))}setResolution(e,t){e===this.mainSeries()&&(t=e.getSupportedResolution(t)),_.Interval.isEqual(e.interval(),t)||this._pushUndoCommand(new Bi(e,t,this.chartWidget()))}chartLoadTheme(e,t,i){const s=new Ei(this.model(),e,t);i?s.redo():this._pushUndoCommand(s)}isJustClonedChart(){return this._chartWidget.isJustClonedChart()}isMultipleLayout(){return this._chartWidget.isMultipleLayout()}addPaneStretchFactorUndoCommand(e,t,i,s){const r=new At(this.model(),e,t,i,s);this._pushUndoCommand(r)}paneForSource(e){return this.m_model.paneForSource(e)}destroy(){this.m_model.destroy()}moveSelectedToolsLeft(){return this._moveSelectedTools(2)}moveSelectedToolsUp(){return this._moveSelectedTools(0)}moveSelectedToolsRight(){return this._moveSelectedTools(3)}moveSelectedToolsDown(){return this._moveSelectedTools(1)}insertStudyWithoutCheck(e,t,i,s){return this._insertStudy(e,t,{},!1,[],void 0,void 0,void 0,void 0,null!=i?i:null,void 0,s)}saveLineToolState(e,t){this._pushUndoCommand(new j(this.m_model,[e],t))}resetScales(){this._model().stopTimeScaleAnimation(),this.beginUndoMacro(ms),this.resetTimeScale();for(const e of this.m_model.panes()){for(const t of e.leftPriceScales())this.resetPriceScale(e,t);for(const t of e.rightPriceScales())this.resetPriceScale(e,t)}this.endUndoMacro(),this.m_model.recalculateAllPanes((0,Ve.viewportChangeEvent)())}shareLineTools(e,t){const i=0===t?ws:1===t?Ps:Ts;this.withMacro(i,(()=>{0===t&&this.unlinkLines(e),e.forEach((i=>{const s=this.model().lineToolsGroupModel().groupForLineTool(i);if(s){s.lineTools().every((t=>e.includes(t)))||this.lineToolsGroupController().excludeLineToolFromGroup(s,i)}this.undoHistory().pushUndoCommand(new Ze(i,t,this.model(),null))}))}),!0)}canCreateStudy(e){
return this.model().chartApi().canCreateStudy(e)}studiesMetaData(){return this.m_model.studiesMetaData()}fullSourceId(e){return this._chartWidget.fullSourceId(e)}chartWidgetCollectionLock(){return this._chartWidget.chartWidgetCollection().lock}_isCountedStudy(e){return!["Volume@tv-basicstudies","Compare@tv-basicstudies","Overlay@tv-basicstudies"].includes(e.id)&&!(0,Zt.isFundamentalStudyMetaInfo)(e)}_mergeUnmergeSource(e,t){this.beginUndoMacro(t.text());const i=(0,n.ensureNotNull)(this._model().paneForSource(e)),s=new Set(i.sourcesByGroup().lineSources().filter((t=>t.ownerSource()===e)));this._model().lineToolsGroupModel().groups().filter((e=>{const t=e.lineTools().some((e=>s.has(e))),i=e.lineTools().some((e=>!s.has(e)));return t&&i})).forEach((e=>{this._pushUndoCommand(new q.ExcludeLineToolsFromGroupUndoCommand(this._model(),e,e.lineTools()))})),this._pushUndoCommand(t),this.endUndoMacro()}_insertStudy(e,t,i,s,r,o,a,l,c,h,d,u){const _=fs.format({title:e.description});this.beginUndoMacro(_);const p=new Vt(this.model(),e,t,i,s,r,o,a,l,c,h||null,u,_);this._pushUndoCommand(p);const m=p.insertedStudy();if(void 0!==d){const e=new Ot.SetPriceScaleModeCommand(d,(0,n.ensureNotNull)(m.priceScale()),null,this.model());this._pushUndoCommand(e)}return this.endUndoMacro(),{study:m,startPromise:p.lastInsertionStartPromise()}}async _processSpecialLineToolsContents(e,t,i){if(t=t||await e.read(),window.user.id&&t.files){const e=Array.from(t.files).find(Yt.blobImageFilter);if(e){const t=URL.createObjectURL(e),s=(0,Yt.uploadImage)(e);return void 0===i&&(i=(0,n.ensureNotNull)(this._model().paneForSource(this.mainSeries()))),this.pasteImageAsLineTool(s,t,i),void await s}}t.text&&(window.user.id&&!Ls&&(0,Gt.isTwitterUrl)(t.text)?(0,Gt.createTweetLineToolByUrl)(t.text,this,!0):window.user.id&&(0,$t.isIdeaUrl)(t.text)?(0,$t.createIdeaLineToolByUrl)(t.text,this,!0):function(e,t){if(null===t.timeScale().logicalRange())return null;const i=t.mainSeries(),s=i.priceScale(),r=t.timeScale(),o=(0,n.ensureNotNull)(t.model().paneForSource(i)),a=(0,n.ensureNotNull)((0,n.ensureNotNull)(s.mainSource()).firstValue()),l=r.coordinateToIndex(t.timeScale().width()/2),c=o.height()/2,h={price:s.coordinateToPrice(c,a),time_t:(0,n.ensureNotNull)(r.indexToTimePoint(l)),offset:0},d=o.newLineToolZOrder(!0),u=jt.LineToolText.createProperties().state();u.text=e;const _={type:"drawing",source:{id:(0,$e.randomHashN)(6),zorder:d,type:"LineToolText",state:{interval:i.interval(),...u},symbol:i.symbol(),ownerSource:i.id(),points:[h]},geometry:[],modelId:t.model().id(),centeredOnChart:!0},p=t.pasteLineTool(o,_,!1,!1);qt.setValue("hint.pasteText",!0,{forceFlush:!0})}(t.text,this))}_insertAfterOrBefore(e,t,i,s){const r=(0,n.ensureNotNull)(this._model().paneForSource(i));if(t.some((e=>(0,S.isLineTool)(e)&&this._model().paneForSource(e)!==r)))throw new Error("Cannot insert line tool after target on another pane");this.beginUndoMacro(e),t.forEach((e=>{(0,n.ensureNotNull)(this.model().paneForSource(e))!==r&&this.mergeToPane(e,r)}));const o=s();this._pushUndoCommand(o),
this.emitEvent("changeZOrder",[t]),this.endUndoMacro()}_sendBackOrBringForward(e,t,i){const s=new Map;t.forEach((e=>{const t=(0,n.ensureNotNull)(this._model().paneForSource(e)),i=s.get(t)||[];i.push(e),s.set(t,i)})),this.beginUndoMacro(e),s.forEach(((e,t)=>{this._pushUndoCommand(i(t,e))})),this.endUndoMacro(),this.emitEvent("changeZOrder",[t])}_moveSelectedTools(e){const t=this.model().selection().lineDataSources();if(0===t.length)return!1;if((0,Xe.lockDrawings)().value())return!0;const i=this.timeScale().visibleBarsStrictRange();if(null===i)return!1;const s=function(e){const t=new Map;for(const i of e){const e=i.ownerSource();if(null===e)continue;let s=t.get(e);if(void 0===s){const r=e.priceScale(),o=e.priceStep(),n=e.firstValue();if(null===r||null===o||null===n)continue;if(null===r.priceRange())continue;s={sources:[],priceScale:r,priceStep:o,startPrice:i.points()[0].price,firstValue:n},t.set(e,s)}s.sources.push(i)}return t}(t);if(0===s.size)return!1;this.beginUndoMacro(Zi,ks);const r=i.firstBar(),o=this.timeScale().indexToCoordinate(r),n=r+(3===e?1:2===e?-1:0),l=this.timeScale().indexToCoordinate(n);return Xe.isDirectionalMovementActive.setValue(!0),s.forEach((t=>{const{startPrice:i,priceStep:s,priceScale:c,firstValue:h}=t,d=i+(0===e?s:1===e?-s:0),u=c.priceToCoordinate(i,h),_=c.priceToCoordinate(d,h),p={logical:{index:r,price:i},screen:new a.Point(o,u)},m={logical:{index:n,price:d},screen:new a.Point(l,_)};this.startMovingSources(t.sources,p,null),this.moveSources(m),this.endMovingSource(!1,!0)})),Xe.isDirectionalMovementActive.setValue(!1),this.endUndoMacro(),!0}_restoreStudyFactoryDefaults(e){const t=new ci(this.m_model,e.properties());this._pushUndoCommand(t)}_restoreLineToolFactoryDefaults(e){this.beginUndoMacro(Qi,ks),this.saveLineToolState(e,Qi);const t=new li(this.m_model,e.properties(),Qi);this._pushUndoCommand(t),this.saveLineToolState(e,Qi),this.endUndoMacro(),this.model().updateSource(e)}_removeAllDrawingToolsImpl(e){this.selectionMacro((()=>{this.lineBeingCreated()&&this.cancelCreatingLine();this.dataSources().filter(S.isLineTool).filter((e=>e.isActualSymbol()&&e.isUserDeletable())).filter((t=>!e||e===t.toolname)).forEach((e=>this.removeSource(e,!1)))}),!0)}_removeAllStudiesImpl(){const e=this.dataSources(),t=e.filter(w.isStudy).filter((e=>!e.isChildStudy()&&e.removeByRemoveAllStudies())),i=e.filter(w.isStudyStub);t.concat(i).forEach((e=>this.removeSource(e,!1)))}}},627492:(e,t,i)=>{"use strict";i.d(t,{ChartEvents:()=>m});var s=i(316230),r=i(650151),o=i(120780),n=i(501867),a=i(175203),l=i(201089),c=i(707957),h=i(483307);const d=(0,l.getLogger)("ReutersCalendar");function u(e){return new Date(e).toISOString()}function _(e){return e.forEach((e=>{e.timestamp=Date.parse(e.date)})),e}function p(e,t,i,o){var n;const a=[],l=[];let c=0,h=0;const d=[],u={},_=new Set;for(t.length>0&&e.forEach((e=>_.add(e.id)));(h<e.length||c<t.length)&&d.length<=o;){const o=h<e.length?e[h]:null,p=c<t.length?t[c]:null
;if(null!==p&&_.has(p.id))c+=1;else if(null!==o&&o.timestamp>=(null!==(n=null==p?void 0:p.timestamp)&&void 0!==n?n:-1/0)){const e=i[o.id];e?(0,s.default)(e,o)||l.push(e):a.push(o),d.push(o),u[o.id]=o,h+=1}else{const e=(0,r.ensureNotNull)(p);d.push(e),u[e.id]=e,c+=1}}return{itemsById:u,mergedItems:d,addedItems:a,changedItems:l}}class m{constructor(e,t,i){if(this.changed=new c.Delegate,this._pendingRequestMoreResult=null,this._pushstreamHandler=e=>{const t=this._mergeItems(_([].concat(e)).sort(((e,t)=>t.timestamp-e.timestamp)));(t.changed.length||t.added.length)&&this.changed.fire(t)},!(this instanceof m))throw new Error("ChartEvents is a constructor");this._useEconomicCalendarUrl=Boolean(t),this._keepCurrenciesFilter=Boolean(i),this._pushstream=t?"economic-calendar":"chartevents-reuters",this._url=t?window.ECONOMIC_CALENDAR_URL+"events":window.CHARTEVENTS_URL?window.CHARTEVENTS_URL+"events":"/chartevents/",this.reset(e),n.pushStreamMultiplexer.on(this._pushstream,this._pushstreamHandler)}get defaultSelectionTimeAmount(){return 6048e5}items(){return this._filter?this._filter(this._items):this._items}reset(e){var t,i;null===(t=this._pendingRequestMoreResult)||void 0===t||t.abort(),this._pendingRequestMoreResult=null,this._items=[],this._itemsById={},this.minObtainedTimestamp=1/0,this._noResults=!1,e&&null!=e.from?this.from=Number(e.from):this.from=Date.now()-864e5,this._historyLimit=e&&e.historyLimit,this._maxItems=1/0,e&&void 0!==e.maxItems&&e.maxItems>0&&(this._maxItems=+e.maxItems),e&&null!=e.to?this.to=e.to:this.to=this.from+this.defaultSelectionTimeAmount,this.from=this.cacheFriendlyTimestamp(this.from),this.to=this.cacheFriendlyTimestamp(this.to),this._filter=e?e.filter:void 0,this.currenciesFilter=null!==(i=null==e?void 0:e.currencyFilter)&&void 0!==i?i:[],this._useEconomicCalendarUrl&&this._keepCurrenciesFilter||(this.countriesFilter=e&&e.currencyFilter?(0,h.convertCurrenciesToCountryCodes)(e.currencyFilter,!this._useEconomicCalendarUrl):[]),e&&void 0!==e.minImportance&&isFinite(+e.minImportance)?this.minImportance=Math.max(-1,Math.min(1,Math.floor(e.minImportance))):this.minImportance=-1}cacheFriendlyTimestamp(e){return e-e%36e5}requestMore(e){var t;if(this._pendingRequestMoreResult&&!this._pendingRequestMoreResult.ready)return this._pendingRequestMoreResult.promise;if(isFinite(this.minObtainedTimestamp)&&void 0!==this._historyLimit&&Number(new Date(this.from))<this._historyLimit&&(this._noResults=!0),this._items.length>=this._maxItems&&(this._noResults=!0),this._noResults)return Promise.resolve({added:[],changed:[],noResults:!0});const i=new URL(this._url);-1!==this.minImportance&&i.searchParams.set("minImportance",this.minImportance.toString()),isFinite(this.minObtainedTimestamp)&&(this.to=this.from,this.from=this.from-this.defaultSelectionTimeAmount),e&&e.from&&e.from<this.minObtainedTimestamp&&(this.from=this.cacheFriendlyTimestamp(e.from)),i.searchParams.set("from",u(this.from)),i.searchParams.set("to",u(this.to)),
(null===(t=this.countriesFilter)||void 0===t?void 0:t.length)?i.searchParams.set("countries",this.countriesFilter.toString().toUpperCase()):this.currenciesFilter.length&&i.searchParams.set("currencies",this.currenciesFilter.toString().toUpperCase());const s=new AbortController,r=this._requestDataImpl(i,s.signal),o={promise:r,ready:!1,abort:()=>s.abort()};return r.then((e=>{o.ready=!0,this.changed.fire(e)})).catch((e=>{var t;o.ready=!0,t=e,d.logWarn(`An error ocurred while loading economic events: ${t}`)})),this._pendingRequestMoreResult=o,r}destroy(){n.pushStreamMultiplexer.off(this._pushstream,this._pushstreamHandler),this._items=[],this.reset()}_mergeItems(e){const t=this._noResults,i=new Set(this.currenciesFilter),s=new Set(this.countriesFilter),r=e.filter((e=>{var t;return(-1===this.minImportance||this.minImportance<=(null!==(t=e.importance)&&void 0!==t?t:1/0))&&(0===i.size||i.has(e.currency.toUpperCase()))&&(0===s.size||s.has(e.country.toLowerCase()))&&(void 0===this._historyLimit||e.timestamp>=this._historyLimit)})),{itemsById:o,mergedItems:n,addedItems:a,changedItems:l}=p(r,this._items,this._itemsById,this._maxItems);return this._items=n,this._itemsById=o,{added:a,changed:l,noResults:t}}async _requestDataImpl(e,t,i){let s=await this._requestOneChunk(e,t),r=s.items,o=s.noData;for(;2e3===s.items.length;){const i=new Date(r[0].date);e.searchParams.set("from",u(i.getTime()+1)),s=await this._requestOneChunk(e,t),r=p(s.items,r,{},1/0).mergedItems,o=o||s.noData}return this.minObtainedTimestamp=this.from,o&&(this._noResults=!0,this.minObtainedTimestamp=-1/0),this._mergeItems(r)}async _requestOneChunk(e,t){var i;const s=Date.now(),r=await(0,o.fetch)(e.toString(),{headers:{accept:"application/json"},signal:t}),n=Date.now()-s;if(a.telemetry.sendReport("calendars","chartevents_http_status",{value:r.status,additional:{source:"ChartEvents"}}),a.telemetry.sendReport("calendars","chartevents_response_time_frame",{value:n,additional:{source:"ChartEvents"}}),!r.ok)throw new Error(`Request ${e.toString()}, status: ${r.status}, status text: ${r.statusText}`);const l=await r.json();if(!l||!l.status||"error"===l.status)throw a.telemetry.sendReport("calendars","chartevents_error"),new Error(l&&l.errmsg||"invalid response");a.telemetry.sendReport("calendars","chartevents_ok");return{items:_(null!==(i=l.result)&&void 0!==i?i:[]).reverse(),noData:"no_data"===l.status}}}},244098:(e,t,i)=>{"use strict";i.d(t,{EUR_CURRENCY:()=>s,defaultCurrencies:()=>r});const s="EUR",r=["USD",s,"ITL","NZD","CHF","AUD","FRF","JPY","ZAR","TRL","CAD","DEM","MXN","ESP","GBP"]},607113:(e,t,i)=>{"use strict";var s=i(650151).assert,r=i(553406).ChartModelBase,o=i(713473).isLineTool,n=i(767359).Watermark,a=i(638456).CheckMobile,l=i(877009).InvalidationMask,c=i(877009).InvalidationLevel;i(707957).Delegate;const{globalChangeEvent:h,sourceChangeEvent:d}=i(964824)
;var u=i(161488),_=u.isStudy,p=u.isFundamentalStudy,m=i(885482),g=i(220843).MainSeriesScaleRatioProperty,S=i(915179).scaleRatio,v=i(849245).StudyInserter,f=i(992543).dateFormatProperty,b=i(827023).timeHoursFormatProperty,y=i(251954),C=i(65541).StudyColorRotatorFactory,w=i(244842),P=i(108039).AppliedTimeFrame,T=i(74439).ReplayStatus,M=w.enabled("fix_left_edge");class x extends r{constructor(e,t,i,s,r,o,a,l,c,h,d){super(e,t,i,s,r,o,a,l,c,h,d);var u=this;this._mainSeriesScaleRatioProperty=new g(this),this.m_mainSeries.dataEvents().completed().subscribe(this,function(){if(this._scrollingState&&this.gotoTime(),M&&!this.m_mainSeries.requestMoreDataAvailable()){var e=this.m_mainSeries.bars().first();null!==e&&this._timeScale.setLeftEdgeFix(e.index)}}.bind(this)),this.m_mainSeries.onIntervalChanged().subscribe(this,(function(){this._recalcVRStudiesParams.oldStartVisibleIndex=NaN,this._recalcVRStudiesParams.oldEndVisibleIndex=NaN})),this.m_mainSeries.dataEvents().barReceived().subscribe(this,x.prototype.updateTimeScaleBaseIndex),this._readOnly||(this.m_mainSeries.properties().addChild("priceAxisProperties",this.m_mainSeries.priceScale().properties()),this._properties.paneProperties.legendProperties.showStudyTitles.listeners().subscribe(this,(function(e){e.value()||u._properties.paneProperties.legendProperties.showStudyArguments.setValue(!1)}))),this._watermarkSource=this._options.watermarkEnabled?new n(this,this.m_mainSeries):null,m.hideAllDrawings().subscribe(this,this._onDrawingsVisibilityChanged),m.hideAllIndicators().subscribe(this,this._onIndicatorsVisibilityChanged),this._properties.scalesProperties.listeners().subscribe(this,x.prototype.fullUpdate),this._studyShiftColorStartOffset=void 0,f.subscribe(this,this._updateDateTimeFormatter),b.subscribe(this,this._updateDateTimeFormatter),this.mainSeries().properties().interval.subscribe(this,this._updateDateTimeFormatter),this._updateDateTimeFormatter(),this._studyColorRotatorFactory=new C(this),this._createLollipopSourcesWatcher(),this._undoModel._chartWidget.onWidget()||this._initAlertsList(),this._dataSourceCollectionChanged.subscribe(this,this._updateShowLegendProperty.bind(this)),this._properties.paneProperties.legendProperties.showLegend.subscribe(this,this._updateShowLegendProperty),this._appliedTimeFrame=new P(this),this.mainSeries().onTimeFrameApplied().subscribe(this,(function(e){var t=null!==e?{res:this.mainSeries().interval(),val:e}:null;this.appliedTimeFrame().setValue(t)}))}applyPreferences(e){for(var t in e)void 0!==this._properties[t]&&"m_mainSeries"!==this._properties[t]&&this._properties[t].mergeAndFire(e[t]);void 0!==e.timeScale&&(this._timeScale.defaultRightOffset().setValue(e.timeScale.defaultRightOffset),this._timeScale.defaultRightOffsetPercentage().setValue(e.timeScale.defaultRightOffsetPercentage),this._timeScale.usePercentageRightOffset().setValue(e.timeScale.usePercentageRightOffset)),this._properties.saveDefaults(),this.m_mainSeries.applyPreferences(e.mainSeries),this.sessions().applyPreferences(e.sessions),this.recalculateAllPanes(h()),
this.fullUpdate()}timezone(){return this._properties.timezone.value()}initConnection(){this._chartApi.switchTimezone(this.timezone())}updatePane(e){var t=this._paneInvalidationMask(e);this.invalidate(t)}fullUpdate(){this.invalidate(l.full())}lightUpdate(){this.invalidate(l.light())}studiesMetaData(){return this._studiesMetaData}studyVersioning(){return this._studyVersioning}startNotStartedStudies(){if(!this.m_mainSeries.isStarted())throw new Error("Cannot start studies: main series is not started");for(var e=this.dataSources(),t=0;t<e.length;t++)_(e[t])&&!e[t].isStarted()&&e[t].restart&&e[t]!==this.m_mainSeries&&e[t].restart()}readOnly(){return this._readOnly}_onDrawingsVisibilityChanged(e){for(var t=!1===e.value(),i=this.dataSources(),s=0;s<i.length;s++){var r=i[s],n=o(r)&&r.properties().visible.value();t&&n?y.emit("drawing_event",r.id(),"show"):!t&&n&&y.emit("drawing_event",r.id(),"hide")}this.selectionMacro((function(e){e.clearSelection()}))}_onIndicatorsVisibilityChanged(){var e=this.allStudies().filter((function(e){return e.properties().visible.value()&&e.canBeHiddenByGlobalFlag()}));if(0!==e.length){for(var t=!1,i=0;i<e.length;i++)if(this.selection().isSelected(e[i])){t=!0;break}t?this.selectionMacro((function(e){e.clearSelection()})):this.lightUpdate()}}mainSeries(){return this.m_mainSeries}timeScale(){return this._timeScale}watermarkSource(){return this._watermarkSource}priceScaleSlotsCount(){var e=0,t=0;this._panes.forEach((function(i){e=Math.max(i.leftPriceScales().length,e),t=Math.max(i.rightPriceScales().length,t)}));var i=e+t;if(a.any()){var s=this.paneForSource(this.mainSeries()),r=s.priceScalePosition(this.mainSeries().priceScale()),o="right"===r;return"overlay"===r&&(o=s.rightPriceScales().length>0),o?{left:0,right:1,totallySlots:i}:{left:1,right:0,totallySlots:i}}return{left:e,right:t,totallySlots:e+t}}setPriceAutoScale(e,t,i){e.setPriceAutoScale(t,i),this.invalidate(this._paneInvalidationMask(e,c.Light))}updateScales(e,t){this._undoModel._chartWidget._updateScalesActions()}mainSeriesScaleRatioProperty(){return this._mainSeriesScaleRatioProperty}mainSeriesScaleRatioPropertyOnChanged(){this._mainSeriesScaleRatioProperty.listeners().fire(this._mainSeriesScaleRatioProperty)}mainSeriesScaleRatio(){return S(this._timeScale,this.m_mainSeries.priceScale())}setMainSeriesScaleRatio(e){this.paneForSource(this.m_mainSeries).applyPriceScaleRatio(this.m_mainSeries.priceScale(),e)}restoreFactoryDefaults(e){e.restoreFactoryDefaults(),this.recalcVisibleRangeStudies(!0)}orderedDataSources(e){var t=[];t.push(this.m_crossHairSource);for(var i=0;i<this._panes.length;i++){var s=this._panes[i].sourcesByGroup().all().slice();e&&s.reverse(),t=t.concat(s)}return t}dataSourceForId(e){for(var t,i=0;i<this._panes.length;++i)if(t=this._panes[i].dataSourceForId(e))return t;return null}onSyncScrollNeeded(e){var t=this._undoModel._chartWidget;if(t._chartWidgetCollection){var i=this.mainSeries().syncModel();if(i){var s=1e3*this._timeScale.points().roughTime(e,i.projectTime.bind(i));t._chartWidgetCollection.syncScroll(s,this)}}}
createStudyInserter(e){return new v(e,this._studiesMetaInfoRepository,{createStudy:this.insertStudyWithParams.bind(this)})}studyInserted(){return this._studyInserted}calculateDefaultTags(){for(var e=[],t=this.dataSources(),i=0;i<t.length;i++){var s=t[i];s.tags&&(e=e.concat(s.tags()))}return e}_sendTo(e,t){var i={},s=this;for(var r in e.forEach((function(e){var t=s.paneForSource(e),r=s._panes.indexOf(t);i[r]||(i[r]=[]),i[r].push(e)})),i){t(s._panes[r],i[r])}this.fullUpdate()}sendToBack(e){this._sendTo(e,(function(e,t){e.sendToBack(t)}))}bringToFront(e){this._sendTo(e,(function(e,t){e.bringToFront(t)}))}destroy(){this.mainSeries().properties().childs().showCountdown.unsubscribeAll(this),this.mainSeries().onTimeFrameApplied().unsubscribeAll(this),this.mainSeries().onIntervalChanged().unsubscribeAll(this),this._appliedTimeFrame.destroy(),this.clearIntervals(),m.hideAllDrawings().unsubscribe(this,this._onDrawingsVisibilityChanged),m.hideAllIndicators().unsubscribe(this,this._onIndicatorsVisibilityChanged),this.resetDeferredStudies(),this.allStudies().forEach((e=>this.removeSource(e))),Array.from(this._customSourcesMap.keys()).forEach(this._removeCustomSource,this),s(0===this._topmostCustomSources.length),s(0===this._fgCustomSources.length),s(0===this._bgCustomSources.length),s(0===this._allCustomSources.length),s(0===this._customSourcesMap.size);for(var e=0;e<this._panes.length;e++)this._panes[e].destroy();this._panes.length=0,this._sessions=null,this.m_mainSeries.onStyleChanged().unsubscribe(this._timeScale,this._timeScale.invalidateVisibleBars),this._timeScale.visibleBarsStrictRangeChanged().unsubscribe(this.m_mainSeries,this.m_mainSeries.clearHighLowPriceCache),this._timeScale.visibleBarsStrictRangeChanged().unsubscribe(this.m_mainSeries,this.m_mainSeries.clearAveragePriceCache),this._timeScale.barSpacingChanged().unsubscribeAll(this),this._timeScale.onScroll().unsubscribeAll(this),this._timeScale.destroy(),f.unsubscribe(this,this._updateDateTimeFormatter),b.unsubscribe(this,this._updateDateTimeFormatter),this.mainSeries().properties().interval.unsubscribe(this,this._updateDateTimeFormatter),this._trendLineStatsCache&&this._trendLineStatsCache.destroy(),this._fibRetracementLabelsCache&&this._fibRetracementLabelsCache.destroy(),this._properties.paneProperties.legendProperties.showLegend.unsubscribeAll(this),this._dataSourceCollectionChanged.unsubscribeAll(this),this.m_crossHairSource.destroy(),super.destroy()}listUserStudies(e){var t=[];e=e||{};for(var i=0;i<this._panes.length;i++)for(var s=this._panes[i].dataSources(),r=0;r<s.length;r++){var o=s[r];if(_(o)&&!p(o)&&o.showInObjectTree()){var n=o.metaInfo&&o.metaInfo();if(n){var a=n.id;if(e.dontCountVolume&&"Volume@tv-basicstudies"===a)continue;if(e.dontCountCompare&&"Compare@tv-basicstudies"===a)continue;if(e.dontCountOverlay&&"Overlay@tv-basicstudies"===a)continue}t.push(n.shortDescription)}}return t}restoreSource(e,t,i,s,r){var o,n;o=e?this.createPane(t):this.panes()[t];var a=s.type.toLowerCase().startsWith("study")
;if(!(n=a?o.restoreStudy(s):o.restoreLineTool(s)))return null;var l=null;if(r?l=o.getPriceScaleById(r.id):n.ownerSource()&&(l=n.ownerSource().priceScale()),l)n.setPriceScale(l),l.addDataSource(n);else{l=o.createPriceScaleAtPosition(r.position,r.priceScaleIndex);r&&r.id&&l.setId(r.id),n.setPriceScale(l),l.addDataSource(n)}if(!e&&i&&i.overlayPriceScales){var c=this.dataSources().filter((function(e){return void 0!==i.overlayPriceScales[e.id()]}));c.forEach(o.removeSourceFromPriceScale.bind(o));var h=new Map;c.forEach((function(e){var t,s=i.overlayPriceScales[e.id()];h.has(s.id)?t=h.get(s.id):((t=o.createPriceScaleAtPosition("overlay")).restoreState(s),h.set(s.id,t)),t.addDataSource(e),e.setPriceScale(t)}))}return n.start(),n.restore&&n.restore(),e&&o.restoreState(i,!1,this.version()),a&&(this.recalculateAllPanes(d(n.id())),this.mainSeries().invalidateBarColorerCache(),this.fullUpdate()),a&&this.alertsWatcher().syncSourceAlertLabels(n),n}isSeriesStyleSupported(e){return this.m_mainSeries.isStyleSupported(e)}getStudyShiftColorStartOffset(){return this._studyShiftColorStartOffset}setStudyShiftColorStartOffset(e){this._studyShiftColorStartOffset=e}onInReplayStateChanged(){return this.m_mainSeries.onInReplayStateChanged()}switchToReplay(e,t){this.m_mainSeries.switchToReplay(e,t)}switchToRealtime(){this.m_mainSeries.switchToRealtime(),this._timeScale.resetRightOffset(),this.setReplayStatus(T.Undefined)}rendererOptionsProvider(){return this._rendererOptionsProvider}priceAxisRendererOptions(){return this._rendererOptionsProvider.options()}isPriceScaleVisible(e){var t=this.paneForSource(e.mainSource()),i=t.priceScalePosition(e);if("overlay"===i)return!0;var s=this.priceScaleSlotsCount();return t.priceScaleIndex(e,i)<s[i]}studyMetaInfoRepository(){return this._studiesMetaInfoRepository}studiesColorRotatorFactory(){return this._studyColorRotatorFactory}}e.exports=x},466743:(e,t,i)=>{"use strict"
;var s=i(809796).TranslatedString,r=i(764005).doAnimate,o=i(208697).ChartUndoModelBase,n=i(853965).saveDefaultProperties,a=i(142257).UndoCommand,l=i(376163).ApplyLineToolTemplateUndoCommand,c=i(796517).SetPriceScaleSelectionStrategyCommand,h=i(519231).SetScaleRatioPropertiesCommand,d=i(345848).trackEvent,u=i(727803).RestoreDefaultsPreferencesUndoCommand,_=i(209800).SetPriceScaleModeCommand,p=i(371764).PriceScaleChangeUndoCommand,m=i(679356).preferencesByWhiteList,g=new s("move left",i.tf(null,void 0,i(415086))),S=new s("move right",i.tf(null,void 0,i(461711))),v=new s("toggle auto scale",i.tf(null,void 0,i(863060))),f=new s("toggle lock scale",i.tf(null,void 0,i(121203))),b=new s("toggle regular scale",i.tf(null,void 0,i(733714))),y=new s("toggle indexed to 100 scale",i.tf(null,void 0,i(98860))),C=new s("toggle percentage scale",i.tf(null,void 0,i(568642))),w=new s("toggle log scale",i.tf(null,void 0,i(160166))),P=new s("invert scale",i.tf(null,void 0,i(794245))),T=new s("remove pane",i.tf(null,void 0,i(847637))),M=new s("apply all chart properties",i.tf(null,void 0,i(64034))),x=new s("set price scale selection strategy to {title}",i.tf(null,void 0,i(669485)));class I extends a{constructor(e,t){super(M),this._model=e,this._undoModel=e.undoModel(),this._newProperties=t,function(e,t){var i={hollowCandle:{related:"candle"}};for(var s in["candleStyle","hollowCandleStyle","haStyle"].forEach((function(t){e[t].wickUpColor=e[t].wickUpColor||e[t].wickColor,e[t].wickDownColor=e[t].wickDownColor||e[t].wickColor})),t.vertGridProperties=t.vertGridProperties||t.gridProperties,t.horzGridProperties=t.horzGridProperties||t.gridProperties,i)if(!e[s+"Style"]){var r=e[i[s].related+"Style"];e[s+"Style"]=TradingView.clone(r)}}(this._newProperties.mainSeries,this._newProperties.paneProperties),this._oldProperties=m(e,e.mainSeries())}_merge(e){n(!0),this._model.applyPreferences(e),n(!1)}redo(){this._merge(this._newProperties),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales()}undo(){this._merge(this._oldProperties),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales()}}t.ChartUndoModel=class extends o{constructor(e,t,i,s,r,o,n,a,l,c,h,d){super(e,t,i,s,r,o,n,a,l,c,h,d),this.beginUndoMacro=(e,t)=>{var i=n.beginUndoMacro(e);return i.setCustomFlag("doesnt_affect_save",t),i},this.endUndoMacro=n.endUndoMacro.bind(n),this.createUndoCheckpoint=n.createUndoCheckpoint.bind(n),this.undoToCheckpoint=n.undoToCheckpoint.bind(n)}version(){return this.m_model.version()}createPane(e){return this.m_model.createPane(e)}restart(){this.m_model.restart()}disconnect(){this.m_model.disconnect()}studyVersioning(){return this.m_model.studyVersioning()}chartModel(){return this._model()}_model(){return this.m_model}pushUndoCommand(e){this._pushUndoCommand(e)}_pushUndoCommand(e){this._undoHistory.pushUndoCommand(e)}startScrollPrice(e,t,i){t.isAutoScale()||(this._initialPriceScrollState=t.state(),this._initialPriceScrollPos=i,this.chartModel().startScrollPrice(e,t,i))}scrollPriceTo(e,t,i){
t.isAutoScale()||(this._initialPriceScrollPos&&Math.abs(this._initialPriceScrollPos-i)>20&&(this.pushUndoCommand(new p(this.m_model,e,t,this._initialPriceScrollState)),delete this._initialPriceScrollState,delete this._initialPriceScrollPos),this.chartModel().scrollPriceTo(e,t,i))}endScrollPrice(e,t){t.isAutoScale()||(delete this._initialPriceScrollState,delete this._initialPriceScrollPos,this.chartModel().endScrollPrice(e,t))}setPriceAutoScale(e,t,i){this.pushUndoCommand(new p(this.m_model,e,t,t.state())),this.chartModel().setPriceAutoScale(e,t,i)}setWidth(e){this.m_model.setWidth(e)}setPaneHeight(e,t){this.m_model.setPaneHeight(e,t)}gridSource(){return this.m_model.gridSource()}watermarkSource(){return this.m_model.watermarkSource()}publishedChartsTimelineSource(){return this.m_model.publishedChartsTimelineSource()}crossHairSource(){return this.m_model.crossHairSource()}model(){return this.m_model}chartWidget(){return this._chartWidget}mainSeries(){return this.m_model.m_mainSeries}mainSeriesScaleRatioProperty(){return this.m_model.mainSeriesScaleRatioProperty()}timeScale(){return this.m_model.timeScale()}selectionMacro(e,t){return this.m_model.selectionMacro(e,t)}setHoveredSource(e,t){this.m_model.setHoveredSource(e,t)}selection(){return this.m_model.selection()}onSelectedSourceChanged(){return this.m_model.onSelectedSourceChanged()}activeStrategySource(){return this.m_model.activeStrategySource()}invalidate(e){this.m_model.invalidate(e)}setCurrentPosition(e,t,i,s){this.m_model.setCurrentPosition(e,t,i,s)}setAndSaveCurrentPosition(e,t,i,s){this.m_model.setAndSaveCurrentPosition(e,t,i,s)}setProperties(e,t,i){var s=this;this.beginUndoMacro(i),this.m_model.selectionMacro((function(){for(var r=0;r<e.length;r++)s.setProperty(e[r],t[r],i)})),this.endUndoMacro()}setPriceScaleMode(e,t,i){for(var s=Object.keys(e),r=t.mode(),o=!1,n=0;n<s.length;n++)if(r[s[n]]!==e[s[n]]){o=!0;break}if(o){var a=new _(e,t,i,this.m_model);this.pushUndoCommand(a)}}setPriceScaleSelectionStrategy(e){if(this.m_model.properties().priceScaleSelectionStrategyName.value()!==e){d("Chart","Change PriceScale Selection Strategy");var t=x.format({title:e});this.beginUndoMacro(t),this.setProperty(this.m_model.properties().priceScaleSelectionStrategyName,e,t);var i=new c(this.m_model,e,t);this.pushUndoCommand(i),this.endUndoMacro()}}setScaleRatioProperty(e,t,i){if(e.value()!==t){var s=new h(e,t,i,this.m_model);this.pushUndoCommand(s)}}lineBeingCreated(){return this.m_model.lineBeingCreated()}paneBeingCreatedLineOn(){return this.m_model.paneBeingCreatedLineOn()}cancelCreatingLine(){this.m_model.cancelCreatingLine()}lineCancelled(){return this.m_model.lineCancelled()}lineBeingEdited(){return this.m_model.lineBeingEdited()}sourcesBeingMoved(){return this.m_model.sourcesBeingMoved()}dataSources(){return this.m_model.dataSources()}orderedDataSources(e){return this.m_model.orderedDataSources(e)}dataSourceForId(e){return this.m_model.dataSourceForId(e)}state(e,t,i,s){return this.m_model.state(e,t,i,s)}calculateDefaultTags(){return this.m_model.calculateDefaultTags()}
onTagsChanged(){return this.m_model.onTagsChanged()}moveLeft(){try{this.beginUndoMacro(g)}catch(e){return}var e=this.m_model.timeScale().width(),t=this;r({to:e/5,onStep:function(e){t.startScrollTime(e),t.scrollTimeTo(0),t.endScrollTime()},onComplete:function(){t.endUndoMacro()}})}moveRight(){try{this.beginUndoMacro(S)}catch(e){return}var e=this.m_model.timeScale().width(),t=this;r({to:e/5,onStep:function(e){t.startScrollTime(0),t.scrollTimeTo(e),t.endScrollTime()},onComplete:function(){t.endUndoMacro()}})}scrollChart(e){this.m_model.scrollEnabled()&&(this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime())}restorePreferences(){var e=new u(this.model());this.pushUndoCommand(e)}applyPreferences(e){var t=new I(this.model(),e);this.pushUndoCommand(t)}applyLineToolTemplate(e,t,i){this.beginUndoMacro(i),this.saveLineToolState(e,i);var s=new l(e,t,i);this.pushUndoCommand(s),this.saveLineToolState(e,i),this.endUndoMacro(),this.model().updateSource(e)}isInReplay(){return this.m_model.isInReplay()}switchToReplay(e,t){this._undoHistory.clearStack(),this.m_model.switchToReplay(e,t)}switchToRealtime(){this._undoHistory.clearStack(),this.m_model.switchToRealtime()}togglePriceScaleAutoScaleMode(e){var t={autoScale:!e.isAutoScale()};this.setPriceScaleMode(t,e,v)}togglePriceScaleLockScaleMode(e){var t={lockScale:!e.isLockScale()};this.setPriceScaleMode(t,e,f)}setPriceScaleRegularScaleMode(e){this.setPriceScaleMode({log:!1,percentage:!1,indexedTo100:!1},e,b)}togglePriceScaleIndexedTo100ScaleMode(e){var t={indexedTo100:!e.isIndexedTo100()};this.setPriceScaleMode(t,e,y)}togglePriceScalePercentageScaleMode(e){var t={percentage:!e.isPercentage()};this.setPriceScaleMode(t,e,C)}togglePriceScaleLogScaleMode(e){var t={log:!e.isLog()};this.setPriceScaleMode(t,e,w)}invertPriceScale(e){var t=e.properties().isInverted;this.setProperty(t,!t.value(),P)}removePane(e){var t=this.m_model.panes()[e].dataSources().slice();this.removeSources(t,!1,T)}}},677305:(e,t,i)=>{"use strict";i.d(t,{sourceNewCurrencyOnPinningToPriceScale:()=>r});var s=i(981107);function r(e,t,i,r){let o=null;if(i.currencyConversionEnabled()&&(0,s.isActingAsSymbolSource)(e)){const s=i.availableCurrencies(),n=t.currency(s),a=e.currency();null!==n&&null!==n.selectedCurrency&&!n.allCurrenciesAreOriginal&&n.selectedCurrency!==a&&(r&&null===a||null!==a&&s.convertible(a))&&(o=n.selectedCurrency)}return o}},949529:(e,t,i)=>{"use strict";i.d(t,{CustomSourceBase:()=>s});class s{constructor(e,t){this._id=e,this._model=t}id(){return this._id}isHoveredEnabled(){return!0}isSelectionEnabled(){return!1}priceScale(){return null}paneViews(e){return[]}labelPaneViews(e){return[]}priceAxisViews(e,t){return[]}updateViewsForPane(e,t){e.containsMainSeries()&&this.updateAllViews(t)}}},790524:(e,t,i)=>{"use strict";i.d(t,{isLineToolState:()=>n,isMainSeriesState:()=>r,isStudyLineToolState:()=>a,isStudyState:()=>o});var s=i(616117);function r(e){return"MainSeries"===e.type}function o(e){return Boolean(e.type)&&e.type.toLowerCase().startsWith("study")}function n(e){return Boolean(e.type)&&(0,
s.isLineToolName)(e.type)}function a(e){return Boolean(e.type)&&(0,s.isStudyLineToolName)(e.type)}},992543:(e,t,i)=>{"use strict";i.d(t,{dateFormatProperty:()=>l,restoreDateFormatSettingsValue:()=>c});var s=i(62802),r=i(152633),o=i(958067);const n="date_format";function a(){return s.getValue(n,(0,o.defaultDateFormat)())}const l=(0,r.createPrimitiveProperty)(a());function c(){l.setValue((0,o.defaultDateFormat)()),s.remove(n)}s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())))},950740:(e,t,i)=>{"use strict";i.d(t,{EnvironmentState:()=>r});var s=i(638456);class r{constructor(e,t=!1){this._shift=!1,this._mod=!1,this._alt=!1,void 0!==e&&(this._shift=Boolean(e.shiftKey),this._mod=Boolean((0,s.isMac)()?e.metaKey:e.ctrlKey),this._alt=Boolean(e.altKey)),this._isApiEvent=t}shift(){return this._shift}mod(){return this._mod}alt(){return this._alt}shiftOnly(){return this._shift&&!this._mod&&!this._alt}modOnly(){return this._mod&&!this._shift&&!this._alt}altOnly(){return this._alt&&!this._shift&&!this._mod}modShift(){return this._shift&&this._mod&&!this._alt}isApiEvent(){return this._isApiEvent}static create(e=!1,t=!1,i=!1){return new r({shiftKey:e,ctrlKey:t,metaKey:t,altKey:i})}}},639958:(e,t,i)=>{"use strict";i.d(t,{PipFormatter:()=>o});var s=i(181728),r=i(624444);class o extends r.PriceFormatter{constructor(e,t,i,r,o){t||(t=1),("forex"===i||(0,s.isCFDSymbol)(i,o))&&r?(super(r),this._isForex=!0):(super(1),this._isForex=!1),this._pipPriceScale=e,this._pipMinMove=t,this._pipMinMove2=r}format(e,t,i){let s=this._isForex?this._pipMinMove2:this._pipMinMove;return void 0===s&&(s=NaN),super.format(e*this._pipPriceScale/s,t,i)}}},754480:(e,t,i)=>{"use strict";i.d(t,{TimeSpanFormatter:()=>r});var s=i(444372);class r{format(e){const t=e<0;e=Math.abs(e);const r=Math.floor(e/86400);e-=86400*r;const o=Math.floor(e/3600);e-=3600*o;const n=Math.floor(e/60);e-=60*n;let a="";return r&&(a+=r+s.t(null,{context:"dates"},i(297840))+" "),o&&(a+=o+s.t(null,{context:"dates"},i(564302))+" "),n&&(a+=n+s.t(null,{context:"dates"},i(592659))+" "),e&&(a+=e+s.t(null,{context:"dates"},i(222448))+" "),t&&(a="-"+a),a.trim()}}},921692:(e,t,i)=>{"use strict";i.d(t,{FuturesContractExpiration:()=>O,isFuturesContractExpiration:()=>N});var s=i(650151),r=i(996986),o=i(888929),n=i(822914),a=i(987088),l=i(86441),c=i(444372),h=i(246733),d=i(511131),u=i(528474),_=i(458963),p=i(422333),m=i(986837),g=i(315801),S=i(787123),v=i(382778);const f=new Path2D("M.18.24a4.78 4.78 0 0 0 .9 4.36c.15.18.32.34.51.5l.52.4-.52.4a3.8 3.8 0 0 0-.52.5 4.78 4.78 0 0 0-.89 4.36c.04.14.16.24.29.24h6.06c.13 0 .25-.1.29-.24a4.78 4.78 0 0 0-.9-4.36 3.8 3.8 0 0 0-.51-.5l-.52-.4.52-.4c.19-.16.36-.32.52-.5A4.78 4.78 0 0 0 6.82.24C6.78.1 6.66 0 6.53 0H.47C.34 0 .22.1.18.24ZM3.5 4.88l1.23-.97a3 3 0 0 0 1.05-2.48H1.22a3 3 0 0 0 1.05 2.48l1.23.97Z");class b extends v.LollipopRenderer{_drawLollipop(e,t,i){const s=i.pixelRatio,r=this._data.style;e.save(),e.translate(t.x,t.y),e.scale(s,s),e.beginPath(),e.strokeStyle=r.outerBorderColor,e.lineWidth=1,
e.arc(0,0,11,0,2*Math.PI),e.stroke(),e.fillStyle=r.backgroundColor,e.beginPath(),e.arc(0,0,10.5,0,2*Math.PI),e.fill(),e.translate(-3.5,-5.5),e.fillStyle=r.iconColor,e.fill(f,"evenodd"),e.translate(3.5,5.5),r.borderColor&&(e.strokeStyle=r.borderColor,e.lineWidth=1.5,(0,S.setLineStyle)(e,_.LINESTYLE_SOLID),e.beginPath(),e.arc(0,0,9.75,0,2*Math.PI),e.stroke()),e.restore()}}var y=i(760823);const C=c.t(null,void 0,i(401256)),w=c.t(null,void 0,i(911235)),P={dark:{background:(0,a.getHexColorByName)("color-cold-gray-900"),foreground:(0,a.getHexColorByName)("color-cold-gray-450"),foregroundExpired:(0,a.getHexColorByName)("color-ripe-red-500")},light:{background:(0,a.getHexColorByName)("color-white"),foreground:(0,a.getHexColorByName)("color-cold-gray-550"),foregroundExpired:(0,a.getHexColorByName)("color-ripe-red-500")}},T={barLine:{lineStyle:_.LINESTYLE_DASHED,lineWidth:1,strokeStyle:""},lollipop:{width:21,height:21,bottom:2,lineWidth:1.5,strokeStyle:"",backgroundColor:"",fillCircle:!0,fillStyle:"",text:{label:"",strokeStyle:"",font:(0,d.makeFont)(12,p.CHART_FONT_FAMILY,"bold")}},iconColor:"",backgroundColor:"",outerBorderColor:""};class M extends m.LollipopPaneView{constructor(){super(...arguments),this._style=(0,n.default)(T)}renderer(e,t){return this._invalidated&&(this._createLollipops(t,e),this._invalidated=!1),this._renderer}getStyle(e){const t=this._model.dark().value()?P.dark:P.light,i=e.expired?t.foregroundExpired:t.foreground,s=t.background,r=this._style;return e.active?(r.backgroundColor=i,r.iconColor=s,r.borderColor=void 0):(r.iconColor=i,r.borderColor=i,r.backgroundColor=e.hovered?(0,u.blendColors)(s,(0,h.applyAlpha)(i,.15)):s),r.outerBorderColor=s,r.barLine.strokeStyle=i,r}_createTooltipContent(e){const t=this._model.dark().value()?P.dark:P.light,i=e.expired?t.foregroundExpired:t.foreground;return[{type:"common",title:e.expired?w:C,subTitle:e.expiration,tooltipIcon:y.replace(/currentColor/g,i),style:{color:i}}]}_createRendererForLollipop(e,t){return new b(e,new g.HitTestResult(g.HitTarget.Custom,t),this._textWidthCache)}_createLollipops(e,t){const i=this._source.data();if(null===i||void 0===i.index)return;const s=this._model.timeScale(),r=super._getY(),o=this._model.hoveredSource()===this._source,n=null!==this.getLastClickedLollipopId(),a={id:0,itemIndex:0,basePoint:(0,l.point)(s.indexToCoordinate(i.index),r),hovered:o,active:n,expiration:i.formattedDate,expired:i.expired,visible:!0};this._lollipops[0]=a,super._createRenderers(e,t)}}var x=i(988124),I=i(731042),L=i(201089),k=i(354950),A=i.n(k),E=i(65455);const D=(0,L.getLogger)("FutureContractExpiration");let B=0;let R=0;function N(e){return e instanceof O}const V={visible:!0};class O extends r.DataSource{constructor(e){super("futures_contract_expiration"),this._data=null,this._pointsetId=(B+=1,`future_expiration_${B}`),this._pointsetTurnaround=null,this._properties=new(A())(V),this._onConnectionStateChanged=e=>{e?this._updateData():this._removePointset()},this.setOwnerSource(e.mainSeries()),this._model=e,this._paneView=new M(e,this,this._showTooltip.bind(this))
;const t=(0,s.ensureNotNull)(e.mainSeries().marketStatusModel().futuresContractExpirationTime());this._expirationUTCTime=t.utcTime().spawn(),this._expired=t.expired().spawn(),this._sessionSpec=t.sessionSpec().spawn(),this._formattedExpirationDate=()=>e.dateFormatter().format(t.utcDayStart()),this._expirationUTCTime.subscribe((()=>{this._removePointset(),this._updateData(),this._paneView.update(),this._model.updateSource(this)})),this._expired.subscribe((()=>{null!==this._data&&(this._data.expired=this._expired.value(),this._paneView.update(),this._model.updateSource(this))}));const i=()=>{this._removePointset(),this._createPointset()};this._destroyPropertyBinder=(0,E.bindProperties)(e.mainSeries().properties().childs().showFuturesContractExpiration,this._properties.childs().visible),e.mainSeries().onIntervalChanged().subscribe(this,i),this._sessionSpec.subscribe(i),e.chartApi().isConnected().subscribe(this._onConnectionStateChanged),this._updateData()}destroy(){this._removePointset(),this._model.mainSeries().onIntervalChanged().unsubscribeAll(this),this._model.chartApi().isConnected().unsubscribe(this._onConnectionStateChanged),this._paneView.destroy(),this._expirationUTCTime.destroy(),this._expired.destroy(),this._sessionSpec.destroy(),this._destroyPropertyBinder()}lollipopsAtIndex(e){return null===this._data||this._data.index!==e?0:1}name(){return"FuturesContractExpiration"}properties(){return this._properties}state(e){return null}paneViews(e){return[this._paneView]}updateAllViews(e){this._paneView.update()}data(){return this._data}zorder(){return o.sortSourcesPreOrdered.FutureContractExpiration}onClickOutside(){this._paneView.processClickOutside()}preferNoScale(){return!0}showInObjectTree(){return!1}isSavedInStudyTemplates(){return!1}isRemovedByStudyTemplates(){return!1}copiable(){return!1}hasStateForAlert(){return!1}isSavedInChart(e){return!1}isSpeciallyZOrderedSource(){return!0}isUserDeletable(){return!1}canHaveChildren(){return!1}isIncludedInAutoScale(){return!1}async _showTooltip(e,t){const r=this._model,o=this._model.timeScale(),n=[o.onScroll(),o.barSpacingChanged(),r.mainSeries().onSymbolIntervalChanged(),(0,s.ensureNotNull)(r.paneForSource(this)).onSizeChanged()],a=this._paneView.processClickOutside.bind(this._paneView),l=this._paneView.clearLastClicked.bind(this._paneView),c=t();if(null===c)return;const{showLollipopTooltip:h}=await Promise.all([i.e(18562),i.e(22666),i.e(5993),i.e(4015),i.e(92191),i.e(53842),i.e(35649),i.e(89842),i.e(72639),i.e(88548),i.e(36747),i.e(50293),i.e(48986),i.e(67103),i.e(13821),i.e(6744),i.e(57215),i.e(42244),i.e(94345),i.e(27620),i.e(58666),i.e(92991),i.e(34884),i.e(2807),i.e(63823),i.e(50690),i.e(59255),i.e(66590),i.e(85841),i.e(6386),i.e(49039)]).then(i.bind(i,722832));h({items:c,position:e,customCloseSubscriptions:n,onClickOutside:a,onCustomClose:l,showScrollFades:!0})}_updateData(){const e=this._expirationUTCTime.value();if(null===e)return this._data=null,void this._removePointset();this._data={time:e,expired:this._expired.value(),
formattedDate:this._formattedExpirationDate()},this._createPointset()}_removePointset(){if(null!==this._pointsetTurnaround){const e=this._model.chartApi();e.isConnected().value()&&e.removePointset(this._pointsetId),this._pointsetTurnaround=null}}_createPointset(){if(null!==this._pointsetTurnaround)return;const e=this._model,t=e.chartApi(),i=this._sessionSpec.value();if(null===this._data||null===i||!t.isConnected().value())return;const r=e.mainSeries(),o=r.symbolInfo();if(null===o)return;let n=e.properties().childs().timezone.value();"exchange"===n&&(n=o.timezone);const a=x.get_timezone(n);this._pointsetTurnaround=(R+=1,`t${R}`);const l=(0,s.ensureNotNull)(r.seriesSource().symbolInstanceId()),c=(0,I.getServerInterval)(r.interval());let h;const d=this._data.time;if(r.isDWM()){const e=new Date(d);i.alignToSessionStart(e),h=[[x.cal_to_utc(a,e)/1e3,0]]}else h=[[d/1e3,0]];t.createPointset(this._pointsetId,this._pointsetTurnaround,l,c,h,this._onPointsetResponse.bind(this))}_onPointsetResponse(e){if("pointset_error"===e.method){const[t,i]=e.params;return void(t===this._pointsetId&&i===this._pointsetTurnaround&&D.logError("Pointset error"))}const t=e.params;t.customId===this._pointsetId&&null!==this._data&&(this._data.index=0===t.plots.length?void 0:t.plots[0].value[0],this._paneView.update(),this._model.updateSource(this))}}},924788:(e,t,i)=>{"use strict";function s(e){return e&&e.lollipopsAtIndex}i.d(t,{isLollipopDataSource:()=>s})},74439:(e,t,i)=>{"use strict";var s;i.d(t,{ReplayStatus:()=>s}),function(e){e[e.Undefined=0]="Undefined",e[e.PointSelect=1]="PointSelect",e[e.AutoPlay=2]="AutoPlay",e[e.Pause=3]="Pause"}(s||(s={}))},913984:(e,t,i)=>{"use strict";function s(e){return Boolean(e.showInObjectTree)}i.d(t,{isDataSource:()=>s})},454373:(e,t,i)=>{"use strict";i.d(t,{LatestUpdatesSource:()=>X,isLatestUpdatesSource:()=>Y});var s=i(650151),r=i(201089),o=i(996986),n=i(888929),a=i(354950),l=i.n(a),c=i(65455),h=i(824837),d=i(120780);const u=new Map;async function _(e,t,i){const s=performance.now();!function(e){const t=[];for(const[i,s]of u)s.expirationTime<e&&t.push(i);t.forEach((e=>u.delete(e)))}(s);const r=u.get(e.symbol);let o;return void 0!==r?o=r.promise:(o=async function(e,t){const i=new URL("/api/v1/minds/popular/",window.location.origin);i.searchParams.append("symbol",e.symbol),e.limit&&i.searchParams.append("limit",e.limit.toString());const s=await(0,d.fetch)(i.href,{credentials:"include",method:"GET",signal:t});if(!s.ok)throw Error("Error while popular minds fetch");return s.json()}(e,i),u.set(e.symbol,{promise:o,expirationTime:s+t})),o}var p=i(822914),m=i(987088),g=i(86441),S=i(444372),v=i(887357),f=i(207678),b=i(528474),y=i(638456),C=i(339957),w=i(137674),P=i(246733),T=i(511131),M=i(458963),x=i(422333),I=i(986837),L=i(315801),k=i(787123),A=i(382778);const E=new Path2D("m7.06 0 .87.77-3.4 4.17H9L1.94 11l-.87-.77 3.4-4.17H0L7.06 0Z");class D extends A.LollipopRenderer{_drawLollipop(e,t,i){const s=i.pixelRatio,r=this._data.style;e.save(),e.translate(t.x,t.y),e.scale(s,s),e.beginPath(),e.strokeStyle=r.outerBorderColor,
e.lineWidth=1,e.arc(0,0,11,0,2*Math.PI),e.stroke(),e.fillStyle=r.backgroundColor,e.beginPath(),e.arc(0,0,10.5,0,2*Math.PI),e.fill(),e.translate(-4.5,-5.5),e.fillStyle=r.iconColor,e.fill(E,"evenodd"),e.translate(4.5,5.5),r.borderColor&&(e.strokeStyle=r.borderColor,e.lineWidth=1.5,(0,k.setLineStyle)(e,M.LINESTYLE_SOLID),e.beginPath(),e.arc(0,0,9.75,0,2*Math.PI),e.stroke()),r.hasUpdatesCircle&&(e.fillStyle=r.hasUpdatesCircle.color,e.strokeStyle=r.hasUpdatesCircle.borderColor,e.lineWidth=2,e.beginPath(),e.arc(9.75*Math.cos(Math.PI/4),9.75*-Math.sin(Math.PI/4),3.5,0,2*Math.PI),e.closePath(),e.fill(),e.stroke()),e.restore()}}var B=i(244230);const R=(0,r.getLogger)("LatestUpdatesProvider"),N={dark:{background:(0,m.getHexColorByName)("color-cold-gray-900"),foreground:(0,m.getHexColorByName)("color-grapes-purple-400"),hasUpdatesCircle:(0,m.getHexColorByName)("color-ripe-red-500")},light:{background:(0,m.getHexColorByName)("color-white"),foreground:(0,m.getHexColorByName)("color-grapes-purple-500"),hasUpdatesCircle:(0,m.getHexColorByName)("color-ripe-red-500")}},V={barLine:{lineStyle:M.LINESTYLE_DASHED,lineWidth:1,strokeStyle:""},lollipop:{width:21,height:21,bottom:2,lineWidth:1.5,strokeStyle:"",backgroundColor:"",fillCircle:!0,fillStyle:"",text:{label:"",strokeStyle:"",font:(0,T.makeFont)(12,x.CHART_FONT_FAMILY,"bold")}},iconColor:"",backgroundColor:"",outerBorderColor:""};async function O(e){const{openMindsPage:t}=await i.e(20603).then(i.bind(i,732246));t(e)}const F=S.t(null,void 0,i(857154)),W=S.t(null,void 0,i(923278)),z=S.t(null,void 0,i(998431)),H=S.t(null,void 0,i(413070)),U=S.t(null,void 0,i(620107));class G extends I.LollipopPaneView{constructor(){super(...arguments),this._style=(0,p.default)(V)}renderer(e,t){return this._source.hideLollipop()?null:(this._invalidated&&(this._createLollipops(t,e),this._invalidated=!1),this._renderer)}getStyle(e){const t=this._model.dark().value()?N.dark:N.light,i=t.foreground,s=t.background,r=this._style;return e.active?(r.backgroundColor=i,r.iconColor=s,r.borderColor=void 0):(r.iconColor=i,r.borderColor=i,r.backgroundColor=e.hovered?(0,b.blendColors)(s,(0,P.applyAlpha)(i,.15)):s),r.outerBorderColor=s,r.barLine.strokeStyle=i,r.lollipop.incHeight=void 0===e.stack?void 0:25*e.stack,r.hasUpdatesCircle=e.data.hasNewItems?{color:t.hasUpdatesCircle,borderColor:s}:void 0,r}_createTooltipContent(e){var t,s,r,o,n;const a=this._model.mainSeries().symbol(),l=(this._model.dark().value()?N.dark:N.light).foreground,c=e.data.newsData,h=e.data.mindsData,d=c&&c.items.length>0,u=h&&h.items.length>0;if(!d&&!u)return null;const _=null!==(t=a.split(":")[1])&&void 0!==t?t:a,p={title:d&&u?F:d&&S.t(null,{replace:{symbol:_}},i(588103))||u&&S.t(null,{replace:{symbol:_}},i(883274))||"",tabs:[],tooltipIcon:B.replace(/currentColor/g,l),style:{color:l}};return d&&p.tabs.push({id:"news",name:W,content:{type:"news",items:c.items,clickHandler:(e,t)=>{y.CheckMobile.any()&&this._source.hideTooltip(),async function(e,t,s){e.isExternal||s.preventDefault();try{const r={...e,analyticsData:t.analyticsData
},[{TradingViewNewsProviderFetcher:o},{onNewsCardAction:n}]=await Promise.all([i.e(56370).then(i.bind(i,249092)),i.e(56370).then(i.bind(i,966360))]);n({newsItem:r,newsItems:await o.instance().fetch({...t.requestProps,client:"web"},3e5),placement:v.NewsWidgetPlacement.Chart})(s)}catch(s){R.logWarn(`An error ocurred while loading news: ${s}`)}}(e,c,t)}},anchor:(null===(r=null===(s=window.widgetbar)||void 0===s?void 0:s.layout)||void 0===r?void 0:r.canOpen())?{text:H,onClick:()=>{var e;this._source.hideTooltip(),null===(e=window.widgetbar)||void 0===e||e.setPage("base"),(0,w.showSymbolNews)(a)},hideInMobileMode:!0}:void 0}),u&&p.tabs.push({id:"minds",name:z,content:{type:"minds",symbol:a,items:h.items,clickHandler:(e,t,i)=>{this._source.hideTooltip(),function(e,t,i,s){var r,o,n;const a=(0,C.mindsMovedToDetailsEnabled)()?null===(r=window.widgetbar)||void 0===r?void 0:r.widget("detail"):null===(o=window.widgetbar)||void 0===o?void 0:o.widget("minds"),l=null==a?void 0:a.widgetObject;l&&(l.unmount(),l.setMindUid(e[t].uid,s),l.mount()),null==a||a.widgetStarted().subscribe(null,(i=>{var r;return null===(r=i.widgetObject)||void 0===r?void 0:r.setMindUid(e[t].uid,s)}),!0),window.innerWidth<f.mobileFirstBreakpoints["media-mf-tablet-vertical"]&&(null===(n=window.widgetbar)||void 0===n||n.resizerBridge.requestFullscreen()),O(i)}(e,t,a,i)}},anchor:(null===(n=null===(o=window.widgetbar)||void 0===o?void 0:o.layout)||void 0===n?void 0:n.canOpen())?{text:U,onClick:()=>{this._source.hideTooltip(),function(e){var t,i;const s=null===(t=window.widgetbar)||void 0===t?void 0:t.widget("minds"),r=null==s?void 0:s.widgetObject;r&&(r.unmount(),r.mount()),window.innerWidth<f.mobileFirstBreakpoints["media-mf-tablet-vertical"]&&(null===(i=window.widgetbar)||void 0===i||i.resizerBridge.requestFullscreen()),O(e)}(a)},hideInMobileMode:!0}:void 0}),p}_createRendererForLollipop(e,t){return new D(e,new L.HitTestResult(L.HitTarget.Custom,t),this._textWidthCache)}_createLollipops(e,t){const i=this._source.data();if(null===i||(void 0===i.newsData||0===i.newsData.items.length)&&(void 0===i.mindsData||0===i.mindsData.items.length))return;const s=this._model.timeScale(),r=super._getY(),o=this._model.hoveredSource()===this._source,n=null!==this.getLastClickedLollipopId(),a=this._source.zorder();let l=0;for(const e of this._model.mainPane().lollipopDataSources())e!==this._source&&e.zorder()>a&&e.isVisible()&&(l+=e.lollipopsAtIndex(i.index));const c={id:0,itemIndex:0,basePoint:(0,g.point)(s.indexToCoordinate(i.index),r),hovered:o,active:n,visible:!0,stack:l,data:i};this._lollipops[0]=c,super._createRenderers(e,t)}}const q=(0,r.getLogger)("Chart.LatestUpdate"),j={visible:!0};function Y(e){return e instanceof X}function K(e){return!e.isSeconds()&&!e.isTicks()}class X extends o.DataSource{constructor(e,t){super("latestUpdates"),this._properties=new(l())(j),this._items={},this._hasNewItems=!1,this._hideLollipopTooltipFn=null,this._prevLastItems={symbol:"",titles:{}},this._abortController=new AbortController,this._destroyed=!1,this.setOwnerSource(e.mainSeries()),
this._latestUpdatesDataEnabled=t,this._model=e,this._series=e.mainSeries(),this._paneView=new G(e,this,this._showTooltip.bind(this)),this._series.symbolResolved().subscribe(this,this._onSymbolResolved);const i=this._series.intervalObj();this._isAvailableOnCurrentInterval=K(i),this._series.onIntervalChanged().subscribe(this,this._recalculateAvailabilityOnCurrentInterval),this._destroyPropertyBinder=(0,c.bindProperties)(e.mainSeries().properties().childs().showLastNews,this._properties.childs().visible),this._requestAllData(),this._hideLollipop=(0,h.createWVFromGetterAndSubscription)((()=>this._model.isInReplay()),this._model.onInReplayStateChanged()),this._hideLollipop.subscribe((()=>this._model.updateSource(this)))}destroy(){this._destroyed=!0,this._abortController.abort(),this._paneView.destroy(),void 0!==this._requestDataTimeoutId&&clearTimeout(this._requestDataTimeoutId),this._series.symbolResolved().unsubscribeAll(this),this._series.onIntervalChanged().unsubscribeAll(this),this._destroyPropertyBinder(),this._hideLollipop.destroy()}hideLollipop(){return this._hideLollipop.value()}lollipopsAtIndex(e){var t;return Object.keys(this._items).length>0&&e===(null===(t=this._series.data().last())||void 0===t?void 0:t.index)?1:0}name(){return"LatestUpdatesSource"}data(){const e=this._series.data().last();if(null===e||void 0===Object.keys(this._items).length)return null;const t={index:e.index,hasNewItems:this._hasNewItems};return this._items[0]&&void 0!==this._requestProps&&void 0!==this._newsAnalyticsData&&(t.newsData={items:this._items[0],requestProps:this._requestProps,analyticsData:this._newsAnalyticsData}),this._items[1]&&(t.mindsData={items:this._items[1]}),t}properties(){return this._properties}state(e){return null}paneViews(e){return[this._paneView]}updateAllViews(e){this._paneView.update()}zorder(){return n.sortSourcesPreOrdered.LatestUpdates}onClickOutside(){this._paneView.processClickOutside()}preferNoScale(){return!0}showInObjectTree(){return!1}isSavedInStudyTemplates(){return!1}isRemovedByStudyTemplates(){return!1}copiable(){return!1}hasStateForAlert(){return!1}isSavedInChart(e){return!1}isSpeciallyZOrderedSource(){return!0}isUserDeletable(){return!1}canHaveChildren(){return!1}isIncludedInAutoScale(){return!1}hideTooltip(){var e;null===(e=this._hideLollipopTooltipFn)||void 0===e||e.call(this),this._hideLollipopTooltipFn=null}async _showTooltip(e,t){const r=this._model.timeScale(),o=[r.onScroll(),r.barSpacingChanged(),this._series.onSymbolIntervalChanged(),(0,s.ensureNotNull)(this._model.paneForSource(this)).onSizeChanged()],n=this._paneView.processClickOutside.bind(this._paneView),a=this._paneView.clearLastClicked.bind(this._paneView),l=t();if(null===l)return;this._hasNewItems=!1
;const{showLollipopTooltipWIthTabs:c}=await Promise.all([i.e(18562),i.e(22666),i.e(5993),i.e(4015),i.e(92191),i.e(53842),i.e(35649),i.e(89842),i.e(72639),i.e(88548),i.e(36747),i.e(50293),i.e(48986),i.e(67103),i.e(13821),i.e(6744),i.e(57215),i.e(42244),i.e(94345),i.e(27620),i.e(58666),i.e(92991),i.e(34884),i.e(2807),i.e(63823),i.e(50690),i.e(59255),i.e(66590),i.e(85841),i.e(6386),i.e(49039)]).then(i.bind(i,480079));this._hideLollipopTooltipFn=c({content:l,position:e,customCloseSubscriptions:o,onClickOutside:n,doNotCloseOn:()=>[document.querySelector('[data-name="news-dialog"]'),document.querySelector('[data-dialog-name="image-dialog"]')].filter((e=>null!==e)),onCustomClose:a,showScrollFades:!0})}async _requestAllData(){var e,t;if(void 0!==this._requestDataTimeoutId&&(clearTimeout(this._requestDataTimeoutId),this._requestDataTimeoutId=void 0),this._abortController.abort(),this._abortController=new AbortController,!this._isAvailableOnCurrentInterval)return void(this._items={});const i=this._series.symbolInfo();if(null===i)return;const s=this._abortController.signal;if(await Promise.all([this._requestNews(s),this._requestMinds(s)]),this._destroyed||s.aborted)return;const r=this._items[0],o=this._items[1],n=null!==(e=r&&r[r.length-1])&&void 0!==e?e:null,a=null!==(t=o&&o[o.length-1])&&void 0!==t?t:null;this._hasNewItems=this._prevLastItems.symbol===i.pro_name&&(this._hasNewItems||null!==n&&n.title!==this._prevLastItems.titles[0]||null!==a&&a.uid!==this._prevLastItems.titles[1]),this._prevLastItems={symbol:i.pro_name,titles:{0:null==n?void 0:n.title,1:null==a?void 0:a.uid}},Object.keys(this._items).length&&(this._paneView.update(),this._model.updateSource(this)),this._requestDataTimeoutId=setTimeout(this._requestAllData.bind(this),3e5)}async _requestNews(e){if(!this._latestUpdatesDataEnabled.news)return;const t=this._series.symbolInfo();if(null!==t)try{const[{TradingViewNewsProviderFetcher:s},{getIsoLanguageCodeFromLanguage:r},{getCardsAnalyticsData:o},{handleNewsProName:n}]=await Promise.all([i.e(56370).then(i.bind(i,249092)),i.e(56370).then(i.bind(i,39654)),i.e(56370).then(i.bind(i,859409)),i.e(56370).then(i.bind(i,470598))]);this._requestProps={lang:r(window.language),symbol:n(t.pro_name,t.type),client:"chart"},this._newsAnalyticsData=o(this._requestProps);let a=await s.instance().fetch(this._requestProps,3e5,3,e);if(this._destroyed||e.aborted)return;a.length>0&&Date.now()-a[0].published>=26784e5&&(a=[]),this._items[0]=a}catch(e){q.logWarn(`An error ocurred while loading news: ${e}`)}}async _requestMinds(e){const t=this._series.symbolInfo();if(null!==t&&this._latestUpdatesDataEnabled.minds)try{const i=await _({symbol:t.pro_name,limit:3},3e5,e);if(this._destroyed||e.aborted)return;this._items[1]=i}catch(e){q.logWarn(`An error ocurred while loading minds: ${e}`)}}_onSymbolResolved(){this._items={},this._requestAllData()}_recalculateAvailabilityOnCurrentInterval(){const e=K(this._series.intervalObj());e!==this._isAvailableOnCurrentInterval&&(this._isAvailableOnCurrentInterval=e,this._requestAllData(),
this._isAvailableOnCurrentInterval||(this._paneView.update(),this._model.updateSource(this)))}}},391534:(e,t,i)=>{"use strict";i.d(t,{LineToolsGroup:()=>l});var s=i(707957),r=i(401580),o=i(541558);function n(e){return e.properties().visible.value()}function a(e){return!n(e)}class l{constructor(e,t,i){this._instanceId=(0,o.randomHashN)(6),this._onChanged=new s.Delegate,this._lineToolsSet=new Set,this._lineTools=[...e],this._lineToolsSet=new Set(this._lineTools),this._name=new r.WatchedValue(t),this.id=i||(0,o.randomHashN)(6)}instanceId(){return this._instanceId}lineTools(){return this._lineTools}name(){return this._name}setName(e){this._doAndFireOnChange((()=>{this._name.setValue(e)}))}isActualSymbol(){return this._lineTools.length>0&&this._lineTools[0].isActualSymbol()&&this._lineTools[0].isActualCurrency()&&this._lineTools[0].isActualUnit()}symbol(){return this._lineTools[0].symbol()}currencyId(){var e;return null!==(e=this._lineTools[0].properties().childs().currencyId.value())&&void 0!==e?e:null}unitId(){var e;return null!==(e=this._lineTools[0].properties().childs().unitId.value())&&void 0!==e?e:null}sharingMode(){return this._lineTools[0].sharingMode()}share(e){this._lineTools.forEach((t=>t.share(e)))}containsLineTool(e){return this._lineToolsSet.has(e)}addLineTools(e){this._doAndFireOnChange((t=>{e.forEach((e=>this._lineToolsSet.add(e))),this._lineTools.push(...e),t.push(...e.map((e=>e.id())))}))}excludeLineTool(e){this._doAndFireOnChange((t=>{this._lineToolsSet.delete(e);const i=this._lineTools.indexOf(e);this._lineTools.splice(i,1),t.push(e.id())}))}excludeLineTools(e){this._doAndFireOnChange((t=>{const i=new Set(e);e.forEach((e=>this._lineToolsSet.delete(e))),this._lineTools=this._lineTools.filter((e=>!i.has(e))),t.push(...e.map((e=>e.id())))}))}state(){return{id:this.id,name:this._name.value(),tools:this._lineTools.map((e=>e.id()))}}visibility(){const e=this._lineTools.some(n),t=this._lineTools.some(a);return e&&!t?"Visible":t&&!e?"Invisible":"Partial"}locked(){const e=this._lineTools.some((e=>e.properties().frozen.value())),t=this._lineTools.some((e=>!e.properties().frozen.value()));return e&&!t?"Locked":t&&!e?"Unlocked":"Partial"}isActualInterval(){const e=this._lineTools.some((e=>e.isActualInterval())),t=this._lineTools.some((e=>!e.isActualInterval()));return e&&!t?"IsActualInterval":t&&!e?"IsNotActualInterval":"Partial"}onChanged(){return this._onChanged}static fromState(e,t){const i=[];for(const s of t.tools){const t=e.dataSourceForId(s);null!==t&&i.push(t)}return i.length>0?new l(i,t.name,t.id):null}_doAndFireOnChange(e){const t=[],i=this.visibility(),s=this.locked(),r=this.isActualInterval();e(t),this._onChanged.fire({affectedLineTools:t,visibilityChanged:i!==this.visibility(),lockedChanged:s!==this.locked(),isActualIntervalChanged:r!==this.isActualInterval()})}}},606097:(e,t,i)=>{"use strict";i.d(t,{blobImageFilter:()=>a,checkImageSize:()=>u,generateLink:()=>d,imageIsOversized:()=>c,uploadImage:()=>_});var s=i(327714),r=i(120780),o=i(444372),n=i(201089);function a(e){
return"image/png"===e.type||"image/jpeg"===e.type}const l=(0,s.size)({width:2e3,height:2e3});function c(e){return e.width>l.width||e.height>l.height}const h=(0,n.getLogger)("Chart.Uploader");async function d(e){const t=new FormData,i="name"in e?e.name:"image.png";t.append("content_type",e.type),t.append("filename",i),t.append("size",""+e.size);try{const e=await(0,r.fetch)("/charts/uploads/generate-link/",{method:"POST",body:t});if(!e.ok)throw new Error(`Error generating upload link: ${e.status}`);return e.json()}catch(t){throw h.logError(`Error generating upload link: ${t}. blob.type: ${e.type} blob.size: ${e.size} filename: ${i}`),t}}async function u(e){return new Promise(((t,i)=>{const s=new FileReader;s.onload=e=>{var s;const r=new Image;r.src=null===(s=e.target)||void 0===s?void 0:s.result,r.onload=()=>{t(!c(r))},r.onerror=i},s.onerror=i,s.readAsDataURL(e)}))}async function _(e){if(!await u(e))throw new Error(o.t(null,void 0,i(753716)));try{const t=await d(e),i=t.data.fields,s=new FormData;for(const e of Object.keys(i))s.append(e,i[e]);s.append("file",e);const o=await(0,r.fetch)(t.data.url,{method:"POST",body:s});if(o.ok)return t.data.url+t.filepath;throw new Error(`Upload response is not ok: ${o.status}`)}catch(e){throw new Error(`Error uploading image: ${e.message}`)}}},549621:(e,t,i)=>{"use strict";i.d(t,{LogicalRange:()=>r});var s=i(650151);class r{constructor(e,t){(0,s.assert)(e<=t,"The left value should be greater than or equal to the right value"),this._left=e,this._right=t}left(){return this._left}right(){return this._right}length(){return this._right-this._left+1}contains(e,t){return e<this._left-.5?!0===t&&1:e>this._right+.5?!0===t&&2:!0!==t||0}before(e){return e<this._left-.5}after(e){return e>this._right+.5}intersects(e){return!(this.after(e.left())||this.before(e.right()))}equals(e){return this._left===e.left()&&this._right===e.right()}static compare(e,t){return null===e||null===t?e===t:e.equals(t)}}},220843:(e,t,i)=>{"use strict";i.d(t,{MainSeriesScaleRatioProperty:()=>o});var s=i(707957),r=i(428123);class o{constructor(e){this._changed=new s.Delegate,this._model=e}destroy(){this._changed.destroy()}getStepChangeValue(){return.1}getMinValue(){return 1e-7}getMaxValue(){return 99999999}value(){return this._model.mainSeriesScaleRatio()}setValue(e,t){(e!==this.value()||t)&&(this._model.setMainSeriesScaleRatio(e),this._onChanged())}state(){return null}clone(){return new o(this._model)}listeners(){return this._changed}subscribe(e,t){this._changed.subscribe(e,t)}unsubscribe(e,t){this._changed.unsubscribe(e,t)}unsubscribeAll(e){this._changed.unsubscribeAll(e)}storeStateIfUndefined(){return!0}weakReference(){return(0,r.weakReference)(this)}ownership(){return(0,r.ownership)(this)}_onChanged(){this._changed.fire(this)}}},189767:(e,t,i)=>{"use strict";i.d(t,{RectangleRenderer:()=>u});var s=i(650151),r=i(86441),o=i(934026),n=i(204652),a=i(246733),l=i(458963),c=i(315801),h=i(787123),d=i(43192);class u extends d.BitmapCoordinatesPaneRenderer{constructor(e,t,i){super(),this._data=null,
this._hitTestResult=e||new c.HitTestResult(c.HitTarget.MovePoint),this._backHitTestResult=t||new c.HitTestResult(c.HitTarget.MovePointBackground),this._forceOverrideTransparency=Boolean(i)}setData(e){this._data=e}hitTest(e,t){if(null===this._data||this._data.points.length<2||this._data.nohittest)return null;const i=t.physicalWidth,s=(0,r.box)(...this._data.points),o=s.min,a=s.max,l=new r.Point(a.x,o.y),c=new r.Point(o.x,a.y),h=this._extendAndHitTestLineSegment(e,o,l,i);if(null!==h)return h;const d=this._extendAndHitTestLineSegment(e,c,a,i);if(null!==d)return d;let u=(0,n.distanceToSegment)(l,a,e);return u.distance<=3?this._hitTestResult:(u=(0,n.distanceToSegment)(o,c,e),u.distance<=3?this._hitTestResult:this._data.fillBackground?this._hitTestBackground(e,o,a,i):null)}getColor(){const e=(0,s.ensure)(this._data);return void 0===e.transparency?e.backcolor:(0,a.generateColor)(e.backcolor,e.transparency,this._forceOverrideTransparency)}_drawImpl(e){if(null===this._data||this._data.points.length<2||this._data.linewidth<=0&&!this._data.fillBackground)return;const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s,bitmapSize:o}=e,{extendLeft:n,extendRight:a,linewidth:c}=this._data,d=(0,r.box)(...this._data.points),u=this._data.linewidth?Math.max(1,Math.floor(this._data.linewidth*i)):0,_=this._data.fillBackground?this.getColor():void 0,p=Math.max(1,Math.floor(i)),m=n?-c:Math.round(d.min.x*i),g=a?o.width+c:Math.round(d.max.x*i),S=Math.round(d.min.y*s),v=Math.round(d.max.y*s);(0,h.fillRectWithBorder)(t,m,S,g,v,p,void 0===_?void 0:{color:_},0===u?void 0:{color:this._data.color,lineStyle:l.LINESTYLE_SOLID,borderWidth:u,borderMode:"center"})}_extendAndHitTestLineSegment(e,t,i,s){const r=this._extendAndClipLineSegment(t,i,s);if(null!==r){if((0,n.distanceToSegment)(r[0],r[1],e).distance<=3)return this._hitTestResult}return null}_extendAndClipLineSegment(e,t,i){const o=(0,s.ensureNotNull)(this._data);if((0,r.equalPoints)(e,t)&&!o.extendLeft&&!o.extendRight)return null;const n=Math.min(e.x,t.x),a=Math.max(e.x,t.x),l=o.extendLeft?0:Math.max(n,0),c=o.extendRight?i:Math.min(a,i);return l>c||c<=0||l>=i?null:[new r.Point(l,e.y),new r.Point(c,t.y)]}_hitTestBackground(e,t,i,s){const n=this._extendAndClipLineSegment(t,i,s);return null!==n&&(0,o.pointInBox)(e,(0,r.box)(n[0],n[1]))?this._backHitTestResult:null}}},993171:(e,t,i)=>{"use strict";i.d(t,{PrePostMarket:()=>v,defaultPrePostMarketPreferences:()=>S});var s=i(987088),r=i(458963),o=i(742391),n=i(949529),a=i(506387);class l extends a.PriceLineAxisView{constructor(e,t){super(),this._model=e,this._source=t}_value(){const e=this._model.mainSeries(),t=e.priceScale(),i=e.firstValue();if(null===i)return{noData:!0};const s=this._source.price(),r=this._source.currentSession();if(null===s||"pre_market"!==r&&"post_market"!==r)return{noData:!0};const o=t.priceToCoordinate(s,i);return{noData:!1,floatCoordinate:o,coordinate:o,color:"",formattedPricePercentage:"",formattedPriceAbsolute:"",formattedPriceIndexedTo100:"",text:"",index:0}}_priceLineColor(e){const t=this._source.properties().childs()
;return"pre_market"===this._source.currentSession()?t.preMarketColor.value():t.postMarketColor.value()}_lineWidth(){return this._source.properties().childs().lineWidth.value()}_lineStyle(){return this._source.properties().childs().lineStyle.value()}_isVisible(){if(!this._source.canBeVisibleOnSymbolAndInterval()||!this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value())return!1;const e=this._source.price(),t=this._source.currentSession();return null!==e&&("pre_market"===t||"post_market"===t)}}var c=i(444372),h=i(229765),d=i(246733);class u extends h.PriceAxisView{constructor(e,t){super(),this._model=e,this._source=t}_updateRendererData(e,t,s){if(e.visible=!1,t.visible=!1,!this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value())return;const r=this._model.mainSeries(),o=r.priceScale(),n=r.firstValue();if(null===n)return;if(!this._source.canBeVisibleOnSymbolAndInterval())return;const a=this._source.price(),l=this._source.currentSession();if(null==a||"pre_market"!==l&&"post_market"!==l)return;e.visible=!0,t.visible=!0,e.text=o.formatPriceAbsolute(a),t.text="pre_market"===l?c.t(null,void 0,i(138429)):c.t(null,void 0,i(306930)),s.coordinate=o.priceToCoordinate(a,n);const h=this._source.properties().childs();s.background="pre_market"===l?(0,d.resetTransparency)(h.preMarketColor.value()):(0,d.resetTransparency)(h.postMarketColor.value())}}var _=i(955831),p=i(315801);class m extends _.HorizontalLinePaneView{constructor(e,t,i){super(),this._model=e,this._source=t;const s={doubleClickHandler:i,doubleTapHandler:i};this._lineRenderer.setHitTest(new p.HitTestResult(p.HitTarget.Regular,s))}_updateImpl(){const e=this._lineRendererData;e.visible=!1;const t=this._model.mainSeries(),i=this._source.properties().childs();if(!i.visible.value()||!t.isVisible())return;const s=t.priceScale(),r=t.firstValue();if(null===r)return;if(!this._source.canBeVisibleOnSymbolAndInterval())return;const o=this._source.price(),n=this._source.currentSession();null===o||"pre_market"!==n&&"post_market"!==n||(e.visible=!0,e.y=s.priceToCoordinate(o,r),e.linestyle=i.lineStyle.value(),e.linewidth=i.lineWidth.value(),e.color="pre_market"===n?i.preMarketColor.value():i.postMarketColor.value())}}var g=i(964824);const S={visible:!0,lineStyle:r.LINESTYLE_DOTTED,lineWidth:1,preMarketColor:"#fb8c00",postMarketColor:s.colorsPalette["color-tv-blue-500"]};class v extends n.CustomSourceBase{constructor(e,t,i){super(e,t),this._extraHoursPrice=null,this._currentSession="holiday",this._quotesProvider=t.mainSeries().quotesProvider(),this._prePostMarketLinePaneView=new m(t,this,i),this._prePostPriceAxisView=new u(t,this),this._prePostLabelPaneView=new o.PanePriceAxisView(this._prePostPriceAxisView,t.mainSeries(),t),this._prePostPriceLineAxisView=new l(t,this),this._quotesProvider.quotesUpdate().subscribe(this,this._updateQuotes),this._updateQuotes()}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this)}paneViews(e){return this._isMainSourcePane(e)?[this._prePostMarketLinePaneView]:[]}
labelPaneViews(e){return this._isMainSourcePane(e)?[this._prePostLabelPaneView]:[]}priceAxisViews(e,t){return this._isMainSourcePane(e)?e.findTargetPriceAxisViews(this,t,[this._prePostPriceAxisView],[this._prePostPriceLineAxisView]):[]}priceScale(){return this._model.mainSeries().priceScale()}updateAllViews(e){this._prePostMarketLinePaneView.update(e),this._prePostPriceAxisView.update(e),this._prePostPriceLineAxisView.update(e),this._prePostLabelPaneView.update(e)}price(){return this._extraHoursPrice}currentSession(){return this._currentSession}canBeVisibleOnSymbolAndInterval(){return this._model.mainSeries().isPrePostMarketPricesAvailableProperty().value()}properties(){return this._model.mainSeries().properties().childs().prePostMarket}_updateQuotes(){const e=this._quotesProvider.quotes();null===e?this._extraHoursPrice=null:(this._extraHoursPrice=e.rtc,void 0!==e.current_session&&(this._currentSession=e.current_session));const t=this._model.mainSeries().properties().childs().prePostMarket.childs().visible.value(),i=this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value();this.canBeVisibleOnSymbolAndInterval()&&(t||i)&&(this.updateAllViews((0,g.sourceChangeEvent)(this.id())),this._model.updateSource(this))}_isMainSourcePane(e){return this._model.paneForSource(this._model.mainSeries())===e}}},985139:(e,t,i)=>{"use strict";var s;i.d(t,{PublishedChartsFilter:()=>s}),function(e){e.None="all",e.Following="following",e.Private="private"}(s||(s={}))},922850:(e,t,i)=>{"use strict";i.d(t,{PublishedChartsTimeline:()=>B});var s=i(444372),r=i(62802),o=i.n(r),n=i(838042),a=i(501867),l=i(985139),c=i(201089),h=i(345848),d=i(638456),u=i(337779),_=i(120780),p=i(223124),m=i(853965),g=i(650151),S=i(987088),v=i(934026),f=i(86441),b=i(315801),y=i(199471);function C(e,t){const i=Math.max(1,Math.floor(t)),s=Math.round(e.x*t)+i%2/2;let r=Math.round(e.size*t);(s+r/2)%1!=0&&(r+=1);const o=Math.min(Math.max(1,Math.round(t*e.borderWidth)),r/2);let n;const a=("up"===e.direction?-1:1)*(e.yInverted?-1:1),l=a*(Math.round(e.size*t/2)+i%2);if(void 0!==e.fixedSpaceYPosition){const i=Math.round(e.fixedSpaceYPosition.itemSpacing*t),s=e.fixedSpaceYPosition.order,o=a*(r*s+i*(s+1));n=Math.round(e.fixedSpaceYPosition.basePosition*t)+o+l}else n=Math.round(e.y*t)+l;return{x:s,y:n,size:r,borderWidth:o,tickSize:i}}function w(e,t,i,s){var r;if(e.save(),i&&!s.highlightByAuthor&&(e.globalAlpha=.4),s.mine)!function(e,t,i){const{borderColor:s,backgroundColor:r,doNotFill:o,direction:n,yInverted:a}=i,{x:l,y:c,borderWidth:h,size:d,tickSize:u}=C(i,t.pixelRatio);e.strokeStyle=s,e.fillStyle=r,e.lineWidth=h;const _="up"===n!==a?-1:1;let p=Math.round(d/2/Math.tan(Math.PI/6))+u%2/2;(l+p/2)%1!=0&&(p-=1);e.translate(l,c+p/2*_),e.beginPath();const m=h/2;e.moveTo(0,-_*(p-m)),e.lineTo(d/2-m,h/2),e.lineTo(-d/2+m,h/2),e.lineTo(0,-_*(p-h/2)),e.closePath(),o||e.fill();e.stroke()}(e,t,s);else{0,function(e,t,i,s,r){const{borderColor:o,backgroundColor:n,label:a}=i,l=t.pixelRatio,{x:c,y:h,borderWidth:d,size:u}=C(i,l);e.strokeStyle=o,e.fillStyle=n,
e.lineWidth=d,e.beginPath();const _=u/2-d/2;e.arc(c,h,_,0,2*Math.PI,!0),e.closePath(),e.fill(),!1;e.stroke(),!s&&a&&u/2>=7&&(e.textAlign="center",e.textBaseline="middle",e.font=a.font,e.fillStyle=a.fontColor,(0,y.drawScaled)(e,l,l,(()=>{e.fillText(a.text,c/l,h/l)})))}(e,t,s,!1,null===(r=s.image)||void 0===r?void 0:r.imageElement)}e.restore()}class P{constructor(e,t,i,s){this._canvas=null,this._clickHandler=e,this._enterHandler=t,this._leaveHandler=i,this._data=null!=s?s:null}setData(e){this._data=e}hitTest(e,t){if(null===this._data)return null;for(let i=this._data.items.length-1;i>=0;--i){const s=this._hitTestDot(this._data.items[i],e,t.pixelRatio);if(s)return s}return null}draw(e,t){this._canvas=e.canvas,null!==this._data&&this._data.items.forEach(w.bind(null,e,t,this._data.highlightByAuthor))}_hitTestDot(e,t,i){const s=new f.Point(e.x,C(e,i).y/i);if((0,v.pointInCircle)(t,s,Math.max(e.size/2,8))){const t=this._canvas,i=null===t?void 0:{mouseEnterHandler:()=>this._enterHandler(e,s.y,t),mouseLeaveHandler:()=>this._leaveHandler(),clickHandler:i=>this._clickHandler(e,s.y,t,i),tapHandler:i=>this._clickHandler(e,s.y,t,i)};return new b.HitTestResult(b.HitTarget.Regular,{activeItem:e.originalItem.id,...i})}return null}}var T=i(511131),M=i(422333);const x={green:{border:(0,S.getHexColorByName)("color-minty-green-700"),background:(0,S.getHexColorByName)("color-minty-green-a700")},red:{border:(0,S.getHexColorByName)("color-ripe-red-700"),background:(0,S.getHexColorByName)("color-ripe-red-500")},neutral:{border:(0,S.getHexColorByName)("color-tan-orange-700"),background:(0,S.getHexColorByName)("color-tan-orange-500")},yellow:{border:"#EAC300",background:"#FFD400"},blue:{border:"#047ACE",background:"#0496FF"}};function I(e){var t,i,s,r;return e.hovered||e.highlightByAuthor?null!==(i=null===(t=e.overrideBorderWidth)||void 0===t?void 0:t.hoveredWidth)&&void 0!==i?i:4:null!==(r=null===(s=e.overrideBorderWidth)||void 0===s?void 0:s.width)&&void 0!==r?r:2}const L=(0,c.getLogger)("Chart.PublishedChartsTimeline");class k extends class{constructor(e,t){this._tooltip=null,this._hoveredBarsMarkData=null,this._destroyed=!1,this._invalidated=!0,this._originalData=[],this._source=e,this._model=t,this._renderer=new P(this._onItemClicked.bind(this),this._showItem.bind(this),this._hideItem.bind(this)),this._createTooltipRenderer().then((e=>{this._destroyed?null==e||e.destroy():this._tooltip=e})),e.properties().childs().visible.subscribe(null,(()=>{var e;null===(e=this._tooltip)||void 0===e||e.hide(!0)}))}destroy(){var e;this._destroyed=!0,null===(e=this._tooltip)||void 0===e||e.destroy()}source(){return this._source}update(){this._invalidated=!0}renderer(e,t){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}onClickOutside(e){e.isTouch&&null!==this._tooltip&&!this._tooltip.contains(e.target)&&this._tooltip.hide(!0)}_extractBarMarksRendererItemData(e,t){var i,s;const r=null!==(i=t.overridedTheme)&&void 0!==i?i:x[t.theme],o=this._calculateSize(e,t),n=this._calculateY(e,o,t)
;return null===this._hoveredBarsMarkData||this._hoveredBarsMarkData.id!==t.id||this._hoveredBarsMarkData.x===t.x&&this._hoveredBarsMarkData.y===Math.round(n)||(null===(s=this._tooltip)||void 0===s||s.hide(!0),this._hoveredBarsMarkData=null),{x:t.x,y:this._calculateY(e,o,t),direction:t.direction,borderColor:r.border,borderWidth:I(t),backgroundColor:r.background,size:o,doNotFill:!t.public,yInverted:t.yInverted,label:void 0===t.label?void 0:{text:t.label,fontColor:t.labelFontColor,font:(0,T.makeFont)(Math.ceil(Math.max(10,Math.min(o/2,20))),M.CHART_FONT_FAMILY,"bold")},originalItem:t}}_onItemClicked(e,t,i,s){s.isTouch&&this._showItem(e,t,i)}async _showItem(e,t,i){var s;const r=await this._tooltipProps(e);if(null===r)return;const o=this._model.timeScale().barSpacing(),n=this._calculateSize(o,e.originalItem);this._hoveredBarsMarkData={x:e.x,y:Math.round(this._calculateY(o,n,e.originalItem)),id:e.originalItem.id},null===(s=this._tooltip)||void 0===s||s.show({itemSize:n,container:(0,g.ensureNotNull)(i.parentElement),x:e.x,y:t,factoryProps:r,onClickOutside:()=>{var e;return null===(e=this._tooltip)||void 0===e?void 0:e.hide(!0)}})}_hideItem(){var e;null===(e=this._tooltip)||void 0===e||e.hide()}_calculateSize(e,t){return Math.min(553,Math.max(7,t.minSize,.8*e))}_updateImpl(){this._originalData=this._source.getPlatesViewData();const e=this._model.timeScale().barSpacing(),t=this._originalData.map(this._extractBarMarksRendererItemData.bind(this,e));this._renderer.setData({items:t,barSpacing:e,highlightByAuthor:!1})}}{constructor(){super(...arguments),this._profileDataCache=new Map}_extractBarMarksRendererItemData(e,t){const i=super._extractBarMarksRendererItemData(e,t);return{...i,fixedSpaceYPosition:{basePosition:t.y,order:t.order,itemSpacing:.2857142857142857*e},mine:t.mine,borderWidth:t.hovered?i.borderWidth:t.public?1:2,doNotFill:!t.public,direction:t.direction}}async _createTooltipRenderer(){const[{TooltipRenderer:e},{PublishedChartsTimelineTooltip:t}]=await Promise.all([Promise.all([i.e(88548),i.e(6744),i.e(43487),i.e(50690),i.e(70354)]).then(i.bind(i,159217)),Promise.all([i.e(88548),i.e(6744),i.e(43487),i.e(50690),i.e(70354)]).then(i.bind(i,286676))]);return new e(t)}_calculateY(e,t,i){const s=("up"===i.direction?-1:1)*(i.yInverted?-1:1),r=s*(t*i.order+.2857142857142857*t*(i.order+1));return i.y+t/2*s+r}_onItemClicked(e,t,i,s){super._onItemClicked(e,t,i,s),s.isTouch||this.source().showIdea(e.originalItem.id,!1)}async _tooltipProps(e){var t;const i=(0,g.ensureDefined)(e.originalItem.username);let s=this._profileDataCache.get(i);if(void 0===s){try{s=await function(e){return fetch(`/api/v1/user/profile/${e}/?avatars_fallback=true&by=username`).then((e=>e.json()))}(i)}catch(e){return L.logWarn(`An error ocurred while loading profile data: ${e}`),null}this._profileDataCache.set(i,s)}return Promise.resolve({avatarUrl:null===(t=s.avatars)||void 0===t?void 0:t.mid,badges:s.badges,title:(0,g.ensureDefined)(e.originalItem.title),username:i,onTitleClicked:()=>this.source().showIdea(e.originalItem.id,!1)})}}
var A=i(888929),E=i(314802);const D=(0,c.getLogger)("Chart.PublishedChartsTimeLine");class B extends n.BarsMarksContainer{constructor(e,t){let i=o().getValue("PublishedChartsTimeline.filter",l.PublishedChartsFilter.None);window.is_authenticated||(i=l.PublishedChartsFilter.None);const s=new m.DefaultProperty("publishedchartstimeline",{filter:i});super(e,s),this.setId("PublishedChartsTimeline"),this._paneView=new k(this,e),this._paneViews=[this._paneView],this._currentRange=null,this._properties.childs().visible.subscribe(this,(()=>{this._getData(this._currentRange)})),s.childs().filter.subscribe(this,(e=>{o().setValue("PublishedChartsTimeline.filter",e.value()),this.clearMarks(),this._getData(this._currentRange)})),this._containsData=e.isSnapshot(),this._containsData&&this._properties.childs().visible.setValue(!0),this.setUserEditEnabled(!1),this._onIdeaClickedHandler=t}destroy(){this._onIdeaClickedHandler=null,this._boundOnMessage&&(a.pushStreamMultiplexer.off("ideas",this._boundOnMessage),a.pushStreamMultiplexer.off("ideas.post",this._boundOnMessage),this._boundOnMessage=null),this._paneView.destroy(),super.destroy()}name(){return"Ideas on chart"}title(){return s.t(null,void 0,i(5400))}zorder(){return A.sortSourcesPreOrdered.BarMarks}paneViews(){return this._model.isInReplay()||!this._properties.childs().visible.value()?[]:this._paneViews}showIdea(e,t){var i;const s=this._marks[e];s?((0,h.trackEvent)("GUI","View published idea"),t&&(0,h.trackEvent)("GUI","Ideas navigation arrow"),(0,d.onWidget)()||this._containsData||(0,E.isOnMobileAppPage)("any")?window.open(`${this._getBaseUrl()}${s.published_chart_url||"/v/"+s.image_url+"/"}`):null===(i=this._onIdeaClickedHandler)||void 0===i||i.call(this,{chartId:s.image_url,chartName:s.name,publishedUrl:s.published_chart_url,shortSymbol:s.short_name})):D.logDebug("PublishedChartsTimeline.showIdea: unexpected published chart id")}state(e){const t={type:"BarsMarksContainer",id:this.id(),zorder:this.zorder(),pinnedTooltips:this._pinnedTooltips};return e&&this._properties.childs().visible.value()&&(t.marks=this.getPublishedPlates()),t}restoreData(e,t){null!=e.pinnedTooltips&&(this._pinnedTooltips=e.pinnedTooltips),t&&void 0!==e.marks&&(this._marks=e.marks)}onClickOutside(e){this._paneView.onClickOutside(e)}_getIndex(e){return this.timeScale().timePointToIndex(e,1)}_initialize(){a.pushStreamMultiplexer&&(this._boundOnMessage=this._onMessage.bind(this),a.pushStreamMultiplexer.on("ideas",this._boundOnMessage),a.pushStreamMultiplexer.on("ideas.post",this._boundOnMessage))}_plateViewData(e){return{title:e.title,user_id:e.user__id,username:e.username,suggested:e.is_hot,mine:e.user__id===window.user.id,public:e.is_public}}_getData(e,t){const i=this._model.mainSeries().properties().childs(),s=this._model.mainSeries().symbolInfo();if(this._currentRange=e,!s||!this._properties.childs().visible.value()&&!t)return Promise.resolve([]);let r=s.base_name.length>1?s.base_name:[s.pro_name];const o=this.roundRange(this._rangeDifference(e));r=(0,u.uniq)(r),r=r.sort();const n=new FormData
;n.append("interval",i.interval.value()),n.append("legs",JSON.stringify(r)),n.append("startTickmark",o.start.toString()),n.append("endTickmark",o.end.toString()),n.append("filter",this.properties().childs().filter.value());const a=(0,p.makeCancelable)(new Promise(((e,t)=>{(0,_.fetch)("/charttimeline/",{method:"POST",body:n,headers:new Headers({acccept:"application/json","X-Requested-With":"XMLHttpRequest"})}).then((i=>{i.ok?i.json().then(e):t()})).catch(t)})));return a.promise.then((t=>{t.forEach((e=>{this._marks[e.id]=e})),this._loadedRange=this._rangeUnion(e,this._loadedRange);const i=this._requests.indexOf(a);~i&&this._requests.splice(i,1),this.updateAllViewsAndRepaint()})),this._requests.push(a),a.promise}_onMessage(e,t,i,s){if(this._containsData)return;const r=this._model.mainSeries(),o=r.symbolInfo(),n=o&&o.base_name;if(!n)return;const a=r.properties().childs();e.interval===a.interval.value()&&~n.indexOf(e.pro_symbol)&&(this._marks[e.id]=e,this.updateAllViewsAndRepaint())}_getBaseUrl(){if((0,d.onWidget)()&&window.locale_domains){const e=window.locale||"en",t=window.locale_domains[e]?window.locale_domains[e]:window.locale_domains.en;return t?document.location.protocol+"//"+t:""}return""}}},529426:(e,t,i)=>{"use strict";function s(e){if(!e)return"";if(["AMEX"].includes(e))return"Arca";if(["NYSE ARCA & MKT"].includes(e))return"NYSE Arca";if(["Cboe BZX"].includes(e))return"Cboe One";if(["FTSEST"].includes(e))return"FTSE ST";const t=/^(CME|COMEX|CBOT|NYMEX)_MINI$/.exec(e);return null!==t?t[1]:e}i.d(t,{redefineExchangeName:()=>s})},154765:(e,t,i)=>{"use strict";i.d(t,{replayModeProperty:()=>c});var s=i(62802),r=i(638456),o=i(125226),n=i(152633);const a="replay_mode";function l(){return(0,o.isFeatureEnabled)("multichart_replay")&&!r.CheckMobile.any()?s.getValue(a,"ActiveChart"):"ActiveChart"}const c=(0,n.createPrimitiveProperty)(l());s.onSync.subscribe(null,(()=>c.setValue(l()))),(0,o.isFeatureEnabled)("multichart_replay")&&c.subscribe(null,(()=>s.setValue(a,c.value())))},944876:(e,t,i)=>{"use strict";i.d(t,{allPriceScaleSelectionStrategyInfo:()=>c,createPriceScaleSelectionStrategy:()=>l});var s=i(650151),r=i(444372),o=i(161488);class n{constructor(e){this._priceScalesLimit=8,this._metaInfo=e}metaInfo(){return this._metaInfo}findSuitableScale(e,t,i,s){if(void 0!==s)return this._tryToGetDesiredPriceScale(e,t,s,i);if((0,o.isStudy)(t)){const s=t.metaInfo();if("Volume"===s.shortId&&e.containsMainSeries())return e.createPriceScaleAtPosition("overlay");const r=t.desiredPriceScalePosition();if(null!==r)return this._tryToGetDesiredPriceScale(e,t,r,i);if(void 0!==i&&((0,o.isStudy)(i)||e.isMainPane())&&s.is_price_study)return this._getPriceScaleTheSameAsForSource(i,e)}let r=!1;if((0,o.isStudy)(t)){const i=t.metaInfo().groupingKey;if(void 0!==i){const t=e.model().findNonOverlayStudyWithGroupingKey(i,e);if(null!==t)return this._getPriceScaleTheSameAsForSource(t.study,t.pane)}r=Boolean(t.metaInfo().is_price_study)}else t===e.model().mainSeries()&&(r=!0);if(r){const t=this._findFirstScaleForPriceStudy(e);if(null!==t)return t}
return this.createNewPriceScaleIfPossible(e)}canCreateNewPriceScale(e){return e.leftPriceScales().length+e.rightPriceScales().length<this._priceScalesLimit}_getPriceScaleTheSameAsForSource(e,t){return t.isOverlay(e)?t.createPriceScaleAtPosition("overlay"):(0,s.ensureNotNull)(e.priceScale())}_priceScaleIsPrice(e,t){const i=e.mainSource();return!!i&&(i===t.mainSeries()||!!(0,o.isStudy)(i)&&Boolean(i.metaInfo().is_price_study))}_findFirstScaleForPriceStudy(e){const t=e.model();for(let i=0;i<this._priceScalesLimit;i++){if(e.rightPriceScales().length>i&&this._priceScaleIsPrice(e.rightPriceScales()[i],t))return e.rightPriceScales()[i];if(e.leftPriceScales().length>i&&this._priceScaleIsPrice(e.leftPriceScales()[i],t))return e.leftPriceScales()[i]}return null}_targetPriceScaleIndex(e,t){if(e.mainSource()===t.mainSeries())return 0}_tryToGetDesiredPriceScale(e,t,i,r){switch(i){case"left":return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("left"):e.createPriceScaleAtPosition("overlay");case"right":return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("right"):e.createPriceScaleAtPosition("overlay");case"as-series":return void 0!==r?(0,s.ensureNotNull)(r.priceScale()):e.isMainPane()?(0,s.ensureNotNull)((0,s.ensureNotNull)(e.mainDataSource()).priceScale()):this.createNewPriceScaleIfPossible(e);case"overlay":return e.createPriceScaleAtPosition("overlay")}}}const a=[{name:"left",title:r.t(null,void 0,i(665323)),ctor:class extends n{constructor(e){super(e)}apply(e){const t=e.model();e.rightPriceScales().slice(0).forEach((i=>e.movePriceScale(i,"left",this._targetPriceScaleIndex(i,t))))}createNewPriceScaleIfPossible(e){return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("left"):e.createPriceScaleAtPosition("overlay")}}},{name:"right",title:r.t(null,void 0,i(214113)),ctor:class extends n{constructor(e){super(e)}apply(e){const t=e.model();e.leftPriceScales().slice(0).forEach((i=>e.movePriceScale(i,"right",this._targetPriceScaleIndex(i,t))))}createNewPriceScaleIfPossible(e){return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("right"):e.createPriceScaleAtPosition("overlay")}}},{name:"auto",title:r.t(null,void 0,i(86951)),ctor:class extends n{constructor(e){super(e)}apply(e){if(e.containsMainSeries()){const t=(0,s.ensureNotNull)((0,s.ensureNotNull)(e.mainDataSource()).priceScale());e.movePriceScale(t,"right",0)}const t=e.model();for(;e.leftPriceScales().length>e.rightPriceScales().length;){const i=e.leftPriceScales()[e.leftPriceScales().length-1];e.movePriceScale(i,"right",this._targetPriceScaleIndex(i,t))}for(;e.rightPriceScales().length-e.leftPriceScales().length>1;){const i=e.rightPriceScales()[e.rightPriceScales().length-1];e.movePriceScale(i,"left",this._targetPriceScaleIndex(i,t))}}createNewPriceScaleIfPossible(e){if(!this.canCreateNewPriceScale(e))return e.createPriceScaleAtPosition("overlay");const t=e.leftPriceScales().length<e.rightPriceScales().length?"left":"right";return e.createPriceScaleAtPosition(t)}}}];function l(e){const t=(0,
s.ensureDefined)(a.find((t=>t.name===e)));return new t.ctor(t)}function c(){return a}},199833:(e,t,i)=>{"use strict";i.d(t,{SeriesBase:()=>Ii});var s,r=i(650151),o=i(638456),n=i(345848),a=i(251954),l=i(201089),c=i(974655),h=i(544421),d=i(195447),u=i(534741),_=i(291784),p=i(354950),m=i.n(p),g=i(444331);!function(e){e.Regular="regular",e.Extended="extended",e.PreMarket="premarket",e.PostMarket="postmarket"}(s||(s={}));var S=i(624444),v=i(339315),f=i(833642),b=i(444372),y=i(244842),C=i(665570),w=i(985715),P=i(29469),T=i(529426);const M=b.t(null,void 0,i(389659)),x=(0,o.onWidget)(),I=y.enabled("hide_unresolved_symbols_in_legend");class L extends w.StatusProviderBase{constructor(e,t,i,s){super(t),this._series=e,this._statusViewProperties=i,this._options=s||{}}text(){return(0,P.generateTitleForGui)(this._getTitleGenerationOptions())}getSplitTitle(){return(0,P.generateSplitTitleForGui)(this._getTitleGenerationOptions())}bold(){return!1}size(){return this._statusViewProperties.childs().fontSize.value()+"px"}errorStatus(){const e=this._series.seriesErrorMessage();return null!==e?{error:e,title:M}:null}_getTitleGenerationOptions(){var e,t;const i=this._series.symbolInfo(),s=this._statusViewProperties.childs(),r=this._series.symbolTextSourceProxyProperty().value();let o;if(s.showExchange.value()&&i){const s=(0,g.isEconomicSymbol)(i)&&(null!==(t=null===(e=i.source2)||void 0===e?void 0:e.description)&&void 0!==t?t:i.source);o=s||(x||"forex"===i.type?i.exchange:(0,T.redefineExchangeName)(null==i?void 0:i.listed_exchange))}const n=null!==null?null:void 0;return{description:A(r,i),exchange:o,symbol:I&&null===i?"":this._series.symbol(),interval:s.showInterval.value()&&!this._options.hideResolution?this._series.interval():void 0,style:this._series.properties().childs().style.value(),inputs:this._series.getInputsProperties().state(),boxSize:this._series.data().boxSize,reversalAmount:this._series.data().reversalAmount,ticker:k(r,i),priceSource:n}}}function k(e,t){return"ticker-and-description"!==e?"":null!==t?t.name:void 0}function A(e,t){if(null!==t)return"ticker"===e?t.name:"long-description"===e&&void 0!==t.long_description?t.long_description:(0,C.getTranslatedSymbolDescription)({pro_name:t.pro_name||void 0,short_name:t.name||void 0,description:t.description||void 0,short_description:t.short_description||void 0,local_description:t.local_description||void 0,language:t.language||void 0})}class E extends f.StatusView{constructor(e,t,i,s){super(new L(e,t,i,s)),this._invalidated=!0,this._series=e,this._series.onRestarted().subscribe(this,this.update),this._series.dataEvents().symbolResolved().subscribe(this,this.update),this._series.dataEvents().completed().subscribe(this,this.update),this._series.boxSizeValue().subscribe(this.update.bind(this)),i.childs().symbolTextSource.listeners().subscribe(this,this.update)}getSeriesPrecision(){let e=4;const t=this._series.symbolInfo();return t&&t.pricescale&&(e=Math.round(Math.log(t.pricescale)/Math.log(10))),e}round(e){const t=this.getSeriesPrecision(),i=Math.round(e*Math.pow(10,t))/Math.pow(10,t)
;return i?i.toString():""}update(){this._invalidated=!0}text(){return this._updateImpl(),super.text()}color(){return this._updateImpl(),super.color()}bold(){return this._updateImpl(),super.bold()}size(){return this._updateImpl(),super.size()}getSplitTitle(){return this._updateImpl(),this._statusProvider.getSplitTitle()}_updateImpl(){this._invalidated&&(this._bold=this._statusProvider.bold(),this._size=this._statusProvider.size(),this._text=this._statusProvider.text(),this._invalidated=!1)}}var D=i(150335),B=i(782086),R=i(168883),N=i(885482),V=i(145352),O=i(616117);const F=o.CheckMobile.any(),W=y.enabled("hide_resolution_in_legend");class z extends B.DataWindowView{constructor(e,t){super(),this._invalidated=!0,this._series=e,this._model=t,this._valuesProvider=this._createValuesProvider(e,t),this._items=this._valuesProvider.getItems().map((e=>new B.DataWindowItem(e.id,e.title,"",e.unimportant))),this.update()}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}series(){return this._series}_updateImpl(){var e,t;const i=this._series.symbolInfo();if(i){const e=[i.name];W||e.push((0,R.translatedIntervalString)(this._series.interval())),(0,g.isEconomicSymbol)(i)&&i.source?e.push(i.source):e.push((0,o.onWidget)()||"forex"===i.type?i.exchange:i.listed_exchange),this._header=e.join(` ${g.symbolTitleSeparator} `),this._title=i.description}else this._header=this._series.symbol();let s=this._model.crossHairSource().appliedIndex();y.enabled("use_last_visible_bar_value_in_legend")&&!(0,D.isNumber)(s)&&(s=null!==(t=null===(e=this._model.timeScale().visibleBarsStrictRange())||void 0===e?void 0:e.lastBar())&&void 0!==t?t:NaN);const r=this._valuesProvider.getValues(s);for(let e=0;e<r.length;++e){const t=r[e],i=this._items[e];i.setValue(t.value),i.setVisible(t.visible),i.setColor(t.color)}}_createValuesProvider(e,t){return new V.SeriesValuesProvider(e,t)}_showLastPriceAndChangeOnly(){return F&&(null===this._model.crossHairSource().pane||(0,O.isLineToolName)(N.tool.value())||null!==this._model.lineBeingEdited())}}const H={open:b.t(null,{context:"in_legend"},i(978155)),high:b.t(null,{context:"in_legend"},i(556723)),low:b.t(null,{context:"in_legend"},i(304292)),close:b.t(null,{context:"in_legend"},i(977297)),hl2:b.t(null,{context:"in_legend"},i(605801)),hlc3:b.t(null,{context:"in_legend"},i(698865)),ohlc4:b.t(null,{context:"in_legend"},i(242659))};class U extends V.SeriesValuesProvider{constructor(e,t){super(e,t);const i=t.properties().childs().paneProperties.childs().legendProperties.childs();this._showBarChange=i.showBarChange,this._showSeriesOHLC=i.showSeriesOHLC,this._showVolume=i.showVolume,this._seriesStyle=e.properties().childs().style;const s=this._emptyValues[0],r=this._emptyValues[1],o=this._emptyValues[2];s.title=H.open,r.title=H.high,o.title=H.low,s.unimportant=!0,r.unimportant=!0,o.unimportant=!0,this._emptyValues[3].title=H.close,this._emptyValues[6].title="",this._emptyValues[4].title=""}getValues(e){
const t=super.getValues(e),i=this._showSeriesOHLC.value(),s=this._showBarChange.value(),r=t[6];if(this._showLastPriceAndChangeOnly()){const e=t[5];return e.visible=e.visible&&i,r.visible=r.visible&&s,t}const o=this._series.style(),n=12!==o&&16!==o,a=12!==o,l=12!==o;r.visible=r.visible&&s&&l;const c=t[7];c.visible=c.visible&&this._showVolume.value();const h=(0,g.isPriceSourceStyle)(this._seriesStyle.value()),d=i&&!h,u=i&&h;if(t[0].visible=d&&n,t[1].visible=d,t[2].visible=d,t[3].visible=d&&a,t[4].visible=u,16===o){const e=this._series.properties().childs().hlcAreaStyle.childs();t[1].color=e.highLineColor.value(),t[2].color=e.lowLineColor.value(),t[3].color=e.closeLineColor.value()}return t}}var G=i(837032);const q=b.t(null,void 0,i(313468));class j extends z{constructor(e,t){super(e,t),this._backgroundColorSpawn=t.backgroundTopColor().spawn(),this._backgroundColorSpawn.subscribe(this.update.bind(this));const i=t.properties().childs().paneProperties.childs().legendProperties.childs();this._visibilityProperty=(0,G.combineProperty)(((e,t,i)=>e||t||i),i.showBarChange.weakReference(),i.showSeriesOHLC.weakReference(),i.showVolume.weakReference()),this._visibilityProperty.subscribe(this,this.update)}areValuesVisible(){return this._visibilityProperty.value()}additional(){const e=this._series.dataPoweredBy();return null!==e&&e.length>0?b.t(null,void 0,i(493345))+" "+e:null}marketTitle(){const e=this._series.marketStatusModel().status().value();return this._showLastPriceAndChangeOnly()&&("pre_market"===e||"post_market"===e)?`${q}:`:""}destroy(){this._backgroundColorSpawn.destroy(),this._visibilityProperty.destroy()}_createValuesProvider(e,t){return new U(e,t)}}var Y=i(515625),K=i(261066),X=i(223699),$=i(547944),Z=i(736029),Q=i(541558);let J=0;class ee{constructor(e,t){this._extrapolatedData=[],this._cacheForFuture=!1,this._modelId=J++,this._builderCache=null,this._uniqueId=(0,Q.randomHashN)(6),this._resolution=t,this._symbolInfo=e,this._valid=Boolean(e.timezone)&&Boolean(e.session),this._session=new $.SessionInfo(e.timezone,e.session,e.session_holidays,e.corrections)}syncSourceTarget(){return{uniqueId:this._uniqueId,resolution:this._resolution,symbolInfo:this._symbolInfo,session:this._session.state()}}getSymbolInfo(){return this._symbolInfo}getSession(){return this._session}getResolution(){return this._resolution}uniqueId(){return this._modelId}distance(e,t){if(!this.isValid())return{success:!1};if(e>t)return{success:!1};if(e===t)return{success:!0,result:0};let i=this._extrapolatedData.length,s=0!==i?this._extrapolatedData[0]:null,r=null!==s?this._extrapolatedData[i-1]:null;const o=e<t;if(1e3*e===s&&this._cacheForFuture===o||(this._extrapolatedData=[1e3*e],i=1,s=null,r=null),null===s||null!==r&&1e3*t>r){const s=(0,Z.extrapolateBarsFrontToTime)(this._barBuilder(),r||1e3*e,1e3*t,2e3,!0);this._extrapolatedData=this._extrapolatedData.concat(s.times),i=this._extrapolatedData.length,this._cacheForFuture=o}if(r=this._extrapolatedData[i-1],r<1e3*t)return{success:!1};const n=this._extrapolatedData.indexOf(1e3*t);return-1===n?{success:!1
}:{success:!0,result:n}}projectTime(e,t){if(!this.isValid())return e;let i=this._extrapolatedData.length,s=i>0?this._extrapolatedData[0]:null,r=null!==s?this._extrapolatedData[i-1]:null;const o=t>=0;1e3*e===s&&this._cacheForFuture===o||(this._extrapolatedData=[1e3*e],i=1,s=null,r=null);const n=Math.abs(t);if(null===s||n>=i){const s=(0,Z.extrapolateBarsFrontByCount)(this._barBuilder(),r||1e3*e,Math.sign(t)*(n-i+1),!0);this._extrapolatedData=this._extrapolatedData.concat(s.times),i=this._extrapolatedData.length,this._cacheForFuture=o}return i<n?e:this._extrapolatedData[n]/1e3}isValid(){return this._valid}dataSize(){return this._extrapolatedData.length}createNewModelWithResolution(e){return new ee(this._symbolInfo,e)}_barBuilder(){return null===this._builderCache&&(this._builderCache=(0,$.newBarBuilder)(this._resolution,this._session,this._session)),this._builderCache}}var te=i(938550),ie=i(824837),se=i(147675),re=i(59171),oe=i.n(re);var ne=i(928691);const ae=(0,l.getLogger)("Chart.Definitions.Series");function le(e,t){return"TickByTick"===e?{mode:e,updatePeriod:t}:{mode:e}}function ce(e,t,i){const s=[];return(0,se.isDelay)(e.delay)?function(e){const t=[];return(0,se.witoutRealtime)(e)?t.push(le("DelayNoRealtime")):(0,se.isDelayForGuest)("MOEX",e)?t.push(le("MOEXDelayForGuest")):(0,se.isDelayForGuest)("TFEX",e)?t.push(le("TFEXDelayForGuest")):(0,se.isDelayForGuest)("CHIXAU",e)?t.push(le("CHIXAuDelayForGuest")):(0,se.isDelayForGuest)("NGM",e)?t.push(le("NGMDelayForGuest")):(0,se.isDelayForGuest)("ICESG",e)?t.push(le("ICESGDelayForGuest")):(0,se.isDelayForGuest)("TAIFEX",e)?t.push(le("TAIFEXDelayForGuest")):(0,se.isDelayForGuest)("TURQUOISE",e)?t.push(le("TURQUOISEDelayForGuest")):(0,se.isDelayForGuest)("ADX",e)?t.push(le("ADXDelayForGuest")):(0,se.isDelayForGuest)("LUXSE",e)?t.push(le("LUXSEDelayForGuest")):(0,se.isDelayForGuest)("NSENG",e)?t.push(le("NSENGDelayForGuest")):(0,se.isDelayForGuest)("TRADEGATE",e)?t.push(le("TRADEGATEDelayForGuest")):["BER","DUS","HAM","HAN","MUN"].some((t=>(0,se.isDelayForGuest)(t,e)))?t.push(le("DEForGuest")):["MIL"].some((t=>(0,se.isDelayForGuest)(t,e)))?t.push(le("MILDelayForGuest")):(0,se.isDelayWithoutMarketAgreement)(e)?t.push(le("DelayWithoutMarketAgreement")):t.push(le("DelayToRealtime")),t}(e):(0,se.isEod)(e,t)?(s.push(le("EOD")),s):((0,se.isTickByTick)(e,t)&&0!==i&&s.push(le("TickByTick",i)),function(e){return oe().hasBatsSymbols(e.full_name)}(e)&&s.push(le("BATSToRealtime")),s)}class he{constructor(e,t,i,s){this._dataUpdatedInfoStatus=new te.WatchedObject(null),this._symbolInfo=(0,ie.createWVFromGetterAndSubscription)(e.getter,e.onChange),this._status=(0,ie.createWVFromGetterAndSubscription)(t.getter,t.onChange),this._updatePeriod=(0,ie.createWVFromGetterAndSubscription)(i.getter,i.onChange),this._symbolInfo.subscribe(this._update.bind(this)),this._status.subscribe(this._update.bind(this)),this._updatePeriod.subscribe(this._update.bind(this)),this._resetSubscription=s,this._resetSubscription.subscribe(this,this._resetStatus)}destroy(){this._symbolInfo.destroy(),
this._status.destroy(),this._updatePeriod.destroy(),this._resetSubscription.unsubscribeAll(this)}status(){return this._dataUpdatedInfoStatus.readonly()}symbolName(){const e=this._symbolInfo.value();return null!==e?e.name:""}time(){const e=this._symbolInfo.value(),t=null!==e&&e.delay&&e.delay>0?e.delay:900;return Math.round(t/60)}listedExchange(){const e=this._symbolInfo.value();return null!==e?e.listed_exchange:""}async description(){const e=this._symbolInfo.value();if(null===e)return"";let t={};try{t=(0,r.ensureNotNull)(await(0,se.getExchange)(e))}catch(e){ae.logWarn(`Cannot get exchange ${(0,ne.errorToString)(e)}`)}return t.description||e.listed_exchange}exchange(){const e=this._symbolInfo.value();return null!==e?e.exchange:""}proName(){const e=this._symbolInfo.value();return null!==e?e.pro_name:""}proPerm(){const e=this._symbolInfo.value();return null!==e?e.pro_perm:""}firstReplacedByBatsExchange(){const e=this._symbolInfo.value();return e&&(0,se.firstReplacedByBatsExchange)(e)}_resetStatus(){this._dataUpdatedInfoStatus.setValue(null)}_update(){const e=this._symbolInfo.value();if(null===e)return void this._dataUpdatedInfoStatus.setValue(null);const t=this._status.value();if("string"==typeof t)return void this._dataUpdatedInfoStatus.setValue(null);if(2===t||1===t)return;const i=ce(e,t,this._updatePeriod.value());0!==i.length?this._dataUpdatedInfoStatus.setValue(i):this._dataUpdatedInfoStatus.setValue(null)}}var de=i(120780),ue=i(389137),_e=i(501867);const pe=(0,l.getLogger)("Chart.DataProblemModel");class me{constructor(e,t){this._mainDataProblem=new te.WatchedObject(null),this._supportPortalProblems=new te.WatchedObject([]),this._allDataProblems=new te.WatchedObject([]),this._pushStreamHandler=null,this._destroyed=!1,this._quotesProvider=e,this._quotesProvider.quotesUpdate().subscribe(this,this._update.bind(this)),this._resetSubscription=t,this._resetSubscription.subscribe(this,this._resetStatus),this._mainDataProblem.subscribe((()=>this._updateAllDataProblems())),this._supportPortalProblems.subscribe((()=>this._updateAllDataProblems())),this._requestSupportPortalProblems()}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this),this._resetSubscription.unsubscribeAll(this),null!==this._pushStreamHandler&&_e.pushStreamMultiplexer.off("support-portal-problem",this._pushStreamHandler),this._destroyed=!0}dataProblems(){return this._allDataProblems}_resetStatus(){this._mainDataProblem.setValue(null)}_update(e){void 0===e.values||void 0===e.values.data_problem?this._resetStatus():this._mainDataProblem.setValue((0,ue.clone)(e.values.data_problem))}_updateAllDataProblems(){const e=this._mainDataProblem.value(),t=this._supportPortalProblems.value();this._allDataProblems.setValue(null===e?t:[e,...t])}async _requestSupportPortalProblems(){{const e=await(0,de.fetch)(`/support/support-portal-problems/?language=${window.locale}`);if(this._destroyed)return;if(!e.ok)return void pe.logWarn("Couldn't load support portal problems");const t=(await e.json()).issues,i=()=>{
const e=t.filter((e=>e.show_on_chart&&!1!==e.is_active&&(void 0===e.language||e.language.some((e=>e===window.locale||"all"===e))))).map((e=>({severity:"low",title:e.title,text:e.description})));this._supportPortalProblems.setValue(e)};i(),this._pushStreamHandler=e=>{switch(e.action){case"created":t.push(e.data);break;case"modified":{const i=t.findIndex((t=>t.id===e.data.id));-1!==i?t[i]={...t[i],...e.data}:t.push(e.data);break}case"deleted":{const i=t.findIndex((t=>t.id===e.data.id));-1!==i&&t.splice(i,1);break}}i()},_e.pushStreamMultiplexer.on("support-portal-problem",this._pushStreamHandler)}}}var ge=i(356747),Se=i(246733),ve=i(229765),fe=i(909598),be=i(988124);function ye(e){return e<10?`0${e}`:e.toString()}function Ce(e,t=Date.now()/1e3){let i=Math.ceil(e-t);if(i<=0)return"";if(i<3600){const e=Math.floor(i/60),t=Math.ceil(i%60);return`${ye(e)}:${ye(t)}`}if(i<86400){const e=Math.floor(i/3600);i%=3600;const t=Math.floor(i/60);i%=60;const s=Math.ceil(i);return`${ye(e)}:${ye(t)}:${ye(s)}`}{const s=new Date(1e3*e),r=new Date(1e3*t),o=be.get_year(s),n=be.get_year(r),a=be.get_month(s),l=be.get_month(r),c=be.get_day_of_month(r),h=we(s)-we(r)>=0?0:-1;let d=12*(o-n)+(a-l)+h;if(d>0){const t=be.get_days_in_month(l,n);!function(e,t){const i=be.get_day_of_month(e);e.setUTCMonth(be.get_month(e)+t),be.get_day_of_month(e)!==i&&e.setUTCDate(0)}(r,d);const i=be.get_days_in_month(be.get_month(r),be.get_year(r)),s=c!==t&&i===be.get_day_of_month(r)?t-c:0;let o=Math.ceil((e-r.getTime()/1e3)/86400)+s;return o>=i&&(d++,o=0),`${d}M ${o}d`}if(-1===h){if(be.get_days_in_month(l,n)-i/86400<1/24)return"1M 0d"}let u=Math.floor(i/86400);i%=86400;let _=Math.ceil(i/3600);return 24===_&&(_=0,u+=1),u===be.get_days_in_month(a,o)?"1M 0d":`${u}d ${_}h`}}function we(e){return 86400*e.getUTCDate()+3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()}var Pe=i(740086),Te=i(964824);const Me=y.enabled("force_exchange_as_title"),xe=y.enabled("chart_style_hilo_last_price"),Ie=[0,1,2,14,15,3,16,9,8,10];xe&&Ie.push(12);const Le={alwaysShowGlobalLast:!1,visibleOnHistoryOnly:!1,showCountdown:!0,showSymbolLabel:!0,useSolidBodyColor:!0};class ke extends ve.PriceAxisView{constructor(e,t,i){super(),this._previousCountdown="",this._source=e,this._model=t,this._options={...Le,...i}}updateCountdown(){this._countdownText()!==this._previousCountdown&&(this.update((0,Te.sourceChangeEvent)(this._source.id())),this._model.updateSourcePriceScale(this._source))}_getSource(){return this._source}_getModel(){return this._model}_isCountdownEnabled(){return this._options.showCountdown}_countdownText(){{const e=this._source.barCloseTime();return null===e?"":Ce(e,this._currentTime()/1e3)}}_updateRendererData(e,t,i){var s;if(e.visible=!1,t.visible=!1,!this._source.isVisible())return;const o=this._source.properties().childs();if(!xe&&12===o.style.value())return;const n=this._model.timeScale().visibleBarsStrictRange(),a=this._source.data().last();if(null===n||null===a)return;if(this._options.visibleOnHistoryOnly&&n.contains(a.index))return
;const l=this._model.properties().childs().scalesProperties.childs();let c=l.showSeriesLastValue.value(),h=this._isCountdownEnabled()&&o.showCountdown.value()&&Ie.includes(o.style.value())&&(this._options.alwaysShowGlobalLast||n.contains(a.index)),d=this._options.showSymbolLabel&&l.showSymbolLabels.value();const u=l.seriesLastValueMode.value()===fe.PriceAxisLastValueMode.LastPriceAndPercentageValue,_=this._source.lastValueData(void 0,this._options.alwaysShowGlobalLast);if(_.noData)return;const p=8===o.style.value();if((c||h||d)&&p&&o.haStyle.childs().showRealLastPrice.value()){const e=this._source.lastValueData(void 0,!1),t=this._source.lastValueData(void 0,!0);e.noData||t.noData||e.index!==t.index||(c=!1,h=!1,d=!1)}const m=(0,Se.resetTransparency)(this._source.priceLineColor(_.color));if(this._options.useSolidBodyColor?(i.background=m,i.borderColor=void 0):(i.background=this._model.backgroundColorAtYPercentFromTop((null!==(s=i.fixedCoordinate)&&void 0!==s?s:i.coordinate)/(0,r.ensureNotNull)(this._model.paneForSource(this._source)).height()),i.borderColor=m),i.coordinate=_.coordinate,i.floatCoordinate=_.floatCoordinate,c||h){const t=this._axisFirstLineText(_,c);e.text=t,this._options.useSolidBodyColor?(i.textColor=this.generateTextColor(i.background),e.borderVisible=!1):(e.borderVisible=!0,i.textColor=m),e.textColor=i.textColor;const s=c&&u?(0,Pe.getOppositeModePriceText)(this._source.priceScale(),_):"";e.secondLine=s,i.secondLineTextColor=i.textColor;const r=h?this._countdownText():"";this._previousCountdown=r,e.thirdLine=r,i.thirdLineTextColor=(0,Se.generateColor)(i.textColor,25),0===t.length&&0===s.length&&0===r.length||(e.visible=!0)}d&&(t.text=this._paneText(d),t.visible=t.text.length>0)}_paneText(e){let t="";const i=this._source.symbolInfo();return Me?t=(0,g.displayedSymbolExchange)(i):e&&(t=(0,g.displayedSymbolName)(i)),t}_axisFirstLineText(e,t){return t?(0,Pe.getCurrentModePriceText)(this._source.priceScale(),e):""}_currentTime(){return window.ChartApiInstance.serverTime()}}var Ae=i(177126),Ee=i(175203),De=i(96080),Be=i(855611),Re=i(30574),Ne=i(217164),Ve=i(710455);const Oe={0:{background:"rgba(242, 54, 69, 0.15)",line:"#F23645"},1:{background:"rgba(255, 152, 0, 0.15)",line:"#FF9800"},2:{background:"rgba(8, 153, 129, 0.15)",line:"#089981"}};class Fe extends Ve.MediaCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(){return null}_drawImpl(e){if(null===this._data)return;const t=Oe[this._data.predictionCode],i=e.context;i.fillStyle=t.background,i.fillRect(Math.max(0,this._data.startX),0,e.mediaSize.width,e.mediaSize.height),i.strokeStyle=t.line,i.beginPath(),i.lineWidth=1;const s=Math.round(this._data.startX);i.moveTo(s,0),i.lineTo(s,e.mediaSize.height),i.stroke()}}class We{constructor(e,t,i,s){this._renderer=new Fe,this._startX=0,this._series=t,this._timeScale=e,this._lastKnownBarIndex=i,this._direction=s}update(){this._startX=this._timeScale.indexToCoordinate(this._lastKnownBarIndex)+.5*this._timeScale.barSpacing()+1}renderer(){const e=(0,
h.barFunction)("close"),t=this._series.data().bars(),i=e((0,r.ensureNotNull)(t.valueAt(this._lastKnownBarIndex))),s=e((0,r.ensureNotNull)(t.last()).value);let o=0;s>i?o=1:s<i&&(o=2);let n=1;return 0!==this._direction&&(n=this._direction===o?2:0),this._renderer.setData({startX:this._startX,predictionCode:n}),this._renderer}}var ze=i(234271);class He extends ve.PriceAxisView{constructor(e,t){super(),this._source=e,this._model=t}_updateRendererData(e,t,i){e.visible=!1;const s=this._source;if(!this._model.properties().childs().scalesProperties.childs().showSeriesPrevCloseValue.value())return;if(s.isDWM())return;const r=s.prevClose();if(null===r)return;const o=(0,Se.resetTransparency)(this._source.properties().childs().prevClosePriceLineColor.value());i.background=o,i.textColor=this.generateTextColor(o),i.coordinate=r.coordinate,e.text=(0,Pe.getCurrentModePriceText)(s.priceScale(),r),e.visible=!0}}var Ue=i(456757),Ge=i(458963);class qe extends Ue.SeriesHorizontalLinePaneView{constructor(e){super(e),this._lineRendererData.linestyle=Ge.LINESTYLE_DOTTED}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.properties().childs();if(!e.showPrevClosePriceLine.value())return;if(this._series.isDWM())return;const t=this._series.prevClose();null!==t&&(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=e.prevClosePriceLineColor.value(),this._lineRendererData.linewidth=e.prevClosePriceLineWidth.value())}}var je=i(969419),Ye=i(956725),Ke=i(239589),Xe=i(86441),$e=i(63316),Ze=i(315801);class Qe{constructor(e,t){this._bars=[],this._invalidated=!0,this._isMarkersEnabled=(0,y.enabled)("source_selection_markers"),this._selectionData=null,this._blockSize=0,this._series=e,this._model=t,this._selectionIndexer=new $e.SelectionIndexes(t.timeScale())}update(){this._invalidated=!0}nearestIndex(e,t){var i,s;return null!==(s=null===(i=this.bars().search(e,t))||void 0===i?void 0:i.index)&&void 0!==s?s:null}items(){return this._bars}_updateImpl(){if(this._bars=[],6===this._series.properties().childs().style.value()&&!this._series.data().boxSize)return;const e=this._series.priceScale(),t=this._model.timeScale();if(t.isEmpty()||!e||e.isEmpty())return;const i=t.visibleStrictDataRange(this.bars());if(null===i)return;if(0===this.bars().size())return;if(this._series.data().bars().isEmpty())return;let s=i.firstBar();const o=i.lastBar(),n=this._series.firstValue();if(null===n)return;for(;s<=o;s++){if(null!==this.bars().valueAt(s))break}if(s>o)return;const a=this.bars().range(s,o),l={},c=this._series.properties().childs().style.value(),h=6===c?(0,r.ensureDefined)(this._series.data().boxSize):0;if(a.each(((e,t)=>{l.value=t;const i=this._barItem(l,t,e);return null===i||(l.previousValue=t,this._bars.push(i)),!1})),6===c&&(this._blockSize=(e.priceToCoordinate(0,n)-e.priceToCoordinate(500,n))/500*h),e.barPricesToCoordinates(this._bars,n),t.barIndexesToCoordinates(this._bars),this._model.selection().isSelected(this._series)){const i=this._selectionIndexer.indexes();this._selectionData={points:[],
bgColors:[],visible:!0,barSpacing:t.barSpacing(),hittestResult:Ze.HitTarget.Regular};const s=(0,r.ensureNotNull)(this._model.paneForSource(this._series)).height();this._selectionData.hittestResult=Ze.HitTarget.Regular;for(let r=0;r<i.length;r++){const o=i[r],a=this._series.bars().valueAt(o);if(null===a)continue;const l=a[1],c=a[4];if(null==l||null==c)continue;const h=.5*(l+c),d=t.indexToCoordinate(o),u=e.priceToCoordinate(h,n);this._selectionData.points.push(new Xe.Point(d,u)),this._selectionData.bgColors.push(this._model.backgroundColorAtYPercentFromTop(u/s))}}else this._selectionIndexer.clear()}_barItem(e,t,i){const s=t[1],r=t[2],o=t[3],n=t[4];if(void 0===s||void 0===r||void 0===o||void 0===n||null===s||null===r||null===o||null===n)return null;const a=this._series.barColorer(),l=this.isProjection(),c=a.barStyle(i,l,e);return{time:Math.round(i),open:s,high:r,low:o,close:n,color:c.barColor,borderColor:c.barBorderColor,isUp:c.isBarUp,hollow:null}}}class Je extends Qe{bars(){return this._series.bars()}isProjection(){return!1}}class et extends Qe{bars(){return this._series.nsBars()}isProjection(){return!0}}class tt extends et{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i=this._series.properties().childs(),s=i.rangeStyle.childs(),r={bars:this._bars,barSpacing:this._model.timeScale().barSpacing(),thinBars:s.thinBars.value(),dontDrawOpen:i.barStyle.childs().dontDrawOpen.value()};return new je.PaneRendererBars(r)}}class it extends et{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i=this._series.priceScale();if(!i)return null;const s=this._model.timeScale().barSpacing(),r={bars:this._bars,barWidth:(0,Ke.optimalBarWidth)(s),barSpacing:this._model.timeScale().barSpacing(),bodyVisible:!0,borderVisible:!0,wickVisible:!0,isPriceScaleInverted:i.isInverted()};return new Ye.PaneRendererCandles(r)}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const r=this._series.barColorer().barStyle(i,!0,e);return s.wickColor=r.wickColor,s.hollow=null,s}}var st=i(506387);class rt extends ke{lastPrice(){return this._getSource().data().lastProjectionPrice}_updateRendererData(e,t,i){e.visible=!1,t.visible=!1;const s=this._getModel(),o=this._getSource(),n=o.priceScale(),a=s.timeScale(),l=this.lastPrice();if(a.isEmpty()||n.isEmpty()||void 0===l)return;const c=a.visibleBarsStrictRange();if(null===c)return;const h=c.firstBar(),d=c.lastBar(),_=o.data(),p=_.search(d,u.PlotRowSearchMode.NearestLeft);if(null===p)return;const m=o.nearestIndex(h,u.PlotRowSearchMode.NearestRight);if(void 0===m)return;const g=o.model().properties().childs().scalesProperties.childs(),S=(0,r.ensureNotNull)(_.valueAt(m))[4];let v=i.background,f=g.showSeriesLastValue.value(),b=!1,y=!1,C=!1;const w=o.lastValueData(4,!1),P=o.properties().childs();if(8===P.style.value()&&P.haStyle.childs().showRealLastPrice.value()){const e=o.lastValueData(4,!0);if(e.noData||e.color===i.background||(v=(0,Se.resetTransparency)(e.color)),!e.noData&&!w.noData){const t=e.index===w.index
;b=t&&g.showSymbolLabels.value(),y=g.seriesLastValueMode.value()===fe.PriceAxisLastValueMode.LastPriceAndPercentageValue,f=f&&t,C=t&&this._isCountdownEnabled()&&P.showCountdown.value()}}else{const e=o.barColorer().barStyle(p.index,!0);v=(0,Se.resetTransparency)(e.barColor)}if(i.background=v,i.textColor=this.generateTextColor(v),i.secondLineTextColor=i.textColor,i.thirdLineTextColor=(0,Se.generateColor)(i.textColor,25),i.coordinate=n.priceToCoordinate(l,S),e.visible=f||C,!w.noData){const i=o.priceScale().isPercentage();w.formattedPriceAbsolute=n.formatPriceAbsolute(l),w.formattedPricePercentage=n.formatPricePercentage(l,S,!0),w.text=i?w.formattedPricePercentage:w.formattedPriceAbsolute,e.text=this._axisFirstLineText(w,f),e.secondLine=f&&y?i?w.formattedPriceAbsolute:w.formattedPricePercentage:"",e.thirdLine=C?this._countdownText():"",t.text=this._paneText(b)}t.visible=b}}var ot=i(742391),nt=i(955831),at=i(987088);const lt={light:{lineStyle:Ge.LINESTYLE_DOTTED,lineWidth:1,textColor:at.colorsPalette["color-cold-gray-900"],backgroundColor:at.colorsPalette["color-tv-blue-50"],lineColor:at.colorsPalette["color-cold-gray-500"]},dark:{lineStyle:Ge.LINESTYLE_DOTTED,lineWidth:1,textColor:at.colorsPalette["color-white"],backgroundColor:at.colorsPalette["color-tv-blue-a800"],lineColor:at.colorsPalette["color-cold-gray-500"]}};function ct(e){return e?lt.dark:lt.light}class ht extends nt.HorizontalLinePaneView{constructor(e,t,i){super(),this._model=e,this._isVisible=t.lineVisible,this._lineColor=t.lineColor,this._lineWidth=t.lineWidth,this._getValue=i}_updateImpl(){const e=this._lineRendererData;if(e.visible=!1,!this._isVisible.value())return;const t=this._model.mainSeries(),i=t.priceScale(),s=t.firstValue(),r=this._getValue();if(null===s||null===r)return;const o=ct(this._model.dark().value()),n=this._lineColor.value()?this._lineColor.value():o.lineColor,a=this._lineWidth.value()?this._lineWidth.value():o.lineWidth;e.visible=!0,e.y=i.priceToCoordinate(r,s),e.linestyle=o.lineStyle,e.linewidth=a,e.color=n}}class dt extends ve.PriceAxisView{constructor(e,t,i,s){super(),this._model=e,this._label=t,this._isVisible=i,this._getValue=s}_updateRendererData(e,t,i){if(e.visible=!1,t.visible=!1,!this._isVisible.value())return;const s=this._model.mainSeries(),r=s.priceScale(),o=s.firstValue(),n=this._getValue();if(null===o||null===n)return;const a=ct(this._model.dark().value());e.visible=!0,t.visible=!0,e.text=r.formatPriceAbsolute(n),t.text=this._label,i.coordinate=r.priceToCoordinate(n,o),i.background=a.backgroundColor,i.textColor=a.textColor}}class ut extends st.PriceLineAxisView{constructor(e,t,i){super(),this._model=e,this._isLineVisible=t,this._getValue=i}_isVisible(){return this._isLineVisible.value()}_lineWidth(){return ct(this._model.dark().value()).lineWidth}_lineStyle(){return ct(this._model.dark().value()).lineStyle}_priceLineColor(e){return ct(this._model.dark().value()).lineColor}_value(){const e=this._model.mainSeries(),t=e.priceScale(),i=e.firstValue(),s=this._getValue();if(null===i||null===s)return{noData:!0}
;const r=t.priceToCoordinate(s,i);return{noData:!1,floatCoordinate:r,coordinate:r,color:"",formattedPricePercentage:"",formattedPriceAbsolute:"",formattedPriceIndexedTo100:"",text:"",index:0}}}const _t=b.t(null,void 0,i(330777)),pt=b.t(null,void 0,i(608136));function mt(e,t,i,s){const r=new ht(e,i,s),o=new dt(e,i.label,i.labelVisible,s);return{paneView:r,panePriceAxisView:new ot.PanePriceAxisView(o,t,e),priceAxisView:o,priceLineAxisView:new ut(e,i.lineVisible,s)}}var gt=i(707957),St=i(502141),vt=i(919892);class ft{constructor(){this._data=null}setData(e){this._data=e}data(){return this._data}draw(e,t){const i=this._data;if(null===i)return;const s=t.pixelRatio;e.save();const r=Math.max(1,Math.floor(s)),o=r%2/2,n=Math.round(i.center.x*s)+o,a=i.center.y*s;e.fillStyle=i.seriesLineColor,e.beginPath();const l=Math.max(2,1.5*i.seriesLineWidth)*s;e.arc(n,a,l,0,2*Math.PI,!1),e.fill(),e.fillStyle=i.fillColor,e.beginPath(),e.arc(n,a,i.radius*s,0,2*Math.PI,!1),e.fill(),e.lineWidth=r,e.strokeStyle=i.strokeColor,e.beginPath(),e.arc(n,a,i.radius*s+r/2,0,2*Math.PI,!1),e.stroke(),e.restore()}hitTest(e,t){return null}}function bt(e){return e}const yt=[{start:0,end:.25,startRadius:4,endRadius:10,startFillAlpha:.25,endFillAlpha:0,startStrokeAlpha:.4,endStrokeAlpha:.8,easing:bt},{start:.25,end:.525,startRadius:10,endRadius:14,startFillAlpha:0,endFillAlpha:0,startStrokeAlpha:.8,endStrokeAlpha:0,easing:bt},{start:.525,end:1,startRadius:14,endRadius:14,startFillAlpha:0,endFillAlpha:0,startStrokeAlpha:0,endStrokeAlpha:0,easing:bt}];function Ct(e,t,i,s){const r=i+(s-i)*t;return(0,Se.applyTransparency)(e,(0,Se.alphaToTransparency)(r))}function wt(e,t){const i=e%2600/2600;let s;for(const e of yt)if(i>=e.start&&i<=e.end){s=e;break}if(void 0===s)throw new Error("Last price animation internal logic error");const r=s.easing((i-s.start)/(s.end-s.start));return{fillColor:Ct(t,r,s.startFillAlpha,s.endFillAlpha),strokeColor:Ct(t,r,s.startStrokeAlpha,s.endStrokeAlpha),radius:(o=r,n=s.startRadius,a=s.endRadius,n+(a-n)*o)};var o,n,a}class Pt{constructor(e){this._renderer=new ft,this._invalidated=!0,this._stageInvalidated=!0,this._startTime=performance.now(),this._endTime=this._startTime-1,this._series=e}update(e){if(this._invalidated=!0,"data-source-change"===e.type&&e.sourceId===this._series.id()&&e.realtime&&this._series.seriesLoaded()){const e=performance.now(),t=this._endTime-e;if(t>0)return void(t<650&&(this._endTime+=2600));this._startTime=e,this._endTime=e+2600}}invalidateStage(){this._stageInvalidated=!0}animationActive(){return performance.now()<=this._endTime}stopAnimation(){this._endTime=this._startTime-1}renderer(e,t){return this._invalidated?(this._updateImpl(e,t),this._invalidated=!1,this._stageInvalidated=!1):this._stageInvalidated&&(this._updateRendererDataStage(),this._stageInvalidated=!1),this._renderer}_updateImpl(e,t){this._renderer.setData(null);const i=this._series.model().timeScale(),s=i.visibleBarsStrictRange(),r=this._series.firstValue(),o=this._series.lastValueData(void 0,!0,!0)
;if(null===s||null===r||void 0===o.index||void 0===o.price||!s.contains(o.index))return;const n=new Xe.Point(i.indexToCoordinate(o.index),this._series.priceScale().priceToCoordinate(o.price,r)),a=o.color,l=this._series.properties().childs();let c;switch(this._series.style()){case 3:c=l.areaStyle.childs().linewidth.value();break;case 10:const t=l.baselineStyle,i=Math.round(e*(Math.abs(100-t.childs().baseLevelPercentage.value())/100));c=n.y<=i?t.childs().topLineWidth.value():t.childs().bottomLineWidth.value();break;case 14:c=l.lineWithMarkersStyle.childs().linewidth.value();break;case 15:c=l.steplineStyle.childs().linewidth.value();break;default:c=l.lineStyle.childs().linewidth.value()}const h=wt(this._duration(),a);this._renderer.setData({seriesLineColor:a,seriesLineWidth:c,fillColor:h.fillColor,strokeColor:h.strokeColor,radius:h.radius,center:n})}_updateRendererDataStage(){const e=this._renderer.data();if(null!==e){const t=wt(this._duration(),e.seriesLineColor);e.fillColor=t.fillColor,e.strokeColor=t.strokeColor,e.radius=t.radius}}_duration(){return this.animationActive()?performance.now()-this._startTime:2599}}var Tt=i(877009),Mt=i(401580),xt=i(175878),It=i(826989),Lt=i(731042);const kt=y.enabled("chart_style_hilo_last_price");class At extends Ue.SeriesHorizontalLinePaneView{constructor(e){super(e),this._lineRendererData.linestyle=Ge.LINESTYLE_DOTTED}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.properties().childs();if(!e.showPriceLine.value())return;if(!kt&&12===e.style.value())return;const t=this._series.lastValueData(void 0,!0);t.noData||(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=this._series.priceLineColor(t.color),this._lineRendererData.linewidth=e.priceLineWidth.value())}}var Et=i(147664),Dt=i(262550),Bt=i(142119),Rt=i(230058),Nt=i(756930);class Vt extends Nt.PaneRendererSeriesBase{constructor(e){super(),this._bars=e.bars,this._barWidth=e.barSpacing}draw(e,t){e.save();const i=Math.round(t.pixelRatio*this._barWidth/2);let s=null;for(let r=0;r<this._bars.length;++r){const o=this._bars[r],n=Math.round(o.time*t.pixelRatio),a=null===s?Math.round(n-i):s+1,l=(r<this._bars.length-1?Math.round(this._bars[r+1].time*t.pixelRatio):n+2*i)-i-a,c=Math.round(Math.min(o.close,o.open)*t.pixelRatio),h=Math.round(Math.max(o.close,o.open)*t.pixelRatio)-c+1;e.fillStyle=o.borderColor,e.fillRect(a,c,l,h),e.fillRect(n,Math.round(o.high*t.pixelRatio),1,Math.round((o.low-o.high)*t.pixelRatio)),e.fillStyle=o.color,e.fillRect(a+1,c+1,l-2,h-2),s=a+l-1}e.restore()}_getTolerance(){return(0,Ke.interactionTolerance)().series+.5}_getBarSpacing(){return this._barWidth}}class Ot extends Je{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()},s=new Bt.CompositeRenderer;return s.append(new Vt(i)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&s.append(new Rt.SelectionRenderer(this._selectionData)),s}}class Ft extends et{
renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()};return new Vt(i)}}class Wt extends Je{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:.9*this._model.timeScale().barSpacing()},s=new Bt.CompositeRenderer;return s.append(new Vt(i)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&s.append(new Rt.SelectionRenderer(this._selectionData)),s}}class zt extends et{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:.9*this._model.timeScale().barSpacing()};return new Vt(i)}}var Ht,Ut=i(203308);class Gt extends Nt.PaneRendererSeriesBase{constructor(e){super(),this._bars=e.bars,this._barSpacing=e.barSpacing,this._barLineWidth=Math.max(1,(0,Ke.optimalBarWidth)(e.barSpacing,1))}draw(e,t){let i,s,r;e.save(),e.lineCap="square";const o=Math.floor(t.pixelRatio)%2?1:0;for(const n of this._bars){const a=Math.round(t.pixelRatio*this._barLineWidth*.5),l=Math.round(t.pixelRatio*n.time-a),c=void 0===s||n.isUp?Math.round(t.pixelRatio*n.high-a):s,h=2*a;let d;if(n.isTwoColorBar){const s=Math.round(t.pixelRatio*n.additionalPrice-t.pixelRatio*n.high+a),r=c+s,u=Math.round(t.pixelRatio*n.low-t.pixelRatio*n.additionalPrice+a),_=void 0!==i&&n.isUp?i:r+u;e.fillStyle=n.upColor,e.fillRect(l,c,h+o,s),e.fillStyle=n.downColor,e.fillRect(l,r,h+o,_+a-r+1),d=_}else{const s=Math.round(t.pixelRatio*n.low-t.pixelRatio*n.high+a),r=void 0!==i&&n.isUp?i:c+s;e.fillStyle=n.color,e.fillRect(l,c,h+o,r+a-c+1),d=r}if(!n.combinedWithProjection){n.isTwoColorBar?e.fillStyle=n.isUp?n.downColor:n.upColor:e.fillStyle=n.color;const i=void 0===r?Math.round((n.time-this._barSpacing)*t.pixelRatio+a):r+2*a,l=Math.round(n.time*t.pixelRatio-a)-i+1,c=2*a+o;if(n.isUp)e.fillRect(i,d-a+1-o,l,c);else{const r=void 0===s?Math.round(n.open*t.pixelRatio-a):s;e.fillRect(i,r,l,c)}}r=l,i=d,s=c}e.restore()}_getTolerance(){return(0,Ke.interactionTolerance)().series+this._barLineWidth/4}_getBarSpacing(){return this._barLineWidth}}function qt(e,t){const i={};return i.upColor=e.upColor,i.downColor=e.downColor,i.isTwoColorBar=e.isTwoColorBar,(0,Ut.default)(t)&&(i.additionalPrice=t),i}class jt extends Je{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()},s=new Bt.CompositeRenderer;return s.append(new Gt(i)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&s.append(new Rt.SelectionRenderer(this._selectionData)),s}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const r=qt(this._series.barColorer().barStyle(i,!1,e),t[6]);return{...s,...r}}}class Yt extends et{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()};return new Gt(i)}_barItem(e,t,i){const s=super._barItem(e,t,i)
;if(null===s)return null;const o=this._series.barColorer().barStyle(i,!0,e),n=t[6],a=qt(o,n);return(0,Ut.default)(n)&&s.time===(0,r.ensureNotNull)(this.bars().lastIndex())&&(a.combinedWithProjection=!0),{...s,...a}}}!function(e){e[e.EllipseWidth=.9]="EllipseWidth",e[e.EllipseRadius=.95]="EllipseRadius",e[e.SimplifiedEllipseWidth=.86]="SimplifiedEllipseWidth"}(Ht||(Ht={}));class Kt extends Nt.PaneRendererSeriesBase{constructor(e){super(),this._bars=e.bars,this._barSpacing=e.barSpacing,this._barWidth=e.barSpacing}draw(e,t){if(0===this._bars.length)return;e.save();const i=this._bars.reduce(((e,t)=>Math.max(e,(t.low-t.high)/t.additionalNum)),0);this._barSpacing>1&&i>=1?this._drawFillSigns(e,t):this._drawSimplified(e,t),e.restore()}_drawImpl(e){}_getTolerance(){return(0,Ke.interactionTolerance)().series+this._barWidth/8}_getBarSpacing(){return this._barSpacing}_drawBarCross(e,t,i,s){!function(e,t,i,s,r){e.moveTo(t,i),e.lineTo(t+s,i+r),e.moveTo(t+s,i),e.lineTo(t,i+r)}(e,t.time-.5*this._barWidth,t.high+s*i,this._barWidth,i)}_drawBarEllipse(e,t,i,s){!function(e,t,i,s,r){e.save(),e.translate(t+s/2,i+r/2),e.scale(s/2,r/2),e.moveTo(1,0),e.arc(0,0,Ht.EllipseRadius,0,2*Math.PI,!1),e.restore()}(e,t.time-this._barWidth*Ht.EllipseWidth*.5,t.high+s*i,this._barWidth*Ht.EllipseWidth,i)}_drawFillSigns(e,t){e.scale(t.pixelRatio,t.pixelRatio),e.lineCap="butt",e.lineWidth=1;for(const t of this._bars){const i=(t.low-t.high)/t.additionalNum;if(t.isMergedBar&&(e.beginPath(),t.isUp?this._drawBarEllipse(e,t,i,t.additionalNum-1):this._drawBarCross(e,t,i,0),e.strokeStyle=t.isUp?t.downColor:t.upColor,e.stroke()),e.beginPath(),t.isUp)for(let s=t.additionalNum-1-(t.isMergedBar?1:0);s>-1;s--)this._drawBarCross(e,t,i,s);else for(let s=t.isMergedBar?1:0;s<t.additionalNum;s++)this._drawBarEllipse(e,t,i,s);e.strokeStyle=t.color,e.stroke()}}_drawSimplified(e,t){for(const i of this._bars){const s=i.isUp?1:Ht.SimplifiedEllipseWidth,r=(i.time-.5*this._barWidth*s)*t.pixelRatio,o=(i.time+.5*this._barWidth*s)*t.pixelRatio,n=Math.max(1,o-r);let a=i.high*t.pixelRatio;const l=i.low*t.pixelRatio,c=i.high*t.pixelRatio;let h=Math.max(1,l-c);if(i.isMergedBar){e.fillStyle=i.isUp?i.downColor:i.upColor;const t=(i.low-i.high)/i.additionalNum,s=Math.max(1,Math.round(t));i.isUp?(e.fillRect(r,a,n,s),a+=s):(e.fillRect(r,a+n-s,n,s),h-=s)}e.fillStyle=i.color,e.fillRect(r,a,n,h)}}}function Xt(e,t,i,s){const r={};return r.low=s-.5*t,r.high=i+.5*t,r.upColor=e.upColor,r.downColor=e.downColor,r.isMergedBar=e.isMergedBar,r.additionalNum=Math.round(1+(i-s)/t),r}class $t extends Je{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()},s=new Bt.CompositeRenderer;return s.append(new Kt(i)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&s.append(new Rt.SelectionRenderer(this._selectionData)),s}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const o=Xt(this._series.barColorer().barStyle(i,!1,e),(0,
r.ensureDefined)(this._series.data().boxSize),s.high,s.low);return{...s,isUp:(0,r.ensureDefined)(s.isUp),...o}}}class Zt extends et{renderer(e,t){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const i={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()};return new Kt(i)}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const o=Xt(this._series.barColorer().barStyle(i,!0,e),(0,r.ensureDefined)(this._series.data().boxSize),s.high,s.low);return{...s,isUp:(0,r.ensureDefined)(s.isUp),...o}}}var Qt=i(72731),Jt=i(825278),ei=i(245242),ti=i(936258),ii=i(904891),si=i(579950);class ri extends ei.SeriesCandlesPaneView{renderer(e,t){this._invalidated&&(this._updateImpl(null),this._invalidated=!1);const i=this._source.priceScale();if(!i)return null;const s=this._source.properties().childs().haStyle.childs(),r=this._model.timeScale().barSpacing(),o={bars:this._bars,barSpacing:r,bodyVisible:s.drawBody.value(),borderVisible:s.drawBorder.value(),borderColor:s.borderColor.value(),wickColor:s.wickColor.value(),barWidth:(0,Ke.optimalBarWidth)(r),wickVisible:s.drawWick.value(),isPriceScaleInverted:i.isInverted()},n=new Bt.CompositeRenderer;return n.append(new Ye.PaneRendererCandles(o)),this._model.selection().isSelected(this._source)&&this._isMarkersEnabled&&this._selectionData&&n.append(new Rt.SelectionRenderer(this._selectionData)),n}}var oi=i(41117),ni=i(255799),ai=i(548587),li=i(158975),ci=i(161488),hi=(i(551775),i(519073)),di=i(488530),ui=i(982217),_i=i(707621);const pi=y.enabled("price_scale_always_last_bar_value"),mi=y.enabled("display_data_mode"),gi=o.CheckMobile.any(),Si=!y.enabled("hide_series_legend_item"),vi=y.enabled("hide_price_scale_global_last_bar_value"),fi=y.enabled("alerts"),bi=y.enabled("no_bars_status"),yi=y.enabled("charting_library_debug_mode"),Ci=y.enabled("chart_style_hilo_last_price"),wi=(0,l.getLogger)("Chart.Series");let Pi=!1;const Ti={countdownEnabled:!0,lastPriceAnimationEnabled:!0};function Mi(e,t,i){return void 0===t?null:`${e}=${t} (${i?"changed":"unchanged"})`}function xi(e){const t=e.state();return t.data.forEach((e=>e.value.splice(7,1))),t}class Ii extends c.PriceDataSource{constructor(e,t,o,n){super(e,"_seriesId"),this.requestingIntradayWhenNotSupported=new gt.Delegate,this.requestingStyleIsNotSupported=new gt.Delegate,this.requestingStyleSupportRecovered=new gt.Delegate,this.requestingResolutionLessThanFrequency=new gt.Delegate,this._paneView=null,this._futureBarsPaneView=null,this._projectionBarsPaneView=null,this._waterlineView=null,this._priceLineView=null,this._gotoDateView=null,this._baseHorizontalLineView=null,this._priceStep=null,this._symbolInfo=null,this._prevSymbolInfo=null,this._isPrePostMarketPricesAvailableProperty=new(m())(!1),this._isBackAdjustmentForbiddenProperty=new(m())(!0),this._isSettlementAsCloseForbiddenProperty=new(m())(!0),this._highLowPriceCache=new Map,this._averagePriceCache=new Map,this._prevClosePriceAxisView=null,this._priceScaleAboutToBeChanged=new gt.Delegate,this._onRestarted=new gt.Delegate,
this._onStatusChanged=new gt.Delegate,this._extendedHoursChanged=new gt.Delegate,this._tagsChanged=new gt.Delegate,this._intervalChanged=new gt.Delegate,this._sessionIdChanged=new gt.Delegate,this._requestMoreDataAvailable=!0,this._lineStyleLastPriceCirclePaneView=new Pt(this),this._prevClosePriceLineView=null,this._dataPoweredBy=null,this._loading=!0,this._seriesLoaded=!1,this._status=0,this._symbolResolvingActive=new Mt.WatchedValue(!1),this._predictBars=0,this._syncModel=null,this._data=null,this._lastCompleteFlags=null,this._haStyle={studyId:(0,r.ensureNotNull)((0,g.chartStyleStudyId)(8,!0))},this._renkoStyle={studyId:(0,r.ensureNotNull)((0,g.chartStyleStudyId)(4,!0))},this._pbStyle={studyId:(0,r.ensureNotNull)((0,g.chartStyleStudyId)(7,!0))},this._kagiStyle={studyId:(0,r.ensureNotNull)((0,g.chartStyleStudyId)(5,!0))},this._pnfStyle={studyId:(0,r.ensureNotNull)((0,g.chartStyleStudyId)(6,!0))},this._rangeStyle={studyId:(0,r.ensureNotNull)((0,g.chartStyleStudyId)(11,!0))},this._barColorerCache=null,this._boxSizeValue=new Mt.WatchedValue,this._base=100,this._pointValue=1,this._formattingDeps=null,this._formatter=new S.PriceFormatter(this._base),this._ignoreMinMoveFormatter=new S.PriceFormatter(this._base),this._ignoreMinMovePriceStep=null,this._lastBarCloseTime=null,this._onSessionIdPropertyChangedBound=this._onSessionIdPropertyChanged.bind(this),this._ignoreSessionIdProxyPropertyChanges=!1,this._textSourceIsAlwaysTickerRestrictionEnabled=!1,this._lastPriceAnimationActive=!1,this._currentSession="out_of_session",this._onStyleChanged=new gt.Delegate,this._intervalObj=null,this._obsoleteZOrder=0,this._seriesErrorMessage=null,this._seriesAlwaysFalseHibernatedVW=new Mt.WatchedValue(!1),this._styleToRecover=null,this._precomputedBarStyles=new WeakMap,this._doNotShowLastAvailableBar=!1,this._gotoDateResultCleared=!1,this._endOfDataPaneView=null,this._pendingTimeRange=null,this._replaySubscriber=null,this._symbolIntervalChanged=new gt.Delegate,this._isReplayResolutionAvailableForUser=null,this._onInReplayStateChanged=new gt.Delegate,this._replayExitedDueUnsupportedInterval=new gt.Delegate,this._replayExitedDueUnavailableForUserInterval=new gt.Delegate,this._onTimeFrameApplied=new gt.Delegate,this._prevRequestedInterval="",this._isActingAsSymbolSource=new Mt.WatchedValue(!0),this._seriesSource=new xt.SeriesDataSource(e.chartApi(),"s",n);const a=this._seriesSource.dataEvents();a.symbolResolved().subscribe(this,this._onSymbolResolved),a.symbolError().subscribe(this,this._onSymbolError),a.seriesTimeFrame().subscribe(this,this._onSeriesTimeFrame),a.seriesError().subscribe(this,this._onSeriesError),a.loading().subscribe(this,this._onSeriesLoading),a.completed().subscribe(this,this._onSeriesCompleted),a.dataUpdated().subscribe(this,this._onDataUpdated),a.barReceived().subscribe(this,this._onBarReceived),this._quotesProvider=new ge.QuotesProvider,this._quotesProvider.quotesUpdate().subscribe(this,this._onQuotesUpdate);const l=t.childs();if(t.hasChild("extendedHours")){(0,
r.ensureDefined)(l.extendedHours).value()&&!t.hasChild("sessionId")&&t.addChild("sessionId",new(m())("extended")),t.removeProperty("extendedHours")}t.hasChild("sessionId")||t.addChild("sessionId",new(m())(s.Regular)),(0,_i.allChartStyles)().includes(l.style.value())||l.style.setValueSilently(2);const c=l.lineStyle.childs();if(l.lineStyle.hasChild("styleType")){let e,t;const i=c.styleType.value();0===i&&(t=14,e=l.lineWithMarkersStyle.childs()),1===i&&(t=15,e=l.steplineStyle.childs()),e&&(e.color.setValueSilently(c.color.value()),e.linestyle.setValueSilently(c.linestyle.value()),e.linewidth.setValueSilently(c.linewidth.value()),e.priceSource.setValueSilently(c.priceSource.value())),void 0!==t&&2===l.style.value()&&l.style.setValue(t),l.lineStyle.removeProperty("styleType")}this._setProperties(t),this._sessionIdProxyProperty=new(m())(l.sessionId.value()),l.sessionId.subscribe(this,(()=>this._updateSessionIdProxyProperty())),this._sessionIdProxyProperty.subscribe(this,this._onSessionIdProxyPropertyChanged),this._symbolTextSourceProxyProperty=new(m()),this._recalcSymbolTextSourceProxyProperty(),l.statusViewStyle.childs().symbolTextSource.subscribe(this,this._recalcSymbolTextSourceProxyProperty),this._symbolTextSourceProxyProperty.subscribe(this,(()=>e.lightUpdate())),this._options=(0,ue.merge)((0,ue.clone)(Ti),o),this._prevChartStyle=l.style.value(),this._priceAxisView=new ke(this,e,{alwaysShowGlobalLast:!vi,showCountdown:o.countdownEnabled});let h=null;pi||vi||(h=new ke(this,e,{visibleOnHistoryOnly:!0,showSymbolLabel:!1,showCountdown:!1,alwaysShowGlobalLast:!1,useSolidBodyColor:!1})),this._priceLinePriceAxisView=new st.SeriesPriceLineAxisView(this),this._priceLineAxisViews=[this._priceLinePriceAxisView];const d=new rt(this,e,{showCountdown:o.countdownEnabled});this._priceAxisViews=[this._priceAxisView,d],null!==h&&this._priceAxisViews.push(h),this._prevClosePriceAxisView=new He(this,e),this._priceAxisViews.unshift(this._prevClosePriceAxisView),this._prevClosePriceLineView=new qe(this),this._panePriceAxisView=new ot.PanePriceAxisView(this._priceAxisView,this,e),this._historyPricePanePriceAxisView=null!==h?new ot.PanePriceAxisView(h,this,e):null,this._projectionPriceAxisView=new ot.PanePriceAxisView(d,this,e),this._labelPaneViews=[this._panePriceAxisView,this._projectionPriceAxisView],null!==this._historyPricePanePriceAxisView&&this._labelPaneViews.push(this._historyPricePanePriceAxisView),this._highLowAvgPaneViews=[],this._averagePaneViews=[],this._createHighLowAvgViews(),this._subscribeRestartToSessionIdChange(),l.visible.subscribe(this,this._updateLastPriceAnimationActive),this._updateLastPriceAnimationActive(),this._dataWindowView=new z(this,e),this._legendView=new j(this,e),this._statusView=new E(this,this._model.properties().childs().scalesProperties.childs().textColor,l.statusViewStyle),this._marketStatusModel=new Y.MarketStatusModel(this._quotesProvider),this._dataUpdatedModeModel=mi?new he({getter:this.symbolInfo.bind(this),onChange:a.symbolResolved()},{getter:this.status.bind(this),onChange:this._onStatusChanged
},{getter:()=>{var e;return null===(e=this._lastCompleteFlags)||void 0===e?void 0:e.rt_update_period},onChange:a.completed()},l.symbol.listeners()):null,this._dataProblemModel=new me(this._quotesProvider,l.symbol.listeners()),l.backAdjustment.subscribe(this,(()=>{this.isStarted()&&this.restart()})),l.settlementAsClose.subscribe(this,(()=>{this.isDWM()&&this.isStarted()&&this.restart()})),this._symbolResolvingActive.subscribe((()=>e.realignLineTools())),this._intervalChanged.subscribe(this,(()=>e.realignLineTools())),y.enabled("widget")||Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(66639),i.e(26855),i.e(92706),i.e(50690),i.e(745),i.e(66849)]).then(i.bind(i,271804)).then((e=>{this._endOfDataPaneView=new e.EndOfDataLollipopPaneView(this)}))}setId(e){var t;super.setId(e),null===(t=(0,ze.getPersistentLogger)())||void 0===t||t.addPersistentLogEntry(`Set series Id to ${e}`,l.LOGLEVEL.INFO,"chart.series")}supportsPressedChunks(){return!0}pressedChunks(e,t){return this.data().pressedChunks(e,t)}seriesErrorMessage(){return this._seriesErrorMessage}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this),this._quotesProvider.destroy(),this._model.timeScale().visibleBarsStrictRangeChanged().unsubscribeAll(this),this._unsubscribeRestartToSessionIdChange(),this._replayExitedDueUnsupportedInterval.destroy(),this._replayExitedDueUnavailableForUserInterval.destroy(),this._onTimeFrameApplied.destroy()}isActingAsSymbolSource(){return this._isActingAsSymbolSource.readonly()}barColorer(){if(this._barColorerCache)return this._barColorerCache;let e=null;const t=this._model.dataSources();for(let i=t.length-1;i>=0;i--){const s=t[i];if((0,ci.isStudy)(s)&&s.hasBarColorer()&&!s.isSourceHidden()){const t=(0,r.ensureNotNull)(s.barColorer());null===e?e=t:e.pushBackBarColorer(t)}}return null===e?e=new li.SeriesBarColorer(this):e.pushBackBarColorer(new li.SeriesBarColorer(this)),this._barColorerCache=e,e}createPaneView(){this._paneView=null,this._projectionBarsPaneView=null,this._waterlineView=null,this._priceLineView=this.hasClosePrice()?new At(this):null;const e=this._properties.childs().style.value();switch(e){case 0:this._paneView=new Jt.SeriesBarsPaneView(this,this._model);break;case 1:this._paneView=new ei.SeriesCandlesPaneView(this,this._model);break;case 2:case 14:case 15:this._paneView=new ti.SeriesLinePaneView(this,this._model);break;case 3:this._paneView=new ii.SeriesAreaPaneView(this,this._model);break;case 16:this._paneView=new si.SeriesHLCAreaPaneView(this,this._model);break;case 8:this._paneView=new ri(this,this._model);break;case 9:this._paneView=new oi.SeriesHollowCandlesPaneView(this,this._model);break;case 13:this._paneView=new Qt.SeriesColumnsPaneView(this,this._model);break;case 10:{this._paneView=new ni.SeriesBaselinePaneView(this,this._model);const e=this._properties.childs().baselineStyle.childs();this._waterlineView=new Et.SeriesWaterlinePaneView({paneHeight:()=>this.priceScale().height(),color:()=>e.baselineColor.value(),baseLevelPercentage:()=>e.baseLevelPercentage.value()});break}
case 12:this._paneView=new Dt.SeriesHiLoPaneView(this,this._model)}switch(e){case 4:this._paneView=new Ot(this,this._model),this._projectionBarsPaneView=new Ft(this,this._model);break;case 7:this._paneView=new Wt(this,this._model),this._projectionBarsPaneView=new zt(this,this._model);break;case 5:this._paneView=new jt(this,this._model),this._projectionBarsPaneView=new Yt(this,this._model);break;case 6:this._paneView=new $t(this,this._model),this._projectionBarsPaneView=new Zt(this,this._model)}if(11===e&&(this._properties.childs().rangeStyle.childs().barStyle.value()===di.RangeBarStyle.Bars?(this._paneView=new Jt.SeriesBarsPaneView(this,this._model),this._projectionBarsPaneView=new tt(this,this._model)):(this._paneView=new ei.SeriesCandlesPaneView(this,this._model),this._projectionBarsPaneView=new it(this,this._model))),null===this._paneView)throw Error("Unknown chart style assigned: "+e)}properties(){return this._properties}zorder(){return 0}quotesProvider(){return this._quotesProvider}currentSession(){return this._currentSession}syncModel(){if(!this._syncModel){const e=this.symbolInfo(),t=this.interval();if(!e||!t)return null;this._syncModel=new ee(e,t)}return this._syncModel}labelPaneViews(){return this._labelPaneViews}topPaneViews(){const e=[];if(null!==this._gotoDateView&&e.push(this._gotoDateView),this._lastPriceAnimationActive){const t=this._lineStyleLastPriceCirclePaneView;t.animationActive()&&setTimeout((()=>this._model.invalidate(Tt.InvalidationMask.cursor())),0),t.invalidateStage(),e.push(t)}return 0!==e.length?e:null}paneViews(){if(!this.properties().childs().visible.value())return null;const e=[(0,r.ensureNotNull)(this._baseHorizontalLineView),(0,r.ensureNotNull)(this._paneView)];return this._endOfDataPaneView&&e.push(this._endOfDataPaneView),this._futureBarsPaneView&&e.push(this._futureBarsPaneView),this._projectionBarsPaneView&&e.push(this._projectionBarsPaneView),null!==this._waterlineView&&e.push(this._waterlineView),e.push((0,r.ensureNotNull)(this._prevClosePriceLineView)),null!==this._priceLineView&&e.push(this._priceLineView),window.TradingView.printing&&this._lastPriceAnimationActive&&(this._lineStyleLastPriceCirclePaneView.stopAnimation(),e.push(this._lineStyleLastPriceCirclePaneView)),e.push(...this._highLowAvgPaneViews),e.push(...this._averagePaneViews),e}priceAxisViews(e,t){return e.findTargetPriceAxisViews(this,t,this._priceAxisViews,this._priceLineAxisViews)}clearHighLowPriceCache(){this._highLowPriceCache.clear()}clearAveragePriceCache(){this._averagePriceCache.clear()}priceScale(){return(0,r.ensureNotNull)(this._priceScale)}setPriceScale(e){this._priceScale!==e&&(this._priceScaleAboutToBeChanged.fire(),this._priceScale=e,this._properties.removeProperty("priceAxisProperties"),this._properties.addChild("priceAxisProperties",e.properties()),this._properties.childs().priceAxisProperties.childChanged(null),(0,a.emit)("series_event","price_scale_changed"),this._priceScaleChanged.fire(e))}priceScaleChanged(){return this._priceScaleChanged}priceScaleAboutToBeChanged(){
return this._priceScaleAboutToBeChanged}applyPreferences(e){const t=(0,ue.clone)(e);this.priceScale().setMode({autoScale:t.priceAxisProperties.autoScale,percentage:t.priceAxisProperties.percentage,log:t.priceAxisProperties.log,lockScale:t.priceAxisProperties.lockScale}),this.setChartStyleWithIntervalIfNeeded(t.style);const{style:i,interval:s,...r}=t;this._properties.mergePreferences(r),this._properties.saveDefaults(),this.createPaneView(),this.invalidateBarStylesCache()}disconnect(){this._seriesSource.stop(),this._predictBars=0,this._status=0,this._model.isSnapshot()||(this._prevSymbolInfo=null,this._symbolInfo=null)}isStarted(){return this._seriesSource.isStarted()}restart(e=!0){if(5===this._status)return;this._loading=!0,this._lastCompleteFlags=null,this._onRestarted.fire(),this._setStatus(1),this._updateSymbolInfo(null,e);let t=this._properties.childs().interval.value();X.Interval.isEqual(t,this._prevRequestedInterval)&&this._notifyIntervalChanged(t);let i=null;this._pendingTimeRange&&(i=this._pendingTimeRange,this._pendingTimeRange=null),this._removeReplaySubscriber(),this._onBeforeModifySeries(this.getSymbolString(),t),this._onTimeFrameApplied.fire(i),t=(0,Lt.getServerInterval)(t),this._data=null,this._seriesSource.modifySeries(this._getResolvingSymbolObject(),t,i),this._seriesSource.isStarted()||this._seriesSource.start(),this._prevRequestedInterval=this.interval(),this.updateAllViews((0,Te.sourceChangeEvent)(this.id())),this._model.lightUpdate()}isSymbolInvalid(){return 4===this._status}getSymbolString(){return(0,vt.encodeExtendedSymbolOrGetSimpleSymbolString)(this._getSymbolObject())}invalidateBarStylesCache(e){wi.logDebug("Invalidate style cache starting from "+e),this._clearStylePlot(this.bars(),e),this._clearStylePlot(this.nsBars())}isFailed(){return 12===this.status()||4===this.status()||10===this.status()}isStatusError(){return 12===this.status()}actualSymbol(){return(0,g.actualSymbol)(this.symbolInfo(),this.symbol())}proSymbol(){return(0,g.proSymbol)(this.symbolInfo(),this.symbol())}onStyleChanged(){return this._onStyleChanged}style(){return this.properties().childs().style.value()}setStyle(e){this.setSymbolParams({style:e})}isRangeBasedStyle(){return(0,g.isRangeBasedStyle)(this.style())}symbolSameAsCurrent(e){return(0,St.symbolSameAsCurrent)(e,this.symbolInfo())}status(){return this._status}symbol(){return this.properties().childs().symbol.value()}symbolChanged(){return this.properties().childs().symbol.listeners()}symbolInfo(){return this._symbolInfo}symbolResolved(){return this.dataEvents().symbolResolved()}symbolResolvingActive(){return this._symbolResolvingActive}symbolHibernated(){return this._seriesAlwaysFalseHibernatedVW}firstValue(){const e=this.firstBar();return null===e?null:this._barFunction(e,0)}firstBar(){const e=this.model().timeScale().visibleBarsStrictRange();if(null===e)return null;const t=e.firstBar(),i=this.data().search(t,u.PlotRowSearchMode.NearestRight);return null!==i?i.value:null}formatter(e=!0){return e?this._formatter:this._ignoreMinMoveFormatter}priceStep(e=!0){
return e?this._priceStep:this._ignoreMinMovePriceStep}bars(){return this.data().bars()}nsBars(){return this.data().nsBars()}interval(){return this.properties().childs().interval.value()}setInterval(e){this.setSymbolParams({interval:e})}intervalObj(){const e=this.interval();if(null!==this._intervalObj&&this._intervalObj.resolutionString===e)return this._intervalObj.interval;const t=X.Interval.parse(e);return this._intervalObj={resolutionString:e,interval:t},t}prevClose(){const e=this.priceScale();if(e.isEmpty()||this.data().isEmpty())return null;const t=this.quotes(),i=this.firstValue();if(null===t||null===i)return null;const s=t.prev_close_price;return void 0===s?null:{coordinate:e.priceToCoordinate(s,i),floatCoordinate:e.priceToCoordinate(s,i),formattedPricePercentage:e.formatPricePercentage(s,i,!0),formattedPriceAbsolute:e.formatPriceAbsolute(s),formattedPriceIndexedTo100:e.formatPriceIndexedTo100(s,i)}}priceLineColor(e){return this.properties().childs().priceLineColor.value()||e}hasClosePrice(){return Ci||12!==this.properties().childs().style.value()}lastValueData(e,t,i){var s;const r={noData:!0},o=this.priceScale();if(this.model().timeScale().isEmpty()||o.isEmpty()||this.data().isEmpty())return r;const n=this.model().timeScale().visibleBarsStrictRange(),a=this.firstValue();if(null===n||null===a)return r;let l,c;if(t){const e=this.data().bars().last();if(null===e)return r;l=e.value,c=e.index}else{const e=this.data().bars().search(n.lastBar(),u.PlotRowSearchMode.NearestLeft);if(null===e)return r;l=e.value,c=e.index}const h=null!==(s=void 0!==e?l[e]:this._barFunction(l,2))&&void 0!==s?s:NaN,d=this.barColorer().barStyle(c,!1),_=o.priceToCoordinate(h,a),p={...o.getFormattedValues(h,a,!0),noData:!1,color:d.barColor,floatCoordinate:_,coordinate:_,index:c};return i&&(p.price=h),p}isDWM(){return this.intervalObj().isDWM()}data(){var e;return null!==(e=this._data)&&void 0!==e?e:this._seriesSource.data()}clearData(){(0,r.assert)(null===this._data,"Cannot clear loaded data"),this._seriesSource.clearData()}nearestValue(e,t,i){var s;const r=this.nearestData(e,i);return null!==(s=null==r?void 0:r.value[t])&&void 0!==s?s:void 0}onSymbolIntervalChanged(){return this._symbolIntervalChanged}onIntervalChanged(){return this._intervalChanged}onStatusChanged(){return this._onStatusChanged}onRestarted(){return this._onRestarted}onExtendedHoursChanged(){return this._extendedHoursChanged}fixLastBar(e){if(!this._futureBarsPaneView){const t=this.bars().lastIndex();t&&(this._futureBarsPaneView=new We(this.model().timeScale(),this,t,e))}}requestMoreData(e){if(3!==this._status&&7!==this._status&&8!==this._status&&9!==this._status&&6!==this._status&&11!==this._status)return;if(this._model.timeScale().isEmpty())return;const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return;if(0===this.bars().size())return;const i=t.lastBar()-(0,r.ensureNotNull)(this.data().last()).index;if(this._predictBars<i&&(this._predictBars=i,this._seriesSource.requestMoreTickmarks(i)),!this._requestMoreDataAvailable)return;const s=(0,
r.ensureNotNull)(this.bars().firstIndex()),o=e||s-t.firstBar();o<=0||(Number.isFinite(o)?(this._requestMoreDataAvailable=!1,this._loading=!0,this._seriesSource.requestMoreData(o),this._setStatus(2)):wi.logWarn("requestMoreData: invalid bar count: "+o+", visible bars: ["+t.firstBar()+", "+t.lastBar()+"], last index: "+(0,r.ensureNotNull)(this.data().last()).index+", predicted bars: "+this._predictBars+", required bars:"+e))}isNeedRestart(e){return 5!==this._status&&(void 0===e&&(e=this.properties().childs().style.value()),!(0,g.isRangeStyle)(this._prevChartStyle)&&!(0,g.isRangeStyle)(e)&&!(this._prevChartStyle===e||!(0,g.isRequiringRestartSeriesStyles)(this._prevChartStyle)&&!(0,g.isRequiringRestartSeriesStyles)(e)))}isStyleSupportedForReplay(e){return 8!==e&&(0,g.isTimeBasedStyle)(e)}sessionId(){return this.properties().childs().sessionId.value()}sessionIdChanged(){return this._sessionIdChanged}priceRange(e,t){var i,s;const o=this._priceScale;if(this.data().isEmpty()||!o)return null;if(o.isLockScale()){const e=this._model.mainSeriesScaleRatio();if(null!==e){const i=o.internalHeight()/(this.model().timeScale().barSpacing()/e),s=(0,r.ensureNotNull)(this.data().search(t,u.PlotRowSearchMode.NearestLeft)).value,n=((0,r.ensure)(s[2])+(0,r.ensure)(s[3]))/2;return new _.PriceRange(n-.5*i,n+.5*i)}}const n=this.priceSource();let a,l,c;if(null!==n?(a=this.data().bars().minMaxOnRangeCached(e,t,[{name:n,offset:0}]),l=this.data().nsBars().minMaxOnRangeCached(e,t,[{name:n,offset:0}])):(a=this.data().bars().minMaxOnRangeCached(e,t,[{name:"low",offset:0},{name:"high",offset:0}]),l=this.data().nsBars().minMaxOnRange(e,t,[{name:"low",offset:0},{name:"high",offset:0}])),a=(0,d.mergeMinMax)(a,l),null===a)c=new _.PriceRange(-.5,.5);else if(a.min===a.max){const e=5/(null!==(s=null===(i=this._symbolInfo)||void 0===i?void 0:i.pricescale)&&void 0!==s?s:100);c=new _.PriceRange(a.min-e,a.max+e)}else c=new _.PriceRange(a.min,a.max);return o.isLog()?new _.PriceRange(o.priceToLogical(c.minValue()),o.priceToLogical(c.maxValue())):c}autoScaleInfo(e,t){const i=this.priceRange(e,t);if(null===this._paneView)return{range:i};const s=this._paneView;return{range:i,topPixelMargin:s.topPixelMargin?s.topPixelMargin():void 0,bottomPixelMargin:s.bottomPixelMargin?s.bottomPixelMargin():void 0}}onChartStyleChanged(e=!0){var t;this._updateBarFunction(),this.isNeedRestart()&&(this.data().clear(),this.model().timeScale().scrollToRealtime(!1),this.isInReplay()&&!this.isStyleSupportedForReplay(this.style())&&this._removeReplaySubscriber(),this.restart(e));const i=this.properties();this._prevChartStyle=i.childs().style.value(),this._onStyleChanged.fire(i.childs().style.value()),this.invalidateBarStylesCache(),this._updateLastPriceAnimationActive(),(null===(t=this._styleToRecover)||void 0===t?void 0:t.originalStyle)!==this.style()&&(this._styleToRecover=null)}setChartStyleWithIntervalIfNeeded(e,t){const i=this.interval(),s=null!=t?t:(0,Lt.getResolutionByChartStyle)(e,i,this._model.defaultResolutions()),r=X.Interval.isEqual(s,i);this.setSymbolParams({interval:r?void 0:s,
style:e})}idForAlert(){return(0,De.hash)(this.getSymbolString()+X.Interval.normalize(this.interval())).toString()}alertCreationAvailable(){const e=this.symbolInfo();return new Mt.WatchedValue(this.hasStateForAlert()&&null!==e&&!(0,g.isEconomicSymbol)(e)).readonly()}hasStateForAlert(){return fi}stateForAlert(){var e;const t=this.idForAlert(),i=Be.FormattersSerializer.serialize(this._formatter);let r;const o=this.isDWM()?s.Regular:this.sessionIdProxyProperty().value();if(this._symbolInfo&&this._symbolInfo.subsessions&&this._symbolInfo.subsessions.length>1){const t=null===(e=this._symbolInfo.subsessions)||void 0===e?void 0:e.find((e=>e.id===o));t&&(r=(0,Re.translateSessionExtendedDescription)(t.description))}const n=this.properties().childs(),a={id:t,uniqueId:t,type:"MainSeries",proSymbol:this.proSymbol(),actualSymbol:this.actualSymbol(),symbolString:this.getSymbolString(),interval:this.interval(),style:n.style.value(),styleInputs:this.getInputsProperties().state(),sessionId:o,sessionDescription:r,dividendsAdjustment:n.dividendsAdjustment.value(),backAdjustment:n.backAdjustment.value()&&!this.isBackAdjustmentForbiddenProperty().value(),settlementAsClose:n.settlementAsClose.value()&&!this.isSettlementAsCloseForbiddenProperty().value(),boxSize:this.data().boxSize,reversalAmount:this.data().reversalAmount,isSpread:this.isSpread(),formatter:i},l=(0,Ne.getSeriesDangerReason)(this);return l&&(a.dangerReason=l),a}styleStudyInfos(){return{haStyle:this._haStyle,renkoStyle:this._renkoStyle,pbStyle:this._pbStyle,kagiStyle:this._kagiStyle,pnfStyle:this._pnfStyle,rangeStyle:this._rangeStyle}}dataEvents(){return this._seriesSource.dataEvents()}isSpread(){var e;return"spread"===(null===(e=this._symbolInfo)||void 0===e?void 0:e.type)}isYield(){return null!==this._symbolInfo&&(0,hi.isYield)(this._symbolInfo)}sessionIdProxyProperty(){return this._sessionIdProxyProperty}symbolTextSourceProxyProperty(){return this._symbolTextSourceProxyProperty}setTextSourceIsAlwaysTickerRestrictionEnabled(e){this._textSourceIsAlwaysTickerRestrictionEnabled=e,this._recalcSymbolTextSourceProxyProperty()}isPrePostMarketPricesAvailableProperty(){return this._isPrePostMarketPricesAvailableProperty}isSettlementAsCloseForbiddenProperty(){return this._isSettlementAsCloseForbiddenProperty}isBackAdjustmentForbiddenProperty(){return this._isBackAdjustmentForbiddenProperty}invalidateBarColorerCache(){this._barColorerCache=null,this.invalidateBarStylesCache()}replayExitedDueUnsupportedInterval(){return this._replayExitedDueUnsupportedInterval}replayExitedDueUnavailableForUserInterval(){return this._replayExitedDueUnavailableForUserInterval}onTimeFrameApplied(){return this._onTimeFrameApplied}onInReplayStateChanged(){return this._onInReplayStateChanged}dataWindowView(){return this._dataWindowView}statusView(){return Si?this._statusView:null}legendView(){return this._legendView}marketStatusModel(){return this._marketStatusModel}isMainSeries(){return!0}dataUpdatedModeModel(){return this._dataUpdatedModeModel}dataProblemModel(){return this._dataProblemModel}
setDefaultTimeframe(e){this._pendingTimeRange=e}loadDataTo(e){const t=this._properties.childs().interval.value();this._onTimeFrameApplied.fire(e),this._seriesSource.modifySeries(this._getResolvingSymbolObject(),(0,Lt.getServerInterval)(t),e)}isInReplay(){return null!==this._replaySubscriber}quotes(){return this.data().isEmpty()?null:this._quotesProvider.quotes()}base(){return this._base}pointValue(){return this._pointValue}barCloseTime(){return this._lastBarCloseTime}priceSource(){let e=null;const t=this._properties.childs();switch(t.style.value()){case 2:e=t.lineStyle.childs().priceSource.value();break;case 14:e=t.lineWithMarkersStyle.childs().priceSource.value();break;case 15:e=t.steplineStyle.childs().priceSource.value();break;case 3:e=t.areaStyle.childs().priceSource.value();break;case 10:e=t.baselineStyle.childs().priceSource.value();break;case 13:e=t.columnStyle.childs().priceSource.value()}return e}updateAllViews(e){var t,i,s,r,o,n,a,l,c;null===(t=this._paneView)||void 0===t||t.update(e),this._dataWindowView.update(),this._legendView.update(),this._statusView.update(),this._averagePaneViews.forEach((t=>t.update(e))),this._highLowAvgPaneViews.forEach((t=>t.update(e))),this._labelPaneViews.forEach((t=>t.update(e))),this._priceAxisViews.forEach((t=>t.update(e))),this._priceLineAxisViews.forEach((t=>t.update(e))),null===(i=this._futureBarsPaneView)||void 0===i||i.update(e),null===(s=this._projectionBarsPaneView)||void 0===s||s.update(e),null===(r=this._waterlineView)||void 0===r||r.update(e),null===(o=this._prevClosePriceLineView)||void 0===o||o.update(e),null===(n=this._priceLineView)||void 0===n||n.update(e),null===(a=this._gotoDateView)||void 0===a||a.update(e),null===(l=this._endOfDataPaneView)||void 0===l||l.update(e),null===(c=this._baseHorizontalLineView)||void 0===c||c.update(e);const h=this._model.activeStrategySource().value();null==h||h.updateAllViews(e),this._lineStyleLastPriceCirclePaneView.update(e)}barFunction(){return this._barFunction}precomputedBarStyle(e){return this._precomputedBarStyles.get(e)}setPrecomputedBarStyle(e,t){this._precomputedBarStyles.set(e,t)}setSymbolParams(e){const{symbol:t,currency:i,unit:s,style:o}=e;let n=e.interval;const a=this.properties().childs(),l=this._symbolInfo;let c,h,d;if(null!==l?(c=void 0!==t&&!(0,St.symbolSameAsCurrent)(t,l),h=void 0!==i&&!(0,St.currenciesAreSame)(i,l),d=void 0!==s&&!(0,St.unitsAreSame)(s,l,this._model.unitConversionEnabled())):(c=void 0!==t&&t!==a.symbol.value(),h=void 0!==i&&i!==a.currencyId.value(),d=void 0!==s&&s!==a.unitId.value()),void 0!==n&&!c){const e=this.getSupportedResolution(n,!1);e!==n&&(wi.logWarn(`Change interval value from ${n} to ${e} because first is not supported`),n=e)}const u=void 0!==n&&!X.Interval.isEqual(a.interval.value(),n),_=void 0!==o&&o!==a.style.value(),p=[Mi("symbol",t,c),Mi("interval",n,u),Mi("currency",i,h),Mi("unit",s,d),Mi("style",o,_)].filter((e=>null!==e)).join("; ");wi.logInfo(`Applying series symbol params: ${p}`),void 0!==t&&a.symbol.setValue(t),void 0!==i&&a.currencyId.setValue(i),
void 0!==s&&a.unitId.setValue(s),u&&a.interval.setValue((0,r.ensureDefined)(n)),_&&a.style.setValue(o);let m=!1;if(_){m=this.isNeedRestart();const e=!c&&(h||d);this.onChartStyleChanged(e)}!m&&(c||u||h||d)&&this._applySymbolParamsChanges({symbolChanged:c,currencyChanged:h,unitChanged:d,intervalChanged:u,styleChanged:_}),(c||h||d)&&this.model().checkLineToolSelection()}setSymbol(e){this.setSymbolParams({symbol:e})}currency(){return this.properties().childs().currencyId.value()||null}setCurrency(e){this.setSymbolParams({currency:e})}isConvertedToOtherCurrency(){return(0,g.isConvertedToOtherCurrency)(this.symbolInfo())}unit(){return this.properties().childs().unitId.value()||null}setUnit(e){this.setSymbolParams({unit:e})}measureUnitId(){return(0,g.measureUnitId)(this.symbolInfo())}isConvertedToOtherUnit(){return(0,g.isConvertedToOtherUnit)(this.symbolInfo(),this._model.unitConversionEnabled())}valueAt(e,t){var i,s;return null!==(s=null===(i=this.data().search(e))||void 0===i?void 0:i.value[t])&&void 0!==s?s:null}symbolSource(){return this}barsProvider(){return this}title(e){return this.symbolTitle(e)}name(){return this.symbolTitle(ui.TitleDisplayTarget.StatusLine)}symbolTitle(e,t,i,s="exchange"){let r=this.properties().childs().symbol.value();const o=this.symbolInfo();if(null!==o){const{type:e}=o;r=(0,g.symbolTitle)(o,t,"forex"===e?"exchange":s)}return i?r:`${r}, ${(0,R.translatedIntervalString)(this.properties().childs().interval.value())}`}setObsoleteZOrder(e){this._obsoleteZOrder=e}obsoleteZOrder(){return this._obsoleteZOrder}valuesProvider(){return new U(this,this.model())}statusProvider(e){return new L(this,this._model.properties().childs().scalesProperties.childs().textColor,this.properties().childs().statusViewStyle,e)}open(e){const t=this.data().valueAt(e);return t&&t[1]}high(e){const t=this.data().valueAt(e);return t&&t[2]}low(e){const t=this.data().valueAt(e);return t&&t[3]}close(e){const t=this.data().valueAt(e);return t&&t[4]}moveItem(e,t,i){if(10===this.style()&&0===t){const t=this.priceScale(),i=this.properties().childs().baselineStyle,s=t.height(),r=100-e.y/s*100,o=r<0?0:Math.round(10*r)/10;i.childs().baseLevelPercentage.setValue(Math.max(Math.min(o,100),0))}}rerequestData(){this._applySymbolParamsChanges({force:!0})}switchToReplay(e,t){this._replaySubscriber=e,this._isReplayResolutionAvailableForUser=t,this._onInReplayStateChanged.fire(),this._replaySubscriber.modifySeries(this.getSymbolString(),this._properties.childs().interval.value()),this.rerequestData()}switchToRealtime(){this.isInReplay()&&(this._removeReplaySubscriber(),this.rerequestData())}requestMoreDataAvailable(){return this._requestMoreDataAvailable}seriesLoaded(){return this._seriesLoaded}endOfData(){var e;return void 0!==(null===(e=this._lastCompleteFlags)||void 0===e?void 0:e.data_completed)}endOfDataType(){var e,t;return null!==(t=null===(e=this._lastCompleteFlags)||void 0===e?void 0:e.data_completed)&&void 0!==t?t:null}dataPoweredBy(){return this._dataPoweredBy}boxSizeValue(){return this._boxSizeValue}isUserDeletable(){return!1}
changeTimeFrame(){(0,n.trackEvent)("GUI","Change timeframe")}onTagsChanged(){return this._tagsChanged}state(e){var t;const i=this.obsoleteZOrder();let s={type:"MainSeries",id:this.id(),zorder:i,haStyle:this._haStyle,renkoStyle:this._renkoStyle,pbStyle:this._pbStyle,kagiStyle:this._kagiStyle,pnfStyle:this._pnfStyle,rangeStyle:this._rangeStyle,formattingDeps:this._formattingDeps};const r=this.properties().state();if((null===(t=this._symbolInfo)||void 0===t?void 0:t.ticker)&&(r.symbol=this._symbolInfo.ticker),this._model.unitConversionEnabled()||(r.unitId=null),s.state=r,e){let e=this.bars();const t=this._model.timeScale().visibleExtendedDataRange(e,0);null!==t&&(e=e.range(t.firstBar(),t.lastBar())),s={...s,bars:xi(e),nsBars:xi(this.nsBars()),symbolInfo:this._symbolInfo,rtPrice:this.data().lastProjectionPrice,boxSize:this.data().boxSize,reversalAmount:this.data().reversalAmount}}return s}restoreState(e,t){if(t&&this._setStatus(5),!this._model.unitConversionEnabled()&&e.state&&delete e.state.unitId,this._properties.mergeAndFire(e.state),this._properties.hasChild("esdBreaksStyle")&&this._properties.removeProperty("esdBreaksStyle"),this._prevChartStyle=this.properties().childs().style.value(),this.createPaneView(),t){const t=e;this.restoreData(t.bars,t.nsBars,t.symbolInfo,t.rtPrice,t.boxSize,t.reversalAmount)}e.formattingDeps&&(this._formattingDeps=e.formattingDeps,this._recreatePriceFormattingDependencies())}restoreData(e,t,i,s,r,o){this._status=5,this._data=new h.SeriesData,this._data.bars().restoreState(e),this._data.nsBars().restoreState(t),this._updateSymbolInfo(i,!1),this._data.lastProjectionPrice=s,this._data.boxSize=r;const n=this.properties().childs();r||(6===n.style.value()?this._data.boxSize=n.pnfStyle.childs().inputs.childs().boxSize.value():4===n.style.value()&&(this._data.boxSize=n.renkoStyle.childs().inputs.childs().boxSize.value())),this._data.reversalAmount=o,o||5===n.style.value()&&(this._data.reversalAmount=n.kagiStyle.childs().inputs.childs().reversalAmount.value()),this._loading=!1}async setGotoDateResult(e,t){this._gotoDateResultCleared=!1;const s=await i.e(4079).then(i.bind(i,228579));this._gotoDateResultCleared||(this._gotoDateView=new s.GotoDateView(this,e,t),this._gotoDateView.doNotShowLastAvailableBar(this._doNotShowLastAvailableBar),this._model.updateSource(this))}clearGotoDateResult(){this._gotoDateView=null,this._gotoDateResultCleared=!0}doNotShowLastAvailableBar(e){var t;this._doNotShowLastAvailableBar=e,null===(t=this._gotoDateView)||void 0===t||t.doNotShowLastAvailableBar(e)}dataUpdated(){return this.dataEvents().dataUpdated()}getSupportedResolution(e,t=!0){if(null===this._symbolInfo||!(0,St.symbolSameAsCurrent)(this.symbol(),this._symbolInfo))return e;if(X.Interval.isRange(e)&&(0,g.isCloseBasedSymbol)(this._symbolInfo)){const t=this.interval();if(!X.Interval.isRange(t))return t;e="1D"}const i=this._symbolInfo.data_frequency;if(void 0!==i){let s=(0,Lt.getApplicableIntervalForFrequency)(i,e);if(s!==e){const e=this._model.defaultResolutions()
;if(!(e.includes(s)||window.is_authenticated&&window.user.is_pro)){const t=e.find((e=>(0,Lt.compareResolutions)(e,s)>=0));s=null!=t?t:e[e.length-1]}return t&&this.requestingResolutionLessThanFrequency.fire(i,s),s}}if(X.Interval.isIntraday(e)&&!this._symbolInfo.has_intraday)return t&&this.requestingIntradayWhenNotSupported.fire(),"D";if(this._symbolInfo.hasOwnProperty("supported_resolutions")){const t=X.Interval.normalize(e),i=this._symbolInfo.supported_resolutions;if(null!==t&&-1===i.indexOf(t))return i[0]}return e}startedAndCompleted(){return new Promise((e=>{this.isStarted()&&e(),this.dataEvents().completed().subscribe(this,e,!0)}))}_barsState(e){const t=e.state();return t.data.forEach((e=>e.value.splice(7,1))),t}_updateBarFunction(){this._barFunction=(0,ai.barFunctionByStyle)(this.style(),this.priceSource())}_setProperties(e){e.hasChild("timeframe")||e.merge({timeframe:""}),e.hasChild("shortName")||e.merge({shortName:""}),e.hasChild("currencyId")||e.addChild("currencyId",new(m())(null)),e.hasChild("unitId")||e.addChild("unitId",new(m())(null)),this._properties=e;const t=e.childs();t.currencyId.subscribe(this,this._onCurrencyChanged),t.unitId.subscribe(this,this._onUnitChanged),t.timeframe.subscribe(this,this.changeTimeFrame),e.subscribe(this,this._onPropertiesChanged)}_updateSessionIdProxyProperty(e){const t=this._properties.childs().sessionId.value();let i=t;if(e){const e=this.symbolInfo();null!==e&&(i=e.subsession_id||t)}this._ignoreSessionIdProxyPropertyChanges=!0,this._sessionIdProxyProperty.setValue(i),this._ignoreSessionIdProxyPropertyChanges=!1}_onSessionIdProxyPropertyChanged(){this._ignoreSessionIdProxyPropertyChanges||this._properties.childs().sessionId.setValue(this._sessionIdProxyProperty.value()),this._updateLastPriceAnimationActive()}_onSymbolResolved(e){this._seriesErrorMessage=null,this._updateSymbolInfo(e,!1),this._model.updateSource(this),this._model.onWidget()||((0,n.trackEvent)("Symbol",e.listed_exchange,e.name),(0,n.trackEvent)("Symbol Type",e.type,e.listed_exchange));const t=e.minmov/e.pricescale,i=this.properties().childs();4===i.style.value()&&i.renkoStyle.childs().inputs.childs().boxSize.value()<t?i.renkoStyle.childs().inputs.merge({boxSize:t}):6===i.style.value()&&i.pnfStyle.childs().inputs.childs().boxSize.value()<t?i.pnfStyle.childs().inputs.merge({boxSize:t}):5===i.style.value()&&i.kagiStyle.childs().inputs.childs().reversalAmount.value()<t&&i.kagiStyle.childs().inputs.merge({reversalAmount:t});const s=this.interval(),r=this.getSupportedResolution(s);s!==r&&this.setSymbolParams({interval:r}),this._checkChartStyle(),this._formattingDeps={format:e.format,pricescale:e.pricescale,minmov:e.minmov,fractional:e.fractional,minmove2:e.minmove2,variable_tick_size:e.variable_tick_size}}_onSymbolError(e){this._setStatus(4),this._loading=!1,this._properties.childs().shortName.setValue(this._properties.childs().symbol.value()),this._model.clearAllStudies(),this.updateAllViews((0,Te.sourceChangeEvent)(this.id())),this._model.updateSource(this),e!==It.permissionDenied&&this._model.resetTimeScale(),
this._sendTelemetryCounter("symbol_error",this._getTelemetryAdditionalData(e,!1)),this._symbolResolvingActive.setValue(!1)}_sendTelemetryCounter(e,t){void 0===t&&(t=this._getTelemetryAdditionalData());const i=Object.assign({count:1},{additional:t});Ee.telemetry.sendChartReport(e,i)}_getTelemetryAdditionalData(e,t){t=void 0===t||t;const i={symbol:this.actualSymbol()};return t&&(i.resolution=this.interval()),void 0!==e&&(i.reason=e),i}_onSeriesError(e){this._loading=!1;let t=e.error;const i=e.ctx;if(i){const e={};Object.keys(i).forEach((t=>{e[t]=i[t].toString()})),t=t.format(e)}yi&&wi.logNormal("Error reason: "+t),this._seriesErrorMessage=t;const s=bi&&this._symbolInfo?10:4;this._setStatus(s),this._seriesLoaded=!0,this._sendTelemetryCounter("series_error",this._getTelemetryAdditionalData(t)),this._enablePriceRangeReady()}_onSeriesLoading(e){this._loading=!0,this._setStatus(2)}_onDataUpdated(e,t){t?this._requestMoreDataAvailable=!0:this._lastPriceAnimationActive&&this._seriesLoaded&&this._lineStyleLastPriceCirclePaneView.update((0,Te.sourceChangeEvent)(this.id())),this._lastBarCloseTime=e&&e.closeTime||null,this._boxSizeValue.setValue(this.data().boxSize),this._statusView.update(),this.clearAveragePriceCache(),this.clearHighLowPriceCache();const i=this.model(),s=(0,r.ensureNotNull)(i.paneForSource(this));i.recalculatePane(s,(0,Te.sourceChangeEvent)({sourceId:this.id(),realtime:!t})),i.updateSource(this)}_setStatus(e){this._status=e,this._statusView.update(),this.model().updateSource(this),this._onStatusChanged.fire()}_onBarReceived(e){this.model().recalcVisibleRangeStudies(!0)}_recreateFormatter(){var e,t;this._formatter=(0,g.createSeriesFormatter)(null!==(e=this.symbolInfo())&&void 0!==e?e:this._formattingDeps,this.properties().childs().minTick.value()),this._ignoreMinMoveFormatter=(0,g.createSeriesFormatter)(this.symbolInfo(),this.properties().childs().minTick.value(),!0),null===(t=this._priceScale)||void 0===t||t.updateFormatter(),this._formatterChanged.fire()}_recreatePriceStep(){const{minMove:e,priceScale:t}=(0,g.getSeriesPriceFormattingState)(this.symbolInfo()),i=e/t;this._ignoreMinMovePriceStep=1/t,this._priceStep!==i&&(this._priceStep=i,this._priceStepChanged.fire())}_recreatePriceFormattingDependencies(){this._recreateFormatter(),this._recreatePriceStep()}_onQuotesUpdate(e,t){if(gi){const e=void 0!==t.values.change||void 0!==t.values.change_percent;e&&this._legendView.update();const i=void 0!==t.values.prev_close_price;i&&((0,r.ensureNotNull)(this._prevClosePriceLineView).update((0,Te.sourceChangeEvent)(this.id())),(0,r.ensureNotNull)(this._prevClosePriceAxisView).update((0,Te.sourceChangeEvent)(this.id()))),(e||i)&&this.model().updateSource(this)}void 0!==e.values.current_session&&e.values.current_session!==this._currentSession&&(this._currentSession=e.values.current_session,this._updateLastPriceAnimationActive())}_updateIsPrePostMarketPricesForbiddenProperty(){const e=(0,g.symbolHasPreOrPostMarket)(this._symbolInfo)&&(this.isDWM()||(0,g.isRegularSessionId)(this.sessionIdProxyProperty().value()))
;this._isPrePostMarketPricesAvailableProperty.setValue(e)}_updateSettlementAsCloseForbiddenProperty(){var e;const t=this.isDWM()&&Boolean(null===(e=this._symbolInfo)||void 0===e?void 0:e.has_settlement);this._isSettlementAsCloseForbiddenProperty.setValue(!t)}_updateBackAdjustmentForbiddenProperty(){var e;const t=Boolean(null===(e=this._symbolInfo)||void 0===e?void 0:e.has_backadjustment);this._isBackAdjustmentForbiddenProperty.setValue(!t)}_removeReplaySubscriber(){{if(!this.isInReplay())return;const e=this._replaySubscriber;this._replaySubscriber=null,this._isReplayResolutionAvailableForUser=null,this._onInReplayStateChanged.fire(),null==e||e.destroy()}}_getSymbolForApi(){return(0,g.symbolForApi)(this.symbolInfo()||this._prevSymbolInfo,this.symbol())}_getSymbolObject(){const e=this._getExtendedSymbolObject();if(v.SYMBOL_STRING_DATA.hasOwnProperty(this.properties().childs().style.value())){return{symbol:e,type:this.styleStudyInfo(this.getStyleShortName()+"Style").studyId+"!",inputs:this.getInputsProperties().state()}}return e}_getExtendedSymbolObject(){const e={symbol:this._getSymbolForApi()},t=this.properties().childs();null!==this.currency()&&(e["currency-id"]=this.currency());const i=this.unit();return this._model.unitConversionEnabled()&&null!==i&&(e["unit-id"]=i),this.isDWM()||(e.session=t.sessionId.value()),e.adjustment=t.dividendsAdjustment.value()?"dividends":"splits",t.backAdjustment.value()&&(e.backadjustment="default"),t.settlementAsClose.value()||(e["settlement-as-close"]=!1),e}_checkChartStyle(){const e=this.style();(0,g.isCloseBasedSymbol)(this.symbolInfo())?(0,g.isSingleValueBasedStyle)(e)||(this.requestingStyleIsNotSupported.fire(),this._styleToRecover={correctedStyle:this.style(),originalStyle:e}):null!==this._styleToRecover&&(this.requestingStyleSupportRecovered.fire(this._styleToRecover.originalStyle),this._styleToRecover=null)}_updateSymbolInfo(e,t){if(this._prevSymbolInfo=t?this._symbolInfo:null,this._symbolInfo=e,e){const t=this._properties.childs();t.shortName.setValue(e.name);const i=(0,g.extractSymbolNameFromSymbolInfo)(e,this.symbol());i&&t.symbol.setValue(i);const s=(0,g.symbolCurrency)(e),r=(0,g.symbolUnit)(e,this._model.unitConversionEnabled());"alwaysOff"===(0,K.currencyUnitVisibilityProperty)().value()||s===t.currencyId.value()&&r===t.unitId.value()||this._model.fullUpdate(),t.currencyId.setValue(s),t.unitId.setValue(r),this._updateSessionIdProxyProperty(!0)}this._base=e?e.pricescale/e.minmov:100,this._pointValue=e&&e.pointvalue||1;const i=(0,vt.encodeExtendedSymbolOrGetSimpleSymbolString)(this._getExtendedSymbolObject());this._quotesProvider.setQuotesSessionSymbol(i),this._marketStatusModel.setSymbolInfo(e),e&&this._recreatePriceFormattingDependencies(),this._statusView.update(),this.priceScale().updateFormatter(),this._symbolResolvingActive.setValue(!e),this._updateIsPrePostMarketPricesForbiddenProperty(),this._dataPoweredBy=(0,Ae.getDataVendorString)(e),this._updateBackAdjustmentForbiddenProperty(),this._updateSettlementAsCloseForbiddenProperty()}_createHighLowAvgViews(){
const e=this.properties().childs().highLowAvgPrice,t=this._getHighLowPrice.bind(this),i=function(e,t,i,s){const r=i.childs(),o=mt(e,t,{label:_t,labelVisible:r.highLowPriceLabelsVisible,lineVisible:r.highLowPriceLinesVisible,lineColor:r.highLowPriceLinesColor,lineWidth:r.highLowPriceLinesWidth},(()=>s(0))),n=mt(e,t,{label:pt,labelVisible:r.highLowPriceLabelsVisible,lineVisible:r.highLowPriceLinesVisible,lineColor:r.highLowPriceLinesColor,lineWidth:r.highLowPriceLinesWidth},(()=>s(1)));return{paneViews:[o.paneView,n.paneView],panePriceAxisViews:[o.panePriceAxisView,n.panePriceAxisView],priceAxisViews:[o.priceAxisView,n.priceAxisView],priceLineAxisViews:[o.priceLineAxisView,n.priceLineAxisView]}}(this._model,this,e,t);this._highLowAvgPaneViews.push(...i.paneViews),this._labelPaneViews.push(...i.panePriceAxisViews),this._priceAxisViews.push(...i.priceAxisViews),this._priceLineAxisViews.push(...i.priceLineAxisViews)}_createAverageViews(){}_getHighLowPrice(e){if(!this._highLowPriceCache.has(e)){const e=this._model.timeScale().visibleBarsStrictRange();if(null===e)return null;const t=function(e,t,i){return e.minMaxOnRangeCached(t,i,[{name:"low",offset:0},{name:"high",offset:0}])}(this._model.mainSeries().bars(),e.firstBar(),e.lastBar());if(null===t)return null;this._highLowPriceCache.set(1,t.min),this._highLowPriceCache.set(0,t.max)}return this._highLowPriceCache.get(e)}_getAveragePrice(e){return null}_onSeriesCompleted(e){var t;this._sendTelemetryCounter("series_loaded",this._getTelemetryAdditionalData()),this._loading=!1,this._seriesErrorMessage=null;let s=e.updateMode;switch("pulsed"===s&&(s="delayed"),s){case"streaming":this._setStatus(3);break;case"endofday":this._setStatus(6);break;case"delayed":this._setStatus(8);break;case"replay":this._setStatus(11)}s.match(/delayed_streaming/)&&this._setStatus(9),this._lastCompleteFlags=null!==(t=e.flags)&&void 0!==t?t:null;const o=(0,r.ensureNotNull)(this._model.paneForSource(this));o.recalculatePriceScale(this.priceScale(),(0,Te.sourceChangeEvent)(this.id()));const n=Tt.InvalidationMask.full();if(null!==this._model.appliedTimeFrame().value()&&n.lockVisibleTimeRangeOnResize(),this._model.invalidate(n),this.model().recalcVisibleRangeStudies(!0),this.model().recalcStudyBasedLineTools(),!this.priceScale().isLockScale()||this.model().timeScale().isEmpty()||this._seriesLoaded||(this.model().timeScale().correctOffset(),this.model().timeScale().correctBarSpacing(),this.model().resetPriceScale(o,this.priceScale())),this._seriesLoaded=!0,!Pi){Pi=!0;(0,i(975420).trackTiming)("Chart","Time to series",window.performance.now())}this.requestMoreData(),this._enablePriceRangeReady()}_notifyIntervalChanged(e){var t,i;const s={timeframe:null!==(t=this._pendingTimeRange)&&void 0!==t?t:void 0};this._intervalChanged.fire(e,s),this._pendingTimeRange=null!==(i=s.timeframe)&&void 0!==i?i:null}_onCurrencyChanged(){this._currencyChanged.fire()}_onUnitChanged(){this._unitChanged.fire()}_applySymbolParamsChanges(e){this._lastCompleteFlags=null,this.clearGotoDateResult()
;const t=this.interval(),i=this.currency(),s=this.unit(),o=X.Interval.isRange(t);o&&this._properties.childs().rangeStyle.childs().inputs.childs().range.setValue(X.Interval.parse(t).multiplier());const{symbolChanged:n,intervalChanged:a,currencyChanged:l,unitChanged:c,force:h}=e,d=a&&X.Interval.parse(t).isDWM()!=X.Interval.parse(t).isDWM();if((null!==i&&l||null!==s&&c)&&this.isInReplay()){const e=this.symbolInfo();(null===e||null!==i&&e.original_currency_id!==i||null!==s&&e.original_unit_id!==s)&&this._removeReplaySubscriber()}if(this._syncModel=null,this._prevRequestedInterval=t,5!==this._status&&(!this._seriesSource.isStarted()||n||l||c||d)&&this._updateSymbolInfo(null,!n&&(l||c)),this.isInReplay()){const e=()=>this._removeReplaySubscriber();n?e():a&&(o||X.Interval.isTicks(t)?e():(0,r.ensureNotNull)(this._isReplayResolutionAvailableForUser)(t)?this._isIntervalSupported(t)||(e(),this._replayExitedDueUnsupportedInterval.fire()):(e(),this._replayExitedDueUnavailableForUserInterval.fire()))}if(5===this._status)return void this._model.realignLineTools();this._loading=!0,this._setStatus(1),this._updateIsPrePostMarketPricesForbiddenProperty(),this._updateBackAdjustmentForbiddenProperty(),this._updateSettlementAsCloseForbiddenProperty(),this._symbolIntervalChanged.fire(),a&&this._notifyIntervalChanged(t),this._onRestarted.fire(),this._seriesLoaded=!1,this._lineStyleLastPriceCirclePaneView.stopAnimation();let u=null;this._pendingTimeRange&&(u=this._pendingTimeRange,this._pendingTimeRange=null),this._onTimeFrameApplied.fire(u),this._onBeforeModifySeries(this.getSymbolString(),t);const _=this._shouldDefineNumberOfBarsForModifySeries(e)&&this._visibleBarsCount()||null;this._data=null,this._seriesSource.modifySeries(this._getResolvingSymbolObject(),(0,Lt.getServerInterval)(t),u,h,_),this._seriesSource.isStarted()||(this._predictBars=0,this._seriesSource.start()),(n||l||c)&&this.disablePriceRangeReady(),this.updateAllViews((0,Te.sourceChangeEvent)(this.id())),this._model.lightUpdate()}_isIntervalSupported(e){return!this.isInReplay()||(0,r.ensureNotNull)(this._replaySubscriber).canChangeResolution(e)}_onBeforeModifySeries(e,t){this._replaySubscriber&&this._replaySubscriber.modifySeries(e,t)}_getResolvingSymbolObject(){let e=this._getSymbolObject();return this._replaySubscriber&&(e=this._replaySubscriber.generateReplaySymbol(e)),e}_onSessionIdPropertyChanged(){this._sessionIdChanged.fire(),this.isDWM()||(this.restart(),this._updateLastPriceAnimationActive())}_subscribeRestartToSessionIdChange(){this.properties().childs().sessionId.subscribe(this,this._onSessionIdPropertyChangedBound)}_unsubscribeRestartToSessionIdChange(){this.properties().childs().sessionId.unsubscribe(this,this._onSessionIdPropertyChangedBound)}_updateLastPriceAnimationActive(){if(!this._options.lastPriceAnimationEnabled)return;const e=this._lastPriceAnimationActive,t=this.properties().childs(),i=t.style.value(),s=3===i||10===i||2===i||14===i||15===i;if(!this._model.isSnapshot()&&t.visible.value()&&s){const e=this.currentSession(),t=!(0,
g.isRegularSessionId)(this.sessionIdProxyProperty().value())&&!this.isDWM();this._lastPriceAnimationActive="market"===e||t&&("pre_market"===e||"post_market"===e)}else this._lastPriceAnimationActive=!1;this._lastPriceAnimationActive&&e!==this._lastPriceAnimationActive&&this.model().invalidate(Tt.InvalidationMask.cursor())}_onPropertiesChanged(e){const t=this._properties.childs();e!==t.symbol&&e!==t.interval&&e!==t.timeframe&&(this._tagsChanged.fire(),this.createPaneView(),this.updateAllViews((0,Te.sourceChangeEvent)(this._id)),this.model().updateSource(this),(0,a.emit)("series_properties_changed",this._id))}_recalcSymbolTextSourceProxyProperty(){this._textSourceIsAlwaysTickerRestrictionEnabled?this._symbolTextSourceProxyProperty.setValue("ticker"):this._symbolTextSourceProxyProperty.setValue(this._properties.childs().statusViewStyle.childs().symbolTextSource.value())}_clearStylePlot(e,t){if(0===e.size())return;if(void 0===t&&e!==this.nsBars())return void(this._precomputedBarStyles=new WeakMap);const i=null!=t?t:(0,r.ensureNotNull)(e.firstIndex()),s=(0,r.ensureNotNull)(e.lastIndex())+1;e.range(i,s).each(((e,t)=>(this._precomputedBarStyles.delete(t),!1)))}_visibleBarsCount(){const e=this._model.timeScale().visibleBarsStrictRange();return null==e?void 0:e.count()}_shouldDefineNumberOfBarsForModifySeries(e){return!1}}},195543:(e,t,i)=>{"use strict";i.d(t,{SeriesHorizontalBaseLinePaneView:()=>r});var s=i(456757);class r extends s.SeriesHorizontalLinePaneView{constructor(e){super(e)}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.priceScale().mode();if(!e.percentage&&!e.indexedTo100)return;const t=this._series.firstValue();null!==t&&(this._lineRendererData.visible=!0,this._lineRendererData.y=this._series.priceScale().priceToCoordinate(t,t),this._lineRendererData.color=this._series.properties().childs().baseLineColor.value())}}},456757:(e,t,i)=>{"use strict";i.d(t,{SeriesHorizontalLinePaneView:()=>r});var s=i(955831);class r extends s.HorizontalLinePaneView{constructor(e){super(),this._series=e,this._model=e.model()}}},370552:(e,t,i)=>{"use strict";var s;i.d(t,{InsertionErrorCode:()=>s}),function(e){e.StudyCannotBeChild="cannot_be_child",e.StubWasRemoved="stub_was_removed",e.CannotGetMetainfo="cannot_get_metainfo",e.CannotCompilePub="cannot_compile_pub",e.Cancelled="cancelled",e.Unknown="unknown"}(s||(s={}))},65541:(e,t,i)=>{"use strict";i.d(t,{StudyColorRotatorFactory:()=>h});var s=i(987088),r=i(724377),o=i(246733),n=i(161488)
;const a=["color-sky-blue-400","color-banana-yellow-700","color-deep-blue-500","color-grapes-purple-a700","color-iguana-green-500","color-minty-green-a700","color-ripe-red-a200","color-berry-pink-200","color-tv-blue-a100","color-tan-orange-a200","color-sky-blue-a400","color-deep-blue-a100","color-grapes-purple-400","color-iguana-green-a700","color-minty-green-200","color-ripe-red-200","color-berry-pink-a200","color-ripe-red-500","color-grapes-purple-500","color-deep-blue-400","color-tv-blue-a200","color-sky-blue-500","color-iguana-green-400","color-minty-green-400","color-banana-yellow-600","color-tan-orange-500","color-berry-pink-400","color-ripe-red-300","color-grapes-purple-300","color-deep-blue-300","color-tv-blue-300","color-sky-blue-300","color-iguana-green-300","color-minty-green-300","color-banana-yellow-400","color-tan-orange-300","color-berry-pink-300","color-tan-orange-a700"];class l{constructor(e){this._offset=0,this._offset=e}getColor(e){if(0===this._offset)return e;const t=a[(this._offset-1)%a.length],i=s.colorsPalette[t],n=(0,o.isHexColor)(e)?1:(0,r.parseRgba)(e)[3];return(0,o.generateColor)(i,(0,o.alphaToTransparency)(n))}}class c{constructor(e,t){this._offset=e,this._modelStartOffset=t}getColor(e){if((0,o.isHexColor)(e)){const t=(0,r.parseRgb)(e);return(0,r.rgbToHexString)((0,r.shiftRgb)(t,this._offset,this._modelStartOffset))}{const t=(0,r.parseRgba)(e);return(0,r.rgbaToString)((0,r.shiftRgba)(t,this._offset,this._modelStartOffset))}}}class h{constructor(e){this._chartModel=e}getColorRotator(e){const t=(0,n.studyColorRotationMode)(e);if(null===t)return null;const i=this._calcDefaultColorsOffset(e);switch(t){case"loop":return new l(i);case"shift":{const e=this._chartModel.getStudyShiftColorStartOffset();return new c(i,e)}}}_calcDefaultColorsOffset(e){let t=0;const i=(0,n.useSameColorRotationComparator)(e);return this._chartModel.dataSources().filter(n.isStudy).forEach((s=>{i(e,s.metaInfo())&&t++})),t}}},849245:(e,t,i)=>{"use strict";i.d(t,{StudyInserter:()=>c});var s=i(526075),r=i(389137),o=i(42292),n=i(370552);const a=(0,i(201089).getLogger)("Chart.Studies.StudyInserter"),l=/^PUB;.*/;class c{constructor(e,t,i){this._parentSources=[],this._propsState=void 0,this._preferredPriceScale=void 0,this._allowChangeCurrency=!1,this._allowChangeUnit=!1,this._paneSize=void 0,this._forceOverlay=!1,this._studyMetaInfoRepository=t,this._inserterImpl=i,this._studyDescriptor=e}setParentSources(e){this._parentSources=e}setPaneSize(e){this._paneSize=e}setPreferredPriceScale(e){this._preferredPriceScale=e}setAllowChangeCurrency(e){this._allowChangeCurrency=e}setAllowChangeUnit(e){this._allowChangeUnit=e}setForceOverlay(e){this._forceOverlay=e}setPropertiesState(e){this._propsState=e}setTargetPriceScaleMode(e){this._targetPriceScaleMode=e}async insert(e,t){var i,c;const h=void 0!==(d=this._inserterImpl).createStub&&void 0!==d.removeStub?this._inserterImpl.createStub():null;var d;let u,_=!0;try{u=await this._studyMetaInfoRepository.findById(this._studyDescriptor)}catch(e){
a.logWarn(`Cannot get study ${JSON.stringify(this._studyDescriptor)}`);const t=this._studyDescriptor.pineId,s=l.test(t),r=!!(null===(i=null==e?void 0:e.errors)||void 0===i?void 0:i.length);return s&&r?Promise.reject(n.InsertionErrorCode.CannotCompilePub):Promise.reject(n.InsertionErrorCode.CannotGetMetainfo)}finally{null!==h&&(_=this._inserterImpl.removeStub(h))}if(!_)return Promise.reject(n.InsertionErrorCode.StubWasRemoved);if(void 0!==t&&t.cancelled)return Promise.reject(n.InsertionErrorCode.Cancelled);if(!this._canApplyStudyToParent(u))return Promise.reject(n.InsertionErrorCode.StudyCannotBeChild);const p={...u.defaults.inputs};let m={};if(void 0!==e){const t=s.StudyMetaInfo.getStudyPropertyRootName(u),i=(0,r.clone)((0,o.defaults)(t));(0,r.merge)(p,i.inputs);const n=await e(p,u.inputs,u);m=n.inputs,this._parentSources=null!==(c=n.parentSources)&&void 0!==c?c:[]}if(void 0!==t&&t.cancelled)return Promise.reject(n.InsertionErrorCode.Cancelled);const g=this._insertStudy(u,m);return null===g?Promise.reject(n.InsertionErrorCode.Unknown):(await g.startPromise,g.study)}_insertStudy(e,t){return this._inserterImpl.createStudy(e,t,null,this._propsState,this._forceOverlay,this._parentSources,this._preferredPriceScale,this._allowChangeCurrency,this._allowChangeUnit,this._paneSize,this._targetPriceScaleMode)}_canApplyStudyToParent(e){return 0===this._parentSources.length||s.StudyMetaInfo.canBeChild(e)}}},459711:(e,t,i)=>{"use strict";i.d(t,{StudyLineToolStub:()=>n,isStudyLineToolStub:()=>o});var s=i(401580),r=i(860142);function o(e){return e instanceof n}class n extends r.StudyStub{constructor(e,t,i){var r;super(e,{...t,ownFirstValue:null},i),this._linkKey=new s.WatchedValue(null!==(r=t.linkKey)&&void 0!==r?r:null)}linkKey(){return this._linkKey}}},167258:(e,t,i)=>{"use strict";var s=i(707957).Delegate;function r(){this._marksByIndex=new Map,this._marksBySpan=[],this.changed=new s,this.minIndex=void 0,this.maxIndex=void 0}r.prototype.reset=function(){this._resetImpl(),this.changed.fire()},r.prototype._resetImpl=function(){this._marksByIndex=new Map,this._marksBySpan=[],this.minIndex=void 0,this.maxIndex=void 0,this._cache=void 0},r.prototype.merge=function(e){if(0!==e.length){var t=e[0].index,i=e[e.length-1].index;t<=this.minIndex&&i>=this.maxIndex&&this._resetImpl();for(var s=this._marksBySpan,r=new Set,o=0;o<e.length;o++){var n=(c=e[o]).index,a=c.span,l=this._marksByIndex.get(c.index);if(l){if(l.index===c.index&&l.span===c.span){l.time=c.time;continue}this._removeTickmark(l)}}for(o=0;o<e.length;o++){var c;n=(c=e[o]).index,a=c.span;if(!this._marksByIndex.has(c.index)){this._marksByIndex.set(n,c);var h=s[a];void 0===h&&(h=[],s[a]=h);var d=0===h.length||h[h.length-1].index<c.index;s[a].push(c),d||r.add(a)}}this.minIndex=void 0===this.minIndex?t:Math.min(this.minIndex,t),this.maxIndex=void 0===this.maxIndex?i:Math.max(this.maxIndex,i);for(a=s.length;a--;)s[a]&&(s[a].length||delete s[a],r.has(a)&&s[a].sort(this._sortByIndexAsc));this._cache=void 0,this.changed.fire()}},r.prototype._removeTickmark=function(e){var t=e.index
;if(this._marksByIndex.get(t)===e){this._marksByIndex.delete(t),t<=this.minIndex&&this.minIndex++,t>=this.maxIndex&&this.maxIndex--,this.maxIndex<this.minIndex&&(this.minIndex=void 0,this.maxIndex=void 0);var i=this._marksBySpan[e.span],s=i.indexOf(e);-1!==s&&i.splice(s,1)}},r.prototype._sortByIndexAsc=function(e,t){return e.index-t.index},r.prototype.removeTail=function(e){var t=new Map;this.maxIndex=this.minIndex,this._marksByIndex.forEach(function(i,s){i.time<e&&(t.set(s,i),this.maxIndex=Math.max(this.maxIndex,s))}.bind(this)),this._marksByIndex=t},r.prototype.addTail=function(e){for(var t=0;t<e.length;t++)e[t].index=this.maxIndex+t+1;this.merge(e)},r.prototype.indexToTime=function(e){var t=this._marksByIndex.get(e);return t?new Date(1e3*t.time):null},r.prototype.density=function(){var e=this.maxIndex-this.minIndex;if(0!==e)return 1e3*(this._marksByIndex.get(this.maxIndex).time-this._marksByIndex.get(this.minIndex).time)/e},r.prototype.estimateLeft=function(e){var t=this.density();if(t)return(1e3*this._marksByIndex.get(this.minIndex).time-e)/t},r.prototype.nearestIndex=function(e){for(var t=this.minIndex,i=this.maxIndex;i-t>2;){if(1e3*this._marksByIndex.get(t).time===e)return t;if(1e3*this._marksByIndex.get(i).time===e)return i;var s=Math.round((t+i)/2);1e3*this._marksByIndex.get(s).time>e?i=s:t=s}return t},r.prototype.build=function(e,t){var i=Math.ceil(t/e);if(this._maxbar===i&&this._cache)return this._cache;this._maxbar=i;for(var s=[],r=this._marksBySpan.length;r--;)if(this._marksBySpan[r]){var o=s;s=[];for(var n=o.length,a=0,l=this._marksBySpan[r],c=l.length,h=1/0,d=-1/0,u=0;u<c;u++){for(var _=l[u],p=_.index;a<n;){var m=o[a],g=m.index;if(!(g<p)){h=g;break}a++,s.push(m),d=g,h=1/0}h-p>=i&&p-d>=i&&(s.push(_),d=p)}for(;a<n;a++)s.push(o[a])}return this._cache=s,this._cache},r.prototype.state=function(e){for(var t=[],i=this._marksBySpan.length;i--;)this._marksBySpan[i]&&(t=t.concat(this._marksBySpan[i]));if(null!==e){const i=e.firstBar(),s=e.lastBar();t=t.filter((e=>e.index>=i&&e.index<=s))}return{marks:t=t.map((function(e){return[e.span,e.time,e.index]})),version:2}},r.prototype.restoreState=function(e){if(this._marksByIndex=new Map,this._marksBySpan=[],this.maxIndex=void 0,this.minIndex=void 0,e&&e.marks&&e.marks.length)if(2===e.version){var t=e.marks.map((function(e){return{span:e[0],time:e[1],index:e[2]}}));this.merge(t)}else this.merge(e.marks)},e.exports.Tickmarks=r},827023:(e,t,i)=>{"use strict";i.d(t,{restoreTimeHoursFormatSettingsValue:()=>l,timeHoursFormatProperty:()=>a});var s=i(62802),r=i(152633);const o="time_hours_format";function n(){return s.getValue(o,"24-hours")}const a=(0,r.createPrimitiveProperty)(n());function l(){a.setValue("24-hours"),s.remove(o)}s.onSync.subscribe(null,(()=>a.setValue(n()))),a.subscribe(null,(()=>s.setValue(o,a.value())))},458527:(e,t,i)=>{"use strict";i.d(t,{trackChartStyleChanged:()=>h,trackDrawingCloned:()=>c,trackDrawingCreated:()=>a,trackDrawingPasted:()=>l});var s=i(776734),r=i(650151),o=i(339315);function n(e,t){(0,s.getTracker)().then((i=>{if(null!==i){const s=(0,
r.ensureNotNull)(e.model().mainSeries().symbolInfo()),o=s.pro_name||s.name;i.trackDrawingsAnalytics(o,e.name(),t)}}))}function a(e){n(e,"create")}function l(e){n(e,"paste")}function c(e){n(e,"clone")}function h(e){(0,s.getTracker)().then((t=>{if(null!==t){const i=o.STYLE_SHORT_NAMES[e];t.trackChartStyle(i)}}))}},440058:(e,t,i)=>{"use strict";i.d(t,{forceTradingObjVisibilityOnScreenshot:()=>h,restoreShowOnScreenshotSettingsValue:()=>c,showOnScreenshotProperty:()=>l});var s=i(62802),r=i(401580),o=i(152633);const n="trading_drawings_on_screenshot";function a(){return s.getBool(n,!1)}const l=(0,o.createPrimitiveProperty)(a());function c(){l.setValue(!1),s.remove(n)}s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())));const h=new r.WatchedValue(null)},376163:(e,t,i)=>{"use strict";i.d(t,{ApplyLineToolTemplateUndoCommand:()=>r});var s=i(142257);class r extends s.UndoCommand{constructor(e,t,i){super(i),this._source=e,this._newState=t,this._oldState=e.properties().state()}redo(){this._source.applyTemplate(this._newState)}undo(){this._source.applyTemplate(this._oldState)}}},553582:(e,t,i)=>{"use strict";i.d(t,{CreateLineToolUndoCommand:()=>c});var s=i(650151),r=i(444372),o=i(809796),n=i(750860),a=i(918208);const l=new o.TranslatedString("create {tool}",r.t(null,void 0,i(581791)));class c extends n.LineToolSynchronizeUndoCommand{constructor({model:e,pane:t,lineTool:i,ownerSource:s,drawOnAllChartsMode:r=0,id:n}){super(e,l.format({tool:new o.TranslatedString(i,a.lineToolsLocalizedNames[i])}),!1),this._lineId=null,this._lineState=null,this._paneIndex=e.panes().indexOf(t),this._lineTool=i,this._ownerSourceId=s.id(),this._lineId=null!=n?n:null,this._drawOnAllChartsMode=r}startCreatingLine(e,t,i,s){var r;const o=this._chartModel.panes()[this._paneIndex],n=this._chartModel.dataSourceForId(this._ownerSourceId),a=this._chartModel.createLineTool(o,e,this._lineTool,t,i,s,n||void 0,null!==(r=this._lineId)&&void 0!==r?r:void 0);return this._lineId=a.id(),!this._chartModel.lineBeingCreated()}continueCreatingLine(e,t,i,s){const r=this._chartModel.continueCreatingLine(e,t,i,s);return r&&this._chartModel.setShouldBeSavedEvenIfHidden(!0),r}line(){return null===this._lineId?null:this._chartModel.dataSourceForId(this._lineId)}drawOnAllCharts(){return 0!==this._drawOnAllChartsMode}_redo(){if(null===this._lineState)return;const e=this._chartModel.restoreSource(!1,this._paneIndex,null,(0,s.ensureNotNull)(this._lineState),null);null!==e&&(this._lineId=e.id(),this._lineState=null,e.share(this._drawOnAllChartsMode))}_undo(){const e=this.line();null!==e&&(this._lineState=e.state(!1),this._chartModel.removeSource(e),this._lineId=null)}}},731327:(e,t,i)=>{"use strict";i.d(t,{ExcludeLineToolsFromGroupUndoCommand:()=>c});var s=i(650151),r=(i(586463),i(444372)),o=i(809796),n=i(389137),a=i(142257);const l=new o.TranslatedString("exclude line tools from group {group}",r.t(null,void 0,i(363391)));class c extends a.UndoCommand{constructor(e,t,i){super(l.format({group:t.name().value()})),this._model=e,this._groupId=t.id,
this._groupName=t.name().value(),this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))).filter(n.notNull);e.excludeLineTools(t),0===e.lineTools().length&&this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=this._model.lineToolsGroupModel().groupForId(this._groupId);null!==t?t.addLineTools(e):this._model.lineToolsGroupModel().createGroup(e,this._groupName,this._groupId)}}},750860:(e,t,i)=>{"use strict";i.d(t,{LineToolSynchronizeUndoCommand:()=>r});var s=i(142257);class r extends s.UndoCommand{constructor(e,t,i){super(t,i),this._invalidateViaSync=!1,this._chartModel=e,this._invalidateViaSync=e.lineToolsSynchronizer().invalidateViaSync()}redo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSyncedAction((()=>this._redo())):this._redo()}undo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSyncedAction((()=>this._undo())):this._undo()}}},371764:(e,t,i)=>{"use strict";i.d(t,{PriceScaleChangeUndoCommand:()=>h});var s=i(650151),r=i(444372),o=i(809796),n=i(201089),a=i(142257);const l=(0,n.getLogger)("Chart.ChartUndoModel"),c=new o.TranslatedString("scale price",r.t(null,void 0,i(347222)));class h extends a.UndoCommand{constructor(e,t,i,s,r){super(c,!1),this._newPriceScaleState=null,this._model=e,this._paneIndex=e.panes().indexOf(t),this._priceScaleId=i.id(),this._state=s,this._timestamp=r?performance.now():null}undo(){if(null!==this._newPriceScaleState)return void l.logDebug("PriceScaleChangeUndoCommand.undo: Command is already undone");const[e,t]=this._paneAndScale();this._newPriceScaleState=t.state(),this._model.restorePriceScaleState(e,t,this._state)}redo(){if(null===this._newPriceScaleState)return void l.logDebug("PriceScaleChangeUndoCommand.redo: Command is not undone");const[e,t]=this._paneAndScale();this._model.restorePriceScaleState(e,t,this._newPriceScaleState),this._newPriceScaleState=null}canMerge(e){return e instanceof h&&null!==this._timestamp&&null!==e._timestamp&&null===this._newPriceScaleState&&e._model===this._model&&e._paneIndex===this._paneIndex&&e._priceScaleId===this._priceScaleId&&Math.abs(e._timestamp-this._timestamp)<1e3}merge(e){this._timestamp=e._timestamp}_paneAndScale(){const e=this._model.panes()[this._paneIndex],t=(0,s.ensureNotNull)(e.getPriceScaleById(this._priceScaleId));return[e,t]}}},744084:(e,t,i)=>{"use strict";i.d(t,{RemoveLineDataSourcesUndoCommand:()=>n});var s=i(650151),r=i(750860),o=i(731327);class n extends r.LineToolSynchronizeUndoCommand{constructor({chartModel:e,title:t,lineDataSourceIds:i}){super(e,t),this._excludeLineToolsFromGroupUndoCommands=[],this._undoState=[],this._lineDataSourceIds=i}_redo(){const e=this._lineDataSourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._groupLineToolsByGroups(e).forEach(((e,t)=>{const i=new o.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,t,e)
;i.redo(),this._excludeLineToolsFromGroupUndoCommands.push(i)})),e.forEach((e=>{this._undoState.push({state:e.state(!1),paneIndex:this._chartModel.panes().indexOf((0,s.ensureNotNull)(this._chartModel.paneForSource(e))),sharingMode:e.sharingMode().value()}),this._chartModel.removeSource(e)}))}_undo(){var e;for(let t=this._undoState.shift();t;t=this._undoState.shift())null===(e=this._chartModel.restoreSource(!1,t.paneIndex,null,t.state,null))||void 0===e||e.share(t.sharingMode);this._excludeLineToolsFromGroupUndoCommands.forEach((e=>e.undo()))}_groupLineToolsByGroups(e){const t=this._chartModel.lineToolsGroupModel();return e.reduce(((e,i)=>{const s=t.groupForLineTool(i);if(null!==s){const t=e.get(s)||[];t.push(i),e.set(s,t)}return e}),new Map)}}},558105:(e,t,i)=>{"use strict";i.d(t,{RemoveSourcesUndoCommand:()=>m});var s=i(650151),r=i(444372),o=i(809796),n=i(247001),a=i(750860),l=i(713473),c=i(201089),h=i(569010),d=i(161488),u=i(744084);const _=(0,c.getLogger)("Chart.RemoveSourcesUndoCommand"),p=new o.TranslatedString("remove line data sources",r.t(null,void 0,i(66414)));class m extends a.LineToolSynchronizeUndoCommand{constructor(e,t,i){super(e,i),this._removeLineDataSourcesUndoCommand=null,this._initialPriceScaleMode=null;const[r,o]=(0,h.closeSourcesSet)(e,t).reduce(((e,t)=>((0,l.isLineTool)(t)?e[1].push(t.id()):e[0].push(t.id()),e)),[[],[]]);this._sourceIds=r,this._lineDataSourceIds=o,this._sourceStates=[],this._paneIndexes=[],this._priceScalePositionIds=[],this._paneStates=[],this._restorePanes=[];const n=t[0];1===t.length&&(0,d.isStudy)(n)&&(this._initialPriceScaleMode=(0,s.ensureNotNull)(n.priceScale()).mode())}removedIds(){return[...this._sourceIds,...this._lineDataSourceIds]}_redo(){const e=this._chartModel.panes().length,t=this._sourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._sourceStates=t.map((e=>(0,s.ensureNotNull)(e.state(!1))));const i=t.map((e=>(0,s.ensureNotNull)(this._chartModel.paneForSource(e))));this._paneIndexes=i.map((e=>this._chartModel.panes().indexOf(e))),this._lineDataSourceIds.length>0&&(this._removeLineDataSourcesUndoCommand=new u.RemoveLineDataSourcesUndoCommand({title:p,chartModel:this._chartModel,lineDataSourceIds:this._lineDataSourceIds}),this._removeLineDataSourcesUndoCommand.redo()),this._priceScalePositionIds=t.map(((e,t)=>{const s=e.priceScale();if(null===s)return null;const r=i[t].priceScalePosition(s);return{id:s.id(),position:r,priceScaleIndex:i[t].priceScaleIndex(s,r)}}));const r=new Set;t.forEach(((e,t)=>{r.add(this._paneIndexes[t])})),this._paneStates=t.map(((e,t)=>{const s=this._paneIndexes[t];return r.has(s)?i[t].state(!1,!0):null})),this._restorePanes=t.map((e=>this._chartModel.removeSource(e))),t.forEach((e=>{(0,d.isStudy)(e)&&(0,n.trackStudies)(e,"remove")})),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}_undo(){const e=[];for(let t=this._sourceStates.length-1;t>=0;t--){
const i=this._chartModel.restoreSource(this._restorePanes[t],this._paneIndexes[t],this._paneStates[t],this._sourceStates[t],this._priceScalePositionIds[t]);i&&e.push(i)}e.some(((t,i)=>t.id()!==this._sourceIds[e.length-i-1]))&&_.logError("Source was restored improperly - source ids does not match"),null!==this._initialPriceScaleMode&&(0,s.ensureNotNull)(e[0].priceScale()).setMode(this._initialPriceScaleMode),this._removeLineDataSourcesUndoCommand&&this._removeLineDataSourcesUndoCommand.undo()}}},727803:(e,t,i)=>{"use strict";i.d(t,{RestoreDefaultsPreferencesUndoCommand:()=>y});var s=i(650151),r=i(444372),o=i(809796),n=i(142257),a=i(679356),l=i(992543),c=i(827023),h=i(14952),d=i(261066),u=i(480059),_=i(535503),p=i(939702),m=i(690142),g=i(440058),S=i(939243),v=i(439016),f=i(360758);const b=new o.TranslatedString("apply all chart properties",r.t(null,void 0,i(64034)));class y extends n.UndoCommand{constructor(e){super(b),this._trading=null,this._oldShowSellBuyButtons=null,this._oldNoConfirmEnabled=null,this._oldShowOnlyRejectionNotifications=null,this._oldShowPricesWithZeroVolume=null,this._oldShowPricesWithSpread=null,this._oldOrderExecutedSoundEnabled=null,this._prevWatermarkPreferences=null,this._prevAlertPreferences=null,this._model=e,this._trading=(0,v.tradingService)(),null!==this._trading&&(this._oldShowSellBuyButtons=this._trading.showSellBuyButtons.value(),this._oldNoConfirmEnabled=this._trading.noConfirmEnabled.value(),this._oldShowOnlyRejectionNotifications=this._trading.showOnlyRejectionNotifications.value(),this._oldShowPricesWithZeroVolume=this._trading.showPricesWith().zeroVolume.value(),this._oldShowPricesWithSpread=this._trading.showPricesWith().spread.value(),this._oldOrderExecutedSoundEnabled=this._trading.orderExecutedSoundParams.enabled.value()),this._defaultsPreferences=(0,a.defaultsPreferencesByWhiteList)(this._model,this._model.mainSeries()),this._oldPreferences=e.preferences(),this._prevDateFormat=l.dateFormatProperty.value(),this._prevAlertPreferences=(0,S.getSettingsProperty)().state(),this._model.onWidget()||(this._prevWithWeekday=m.withWeekdayProperty.value()),this._prevTimeHoursFormat=c.timeHoursFormatProperty.value(),this._prevAddPlusButton=f.addPlusButtonProperty.value(),this._prevShowOpenMarkerStatus=h.showMarketOpenStatusProperty.value(),this._prevCurrencyUnitVisibility=(0,d.currencyUnitVisibilityProperty)().value(),this._prevAutoLogButtonsVisibility=(0,u.autoLogButtonsVisibilityProperty)().value(),this._prevNavigationButtonsVisibility=(0,_.property)().value(),this._prevPaneButtonsVisibility=(0,p.property)().value();const t=this._model.watermarkSource();null!==t&&(this._prevWatermarkPreferences=t.properties().state())}redo(){null!==this._trading&&(this._trading.showSellBuyButtons.setValue(!0),this._trading.noConfirmEnabled.setValue(!1),this._trading.showOnlyRejectionNotifications.setValue(!1),this._trading.showPricesWith().zeroVolume.setValue(!0),this._trading.showPricesWith().spread.setValue(!0),this._trading.orderExecutedSoundParams.enabled.setValue(!1)),
this._model.applyPreferences(this._defaultsPreferences),this._model.updateScales(),(0,l.restoreDateFormatSettingsValue)(),(0,c.restoreTimeHoursFormatSettingsValue)(),(0,f.restoreAddPlusButtonSettingsValue)(),(0,h.restoreShowMarketOpenStatusProperty)(),(0,d.restoreCurrencyUnitVisibilitySettingsValue)(),(0,u.restoreAutoLogButtonsVisibilitySettingsValue)(),(0,_.restoreNavigationButtonsVisibilitySettingsValue)(),(0,p.restorePaneButtonsVisibilitySettingsValue)(),(0,m.restoreWithWeekdaySettingsValue)(),(0,g.restoreShowOnScreenshotSettingsValue)(),(0,S.restoreSettingsProperty)();const e=this._model.watermarkSource();null!==e&&e.restorePropertiesDefaults()}undo(){null!==this._trading&&(this._trading.showSellBuyButtons.setValue((0,s.ensureNotNull)(this._oldShowSellBuyButtons)),this._trading.noConfirmEnabled.setValue((0,s.ensureNotNull)(this._oldNoConfirmEnabled)),this._trading.showOnlyRejectionNotifications.setValue((0,s.ensureNotNull)(this._oldShowOnlyRejectionNotifications)),this._trading.showPricesWith().zeroVolume.setValue((0,s.ensureNotNull)(this._oldShowPricesWithZeroVolume)),this._trading.showPricesWith().spread.setValue((0,s.ensureNotNull)(this._oldShowPricesWithSpread)),this._trading.orderExecutedSoundParams.enabled.setValue((0,s.ensureNotNull)(this._oldOrderExecutedSoundEnabled))),this._model.applyPreferences(this._oldPreferences),this._model.updateScales(),l.dateFormatProperty.setValue(this._prevDateFormat),c.timeHoursFormatProperty.setValue(this._prevTimeHoursFormat),h.showMarketOpenStatusProperty.setValue(this._prevShowOpenMarkerStatus),f.addPlusButtonProperty.setValue(this._prevAddPlusButton),(0,d.currencyUnitVisibilityProperty)().setValue(this._prevCurrencyUnitVisibility),(0,u.autoLogButtonsVisibilityProperty)().setValue(this._prevAutoLogButtonsVisibility),(0,_.property)().setValue(this._prevNavigationButtonsVisibility),(0,p.property)().setValue(this._prevPaneButtonsVisibility),null!==this._prevAlertPreferences&&(0,S.getSettingsProperty)().mergeAndFire(this._prevAlertPreferences),this._model.onWidget()||m.withWeekdayProperty.setValue(this._prevWithWeekday);const e=this._model.watermarkSource();null!==e&&null!==this._prevWatermarkPreferences&&e.properties().mergeAndFire(this._prevWatermarkPreferences)}}},209800:(e,t,i)=>{"use strict";i.d(t,{SetPriceScaleModeCommand:()=>n});var s=i(853965),r=i(142257),o=i(964824);class n extends r.UndoCommand{constructor(e,t,i,s){super(i),this._newMode=e,this._priceScaleId=t.id(),this._model=s,this._oldMode=t.mode()}redo(){this._applyMode(this._newMode)}undo(){this._applyMode(this._oldMode)}_applyMode(e){const t=this._findPriceScaleById();null!==t&&((0,s.saveDefaultProperties)(!0),t.setMode(e),(0,s.saveDefaultProperties)(!1),this._model&&(this._model.recalculateAllPanes((0,o.viewportChangeEvent)()),this._model.lightUpdate()))}_findPriceScaleById(){const e=this._model.panes();for(let t=0;t<e.length;t++){const i=e[t].getPriceScaleById(this._priceScaleId);if(null!==i)return i}return null}}},796517:(e,t,i)=>{"use strict";i.d(t,{SetPriceScaleSelectionStrategyCommand:()=>a})
;var s=i(650151),r=i(142257),o=i(944876);class n{constructor(e){this._leftScales=e.leftPriceScales().map((e=>e.id())),this._rightScales=e.rightPriceScales().map((e=>e.id()))}restorePane(e){this._leftScales.reverse().map((t=>(0,s.ensureNotNull)(e.getPriceScaleById(t)))).forEach((t=>e.movePriceScale(t,"left"))),this._rightScales.reverse().map((t=>(0,s.ensureNotNull)(e.getPriceScaleById(t)))).forEach((t=>e.movePriceScale(t,"right")))}}class a extends r.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._targetStrategy=(0,o.createPriceScaleSelectionStrategy)(t),this._initialState=e.panes().map((e=>new n(e)))}redo(){this._chartModel.panes().forEach((e=>e.setPriceScaleSelectionStrategy(this._targetStrategy))),this._chartModel.fullUpdate()}undo(){const e=this._chartModel.panes();for(let t=0;t<e.length;t++)this._initialState[t].restorePane(e[t]);this._chartModel.fullUpdate()}}},519231:(e,t,i)=>{"use strict";i.d(t,{SetScaleRatioPropertiesCommand:()=>n});var s=i(142257),r=i(853965),o=i(964824);class n extends s.UndoCommand{constructor(e,t,i,s){super(i),this._property=e,this._newValue=t,this._model=s,this._priceScale=this._model.mainSeries().priceScale(),this._oldValue=this._property.value(),this._oldMode=this._priceScale.mode()}redo(){this._oldValue=this._property.value(),this._oldMode=this._priceScale.mode(),(0,r.saveDefaultProperties)(!0),this._priceScale.setMode({autoScale:!1,percentage:!1,log:!1}),this._property.setValue(this._newValue),(0,r.saveDefaultProperties)(!1),this._model.recalculateAllPanes((0,o.viewportChangeEvent)()),this._model.lightUpdate()}undo(){(0,r.saveDefaultProperties)(!0),this._property.setValue(this._oldValue),this._priceScale.setMode(this._oldMode),(0,r.saveDefaultProperties)(!1),this._model.recalculateAllPanes((0,o.viewportChangeEvent)()),this._model.lightUpdate()}}},993713:(e,t,i)=>{"use strict";i.d(t,{SetWatchedValueCommand:()=>r});var s=i(142257);class r extends s.UndoCommand{constructor(e,t,i){super(i),this._wv=e,this._newValue=t,this._oldValue=e.value()}redo(){this._wv.setValue(this._newValue)}undo(){this._wv.setValue(this._oldValue)}}},569010:(e,t,i)=>{"use strict";function s(e,t){let i=[];const r=e.children(t,!1);for(let t=0;t<r.length;t++)i=i.concat(s(e,r[t]));return i.push(t),i}function r(e,t){const i=new Set,r=t=>{e.children(t,!1).forEach((e=>{i.has(e)||(i.add(e),r(e))}))};return t.forEach(r),t.filter((e=>!i.has(e))).map((t=>s(e,t))).reduce(((e,t)=>e.concat(t)),[])}i.d(t,{closeSourcesSet:()=>r})},744728:(e,t,i)=>{"use strict";i.d(t,{SwapChartsUndoCommand:()=>a});var s=i(444372),r=i(809796),o=i(142257);const n=new r.TranslatedString("swap charts in the Layout",s.t(null,void 0,i(665818)));class a extends o.UndoCommand{constructor(e,t,i){super(n),this._swapper=e,this._from=t,this._to=i}redo(){this._swapper(this._from,this._to)}undo(){this._swapper(this._from,this._to)}}},89820:(e,t,i)=>{"use strict";i.d(t,{TimeScaleChangeUndoCommand:()=>n});var s=i(201089),r=i(142257);const o=(0,s.getLogger)("Chart.ChartUndoModel");class n extends r.UndoCommand{constructor(e,t,i){super(i,!1),
this._newRightOffsetAndBarSpacing=null,this.setCustomFlag("doesnt_affect_save",!0),this._model=e,this._rightOffsetAndBarSpacing=t}undo(){if(null!==this._newRightOffsetAndBarSpacing)return void o.logDebug("TimeScaleChangeUndoCommand.undo: Command is already undone");const e=this._model.timeScale();this._newRightOffsetAndBarSpacing={barSpacing:e.barSpacing(),rightOffset:e.rightOffset()},e.setBarSpacing(this._rightOffsetAndBarSpacing.barSpacing),e.setRightOffset(this._rightOffsetAndBarSpacing.rightOffset),this._model.lightUpdate()}redo(){if(null===this._newRightOffsetAndBarSpacing)return void o.logDebug("TimeScaleChangeUndoCommand.redo: Command is not undone");const e=this._model.timeScale();e.setBarSpacing(this._newRightOffsetAndBarSpacing.barSpacing),e.setRightOffset(this._newRightOffsetAndBarSpacing.rightOffset),this._model.lightUpdate(),this._newRightOffsetAndBarSpacing=null}}},142257:(e,t,i)=>{"use strict";i.d(t,{UndoCommand:()=>r});var s=i(809796);class r{constructor(e,t=!0){this._customFlags={},this._text=e||new s.TranslatedString("",""),this._executeOnPush=t}text(){return this._text}executeOnPush(){return this._executeOnPush}customFlag(e){return this._customFlags[e]}setCustomFlag(e,t){this._customFlags[e]=t}canMerge(e){return!1}merge(e){throw new Error("Should be re-implemented in child classes")}}},176019:(e,t,i)=>{"use strict";i.d(t,{createUndoHistory:()=>h});var s=i(650151),r=i(13294),o=i(345297),n=i(993713),a=i(201089),l=i(707957);const c=(0,a.getLogger)("Common.UndoHistory");function h(){const e=[],t=new r.UndoStack,i=new r.UndoStack,a=new l.Delegate;function h(s){if(e.length>0)e[e.length-1].addCommand(s);else{i.clear();const e=t.head(),r=e&&e.text().originalText();e&&e.canMerge(s)?e.merge(s):t.push(s);const o=s.text().originalText();""!==o&&o!==r&&c.logNormal("DO: "+o)}s.executeOnPush()&&s.redo(),e.length||a.fire(d())}function d(){const e=t.head(),s=i.head(),r=void 0===e?void 0:e.text(),o=void 0===s?void 0:s.text();return{enableUndo:!t.isEmpty(),undoCommandCount:t.size(),undoText:void 0!==r?r.translatedText():r,enableRedo:!i.isEmpty(),redoCommandCount:i.size(),redoText:void 0!==o?o.translatedText():o,originalUndoText:void 0!==r?r.originalText():void 0,originalRedoText:void 0!==o?o.originalText():void 0}}return{beginUndoMacro:function(t){const i=new o.UndoMacroCommand(t);return e.push(i),i},clearStack:function(){t.clear(),i.clear(),a.fire(d())},createUndoCheckpoint:function(){return{lastActualCommand:t.isEmpty()?null:t.head()}},endUndoMacro:function(){const t=(0,s.ensureDefined)(e.pop());t.isEmpty()||h(t)},pushUndoCommand:h,redo:function(){if(i.isEmpty())return!1;const e=i.pop();return!!e&&(e.redo(),t.push(e),c.logNormal("REDO: "+e.text().originalText()),a.fire(d()),!0)},redoStack:function(){return i},setWatchedValue:function(e,t,i,s){if(e.value()!==t){const r=new n.SetWatchedValueCommand(e,t,i);r.setCustomFlag("doesnt_affect_save",!!s),h(r),r.redo()}},undo:function(){if(t.isEmpty())return!1;const e=t.pop();return!!e&&(e.undo(),i.push(e),c.logNormal("UNDO: "+e.text().originalText()),a.fire(d()),!0)},
undoStack:function(){return t},undoToCheckpoint:function(e){for(;!t.isEmpty()&&e.lastActualCommand!==t.head();)t.pop().undo();i.clear(),a.fire(d())},state:d,onChange:function(){return a}}}},345297:(e,t,i)=>{"use strict";i.d(t,{UndoMacroCommand:()=>r});var s=i(142257);class r extends s.UndoCommand{constructor(e){super(e,!1),this._subcommands=[]}addCommand(e){this._subcommands.push(e)}isEmpty(){return 0===this._subcommands.length}redo(){for(let e=0;e<this._subcommands.length;e++)this._subcommands[e].redo()}undo(){for(let e=this._subcommands.length-1;e>=0;e--)this._subcommands[e].undo()}commands(){return this._subcommands}}},13294:(e,t,i)=>{"use strict";i.d(t,{UndoStack:()=>n});var s=i(142257),r=i(707957);const o=(0,i(201089).getLogger)("Common.UndoStack");class n{constructor(){this._commands=[],this._onChange=new r.Delegate}onChange(){return this._onChange}isEmpty(){return 0===this._commands.length}size(){return this._commands.length}clear(){this.isEmpty()||(this._commands.length=0,this._onChange.fire())}push(e){if(!(e instanceof s.UndoCommand))throw new TypeError("argument must be an instance of UndoCommand");this._commands.push(e),this._onChange.fire(e)}pop(){if(this.isEmpty())return void o.logDebug("pop: undo stack is empty");const e=this._commands.pop();return this._onChange.fire(e),e}head(){if(!this.isEmpty())return this._commands[this._commands.length-1]}}},438907:(e,t,i)=>{"use strict";i.d(t,{sourceNewUnitOnPinningToPriceScale:()=>n,unitConvertibleGroups:()=>o});var s=i(981107),r=i(444331);function o(e,t,i){const s=(0,r.symbolUnitConvertibleGroupsIfExist)(e,!0);if(null!==s)return s;const o=i.unitGroupById(t);return null===o?[]:[o]}function n(e,t,i,r){let n=null;if(i.unitConversionEnabled()&&(0,s.isSymbolSource)(e)){const s=i.availableUnits(),a=t.unit(s),l=e.unit(),c=null===l?[]:o(e.symbolInfo(),l,s);null!==a&&null!==a.selectedUnit&&!a.allUnitsAreOriginal&&a.selectedUnit!==l&&(r&&null===l||null!==l&&s.convertible(l,c))&&(n=a.selectedUnit)}return n}},347900:(e,t,i)=>{"use strict";i.r(t),i.d(t,{restoreWatermarkPropertyDefaults:()=>d,watermarkProperty:()=>h});var s=i(62802),r=i(354950),o=i.n(r);const n="symbolWatermark",a={visibility:!1,color:"rgba(80, 83, 94, 0.25)"};function l(){const e=s.getJSON(n);return Object.assign({},a,e)}let c=null;function h(){return null===c&&(c=new(o())(l()),s.onSync.subscribe(null,(()=>{null!==c&&c.mergeAndFire(l())})),c.listeners().subscribe(null,(()=>{null!==c&&s.setJSON(n,c.state())}))),c}function d(){null!==c&&c.mergeAndFire(a)}},767359:(e,t,i)=>{"use strict";var s=i(168883).translatedIntervalString,r=i(665570).getTranslatedSymbolDescription,o=i(422333).CHART_FONT_FAMILY,n=i(347900),a=n.watermarkProperty,l=n.restoreWatermarkPropertyDefaults,c=i(199471).drawScaled,h=i(42292).applyDefaultsOverrides,d=i(42292).applyPropertiesOverrides;const u="symbolWatermark";t.Watermark=function(e,t){var i={},n=a();function _(e,t){var s=e.font;return i.hasOwnProperty(s)||(i[s]={}),i[s].hasOwnProperty(t)||(i[s][t]=e.measureText(t).width),i[s][t]}h(n,void 0,!1,u),
n.listeners().subscribe(this,(function(){e.updateSource(this)})),this.destroy=function(){n.listeners().unsubscribeAll(this)},this.properties=function(){return n},this.restorePropertiesDefaults=function(){l()},this.applyOverrides=function(e){d(n,void 0,!1,e,u)};var p={renderer:function(i,a){return{draw:function(l,h){c(l,h.pixelRatio,h.pixelRatio,(function(){var c=t.symbolInfo();l.fillStyle=n.color.value();var h,d=c.name;/QUANDL/.test(c.exchange)&&((h=d.split(/\//)).length&&(d=h[h.length-1]));var u={description:c.description,short_description:c.short_description,pro_name:c.pro_name,short_name:c.name,local_description:c.local_description,language:c.language};const p=e.watermarkContentProvider(),m=p?p({symbolInfo:c,interval:t.interval()}):null;for(var g=(m?m.map((e=>({text:e.text,font:`${e.fontSize}px ${o}`,lineHeight:e.lineHeight,vertOffset:e.vertOffset}))):null)||[{text:d?d+", "+s(t.interval()):"",font:"96px "+o,lineHeight:117,vertOffset:0},{text:r(u)||"",font:"48px "+o,lineHeight:58,vertOffset:5}],S=0,v=0;v<g.length;v++){if((y=g[v]).text){l.font=y.font;var f=_(l,y.text);y.zoom=f>a?a/f:1,S+=y.lineHeight*y.zoom}}var b=Math.max((i-S)/2,0);for(v=0;v<g.length;v++){var y;(y=g[v]).text&&(l.save(),l.translate(a/2,b),l.textBaseline="top",l.textAlign="center",l.font=y.font,l.scale(y.zoom,y.zoom),l.fillText(y.text,0,y.vertOffset),l.restore(),b+=y.lineHeight*y.zoom)}}))}}},update:function(){}};this.paneViews=function(){return t.symbolInfo()&&n.visibility.value()?[p]:[]}}},690142:(e,t,i)=>{"use strict";i.d(t,{restoreWithWeekdaySettingsValue:()=>l,withWeekdayProperty:()=>a});var s=i(62802),r=i(152633);const o="date_format_with_weekday";function n(){return s.getBool(o,!0)}const a=(0,r.createPrimitiveProperty)(n());function l(){a.setValue(!0),s.remove(o)}a.subscribe(null,(()=>s.setValue(o,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},46955:(e,t,i)=>{"use strict";i.d(t,{moveAfterSource:()=>A,moveBeforeSource:()=>E,newLineToolZOrder:()=>C,newStudyZOrder:()=>w,reorderDataSourcesStateZOrder:()=>f});var s=i(713473),r=i(161488),o=i(440617),n=i(790524),a=i(674981);function l(e){return(0,s.isLineTool)(e)&&!e.isSpeciallyZOrderedSource()}function c(e){return(0,r.isStudy)(e)&&!e.isSpeciallyZOrderedSource()}function h(e,t){return e.zorder-t.zorder}function d(e,t){(0,n.isMainSeriesState)(e)?e.zorder=0:e.zorder=t}function u(e,t){e.setZorder(t)}function _(e){return e.zorder()}function p(e){return Math.round(1e3*e)/1e3}function m(e,t){const i=Math.max(e,t),s=Math.min(e,t);return Math.max(0,Math.ceil(i)-Math.floor(s)-1)}function g(e,t,i){let s=0;const r=function(e,t){const i=1e3;return Math.abs(t*i-e*i)/i}(t,e);var o;return r>i?(e=Math.trunc(e),s=Math.floor(r/(i+1))):(o=r/(i+1),s=Math.floor(1e3*o)/1e3),{startZOrder:e,zOrderStep:s}}function S(e,t,i,s){let r=e.length,o=t;for(let t=e.length-1;t>=-1;t--)if(-1===t||s(e[t])){const s=t;let n=T(o);if(r-1===s)s>=0&&i(e[s],n);else{const t=m(r,s);let a=0;for(;0===a;){const e=g(o,n,t);o=e.startZOrder,a=e.zOrderStep,0===a&&(n-=1e4,0===n&&(n-=1e4))}let l=r-1;for(;l>s;){const t=p(o-a);i(e[l],t),o=t,
l--}s>=0&&i(e[s],n)}o=n,r=s}}function v(e,t,i,s){let r=-1,o=t;for(let t=0;t<=e.length;t++)if(t===e.length||s(e[t])){const s=t;let n=P(o);if(r+1===s)s<=e.length-1&&i(e[s],n);else{const t=m(r,s);let a=0;for(;0===a;){const e=g(o,n,t);o=e.startZOrder,a=e.zOrderStep,0===a&&(n+=1e4,0===n&&(n+=1e4))}let l=r+1;for(;l<=s-1;){const t=p(o+a);i(e[l],t),o=t,l++}s<=e.length-1&&i(e[s],n)}o=n,r=s}}function f(e){!function(e,t,i,s,r,o){let n=null;const a=[];for(const r of e)t(r)?(a.push(r),n=r):(i(r)||s(r))&&a.push(r);a.sort(o),null!==n&&r(n,0);const l=null===n?-1:a.indexOf(n);-1!==l?(S(a.slice(0,l),0,r,i),v(a.slice(l+1),0,r,i)):v(a,0,r,i)}(e,n.isMainSeriesState,n.isStudyState,n.isLineToolState,d,h)}function b(e,t){const i=Math.floor(e/1e4);let s=t.get(i);return void 0===s&&(s=[],t.set(i,s)),s}function y(e,t,i,s,r,o){let n=-1/0,a=1/0,l=-1/0,c=0;const h=new Map;for(let s=0;s<e.length;++s){const o=e[s],d=r(o);t(o)?(n=Math.max(n,d),b(d,h).push(o)):i(o)&&(d<0&&(a=Math.min(a,d),l=Math.max(l,d)),c=Math.max(c,d))}if(o){const e=Math.max(c,n),t=g(e,P(e),1);return p(t.startZOrder+t.zOrderStep)}if(n===-1/0){const e=a===1/0?0:a,t=g(T(e),e,1);return p(t.startZOrder+t.zOrderStep)}const d=g(n,P(n),1);if(0!==d.zOrderStep)return p(d.startZOrder+d.zOrderStep);const u=b(n,h).sort(((e,t)=>r(e)-r(t)));let _=T(r(u[0]));const m=P(_),S=g(_,m,u.length+1).zOrderStep;return 0!==S?(u.forEach((e=>{const t=p(_+S);s(e,t),_=t})),p(_+S)):p(m+5e3)}function C(e,t){return y(e,l,c,u,_,t)}function w(e){let t=-1e4;for(const i of e)c(i)&&(t=Math.min(t,i.zorder()-1e4));return 0===t?-1e4:t}function P(e){const t=1e4*Math.ceil(e/1e4);return t===e?t+1e4:t}function T(e){const t=1e4*Math.floor(e/1e4);return t===e?t-1e4:t}function M(e,t,i,s,r,o,n){const l=t.length,{newItems:c,movedItemsStartIndex:h}=i>0?(0,a.moveAfter)(e,t,i-1):(0,a.moveBefore)(e,t,0);let d=!1;for(let t=h;t<h+l;t++)if(c[t]!==e[t]){d=!0;break}if(!d)return;if(s(t[0]))return void(i<e.length&&n(e[i])<0?v(c.slice(h+1),0,o,r):S(c.slice(0,h),0,o,r));t.some((e=>r(e)))?function(e,t,i,s,r,o){let n,a,l=-1,c=-1;0===i?(c=x(e,i+t,s),a=o(e[c])):i+t===e.length?(l=I(e,i-1,s),n=o(e[l])):(l=I(e,i-1,s),n=o(e[l]),c=x(e,i+t,s),a=o(e[c]));if((void 0===n||n<0)&&void 0!==a&&a<=0)S(e.slice(0,c),a,r,s);else if((void 0===a||a>0)&&void 0!==n&&n>=0)v(e.slice(l+1),n,r,s);else{i+t<e.length-i?S(e.slice(0,i+t),0,r,s):v(e.slice(i),0,r,s)}}(c,l,h,r,o,n):function(e,t,i,s,r,o,n){let a,l;0===i?l=n(e[i+t]):i+t===e.length?a=n(e[i-1]):(a=n(e[i-1]),l=n(e[i+t]));let c=0,h=0,d=0,u=0,_=0;if((void 0===a||a<0)&&void 0!==l&&l<=0){c=l;const e=g(c,void 0!==a?a:T(l),t);c=e.startZOrder,_=e.zOrderStep,d=i+t-1,u=d-t,h=-1}else if((void 0===l||l>0)&&void 0!==a&&a>=0){c=a;const e=g(c,void 0!==l?l:P(a),t);c=e.startZOrder,_=e.zOrderStep,d=i,u=d+t,h=1}if(0!==_)for(;d!==u;){const t=p(c+h*_);o(e[d],t),c=t,d+=h}else{const t=e.findIndex((e=>r(e)));-1!==t?(S(e.slice(0,t),0,o,s),v(e.slice(t+1),0,o,s)):v(e,0,o,s)}}(c,l,h,r,s,o,n)}function x(e,t,i){for(;t<e.length&&i(e[t]);)t++;return Math.min(t,e.length-1)}function I(e,t,i){for(;t>=0&&i(e[t]);)t--;return Math.max(0,t)}
function L(e,t,i,s,r,o,n){const a=e.indexOf(i)+1;M(e,t,a,s,r,o,n)}function k(e,t,i,s,r,o,n){const a=e.indexOf(i);M(e,t,a,s,r,o,n)}function A(e,t,i){L(e,t,i,o.isSeries,c,u,_)}function E(e,t,i){k(e,t,i,o.isSeries,c,u,_)}},455105:(e,t,i)=>{"use strict";i.d(t,{ActionCreators:()=>m});var s=i(444372),r=i(158566),o=i(992854),n=i(949307),a=i(167975),l=i(582665),c=i(789795),h=i(439970),d=i(951983),u=i(201457),_=i(535149),p=i(133736);const m={stopAlerts:(e,t,i)=>new r.TVAction({label:t,icon:(null==i?void 0:i.showIcon)?h:void 0,onExecute:async()=>{const t=await g();return(0,o.maybeRunWithConfirmation)((()=>t.stopAlerts(e)),null==i?void 0:i.confirmation)}}),restartAlerts:(e,t,i)=>new r.TVAction({label:t,icon:(null==i?void 0:i.showIcon)?c:void 0,onExecute:async()=>{const t=await g();return(0,o.maybeRunWithConfirmation)((()=>t.restartAlerts(e)),null==i?void 0:i.confirmation)}}),cloneAlerts:e=>new r.TVAction({label:s.t(null,void 0,i(552977)),icon:u,onExecute:async()=>(await g()).cloneAlerts(e)}),deleteAlerts:(e,t,i)=>new r.TVAction({label:t,icon:(null==i?void 0:i.showIcon)?_:void 0,onExecute:async()=>{const t=await g();return(0,o.maybeRunWithConfirmation)((()=>t.deleteAlerts(e)),null==i?void 0:i.confirmation)}}),editAlert:(e,t,o,l)=>new r.TVAction({label:o?(0,a.appendEllipsis)(s.t(null,void 0,i(557212))):(0,a.appendEllipsis)(s.t(null,void 0,i(116744))),icon:d,onExecute:()=>(null==l||l(),(0,n.getPriceAlertsDispatcher)().then((i=>i.openEditDialog(e,{actionSource:t}))))}),restartAllAlerts:()=>new r.TVAction({label:(0,l.bulkRestartLabel)(!1),onExecute:async()=>{const e=await g();return(0,o.maybeRunWithConfirmation)((()=>e.restartAlerts(Array.from(e.getAlerts().keys()))),(0,l.bulkRestartConfirmation)(!1))}}),stopAllAlerts:()=>new r.TVAction({label:(0,l.bulkStopLabel)(!1),onExecute:async()=>{const e=await g();return(0,o.maybeRunWithConfirmation)((()=>e.stopAlerts(Array.from(e.getAlerts().keys()))),(0,l.bulkStopConfirmation)(!1))}}),deleteAllInactiveAlerts:()=>new r.TVAction({label:(0,l.bulkRemoveInactiveLabel)(),onExecute:async()=>{const e=await g(),t=[];for(const i of e.getAlerts().values())i.active||t.push(i.id);return(0,o.maybeRunWithConfirmation)((()=>e.deleteAlerts(t)),(0,l.bulkRemoveInactiveConfirmation)())}}),deleteAllAlerts:()=>new r.TVAction({label:(0,l.bulkRemoveLabel)(!1),onExecute:async()=>{const e=await g();return(0,o.maybeRunWithConfirmation)((()=>e.deleteAlerts(Array.from(e.getAlerts().keys()))),(0,l.bulkRemoveConfirmation)(!1))}}),deleteAllEvents:()=>new r.TVAction({label:s.t(null,void 0,i(390350)),icon:p,onExecute:async()=>(0,o.maybeRunWithConfirmation)((()=>S()),(0,l.bulkClearLogConfirmation)())}),deleteEvents:e=>new r.TVAction({label:s.t(null,void 0,i(734596)),icon:_,onExecute:()=>S(e.map((e=>e.id)))})};async function g(){const{getWidgetAlertsCollection:e}=await i.e(98698).then(i.bind(i,244593));return e()}async function S(e){const{deleteFires:t}=await i.e(15468).then(i.bind(i,412867));return t(e)}},937994:(e,t,i)=>{"use strict";function s(e=0){return e<1e3?e:e/1e3}function r(e,t){if(e.length>t){
const i=/[\W]+$/g,s=e.substring(0,t),r=s.replace(i,"");return`${r.length?r:s.substring(0,t-1)}`}return e}i.d(t,{cutString:()=>r,ensureDurationInSeconds:()=>s})},161608:(e,t,i)=>{"use strict";i.d(t,{getAlertLabelContextMenuActions:()=>a});var s=i(373571),r=i(895171);const o=(0,r.default)((async()=>new((await i.e(2851).then(i.bind(i,266747))).AlertActionCreators))),n=(0,r.default)((async()=>new((await i.e(90510).then(i.bind(i,558325))).AlertLabelActionCreators)));async function a(e){const[t,i]=await Promise.all([o(),n()]),{chartWidget:r,labelExtendProperty:a,alert:l,analytics:c}=e,h=l.id().value();if(void 0===h)return[];const d=[];return l.isActive()?d.push(t.stopAlert(h,{...c,event:"stop"})):d.push(t.restartAlert(h,{...c,event:"restart"})),d.push(t.editAlert(h,{...c,event:"edit",editActionSource:"alert_label_context_menu_edit"}),t.deleteAlert(h,{...c,event:"delete"}),new s.Separator,i.toggleExtend(r,a,c),i.changeColor(r)),d}},606271:(e,t,i)=>{"use strict";i.r(t),i.d(t,{getAlertEditorSource:()=>s.getAlertEditorSource,isFirstAlertPlotUsual:()=>a});var s=i(151519),r=i(440617),o=i(161488),n=i(223284);function a(e){if((0,r.isSeries)(e))return!0;if((0,o.isStudy)(e)&&!(0,o.isStudyStrategy)(e)){const t=(0,n.plotsForAlert)(e.metaInfo(),e.offset.bind(e));return!e.metaInfo().hasAlertFunction&&t.every((e=>"alertcondition"!==e.type))}return!1}},992393:(e,t,i)=>{"use strict";i.d(t,{confirmDatasourceRemoving:()=>o});var s=i(444372),r=i(779923);function o(){return new Promise((e=>(0,r.showConfirm)({text:s.t(null,void 0,i(784019)),onConfirm:({dialogClose:t})=>{e(!0),t()},onClose:()=>e(!1)})))}},217164:(e,t,i)=>{"use strict";i.d(t,{getSeriesDangerReason:()=>o,getSeriesDangerReasons:()=>r});var s=i(782856);function r(e){const t=new Set;e.isSpread()&&t.add(s.DataSourceDangerReason.Spread);const i=e.symbolInfo();return"CRYPTOCAP"===(null==i?void 0:i.exchange)&&t.add(s.DataSourceDangerReason.CryptoCap),t}function o(e){const[t]=r(e);return null!=t?t:null}},234271:(e,t,i)=>{"use strict";i.d(t,{getPersistentLogger:()=>r,setPersistentLogger:()=>o});let s=null;function r(){return s}function o(e){s=e}},454984:(e,t,i)=>{"use strict";function s(e,t,i="promise rejected by time-out"){return new Promise(((s,r)=>{const o=setTimeout((()=>r(i)),t);e.then((e=>{clearTimeout(o),s(e)})),e.catch((e=>{clearTimeout(o),r(e)}))}))}i.d(t,{makeTimeLimited:()=>s})},868683:(e,t,i)=>{"use strict";function s(){return Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(34465),i.e(69121),i.e(88194),i.e(99138),i.e(50690),i.e(745),i.e(32077)]).then(i.bind(i,880880))}i.d(t,{loadChangeIntervalDialog:()=>s})},230296:(e,t,i)=>{"use strict";i.d(t,{showChangeIntervalDialogAsync:()=>o});var s=i(868683);let r=null;function o(e){const t=r=(0,s.loadChangeIntervalDialog)().then((i=>{t===r&&i.showChangeIntervalDialog(e)}));return t}},277774:(e,t,i)=>{"use strict";function s(e){
return Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(5993),i.e(9817),i.e(4015),i.e(92191),i.e(53842),i.e(34465),i.e(69121),i.e(38669),i.e(5145),i.e(88194),i.e(25190),i.e(72639),i.e(87845),i.e(89434),i.e(22486),i.e(24215),i.e(18511),i.e(17301),i.e(43159),i.e(50690),i.e(59255),i.e(745),i.e(85841),i.e(68985),i.e(53549),i.e(2976),i.e(91859)]).then(i.bind(i,533919)).then((t=>t.showGoToDateDialog(e)))}i.d(t,{showGoToDateDialog:()=>s})},703089:(e,t,i)=>{"use strict";async function s(e){(await Promise.all([i.e(72933),i.e(92547),i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(92191),i.e(68992),i.e(61298),i.e(33199),i.e(967),i.e(73151),i.e(93139),i.e(48478),i.e(5201),i.e(50690),i.e(23127),i.e(50553),i.e(745),i.e(8658),i.e(22616),i.e(26066)]).then(i.bind(i,492418))).renderGoToTradingViewReferralDialog(e)}i.d(t,{showGoToTradingViewReferralDialog:()=>s})},663554:(e,t,i)=>{"use strict";i.d(t,{showDeleteStudyTreeConfirm:()=>o});var s=i(444372),r=i(779923);function o(e){(0,r.showConfirm)({title:s.t(null,void 0,i(638154)),text:s.t(null,void 0,i(452003)),onConfirm:({dialogClose:t})=>{e(),t()}})}},568247:(e,t,i)=>{"use strict";function s(e,t){Promise.all([i.e(22666),i.e(62253),i.e(92108),i.e(9817),i.e(59894),i.e(54252),i.e(50690),i.e(745),i.e(9374)]).then(i.bind(i,557173)).then((i=>{i.showSymbolInfoDialog(null!=e?e:null,t)}))}i.d(t,{showSymbolInfoDialog:()=>s})},861814:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M15.08 5.75a5.07 5.07 0 0 1 7.17 7.17l-3.23 3.23-.7-.7 3.22-3.24a4.07 4.07 0 1 0-5.75-5.75l-3.23 3.23-.7-.71 3.22-3.23Zm-9.33 9.33a5.07 5.07 0 1 0 7.17 7.17l3.23-3.23-.7-.7-3.24 3.22a4.07 4.07 0 1 1-5.75-5.75l3.23-3.23-.71-.7-3.23 3.22Zm10.77-4.3-5.74 5.74.7.7 5.75-5.74-.71-.7Z"/></svg>'},324020:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M15 5H6.5C5.67 5 5 5.67 5 6.5v15c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5V16h1v5.5a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 4 21.5v-15A2.5 2.5 0 0 1 6.5 4H15v1Zm7.41-.3a2 2 0 0 0-2.82 0l-.94.95-7.5 7.5-1 1-.15.14V19h4.7l.15-.15 1-1 7.5-7.5.94-.94a2 2 0 0 0 0-2.82L22.41 4.7Zm-2.12.71a1 1 0 0 1 1.42 0l1.88 1.88a1 1 0 0 1 0 1.42l-.59.58-1.65-1.64L19.71 6l.58-.59Zm.36 2.94L22.29 10l-6.79 6.8-1.65-1.65-1.64-1.65L19 6.7l1.65 1.65Zm-7.5 7.5 1.64 1.65-.5.5H11v-3.3l.5-.5 1.65 1.65Z"/></svg>'},553218:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><rect width="10" height="4" fill="currentColor" rx="2" x="4" y="7"/></svg>'},262998:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><circle fill="currentColor" cx="9" cy="9" r="5"/></svg>'},732140:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18" fill="none"><circle fill="currentColor" cx="9" cy="9" r="4"/></svg>'},725230:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M9.3 9l.9-4.53a1.23 1.23 0 1 0-2.4 0L8.7 9l-.9 4.53a1.23 1.23 0 1 0 2.4 0L9.3 9z"/><path fill="currentColor" d="M9.15 9.26l4.38-1.48a1.23 1.23 0 1 0-1.21-2.09L8.85 8.74l-4.38 1.48a1.23 1.23 0 1 0 1.21 2.09l3.47-3.05z"/><path fill="currentColor" d="M9.15 8.74L5.68 5.69a1.23 1.23 0 1 0-1.2 2.09l4.37 1.48 3.47 3.05a1.23 1.23 0 1 0 1.2-2.09L9.16 8.74z"/></svg>'},643401:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M13.29 4.8h-.09a4.2 4.2 0 1 0 .09 8.4 6 6 0 1 1 0-8.4z"/></svg>'},212462:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M12.58 12.1A3.86 3.86 0 0 0 9 6.75a3.87 3.87 0 0 0-3.58 5.33 7.74 7.74 0 0 1 7.16 0zM3.64 9.93l-2.3-.62.37-1.38 2.3.62-.37 1.38zM6.1 6.07L5.07 3.92l1.3-.6 1 2.15-1.29.6zM10.62 5.47l1-2.16 1.3.6-1.01 2.16-1.3-.6zM13.99 8.55l2.3-.62.36 1.38-2.3.62L14 8.55z"/></svg>'},845437:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd"><path stroke="currentColor" d="M13 22.5H5.5a2 2 0 0 1-2-2v-14a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2V14"/><path stroke="currentColor" stroke-linecap="square" d="M18.5 15.5v8m-4-4h8"/><path fill="currentColor" d="M7 8h11v1H7zm0 4h11v1H7zm0 4h5v1H7z"/></g></svg>'},527409:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="currentcolor" d="m13.5 5a1 1 0 0 0 0 19 1 1 0 0 0 0-19m0 1a1 1 0 0 1 0 17 1 1 0 0 1 0-17zm2.31-.6A9.5 9.5 0 0 0 9 14.5a9.5 9.5 0 0 0 6.81 9.1l.99-.78A8.5 8.5 0 0 1 10 14.5a8.5 8.5 0 0 1 6.8-8.32"/></svg>'},855824:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 7 5" width="7" height="5" fill="none"><path stroke="currentColor" stroke-width="1.2" d="M1 1.5l2.5 2 2.5-2"/></svg>'},539706:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M5 2H4v3H1v1h3v3h1V6h3V5H5V2Z"/><path fill="currentColor" fill-rule="evenodd" d="M17.5 11h-7a1.5 1.5 0 0 0 0 3h7a1.5 1.5 0 0 0 0-3Zm-7-1a2.5 2.5 0 0 0 0 5h7a2.5 2.5 0 0 0 0-5h-7Z"/><path fill="currentColor" d="M8 18h12v1H8v-1Z"/><path fill="currentColor" d="M21.5 6H10V5h11.5A2.5 2.5 0 0 1 24 7.5v14a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 4 21.5V11h1v10.5c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5v-14c0-.83-.67-1.5-1.5-1.5Z"/></svg>'},760823:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" width="25" height="25"><circle fill="transparent" stroke="currentColor" stroke-width="1.5" cx="12.5" cy="12.5" r="11.75"/><path fill="currentColor" fill-rule="evenodd" d="M8.24 6.29a5.3 5.3 0 0 0 1.8 5.73l.67.48-.66.48a5.3 5.3 0 0 0-1.81 5.73c.05.17.2.29.36.29h7.8c.17 0 .31-.12.36-.29a5.3 5.3 0 0 0-1.8-5.73l-.67-.48.66-.48a5.3 5.3 0 0 0 1.81-5.73.39.39 0 0 0-.36-.29H8.6a.39.39 0 0 0-.36.29Zm4.26 5.48 1.58-1.15a3.41 3.41 0 0 0 1.36-2.93H9.56a3.41 3.41 0 0 0 1.36 2.93l1.58 1.15Z"/></svg>'},244230:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" width="25" height="25"><circle fill="none" stroke="currentColor" stroke-width="1.5" cx="12.5" cy="12.5" r="11.75"/><path fill="currentColor" d="m15.65 6 1.02.9-4.02 4.93h5.29L9.59 19l-1.02-.9 4.02-4.93H7.3L15.65 6Z"/></svg>'},428026:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M17.5 7H17v6h-3v-3H9v6H5v6h17V7h-4.5zm.5 14h3V8h-3v13zm-1 0v-7h-3v7h3zm-4-7.5V21h-3V11h3v2.5zM9 21v-4H6v4h3z"/></svg>'},437924:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" transform="translate(4 5)"><circle stroke="currentColor" cx="9.5" cy="9.5" r="9"/><path stroke="currentColor" d="M7 14.5h2.5v-5H7"/><path stroke="currentColor" stroke-linecap="square" d="M9.5 14.5h2"/><path fill="currentColor" d="M9.5 7a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></g></svg>'},902872:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(6 3)"><rect width="15" height="12" rx="2" x=".5" y="8.5"/><path stroke-linecap="round" stroke-width="2" d="M8 15v2"/><path d="M11.5 4a3.5 3.5 0 0 0-7 0v4.5"/></g></svg>'},507983:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 14" width="16" height="14"><path fill="currentColor" fill-rule="evenodd" d="M4.6 1.5 1.64 7l2.96 5.5h6.8L14.36 7 11.4 1.5H4.6ZM15.5 7 12 .5H4L.5 7 4 13.5h8L15.5 7ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm0 1a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/></svg>'},139267:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path d="M6.5 15A8.5 8.5 0 1 0 15 6.5H8.5"/><path d="M12 10L8.5 6.5 12 3"/></g></svg>'},416911:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(3 6)"><path d="M.964 8C3 4 6.679.5 11 .5 15.32.5 19 4 21.036 8 19 12 15.32 15.5 11 15.5 6.679 15.5 3 12 .964 8z"/><circle cx="11" cy="8" r="3.5"/></g></svg>'},381554:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path stroke-linecap="square" d="M21.5 14.5a8 8 0 1 0-8 8m6-6v8m-4-4h8"/><path d="M10 14.5h3.5V9m-3.277-1.76a3 3 0 1 0-3.993 3.979m14.565-.012a3 3 0 1 0-4.019-3.966"/></g></svg>'},706862:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path stroke-linecap="square" d="M11.5 21.5v-7m3 7v-5m3 5v-3m-9 3v-5"/><path d="M5.5 22v-3"/><path stroke-linecap="square" d="M5.5 13.5l4.297-4.297a2.406 2.406 0 0 1 3.406 0l2.594 2.594c.94.94 2.463.943 3.406 0L23.5 7.5M22.5 12.5v6m-3-3h6"/></g></svg>'},108218:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(3 4)"><circle cx="10.5" cy="10.5" r="8"/><path d="M7 10.5h3.5V5M7.223 3.24A3 3 0 1 0 3.23 7.218m14.565-.011a3 3 0 1 0-4.019-3.966"/></g></svg>'},854190:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="square" d="M6.145 11.968L14 5.5l7.855 6.468a.3.3 0 0 1-.191.532H6.336a.3.3 0 0 1-.19-.532zm0 4.064L14 22.5l7.855-6.468a.3.3 0 0 0-.191-.532H6.336a.3.3 0 0 0-.19.532z"/></svg>'},225191:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" transform="translate(4 5)"><path fill="currentColor" d="M3 1h1v13.5H3z"/><circle stroke="currentColor" cx="3.5" cy="16.5" r="2"/><path fill="currentColor" d="M5.5 16H18v1H5.5z"/><path stroke="currentColor" d="M0 4L3.5.5 7 4m8 9l3.5 3.5L15 20"/></g></svg>'},951983:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(4 4)"><path d="M.5 10.992c0 .287.226.508.505.508H2.65c.19.93.55 1.82 1.09 2.63L2.577 15.3a.5.5 0 0 0-.007.71l1.42 1.42a.5.5 0 0 0 .71-.007l1.17-1.163c.81.54 1.71.9 2.63 1.09v1.645c0 .284.227.505.508.505h1.984c.28 0 .508-.221.508-.505V17.35a7.46 7.46 0 0 0 2.63-1.09l1.17 1.163a.5.5 0 0 0 .71.007l1.42-1.42a.5.5 0 0 0-.007-.71l-1.163-1.17c.54-.81.9-1.7 1.09-2.63h1.645a.502.502 0 0 0 .505-.508V9.008a.503.503 0 0 0-.505-.508H17.35c-.19-.93-.55-1.82-1.09-2.63l1.163-1.17a.5.5 0 0 0 .007-.71l-1.42-1.42a.5.5 0 0 0-.71.007L14.13 3.74a7.46 7.46 0 0 0-2.63-1.09V1.005A.504.504 0 0 0 10.992.5H9.008a.504.504 0 0 0-.508.505V2.65c-.92.19-1.82.55-2.63 1.09L4.7 2.577a.5.5 0 0 0-.71-.007L2.57 3.99a.5.5 0 0 0 .007.71L3.74 5.87c-.54.81-.9 1.7-1.09 2.63H1.005a.503.503 0 0 0-.505.508v1.984z"/><circle cx="10" cy="10" r="2.5"/></g></svg>'},593379:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><g fill="currentColor" fill-rule="nonzero"><path d="M4 15h8.5v-1h-8.5zM16.5 15h8.5v-1h-8.5z"/><path d="M14.5 16c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm0 1c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5 2.5 1.119 2.5 2.5-1.119 2.5-2.5 2.5z"/></g></svg>'},535149:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M11.5 6a.5.5 0 0 0-.5.5V8h6V6.5a.5.5 0 0 0-.5-.5h-5zM18 8V6.5c0-.83-.67-1.5-1.5-1.5h-5c-.83 0-1.5.67-1.5 1.5V8H5.5a.5.5 0 0 0 0 1H7v12.5A2.5 2.5 0 0 0 9.5 24h9a2.5 2.5 0 0 0 2.5-2.5V9h1.5a.5.5 0 0 0 0-1H18zm2 1H8v12.5c0 .83.67 1.5 1.5 1.5h9c.83 0 1.5-.67 1.5-1.5V9zm-8.5 3c.28 0 .5.22.5.5v7a.5.5 0 0 1-1 0v-7c0-.28.22-.5.5-.5zm5.5.5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7z"/></svg>'},484959:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="currentColor" d="M18.15 7.02A9.05 9.05 0 0014 6c-3.45 0-6.08 2-7.8 3.92a18.18 18.18 0 00-2.64 3.84v.02h-.01L4 14l-.45-.21-.1.21.1.21L4 14l-.45.21.01.03a5.85 5.85 0 00.16.32c.11.2.28.51.5.87a18.18 18.18 0 002.4 3.12l.71-.71A17.18 17.18 0 014.56 14a10.05 10.05 0 01.52-.91c.41-.69 1.04-1.6 1.85-2.5C8.58 8.75 10.95 7 14 7a8 8 0 013.4.77l.75-.75zm-3.11 3.12a4 4 0 00-4.9 4.9l.86-.87V14a3 3 0 013.17-3l.87-.86zm1.96 3.7l.86-.88a4 4 0 01-4.9 4.9l.87-.86A3 3 0 0017 13.83zm-6.4 6.4A8 8 0 0014 21c3.05 0 5.42-1.76 7.07-3.58A17.18 17.18 0 0023.44 14a9.47 9.47 0 00-.52-.91 17.18 17.18 0 00-2.25-2.93l.7-.7a18.18 18.18 0 013.06 4.3l.02.02L24 14l.45.21-.01.03a7.03 7.03 0 01-.16.32c-.11.2-.28.51-.5.87-.44.72-1.1 1.69-1.97 2.65C20.08 20.01 17.45 22 14 22c-1.55 0-2.94-.4-4.15-1.02l.75-.75zM24 14l.45-.21.1.21-.1.21L24 14zM22.2 6.5L6.5 22.2l-.7-.7L21.5 5.8l.7.7z"/></svg>'},397874:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(6 4)"><rect width="15" height="12" rx="2" x=".5" y="7.5"/><path stroke-linecap="round" stroke-width="2" d="M8 14v2"/><path d="M11.5 7.5V4a3.5 3.5 0 0 0-7 0v3.5"/></g></svg>'},677067:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M13.39 3.84a1 1 0 0 1 1.22 0l8.19 6.37a1 1 0 0 1 0 1.58l-8.19 6.37a1 1 0 0 1-1.22 0L5.2 11.79a1 1 0 0 1 0-1.58l8.19-6.37zm.61.8L5.81 11 14 17.37 22.19 11 14 4.63zM5.3 13.6l8.7 6.76 8.7-6.76.6.78-8.69 6.77a1 1 0 0 1-1.22 0l-8.7-6.77.62-.78zm8.09 10.55l-8.7-6.77.62-.78L14 23.37l8.7-6.76.6.78-8.69 6.77a1 1 0 0 1-1.22 0z"/></svg>'},439970:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M13.5 24a9.5 9.5 0 1 0 0-19 9.5 9.5 0 0 0 0 19zm0 1a10.5 10.5 0 1 0 0-21 10.5 10.5 0 0 0 0 21zM11 10h1v9h-1v-9zm5 0h-1v9h1v-9z"/></svg>'},789795:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M23 14.5a9.5 9.5 0 1 1-19 0 9.5 9.5 0 0 1 19 0zm1 0a10.5 10.5 0 1 1-21 0 10.5 10.5 0 0 1 21 0zM11.3 9.6l-.8-.6v11l.8-.6 6-4.5.53-.4-.53-.4-6-4.5zm4.87 4.9L11.5 18v-7l4.67 3.5z"/></svg>'},133736:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path stroke="currentColor" d="M5.5 16.5c1 3 7 7 11 7 2-4 2-8.5 2-8.5s-1-3.5-2-4-4.5.5-4.5.5-3 3.5-6.5 5z"/><path stroke="currentColor" d="M15.5 11l3-6s.5-1 1.5-.5.5 1.5.5 1.5l-3 6M12 11.5l6.5 3.5M7.5 19c2-.5 4-2.5 4-2.5m0 5.5c2-1 3-3.5 3-3.5"/></svg>'},786559:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><rect width="18" height="18" fill="#EC407A" rx="9" opacity=".15"/><path fill="#C2185B" d="M13.4 5.9c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.45-1.96-.45-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.71.4-.48.86-.72 1.4-.72.56 0 1.31.16 2.27.46.95.3 1.62.45 2.01.45.64 0 1.06-.3 1.27-.9h1.03zm0 3.87c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.46-1.96-.46-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.7.4-.48.86-.72 1.4-.72.56 0 1.31.15 2.27.46.95.3 1.62.44 2.01.44.64 0 1.06-.3 1.27-.9h1.03z"/></svg>'}}]);